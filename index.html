<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Kapazit√§tsplaner V5 - Hierarchische Dashboards</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: system-ui, -apple-system, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .group:hover .group-hover\:opacity-100 { opacity: 1; }
    /* Scroll-Position beibehalten */
    .preserve-scroll { scroll-behavior: auto; }
    
    /* Verstecke Scrollbar f√ºr Header-Synchronisation */
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* Diagonale Schraffur f√ºr Pausenzeiten */
    .break-stripe {
      background-color: rgba(251, 146, 60, 0.2); /* Orange transparent */
      background-image: repeating-linear-gradient(
        45deg,
        rgba(251, 146, 60, 0.4) 0px,
        rgba(251, 146, 60, 0.4) 2px,
        transparent 2px,
        transparent 6px
      );
    }
    
    /* Mobile Touch-Optimierungen */
    @media (max-width: 768px) {
      /* Touch-Targets mindestens 44x44px */
      button { min-height: 44px; min-width: 44px; }
      
      /* Besseres Tap-Highlighting */
      button, a, [role="button"] {
        -webkit-tap-highlight-color: rgba(99, 102, 241, 0.3);
      }
      
      /* Verhindere Zoom bei Input-Focus */
      input, select, textarea {
        font-size: 16px !important;
      }
      
      /* Scrollbare Bereiche mit Momentum */
      .overflow-x-auto, .overflow-y-auto {
        -webkit-overflow-scrolling: touch;
      }
      
      /* Mobile: Kleinere Schrift im Gantt */
      .gantt-text {
        font-size: 10px !important;
      }
      
      /* Mobile: Admin Panel volle H√∂he */
      .admin-modal {
        max-height: 95vh !important;
        margin: 0.5rem !important;
      }
      
      /* Mobile: Gr√∂√üere Touch-Bereiche f√ºr Tasks */
      .task-block {
        min-height: 50px !important;
      }
    }
    
    /* Tablet Optimierungen */
    @media (min-width: 768px) and (max-width: 1024px) {
      /* Admin Panel auf Tablets */
      .admin-grid {
        grid-template-columns: 1fr 1fr !important;
      }
    }
    
    /* Sehr kleine Smartphones */
    @media (max-width: 480px) {
      /* Admin Panel einspaltiges Layout */
      .admin-grid {
        grid-template-columns: 1fr !important;
      }
      
      /* Kleinere Padding auf Mobile */
      .mobile-padding {
        padding: 0.5rem !important;
      }
      
      /* Dashboard Karten volle Breite */
      .dashboard-cards {
        grid-template-columns: 1fr !important;
      }
    }
    
    /* Verbesserte Touch-Gesten f√ºr Tasks */
    .task-touchable {
      cursor: pointer;
      touch-action: none;
    }
    
    @media (hover: none) {
      /* Auf Touch-Ger√§ten: Buttons immer sichtbar */
      .opacity-0.group-hover\:opacity-100 {
        opacity: 0.8 !important;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // FIREBASE CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyBSPyPehsfFzYTL6Rdy7zVy2l-aLDunckI",
      authDomain: "kapazitaetsplanerhoffmann.firebaseapp.com",
      projectId: "kapazitaetsplanerhoffmann",
      storageBucket: "kapazitaetsplanerhoffmann.firebasestorage.app",
      messagingSenderId: "25183676841",
      appId: "1:25183676841:web:bb8ecbe3c6e185ca07bcb8"
    };

    // Firebase initialisieren
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    // Storage-Wrapper f√ºr Firebase (kompatibel mit alter window.storage API)
    window.storage = {
      async get(key) {
        try {
          const doc = await db.collection('data').doc(key).get();
          if (doc.exists) {
            return { key, value: doc.data().value };
          }
          return null;
        } catch (e) {
          console.error('Firebase get error:', e);
          return null;
        }
      },
      async set(key, value) {
        try {
          await db.collection('data').doc(key).set({ value, updated: new Date() });
          return { key, value };
        } catch (e) {
          console.error('Firebase set error:', e);
          return null;
        }
      }
    };

    // Lucide React Icons als inline SVG
    const Calendar = ({className, ...props}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
    );
    const Users = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
    );
    const LogOut = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
    );
    const Settings = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
    );
    const Plus = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14"/><path d="M12 5v14"/></svg>
    );
    const Trash2 = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
    );
    const GripVertical = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg>
    );
    const ChevronLeft = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m15 18-6-6 6-6"/></svg>
    );
    const ChevronRight = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m9 18 6-6-6-6"/></svg>
    );
    const StickyNote = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M15.5 3H5a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2V8.5L15.5 3Z"/><path d="M15 3v6h6"/></svg>
    );
    const BarChart3 = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>
    );
    const ChevronDown = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m6 9 6 6 6-6"/></svg>
    );
    const ChevronUp = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m18 15-6-6-6 6"/></svg>
    );
    const Umbrella = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 12a10.06 10.06 1 0 0-20 0Z"/><path d="M12 12v8a2 2 0 0 0 4 0"/><path d="M12 2v1"/></svg>
    );
    const Eye = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
    );
    const Building2 = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></svg>
    );
    const ArrowRight = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
    );
    const Copy = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
    );
    const X = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
    );

const CapacityPlanner = () => {
  const [currentUser, setCurrentUser] = useState(null);
  const [users, setUsers] = useState([]);
  const [teams, setTeams] = useState([]);
  const [divisions, setDivisions] = useState([]); // NEU: Abteilungen
  const [departments, setDepartments] = useState([]);
  const [projects, setProjects] = useState([]);
  const [projectFolders, setProjectFolders] = useState([]); // NEU: Ordner f√ºr Projekte
  const [tasks, setTasks] = useState([]);
  const [notes, setNotes] = useState([]);
  const [vacations, setVacations] = useState([]);
  const [currentWeek, setCurrentWeek] = useState(() => {
    const now = new Date();
    const d = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  });
  const [currentYear] = useState(new Date().getFullYear());
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [passwordInput, setPasswordInput] = useState('');
  const [passwordError, setPasswordError] = useState(false);
  const [showLogin, setShowLogin] = useState(true);
  
  // üîê PASSWORT HIER √ÑNDERN - dies ist das gemeinsame Team-Passwort
  const APP_PASSWORD = "Team2025";
  const [showSettings, setShowSettings] = useState(false);
  const [showAdmin, setShowAdmin] = useState(false);
  const [showDashboard, setShowDashboard] = useState(false);
  const [showProjectDashboard, setShowProjectDashboard] = useState(false); // Projektdashboard
  const [showProjectPlanning, setShowProjectPlanning] = useState(false); // NEU: Projektplanung
  const [projectPlanningView, setProjectPlanningView] = useState('projects'); // 'projects' oder 'resources'
  const [projectPhases, setProjectPhases] = useState([]); // Projekt-Phasen f√ºr Gantt
  const [workPackages, setWorkPackages] = useState([]); // NEU: Arbeitspakete unter Phasen
  const [dependencies, setDependencies] = useState([]); // NEU: Abh√§ngigkeiten zwischen APs
  const [timelineScroll, setTimelineScroll] = useState(0); // NEU: Scroll-Position f√ºr Timeline
  const [dayWidth, setDayWidth] = useState(15); // NEU: Breite pro Tag (Zoom) - Standard 15px
  const [expandedProjects, setExpandedProjects] = useState({}); // Aufklapp-Status der Projekte
  const [expandedPhases, setExpandedPhases] = useState({}); // Aufklapp-Status der Phasen
  const [draggedProject, setDraggedProject] = useState(null);
  const [draggedTask, setDraggedTask] = useState(null);
  const [resizingTask, setResizingTask] = useState(null);
  const [fontSize, setFontSize] = useState(12);
  const [dashboardFontSize, setDashboardFontSize] = useState(10); // Schriftgr√∂√üe f√ºr Dashboard
  const [expandedNotes, setExpandedNotes] = useState({});
  const [expandedMembers, setExpandedMembers] = useState({});
  const [selectedUser, setSelectedUser] = useState(null);
  const [detailViewUser, setDetailViewUser] = useState(null);
  const [projectSearchText, setProjectSearchText] = useState('');
  
  // Projektdashboard Filter (persistent pro User)
  const [projectDashboardFilters, setProjectDashboardFilters] = useState({
    department: 'all',
    division: 'all',
    team: 'all',
    user: 'all',
    projectSearch: ''
  });
  
  // History & Undo/Redo States
  const [historyLog, setHistoryLog] = useState([]);
  const [showHistory, setShowHistory] = useState(false);
  const [sidebarWPId, setSidebarWPId] = useState(null); // Sidebar f√ºr Projektplanung
  const [filterAssigned, setFilterAssigned] = useState({ responsibles: false, editors: false, divisions: false });
  const [resizeMode, setResizeMode] = useState('magnetic'); // 'magnetic' oder 'rigid'
  const [baselines, setBaselines] = useState([]); // Gespeicherte Baselines
  const [activeBaseline, setActiveBaseline] = useState(null); // Aktuell angezeigte Baseline
  const [ganttZoomLevel, setGanttZoomLevel] = useState(50); // Zoom f√ºr Gantt (25-100%)
  const [ganttLeftPanelWidth, setGanttLeftPanelWidth] = useState(384); // Breite der linken Liste
  const [ganttColumnWidths, setGanttColumnWidths] = useState({ 
    start: 70,  // Start-Spalte
    end: 70,    // Ende-Spalte
    hours: 50,  // Plan h-Spalte
    days: 40    // KT-Spalte
  }); // Individuelle Spaltenbreiten
  const [ganttVisibleColumns, setGanttVisibleColumns] = useState({ start: true, end: true, hours: true, days: true }); // Sichtbare Spalten
  const [ganttProjectSidebarCollapsed, setGanttProjectSidebarCollapsed] = useState(false); // Projekt-Sidebar eingeklappt
  const [ganttSelectedProjectId, setGanttSelectedProjectId] = useState(null); // Ausgew√§hltes Projekt
  const [ganttSelectedFolderId, setGanttSelectedFolderId] = useState(null); // Ausgew√§hlter Ordner
  const [holidays, setHolidays] = useState({}); // Freie Tage: { "2026-02-16": { type: "feiertag", name: "Rosenmontag" } }
  
  // Freie Tage laden
  useEffect(() => {
    const loadHolidays = async () => {
      try {
        const saved = await window.storage.get('ganttHolidays');
        if (saved) setHolidays(JSON.parse(saved.value));
      } catch (e) { /* ignore */ }
    };
    loadHolidays();
  }, []);
  
  // Freie Tage speichern
  const saveHolidays = async (h) => {
    setHolidays(h);
    try {
      await window.storage.set('ganttHolidays', JSON.stringify(h));
    } catch (e) { /* ignore */ }
  };
  
  // Baselines beim Start laden
  useEffect(() => {
    const loadBaselines = async () => {
      try {
        const saved = await window.storage.get('wpBaselines');
        if (saved) setBaselines(JSON.parse(saved.value));
      } catch (e) { /* ignore */ }
    };
    loadBaselines();
  }, []);
  
  const [undoStack, setUndoStack] = useState([]);
  const [redoStack, setRedoStack] = useState([]);
  const maxUndoSteps = 50; // Maximale Anzahl Undo-Schritte
  
  // Refs f√ºr Scroll-Position
  const ganttScrollRef = useRef(null);
  const [savedScrollPosition, setSavedScrollPosition] = useState(0);
  
  // Neue States f√ºr hierarchische √úbersichten
  const [expandedDepartments, setExpandedDepartments] = useState({});
  const [expandedTeams, setExpandedTeams] = useState({});

  // Ref f√ºr Admin-Panel Scroll-Position
  const adminScrollRef = useRef(null);
  const [lastScrollPosition, setLastScrollPosition] = useState(0);

  const WEEKS_TO_SHOW = 4;
  const DW = 80, HH = 40;
  const GRID_START = 6;               // Gantt zeigt ab 6:00 ‚Ä¶
  const GRID_END   = 20;              // ‚Ä¶ bis 20:00
  const GRID_ROWS  = GRID_END - GRID_START; // 14 Zeilen
  
  // üìú History & Undo/Redo Funktionen
  const createSnapshot = () => ({
    tasks: JSON.parse(JSON.stringify(tasks)),
    projects: JSON.parse(JSON.stringify(projects)),
    users: JSON.parse(JSON.stringify(users)),
    vacations: JSON.parse(JSON.stringify(vacations)),
    notes: JSON.parse(JSON.stringify(notes))
  });
  
  const saveSnapshot = () => {
    const snapshot = createSnapshot();
    setUndoStack(prev => [snapshot, ...prev].slice(0, maxUndoSteps));
    setRedoStack([]); // Redo-Stack leeren bei neuer Aktion
  };
  
  const addToHistory = (action, details) => {
    const entry = {
      id: Date.now(),
      timestamp: new Date().toISOString(),
      action, // z.B. 'task_create', 'task_move', 'vacation_set'
      userName: currentUser?.name || 'Unbekannt',
      userId: currentUser?.id,
      details
    };
    setHistoryLog(prev => [entry, ...prev].slice(0, 200)); // Max 200 Eintr√§ge
  };
  
  const undo = () => {
    if (undoStack.length === 0) return;
    
    const currentSnapshot = createSnapshot();
    setRedoStack(prev => [currentSnapshot, ...prev].slice(0, maxUndoSteps));
    
    const previousState = undoStack[0];
    setTasks(previousState.tasks);
    setProjects(previousState.projects);
    setUsers(previousState.users);
    setVacations(previousState.vacations);
    setNotes(previousState.notes);
    setUndoStack(prev => prev.slice(1));
    
    addToHistory('undo', { info: 'Aktion r√ºckg√§ngig gemacht' });
  };
  
  const redo = () => {
    if (redoStack.length === 0) return;
    
    const currentSnapshot = createSnapshot();
    setUndoStack(prev => [currentSnapshot, ...prev].slice(0, maxUndoSteps));
    
    const nextState = redoStack[0];
    setTasks(nextState.tasks);
    setProjects(nextState.projects);
    setUsers(nextState.users);
    setVacations(nextState.vacations);
    setNotes(nextState.notes);
    setRedoStack(prev => prev.slice(1));
    
    addToHistory('redo', { info: 'Aktion wiederhergestellt' });
  };
  
  // Standard: Vollzeit mit ZWEI Pausen
  const DEFAULT_SCHEDULE = {
    1: {start:8, end:17, break1Start:9, break1Duration:0.25, break2Start:12.5, break2Duration:0.75},
    2: {start:8, end:17, break1Start:9, break1Duration:0.25, break2Start:12.5, break2Duration:0.75},
    3: {start:8, end:17, break1Start:9, break1Duration:0.25, break2Start:12.5, break2Duration:0.75},
    4: {start:8, end:17, break1Start:9, break1Duration:0.25, break2Start:12.5, break2Duration:0.75},
    5: {start:8, end:17, break1Start:9, break1Duration:0.25, break2Start:12.5, break2Duration:0.75}
  };

  // 8.5  ‚Üí  "08:30"   |   "08:30"  ‚Üí  8.5
  const h2t = (h) => { const hh=Math.floor(h), mm=Math.round((h-hh)*60); return `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`; };
  const t2h = (s) => { const [h,m]=s.split(':').map(Number); return h+m/60; };
  
  // Smart Time Formatter - wandelt verschiedene Eingaben in HH:MM um
  const formatTimeInput = (input) => {
    if (!input) return '';
    
    // Nur Zahlen extrahieren
    const digits = input.replace(/[^0-9]/g, '');
    if (digits.length === 0) return '';
    
    // Verschiedene Formate handhaben
    if (digits.length === 1) {
      // "6" ‚Üí "06:00"
      return `${digits.padStart(2, '0')}:00`;
    } else if (digits.length === 2) {
      // "63" ‚Üí "06:30" oder "12" ‚Üí "12:00"
      const num = parseInt(digits);
      if (num > 23) {
        // Wahrscheinlich HM statt HH (z.B. 63 = 6:30)
        const h = digits[0];
        const m = digits[1] + '0';
        return `${h.padStart(2, '0')}:${m}`;
      } else {
        return `${digits}:00`;
      }
    } else if (digits.length === 3) {
      // "630" ‚Üí "06:30"
      const h = digits[0];
      const m = digits.substring(1);
      return `${h.padStart(2, '0')}:${m}`;
    } else if (digits.length >= 4) {
      // "1230" ‚Üí "12:30"
      const h = digits.substring(0, 2);
      const m = digits.substring(2, 4);
      return `${h}:${m}`;
    }
    
    return input;
  };

  // Pr√ºfe ob eine Stunde in einer Pausenzeit liegt (ZWEI Pausen m√∂glich!)
  const isBreakHour = (user, date, hour) => {
    if (!date) return false;
    const dayNum = date.getDay();
    if (dayNum === 0 || dayNum === 6) return false; // Wochenende
    const sched = (user.dailySchedule || DEFAULT_SCHEDULE)[dayNum];
    if (!sched) return false;
    
    // Pause 1 (z.B. 09:00-09:15)
    const break1Start = sched.break1Start || 0;
    const break1Duration = sched.break1Duration || 0;
    const break1End = break1Start + break1Duration;
    
    // Pause 2 (z.B. 12:30-13:15)
    const break2Start = sched.break2Start || 0;
    const break2Duration = sched.break2Duration || 0;
    const break2End = break2Start + break2Duration;
    
    // Teilzeit-Logik: Wenn Arbeitsende vor 13:00, dann Mittagspause entf√§llt
    const workEnd = sched.end || 17;
    const hasBreak2 = workEnd > 13 && break2Duration > 0;
    
    // Pr√ºfe ob Stunde in einer der Pausen liegt
    const inBreak1 = break1Duration > 0 && hour >= break1Start && hour < break1End;
    const inBreak2 = hasBreak2 && hour >= break2Start && hour < break2End;
    
    return inBreak1 || inBreak2;
  };
  
  // Berechne Netto-Stunden (Brutto minus ALLE Pausen√ºberschneidungen)
  const calculateNetHours = (startHour, endHour, startDate, endDate, userId) => {
    const start = new Date(startDate + 'T12:00:00');
    const end = new Date(endDate + 'T12:00:00');
    const days = Math.round((end - start) / 86400000) + 1;
    const user = users.find(u => u.id === userId);
    
    let totalGross = 0;
    let totalBreak = 0;
    
    for (let d = 0; d < days; d++) {
      const currentDate = new Date(start);
      currentDate.setDate(start.getDate() + d);
      const dayNum = currentDate.getDay();
      
      // Wochenende √ºberspringen
      if (dayNum === 0 || dayNum === 6) continue;
      
      const sched = (user?.dailySchedule || DEFAULT_SCHEDULE)[dayNum];
      if (!sched) continue;
      
      const dayGross = endHour - startHour;
      totalGross += dayGross;
      
      // Pause 1 √úberschneidung
      const break1Start = sched.break1Start || 0;
      const break1Duration = sched.break1Duration || 0;
      const break1End = break1Start + break1Duration;
      
      if (break1Duration > 0) {
        const overlap1Start = Math.max(startHour, break1Start);
        const overlap1End = Math.min(endHour, break1End);
        if (overlap1Start < overlap1End) {
          totalBreak += (overlap1End - overlap1Start);
        }
      }
      
      // Pause 2 √úberschneidung (nur wenn nicht Teilzeit)
      const workEnd = sched.end || 17;
      const hasBreak2 = workEnd > 13;
      
      if (hasBreak2) {
        const break2Start = sched.break2Start || 0;
        const break2Duration = sched.break2Duration || 0;
        const break2End = break2Start + break2Duration;
        
        if (break2Duration > 0) {
          const overlap2Start = Math.max(startHour, break2Start);
          const overlap2End = Math.min(endHour, break2End);
          if (overlap2Start < overlap2End) {
            totalBreak += (overlap2End - overlap2Start);
          }
        }
      }
    }
    
    return {
      gross: totalGross,
      break: totalBreak,
      net: totalGross - totalBreak
    };
  };

  // Berechne Netto-Stunden f√ºr einen EINZELNEN Tag (f√ºr Dashboard Tages-Anzeige)
  const calculateDayNetHours = (userId, date, startHour, endHour) => {
    const user = users.find(u => u.id === userId);
    const dayNum = date.getDay();
    
    // Wochenende = 0 Stunden
    if (dayNum === 0 || dayNum === 6) return 0;
    
    const sched = (user?.dailySchedule || DEFAULT_SCHEDULE)[dayNum];
    if (!sched) return 0;
    
    let netHours = endHour - startHour;
    
    // Pause 1 abziehen falls √úberschneidung
    const break1Start = sched.break1Start;
    const break1Duration = sched.break1Duration || 0;
    if (break1Start !== undefined && break1Duration > 0) {
      const break1End = break1Start + break1Duration;
      const overlap1Start = Math.max(startHour, break1Start);
      const overlap1End = Math.min(endHour, break1End);
      if (overlap1Start < overlap1End) {
        netHours -= (overlap1End - overlap1Start);
      }
    }
    
    // Pause 2 abziehen falls √úberschneidung (nur bei Vollzeit)
    const workEnd = sched.end || 17;
    if (workEnd > 13) {
      const break2Start = sched.break2Start;
      const break2Duration = sched.break2Duration || 0;
      if (break2Start !== undefined && break2Duration > 0) {
        const break2End = break2Start + break2Duration;
        const overlap2Start = Math.max(startHour, break2Start);
        const overlap2End = Math.min(endHour, break2End);
        if (overlap2Start < overlap2End) {
          netHours -= (overlap2End - overlap2Start);
        }
      }
    }
    
    return netHours;
  };


  useEffect(() => {
    const init = async () => {
      try {
        const u = await window.storage.get('users').catch(() => null);
        const du = [
          { id: 'admin', name: 'Admin', role: 'admin', teamId: null, teamRole: null, departmentId: null },
          { id: 'p1', name: 'Person 1', role: 'member', teamId: 'team1', teamRole: 'lead', weeklyCapacity: 40, departmentId: null },
          { id: 'p2', name: 'Person 2', role: 'member', teamId: 'team1', teamRole: 'responsible', weeklyCapacity: 40, departmentId: null },
          { id: 'p3', name: 'Person 3', role: 'member', teamId: 'team1', teamRole: 'editor', weeklyCapacity: 40, departmentId: null },
          { id: 'p4', name: 'Person 4 (Bereichsleiter)', role: 'member', teamId: 'team2', teamRole: 'department_head', weeklyCapacity: 40, departmentId: 'dept1' },
          { id: 'p5', name: 'Person 5', role: 'member', teamId: 'team2', teamRole: 'editor', weeklyCapacity: 40, departmentId: null },
          { id: 'p6', name: 'Person 6 (Unternehmer)', role: 'member', teamId: null, teamRole: 'entrepreneur', weeklyCapacity: 40, departmentId: null }
        ];
        setUsers(u ? JSON.parse(u.value) : du);
        if (!u) await window.storage.set('users', JSON.stringify(du));

        const t = await window.storage.get('teams').catch(() => null);
        const dt = [
          { id: 'team1', name: 'Team Alpha', divisionId: 'div1' },
          { id: 'team2', name: 'Team Beta', divisionId: 'div1' }
        ];
        setTeams(t ? JSON.parse(t.value) : dt);
        if (!t) await window.storage.set('teams', JSON.stringify(dt));

        const div = await window.storage.get('divisions').catch(() => null);
        const ddiv = [
          { id: 'div1', name: 'Abteilung 1', departmentId: 'dept1' },
          { id: 'div2', name: 'Abteilung 2', departmentId: 'dept1' }
        ];
        setDivisions(div ? JSON.parse(div.value) : ddiv);
        if (!div) await window.storage.set('divisions', JSON.stringify(ddiv));

        const d = await window.storage.get('departments').catch(() => null);
        const dd = [
          { id: 'dept1', name: 'Bereich Nord' },
          { id: 'dept2', name: 'Bereich S√ºd' }
        ];
        setDepartments(d ? JSON.parse(d.value) : dd);
        if (!d) await window.storage.set('departments', JSON.stringify(dd));

        const p = await window.storage.get('projects').catch(() => null);
        const dp = [
          { id: 'p1', name: 'Projekt A', color: '#22c55e' },
          { id: 'p2', name: 'Projekt B', color: '#ef4444' },
          { id: 'p3', name: 'Projekt C', color: '#3b82f6' }
        ];
        setProjects(p ? JSON.parse(p.value) : dp);
        if (!p) await window.storage.set('projects', JSON.stringify(dp));

        const pf = await window.storage.get('projectFolders').catch(() => null);
        if (pf) setProjectFolders(JSON.parse(pf.value));

        const tk = await window.storage.get('tasks').catch(() => null);
        if (tk) setTasks(JSON.parse(tk.value));

        const n = await window.storage.get('notes').catch(() => null);
        if (n) setNotes(JSON.parse(n.value));

        const v = await window.storage.get('vacations').catch(() => null);
        if (v) setVacations(JSON.parse(v.value));
        
        const pp = await window.storage.get('projectPhases').catch(() => null);
        if (pp) setProjectPhases(JSON.parse(pp.value));
        
        const wp = await window.storage.get('workPackages').catch(() => null);
        if (wp) setWorkPackages(JSON.parse(wp.value));
        
        const deps = await window.storage.get('dependencies').catch(() => null);
        if (deps) setDependencies(JSON.parse(deps.value));
      } catch (e) { console.error('Init error:', e); }
    };
    init();
  }, []);

  useEffect(() => {
    if (currentUser && !selectedUser) setSelectedUser(currentUser);
    if (currentUser && selectedUser && currentUser.id !== selectedUser.id && currentUser.teamRole !== 'lead') {
      setSelectedUser(currentUser);
    }
  }, [currentUser]);

  // Scroll-Position nach State-Updates wiederherstellen
  useEffect(() => {
    if (ganttScrollRef.current && savedScrollPosition > 0) {
      ganttScrollRef.current.scrollLeft = savedScrollPosition;
      setSavedScrollPosition(0);
    }
  }, [tasks, expandedNotes, savedScrollPosition]);

  const getWeekDates = (w, y) => {
    try {
      // Jahres√ºberlauf behandeln
      let week = parseInt(w) || 1;
      let year = parseInt(y) || 2025;
      while (week > 52) {
        week -= 52;
        year++;
      }
      while (week < 1) {
        week += 52;
        year--;
      }
      
      const s = new Date(year, 0, 1 + (week - 1) * 7);
      const d = s.getDay();
      const st = new Date(s);
      if (d <= 4) st.setDate(s.getDate() - s.getDay() + 1);
      else st.setDate(s.getDate() + 8 - s.getDay());
      const dates = [];
      for (let i = 0; i < 7; i++) {
        const dt = new Date(st);
        dt.setDate(st.getDate() + i);
        dt.setHours(12, 0, 0, 0);
        dates.push(dt);
      }
      return dates;
    } catch (e) {
      console.error('Date error:', e);
      return [];
    }
  };

  const formatDate = (d) => {
    const dt = new Date(d);
    dt.setHours(12, 0, 0, 0);
    return dt.toISOString().split('T')[0];
  };
  
  const getWeekNumber = (date) => {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  };

  const saveTasks = async (t) => { setTasks(t); await window.storage.set('tasks', JSON.stringify(t)); };
  const saveProjects = async (p) => { setProjects(p); await window.storage.set('projects', JSON.stringify(p)); };
  const saveProjectFolders = async (pf) => { setProjectFolders(pf); await window.storage.set('projectFolders', JSON.stringify(pf)); };
  const saveUsers = async (u) => { setUsers(u); await window.storage.set('users', JSON.stringify(u)); };
  const saveTeams = async (t) => { setTeams(t); await window.storage.set('teams', JSON.stringify(t)); };
  const saveDivisions = async (d) => { setDivisions(d); await window.storage.set('divisions', JSON.stringify(d)); };
  const saveDepartments = async (d) => { setDepartments(d); await window.storage.set('departments', JSON.stringify(d)); };
  const saveNotes = async (n) => { setNotes(n); await window.storage.set('notes', JSON.stringify(n)); };
  const saveVacations = async (v) => { setVacations(v); await window.storage.set('vacations', JSON.stringify(v)); };
  const saveProjectPhases = async (pp) => { setProjectPhases(pp); await window.storage.set('projectPhases', JSON.stringify(pp)); };
  const saveWorkPackages = async (wp) => { setWorkPackages(wp); await window.storage.set('workPackages', JSON.stringify(wp)); };
  const saveDependencies = async (deps) => { setDependencies(deps); await window.storage.set('dependencies', JSON.stringify(deps)); };

  // Zeilen-Reihenfolge √§ndern (Drag & Drop vertikal)
  const handleRowDrop = (draggedType, draggedId, targetType, targetId, position) => {
    if (draggedType === 'project' && targetType === 'project') {
      // Projekt verschieben
      const draggedIdx = projects.findIndex(p => p.id === draggedId);
      let targetIdx = projects.findIndex(p => p.id === targetId);
      if (draggedIdx === -1 || targetIdx === -1 || draggedIdx === targetIdx) return;
      
      const newProjects = [...projects];
      const [moved] = newProjects.splice(draggedIdx, 1);
      if (position === 'after') targetIdx = targetIdx >= draggedIdx ? targetIdx : targetIdx + 1;
      else targetIdx = targetIdx > draggedIdx ? targetIdx - 1 : targetIdx;
      newProjects.splice(targetIdx, 0, moved);
      
      // Order-Werte aktualisieren
      newProjects.forEach((p, i) => p.order = i);
      saveProjects(newProjects);
    }
    else if (draggedType === 'phase' && targetType === 'phase') {
      // Phase verschieben (nur innerhalb desselben Projekts)
      const draggedPhase = projectPhases.find(p => p.id === draggedId);
      const targetPhase = projectPhases.find(p => p.id === targetId);
      if (!draggedPhase || !targetPhase || draggedPhase.projectId !== targetPhase.projectId) return;
      
      const projectId = draggedPhase.projectId;
      const phasesInProject = projectPhases.filter(p => p.projectId === projectId);
      const otherPhases = projectPhases.filter(p => p.projectId !== projectId);
      
      const draggedIdx = phasesInProject.findIndex(p => p.id === draggedId);
      let targetIdx = phasesInProject.findIndex(p => p.id === targetId);
      if (draggedIdx === targetIdx) return;
      
      const [moved] = phasesInProject.splice(draggedIdx, 1);
      if (position === 'after') targetIdx = targetIdx >= draggedIdx ? targetIdx : targetIdx + 1;
      else targetIdx = targetIdx > draggedIdx ? targetIdx - 1 : targetIdx;
      phasesInProject.splice(targetIdx, 0, moved);
      
      phasesInProject.forEach((p, i) => p.order = i);
      saveProjectPhases([...otherPhases, ...phasesInProject]);
    }
    else if (draggedType === 'wp' && targetType === 'wp') {
      // Arbeitspaket verschieben (nur innerhalb derselben Phase)
      const draggedWP = workPackages.find(w => w.id === draggedId);
      const targetWP = workPackages.find(w => w.id === targetId);
      if (!draggedWP || !targetWP || draggedWP.phaseId !== targetWP.phaseId) return;
      
      const phaseId = draggedWP.phaseId;
      const wpsInPhase = workPackages.filter(w => w.phaseId === phaseId);
      const otherWPs = workPackages.filter(w => w.phaseId !== phaseId);
      
      const draggedIdx = wpsInPhase.findIndex(w => w.id === draggedId);
      let targetIdx = wpsInPhase.findIndex(w => w.id === targetId);
      if (draggedIdx === targetIdx) return;
      
      const [moved] = wpsInPhase.splice(draggedIdx, 1);
      if (position === 'after') targetIdx = targetIdx >= draggedIdx ? targetIdx : targetIdx + 1;
      else targetIdx = targetIdx > draggedIdx ? targetIdx - 1 : targetIdx;
      wpsInPhase.splice(targetIdx, 0, moved);
      
      wpsInPhase.forEach((w, i) => w.order = i);
      saveWorkPackages([...otherWPs, ...wpsInPhase]);
    }
  };

  const toggleVacation = (userId, date) => {
    // Scroll-Position speichern
    if (ganttScrollRef.current) {
      setSavedScrollPosition(ganttScrollRef.current.scrollLeft);
    }
    
    const dateStr = formatDate(date);
    const existing = vacations.find(v => v.userId === userId && v.date === dateStr);
    if (existing) {
      saveVacations(vacations.filter(v => !(v.userId === userId && v.date === dateStr)));
    } else {
      saveVacations([...vacations, {id: 'v' + Date.now(), userId, date: dateStr}]);
    }
  };

  const isVacation = (userId, date) => {
    const dateStr = formatDate(date);
    return vacations.some(v => v.userId === userId && v.date === dateStr);
  };

  const addTask = (uid, pid, date, sh, eh) => {
    const td = new Date(date);
    td.setHours(12, 0, 0, 0);
    saveTasks([...tasks, {
      id: 't' + Date.now(), userId: uid, projectId: pid,
      startDate: formatDate(td), endDate: formatDate(td),
      startHour: sh, endHour: eh
    }]);
  };

  // NEU: Kopiere Tasks aus Vorwoche
  const copyTasksFromPreviousWeek = (userId, targetWeekNum) => {
    // Scroll-Position speichern
    if (ganttScrollRef.current) {
      setSavedScrollPosition(ganttScrollRef.current.scrollLeft);
    }
    
    const sourceWeekNum = targetWeekNum - 1;
    const sourceWeekDates = getWeekDates(sourceWeekNum, currentYear);
    const targetWeekDates = getWeekDates(targetWeekNum, currentYear);
    
    if (sourceWeekDates.length === 0 || targetWeekDates.length === 0) return;
    
    const sourceStartDate = formatDate(sourceWeekDates[0]);
    const sourceEndDate = formatDate(sourceWeekDates[6]);
    const targetStartDate = formatDate(targetWeekDates[0]);
    
    // Finde alle Tasks der Vorwoche
    const previousWeekTasks = tasks.filter(t => 
      t.userId === userId && 
      t.startDate >= sourceStartDate && 
      t.startDate <= sourceEndDate
    );
    
    if (previousWeekTasks.length === 0) {
      alert('Keine Planung in der Vorwoche gefunden!');
      return;
    }
    
    // Berechne Tages-Offset
    const daysDiff = 7;
    
    // Kopiere Tasks
    const newTasks = previousWeekTasks.map(t => {
      const oldStart = new Date(t.startDate + 'T12:00:00');
      const oldEnd = new Date(t.endDate + 'T12:00:00');
      const newStart = new Date(oldStart);
      newStart.setDate(newStart.getDate() + daysDiff);
      const newEnd = new Date(oldEnd);
      newEnd.setDate(newEnd.getDate() + daysDiff);
      
      return {
        id: 't' + Date.now() + '_' + Math.random(),
        userId: t.userId,
        projectId: t.projectId,
        startDate: formatDate(newStart),
        endDate: formatDate(newEnd),
        startHour: t.startHour,
        endHour: t.endHour
      };
    });
    
    saveTasks([...tasks, ...newTasks]);
    alert(`${previousWeekTasks.length} Aufgabe(n) aus Vorwoche kopiert!`);
  };
  
  // NEU: Kopiere einzelnen Task in n√§chste Woche
  const copyTaskToNextWeek = (task) => {
    // Scroll-Position speichern
    if (ganttScrollRef.current) {
      setSavedScrollPosition(ganttScrollRef.current.scrollLeft);
    }
    
    const oldStart = new Date(task.startDate + 'T12:00:00');
    const oldEnd = new Date(task.endDate + 'T12:00:00');
    const newStart = new Date(oldStart);
    newStart.setDate(newStart.getDate() + 7);
    const newEnd = new Date(oldEnd);
    newEnd.setDate(newEnd.getDate() + 7);
    
    const newTask = {
      id: 't' + Date.now(),
      userId: task.userId,
      projectId: task.projectId,
      startDate: formatDate(newStart),
      endDate: formatDate(newEnd),
      startHour: task.startHour,
      endHour: task.endHour
    };
    
    saveTasks([...tasks, newTask]);
  };

  const updateTask = (id, upd) => saveTasks(tasks.map(t => t.id === id ? { ...t, ...upd } : t));
  const deleteTask = (id) => {
    // Scroll-Position speichern
    if (ganttScrollRef.current) {
      setSavedScrollPosition(ganttScrollRef.current.scrollLeft);
    }
    saveTasks(tasks.filter(t => t.id !== id));
  };

  const getWeekNote = (userId, weekNum) => {
    return notes.find(n => n.userId === userId && n.week === weekNum && n.year === currentYear);
  };

  const updateWeekNote = (userId, weekNum, text) => {
    const existing = notes.find(n => n.userId === userId && n.week === weekNum && n.year === currentYear);
    if (existing) {
      saveNotes(notes.map(n => n.userId === userId && n.week === weekNum && n.year === currentYear ? {...n, text} : n));
    } else {
      saveNotes([...notes, {id: 'n' + Date.now(), userId, week: weekNum, year: currentYear, text}]);
    }
  };

  const getTeamMembers = (teamId) => users.filter(u => u.teamId === teamId && u.role !== 'admin');

  // Arbeitsplan eines Users f√ºr einen konkreten Tag
  const getDaySchedule = (user, date) => {
    const dow = date.getDay();
    if (dow === 0 || dow === 6) return {start:0, end:0, break1Duration:0, break2Duration:0};
    return (user.dailySchedule || DEFAULT_SCHEDULE)[dow] || {start:8, end:17, break1Start:9, break1Duration:0.25, break2Start:12.5, break2Duration:0.75};
  };
  // Arbeitsstunden an einem Tag (= end ‚àí start ‚àí pause1 ‚àí pause2, oder 0 wenn frei)
  const getDailyHours = (user, date) => {
    const s = getDaySchedule(user, date);
    const gross = s.end > s.start ? s.end - s.start : 0;
    const break1 = s.break1Duration || 0;
    const break2 = (s.end > 13) ? (s.break2Duration || 0) : 0; // Pause 2 nur bei Vollzeit
    return Math.max(0, gross - break1 - break2);
  };
  const isNonWorkingDay = (user, date) => getDailyHours(user, date) === 0;
  // Pr√ºft ob eine bestimmte Stunde (z.B. 9 = 9:00‚Äì10:00) innerhalb des Arbeitsplans liegt
  const isWorkingHour = (user, date, hour) => {
    const s = getDaySchedule(user, date);
    // Eine Stunden-Zelle ist "Arbeitszeit" wenn irgendein Teil davon in der Arbeitszeit liegt
    // Beispiel: hour=7 (7:00-8:00), s.start=7.5 (7:30) ‚Üí hour+1 > 7.5 ‚Üí true
    return (hour + 1) > s.start && hour < s.end;
  };
  // Wochenkapazit√§t eines Users (Urlaub-Tage werden abgezogen)
  const getWeekCapacity = (user, weekDates) => {
    return weekDates.reduce((sum, d) => {
      if (isVacation(user.id, d)) return sum;
      return sum + getDailyHours(user, d);
    }, 0);
  };

  useEffect(() => {
    const handleMouseMove = (e) => {
      if (draggedTask) {
        const dx = e.clientX - draggedTask.startX;
        const dy = e.clientY - draggedTask.startY;
        const daysMoved = Math.round(dx / DW);
        const hoursMoved = Math.round(dy / HH * 4) / 4; // 0,25h Schritte!
        const st = new Date(draggedTask.task.startDate);
        const newSt = new Date(st);
        newSt.setDate(st.getDate() + daysMoved);
        const ed = new Date(draggedTask.task.endDate);
        const newEd = new Date(ed);
        newEd.setDate(ed.getDate() + daysMoved);
        const newSh = Math.max(GRID_START, Math.min(GRID_END - 1, draggedTask.task.startHour - hoursMoved));
        const newEh = Math.max(GRID_START + 1, Math.min(GRID_END, draggedTask.task.endHour - hoursMoved));
        setDraggedTask({ ...draggedTask, previewStartDate: formatDate(newSt), previewEndDate: formatDate(newEd), previewStartHour: newSh, previewEndHour: newEh });
      }
      if (resizingTask) {
        if (resizingTask.dir === 'right') {
          const dx = e.clientX - resizingTask.startX;
          const daysMoved = Math.round(dx / DW);
          const ed = new Date(resizingTask.task.endDate);
          const newEd = new Date(ed);
          newEd.setDate(ed.getDate() + daysMoved);
          setResizingTask({ ...resizingTask, previewEndDate: formatDate(newEd) });
        } else if (resizingTask.dir === 'top') {
          const dy = e.clientY - resizingTask.startY;
          const hoursMoved = Math.round(dy / HH * 4) / 4; // 0,25h Schritte!
          const newEh = Math.max(resizingTask.task.startHour + 1, Math.min(GRID_END, resizingTask.origEnd - hoursMoved));
          setResizingTask({ ...resizingTask, previewEndHour: newEh });
        } else if (resizingTask.dir === 'bottom') {
          const dy = e.clientY - resizingTask.startY;
          const hoursMoved = Math.round(dy / HH * 4) / 4; // 0,25h Schritte!
          const newSh = Math.max(GRID_START, Math.min(resizingTask.task.endHour - 1, resizingTask.origStart - hoursMoved));
          setResizingTask({ ...resizingTask, previewStartHour: newSh });
        }
      }
    };
    const handleMouseUp = () => {
      if (draggedTask && draggedTask.previewStartDate) {
        updateTask(draggedTask.task.id, {
          startDate: draggedTask.previewStartDate, endDate: draggedTask.previewEndDate,
          startHour: draggedTask.previewStartHour, endHour: draggedTask.previewEndHour
        });
      }
      if (resizingTask) {
        const upd = {};
        if (resizingTask.previewEndDate) upd.endDate = resizingTask.previewEndDate;
        if (resizingTask.previewEndHour !== undefined) upd.endHour = resizingTask.previewEndHour;
        if (resizingTask.previewStartHour !== undefined) upd.startHour = resizingTask.previewStartHour;
        if (Object.keys(upd).length > 0) updateTask(resizingTask.task.id, upd);
      }
      setDraggedTask(null);
      setResizingTask(null);
    };
    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);
    return () => {
      document.removeEventListener('mousemove', handleMouseMove);
      document.removeEventListener('mouseup', handleMouseUp);
    };
  }, [draggedTask, resizingTask, tasks]);

  const AdminPanel = () => {
    const [localUsers, setLocalUsers] = React.useState(users);
    const [localTeams, setLocalTeams] = React.useState(teams);
    const [localDivisions, setLocalDivisions] = React.useState(divisions);
    const [localDepartments, setLocalDepartments] = React.useState(departments);
    const [expandedUsers, setExpandedUsers] = React.useState({});
    const [userSort, setUserSort] = React.useState('recent'); // 'recent', 'a-z', 'z-a'
    React.useEffect(() => { setLocalUsers(users); }, [users]);
    React.useEffect(() => { setLocalTeams(teams); }, [teams]);
    React.useEffect(() => { setLocalDivisions(divisions); }, [divisions]);
    React.useEffect(() => { setLocalDepartments(departments); }, [departments]);
    
    // Scroll-Position speichern vor Update
    const saveScrollPosition = () => {
      if (adminScrollRef.current) {
        setLastScrollPosition(adminScrollRef.current.scrollTop);
      }
    };
    
    // Scroll-Position wiederherstellen nach Update
    React.useEffect(() => {
      if (adminScrollRef.current && lastScrollPosition > 0) {
        adminScrollRef.current.scrollTop = lastScrollPosition;
      }
    }, [localUsers]);
    
    return (
      <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 mobile-padding">
        <div className="bg-white rounded-3xl p-6 w-[95%] max-w-[2496px] max-h-[95vh] overflow-y-auto admin-modal">
          <div className="flex justify-between mb-6">
            <h2 className="text-2xl font-bold">Admin Panel</h2>
            <button onClick={() => setShowAdmin(false)} className="text-2xl">‚úï</button>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-4 gap-6 admin-grid">
            {/* SPALTE 1: BEREICHE */}
            <div>
              <h3 className="font-bold mb-3">Bereiche</h3>
              <div className="space-y-2 max-h-[576px] overflow-y-auto mb-3">
                {localDepartments.sort((a, b) => a.name.localeCompare(b.name)).map(d => (
                  <div key={d.id} className="p-3 bg-gray-50 rounded-xl relative">
                    <button 
                      onClick={() => {
                        const hasChildren = localDivisions.some(div => div.departmentId === d.id);
                        if (hasChildren) {
                          alert('Dieser Bereich kann nicht gel√∂scht werden, da ihm noch Abteilungen zugeordnet sind.');
                          return;
                        }
                        if (confirm(`Bereich "${d.name}" wirklich l√∂schen?`)) {
                          const newDepts = localDepartments.filter(x => x.id !== d.id);
                          setLocalDepartments(newDepts);
                          saveDepartments(newDepts);
                        }
                      }}
                      className="absolute top-2 right-2 p-1 text-red-500 hover:bg-red-100 rounded"
                      title="L√∂schen"
                    >
                      <Trash2 className="w-4 h-4" />
                    </button>
                    <input type="text" value={d.name} 
                      onChange={(e) => setLocalDepartments(localDepartments.map(x => x.id === d.id ? {...x, name: e.target.value} : x))} 
                      onBlur={() => saveDepartments(localDepartments)}
                      className="w-full p-2 border rounded pr-8" />
                  </div>
                ))}
              </div>
              <button onClick={() => {
                const newDept = { id: 'dept' + Date.now(), name: 'Neuer Bereich' };
                const newDepts = [newDept, ...localDepartments];
                setLocalDepartments(newDepts); saveDepartments(newDepts);
              }} className="w-full p-3 bg-indigo-600 text-white rounded-xl">
                <Plus className="w-4 h-4 inline mr-2" /> Bereich hinzuf√ºgen
              </button>
            </div>

            {/* SPALTE 2: ABTEILUNGEN */}
            <div>
              <h3 className="font-bold mb-3">Abteilungen</h3>
              <div className="space-y-2 max-h-[576px] overflow-y-auto mb-3">
                {localDivisions.sort((a, b) => a.name.localeCompare(b.name)).map(div => (
                  <div key={div.id} className="p-3 bg-gray-50 rounded-xl relative">
                    <button 
                      onClick={() => {
                        const hasChildren = localTeams.some(t => t.divisionId === div.id);
                        if (hasChildren) {
                          alert('Diese Abteilung kann nicht gel√∂scht werden, da ihr noch Teams zugeordnet sind.');
                          return;
                        }
                        if (confirm(`Abteilung "${div.name}" wirklich l√∂schen?`)) {
                          const newDivs = localDivisions.filter(x => x.id !== div.id);
                          setLocalDivisions(newDivs);
                          saveDivisions(newDivs);
                        }
                      }}
                      className="absolute top-2 right-2 p-1 text-red-500 hover:bg-red-100 rounded"
                      title="L√∂schen"
                    >
                      <Trash2 className="w-4 h-4" />
                    </button>
                    <input type="text" value={div.name} 
                      onChange={(e) => setLocalDivisions(localDivisions.map(x => x.id === div.id ? {...x, name: e.target.value} : x))} 
                      onBlur={() => saveDivisions(localDivisions)}
                      className="w-full p-2 border rounded mb-2 pr-8" />
                    <select value={div.departmentId || ''} 
                      onChange={(e) => { const newDivs = localDivisions.map(x => x.id === div.id ? {...x, departmentId: e.target.value} : x); setLocalDivisions(newDivs); saveDivisions(newDivs); }} 
                      className="w-full p-2 border rounded text-sm">
                      <option value="">Kein Bereich</option>
                      {localDepartments.map(d => <option key={d.id} value={d.id}>{d.name}</option>)}
                    </select>
                  </div>
                ))}
              </div>
              <button onClick={() => {
                const newDiv = { id: 'div' + Date.now(), name: 'Neue Abteilung', departmentId: localDepartments[0]?.id || null };
                const newDivs = [newDiv, ...localDivisions];
                setLocalDivisions(newDivs); saveDivisions(newDivs);
              }} className="w-full p-3 bg-indigo-600 text-white rounded-xl">
                <Plus className="w-4 h-4 inline mr-2" /> Abteilung hinzuf√ºgen
              </button>
            </div>

            {/* SPALTE 3: TEAMS */}
            <div>
              <h3 className="font-bold mb-3">Teams</h3>
              <div className="space-y-2 max-h-[576px] overflow-y-auto mb-3">
                {localTeams.sort((a, b) => a.name.localeCompare(b.name)).map(t => (
                  <div key={t.id} className="p-3 bg-gray-50 rounded-xl relative">
                    <button 
                      onClick={() => {
                        const hasChildren = localUsers.some(u => u.teamId === t.id);
                        if (hasChildren) {
                          alert('Dieses Team kann nicht gel√∂scht werden, da ihm noch Benutzer zugeordnet sind.');
                          return;
                        }
                        if (confirm(`Team "${t.name}" wirklich l√∂schen?`)) {
                          const newTeams = localTeams.filter(x => x.id !== t.id);
                          setLocalTeams(newTeams);
                          saveTeams(newTeams);
                        }
                      }}
                      className="absolute top-2 right-2 p-1 text-red-500 hover:bg-red-100 rounded"
                      title="L√∂schen"
                    >
                      <Trash2 className="w-4 h-4" />
                    </button>
                    <input type="text" value={t.name} 
                      onChange={(e) => setLocalTeams(localTeams.map(x => x.id === t.id ? {...x, name: e.target.value} : x))} 
                      onBlur={() => saveTeams(localTeams)}
                      className="w-full p-2 border rounded mb-2 pr-8" />
                    <select value={t.divisionId || ''} 
                      onChange={(e) => { const newTeams = localTeams.map(x => x.id === t.id ? {...x, divisionId: e.target.value} : x); setLocalTeams(newTeams); saveTeams(newTeams); }} 
                      className="w-full p-2 border rounded text-sm">
                      <option value="">Keine Abteilung</option>
                      {localDivisions.map(d => <option key={d.id} value={d.id}>{d.name}</option>)}
                    </select>
                  </div>
                ))}
              </div>
              <button onClick={() => {
                const newTeam = { id: 'team' + Date.now(), name: 'Neues Team', divisionId: localDivisions[0]?.id || null };
                const newTeams = [newTeam, ...localTeams];
                setLocalTeams(newTeams); saveTeams(newTeams);
              }} className="w-full p-3 bg-indigo-600 text-white rounded-xl">
                <Plus className="w-4 h-4 inline mr-2" /> Team hinzuf√ºgen
              </button>
            </div>

            {/* SPALTE 4: BENUTZER */}
            <div>
              <div className="flex items-center justify-between mb-3">
                <h3 className="font-bold">Benutzer</h3>
                <select 
                  value={userSort} 
                  onChange={(e) => setUserSort(e.target.value)}
                  className="text-xs px-2 py-1 border rounded bg-white"
                >
                  <option value="recent">Zuletzt hinzugef√ºgt</option>
                  <option value="a-z">A ‚Üí Z</option>
                  <option value="z-a">Z ‚Üí A</option>
                </select>
              </div>
              <div ref={adminScrollRef} className="space-y-2 max-h-[576px] overflow-y-auto mb-3 preserve-scroll">
                {localUsers.filter(u => u.role !== 'admin').sort((a, b) => {
                  if (userSort === 'a-z') return a.name.localeCompare(b.name);
                  if (userSort === 'z-a') return b.name.localeCompare(a.name);
                  return 0; // 'recent' - keine Sortierung, Array-Reihenfolge beibehalten
                }).map(u => {
                  const isExpanded = expandedUsers[u.id];
                  return (
                  <div key={u.id} className="bg-gray-50 rounded-xl">
                    {/* Header - immer sichtbar */}
                    <div 
                      className="p-3 cursor-pointer hover:bg-gray-100 rounded-xl flex items-center justify-between"
                      onClick={() => setExpandedUsers({...expandedUsers, [u.id]: !isExpanded})}
                    >
                      <div className="flex-1">
                        <div className="font-semibold text-sm">{u.name}</div>
                        <div className="text-xs text-gray-500">
                          {localTeams.find(t => t.id === u.teamId)?.name || 'Kein Team'} ‚Ä¢ {
                            u.teamRole === 'entrepreneur' ? 'Unternehmer' :
                            u.teamRole === 'department_head' ? 'Bereichsleitung' :
                            u.teamRole === 'lead' ? 'F√ºhrungskraft' :
                            u.teamRole === 'responsible' ? 'Verantwortlicher' : 'Bearbeiter'
                          }
                        </div>
                      </div>
                      <div className="flex items-center gap-2">
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            const hasTasks = tasks.some(t => t.userId === u.id);
                            if (hasTasks) {
                              alert('Dieser Benutzer kann nicht gel√∂scht werden, da ihm noch Tasks zugeordnet sind.');
                              return;
                            }
                            if (confirm(`Benutzer "${u.name}" wirklich l√∂schen?`)) {
                              saveScrollPosition();
                              const newUsers = localUsers.filter(x => x.id !== u.id);
                              setLocalUsers(newUsers);
                              saveUsers(newUsers);
                            }
                          }}
                          className="p-1 text-red-500 hover:bg-red-100 rounded"
                          title="L√∂schen"
                        >
                          <Trash2 className="w-4 h-4" />
                        </button>
                        <div className="text-xl text-gray-400">
                          {isExpanded ? '‚ñº' : '‚ñ∂'}
                        </div>
                      </div>
                    </div>
                    
                    {/* Details - nur wenn expanded */}
                    {isExpanded && (
                      <div className="px-3 pb-3 space-y-2">
                    <input type="text" value={u.name} 
                      onChange={(e) => { saveScrollPosition(); setLocalUsers(localUsers.map(x => x.id === u.id ? {...x, name: e.target.value} : x)); }} 
                      onBlur={() => { saveUsers(localUsers); }}
                      className="w-full p-2 border rounded" 
                      placeholder="Name" />
                    <select value={u.teamId || ''} 
                      onChange={(e) => { saveScrollPosition(); const newUsers = localUsers.map(x => x.id === u.id ? {...x, teamId: e.target.value} : x); setLocalUsers(newUsers); saveUsers(newUsers); }} 
                      className="w-full p-2 border rounded">
                      <option value="">Kein Team</option>
                      {localTeams.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                    </select>
                    <select value={u.teamRole || 'editor'} 
                      onChange={(e) => { saveScrollPosition(); const newUsers = localUsers.map(x => x.id === u.id ? {...x, teamRole: e.target.value} : x); setLocalUsers(newUsers); saveUsers(newUsers); }} 
                      className="w-full p-2 border rounded mb-2">
                      <option value="entrepreneur">Unternehmer</option>
                      <option value="department_head">Bereichsleitung</option>
                      <option value="lead">F√ºhrungskraft</option>
                      <option value="responsible">Verantwortlicher</option>
                      <option value="editor">Bearbeiter</option>
                    </select>
                    {(u.teamRole === 'department_head' || u.teamRole === 'entrepreneur') && (
                      <select value={u.departmentId || ''} 
                        onChange={(e) => { saveScrollPosition(); const newUsers = localUsers.map(x => x.id === u.id ? {...x, departmentId: e.target.value || null} : x); setLocalUsers(newUsers); saveUsers(newUsers); }} 
                        className="w-full p-2 border rounded mb-2 bg-yellow-50">
                        <option value="">Kein Bereich (sieht alle)</option>
                        {localDepartments.map(d => <option key={d.id} value={d.id}>{d.name}</option>)}
                      </select>
                    )}
                    {/* Arbeitszeiten Mo‚ÄìFr */}
                    <div className="mt-2 p-2 bg-white rounded border">
                      <div className="text-xs font-semibold text-gray-500 mb-1.5">Arbeitszeiten & Pausen</div>
                      <div className="space-y-1.5">
                        {[{d:1,l:'Mo'},{d:2,l:'Di'},{d:3,l:'Mi'},{d:4,l:'Do'},{d:5,l:'Fr'}].map(({d,l}) => {
                          const sched = u.dailySchedule || DEFAULT_SCHEDULE;
                          const dayS = sched[d] || {start:8, end:17, break1Start:9, break1Duration:0.25, break2Start:12.5, break2Duration:0.75};
                          const isOff = dayS.start >= dayS.end || (dayS.start === 0 && dayS.end === 0);
                          const toggleOff = () => {
                            saveScrollPosition();
                            const newSched = {...sched, [d]: isOff ? {start:8,end:17,break1Start:9,break1Duration:0.25,break2Start:12.5,break2Duration:0.75} : {start:0,end:0,break1Duration:0,break2Duration:0}};
                            const nu = localUsers.map(x => x.id === u.id ? {...x, dailySchedule: newSched} : x);
                            setLocalUsers(nu); saveUsers(nu);
                          };
                          const setVal = (field, raw) => {
                            saveScrollPosition();
                            const val = (field === 'break1Duration' || field === 'break2Duration') 
                              ? parseFloat(raw) || 0 
                              : t2h(raw);
                            const newSched = {...sched, [d]: {...dayS, [field]: val}};
                            const nu = localUsers.map(x => x.id === u.id ? {...x, dailySchedule: newSched} : x);
                            setLocalUsers(nu); saveUsers(nu);
                          };
                          const break1 = dayS.break1Duration || 0;
                          const break2 = (dayS.end > 13) ? (dayS.break2Duration || 0) : 0; // Pause 2 nur bei Vollzeit
                          const netHours = Math.max(0, (dayS.end - dayS.start) - break1 - break2);
                          return (
                            <div key={d} className="space-y-1">
                              <div className="flex items-center gap-1.5">
                                <span className="text-xs w-5 font-semibold text-gray-600">{l}</span>
                                {isOff ? (
                                  <span className="text-xs text-red-500 italic flex-1">frei</span>
                                ) : (
                                  <>
                                    <input 
                                      type="text" 
                                      defaultValue={h2t(dayS.start)}
                                      key={`start-${u.id}-${d}-${dayS.start}`}
                                      onBlur={(e) => {
                                        const formatted = formatTimeInput(e.target.value);
                                        if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                          setVal('start', formatted);
                                        }
                                      }}
                                      onKeyDown={(e) => {
                                        if (e.key === 'Enter') {
                                          const formatted = formatTimeInput(e.target.value);
                                          if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                            setVal('start', formatted);
                                            e.target.blur();
                                          }
                                        }
                                      }}
                                      className="text-xs border rounded px-1 py-0.5 flex-1" 
                                      style={{minWidth:0}}
                                      placeholder="HH:MM" 
                                    />
                                    <span className="text-xs text-gray-400">‚Äì</span>
                                    <input 
                                      type="text" 
                                      defaultValue={h2t(dayS.end)}
                                      key={`end-${u.id}-${d}-${dayS.end}`}
                                      onBlur={(e) => {
                                        const formatted = formatTimeInput(e.target.value);
                                        if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                          setVal('end', formatted);
                                        }
                                      }}
                                      onKeyDown={(e) => {
                                        if (e.key === 'Enter') {
                                          const formatted = formatTimeInput(e.target.value);
                                          if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                            setVal('end', formatted);
                                            e.target.blur();
                                          }
                                        }
                                      }}
                                      className="text-xs border rounded px-1 py-0.5 flex-1" 
                                      style={{minWidth:0}}
                                      placeholder="HH:MM"
                                    />
                                    <span className="text-xs text-gray-500 w-10 text-right font-semibold">{netHours.toFixed(2)}h</span>
                                  </>
                                )}
                                <button onClick={toggleOff}
                                  className={`text-xs px-1.5 py-0.5 rounded ml-auto ${isOff ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-600'}`}>
                                  {isOff ? 'An' : 'Aus'}
                                </button>
                              </div>
                              {!isOff && (
                                <div className="mt-1 ml-6 space-y-1">
                                  <div className="flex items-center gap-2 text-xs">
                                    <span className="text-xs font-medium text-gray-600 w-16">Pause 1:</span>
                                    <input 
                                      type="text" 
                                      defaultValue={h2t(dayS.break1Start || 9)}
                                      key={`b1s-${u.id}-${d}-${dayS.break1Start}`}
                                      onBlur={(e) => {
                                        const formatted = formatTimeInput(e.target.value);
                                        if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                          setVal('break1Start', formatted);
                                        }
                                      }}
                                      onKeyDown={(e) => {
                                        if (e.key === 'Enter') {
                                          const formatted = formatTimeInput(e.target.value);
                                          if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                            setVal('break1Start', formatted);
                                            e.target.blur();
                                          }
                                        }
                                      }}
                                      className="border rounded px-2 py-1 text-xs w-24" 
                                      placeholder="HH:MM"
                                      title="Pause 1 von" />
                                    <span className="text-gray-400">‚Äì</span>
                                    <input 
                                      type="text" 
                                      defaultValue={h2t((dayS.break1Start || 9) + (dayS.break1Duration || 0.25))}
                                      key={`b1e-${u.id}-${d}-${dayS.break1Duration}`}
                                      onBlur={(e) => {
                                        const formatted = formatTimeInput(e.target.value);
                                        if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                          const endTime = t2h(formatted);
                                          const startTime = dayS.break1Start || 9;
                                          const duration = Math.max(0, endTime - startTime);
                                          setVal('break1Duration', duration.toString());
                                        }
                                      }}
                                      onKeyDown={(e) => {
                                        if (e.key === 'Enter') {
                                          const formatted = formatTimeInput(e.target.value);
                                          if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                            const endTime = t2h(formatted);
                                            const startTime = dayS.break1Start || 9;
                                            const duration = Math.max(0, endTime - startTime);
                                            setVal('break1Duration', duration.toString());
                                            e.target.blur();
                                          }
                                        }
                                      }}
                                      className="border rounded px-2 py-1 text-xs w-24" 
                                      placeholder="HH:MM"
                                      title="Pause 1 bis" />
                                    <span className="text-[10px] text-gray-400 w-12 text-right">{(dayS.break1Duration || 0.25).toFixed(2)}h</span>
                                  </div>
                                  <div className="flex items-center gap-2 text-xs">
                                    <span className="text-xs font-medium text-gray-600 w-16">Pause 2:</span>
                                    <input 
                                      type="text" 
                                      defaultValue={h2t(dayS.break2Start || 12.5)}
                                      key={`b2s-${u.id}-${d}-${dayS.break2Start}`}
                                      onBlur={(e) => {
                                        const formatted = formatTimeInput(e.target.value);
                                        if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                          setVal('break2Start', formatted);
                                        }
                                      }}
                                      onKeyDown={(e) => {
                                        if (e.key === 'Enter') {
                                          const formatted = formatTimeInput(e.target.value);
                                          if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                            setVal('break2Start', formatted);
                                            e.target.blur();
                                          }
                                        }
                                      }}
                                      className="border rounded px-2 py-1 text-xs w-24" 
                                      placeholder="HH:MM"
                                      title="Pause 2 von" />
                                    <span className="text-gray-400">‚Äì</span>
                                    <input 
                                      type="text" 
                                      defaultValue={h2t((dayS.break2Start || 12.5) + (dayS.break2Duration || 0.75))}
                                      key={`b2e-${u.id}-${d}-${dayS.break2Duration}`}
                                      onBlur={(e) => {
                                        const formatted = formatTimeInput(e.target.value);
                                        if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                          const endTime = t2h(formatted);
                                          const startTime = dayS.break2Start || 12.5;
                                          const duration = Math.max(0, endTime - startTime);
                                          setVal('break2Duration', duration.toString());
                                        }
                                      }}
                                      onKeyDown={(e) => {
                                        if (e.key === 'Enter') {
                                          const formatted = formatTimeInput(e.target.value);
                                          if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                            const endTime = t2h(formatted);
                                            const startTime = dayS.break2Start || 12.5;
                                            const duration = Math.max(0, endTime - startTime);
                                            setVal('break2Duration', duration.toString());
                                            e.target.blur();
                                          }
                                        }
                                      }}
                                      className="border rounded px-2 py-1 text-xs w-24" 
                                      placeholder="HH:MM"
                                      title="Pause 2 bis" />
                                    <span className="text-[10px] text-gray-400 w-12 text-right">{(dayS.break2Duration || 0.75).toFixed(2)}h</span>
                                  </div>
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </div>
                      <div className="text-xs text-gray-400 mt-1.5 text-right border-t pt-1">
                        Œ£ {[1,2,3,4,5].reduce((s,d) => { 
                          const ds=(u.dailySchedule||DEFAULT_SCHEDULE)[d]||{start:8,end:17,break1Duration:0.25,break2Duration:0.75}; 
                          const gross=ds.end>ds.start?ds.end-ds.start:0; 
                          const b1=ds.break1Duration||0; 
                          const b2=(ds.end>13)?(ds.break2Duration||0):0; 
                          return s+Math.max(0,gross-b1-b2); 
                        }, 0).toFixed(2)}h/Woche
                      </div>
                    </div>
                      </div>
                    )}
                  </div>
                  );
                })}
              </div>
              <button onClick={() => {
                saveScrollPosition();
                const newUser = { 
                  id: 'p' + Date.now(), 
                  name: 'Neue Person', 
                  role: 'member', 
                  teamId: localTeams[0]?.id || null, 
                  teamRole: 'editor', 
                  dailySchedule: {
                    1:{start:8,end:17,break1Start:9,break1Duration:0.25,break2Start:12.5,break2Duration:0.75},
                    2:{start:8,end:17,break1Start:9,break1Duration:0.25,break2Start:12.5,break2Duration:0.75},
                    3:{start:8,end:17,break1Start:9,break1Duration:0.25,break2Start:12.5,break2Duration:0.75},
                    4:{start:8,end:17,break1Start:9,break1Duration:0.25,break2Start:12.5,break2Duration:0.75},
                    5:{start:8,end:17,break1Start:9,break1Duration:0.25,break2Start:12.5,break2Duration:0.75}
                  }, 
                  departmentId: null 
                };
                // Am ENDE einf√ºgen statt am Anfang - kein Scrollen mehr
                const newUsers = [...localUsers, newUser];
                setLocalUsers(newUsers); 
                saveUsers(newUsers);
                // Neuen User automatisch aufklappen
                setExpandedUsers({...expandedUsers, [newUser.id]: true});
                // Sortierung auf "Zuletzt hinzugef√ºgt" setzen
                setUserSort('recent');
              }} className="w-full p-3 bg-indigo-600 text-white rounded-xl">
                <Plus className="w-4 h-4 inline mr-2" /> Person hinzuf√ºgen
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  };


  const TeamDashboard = () => {
    // Berechne Team-Auslastung √ºber alle angezeigten Wochen
    const calculateTeamUtilization = (teamId) => {
      const members = getTeamMembers(teamId);
      let totalHours = 0;
      let totalCapacity = 0;
      
      Array.from({length: WEEKS_TO_SHOW}, (_, weekOffset) => {
        const weekNum = currentWeek + weekOffset;
        const weekDates = getWeekDates(weekNum, currentYear);
        
        members.forEach(member => {
          weekDates.forEach(d => {
            const ds = formatDate(d);
            tasks.forEach(t => {
              if (t.userId === member.id && ds >= t.startDate && ds <= t.endDate) {
                // NUR Stunden f√ºr DIESEN Tag addieren!
                totalHours += calculateDayNetHours(member.id, d, t.startHour, t.endHour);
              }
            });
          });
          totalCapacity += getWeekCapacity(member, weekDates);
        });
      });
      
      const utilizationPercent = totalCapacity > 0 ? (totalHours / totalCapacity) * 100 : 0;
      return {
        totalHours: Math.round(totalHours),
        totalCapacity: Math.round(totalCapacity),
        utilizationPercent: Math.round(utilizationPercent),
        freeCapacity: Math.round(totalCapacity - totalHours)
      };
    };

    // NEU: Berechne Team-Auslastung PRO WOCHE
    const calculateTeamUtilizationPerWeek = (teamId) => {
      const members = getTeamMembers(teamId);
      const weeklyData = [];
      
      Array.from({length: WEEKS_TO_SHOW}, (_, weekOffset) => {
        const weekNum = currentWeek + weekOffset;
        const weekDates = getWeekDates(weekNum, currentYear);
        
        let weekHours = 0;
        let weekCapacity = 0;
        
        members.forEach(member => {
          weekDates.forEach(d => {
            const ds = formatDate(d);
            tasks.forEach(t => {
              if (t.userId === member.id && ds >= t.startDate && ds <= t.endDate) {
                // NUR Stunden f√ºr DIESEN Tag addieren!
                weekHours += calculateDayNetHours(member.id, d, t.startHour, t.endHour);
              }
            });
          });
          weekCapacity += getWeekCapacity(member, weekDates);
        });
        
        const utilizationPercent = weekCapacity > 0 ? (weekHours / weekCapacity) * 100 : 0;
        weeklyData.push({
          weekNum,
          hours: Math.round(weekHours),
          capacity: Math.round(weekCapacity),
          utilization: Math.round(utilizationPercent),
          free: Math.round(weekCapacity - weekHours)
        });
      });
      
      return weeklyData;
    };

    // Bestimme relevante Teams basierend auf Rolle
    let relevantTeams = [];
    let viewMode = 'team';
    
    if (currentUser.teamRole === 'entrepreneur') {
      relevantTeams = teams;
      viewMode = 'entrepreneur';
    } else if (currentUser.teamRole === 'department_head') {
      if (currentUser.departmentId) {
        // Finde alle divisions im Bereich
        const departmentDivisions = divisions.filter(d => d.departmentId === currentUser.departmentId);
        const divisionIds = departmentDivisions.map(d => d.id);
        // Finde alle teams in diesen divisions
        relevantTeams = teams.filter(t => divisionIds.includes(t.divisionId));
      } else {
        relevantTeams = teams;
      }
      viewMode = 'department';
    } else if (currentUser.teamRole === 'lead') {
      relevantTeams = teams.filter(t => t.id === currentUser.teamId);
      viewMode = 'team';
    }

    return (
      <div className="min-h-screen bg-gradient-to-br from-indigo-50 to-purple-50">
        <div className="bg-white shadow-lg sticky top-0 z-10">
          <div className="max-w-full mx-auto px-6 py-4 flex justify-between">
            <div className="flex items-center gap-3">
              <BarChart3 className="w-6 h-6 text-indigo-600" />
              <h1 className="text-xl font-bold">
                {viewMode === 'entrepreneur' && 'Unternehmens-Dashboard - Alle Teams'}
                {viewMode === 'department' && `Bereichs-Dashboard${currentUser.departmentId ? ' - ' + departments.find(d => d.id === currentUser.departmentId)?.name : ' - Alle Bereiche'}`}
                {viewMode === 'team' && 'Team-Dashboard'}
              </h1>
            </div>
            <div className="flex gap-2 items-center">
              {/* Schriftgr√∂√üe-Slider */}
              <div className="flex items-center gap-2 px-3 py-2 bg-gray-100 rounded-2xl">
                <span className="text-xs text-gray-600">A</span>
                <input 
                  type="range" 
                  min="10" 
                  max="30" 
                  value={dashboardFontSize} 
                  onChange={(e) => setDashboardFontSize(Number(e.target.value))}
                  className="w-32"
                  title={`Schriftgr√∂√üe: ${dashboardFontSize}px`}
                />
                <span className="text-lg font-bold text-gray-800">A</span>
              </div>
              
              {/* Undo/Redo/History Buttons */}
              <button 
                onClick={undo} 
                disabled={undoStack.length === 0}
                className={`p-3 rounded-2xl ${undoStack.length > 0 ? 'hover:bg-gray-100' : 'opacity-30 cursor-not-allowed'}`}
                title={`R√ºckg√§ngig (${undoStack.length} verf√ºgbar)`}>
                ‚Ü∂
              </button>
              <button 
                onClick={redo} 
                disabled={redoStack.length === 0}
                className={`p-3 rounded-2xl ${redoStack.length > 0 ? 'hover:bg-gray-100' : 'opacity-30 cursor-not-allowed'}`}
                title={`Wiederholen (${redoStack.length} verf√ºgbar)`}>
                ‚Ü∑
              </button>
              <button 
                onClick={() => setShowHistory(!showHistory)} 
                className={`p-3 rounded-2xl ${showHistory ? 'bg-blue-100' : 'hover:bg-gray-100'}`}
                title="√Ñnderungshistorie">
                üìú
              </button>
              
              {/* Navigation Buttons */}
              <button 
                onClick={() => { setShowDashboard(false); setShowProjectDashboard(false); setShowProjectPlanning(false); }} 
                className="px-4 py-2 rounded-2xl bg-gray-100 hover:bg-gray-200"
              >
                <Calendar className="w-4 h-4 inline mr-2" />Planung
              </button>
              <button 
                className="px-4 py-2 rounded-2xl bg-green-600 text-white"
              >
                <BarChart3 className="w-4 h-4 inline mr-2" />Team Dashboard
              </button>
              <button 
                onClick={() => { setShowDashboard(false); setShowProjectDashboard(true); setShowProjectPlanning(false); }} 
                className="px-4 py-2 rounded-2xl bg-gray-100 hover:bg-gray-200"
              >
                <BarChart3 className="w-4 h-4 inline mr-2" />Projekt Dashboard
              </button>
              <button 
                onClick={() => { setShowDashboard(false); setShowProjectDashboard(false); setShowProjectPlanning(true); }} 
                className="px-4 py-2 rounded-2xl bg-gray-100 hover:bg-gray-200"
              >
                üèóÔ∏è Projektplanung
              </button>
              
              {currentUser.role === 'admin' && (
                <button onClick={() => setShowAdmin(true)} className="px-4 py-2 bg-purple-600 text-white rounded-2xl">
                  Admin
                </button>
              )}
              <button onClick={() => setShowSettings(true)} className="p-3 hover:bg-gray-100 rounded-2xl">
                <Settings className="w-5 h-5" />
              </button>
              <button onClick={() => { setCurrentUser(null); setSelectedUser(null); setShowLogin(true); setShowDashboard(false); }} 
                className="px-4 py-2 bg-gray-100 rounded-2xl">
                <LogOut className="w-4 h-4 inline mr-2" />Abmelden
              </button>
            </div>
          </div>
        </div>

        <div className="w-full px-2 py-6">
          <div className="bg-white shadow mb-4 rounded-2xl">
            <div className="px-6 py-4 flex justify-between items-center">
              <button onClick={() => setCurrentWeek(w => w === 1 ? 52 : w - 1)} className="px-4 py-2 bg-indigo-600 text-white rounded-2xl">
                <ChevronLeft className="w-5 h-5" />
              </button>
              <div className="font-bold">KW {currentWeek} - {currentWeek + WEEKS_TO_SHOW - 1}</div>
              <button onClick={() => setCurrentWeek(w => w === 52 ? 1 : w + 1)} className="px-4 py-2 bg-indigo-600 text-white rounded-2xl">
                <ChevronRight className="w-5 h-5" />
              </button>
            </div>
          </div>

          {/* TEAM-√úBERSICHTSKARTEN */}
          <div className="grid grid-cols-1 lg:grid-cols-2 2xl:grid-cols-3 gap-4 mb-6 dashboard-cards" style={{gridTemplateColumns: 'repeat(auto-fit, minmax(500px, 1fr))'}}>
            {relevantTeams.map(team => {
              const teamUtil = calculateTeamUtilization(team.id);
              const weeklyUtil = calculateTeamUtilizationPerWeek(team.id);
              const isExpanded = expandedTeams[team.id];
              // Hierarchie: team -> division -> department
              const teamDivision = divisions.find(d => d.id === team.divisionId);
              const teamDept = teamDivision ? departments.find(d => d.id === teamDivision.departmentId) : null;
              const members = getTeamMembers(team.id);
              
              return (
                <div key={team.id} className="bg-white rounded-2xl shadow-lg overflow-hidden border-2 border-gray-100">
                  {/* Team Header mit Auslastung */}
                  <div 
                    onClick={() => setExpandedTeams({...expandedTeams, [team.id]: !isExpanded})}
                    className="bg-gradient-to-r from-indigo-500 to-purple-500 p-4 cursor-pointer hover:from-indigo-600 hover:to-purple-600 transition-colors"
                  >
                    <div className="flex justify-between items-start mb-3">
                      <div className="flex-1">
                        <h3 className="text-lg font-bold text-white">{team.name}</h3>
                        {viewMode === 'entrepreneur' && (
                          <p className="text-sm text-purple-100">
                            {teamDivision?.name}{teamDept ? ` ‚Ä¢ ${teamDept.name}` : ''}
                          </p>
                        )}
                        <p className="text-xs text-purple-200 mt-1">{members.length} Mitarbeiter</p>
                      </div>
                      <div className="text-white">
                        {isExpanded ? <ChevronUp className="w-5 h-5" /> : <ChevronDown className="w-5 h-5" />}
                      </div>
                    </div>
                    
                    {/* Gro√üe Auslastungs-Anzeige */}
                    <div className="bg-white/20 rounded-xl p-3 backdrop-blur-sm">
                      <div className="flex justify-between items-end mb-2">
                        <div>
                          <div className="text-3xl font-bold text-white">{teamUtil.utilizationPercent}%</div>
                          <div className="text-xs text-purple-100">Auslastung</div>
                        </div>
                        <div className="text-right">
                          <div className="text-sm font-semibold text-white">{teamUtil.totalHours}h / {teamUtil.totalCapacity}h</div>
                          <div className="text-xs text-purple-100">
                            {teamUtil.freeCapacity > 0 ? `${teamUtil.freeCapacity}h frei` : '√úberlastet!'}
                          </div>
                        </div>
                      </div>
                      
                      {/* Balken */}
                      <div className="w-full bg-white/30 rounded-full h-3 overflow-hidden mb-3">
                        <div 
                          className={`h-full transition-all ${
                            teamUtil.utilizationPercent > 100 ? 'bg-red-400' :
                            teamUtil.utilizationPercent > 90 ? 'bg-orange-400' :
                            teamUtil.utilizationPercent > 70 ? 'bg-yellow-400' :
                            'bg-green-400'
                          }`}
                          style={{width: `${Math.min(teamUtil.utilizationPercent, 100)}%`}}
                        />
                      </div>
                      
                      {/* Wochen-√úbersicht */}
                      <div className="grid grid-cols-4 gap-2">
                        {weeklyUtil.map((week, idx) => (
                          <div key={idx} className="bg-white/30 rounded-lg p-2">
                            <div className="text-xs font-semibold text-white mb-1 text-center">KW {week.weekNum}</div>
                            
                            {/* Prozent-Anzeige */}
                            <div className={`text-lg font-bold text-center mb-2 ${
                              week.utilization > 100 ? 'text-red-200' :
                              week.utilization > 90 ? 'text-orange-200' :
                              week.utilization > 70 ? 'text-yellow-200' :
                              'text-green-200'
                            }`}>
                              {week.utilization}%
                            </div>
                            
                            {/* F√ºllstandsbalken */}
                            <div className="w-full bg-white/20 rounded-full h-2 overflow-hidden mb-2">
                              <div 
                                className={`h-full transition-all ${
                                  week.utilization > 100 ? 'bg-red-300' :
                                  week.utilization > 90 ? 'bg-orange-300' :
                                  week.utilization > 70 ? 'bg-yellow-300' :
                                  'bg-green-300'
                                }`}
                                style={{width: `${Math.min(week.utilization, 100)}%`}}
                              />
                            </div>
                            
                            {/* Stunden */}
                            <div className="text-xs text-purple-100 text-center">{week.hours}h / {week.capacity}h</div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                  
                  {/* Mitglieder-Liste (aufklappbar) */}
                  {isExpanded && (
                    <div className="p-4 bg-gray-50">
                      <h4 className="font-semibold text-sm text-gray-600 mb-3">Teammitglieder:</h4>
                      <div className="grid grid-cols-1 xl:grid-cols-2 gap-2">
                        {members.map(member => {
                          const isMemberExpanded = expandedMembers[member.id];
                          
                          // Berechne Mitarbeiter-Auslastung
                          let memberTotalHours = 0;
                          let memberTotalCapacity = 0;
                          Array.from({length: WEEKS_TO_SHOW}, (_, weekOffset) => {
                            const weekNum = currentWeek + weekOffset;
                            const weekDates = getWeekDates(weekNum, currentYear);
                            weekDates.forEach(d => {
                              const ds = formatDate(d);
                              tasks.forEach(t => {
                                if (t.userId === member.id && ds >= t.startDate && ds <= t.endDate) {
                                  // NUR Stunden f√ºr DIESEN Tag addieren, nicht den ganzen Task!
                                  memberTotalHours += calculateDayNetHours(member.id, d, t.startHour, t.endHour);
                                }
                              });
                            });
                            memberTotalCapacity += getWeekCapacity(member, weekDates);
                          });
                          const memberUtil = memberTotalCapacity > 0 ? (memberTotalHours / memberTotalCapacity) * 100 : 0;
                          
                          return (
                            <div key={member.id} className="bg-white rounded-xl border border-gray-200 overflow-hidden">
                              <div 
                                onClick={() => setExpandedMembers({...expandedMembers, [member.id]: !isMemberExpanded})}
                                className="p-3 flex justify-between items-center cursor-pointer hover:bg-gray-50"
                              >
                                <div className="flex items-center gap-3 flex-1">
                                  <div className="flex-1 min-w-0">
                                    <div className="flex items-center gap-3 mb-2">
                                      <span className="font-medium text-gray-800" style={{fontSize: `${dashboardFontSize + 2}px`}}>{member.name}</span>
                                      <button 
                                        onClick={(e) => { e.stopPropagation(); setDetailViewUser(member); }}
                                        className="p-1 hover:bg-indigo-100 rounded transition-colors" 
                                        title="Detailansicht"
                                      >
                                        <Eye className="w-4 h-4 text-indigo-600" />
                                      </button>
                                    </div>
                                    {/* F√ºllstandsbalken */}
                                    <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                      <div 
                                        className={`h-full transition-all ${
                                          memberUtil > 100 ? 'bg-red-500' :
                                          memberUtil > 90 ? 'bg-orange-500' :
                                          memberUtil > 70 ? 'bg-yellow-500' :
                                          'bg-green-500'
                                        }`}
                                        style={{width: `${Math.min(memberUtil, 100)}%`}}
                                      />
                                    </div>
                                  </div>
                                </div>
                                <div className="flex items-center gap-3">
                                  <div className="text-right">
                                    <div className={`font-semibold ${
                                      memberUtil > 100 ? 'text-red-600' :
                                      memberUtil > 90 ? 'text-orange-600' :
                                      memberUtil > 70 ? 'text-yellow-600' :
                                      'text-green-600'
                                    }`} style={{fontSize: `${dashboardFontSize + 2}px`}}>
                                      {Math.round(memberUtil)}%
                                    </div>
                                    <div className="text-gray-500" style={{fontSize: `${dashboardFontSize}px`}}>{Math.round(memberTotalHours)}h / {Math.round(memberTotalCapacity)}h</div>
                                  </div>
                                  {isMemberExpanded ? <ChevronUp className="w-4 h-4 text-gray-400" /> : <ChevronDown className="w-4 h-4 text-gray-400" />}
                                </div>
                              </div>
                              
                              {/* Wochen-Details pro Mitarbeiter */}
                              {isMemberExpanded && (
                                <div className="px-3 pb-3 pt-1 bg-gray-50 border-t">
                                  <div className="flex gap-2 overflow-hidden">
                                    {Array.from({length: WEEKS_TO_SHOW}, (_, weekOffset) => {
                                      const weekNum = currentWeek + weekOffset;
                                      const weekDates = getWeekDates(weekNum, currentYear);
                                      
                                      // Wochen-Gesamt berechnen
                                      let weekTotal = 0;
                                      let weekCapacity = getWeekCapacity(member, weekDates);
                                      weekDates.forEach(d => {
                                        const ds = formatDate(d);
                                        tasks.forEach(t => {
                                          if (t.userId === member.id && ds >= t.startDate && ds <= t.endDate) {
                                            weekTotal += calculateDayNetHours(member.id, d, t.startHour, t.endHour);
                                          }
                                        });
                                      });
                                      const weekUtil = weekCapacity > 0 ? (weekTotal / weekCapacity) * 100 : 0;
                                      
                                      return (
                                        <div key={weekNum} className="flex-shrink-0 bg-white rounded-lg p-2 border border-gray-200" style={{minWidth: '220px'}}>
                                          <div className="font-semibold mb-1 text-center text-gray-700" style={{fontSize: `${dashboardFontSize + 1}px`}}>KW {weekNum}</div>
                                          
                                          {/* Wochen-F√ºllstandsbalken */}
                                          <div className="mb-2">
                                            <div className="flex justify-between items-center mb-1" style={{fontSize: `${dashboardFontSize}px`}}>
                                              <span className={`font-semibold ${
                                                weekUtil > 100 ? 'text-red-600' :
                                                weekUtil > 90 ? 'text-orange-600' :
                                                weekUtil > 70 ? 'text-yellow-600' :
                                                'text-green-600'
                                              }`}>{Math.round(weekUtil)}%</span>
                                              <span className="text-gray-500 text-xs">{weekTotal.toFixed(1)}h / {weekCapacity}h</span>
                                            </div>
                                            <div className="w-full bg-gray-200 rounded-full h-1.5 overflow-hidden">
                                              <div 
                                                className={`h-full transition-all ${
                                                  weekUtil > 100 ? 'bg-red-500' :
                                                  weekUtil > 90 ? 'bg-orange-500' :
                                                  weekUtil > 70 ? 'bg-yellow-500' :
                                                  'bg-green-500'
                                                }`}
                                                style={{width: `${Math.min(weekUtil, 100)}%`}}
                                              />
                                            </div>
                                          </div>
                                          
                                          <div className="space-y-1">
                                            {weekDates.slice(1, 6).map((d, i) => {
                                              const ds = formatDate(d);
                                              let tot = 0;
                                              tasks.forEach(t => {
                                                if (t.userId === member.id && ds >= t.startDate && ds <= t.endDate) {
                                                  // Nur Stunden f√ºr DIESEN Tag berechnen, nicht den ganzen Task!
                                                  tot += calculateDayNetHours(member.id, d, t.startHour, t.endHour);
                                                }
                                              });
                                              const isVac = isVacation(member.id, d);
                                              const isNonWork = isNonWorkingDay(member, d);
                                              const dayCapacity = getDailyHours(member, d);
                                              const utilization = dayCapacity > 0 ? (tot / dayCapacity) * 100 : 0;
                                              
                                              return (
                                                <div key={i} className="space-y-1">
                                                  <div className="flex justify-between items-center" style={{fontSize: `${dashboardFontSize}px`}}>
                                                    <span className="text-gray-600">
                                                      {['Mo','Di','Mi','Do','Fr'][i]} {d.getDate()}.{d.getMonth()+1}
                                                    </span>
                                                    <span className={`font-semibold ${
                                                      isVac ? 'text-orange-600' : 
                                                      isNonWork ? 'text-gray-400' :
                                                      tot > dayCapacity ? 'text-red-600' : 
                                                      tot > 0 ? 'text-green-600' : 
                                                      'text-gray-400'
                                                    }`}>
                                                      {isVac ? 'üèñÔ∏è' : isNonWork ? 'frei' : `${tot.toFixed(2)}h`}
                                                    </span>
                                                  </div>
                                                  
                                                  {/* F√ºllstandsanzeige */}
                                                  {!isVac && !isNonWork && dayCapacity > 0 && (
                                                    <div className="w-full bg-gray-200 rounded-full h-1.5 overflow-hidden">
                                                      <div 
                                                        className={`h-full transition-all ${
                                                          utilization > 100 ? 'bg-red-500' :
                                                          utilization > 90 ? 'bg-orange-500' :
                                                          utilization > 70 ? 'bg-yellow-500' :
                                                          utilization > 0 ? 'bg-green-500' :
                                                          'bg-gray-400'
                                                        }`}
                                                        style={{width: `${Math.min(utilization, 100)}%`}}
                                                        title={`${Math.round(utilization)}% ausgelastet`}
                                                      />
                                                    </div>
                                                  )}
                                                </div>
                                              );
                                            })}
                                          </div>
                                          
                                          {/* Notizen f√ºr diese Woche - IMMER SICHTBAR */}
                                          {(() => {
                                            const weekNote = getWeekNote(member.id, weekNum);
                                            const noteText = weekNote?.text?.trim() || '';
                                            return (
                                              <div className="mt-2 pt-2 border-t border-gray-200">
                                                <div className="flex items-start gap-1">
                                                  <StickyNote className="w-3 h-3 text-indigo-500 mt-0.5 flex-shrink-0" />
                                                  <div className="flex-1" style={{fontSize: `${dashboardFontSize}px`}}>
                                                    {noteText ? (
                                                      <div className="text-gray-700 bg-yellow-50 p-1.5 rounded border border-yellow-200 whitespace-pre-line">{noteText}</div>
                                                    ) : (
                                                      <div className="text-gray-400 italic">Keine Notizen</div>
                                                    )}
                                                  </div>
                                                </div>
                                              </div>
                                            );
                                          })()}
                                        </div>
                                      );
                                    })}
                                  </div>
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        </div>

        {/* Detailansicht Modal */}
        {detailViewUser && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-3xl p-6 w-full max-h-[90vh] overflow-y-auto" style={{maxWidth: '95%'}}>
              <div className="flex justify-between mb-6">
                <h2 className="text-2xl font-bold">Detailansicht: {detailViewUser.name}</h2>
                <button onClick={() => setDetailViewUser(null)} className="text-2xl">‚úï</button>
              </div>
              
              <div className="flex gap-4">
                <div className="w-56 bg-gray-50 rounded-2xl p-4 flex-shrink-0 flex flex-col" style={{maxHeight: '500px'}}>
                  <h3 className="font-bold mb-3">Projekte</h3>
                  <div className="space-y-2 overflow-y-auto flex-1">
                    {projects.sort((a, b) => a.name.localeCompare(b.name)).map(p => (
                      <div key={p.id} className="flex items-center gap-2 p-3 rounded-xl bg-white border-2" style={{borderColor: p.color}}>
                        <div className="w-4 h-4 rounded" style={{backgroundColor: p.color}}></div>
                        <span className="flex-1 text-sm">{p.name}</span>
                      </div>
                    ))}
                  </div>
                </div>
                <div className="flex-1 overflow-x-auto" ref={ganttScrollRef}>
                  <div className="flex gap-4">
                    {Array.from({length: WEEKS_TO_SHOW}, (_, i) => {
                      const weekNum = currentWeek + i;
                      return <WeekColumn key={weekNum} weekNum={weekNum} user={detailViewUser} />;
                    })}
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

        {showAdmin && <AdminPanel />}
        
        {/* Settings Modal */}
        {showSettings && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-3xl p-6 max-w-md w-full">
              <div className="flex justify-between mb-6">
                <h2 className="text-2xl font-bold">Einstellungen</h2>
                <button onClick={() => setShowSettings(false)} className="text-2xl">‚úï</button>
              </div>
              <p className="text-gray-600">
                Die vollst√§ndigen Einstellungen sind in der Planung-Ansicht verf√ºgbar.<br/><br/>
                Bitte gehe zur Planung, um alle Einstellungen zu bearbeiten.
              </p>
              <button 
                onClick={() => { setShowSettings(false); setShowDashboard(false); setShowProjectDashboard(false); }}
                className="mt-4 w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
              >
                Zur Planung wechseln
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  const WeekColumn = ({ weekNum, user }) => {
    const weekDates = getWeekDates(weekNum, currentYear);
    if (weekDates.length === 0) return null;
    const weekNote = getWeekNote(user.id, weekNum);
    const isNoteExpanded = expandedNotes[`${user.id}-${weekNum}`] !== false;
    const [localNoteText, setLocalNoteText] = React.useState(weekNote?.text || '');
    React.useEffect(() => { setLocalNoteText(weekNote?.text || ''); }, [weekNote?.text]);

    return (
      <div className="flex-shrink-0" style={{width: 7 * DW + 50}}>
        <div className="bg-gray-50 rounded-2xl p-4">
          <h3 className="text-lg font-bold mb-2 text-center">KW {weekNum}</h3>
          
          {/* Button: Aus Vorwoche kopieren */}
          <div className="mb-3 flex justify-center">
            <button 
              onClick={() => copyTasksFromPreviousWeek(user.id, weekNum)}
              className="px-3 py-1.5 bg-indigo-500 text-white text-xs rounded-lg hover:bg-indigo-600 transition-colors flex items-center gap-1"
              title="Alle Aufgaben aus KW {weekNum - 1} in diese Woche kopieren"
            >
              <Copy className="w-3 h-3" />
              Aus KW {weekNum - 1} kopieren
            </button>
          </div>
          
          <div className="flex mb-1" style={{marginLeft: '40px'}}>
            <div style={{display: 'grid', gridTemplateColumns: `repeat(7, ${DW}px)`, width: 7 * DW}}>
              {weekDates.map((d, i) => {
                const isVacationDay = isVacation(user.id, d);
                const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                const isNonWork = isNonWorkingDay(user, d);
                return (
                  <div key={i} className="flex justify-center">
                    {!isWeekend && !isNonWork && (
                      <button onClick={(e) => { e.preventDefault(); e.stopPropagation(); toggleVacation(user.id, d); }}
                        className={`p-1 rounded transition-all ${isVacationDay ? 'bg-orange-400 text-white hover:bg-orange-500' : 'bg-gray-100 text-gray-400 hover:bg-gray-200'}`}
                        title={isVacationDay ? 'Urlaub entfernen' : 'Urlaub markieren'}>
                        <Umbrella className="w-4 h-4" />
                      </button>
                    )}
                  </div>
                );
              })}
            </div>
          </div>
          <div className="flex mb-2" style={{marginLeft: '40px'}}>
            <div style={{display: 'grid', gridTemplateColumns: `repeat(7, ${DW}px)`, width: 7 * DW}}>
              {weekDates.map((d, i) => {
                const isWe = d.getDay() === 0 || d.getDay() === 6;
                const isNonWork = isNonWorkingDay(user, d);
                const dayS = getDaySchedule(user, d);
                return (
                  <div key={i} className={`text-center flex flex-col justify-center ${(isWe || isNonWork) ? 'bg-gray-300' : 'bg-white border border-gray-200'}`} style={{height: '60px'}}>
                    <div className="text-xs font-semibold">{['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'][d.getDay()]}</div>
                    <div className="text-sm">{d.getDate()}.{d.getMonth() + 1}</div>
                    {!isWe && (
                      <div className={`text-xs mt-0.5 ${isNonWork ? 'text-gray-500 font-semibold' : 'text-gray-400'}`}>
                        {isNonWork ? 'frei' : `${h2t(dayS.start)}‚Äì${h2t(dayS.end)}`}
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          </div>
          <div className="flex">
            <div className="flex flex-col justify-between text-xs text-gray-500 pr-2" style={{width: '40px'}}>
              {Array.from({length: GRID_ROWS}, (_, i) => GRID_END - 1 - i).map(h => (
                <div key={h} className="text-right" style={{height: HH, lineHeight: `${HH}px`}}>{h}:00</div>
              ))}
            </div>
            <div className="relative bg-white rounded-xl" style={{width: 7 * DW, height: GRID_ROWS * HH}}
              onDrop={(e) => {
                e.preventDefault();
                if (draggedProject) {
                  const rect = e.currentTarget.getBoundingClientRect();
                  const x = e.clientX - rect.left;
                  const y = e.clientY - rect.top;
                  const day = Math.floor(x / DW);
                  const hourFloat = GRID_END - (y / HH);
                  const hour = Math.round(hourFloat * 4) / 4; // Auf 0,25h runden
                  
                  // Pr√ºfe ob Urlaubstag
                  const dropDate = weekDates[day];
                  const isVacationDay = dropDate && isVacation(user.id, dropDate);
                  
                  if (day >= 0 && day < 7 && hour >= GRID_START && hour < GRID_END && !isVacationDay) {
                    addTask(user.id, draggedProject.id, weekDates[day], hour, Math.min(hour + 2, GRID_END));
                  }
                  setDraggedProject(null);
                }
              }}
              onDragOver={(e) => e.preventDefault()}>
              <div className="absolute inset-0" style={{display: 'grid', gridTemplateColumns: `repeat(7, ${DW}px)`, gridTemplateRows: `repeat(${GRID_ROWS}, ${HH}px)`}}>
                {Array.from({length: GRID_ROWS * 7}, (_, i) => {
                  const dayIndex  = i % 7;
                  const rowIndex  = Math.floor(i / 7);
                  const hourSlot  = GRID_END - 1 - rowIndex;
                  const dateForDay = weekDates[dayIndex];
                  const isWe       = dateForDay?.getDay() === 0 || dateForDay?.getDay() === 6;
                  const isVacDay   = dateForDay && isVacation(user.id, dateForDay);
                  const isNonWork  = dateForDay && isNonWorkingDay(user, dateForDay);
                  const isWorkH    = dateForDay && isWorkingHour(user, dateForDay, hourSlot);
                  // Farb-Priorit√§t: Urlaub > Wochenende/frei > au√üerhalb Arbeitszeit > normal
                  let bg = '';
                  if (isVacDay)              bg = 'bg-orange-100';
                  else if (isWe || isNonWork) bg = 'bg-gray-200';
                  else if (!isWorkH)         bg = 'bg-gray-100';
                  return <div key={i} className={`border border-gray-100 ${bg}`}></div>;
                })}
              </div>
              {/* Pausenbalken als proportionale Overlays */}
              {weekDates.map((d, dayIdx) => {
                const dayNum = d.getDay();
                if (dayNum === 0 || dayNum === 6) return null;
                
                // Richtigen Schedule holen
                const userSchedule = user?.dailySchedule || DEFAULT_SCHEDULE;
                const sched = userSchedule[dayNum] || DEFAULT_SCHEDULE[dayNum];
                if (!sched) return null;
                
                const breakBars = [];
                
                // Nicht-Arbeitszeit VOR Arbeitsbeginn (grau) - 0,25h genau
                if (sched.start > GRID_START) {
                  const bottom = 0;
                  const height = (sched.start - GRID_START) * HH;
                  breakBars.push(
                    <div key={`${dayIdx}-before`} 
                      className="absolute bg-gray-100 pointer-events-none"
                      style={{
                        left: dayIdx * DW,
                        width: DW,
                        bottom: bottom,
                        height: height,
                        borderTop: '1px solid rgba(0,0,0,0.1)'
                      }}
                    />
                  );
                }
                
                // Nicht-Arbeitszeit NACH Arbeitsende (grau) - 0,25h genau
                if (sched.end < GRID_END) {
                  const bottom = (sched.end - GRID_START) * HH;
                  const height = (GRID_END - sched.end) * HH;
                  breakBars.push(
                    <div key={`${dayIdx}-after`} 
                      className="absolute bg-gray-100 pointer-events-none"
                      style={{
                        left: dayIdx * DW,
                        width: DW,
                        bottom: bottom,
                        height: height,
                        borderBottom: '1px solid rgba(0,0,0,0.1)'
                      }}
                    />
                  );
                }
                
                // Pause 1 - nur wenn explizit konfiguriert
                if (sched.break1Start !== undefined && sched.break1Duration > 0) {
                  const bottom = (sched.break1Start - GRID_START) * HH;
                  const height = sched.break1Duration * HH;
                  breakBars.push(
                    <div key={`${dayIdx}-b1`} 
                      className="absolute break-stripe pointer-events-none rounded"
                      style={{
                        left: dayIdx * DW,
                        width: DW,
                        bottom: bottom,
                        height: height
                      }}
                    />
                  );
                }
                
                // Pause 2 - nur wenn explizit konfiguriert UND Vollzeit
                const workEnd = sched.end || 17;
                const hasBreak2 = workEnd > 13;
                if (hasBreak2 && sched.break2Start !== undefined && sched.break2Duration > 0) {
                  const bottom = (sched.break2Start - GRID_START) * HH;
                  const height = sched.break2Duration * HH;
                  breakBars.push(
                    <div key={`${dayIdx}-b2`} 
                      className="absolute break-stripe pointer-events-none rounded"
                      style={{
                        left: dayIdx * DW,
                        width: DW,
                        bottom: bottom,
                        height: height
                      }}
                    />
                  );
                }
                
                return breakBars;
              }).flat()}
              {tasks.filter(t => t.userId === user.id).map(t => {
                const isDrag = draggedTask?.task?.id === t.id;
                const isResize = resizingTask?.task?.id === t.id;
                const startDate = isDrag && draggedTask.previewStartDate ? draggedTask.previewStartDate : t.startDate;
                const endDate = isDrag && draggedTask.previewEndDate ? draggedTask.previewEndDate : isResize && resizingTask.previewEndDate ? resizingTask.previewEndDate : t.endDate;
                const startHour = isDrag && draggedTask.previewStartHour !== undefined ? draggedTask.previewStartHour : isResize && resizingTask.previewStartHour !== undefined ? resizingTask.previewStartHour : t.startHour;
                const endHour = isDrag && draggedTask.previewEndHour !== undefined ? draggedTask.previewEndHour : isResize && resizingTask.previewEndHour !== undefined ? resizingTask.previewEndHour : t.endHour;
                const st = new Date(startDate + 'T12:00:00');
                const ed = new Date(endDate + 'T12:00:00');
                const fd = new Date(weekDates[0]);
                fd.setHours(12, 0, 0, 0);
                const diff = Math.round((st - fd) / 86400000);
                if (diff < 0 || diff >= 7) return null;
                const days = Math.round((ed - st) / 86400000) + 1;
                const proj = projects.find(p => p.id === t.projectId);
                const netHours = calculateNetHours(startHour, endHour, startDate, endDate, t.userId);
                const bottomPos = (startHour - GRID_START) * HH;
                const heightVal = Math.max((endHour - startHour) * HH, HH);
                return (
                  <div key={t.id} onMouseDown={(e) => { e.preventDefault(); setDraggedTask({ task: t, startX: e.clientX, startY: e.clientY }); }}
                    style={{ left: diff * DW, width: days * DW, bottom: bottomPos, height: heightVal, backgroundColor: proj?.color, opacity: 0.7 }} 
                    className="absolute rounded-lg shadow-lg flex flex-col items-center justify-center text-white font-bold cursor-move group">
                    <div onMouseDown={(e) => { e.stopPropagation(); setResizingTask({ task: t, dir: 'top', startX: e.clientX, startY: e.clientY, origEnd: t.endHour }); }}
                      className="absolute top-0 left-0 right-0 h-2 cursor-ns-resize hover:bg-black/20 z-10" />
                    <div className="text-xs pointer-events-none">{proj?.name}</div>
                    <div className="text-xs pointer-events-none opacity-80">{h2t(startHour)}‚Äì{h2t(endHour)}</div>
                    <div className="text-xs pointer-events-none">
                      {netHours.break > 0 ? (
                        <span title={`${netHours.gross.toFixed(2)}h brutto - ${netHours.break.toFixed(2)}h Pause`}>
                          {netHours.net.toFixed(2)}h
                        </span>
                      ) : (
                        `${netHours.net.toFixed(2)}h`
                      )}
                    </div>
                    <div onMouseDown={(e) => { e.stopPropagation(); setResizingTask({ task: t, dir: 'right', startX: e.clientX, startY: e.clientY }); }}
                      className="absolute right-0 top-0 bottom-0 w-2 cursor-ew-resize hover:bg-black/20 z-10" />
                    <div onMouseDown={(e) => { e.stopPropagation(); setResizingTask({ task: t, dir: 'bottom', startX: e.clientX, startY: e.clientY, origStart: t.startHour }); }}
                      className="absolute bottom-0 left-0 right-0 h-2 cursor-ns-resize hover:bg-black/20 z-10" />
                    
                    {/* Button: In n√§chste Woche kopieren */}
                    <button 
                      onMouseDown={(e) => e.stopPropagation()} 
                      onClick={(e) => { e.stopPropagation(); copyTaskToNextWeek(t); }} 
                      className="absolute top-1 right-7 opacity-0 group-hover:opacity-100 bg-green-500 hover:bg-green-600 rounded-lg p-1 z-20 min-w-[18px] min-h-[18px] flex items-center justify-center"
                      title="In n√§chste Woche kopieren"
                    >
                      <ArrowRight className="w-3 h-3" />
                    </button>
                    
                    {/* Button: L√∂schen */}
                    <button onMouseDown={(e) => e.stopPropagation()} onClick={(e) => { e.stopPropagation(); deleteTask(t.id); }} 
                      className="absolute top-1 right-1 opacity-0 group-hover:opacity-100 bg-red-500 rounded-lg p-1 z-20 min-w-[18px] min-h-[18px] flex items-center justify-center">
                      <Trash2 className="w-3 h-3" />
                    </button>
                  </div>
                );
              })}
            </div>
          </div>
          <div className="border-t-2 mt-3 pt-3" style={{marginLeft: '40px'}}>
            <div style={{display: 'grid', gridTemplateColumns: `repeat(7, ${DW}px)`, width: 7 * DW}}>
              {weekDates.map((d, i) => {
                const ds = formatDate(d);
                let tot = 0;
                const dayNum = d.getDay();
                const sched = (user?.dailySchedule || DEFAULT_SCHEDULE)[dayNum];
                
                tasks.forEach(t => { 
                  if (t.userId === user.id && ds >= t.startDate && ds <= t.endDate) {
                    // Netto-Stunden f√ºr diesen Tag berechnen
                    const dayGross = t.endHour - t.startHour;
                    let dayNet = dayGross;
                    
                    // Nur Werktage
                    if (dayNum !== 0 && dayNum !== 6 && sched) {
                      // Pause 1 √úberschneidung
                      const break1Start = sched.break1Start || 0;
                      const break1Duration = sched.break1Duration || 0;
                      const break1End = break1Start + break1Duration;
                      
                      if (break1Duration > 0) {
                        const overlap1Start = Math.max(t.startHour, break1Start);
                        const overlap1End = Math.min(t.endHour, break1End);
                        if (overlap1Start < overlap1End) {
                          dayNet -= (overlap1End - overlap1Start);
                        }
                      }
                      
                      // Pause 2 √úberschneidung (nur wenn nicht Teilzeit)
                      const workEnd = sched.end || 17;
                      const hasBreak2 = workEnd > 13;
                      
                      if (hasBreak2) {
                        const break2Start = sched.break2Start || 0;
                        const break2Duration = sched.break2Duration || 0;
                        const break2End = break2Start + break2Duration;
                        
                        if (break2Duration > 0) {
                          const overlap2Start = Math.max(t.startHour, break2Start);
                          const overlap2End = Math.min(t.endHour, break2End);
                          if (overlap2Start < overlap2End) {
                            dayNet -= (overlap2End - overlap2Start);
                          }
                        }
                      }
                    }
                    
                    tot += dayNet;
                  }
                });
                const isWe = d.getDay() === 0 || d.getDay() === 6;
                const isVac = isVacation(user.id, d);
                const isNonWork = isNonWorkingDay(user, d);
                const dayCapacity = getDailyHours(user, d);
                return (
                  <div key={i} className="text-center px-1">
                    <div className={`py-1 rounded font-bold ${
                      isVac ? 'bg-orange-400 text-white' : 
                      isNonWork ? 'bg-gray-300 text-gray-500' :
                      isWe ? 'bg-gray-300' : 
                      tot > dayCapacity ? 'bg-red-400 text-white' : 
                      tot > 0 ? 'bg-green-400 text-white' : 
                      'bg-gray-200'
                    }`}>
                      {isVac ? 'üèñÔ∏è' : isNonWork ? 'frei' : tot > 0 ? `${tot.toFixed(2)}h` : ''}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
          <div className="mt-3">
            <button onClick={() => { 
              // Scroll-Position speichern
              if (ganttScrollRef.current) {
                setSavedScrollPosition(ganttScrollRef.current.scrollLeft);
              }
              const key = `${user.id}-${weekNum}`; 
              setExpandedNotes(prev => ({...prev, [key]: prev[key] === false ? true : false})); 
            }} 
              className="flex items-center gap-2 text-sm text-indigo-600 hover:text-indigo-800">
              <StickyNote className="w-4 h-4" />
              Notizen KW {weekNum}
            </button>
            {isNoteExpanded && (
              <textarea value={localNoteText} onChange={(e) => setLocalNoteText(e.target.value)}
                onBlur={() => updateWeekNote(user.id, weekNum, localNoteText)}
                className="w-full mt-2 p-2 border rounded" rows="3" placeholder="Notizen f√ºr diese Woche..." />
            )}
          </div>
        </div>
      </div>
    );
  };

  // üîê PASSWORT-SCREEN - wird als erstes gezeigt
  if (!isAuthenticated) {
    const handlePasswordSubmit = (e) => {
      e.preventDefault();
      if (passwordInput === APP_PASSWORD) {
        setIsAuthenticated(true);
        setPasswordError(false);
      } else {
        setPasswordError(true);
        setPasswordInput('');
      }
    };
    
    return (
      <div className="min-h-screen bg-gradient-to-br from-purple-100 to-pink-100 flex items-center justify-center">
        <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
          <div className="text-center mb-6">
            <div className="w-20 h-20 mx-auto mb-4 bg-indigo-600 rounded-full flex items-center justify-center">
              <svg className="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
              </svg>
            </div>
            <h1 className="text-3xl font-bold text-gray-800 mb-2">Team Kapazit√§tsplaner V5</h1>
            <p className="text-gray-600">Bitte Passwort eingeben</p>
          </div>
          
          <form onSubmit={handlePasswordSubmit} className="space-y-4">
            <div>
              <input
                type="password"
                value={passwordInput}
                onChange={(e) => {setPasswordInput(e.target.value); setPasswordError(false);}}
                placeholder="Passwort"
                className={`w-full p-4 border-2 rounded-2xl text-lg focus:outline-none focus:border-indigo-600 transition-colors ${
                  passwordError ? 'border-red-500 bg-red-50' : 'border-gray-300'
                }`}
                autoFocus
              />
              {passwordError && (
                <p className="text-red-600 text-sm mt-2 flex items-center gap-2">
                  <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                  </svg>
                  Falsches Passwort. Bitte erneut versuchen.
                </p>
              )}
            </div>
            
            <button
              type="submit"
              className="w-full p-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-2xl font-bold text-lg hover:shadow-xl transition-shadow"
            >
              Anmelden
            </button>
          </form>
          
          <div className="mt-6 pt-6 border-t text-center">
            <p className="text-sm text-gray-500">
              Standard-Passwort: <code className="bg-gray-100 px-2 py-1 rounded">Team2025</code>
            </p>
            <p className="text-xs text-gray-400 mt-2">
              Hinweis: Passwort kann in der Datei ge√§ndert werden
            </p>
          </div>
        </div>
      </div>
    );
  }

  if (showLogin) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-indigo-100 to-purple-100 flex items-center justify-center">
        <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
          <Calendar className="w-16 h-16 mx-auto text-indigo-600 mb-4" />
          <h1 className="text-3xl font-bold text-center mb-6">Kapazit√§tsplaner V5</h1>
          <div className="space-y-3">
            {users.map(u => (
              <button key={u.id} onClick={() => { setCurrentUser(u); setShowLogin(false); setShowDashboard(u.teamRole === 'lead' || u.teamRole === 'department_head' || u.teamRole === 'entrepreneur'); }} 
                className="w-full p-4 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-2xl hover:shadow-xl transition-shadow">
                {u.name} {u.teamRole === 'lead' && '(F√ºhrungskraft)'} {u.teamRole === 'department_head' && '(Bereichsleitung)'} {u.teamRole === 'entrepreneur' && '(Unternehmer)'}
              </button>
            ))}
          </div>
        </div>
      </div>
    );
  }

  if (showDashboard && (currentUser.teamRole === 'lead' || currentUser.teamRole === 'department_head' || currentUser.teamRole === 'entrepreneur' || currentUser.role === 'admin')) {
    return <TeamDashboard />;
  }

  // Projekt-Dashboard - F√úR ALLE zug√§nglich
  if (showProjectDashboard) {
    const ProjectDashboard = () => {
      // Helper-Funktionen
      const openSettings = () => {
        setShowSettings(true);
      };
      
      // Filter speichern - SOFORT State updaten, im Hintergrund speichern
      const updateFilter = (filterName, value) => {
        const newFilters = {...projectDashboardFilters, [filterName]: value};
        setProjectDashboardFilters(newFilters);
        // Im Hintergrund speichern ohne zu warten
        const key = `project-filters-${currentUser.id}`;
        window.storage.set(key, JSON.stringify(newFilters)).catch(() => {});
      };
      
      // Berechne Stunden pro Projekt, gruppiert nach Department
      const calculateProjectHoursByDivision = (projectId, filters, project) => {
        const divisionHours = {};
        let totalHours = 0;
        
        // IST-Stunden berechnen
        tasks.forEach(t => {
          if (t.projectId === projectId) {
            const user = users.find(u => u.id === t.userId);
            if (!user) return;
            
            const team = teams.find(tm => tm.id === user?.teamId);
            const division = team ? divisions.find(d => d.id === team.divisionId) : null;
            const dept = division ? departments.find(d => d.id === division.departmentId) : null;
            
            // Filter anwenden
            if (filters.department !== 'all' && dept?.id !== filters.department) return;
            if (filters.division && filters.division !== 'all' && division?.id !== filters.division) return;
            if (filters.team !== 'all' && team?.id !== filters.team) return;
            if (filters.user !== 'all' && user?.id !== filters.user) return;
            
            const divName = division?.name || 'Ohne Abteilung';
            const divId = division?.id || 'none';
            const deptName = dept?.name || '';
            
            const netHours = calculateNetHours(t.startHour, t.endHour, t.startDate, t.endDate, t.userId);
            
            if (!divisionHours[divId]) {
              divisionHours[divId] = { 
                name: divName,
                departmentName: deptName,
                actualHours: 0,
                plannedHours: 0
              };
            }
            divisionHours[divId].actualHours += netHours.net;
            totalHours += netHours.net;
          }
        });
        
        // SOLL-Stunden aus projectPhases holen (Phasen basieren auf divisions!)
        projectPhases.forEach(phase => {
          if (phase.projectId === projectId && phase.hoursNeeded > 0) {
            const divId = phase.divisionId;
            const division = divisions.find(d => d.id === divId);
            const dept = division ? departments.find(d => d.id === division.departmentId) : null;
            
            if (!divisionHours[divId]) {
              divisionHours[divId] = {
                name: phase.divisionName || division?.name || 'Unbekannt',
                departmentName: dept?.name || '',
                actualHours: 0,
                plannedHours: 0
              };
            }
            divisionHours[divId].plannedHours += phase.hoursNeeded;
          }
        });
        
        return { divisionHours, totalHours };
      };
      
      // Filtern nach Projekt-Name UND Bereich
      const filteredProjects = projects.filter(p => {
        // Projekt-Name Filter
        if (!p.name.toLowerCase().includes(projectDashboardFilters.projectSearch.toLowerCase())) {
          return false;
        }
        
        // Bereich Filter: Nur Projekte zeigen die f√ºr den gew√§hlten Bereich Stunden haben
        if (projectDashboardFilters.department !== 'all') {
          const deptHours = (p.departmentHours || {})[projectDashboardFilters.department] || 0;
          // Pr√ºfe auch ob IST-Stunden f√ºr diesen Bereich existieren
          let hasActualHours = false;
          tasks.forEach(t => {
            if (t.projectId === p.id) {
              const user = users.find(u => u.id === t.userId);
              const team = teams.find(tm => tm.id === user?.teamId);
              const division = team ? divisions.find(d => d.id === team.divisionId) : null;
              const dept = division ? departments.find(d => d.id === division.departmentId) : null;
              if (dept?.id === projectDashboardFilters.department) {
                hasActualHours = true;
              }
            }
          });
          
          if (deptHours === 0 && !hasActualHours) {
            return false;
          }
        }
        
        // Abteilung Filter (NEU)
        if (projectDashboardFilters.division && projectDashboardFilters.division !== 'all') {
          let hasHoursInDivision = false;
          tasks.forEach(t => {
            if (t.projectId === p.id) {
              const user = users.find(u => u.id === t.userId);
              const team = teams.find(tm => tm.id === user?.teamId);
              if (team?.divisionId === projectDashboardFilters.division) {
                hasHoursInDivision = true;
              }
            }
          });
          if (!hasHoursInDivision) return false;
        }
        
        // Team Filter
        if (projectDashboardFilters.team !== 'all') {
          let hasHoursInTeam = false;
          tasks.forEach(t => {
            if (t.projectId === p.id) {
              const user = users.find(u => u.id === t.userId);
              if (user?.teamId === projectDashboardFilters.team) {
                hasHoursInTeam = true;
              }
            }
          });
          if (!hasHoursInTeam) return false;
        }
        
        return true;
      });
      
      return (
        <>
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50">
          <div className="bg-white shadow-lg sticky top-0 z-10">
            <div className="max-w-full mx-auto px-6 py-4">
              {/* Header mit Navigation */}
              <div className="flex justify-between items-center mb-4">
                <div className="flex items-center gap-3">
                  <span className="text-3xl">üìä</span>
                  <h1 className="text-xl font-bold">Projekt-Dashboard - Stunden√ºbersicht nach Bereichen</h1>
                </div>
                
                {/* Navigation Buttons */}
                <div className="flex gap-2">
                  {/* Undo/Redo/History Buttons */}
                  <button 
                    onClick={undo} 
                    disabled={undoStack.length === 0}
                    className={`p-3 rounded-2xl ${undoStack.length > 0 ? 'hover:bg-gray-100' : 'opacity-30 cursor-not-allowed'}`}
                    title={`R√ºckg√§ngig (${undoStack.length} verf√ºgbar)`}>
                    ‚Ü∂
                  </button>
                  <button 
                    onClick={redo} 
                    disabled={redoStack.length === 0}
                    className={`p-3 rounded-2xl ${redoStack.length > 0 ? 'hover:bg-gray-100' : 'opacity-30 cursor-not-allowed'}`}
                    title={`Wiederholen (${redoStack.length} verf√ºgbar)`}>
                    ‚Ü∑
                  </button>
                  <button 
                    onClick={() => setShowHistory(!showHistory)} 
                    className={`p-3 rounded-2xl ${showHistory ? 'bg-blue-100' : 'hover:bg-gray-100'}`}
                    title="√Ñnderungshistorie">
                    üìú
                  </button>
                  
                  {/* Navigation */}
                  <button 
                    onClick={() => { setShowDashboard(false); setShowProjectDashboard(false); setShowProjectPlanning(false); }} 
                    className="px-4 py-2 rounded-2xl bg-gray-100 hover:bg-gray-200"
                  >
                    <Calendar className="w-4 h-4 inline mr-2" />Planung
                  </button>
                  <button 
                    onClick={() => { setShowDashboard(true); setShowProjectDashboard(false); setShowProjectPlanning(false); }} 
                    className="px-4 py-2 rounded-2xl bg-gray-100 hover:bg-gray-200"
                  >
                    <BarChart3 className="w-4 h-4 inline mr-2" />Team Dashboard
                  </button>
                  <button 
                    className="px-4 py-2 rounded-2xl bg-blue-600 text-white"
                  >
                    <BarChart3 className="w-4 h-4 inline mr-2" />Projekt Dashboard
                  </button>
                  <button 
                    onClick={() => { setShowDashboard(false); setShowProjectDashboard(false); setShowProjectPlanning(true); }} 
                    className="px-4 py-2 rounded-2xl bg-gray-100 hover:bg-gray-200"
                  >
                    üèóÔ∏è Projektplanung
                  </button>
                  {currentUser.role === 'admin' && (
                    <button onClick={() => setShowAdmin(true)} className="px-4 py-2 bg-purple-600 text-white rounded-2xl">
                      Admin
                    </button>
                  )}
                  <button onClick={openSettings} className="p-3 hover:bg-gray-100 rounded-2xl">
                    <Settings className="w-5 h-5" />
                  </button>
                  <button 
                    onClick={() => { setCurrentUser(null); setSelectedUser(null); setShowLogin(true); setShowProjectDashboard(false); }} 
                    className="px-4 py-2 bg-gray-100 rounded-2xl"
                  >
                    <LogOut className="w-4 h-4 inline mr-2" />Abmelden
                  </button>
                </div>
              </div>
              
              {/* Filter */}
              <div className="grid grid-cols-1 md:grid-cols-5 gap-3 pb-4 border-b">
                {/* Bereich Filter */}
                <div>
                  <label className="text-xs font-semibold text-gray-600 mb-1 block">Bereich</label>
                  <select 
                    value={projectDashboardFilters.department}
                    onChange={(e) => updateFilter('department', e.target.value)}
                    className="w-full p-2 border rounded-lg text-sm"
                  >
                    <option value="all">Alle Bereiche</option>
                    {departments.sort((a, b) => a.name.localeCompare(b.name)).map(d => (
                      <option key={d.id} value={d.id}>{d.name}</option>
                    ))}
                  </select>
                </div>
                
                {/* Abteilung Filter (NEU) */}
                <div>
                  <label className="text-xs font-semibold text-gray-600 mb-1 block">Abteilung</label>
                  <select 
                    value={projectDashboardFilters.division || 'all'}
                    onChange={(e) => updateFilter('division', e.target.value)}
                    className="w-full p-2 border rounded-lg text-sm"
                  >
                    <option value="all">Alle Abteilungen</option>
                    {divisions.sort((a, b) => a.name.localeCompare(b.name)).map(div => {
                      const dept = departments.find(d => d.id === div.departmentId);
                      return (
                        <option key={div.id} value={div.id}>
                          {div.name}{dept ? ` (${dept.name})` : ''}
                        </option>
                      );
                    })}
                  </select>
                </div>
                
                {/* Team Filter */}
                <div>
                  <label className="text-xs font-semibold text-gray-600 mb-1 block">Team</label>
                  <select 
                    value={projectDashboardFilters.team}
                    onChange={(e) => updateFilter('team', e.target.value)}
                    className="w-full p-2 border rounded-lg text-sm"
                  >
                    <option value="all">Alle Teams</option>
                    {teams.sort((a, b) => a.name.localeCompare(b.name)).map(t => {
                      const div = divisions.find(d => d.id === t.divisionId);
                      const dept = div ? departments.find(d => d.id === div.departmentId) : null;
                      return (
                        <option key={t.id} value={t.id}>
                          {t.name}{div ? ` (${div.name})` : ''}{dept ? ` ‚Ä¢ ${dept.name}` : ''}
                        </option>
                      );
                    })}
                  </select>
                </div>
                
                {/* Mitglied Filter */}
                <div>
                  <label className="text-xs font-semibold text-gray-600 mb-1 block">Mitglied</label>
                  <select 
                    value={projectDashboardFilters.user}
                    onChange={(e) => updateFilter('user', e.target.value)}
                    className="w-full p-2 border rounded-lg text-sm"
                  >
                    <option value="all">Alle Mitglieder</option>
                    {users.filter(u => u.role !== 'admin').sort((a, b) => a.name.localeCompare(b.name)).map(u => (
                      <option key={u.id} value={u.id}>{u.name}</option>
                    ))}
                  </select>
                </div>
                
                {/* Projekt Suche */}
                <div>
                  <label className="text-xs font-semibold text-gray-600 mb-1 block">Projekt suchen</label>
                  <input 
                    type="text"
                    value={projectDashboardFilters.projectSearch}
                    onChange={(e) => updateFilter('projectSearch', e.target.value)}
                    placeholder="Projekt eingeben..."
                    className="w-full p-2 border rounded-lg text-sm"
                  />
                </div>
              </div>
              
              {/* Filter Reset */}
              {(projectDashboardFilters.department !== 'all' || 
                projectDashboardFilters.division !== 'all' ||
                projectDashboardFilters.team !== 'all' || 
                projectDashboardFilters.user !== 'all' || 
                projectDashboardFilters.projectSearch !== '') && (
                <div className="pt-2">
                  <button 
                    onClick={() => {
                      const resetFilters = {department: 'all', division: 'all', team: 'all', user: 'all', projectSearch: ''};
                      setProjectDashboardFilters(resetFilters);
                      window.storage.set(`project-filters-${currentUser.id}`, JSON.stringify(resetFilters));
                    }}
                    className="text-sm text-indigo-600 hover:text-indigo-800"
                  >
                    ‚úï Filter zur√ºcksetzen
                  </button>
                </div>
              )}
            </div>
          </div>

          <div className="w-full px-4 py-6">
            <div className="grid grid-cols-1 lg:grid-cols-2 2xl:grid-cols-3 gap-6">
              {filteredProjects.sort((a, b) => a.name.localeCompare(b.name)).map(project => {
                const { divisionHours, totalHours } = calculateProjectHoursByDivision(project.id, projectDashboardFilters, project);
                
                // Nur Abteilungen mit SOLL>0 ODER IST>0 anzeigen
                const divArray = Object.entries(divisionHours)
                  .filter(([id, data]) => data.actualHours > 0 || data.plannedHours > 0)
                  .map(([id, data]) => ({
                    id,
                    name: data.name,
                    departmentName: data.departmentName,
                    actualHours: data.actualHours,
                    plannedHours: data.plannedHours,
                    utilization: data.plannedHours > 0 ? (data.actualHours / data.plannedHours) * 100 : 0,
                    percentage: totalHours > 0 ? (data.actualHours / totalHours) * 100 : 0
                  }))
                  .sort((a, b) => a.name.localeCompare(b.name)); // Alphabetisch!
                
                // Projekt ohne Abteilungen mit Stunden ausblenden
                if (divArray.length === 0) return null;
                
                // Gesamt-SOLL berechnen
                const totalPlannedHours = divArray.reduce((sum, d) => sum + d.plannedHours, 0);
                const totalUtilization = totalPlannedHours > 0 ? (totalHours / totalPlannedHours) * 100 : 0;
                
                return (
                  <div key={project.id} className="bg-white rounded-2xl shadow-lg overflow-hidden border-2 border-gray-100">
                    {/* Projekt Header */}
                    <div className="p-4 border-b" style={{backgroundColor: project.color + '20'}}>
                      <div className="flex items-center gap-3 mb-3">
                        <div 
                          className="w-6 h-6 rounded-full" 
                          style={{backgroundColor: project.color}}
                        />
                        <h3 className="text-lg font-bold text-gray-800 flex-1">{project.name}</h3>
                      </div>
                      
                      {/* Gesamt IST & SOLL */}
                      <div className="grid grid-cols-2 gap-3">
                        <div className="bg-white/50 rounded-lg p-2">
                          <div className="text-xs text-gray-600 mb-1">IST-Stunden</div>
                          <div className="text-2xl font-bold text-gray-700">{totalHours.toFixed(1)}h</div>
                        </div>
                        <div className="bg-white/50 rounded-lg p-2">
                          <div className="text-xs text-gray-600 mb-1">SOLL-Stunden</div>
                          <div className="text-2xl font-bold text-indigo-600">
                            {totalPlannedHours > 0 ? `${totalPlannedHours.toFixed(0)}h` : '-'}
                          </div>
                        </div>
                      </div>
                      
                      {/* Gesamt-Fortschritt (nur wenn SOLL > 0) */}
                      {totalPlannedHours > 0 && (
                        <div className="mt-3">
                          <div className="flex justify-between items-center mb-1">
                            <span className="text-xs text-gray-600">Gesamt-Fortschritt</span>
                            <span className={`text-sm font-bold ${
                              totalUtilization > 100 ? 'text-red-600' :
                              totalUtilization > 90 ? 'text-orange-600' :
                              totalUtilization > 70 ? 'text-yellow-600' :
                              'text-green-600'
                            }`}>
                              {Math.round(totalUtilization)}%
                            </span>
                          </div>
                          <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                            <div 
                              className={`h-full transition-all ${
                                totalUtilization > 100 ? 'bg-red-500' :
                                totalUtilization > 90 ? 'bg-orange-500' :
                                totalUtilization > 70 ? 'bg-yellow-500' :
                                'bg-green-500'
                              }`}
                              style={{width: `${Math.min(totalUtilization, 100)}%`}}
                            />
                          </div>
                        </div>
                      )}
                      
                      {/* √úberplanung Warnung */}
                      {totalPlannedHours > 0 && totalUtilization > 100 && (
                        <div className="mt-2 text-xs text-red-600 bg-red-50 rounded p-2">
                          ‚ö†Ô∏è √úberplant um {(totalHours - totalPlannedHours).toFixed(1)}h ({Math.round(totalUtilization - 100)}%)
                        </div>
                      )}
                    </div>
                    
                    {/* Abteilungen-Aufschl√ºsselung */}
                    <div className="p-4 space-y-3">
                      <div className="text-xs font-semibold text-gray-600 mb-2">Stunden pro Abteilung:</div>
                      
                      {divArray.map((div, idx) => (
                        <div key={div.id} className="bg-gray-50 rounded-lg p-3 border border-gray-200">
                          <div className="flex justify-between items-start mb-2">
                            <div className="flex-1">
                              <span className="font-semibold text-gray-700">{div.name}</span>
                              {div.departmentName && (
                                <span className="text-xs text-gray-500 ml-2">({div.departmentName})</span>
                              )}
                            </div>
                            <div className="text-right">
                              <div className="flex items-center gap-2">
                                <span className="text-lg font-bold text-gray-700">{div.actualHours.toFixed(1)}h</span>
                                {div.plannedHours > 0 && (
                                  <>
                                    <span className="text-gray-400">/</span>
                                    <span className="text-sm text-indigo-600">{div.plannedHours.toFixed(0)}h</span>
                                  </>
                                )}
                              </div>
                              {div.plannedHours > 0 && (
                                <div className={`text-xs font-semibold ${
                                  div.utilization > 100 ? 'text-red-600' :
                                  div.utilization > 90 ? 'text-orange-600' :
                                  div.utilization > 70 ? 'text-yellow-600' :
                                  'text-green-600'
                                }`}>
                                  {Math.round(div.utilization)}% Fortschritt
                                </div>
                              )}
                            </div>
                          </div>
                          
                          {/* F√ºllstandsbalken (IST vs SOLL wenn vorhanden, sonst Anteil am Gesamt) */}
                          {div.plannedHours > 0 ? (
                            <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                              <div 
                                className={`h-full transition-all ${
                                  div.utilization > 100 ? 'bg-red-500' :
                                  div.utilization > 90 ? 'bg-orange-500' :
                                  div.utilization > 70 ? 'bg-yellow-500' :
                                  'bg-green-500'
                                }`}
                                style={{width: `${Math.min(div.utilization, 100)}%`}}
                              />
                            </div>
                          ) : (
                            <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                              <div 
                                className={`h-full transition-all ${
                                  idx === 0 ? 'bg-indigo-500' :
                                  idx === 1 ? 'bg-blue-500' :
                                  idx === 2 ? 'bg-cyan-500' :
                                  'bg-teal-500'
                                }`}
                                style={{width: `${div.percentage}%`}}
                                title={`${Math.round(div.percentage)}% Anteil am Gesamt`}
                              />
                            </div>
                          )}
                          
                          {/* Warnung bei √úberplanung */}
                          {div.plannedHours > 0 && div.utilization > 100 && (
                            <div className="text-xs text-red-600 mt-1">
                              ‚ö†Ô∏è +{(div.actualHours - div.plannedHours).toFixed(1)}h √ºber Soll
                            </div>
                          )}
                        </div>
                      ))}
                      
                      {/* Verteilungs-Visualisierung (nur wenn >1 Abteilung) */}
                      {divArray.length > 1 && (
                        <div className="mt-4 pt-4 border-t">
                          <div className="text-xs font-semibold text-gray-500 mb-2 text-center">IST-Verteilung</div>
                          <div className="flex h-4 rounded-full overflow-hidden">
                            {divArray.map((div, idx) => (
                              <div 
                                key={div.id}
                                className={`${
                                  idx === 0 ? 'bg-indigo-500' :
                                  idx === 1 ? 'bg-blue-500' :
                                  idx === 2 ? 'bg-cyan-500' :
                                  'bg-teal-500'
                                }`}
                                style={{width: `${div.percentage}%`}}
                                title={`${div.name}: ${div.actualHours.toFixed(1)}h (${Math.round(div.percentage)}%)`}
                              />
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
            
            {/* Keine Projekte gefunden */}
            {filteredProjects.every(p => {
              const { divisionHours } = calculateProjectHoursByDivision(p.id, projectDashboardFilters, p);
              const hasAnyHours = Object.values(divisionHours).some(d => d.actualHours > 0 || d.plannedHours > 0);
              return !hasAnyHours;
            }) && (
              <div className="text-center py-12">
                <div className="text-6xl mb-4">üìä</div>
                <h2 className="text-2xl font-bold text-gray-600 mb-2">
                  {projectDashboardFilters.department !== 'all' || 
                   projectDashboardFilters.division !== 'all' ||
                   projectDashboardFilters.team !== 'all' || 
                   projectDashboardFilters.user !== 'all' || 
                   projectDashboardFilters.projectSearch !== '' 
                    ? 'Keine Projekte gefunden'
                    : 'Noch keine Projekt-Stunden'
                  }
                </h2>
                <p className="text-gray-500">
                  {projectDashboardFilters.department !== 'all' || 
                   projectDashboardFilters.division !== 'all' ||
                   projectDashboardFilters.team !== 'all' || 
                   projectDashboardFilters.user !== 'all' || 
                   projectDashboardFilters.projectSearch !== '' 
                    ? 'Versuche andere Filter-Einstellungen'
                    : 'Erstelle Tasks mit Projektzuordnung oder definiere Soll-Stunden in den Einstellungen'
                  }
                </p>
              </div>
            )}
          </div>
        </div>
        
        {/* Settings Modal */}
        {showSettings && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-3xl p-6 max-w-md w-full">
              <div className="flex justify-between mb-6">
                <h2 className="text-2xl font-bold">Einstellungen</h2>
                <button onClick={() => setShowSettings(false)} className="text-2xl">‚úï</button>
              </div>
              <p className="text-gray-600">
                Die vollst√§ndigen Einstellungen sind in der Planung-Ansicht verf√ºgbar.<br/><br/>
                Bitte gehe zur Planung, um alle Einstellungen zu bearbeiten.
              </p>
              <button 
                onClick={() => { setShowSettings(false); setShowDashboard(false); setShowProjectDashboard(false); }}
                className="mt-4 w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
              >
                Zur Planung wechseln
              </button>
            </div>
          </div>
        )}
        </>
      );
    };
    
    return <ProjectDashboard />;
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // PROJEKTPLANUNG DASHBOARD - Das neue Feature! üî•
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // PROJEKTPLANUNG DASHBOARD - Hierarchische Arbeitspakete V11
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  // Globaler Scroll-Speicher - AUSSERHALB von React!
  const _scrollPositions = window._sidebarScrollPositions || (window._sidebarScrollPositions = {});
  
  if (showProjectPlanning) {
    const ProjectPlanningDashboard = () => {
      const [expandedPackages, setExpandedPackages] = React.useState({});
      const [contextMenu, setContextMenu] = React.useState(null);
      const [draggedWP, setDraggedWP] = React.useState(null);
      const [resizingWP, setResizingWP] = React.useState(null);
      const [editingName, setEditingName] = React.useState(null);
      const [selectedWP, setSelectedWP] = React.useState(null);
      const [selectedWPs, setSelectedWPs] = React.useState([]); // Multi-Select: Array von WP-IDs
      const [lastClickedWP, setLastClickedWP] = React.useState(null); // F√ºr Shift-Auswahl
      const [hoveredWP, setHoveredWP] = React.useState(null);
      const [hoveredDep, setHoveredDep] = React.useState(null);
      const [dependencies, setDependencies] = React.useState([]);
      const [linkingFrom, setLinkingFrom] = React.useState(null);
      const [linkMousePos, setLinkMousePos] = React.useState(null);
      // sidebarWPId und filterAssigned kommen aus dem Parent-Scope
      const [showAssignments, setShowAssignments] = React.useState(true);
      const [showHours, setShowHours] = React.useState(true); // Stunden neben Balken anzeigen
      const [previewPositions, setPreviewPositions] = React.useState({}); // Live-Preview f√ºr abh√§ngige Balken
      const [originalPositions, setOriginalPositions] = React.useState({}); // Original-Positionen f√ºr Schatten
      const [baselineMenuOpen, setBaselineMenuOpen] = React.useState(false); // Baseline-Dropdown
      const [viewMenuOpen, setViewMenuOpen] = React.useState(false); // Ansicht-Men√º
      const [rowDragWP, setRowDragWP] = React.useState(null); // WP das vertikal gezogen wird
      const [dropTarget, setDropTarget] = React.useState(null); // {wpId, position: 'before'|'after'|'child'}
      const [columnMenuOpen, setColumnMenuOpen] = React.useState(false); // Spalten-Men√º
      // Nutze Parent-States f√ºr persistente Breiten
      const leftPanelWidth = ganttLeftPanelWidth;
      const setLeftPanelWidth = setGanttLeftPanelWidth;
      const columnWidths = ganttColumnWidths;
      const setColumnWidths = setGanttColumnWidths;
      const [isResizingPanel, setIsResizingPanel] = React.useState(false);
      const [resizingColumn, setResizingColumn] = React.useState(null); // {key, startX, startWidth}
      // Nutze Parent-States f√ºr Sidebar (damit sie beim Zoom erhalten bleiben)
      const selectedProjectId = ganttSelectedProjectId;
      const setSelectedProjectId = setGanttSelectedProjectId;
      const selectedFolderId = ganttSelectedFolderId;
      const setSelectedFolderId = setGanttSelectedFolderId;
      const projectSidebarCollapsed = ganttProjectSidebarCollapsed;
      const setProjectSidebarCollapsed = setGanttProjectSidebarCollapsed;
      const [collapsedFolders, setCollapsedFolders] = React.useState({}); // Zugeklappte Ordner
      const [draggingProject, setDraggingProject] = React.useState(null); // Projekt das gezogen wird
      const [draggingFolder, setDraggingFolder] = React.useState(null); // Ordner der gezogen wird
      const [dragOverFolder, setDragOverFolder] = React.useState(null); // Ordner √ºber dem gehovered wird
      const [dragOverProject, setDragOverProject] = React.useState(null); // Projekt √ºber dem gehovered wird (f√ºr Sortierung)
      const [editingFolderId, setEditingFolderId] = React.useState(null); // Ordner der bearbeitet wird
      const [dayContextMenu, setDayContextMenu] = React.useState(null); // { x, y, date } f√ºr Rechtsklick auf Tag
      const [editingHoliday, setEditingHoliday] = React.useState(null); // { date, type, name } f√ºr Bearbeitung
      const [detailsCollapsed, setDetailsCollapsed] = React.useState(false); // Details-Panel eingeklappt
      const originalPositionsRef = React.useRef({}); // Ref f√ºr Loop-freien Zugriff
      const ganttScrollRef = React.useRef(null); // Ref f√ºr Gantt-Scroll-Container
      const headerScrollRef = React.useRef(null); // Ref f√ºr Header-Scroll (synchronisiert mit ganttHScrollRef)
      
      // Globaler Scroll-Speicher (au√üerhalb React)
      if (!window._ganttScrollTop) window._ganttScrollTop = { value: 0, isDragging: false };
      if (!window._ganttScrollLeft) window._ganttScrollLeft = { value: 0 };
      const ganttHScrollRef = React.useRef(null); // Ref f√ºr horizontalen Scroll
      
      // Nutze Parent-States f√ºr Zoom und Spalten
      const zoomLevel = ganttZoomLevel;
      const setZoomLevel = setGanttZoomLevel;
      
      // sidebarWP wird immer frisch aus workPackages geholt
      const sidebarWP = sidebarWPId ? workPackages.find(w => w.id === sidebarWPId) : null;
      
      // Sortierte Listen
      const sortedUsers = React.useMemo(() => [...users].sort((a, b) => a.name.localeCompare(b.name, 'de')), [users]);
      const sortedDivisions = React.useMemo(() => [...divisions].sort((a, b) => a.name.localeCompare(b.name, 'de')), [divisions]);
      
      // Zoom-abh√§ngige Breite
      const DAY_WIDTH = Math.round(35 * zoomLevel / 100);
      const ROW_HEIGHT = 32;
      const WEEKS_TO_SHOW = Math.ceil(20 * 100 / zoomLevel);
      const currentWeekNum = getWeekNumber(new Date());
      const weekNumbers = Array.from({length: WEEKS_TO_SHOW}, (_, i) => currentWeekNum + i);
      
      const wpColors = ['#6366f1', '#8b5cf6', '#ec4899', '#f43f5e', '#f97316', '#eab308', '#22c55e', '#14b8a6', '#0ea5e9', '#64748b'];
      
      const monthNames = ['Jan', 'Feb', 'M√§r', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
      
      React.useEffect(() => {
        const loadDeps = async () => {
          const saved = await window.storage.get('wpDependencies').catch(() => null);
          if (saved) setDependencies(JSON.parse(saved.value));
        };
        loadDeps();
      }, []);
      
      const saveDependencies = (deps) => {
        setDependencies(deps);
        window.storage.set('wpDependencies', JSON.stringify(deps));
      };
      
      // Hilfsfunktionen f√ºr Wochenend-Berechnung
      const isWeekendDay = (date) => {
        const d = new Date(date);
        return d.getDay() === 0 || d.getDay() === 6; // 0 = Sonntag, 6 = Samstag
      };
      
      const addWorkingDays = (startDate, days, allowWeekend) => {
        const result = new Date(startDate);
        let remaining = days;
        
        if (allowWeekend) {
          result.setDate(result.getDate() + days);
          return result;
        }
        
        while (remaining > 0) {
          result.setDate(result.getDate() + 1);
          if (!isWeekendDay(result)) {
            remaining--;
          }
        }
        return result;
      };
      
      const countWorkingDays = (startDate, endDate, allowWeekend) => {
        if (allowWeekend) {
          return Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24));
        }
        
        let count = 0;
        const current = new Date(startDate);
        const end = new Date(endDate);
        
        while (current <= end) {
          if (!isWeekendDay(current)) {
            count++;
          }
          current.setDate(current.getDate() + 1);
        }
        return count;
      };
      
      const skipWeekend = (date, forward = true) => {
        const d = new Date(date);
        while (isWeekendDay(d)) {
          d.setDate(d.getDate() + (forward ? 1 : -1));
        }
        return d;
      };
      
      // Baseline-Funktionen
      const createBaseline = (name) => {
        if (!selectedProjectId) {
          alert('Bitte w√§hlen Sie zuerst ein einzelnes Projekt aus, um eine Baseline zu erstellen.');
          return null;
        }
        const projectWPs = workPackages.filter(wp => wp.projectId === selectedProjectId);
        const baseline = {
          id: `baseline_${Date.now()}`,
          projectId: selectedProjectId,
          name: name || `Baseline ${new Date().toLocaleDateString('de-DE')} ${new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })}`,
          createdAt: new Date().toISOString(),
          workPackages: projectWPs.map(wp => ({ id: wp.id, startDate: wp.startDate, endDate: wp.endDate }))
        };
        const newBaselines = [...baselines, baseline];
        setBaselines(newBaselines);
        window.storage.set('wpBaselines', JSON.stringify(newBaselines));
        return baseline;
      };
      
      const deleteBaseline = (baselineId) => {
        const newBaselines = baselines.filter(b => b.id !== baselineId);
        setBaselines(newBaselines);
        window.storage.set('wpBaselines', JSON.stringify(newBaselines));
        if (activeBaseline?.id === baselineId) setActiveBaseline(null);
      };
      
      const loadBaseline = (baselineId) => {
        const baseline = baselines.find(b => b.id === baselineId);
        if (baseline) {
          setActiveBaseline(activeBaseline?.id === baselineId ? null : baseline);
        }
      };
      
      const restoreBaseline = (baselineId) => {
        const baseline = baselines.find(b => b.id === baselineId);
        if (baseline) {
          const updated = workPackages.map(wp => {
            const savedWP = baseline.workPackages.find(bwp => bwp.id === wp.id);
            if (savedWP) {
              return { ...wp, startDate: savedWP.startDate, endDate: savedWP.endDate };
            }
            return wp;
          });
          saveWorkPackages(updated);
          setActiveBaseline(null);
        }
      };
      
      const getChildren = (wpId, allWPs) => allWPs.filter(wp => wp.parentId === wpId).sort((a, b) => (a.order || 0) - (b.order || 0));
      
      const getAllDescendants = (wpId, allWPs) => {
        const children = getChildren(wpId, allWPs);
        let descendants = [...children];
        children.forEach(child => { descendants = [...descendants, ...getAllDescendants(child.id, allWPs)]; });
        return descendants;
      };
      
      const calculateDatesFromChildren = (wpId, allWPs) => {
        const getAllLeafDates = (id) => {
          const children = getChildren(id, allWPs);
          if (children.length === 0) {
            const wp = allWPs.find(w => w.id === id);
            return wp ? [{ start: wp.startDate, end: wp.endDate }] : [];
          }
          return children.flatMap(child => getAllLeafDates(child.id));
        };
        const dates = getAllLeafDates(wpId);
        if (dates.length === 0) return null;
        const validDates = dates.filter(d => d.start && d.end);
        if (validDates.length === 0) return null;
        const starts = validDates.map(d => new Date(d.start));
        const ends = validDates.map(d => new Date(d.end));
        return { startDate: formatDate(new Date(Math.min(...starts))), endDate: formatDate(new Date(Math.max(...ends))) };
      };
      
      const calculateTotalHours = (wpId) => {
        const wp = workPackages.find(w => w.id === wpId);
        if (!wp) return 0;
        const children = getChildren(wpId, workPackages);
        if (children.length === 0) return wp.plannedHours || 0;
        return children.reduce((sum, child) => sum + calculateTotalHours(child.id), 0);
      };
      
      const calculateAssignedHours = (wp) => {
        if (!wp) return 0;
        const respHours = (wp.responsibles || []).reduce((sum, r) => sum + (typeof r === 'object' ? (r.hours || 0) : 0), 0);
        const editHours = (wp.editors || []).reduce((sum, e) => sum + (typeof e === 'object' ? (e.hours || 0) : 0), 0);
        return respHours + editHours;
      };
      
      const getAssignmentText = (wp) => {
        const assignments = [];
        (wp.responsibles || []).forEach(r => {
          const userId = typeof r === 'object' ? r.userId : r;
          const hours = typeof r === 'object' ? r.hours : 0;
          const user = users.find(u => u.id === userId);
          if (user) {
            const nameParts = user.name.split(' ');
            const shortName = nameParts.length > 1 ? `${nameParts[0][0]}.${nameParts[nameParts.length-1]}` : user.name;
            assignments.push(hours > 0 ? `${shortName} ${hours}h` : shortName);
          }
        });
        (wp.editors || []).forEach(e => {
          const userId = typeof e === 'object' ? e.userId : e;
          const hours = typeof e === 'object' ? e.hours : 0;
          const user = users.find(u => u.id === userId);
          if (user) {
            const nameParts = user.name.split(' ');
            const shortName = nameParts.length > 1 ? `${nameParts[0][0]}.${nameParts[nameParts.length-1]}` : user.name;
            if (!assignments.some(a => a.startsWith(shortName.split(' ')[0]))) {
              assignments.push(hours > 0 ? `${shortName} ${hours}h` : shortName);
            }
          }
        });
        return assignments.join(', ');
      };
      
      const isUserAssigned = (assignments, userId) => {
        if (!assignments) return false;
        return assignments.some(a => (typeof a === 'object' ? a.userId : a) === userId);
      };
      
      const getUserHours = (assignments, userId) => {
        if (!assignments) return 0;
        const found = assignments.find(a => (typeof a === 'object' ? a.userId : a) === userId);
        return found && typeof found === 'object' ? (found.hours || 0) : 0;
      };
      
      const toggleUserAssignment = React.useCallback((wpId, field, userId, isChecked, hours = 0) => {
        const wp = workPackages.find(w => w.id === wpId);
        if (!wp) return;
        let current = wp[field] || [];
        current = current.map(a => typeof a === 'object' ? a : { userId: a, hours: 0 });
        let updated;
        if (isChecked) {
          if (!current.some(a => a.userId === userId)) {
            updated = [...current, { userId, hours }];
          } else {
            updated = current;
          }
        } else {
          updated = current.filter(a => a.userId !== userId);
        }
        const newWPs = workPackages.map(w => w.id === wpId ? { ...w, [field]: updated } : w);
        saveWorkPackages(newWPs);
      }, [workPackages]);
      
      const updateUserHours = React.useCallback((wpId, field, userId, hours) => {
        const wp = workPackages.find(w => w.id === wpId);
        if (!wp) return;
        let current = wp[field] || [];
        current = current.map(a => typeof a === 'object' ? a : { userId: a, hours: 0 });
        const updated = current.map(a => a.userId === userId ? { ...a, hours } : a);
        const newWPs = workPackages.map(w => w.id === wpId ? { ...w, [field]: updated } : w);
        saveWorkPackages(newWPs);
      }, [workPackages]);
      
      const getFlatSortedList = (projectId) => {
        const projectWPs = workPackages.filter(wp => wp.projectId === projectId);
        const result = [];
        const addWithChildren = (parentId, level) => {
          const children = projectWPs.filter(wp => wp.parentId === parentId).sort((a, b) => (a.order || 0) - (b.order || 0));
          children.forEach(wp => {
            const hasChildren = projectWPs.some(w => w.parentId === wp.id);
            const isExpanded = expandedPackages[wp.id] !== false;
            result.push({ ...wp, _level: level, _hasChildren: hasChildren });
            if (hasChildren && isExpanded) addWithChildren(wp.id, level + 1);
          });
        };
        addWithChildren(null, 0);
        return result;
      };
      
      const dateToX = (dateStr) => {
        if (!dateStr) return 0;
        const date = new Date(dateStr);
        const startOfTimeline = getWeekDates(currentWeekNum, new Date().getFullYear())[0];
        return Math.floor((date - startOfTimeline) / (1000 * 60 * 60 * 24)) * DAY_WIDTH;
      };
      
      const xToDate = (x) => {
        const startOfTimeline = getWeekDates(currentWeekNum, new Date().getFullYear())[0];
        const days = Math.round(x / DAY_WIDTH);
        const date = new Date(startOfTimeline);
        date.setDate(date.getDate() + days);
        return formatDate(date);
      };
      
      const addWorkPackage = (projectId, parentId = null) => {
        const siblings = workPackages.filter(wp => wp.projectId === projectId && wp.parentId === parentId);
        const maxOrder = siblings.length > 0 ? Math.max(...siblings.map(s => s.order || 0)) : 0;
        const startDate = new Date();
        const newWP = {
          id: `wp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
          projectId, parentId, name: 'Neues Arbeitspaket',
          startDate: formatDate(startDate), endDate: formatDate(startDate),
          order: maxOrder + 1, color: null, responsibles: [], editors: [], divisionIds: [], plannedHours: 0
        };
        saveWorkPackages([...workPackages, newWP]);
        setEditingName(newWP.id);
      };
      
      const deleteWorkPackage = (wpId) => {
        const toDelete = [wpId, ...getAllDescendants(wpId, workPackages).map(d => d.id)];
        saveWorkPackages(workPackages.filter(wp => !toDelete.includes(wp.id)));
        saveDependencies(dependencies.filter(d => !toDelete.includes(d.fromId) && !toDelete.includes(d.toId)));
        if (selectedWP?.id === wpId) setSelectedWP(null);
        if (sidebarWPId === wpId) setSidebarWPId(null);
      };
      
      const addDependency = (fromId, toId, type = 'FS') => {
        if (fromId === toId) return;
        if (dependencies.some(d => d.fromId === fromId && d.toId === toId && d.type === type)) return;
        const fromWP = workPackages.find(w => w.id === fromId);
        const toWP = workPackages.find(w => w.id === toId);
        let lagDays = 0;
        if (fromWP && toWP) {
          if (type === 'SS' && fromWP.startDate && toWP.startDate) {
            // Start-to-Start: Lag basiert auf Startdaten
            lagDays = Math.round((new Date(toWP.startDate) - new Date(fromWP.startDate)) / (1000 * 60 * 60 * 24));
          } else if (type === 'FS' && fromWP.endDate && toWP.startDate) {
            // Finish-to-Start: Lag basiert auf Ende‚ÜíStart
            lagDays = Math.round((new Date(toWP.startDate) - new Date(fromWP.endDate)) / (1000 * 60 * 60 * 24));
          }
        }
        saveDependencies([...dependencies, { id: `dep_${Date.now()}`, fromId, toId, lagDays, type }]);
      };
      
      const deleteDependency = (depId) => saveDependencies(dependencies.filter(d => d.id !== depId));
      
      const updateWorkPackage = React.useCallback((wpId, field, value) => {
        // Scroll-Position speichern VOR dem Update
        if (ganttScrollRef.current) {
          window._ganttScrollTop.value = ganttScrollRef.current.scrollTop;
        }
        if (ganttHScrollRef.current) {
          window._ganttScrollLeft.value = ganttHScrollRef.current.scrollLeft;
        }
        
        const updated = workPackages.map(wp => wp.id === wpId ? { ...wp, [field]: value } : wp);
        saveWorkPackages(updated);
        if (selectedWP?.id === wpId) setSelectedWP(prev => prev ? { ...prev, [field]: value } : null);
        
        // Scroll-Position mehrfach wiederherstellen f√ºr Robustheit
        const restoreScroll = () => {
          if (ganttScrollRef.current) ganttScrollRef.current.scrollTop = window._ganttScrollTop.value;
          if (ganttHScrollRef.current) ganttHScrollRef.current.scrollLeft = window._ganttScrollLeft.value;
          if (headerScrollRef.current) headerScrollRef.current.scrollLeft = window._ganttScrollLeft.value;
        };
        requestAnimationFrame(restoreScroll);
        setTimeout(restoreScroll, 10);
        setTimeout(restoreScroll, 50);
      }, [workPackages, selectedWP]);
      
      const indentWorkPackage = (wpId) => {
        const wp = workPackages.find(w => w.id === wpId);
        if (!wp) return;
        const siblings = workPackages.filter(w => w.projectId === wp.projectId && w.parentId === wp.parentId).sort((a, b) => (a.order || 0) - (b.order || 0));
        const myIndex = siblings.findIndex(s => s.id === wpId);
        if (myIndex <= 0) return;
        const newParent = siblings[myIndex - 1];
        const newSiblings = workPackages.filter(w => w.parentId === newParent.id);
        const maxOrder = newSiblings.length > 0 ? Math.max(...newSiblings.map(s => s.order || 0)) : 0;
        const updated = workPackages.map(w => w.id === wpId ? { ...w, parentId: newParent.id, order: maxOrder + 1 } : w);
        saveWorkPackages(updated);
        setExpandedPackages(prev => ({ ...prev, [newParent.id]: true }));
      };
      
      const outdentWorkPackage = (wpId) => {
        const wp = workPackages.find(w => w.id === wpId);
        if (!wp || !wp.parentId) return;
        const parent = workPackages.find(w => w.id === wp.parentId);
        if (!parent) return;
        const newOrder = (parent.order || 0) + 0.5;
        const updated = workPackages.map(w => w.id === wpId ? { ...w, parentId: parent.parentId, order: newOrder } : w);
        const reordered = updated.filter(w => w.projectId === wp.projectId && w.parentId === parent.parentId).sort((a, b) => (a.order || 0) - (b.order || 0)).map((w, i) => ({ ...w, order: i + 1 }));
        const others = updated.filter(w => w.projectId !== wp.projectId || w.parentId !== parent.parentId);
        saveWorkPackages([...others, ...reordered]);
      };
      
      // Bulk-Operationen f√ºr Multi-Select
      const bulkIndent = () => {
        if (selectedWPs.length === 0) return;
        // Sortiere nach Order damit die Reihenfolge stimmt
        const sorted = selectedWPs.map(id => workPackages.find(w => w.id === id)).filter(Boolean).sort((a, b) => (a.order || 0) - (b.order || 0));
        sorted.forEach(wp => indentWorkPackage(wp.id));
      };
      
      const bulkOutdent = () => {
        if (selectedWPs.length === 0) return;
        // Sortiere umgekehrt nach Order f√ºr Outdent
        const sorted = selectedWPs.map(id => workPackages.find(w => w.id === id)).filter(Boolean).sort((a, b) => (b.order || 0) - (a.order || 0));
        sorted.forEach(wp => outdentWorkPackage(wp.id));
      };
      
      const bulkDelete = () => {
        if (selectedWPs.length === 0) return;
        if (!confirm(`${selectedWPs.length} Arbeitspakete l√∂schen?`)) return;
        const updated = workPackages.filter(wp => !selectedWPs.includes(wp.id));
        saveWorkPackages(updated);
        setSelectedWPs([]);
      };
      
      const bulkSetColor = (color) => {
        if (selectedWPs.length === 0) return;
        const updated = workPackages.map(wp => selectedWPs.includes(wp.id) ? { ...wp, color } : wp);
        saveWorkPackages(updated);
      };
      
      // Click-Handler f√ºr WP-Auswahl (STRG/SHIFT)
      const handleWPClick = (e, wp, flatList) => {
        e.stopPropagation();
        
        if (e.ctrlKey || e.metaKey) {
          // STRG/CMD: Toggle einzelnes WP
          setSelectedWPs(prev => prev.includes(wp.id) ? prev.filter(id => id !== wp.id) : [...prev, wp.id]);
          setLastClickedWP(wp.id);
        } else if (e.shiftKey && lastClickedWP) {
          // SHIFT: Bereich ausw√§hlen
          const lastIndex = flatList.findIndex(w => w.id === lastClickedWP);
          const currentIndex = flatList.findIndex(w => w.id === wp.id);
          if (lastIndex !== -1 && currentIndex !== -1) {
            const start = Math.min(lastIndex, currentIndex);
            const end = Math.max(lastIndex, currentIndex);
            const rangeIds = flatList.slice(start, end + 1).map(w => w.id);
            setSelectedWPs(prev => [...new Set([...prev, ...rangeIds])]);
          }
        } else {
          // Normaler Klick: Nur dieses WP ausw√§hlen
          setSelectedWPs([wp.id]);
          setLastClickedWP(wp.id);
        }
      };
      
      // Auswahl aufheben bei Klick au√üerhalb
      const clearSelection = () => {
        if (selectedWPs.length > 0) {
          setSelectedWPs([]);
        }
      };
      
      // Verschiebt ein WP an eine neue Position (vor/nach einem anderen WP oder als Kind)
      const moveWorkPackage = (draggedId, targetId, position) => {
        if (draggedId === targetId) return;
        const draggedWp = workPackages.find(w => w.id === draggedId);
        const targetWp = workPackages.find(w => w.id === targetId);
        if (!draggedWp || !targetWp) return;
        
        // Pr√ºfe ob target ein Nachkomme von dragged ist (w√ºrde Zirkelbezug erzeugen)
        const isDescendant = (parentId, checkId) => {
          if (parentId === checkId) return true;
          const children = workPackages.filter(w => w.parentId === parentId);
          return children.some(c => isDescendant(c.id, checkId));
        };
        if (isDescendant(draggedId, targetId)) return;
        
        let newParentId, newOrder;
        
        if (position === 'child') {
          // Als Kind des Targets einf√ºgen
          newParentId = targetId;
          const children = workPackages.filter(w => w.parentId === targetId);
          newOrder = children.length > 0 ? Math.max(...children.map(c => c.order || 0)) + 1 : 1;
        } else {
          // Vor oder nach dem Target als Geschwister
          newParentId = targetWp.parentId;
          const siblings = workPackages.filter(w => w.projectId === targetWp.projectId && w.parentId === newParentId && w.id !== draggedId);
          const targetOrder = targetWp.order || 0;
          newOrder = position === 'before' ? targetOrder - 0.5 : targetOrder + 0.5;
        }
        
        // Update das gezogene WP
        let updated = workPackages.map(w => w.id === draggedId ? { ...w, parentId: newParentId, order: newOrder } : w);
        
        // Reorder alle Geschwister um saubere Nummern zu haben
        const siblingsToReorder = updated.filter(w => w.projectId === draggedWp.projectId && w.parentId === newParentId);
        const reordered = siblingsToReorder.sort((a, b) => (a.order || 0) - (b.order || 0)).map((w, i) => ({ ...w, order: i + 1 }));
        const others = updated.filter(w => w.projectId !== draggedWp.projectId || w.parentId !== newParentId);
        
        saveWorkPackages([...others, ...reordered]);
        
        // Expand parent wenn als Kind eingef√ºgt
        if (position === 'child') {
          setExpandedPackages(prev => ({ ...prev, [targetId]: true }));
        }
      };
      
      const toggleExpand = (wpId) => setExpandedPackages(prev => ({ ...prev, [wpId]: prev[wpId] === false ? true : false }));
      
      const moveWithDependencies = (wpId, newStartDate, newEndDate) => {
        const wp = workPackages.find(w => w.id === wpId);
        if (!wp) return;
        
        const oldEndDate = new Date(wp.endDate);
        const newEnd = new Date(newEndDate);
        const daysDiff = Math.round((newEnd - oldEndDate) / (1000 * 60 * 60 * 24));
        
        let updated = workPackages.map(w => w.id === wpId ? { ...w, startDate: newStartDate, endDate: newEndDate } : w);
        let updatedDeps = [...dependencies];
        
        if (daysDiff > 0) {
          // Nach RECHTS geschoben (sp√§ter) ‚Üí je nach Modus
          if (resizeMode === 'rigid') {
            // Starr: Alle Nachfolger sofort mitschieben, Lag bleibt erhalten
            const processSuccessorsRigid = (sourceId, shiftAmount) => {
              dependencies.filter(d => d.fromId === sourceId).forEach(dep => {
                const depWP = updated.find(w => w.id === dep.toId);
                if (depWP && depWP.startDate) {
                  const newDepStart = new Date(depWP.startDate);
                  newDepStart.setDate(newDepStart.getDate() + shiftAmount);
                  const newDepEnd = new Date(depWP.endDate);
                  newDepEnd.setDate(newDepEnd.getDate() + shiftAmount);
                  updated = updated.map(w => w.id === dep.toId ? { ...w, startDate: formatDate(newDepStart), endDate: formatDate(newDepEnd) } : w);
                  processSuccessorsRigid(dep.toId, shiftAmount);
                }
              });
            };
            processSuccessorsRigid(wpId, daysDiff);
          } else {
            // Magnetisch: Puffer erst aufbrauchen, dann verschieben
            const processSuccessorsMagnetic = (sourceId, remainingShift) => {
              dependencies.filter(d => d.fromId === sourceId).forEach(dep => {
                const depIndex = updatedDeps.findIndex(d => d.id === dep.id);
                const currentLag = dep.lagDays || 0;
                
                if (currentLag >= remainingShift) {
                  // Lag reicht aus - nur Lag reduzieren, B bleibt
                  if (depIndex >= 0) {
                    updatedDeps[depIndex] = { ...updatedDeps[depIndex], lagDays: currentLag - remainingShift };
                  }
                } else {
                  // Lag reicht nicht - Lag auf 0 setzen und Rest verschieben
                  const shiftAmount = remainingShift - currentLag;
                  if (depIndex >= 0) {
                    updatedDeps[depIndex] = { ...updatedDeps[depIndex], lagDays: 0 };
                  }
                  
                  const depWP = updated.find(w => w.id === dep.toId);
                  if (depWP && depWP.startDate) {
                    const newDepStart = new Date(depWP.startDate);
                    newDepStart.setDate(newDepStart.getDate() + shiftAmount);
                    const newDepEnd = new Date(depWP.endDate);
                    newDepEnd.setDate(newDepEnd.getDate() + shiftAmount);
                    updated = updated.map(w => w.id === dep.toId ? { ...w, startDate: formatDate(newDepStart), endDate: formatDate(newDepEnd) } : w);
                    processSuccessorsMagnetic(dep.toId, shiftAmount);
                  }
                }
              });
            };
            processSuccessorsMagnetic(wpId, daysDiff);
          }
        } else if (daysDiff < 0) {
          // Nach LINKS geschoben (fr√ºher)
          if (resizeMode === 'rigid') {
            // Starr: Alle Nachfolger auch nach links mitschieben, Lag bleibt erhalten
            const processSuccessorsRigidLeft = (sourceId, shiftAmount) => {
              dependencies.filter(d => d.fromId === sourceId).forEach(dep => {
                const depWP = updated.find(w => w.id === dep.toId);
                if (depWP && depWP.startDate) {
                  const newDepStart = new Date(depWP.startDate);
                  newDepStart.setDate(newDepStart.getDate() + shiftAmount); // shiftAmount ist negativ
                  const newDepEnd = new Date(depWP.endDate);
                  newDepEnd.setDate(newDepEnd.getDate() + shiftAmount);
                  updated = updated.map(w => w.id === dep.toId ? { ...w, startDate: formatDate(newDepStart), endDate: formatDate(newDepEnd) } : w);
                  processSuccessorsRigidLeft(dep.toId, shiftAmount);
                }
              });
            };
            processSuccessorsRigidLeft(wpId, daysDiff);
          } else {
            // Magnetisch: Abstand wird gr√∂√üer, B bleibt wo es ist
            dependencies.filter(d => d.fromId === wpId).forEach(dep => {
              const depIndex = updatedDeps.findIndex(d => d.id === dep.id);
              if (depIndex >= 0) {
                const currentLag = dep.lagDays || 0;
                updatedDeps[depIndex] = { ...updatedDeps[depIndex], lagDays: currentLag + Math.abs(daysDiff) };
              }
            });
          }
        }
        
        saveWorkPackages(updated);
        saveDependencies(updatedDeps);
      };
      
      const moveSummaryWithChildren = (wpId, daysDiff) => {
        const descendants = getAllDescendants(wpId, workPackages);
        const idsToMove = [wpId, ...descendants.map(d => d.id)];
        
        let updated = workPackages.map(wp => {
          if (idsToMove.includes(wp.id) && wp.startDate && wp.endDate) {
            const newStart = new Date(wp.startDate);
            newStart.setDate(newStart.getDate() + daysDiff);
            const newEnd = new Date(wp.endDate);
            newEnd.setDate(newEnd.getDate() + daysDiff);
            return { ...wp, startDate: formatDate(newStart), endDate: formatDate(newEnd) };
          }
          return wp;
        });
        
        let updatedDeps = [...dependencies];
        
        if (daysDiff > 0) {
          // Nach RECHTS ‚Üí externe Abh√§ngigkeiten je nach Modus behandeln
          if (resizeMode === 'rigid') {
            // Starr: Alle externen Nachfolger sofort mitschieben
            const processExternalRigid = (sourceIds, shiftAmount) => {
              dependencies.filter(d => sourceIds.includes(d.fromId) && !idsToMove.includes(d.toId)).forEach(dep => {
                const depWP = updated.find(w => w.id === dep.toId);
                if (depWP && depWP.startDate) {
                  const newDepStart = new Date(depWP.startDate);
                  newDepStart.setDate(newDepStart.getDate() + shiftAmount);
                  const newDepEnd = new Date(depWP.endDate);
                  newDepEnd.setDate(newDepEnd.getDate() + shiftAmount);
                  updated = updated.map(w => w.id === dep.toId ? { ...w, startDate: formatDate(newDepStart), endDate: formatDate(newDepEnd) } : w);
                  processExternalRigid([dep.toId], shiftAmount);
                }
              });
            };
            processExternalRigid(idsToMove, daysDiff);
          } else {
            // Magnetisch: Puffer aufbrauchen, dann verschieben
            const processExternalMagnetic = (sourceIds, remainingShift) => {
              dependencies.filter(d => sourceIds.includes(d.fromId) && !idsToMove.includes(d.toId)).forEach(dep => {
                const depIndex = updatedDeps.findIndex(d => d.id === dep.id);
                const currentLag = dep.lagDays || 0;
                
                if (currentLag >= remainingShift) {
                  if (depIndex >= 0) {
                    updatedDeps[depIndex] = { ...updatedDeps[depIndex], lagDays: currentLag - remainingShift };
                  }
                } else {
                  const shiftAmount = remainingShift - currentLag;
                  if (depIndex >= 0) {
                    updatedDeps[depIndex] = { ...updatedDeps[depIndex], lagDays: 0 };
                  }
                  
                  const depWP = updated.find(w => w.id === dep.toId);
                  if (depWP && depWP.startDate) {
                    const newDepStart = new Date(depWP.startDate);
                    newDepStart.setDate(newDepStart.getDate() + shiftAmount);
                    const newDepEnd = new Date(depWP.endDate);
                    newDepEnd.setDate(newDepEnd.getDate() + shiftAmount);
                    updated = updated.map(w => w.id === dep.toId ? { ...w, startDate: formatDate(newDepStart), endDate: formatDate(newDepEnd) } : w);
                    processExternalMagnetic([dep.toId], shiftAmount);
                  }
                }
              });
            };
            processExternalMagnetic(idsToMove, daysDiff);
          }
        } else if (daysDiff < 0) {
          // Nach LINKS
          if (resizeMode === 'rigid') {
            // Starr: Alle externen Nachfolger auch nach links mitschieben
            const processExternalRigidLeft = (sourceIds, shiftAmount) => {
              dependencies.filter(d => sourceIds.includes(d.fromId) && !idsToMove.includes(d.toId)).forEach(dep => {
                const depWP = updated.find(w => w.id === dep.toId);
                if (depWP && depWP.startDate) {
                  const newDepStart = new Date(depWP.startDate);
                  newDepStart.setDate(newDepStart.getDate() + shiftAmount);
                  const newDepEnd = new Date(depWP.endDate);
                  newDepEnd.setDate(newDepEnd.getDate() + shiftAmount);
                  updated = updated.map(w => w.id === dep.toId ? { ...w, startDate: formatDate(newDepStart), endDate: formatDate(newDepEnd) } : w);
                  processExternalRigidLeft([dep.toId], shiftAmount);
                }
              });
            };
            processExternalRigidLeft(idsToMove, daysDiff);
          } else {
            // Magnetisch: Abstand wird gr√∂√üer, externe Nachfolger bleiben
            dependencies.filter(d => idsToMove.includes(d.fromId) && !idsToMove.includes(d.toId)).forEach(dep => {
              const depIndex = updatedDeps.findIndex(d => d.id === dep.id);
              if (depIndex >= 0) {
                const currentLag = dep.lagDays || 0;
                updatedDeps[depIndex] = { ...updatedDeps[depIndex], lagDays: currentLag + Math.abs(daysDiff) };
              }
            });
          }
        }
        
        saveWorkPackages(updated);
        saveDependencies(updatedDeps);
      };
      
      const resizeWithDependencies = (wpId, newEndDate) => {
        const wp = workPackages.find(w => w.id === wpId);
        if (!wp) return;
        
        const oldEndDate = new Date(wp.endDate);
        const newEnd = new Date(newEndDate);
        const daysDiff = Math.round((newEnd - oldEndDate) / (1000 * 60 * 60 * 24));
        
        let updated = workPackages.map(w => w.id === wpId ? { ...w, endDate: newEndDate } : w);
        let updatedDeps = [...dependencies];
        
        if (daysDiff > 0) {
          if (resizeMode === 'rigid') {
            // Starr: Alle Nachfolger sofort mitschieben, Lag bleibt erhalten
            const processSuccessorsRigid = (sourceId, shiftAmount) => {
              dependencies.filter(d => d.fromId === sourceId).forEach(dep => {
                const depWP = updated.find(w => w.id === dep.toId);
                if (depWP && depWP.startDate) {
                  const newDepStart = new Date(depWP.startDate);
                  newDepStart.setDate(newDepStart.getDate() + shiftAmount);
                  const newDepEnd = new Date(depWP.endDate);
                  newDepEnd.setDate(newDepEnd.getDate() + shiftAmount);
                  updated = updated.map(w => w.id === dep.toId ? { ...w, startDate: formatDate(newDepStart), endDate: formatDate(newDepEnd) } : w);
                  processSuccessorsRigid(dep.toId, shiftAmount);
                }
              });
            };
            processSuccessorsRigid(wpId, daysDiff);
          } else {
            // Magnetisch: Puffer erst aufbrauchen, dann verschieben
            const processSuccessorsMagnetic = (sourceId, remainingShift) => {
              dependencies.filter(d => d.fromId === sourceId).forEach(dep => {
                const depIndex = updatedDeps.findIndex(d => d.id === dep.id);
                const currentLag = dep.lagDays || 0;
                
                if (currentLag >= remainingShift) {
                  if (depIndex >= 0) {
                    updatedDeps[depIndex] = { ...updatedDeps[depIndex], lagDays: currentLag - remainingShift };
                  }
                } else {
                  const shiftAmount = remainingShift - currentLag;
                  if (depIndex >= 0) {
                    updatedDeps[depIndex] = { ...updatedDeps[depIndex], lagDays: 0 };
                  }
                  
                  const depWP = updated.find(w => w.id === dep.toId);
                  if (depWP && depWP.startDate) {
                    const newDepStart = new Date(depWP.startDate);
                    newDepStart.setDate(newDepStart.getDate() + shiftAmount);
                    const newDepEnd = new Date(depWP.endDate);
                    newDepEnd.setDate(newDepEnd.getDate() + shiftAmount);
                    updated = updated.map(w => w.id === dep.toId ? { ...w, startDate: formatDate(newDepStart), endDate: formatDate(newDepEnd) } : w);
                    processSuccessorsMagnetic(dep.toId, shiftAmount);
                  }
                }
              });
            };
            processSuccessorsMagnetic(wpId, daysDiff);
          }
        } else if (daysDiff < 0) {
          // Balken wird VERKLEINERT ‚Üí Abstand wird gr√∂√üer, B bleibt wo es ist
          dependencies.filter(d => d.fromId === wpId).forEach(dep => {
            const depIndex = updatedDeps.findIndex(d => d.id === dep.id);
            if (depIndex >= 0) {
              const currentLag = dep.lagDays || 0;
              updatedDeps[depIndex] = { ...updatedDeps[depIndex], lagDays: currentLag + Math.abs(daysDiff) };
            }
          });
        }
        
        saveWorkPackages(updated);
        saveDependencies(updatedDeps);
      };
      
      // Berechne Preview-Positionen f√ºr abh√§ngige Balken w√§hrend Drag/Resize
      const calculatePreviewPositions = (wpId, newEndDate) => {
        const wp = workPackages.find(w => w.id === wpId);
        if (!wp) return {};
        
        const oldEndDate = new Date(wp.endDate);
        const newEnd = new Date(newEndDate);
        const daysDiff = Math.round((newEnd - oldEndDate) / (1000 * 60 * 60 * 24));
        
        if (daysDiff === 0) return {};
        
        const previews = {};
        
        if (daysDiff > 0) {
          // Nach rechts
          if (resizeMode === 'rigid') {
            const processRigid = (sourceId, shiftAmount) => {
              dependencies.filter(d => d.fromId === sourceId).forEach(dep => {
                const depWP = workPackages.find(w => w.id === dep.toId);
                if (depWP && depWP.startDate) {
                  const existingPreview = previews[dep.toId];
                  const baseStart = existingPreview ? new Date(existingPreview.startDate) : new Date(depWP.startDate);
                  const baseEnd = existingPreview ? new Date(existingPreview.endDate) : new Date(depWP.endDate);
                  const newDepStart = new Date(baseStart);
                  newDepStart.setDate(newDepStart.getDate() + shiftAmount);
                  const newDepEnd = new Date(baseEnd);
                  newDepEnd.setDate(newDepEnd.getDate() + shiftAmount);
                  previews[dep.toId] = { startDate: formatDate(newDepStart), endDate: formatDate(newDepEnd) };
                  processRigid(dep.toId, shiftAmount);
                }
              });
            };
            processRigid(wpId, daysDiff);
          } else {
            const processMagnetic = (sourceId, remainingShift) => {
              dependencies.filter(d => d.fromId === sourceId).forEach(dep => {
                const currentLag = dep.lagDays || 0;
                if (currentLag < remainingShift) {
                  const shiftAmount = remainingShift - currentLag;
                  const depWP = workPackages.find(w => w.id === dep.toId);
                  if (depWP && depWP.startDate) {
                    const existingPreview = previews[dep.toId];
                    const baseStart = existingPreview ? new Date(existingPreview.startDate) : new Date(depWP.startDate);
                    const baseEnd = existingPreview ? new Date(existingPreview.endDate) : new Date(depWP.endDate);
                    const newDepStart = new Date(baseStart);
                    newDepStart.setDate(newDepStart.getDate() + shiftAmount);
                    const newDepEnd = new Date(baseEnd);
                    newDepEnd.setDate(newDepEnd.getDate() + shiftAmount);
                    previews[dep.toId] = { startDate: formatDate(newDepStart), endDate: formatDate(newDepEnd) };
                    processMagnetic(dep.toId, shiftAmount);
                  }
                }
              });
            };
            processMagnetic(wpId, daysDiff);
          }
        } else if (daysDiff < 0 && resizeMode === 'rigid') {
          // Nach links - nur bei rigid Mode werden Nachfolger mitgezogen
          const processRigidLeft = (sourceId, shiftAmount) => {
            dependencies.filter(d => d.fromId === sourceId).forEach(dep => {
              const depWP = workPackages.find(w => w.id === dep.toId);
              if (depWP && depWP.startDate) {
                const existingPreview = previews[dep.toId];
                const baseStart = existingPreview ? new Date(existingPreview.startDate) : new Date(depWP.startDate);
                const baseEnd = existingPreview ? new Date(existingPreview.endDate) : new Date(depWP.endDate);
                const newDepStart = new Date(baseStart);
                newDepStart.setDate(newDepStart.getDate() + shiftAmount); // shiftAmount ist negativ
                const newDepEnd = new Date(baseEnd);
                newDepEnd.setDate(newDepEnd.getDate() + shiftAmount);
                previews[dep.toId] = { startDate: formatDate(newDepStart), endDate: formatDate(newDepEnd) };
                processRigidLeft(dep.toId, shiftAmount);
              }
            });
          };
          processRigidLeft(wpId, daysDiff);
        }
        
        return previews;
      };
      
      React.useEffect(() => {
        const handleMouseMove = (e) => {
          if (draggedWP) {
            const dx = e.clientX - draggedWP.startX;
            const daysDiff = Math.round(dx / DAY_WIDTH);
            
            if (draggedWP.isSummary) {
              setDraggedWP(prev => ({ ...prev, daysDiff }));
              // Preview f√ºr Summary-Drag berechnen
              if (daysDiff !== 0) {
                const wp = workPackages.find(w => w.id === draggedWP.wp.id);
                if (wp && wp.endDate) {
                  const newEnd = new Date(wp.endDate);
                  newEnd.setDate(newEnd.getDate() + daysDiff);
                  const previews = calculatePreviewPositions(draggedWP.wp.id, formatDate(newEnd));
                  setPreviewPositions(previews);
                  // Speichere Original-Positionen f√ºr Schatten (nur einmal)
                  if (Object.keys(originalPositionsRef.current).length === 0) {
                    const originals = { [draggedWP.wp.id]: { startDate: wp.startDate, endDate: wp.endDate } };
                    Object.keys(previews).forEach(id => {
                      const origWP = workPackages.find(w => w.id === id);
                      if (origWP) originals[id] = { startDate: origWP.startDate, endDate: origWP.endDate };
                    });
                    originalPositionsRef.current = originals;
                    setOriginalPositions(originals);
                  }
                }
              } else {
                setPreviewPositions({});
              }
            } else {
              let newStart = xToDate(draggedWP.originalX + dx);
              const wp = draggedWP.wp;
              const allowWeekend = wp.allowWeekend !== false; // Default: erlaubt (f√ºr R√ºckw√§rtskompatibilit√§t)
              
              // Wenn Wochenende nicht erlaubt, zum n√§chsten Arbeitstag springen
              if (!allowWeekend) {
                const startDate = new Date(newStart);
                if (isWeekendDay(startDate)) {
                  const skipped = skipWeekend(startDate, true);
                  newStart = formatDate(skipped);
                }
              }
              
              // Dauer berechnen (in Arbeitstagen oder KTn)
              const origStart = new Date(wp.startDate);
              const origEnd = new Date(wp.endDate);
              let duration;
              
              if (!allowWeekend) {
                // Z√§hle Arbeitstage
                duration = countWorkingDays(origStart, origEnd, false) - 1;
                const newEnd = addWorkingDays(new Date(newStart), duration, false);
                setDraggedWP(prev => ({ ...prev, previewStart: newStart, previewEnd: formatDate(newEnd) }));
              } else {
                // Normale KT
                duration = (origEnd - origStart) / (1000 * 60 * 60 * 24);
                const newEnd = new Date(newStart);
                newEnd.setDate(newEnd.getDate() + duration);
                setDraggedWP(prev => ({ ...prev, previewStart: newStart, previewEnd: formatDate(newEnd) }));
              }
              
              // Preview f√ºr normale Drag berechnen
              const previewEnd = draggedWP.previewEnd || formatDate(new Date(newStart).setDate(new Date(newStart).getDate() + duration));
              const previews = calculatePreviewPositions(wp.id, previewEnd);
              setPreviewPositions(previews);
              // Speichere Original-Positionen f√ºr Schatten (nur einmal)
              if (Object.keys(originalPositionsRef.current).length === 0) {
                const originals = { [wp.id]: { startDate: wp.startDate, endDate: wp.endDate } };
                Object.keys(previews).forEach(id => {
                  const origWP = workPackages.find(w => w.id === id);
                  if (origWP) originals[id] = { startDate: origWP.startDate, endDate: origWP.endDate };
                });
                originalPositionsRef.current = originals;
                setOriginalPositions(originals);
              }
            }
          }
          if (resizingWP) {
            const dx = e.clientX - resizingWP.startX;
            if (resizingWP.side === 'left') {
              // Links resizen - Start √§ndern
              const newStart = xToDate(resizingWP.originalStartX + dx);
              if (new Date(newStart) <= new Date(resizingWP.wp.endDate)) {
                setResizingWP(prev => ({ ...prev, previewStart: newStart }));
                // Speichere Original-Positionen f√ºr Schatten (nur einmal)
                if (Object.keys(originalPositionsRef.current).length === 0) {
                  const wp = resizingWP.wp;
                  const originals = { [wp.id]: { startDate: wp.startDate, endDate: wp.endDate } };
                  originalPositionsRef.current = originals;
                  setOriginalPositions(originals);
                }
              }
            } else {
              // Rechts resizen - Ende √§ndern (wie bisher)
              const newEnd = xToDate(resizingWP.originalEndX + dx);
              if (new Date(newEnd) >= new Date(resizingWP.wp.startDate)) {
                setResizingWP(prev => ({ ...prev, previewEnd: newEnd }));
                // Preview f√ºr Resize berechnen
                const previews = calculatePreviewPositions(resizingWP.wp.id, newEnd);
                setPreviewPositions(previews);
                // Speichere Original-Positionen f√ºr Schatten (nur einmal)
                if (Object.keys(originalPositionsRef.current).length === 0) {
                  const wp = resizingWP.wp;
                  const originals = { [wp.id]: { startDate: wp.startDate, endDate: wp.endDate } };
                  Object.keys(previews).forEach(id => {
                    const origWP = workPackages.find(w => w.id === id);
                    if (origWP) originals[id] = { startDate: origWP.startDate, endDate: origWP.endDate };
                  });
                  originalPositionsRef.current = originals;
                  setOriginalPositions(originals);
                }
              }
            }
          }
          if (linkingFrom) setLinkMousePos({ x: e.clientX, y: e.clientY });
        };
        const handleMouseUp = (e) => {
          if (draggedWP) {
            if (draggedWP.isSummary && draggedWP.daysDiff !== 0) {
              moveSummaryWithChildren(draggedWP.wp.id, draggedWP.daysDiff);
            } else if (draggedWP.previewStart) {
              moveWithDependencies(draggedWP.wp.id, draggedWP.previewStart, draggedWP.previewEnd);
            }
          }
          if (resizingWP) {
            if (resizingWP.side === 'left' && resizingWP.previewStart) {
              // Links resizen - nur Start √§ndern, Ende bleibt
              const updated = workPackages.map(w => w.id === resizingWP.wp.id ? { ...w, startDate: resizingWP.previewStart } : w);
              saveWorkPackages(updated);
            } else if (resizingWP.previewEnd) {
              resizeWithDependencies(resizingWP.wp.id, resizingWP.previewEnd);
            }
          }
          if (linkingFrom) {
            const target = e.target.closest('[data-wp-id]');
            if (target && target.dataset.wpId !== linkingFrom.id) addDependency(linkingFrom.id, target.dataset.wpId, linkingFrom.fromStart ? 'SS' : 'FS');
          }
          setDraggedWP(null); setResizingWP(null); setLinkingFrom(null); setLinkMousePos(null); setPreviewPositions({}); 
          originalPositionsRef.current = {};
          setOriginalPositions({});
        };
        if (draggedWP || resizingWP || linkingFrom) {
          // Markiere als Dragging
          window._ganttScrollTop.isDragging = true;
          
          const wrappedMouseMove = (e) => {
            // Scroll VOR dem Handler aktualisieren (vertikal + horizontal)
            if (ganttScrollRef.current) {
              window._ganttScrollTop.value = ganttScrollRef.current.scrollTop;
            }
            if (ganttHScrollRef.current) {
              window._ganttScrollLeft.value = ganttHScrollRef.current.scrollLeft;
            }
            handleMouseMove(e);
            // Scroll nach State-Update wiederherstellen (mehrfach zur Sicherheit)
            const restore = () => {
              if (ganttScrollRef.current && window._ganttScrollTop.isDragging) {
                ganttScrollRef.current.scrollTop = window._ganttScrollTop.value;
              }
              if (ganttHScrollRef.current && window._ganttScrollTop.isDragging) {
                ganttHScrollRef.current.scrollLeft = window._ganttScrollLeft.value;
              }
              if (headerScrollRef.current && window._ganttScrollTop.isDragging) {
                headerScrollRef.current.scrollLeft = window._ganttScrollLeft.value;
              }
            };
            requestAnimationFrame(restore);
            setTimeout(restore, 0);
            setTimeout(restore, 16);
          };
          
          const wrappedMouseUp = (e) => {
            const scrollPosV = window._ganttScrollTop.value;
            const scrollPosH = window._ganttScrollLeft.value;
            handleMouseUp(e);
            // Scroll nach mouseUp wiederherstellen
            const restore = () => {
              if (ganttScrollRef.current) {
                ganttScrollRef.current.scrollTop = scrollPosV;
              }
              if (ganttHScrollRef.current) {
                ganttHScrollRef.current.scrollLeft = scrollPosH;
              }
              if (headerScrollRef.current) {
                headerScrollRef.current.scrollLeft = scrollPosH;
              }
            };
            requestAnimationFrame(restore);
            setTimeout(restore, 0);
            setTimeout(restore, 50);
            // Reset nach Delay
            setTimeout(() => {
              window._ganttScrollTop.isDragging = false;
              window._ganttScrollTop.value = 0;
              window._ganttScrollLeft.value = 0;
            }, 100);
          };
          
          document.addEventListener('mousemove', wrappedMouseMove);
          document.addEventListener('mouseup', wrappedMouseUp);
          return () => { 
            document.removeEventListener('mousemove', wrappedMouseMove); 
            document.removeEventListener('mouseup', wrappedMouseUp); 
          };
        }
      }, [draggedWP, resizingWP, linkingFrom, workPackages, dependencies, DAY_WIDTH, resizeMode]);
      
      // Scroll-Position bei jedem Render w√§hrend Drag wiederherstellen
      React.useLayoutEffect(() => {
        if (window._ganttScrollTop.isDragging) {
          if (ganttScrollRef.current) {
            ganttScrollRef.current.scrollTop = window._ganttScrollTop.value;
          }
          if (ganttHScrollRef.current) {
            ganttHScrollRef.current.scrollLeft = window._ganttScrollLeft.value;
          }
          if (headerScrollRef.current) {
            headerScrollRef.current.scrollLeft = window._ganttScrollLeft.value;
          }
        }
      });
      
      React.useEffect(() => {
        if (!contextMenu) return;
        const handleClick = () => setContextMenu(null);
        const timer = setTimeout(() => document.addEventListener('click', handleClick), 10);
        return () => { clearTimeout(timer); document.removeEventListener('click', handleClick); };
      }, [contextMenu]);
      
      // Baseline-Men√º schlie√üen bei Klick au√üerhalb
      React.useEffect(() => {
        if (!baselineMenuOpen) return;
        const handleClick = () => setBaselineMenuOpen(false);
        const timer = setTimeout(() => document.addEventListener('click', handleClick), 10);
        return () => { clearTimeout(timer); document.removeEventListener('click', handleClick); };
      }, [baselineMenuOpen]);
      
      // Ansicht-Men√º schlie√üen bei Klick au√üerhalb
      React.useEffect(() => {
        if (!viewMenuOpen) return;
        const handleClick = () => setViewMenuOpen(false);
        const timer = setTimeout(() => document.addEventListener('click', handleClick), 10);
        return () => { clearTimeout(timer); document.removeEventListener('click', handleClick); };
      }, [viewMenuOpen]);
      
      // Spalten-Men√º schlie√üen bei Klick au√üerhalb
      React.useEffect(() => {
        if (!columnMenuOpen) return;
        const handleClick = () => setColumnMenuOpen(false);
        const timer = setTimeout(() => document.addEventListener('click', handleClick), 10);
        return () => { clearTimeout(timer); document.removeEventListener('click', handleClick); };
      }, [columnMenuOpen]);
      
      // Tag-Kontextmen√º schlie√üen bei Klick au√üerhalb
      React.useEffect(() => {
        if (!dayContextMenu) return;
        const handleClick = () => setDayContextMenu(null);
        const timer = setTimeout(() => document.addEventListener('click', handleClick), 10);
        return () => { clearTimeout(timer); document.removeEventListener('click', handleClick); };
      }, [dayContextMenu]);
      
      // ESC-Taste zum Aufheben der Multi-Auswahl
      React.useEffect(() => {
        const handleKeyDown = (e) => {
          if (e.key === 'Escape' && selectedWPs.length > 0) {
            setSelectedWPs([]);
          }
        };
        document.addEventListener('keydown', handleKeyDown);
        return () => document.removeEventListener('keydown', handleKeyDown);
      }, [selectedWPs.length]);
      
      // Panel-Resize Handler
      React.useEffect(() => {
        if (!isResizingPanel) return;
        const handleMouseMove = (e) => {
          // Ber√ºcksichtige die Projekt-Sidebar Breite
          const sidebarWidth = projectSidebarCollapsed ? 40 : 224; // w-10 = 40px, w-56 = 224px
          const newWidth = Math.max(250, Math.min(800, e.clientX - sidebarWidth));
          setLeftPanelWidth(newWidth);
        };
        const handleMouseUp = () => setIsResizingPanel(false);
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        return () => {
          document.removeEventListener('mousemove', handleMouseMove);
          document.removeEventListener('mouseup', handleMouseUp);
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        };
      }, [isResizingPanel, projectSidebarCollapsed, setLeftPanelWidth]);
      
      // Column-Resize Handler (f√ºr individuelle Spaltenbreiten)
      React.useEffect(() => {
        if (!resizingColumn) return;
        const handleMouseMove = (e) => {
          const diff = e.clientX - resizingColumn.startX;
          const newWidth = Math.max(40, Math.min(150, resizingColumn.startWidth + diff));
          setColumnWidths(prev => ({ ...prev, [resizingColumn.key]: newWidth }));
        };
        const handleMouseUp = () => setResizingColumn(null);
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        return () => {
          document.removeEventListener('mousemove', handleMouseMove);
          document.removeEventListener('mouseup', handleMouseUp);
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        };
      }, [resizingColumn, setColumnWidths]);
      
      // Hilfsfunktion: Datum als dd.mm.yy formatieren
      const formatDateShort = (dateStr) => {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = String(d.getFullYear()).slice(-2);
        return `${day}.${month}.${year}`;
      };
      
      // Row-Drag Handler
      React.useEffect(() => {
        if (!rowDragWP) return;
        
        const handleMouseUp = () => {
          if (dropTarget && rowDragWP) {
            moveWorkPackage(rowDragWP.id, dropTarget.wpId, dropTarget.position);
          }
          setRowDragWP(null);
          setDropTarget(null);
        };
        
        document.addEventListener('mouseup', handleMouseUp);
        return () => document.removeEventListener('mouseup', handleMouseUp);
      }, [rowDragWP, dropTarget]);
      
      const renderBracket = (wp, x, width, color) => {
        const totalHours = calculateTotalHours(wp.id);
        const isDragging = draggedWP?.wp.id === wp.id;
        const displayX = isDragging && draggedWP.daysDiff ? x + (draggedWP.daysDiff * DAY_WIDTH) : x;
        const assignmentText = showAssignments ? getAssignmentText(wp) : '';
        
        return (
          <React.Fragment>
            <div 
              className="absolute cursor-move group"
              style={{ left: displayX, width, top: 4, height: ROW_HEIGHT - 8, opacity: isDragging ? 0.6 : 1 }}
              data-wp-id={wp.id}
              onMouseEnter={(e) => { if (!draggedWP) { const rect = e.currentTarget.getBoundingClientRect(); setHoveredWP({ wp, x: rect.left, y: rect.bottom + 5, totalHours }); }}}
              onMouseLeave={() => setHoveredWP(null)}
              onClick={(e) => { e.stopPropagation(); setSelectedWP(wp); }}
              onDoubleClick={(e) => { e.stopPropagation(); e.preventDefault(); setSelectedWPs([]); setSidebarWPId(wp.id); }}
              onContextMenu={(e) => { e.preventDefault(); e.stopPropagation(); setContextMenu({ x: e.clientX, y: e.clientY, type: 'gantt-wp', wp, project: projects.find(p => p.id === wp.projectId) }); }}
              onMouseDown={(e) => { if (e.detail > 1) return; if (e.target.classList.contains('row-drag-handle')) return; e.preventDefault(); if (ganttScrollRef.current) { window._ganttScrollTop.value = ganttScrollRef.current.scrollTop; window._ganttScrollTop.isDragging = true; } if (ganttHScrollRef.current) { window._ganttScrollLeft.value = ganttHScrollRef.current.scrollLeft; } const calcDates = calculateDatesFromChildren(wp.id, workPackages); setDraggedWP({ wp, startX: e.clientX, originalX: dateToX(calcDates?.startDate), isSummary: true, daysDiff: 0 }); }}
            >
              <div className="absolute left-0 top-0 w-1.5 h-full" style={{ borderLeft: `2px solid ${color}`, borderTop: `2px solid ${color}`, borderTopLeftRadius: 3 }} />
              <div className="absolute top-0 left-1.5 right-1.5" style={{ borderTop: `2px solid ${color}` }} />
              <div className="absolute left-1/2 -translate-x-1/2 -top-1"><div className="w-2 h-2 rotate-45" style={{ backgroundColor: color }} /></div>
              <div className="absolute right-0 top-0 w-1.5 h-full" style={{ borderRight: `2px solid ${color}`, borderTop: `2px solid ${color}`, borderTopRightRadius: 3 }} />
              {/* Vertikaler Drag-Handle */}
              <div 
                className="row-drag-handle absolute left-1/2 -translate-x-1/2 top-2 w-4 h-2 cursor-grab opacity-0 group-hover:opacity-60 hover:opacity-100 flex justify-center gap-px rounded"
                style={{ backgroundColor: color }}
                onMouseDown={(e) => { e.stopPropagation(); e.preventDefault(); setRowDragWP(wp); }}
                title="Vertikal verschieben"
              >
                <div className="w-px h-full bg-white/60"></div>
                <div className="w-px h-full bg-white/60"></div>
                <div className="w-px h-full bg-white/60"></div>
              </div>
            </div>
            <div className="absolute text-xs whitespace-nowrap pointer-events-none" style={{ left: displayX + width + 8, top: ROW_HEIGHT / 2 - 7 }}>
              <span className="text-gray-700 font-medium">{wp.name}</span>
              {showHours && totalHours > 0 && <span className="text-gray-500 ml-2">{totalHours}h</span>}
              {assignmentText && <span className="text-indigo-500 ml-2">{assignmentText}</span>}
            </div>
          </React.Fragment>
        );
      };
      
      const renderBar = (wp, x, width, color, isChild) => {
        const isDragging = draggedWP?.wp.id === wp.id;
        const isResizing = resizingWP?.wp.id === wp.id;
        const hasChildren = getChildren(wp.id, workPackages).length > 0;
        const isSelected = selectedWP?.id === wp.id;
        const totalHours = calculateTotalHours(wp.id);
        const textWidth = wp.name.length * 6;
        const textFitsInBar = textWidth < width - 10;
        const assignmentText = showAssignments ? getAssignmentText(wp) : '';
        
        return (
          <React.Fragment>
            {/* Hover-Container f√ºr Link-Handles - gro√üz√ºgiger Bereich f√ºr bessere Bedienung */}
            <div 
              className="absolute"
              style={{ left: x - 28, width: Math.max(width, DAY_WIDTH) + 56, top: 0, height: ROW_HEIGHT, zIndex: 5 }}
              onMouseEnter={(e) => { if (!draggedWP && !resizingWP && !linkingFrom) { setHoveredWP({ wp, totalHours }); }}}
              onMouseLeave={(e) => { 
                // Nur verlassen wenn wir wirklich den Container verlassen
                const rect = e.currentTarget.getBoundingClientRect();
                const isInside = e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom;
                if (!isInside && !draggedWP && !resizingWP && !linkingFrom) setHoveredWP(null); 
              }}
            >
              {/* Link-Handles - weiter au√üen vom Balken f√ºr bessere Bedienung */}
              {hoveredWP?.wp.id === wp.id && (
                <React.Fragment>
                  <div className="link-handle absolute w-5 h-5 rounded-full bg-indigo-500 border-2 border-white shadow-lg cursor-crosshair hover:bg-indigo-600 hover:scale-125 transition-all"
                    style={{ left: -10, top: '50%', transform: 'translateY(-50%)', zIndex: 35 }}
                    onMouseDown={(e) => { e.stopPropagation(); e.preventDefault(); const rect = e.target.getBoundingClientRect(); setLinkingFrom({ ...wp, startX: rect.left + rect.width / 2, startY: rect.top + rect.height / 2, fromStart: true }); setLinkMousePos({ x: e.clientX, y: e.clientY }); }}
                    title="Start-Abh√§ngigkeit (SS)" />
                  <div className="link-handle absolute w-5 h-5 rounded-full bg-indigo-500 border-2 border-white shadow-lg cursor-crosshair hover:bg-indigo-600 hover:scale-125 transition-all"
                    style={{ right: -10, top: '50%', transform: 'translateY(-50%)', zIndex: 35 }}
                    onMouseDown={(e) => { e.stopPropagation(); e.preventDefault(); const rect = e.target.getBoundingClientRect(); setLinkingFrom({ ...wp, startX: rect.left + rect.width / 2, startY: rect.top + rect.height / 2, fromStart: false }); setLinkMousePos({ x: e.clientX, y: e.clientY }); }}
                    title="Ende-Abh√§ngigkeit (FS)" />
                </React.Fragment>
              )}
            </div>
            <div data-wp-id={wp.id} className={`absolute rounded shadow-sm cursor-pointer group ${isSelected ? 'ring-2 ring-indigo-500 ring-offset-1' : ''}`}
              style={{ left: x, width: Math.max(width, DAY_WIDTH), top: isChild ? 6 : 4, height: isChild ? ROW_HEIGHT - 12 : ROW_HEIGHT - 8, backgroundColor: color, opacity: isDragging || isResizing ? 0.6 : 1, zIndex: 6 }}
              onClick={(e) => { e.stopPropagation(); setSelectedWP(wp); }}
              onDoubleClick={(e) => { e.stopPropagation(); e.preventDefault(); setSelectedWPs([]); setSidebarWPId(wp.id); }}
              onContextMenu={(e) => { e.preventDefault(); e.stopPropagation(); setContextMenu({ x: e.clientX, y: e.clientY, type: 'gantt-wp', wp, project: projects.find(p => p.id === wp.projectId) }); }}
              onMouseEnter={(e) => { if (!draggedWP && !resizingWP && !linkingFrom) { setHoveredWP({ wp, totalHours }); }}}
              onMouseDown={(e) => { if (e.detail > 1) return; if (hasChildren || e.target.classList.contains('resize-handle') || e.target.classList.contains('link-handle') || e.target.classList.contains('row-drag-handle')) return; e.preventDefault(); if (ganttScrollRef.current) { window._ganttScrollTop.value = ganttScrollRef.current.scrollTop; window._ganttScrollTop.isDragging = true; } if (ganttHScrollRef.current) { window._ganttScrollLeft.value = ganttHScrollRef.current.scrollLeft; } setDraggedWP({ wp, startX: e.clientX, originalX: x, isSummary: false }); }}>
              {textFitsInBar && <div className="px-1 text-white text-xs truncate" style={{ fontSize: 10, lineHeight: `${isChild ? ROW_HEIGHT - 12 : ROW_HEIGHT - 8}px` }}>{wp.name}</div>}
              {!hasChildren && <div className="resize-handle absolute left-0 top-0 bottom-0 w-2 cursor-ew-resize opacity-0 group-hover:opacity-100 bg-white/30 rounded-l" onMouseDown={(e) => { e.stopPropagation(); if (ganttScrollRef.current) { window._ganttScrollTop.value = ganttScrollRef.current.scrollTop; window._ganttScrollTop.isDragging = true; } if (ganttHScrollRef.current) { window._ganttScrollLeft.value = ganttHScrollRef.current.scrollLeft; } setResizingWP({ wp, startX: e.clientX, originalStartX: x, originalEndX: x + width, side: 'left' }); }} />}
              {!hasChildren && <div className="resize-handle absolute right-0 top-0 bottom-0 w-2 cursor-ew-resize opacity-0 group-hover:opacity-100 bg-white/30 rounded-r" onMouseDown={(e) => { e.stopPropagation(); if (ganttScrollRef.current) { window._ganttScrollTop.value = ganttScrollRef.current.scrollTop; window._ganttScrollTop.isDragging = true; } if (ganttHScrollRef.current) { window._ganttScrollLeft.value = ganttHScrollRef.current.scrollLeft; } setResizingWP({ wp, startX: e.clientX, originalStartX: x, originalEndX: x + width, side: 'right' }); }} />}
              {/* Vertikaler Drag-Handle links am Balken */}
              <div 
                className="row-drag-handle absolute left-1 top-1/2 -translate-y-1/2 w-2 h-3 cursor-grab opacity-0 group-hover:opacity-60 hover:opacity-100 flex flex-col justify-center gap-px"
                onMouseDown={(e) => { e.stopPropagation(); e.preventDefault(); setRowDragWP(wp); }}
                title="Vertikal verschieben"
              >
                <div className="w-full h-px bg-white/80"></div>
                <div className="w-full h-px bg-white/80"></div>
                <div className="w-full h-px bg-white/80"></div>
              </div>
            </div>
            <div className="absolute text-xs whitespace-nowrap pointer-events-none" style={{ left: x + width + 22, top: ROW_HEIGHT / 2 - 7 }}>
              {showHours && totalHours > 0 && <span className="text-gray-500">{totalHours}h</span>}
              {!textFitsInBar && <span className="ml-1 text-gray-600">{wp.name}</span>}
              {assignmentText && <span className="text-indigo-500 ml-2">{assignmentText}</span>}
            </div>
          </React.Fragment>
        );
      };
      
      // Projekt-Filterung (muss VOR allProjectsData definiert werden!)
      // Priorit√§t: einzelnes Projekt > Ordner > alle
      const filteredProjects = selectedProjectId 
        ? (projects || []).filter(p => p.id === selectedProjectId) 
        : selectedFolderId
          ? (projects || []).filter(p => p.folderId === selectedFolderId)
          : (projects || []);
      
      const allProjectsData = (filteredProjects || []).map(project => ({
        project,
        flatList: getFlatSortedList(project.id)
      }));
      
      // Berechne Monate f√ºr Header
      const getMonthsForWeeks = () => {
        const months = [];
        let currentMonth = null;
        let startWeekIdx = 0;
        
        weekNumbers.forEach((weekNum, idx) => {
          const weekDates = getWeekDates(weekNum, new Date().getFullYear());
          const monthIdx = weekDates[0].getMonth();
          const monthName = monthNames[monthIdx];
          
          if (monthName !== currentMonth) {
            if (currentMonth !== null) {
              months.push({ name: currentMonth, weeks: idx - startWeekIdx });
            }
            currentMonth = monthName;
            startWeekIdx = idx;
          }
        });
        months.push({ name: currentMonth, weeks: weekNumbers.length - startWeekIdx });
        return months;
      };
      
      const monthHeaders = getMonthsForWeeks();
      
      const UserAssignmentSection = ({ wpId, field, label, filterKey }) => {
        const wp = workPackages.find(w => w.id === wpId);
        const scrollRef = React.useRef(null);
        const scrollKey = `${wpId}-${field}`;
        
        // Scroll-Position nach jedem Render wiederherstellen
        React.useLayoutEffect(() => {
          if (scrollRef.current && _scrollPositions[scrollKey]) {
            scrollRef.current.scrollTop = _scrollPositions[scrollKey];
          }
        });
        
        if (!wp) return null;
        const assignments = wp[field] || [];
        const isFiltered = filterAssigned[filterKey];
        const filteredUsers = isFiltered ? sortedUsers.filter(u => isUserAssigned(assignments, u.id)) : sortedUsers;
        
        const saveScroll = () => {
          if (scrollRef.current) _scrollPositions[scrollKey] = scrollRef.current.scrollTop;
        };
        
        const handleToggle = (userId, checked) => {
          saveScroll();
          toggleUserAssignment(wpId, field, userId, checked, 0);
        };
        
        const handleHoursChange = (userId, value) => {
          saveScroll();
          updateUserHours(wpId, field, userId, parseFloat(value) || 0);
        };
        
        return (
          <div>
            <div className="flex items-center justify-between mb-1">
              <label className="text-xs font-semibold text-gray-600">{label}</label>
              <button onClick={(e) => { e.stopPropagation(); setFilterAssigned(prev => ({ ...prev, [filterKey]: !prev[filterKey] })); }} className={`text-xs px-2 py-0.5 rounded ${isFiltered ? 'bg-indigo-100 text-indigo-700' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}>
                {isFiltered ? 'Alle zeigen' : 'Nur zugewiesene'}
              </button>
            </div>
            <div ref={scrollRef} className="space-y-1 max-h-40 overflow-y-auto border rounded p-2">
              {filteredUsers.length === 0 ? (
                <div className="text-xs text-gray-400 italic">Keine Zuweisungen</div>
              ) : filteredUsers.map(user => {
                const isAssigned = isUserAssigned(assignments, user.id);
                const hours = getUserHours(assignments, user.id);
                return (
                  <div key={user.id} className="flex items-center gap-2 text-xs hover:bg-gray-50 p-1 rounded">
                    <input type="checkbox" checked={isAssigned} onClick={(e) => e.stopPropagation()} onChange={(e) => handleToggle(user.id, e.target.checked)} className="rounded flex-shrink-0" />
                    <span className="flex-1 truncate">{user.name}</span>
                    {isAssigned && (
                      <input 
                        type="number" 
                        min="0" 
                        step="0.5" 
                        key={`${user.id}-${hours}`}
                        defaultValue={hours || ''} 
                        placeholder="0" 
                        onClick={(e) => e.stopPropagation()} 
                        onBlur={(e) => handleHoursChange(user.id, e.target.value)}
                        onKeyDown={(e) => { if (e.key === 'Enter') e.target.blur(); }}
                        className="w-14 px-1 py-0.5 border rounded text-xs text-right" 
                      />
                    )}
                    {isAssigned && <span className="text-gray-400 text-xs">h</span>}
                  </div>
                );
              })}
            </div>
          </div>
        );
      };
      
      const DivisionAssignmentSection = ({ wpId }) => {
        const wp = workPackages.find(w => w.id === wpId);
        const scrollRef = React.useRef(null);
        const scrollKey = `${wpId}-divisions`;
        
        React.useLayoutEffect(() => {
          if (scrollRef.current && _scrollPositions[scrollKey]) {
            scrollRef.current.scrollTop = _scrollPositions[scrollKey];
          }
        });
        
        if (!wp) return null;
        const isFiltered = filterAssigned.divisions;
        const divisionIds = wp.divisionIds || [];
        const filteredDivisions = isFiltered ? sortedDivisions.filter(d => divisionIds.includes(d.id)) : sortedDivisions;
        
        const saveScroll = () => {
          if (scrollRef.current) _scrollPositions[scrollKey] = scrollRef.current.scrollTop;
        };
        
        const handleToggle = (divId, checked) => {
          saveScroll();
          const updated = checked ? [...divisionIds, divId] : divisionIds.filter(id => id !== divId);
          updateWorkPackage(wpId, 'divisionIds', updated);
        };
        
        return (
          <div>
            <div className="flex items-center justify-between mb-1">
              <label className="text-xs font-semibold text-gray-600">Abteilungen</label>
              <button onClick={(e) => { e.stopPropagation(); setFilterAssigned(prev => ({ ...prev, divisions: !prev.divisions })); }} className={`text-xs px-2 py-0.5 rounded ${isFiltered ? 'bg-indigo-100 text-indigo-700' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}>
                {isFiltered ? 'Alle zeigen' : 'Nur zugewiesene'}
              </button>
            </div>
            <div ref={scrollRef} className="space-y-1 max-h-32 overflow-y-auto border rounded p-2">
              {filteredDivisions.length === 0 ? (
                <div className="text-xs text-gray-400 italic">Keine Zuweisungen</div>
              ) : filteredDivisions.map(div => (
                <label key={div.id} className="flex items-center gap-2 text-xs cursor-pointer hover:bg-gray-50 p-1 rounded">
                  <input type="checkbox" checked={divisionIds.includes(div.id)} onClick={(e) => e.stopPropagation()} onChange={(e) => handleToggle(div.id, e.target.checked)} className="rounded" />
                  <span>{div.name}</span>
                </label>
              ))}
            </div>
          </div>
        );
      };
      
      const HEADER_HEIGHT = 76; // Monat + KW + Datum + Wochentag
      
      // Baselines f√ºr aktuelles Projekt
      const currentProjectBaselines = selectedProjectId 
        ? (baselines || []).filter(b => b.projectId === selectedProjectId)
        : [];
      
      return (
        <div className="h-screen bg-gray-50 flex flex-col">
          <div className="bg-white shadow px-4 py-3 flex items-center justify-between flex-shrink-0">
            <div className="flex items-center gap-3">
              <Calendar className="w-6 h-6 text-indigo-600" />
              <h1 className="text-xl font-bold">Projektplanung</h1>
              {selectedFolderId && !selectedProjectId && (
                <React.Fragment>
                  <ChevronRight className="w-4 h-4 text-gray-400" />
                  <span className="text-yellow-500">üìÅ</span>
                  <span className="text-lg font-semibold text-indigo-600">{(projectFolders || []).find(f => f.id === selectedFolderId)?.name}</span>
                  <span className="text-sm text-gray-400 ml-1">({filteredProjects.length} Projekte)</span>
                </React.Fragment>
              )}
              {selectedProjectId && (
                <React.Fragment>
                  <ChevronRight className="w-4 h-4 text-gray-400" />
                  <span className="text-lg font-semibold text-indigo-600">{(projects || []).find(p => p.id === selectedProjectId)?.name}</span>
                </React.Fragment>
              )}
              {!selectedProjectId && !selectedFolderId && <span className="text-sm text-gray-400 ml-2">({(projects || []).length} Projekte)</span>}
            </div>
            <button onClick={() => setShowProjectPlanning(false)} className="p-2 hover:bg-gray-100 rounded-lg"><X className="w-5 h-5" /></button>
          </div>
          
          <div className="bg-white border-b px-2 py-1 flex items-center gap-4 flex-shrink-0">
            {/* Ansicht Dropdown - enth√§lt alles */}
            <div className="relative">
              <button 
                onClick={() => setViewMenuOpen(!viewMenuOpen)}
                className="text-xs px-3 py-1.5 rounded bg-gray-100 text-gray-700 hover:bg-gray-200 flex items-center gap-1.5 font-medium"
              >
                <span>‚öôÔ∏è Ansicht</span>
                <ChevronDown className="w-3 h-3" />
              </button>
              {viewMenuOpen && (
                <div className="absolute left-0 top-full mt-1 bg-white rounded-lg shadow-xl border py-2 min-w-56 z-50" onClick={(e) => e.stopPropagation()}>
                  {/* Anzeige-Optionen */}
                  <div className="px-3 pb-1 text-xs font-semibold text-gray-400 uppercase">Anzeige</div>
                  <label className="flex items-center gap-2 px-3 py-1.5 hover:bg-gray-50 cursor-pointer text-sm">
                    <input type="checkbox" checked={showAssignments} onChange={(e) => setShowAssignments(e.target.checked)} className="rounded" />
                    <Users className="w-3.5 h-3.5 text-indigo-500" />
                    <span>Zuweisungen</span>
                  </label>
                  <label className="flex items-center gap-2 px-3 py-1.5 hover:bg-gray-50 cursor-pointer text-sm">
                    <input type="checkbox" checked={showHours} onChange={(e) => setShowHours(e.target.checked)} className="rounded" />
                    <span>‚è±Ô∏è</span>
                    <span>Stunden</span>
                  </label>
                  <label className="flex items-center gap-2 px-3 py-1.5 hover:bg-gray-50 cursor-pointer text-sm">
                    <input type="checkbox" checked={resizeMode === 'rigid'} onChange={(e) => setResizeMode(e.target.checked ? 'rigid' : 'magnetic')} className="rounded" />
                    <span>üîó</span>
                    <span>Abstand halten</span>
                  </label>
                  
                  {/* Spalten */}
                  <div className="border-t my-2" />
                  <div className="px-3 pb-1 text-xs font-semibold text-gray-400 uppercase">Spalten</div>
                  {[
                    { key: 'start', label: 'Start' },
                    { key: 'end', label: 'Ende' },
                    { key: 'hours', label: 'Plan h' },
                    { key: 'days', label: 'KT' }
                  ].map(col => (
                    <label key={col.key} className="flex items-center gap-2 px-3 py-1.5 hover:bg-gray-50 cursor-pointer text-sm">
                      <input type="checkbox" checked={ganttVisibleColumns[col.key]} onChange={(e) => setGanttVisibleColumns(prev => ({ ...prev, [col.key]: e.target.checked }))} className="rounded" />
                      <span>{col.label}</span>
                    </label>
                  ))}
                  
                  {/* Baselines - nur wenn Projekt ausgew√§hlt */}
                  {selectedProjectId && (
                    <React.Fragment>
                      <div className="border-t my-2" />
                      <div className="px-3 pb-1 text-xs font-semibold text-gray-400 uppercase">Baselines</div>
                      <button 
                        onClick={() => { createBaseline(); }} 
                        className="w-full px-3 py-1.5 text-left text-sm hover:bg-violet-50 flex items-center gap-2"
                      >
                        <Plus className="w-3.5 h-3.5 text-violet-600" />
                        <span>Neue Baseline erstellen</span>
                      </button>
                      {currentProjectBaselines.map(baseline => (
                        <div key={baseline.id} className="px-3 py-1.5 hover:bg-gray-50 flex items-center justify-between">
                          <div className="flex items-center gap-2 flex-1 min-w-0">
                            <button 
                              onClick={() => loadBaseline(baseline.id)}
                              className={`text-xs ${activeBaseline?.id === baseline.id ? 'text-violet-600' : 'text-gray-400'}`}
                            >
                              {activeBaseline?.id === baseline.id ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}
                            </button>
                            <span className="text-sm truncate">{baseline.name}</span>
                          </div>
                          <button onClick={() => deleteBaseline(baseline.id)} className="text-red-400 hover:text-red-600 text-xs ml-2">üóëÔ∏è</button>
                        </div>
                      ))}
                      {currentProjectBaselines.length === 0 && (
                        <div className="px-3 py-1.5 text-xs text-gray-400 italic">Keine Baselines</div>
                      )}
                    </React.Fragment>
                  )}
                </div>
              )}
            </div>
            
            {/* Zoom - separat */}
            <div className="flex items-center gap-2 ml-2">
              <span className="text-xs text-gray-500">Zoom:</span>
              <button onClick={() => setZoomLevel(Math.max(25, zoomLevel - 25))} className="w-6 h-6 rounded bg-gray-100 hover:bg-gray-200 text-gray-600 text-sm">-</button>
              <span className="text-xs w-10 text-center">{zoomLevel * 2}%</span>
              <button onClick={() => setZoomLevel(Math.min(100, zoomLevel + 25))} className="w-6 h-6 rounded bg-gray-100 hover:bg-gray-200 text-gray-600 text-sm">+</button>
            </div>
            
            {/* Aktive Baseline Anzeige */}
            {activeBaseline && selectedProjectId && (
              <span className="text-xs text-violet-600 bg-violet-50 px-2 py-0.5 rounded ml-auto">
                üìå {activeBaseline.name}
              </span>
            )}
          </div>

          
          <div className="flex-1 flex overflow-hidden relative">
            {/* Projekt-Sidebar mit Ordner-Struktur */}
            <div className={`${projectSidebarCollapsed ? 'w-10' : 'w-56'} bg-slate-800 text-white flex flex-col flex-shrink-0 transition-all duration-200 border-r-2 border-slate-600`}>
              <div className="p-2 border-b border-slate-700 flex items-center justify-between bg-slate-900">
                {!projectSidebarCollapsed && <span className="text-xs font-semibold text-slate-400 uppercase tracking-wide">Projekte</span>}
                <button 
                  onClick={() => setProjectSidebarCollapsed(!projectSidebarCollapsed)} 
                  className="p-1 hover:bg-slate-700 rounded text-slate-400 hover:text-white transition-colors"
                >
                  {projectSidebarCollapsed ? <ChevronRight className="w-4 h-4" /> : <ChevronLeft className="w-4 h-4" />}
                </button>
              </div>
              {!projectSidebarCollapsed && (
                <div className="flex-1 overflow-y-auto">
                  {/* Alle Projekte Button */}
                  <button 
                    onClick={() => { setSelectedProjectId(null); setSelectedFolderId(null); setActiveBaseline(null); }}
                    className={`w-full px-3 py-2 text-left text-sm flex items-center gap-2 ${selectedProjectId === null && selectedFolderId === null ? 'bg-indigo-600' : 'hover:bg-slate-700'}`}
                  >
                    <span className="w-3 h-3 rounded bg-gradient-to-br from-indigo-400 to-purple-500" />
                    <span className="truncate">Alle Projekte</span>
                    <span className="text-xs text-slate-400 ml-auto">{(projects || []).length}</span>
                  </button>
                  
                  {/* Ordner mit Projekten - sortiert nach order */}
                  {(projectFolders || []).sort((a, b) => (a.order || 0) - (b.order || 0)).map((folder, folderIdx) => {
                    const folderProjects = (projects || []).filter(p => p.folderId === folder.id);
                    const isCollapsed = collapsedFolders[folder.id];
                    const isDragOver = dragOverFolder === folder.id;
                    const isFolderSelected = selectedFolderId === folder.id && selectedProjectId === null;
                    const isFolderDragOver = draggingFolder && draggingFolder !== folder.id && dragOverFolder === folder.id;
                    
                    return (
                      <div key={folder.id}>
                        {/* Ordner-Header */}
                        <div 
                          draggable
                          onDragStart={(e) => { e.stopPropagation(); setDraggingFolder(folder.id); }}
                          onDragEnd={() => { setDraggingFolder(null); setDragOverFolder(null); }}
                          className={`w-full px-2 py-1.5 text-left text-sm flex items-center gap-1 cursor-pointer ${isFolderSelected ? 'bg-indigo-600' : isFolderDragOver ? 'bg-slate-600 border-t-2 border-indigo-400' : isDragOver && draggingProject ? 'bg-indigo-500' : 'hover:bg-slate-700'} ${draggingFolder === folder.id ? 'opacity-50' : ''}`}
                          onClick={() => { setSelectedFolderId(folder.id); setSelectedProjectId(null); setActiveBaseline(null); setCollapsedFolders(prev => ({ ...prev, [folder.id]: false })); }}
                          onDragOver={(e) => { e.preventDefault(); setDragOverFolder(folder.id); }}
                          onDragLeave={() => setDragOverFolder(null)}
                          onDrop={(e) => {
                            e.preventDefault();
                            setDragOverFolder(null);
                            // Ordner sortieren
                            if (draggingFolder && draggingFolder !== folder.id) {
                              const sorted = (projectFolders || []).sort((a, b) => (a.order || 0) - (b.order || 0));
                              const targetIdx = sorted.findIndex(f => f.id === folder.id);
                              const withoutDragged = sorted.filter(f => f.id !== draggingFolder);
                              const draggedF = sorted.find(f => f.id === draggingFolder);
                              if (draggedF) {
                                withoutDragged.splice(targetIdx, 0, draggedF);
                                const updated = withoutDragged.map((f, i) => ({ ...f, order: i }));
                                saveProjectFolders(updated);
                              }
                              setDraggingFolder(null);
                            }
                            // Projekt in Ordner verschieben
                            if (draggingProject) {
                              const updated = (projects || []).map(p => p.id === draggingProject ? { ...p, folderId: folder.id } : p);
                              saveProjects(updated);
                              setDraggingProject(null);
                            }
                          }}
                        >
                          <button className="p-0.5 hover:bg-slate-600 rounded" onClick={(e) => { e.stopPropagation(); setCollapsedFolders(prev => ({ ...prev, [folder.id]: !prev[folder.id] })); }}>
                            {isCollapsed ? <ChevronRight className="w-3 h-3" /> : <ChevronDown className="w-3 h-3" />}
                          </button>
                          <span className="text-yellow-400">üìÅ</span>
                          {editingFolderId === folder.id ? (
                            <input
                              autoFocus
                              type="text"
                              defaultValue={folder.name}
                              className="flex-1 bg-slate-700 text-white text-sm px-1 rounded border-0 outline-none"
                              onClick={(e) => e.stopPropagation()}
                              onBlur={(e) => {
                                const updated = (projectFolders || []).map(f => f.id === folder.id ? { ...f, name: e.target.value } : f);
                                saveProjectFolders(updated);
                                setEditingFolderId(null);
                              }}
                              onKeyDown={(e) => { if (e.key === 'Enter') e.target.blur(); if (e.key === 'Escape') setEditingFolderId(null); }}
                            />
                          ) : (
                            <span 
                              className="truncate flex-1" 
                              onDoubleClick={(e) => { e.stopPropagation(); setEditingFolderId(folder.id); }}
                            >
                              {folder.name}
                            </span>
                          )}
                          <span className="text-xs text-slate-400">{folderProjects.length}</span>
                          <button 
                            className="p-0.5 hover:bg-red-600 rounded opacity-50 hover:opacity-100"
                            onClick={(e) => { 
                              e.stopPropagation(); 
                              if (confirm('Ordner l√∂schen? Projekte werden nicht gel√∂scht.')) {
                                // Projekte aus Ordner entfernen
                                const updatedProjects = (projects || []).map(p => p.folderId === folder.id ? { ...p, folderId: null } : p);
                                saveProjects(updatedProjects);
                                // Ordner l√∂schen
                                const updatedFolders = (projectFolders || []).filter(f => f.id !== folder.id);
                                saveProjectFolders(updatedFolders);
                                // Falls dieser Ordner ausgew√§hlt war, zur√ºcksetzen
                                if (selectedFolderId === folder.id) setSelectedFolderId(null);
                              }
                            }}
                            title="Ordner l√∂schen"
                          >
                            <Trash2 className="w-3 h-3" />
                          </button>
                        </div>
                        
                        {/* Projekte im Ordner - sortiert nach order */}
                        {!isCollapsed && folderProjects.sort((a, b) => (a.order || 0) - (b.order || 0)).map((project, idx) => {
                          const projectBaselines = (baselines || []).filter(b => b.projectId === project.id);
                          const isDragOver = dragOverProject === project.id;
                          return (
                            <div
                              key={project.id}
                              draggable
                              onDragStart={(e) => { e.stopPropagation(); setDraggingProject(project.id); }}
                              onDragEnd={() => { setDraggingProject(null); setDragOverFolder(null); setDragOverProject(null); }}
                              onDragOver={(e) => { e.preventDefault(); e.stopPropagation(); if (draggingProject && draggingProject !== project.id) setDragOverProject(project.id); }}
                              onDragLeave={() => setDragOverProject(null)}
                              onDrop={(e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                if (draggingProject && draggingProject !== project.id) {
                                  // Projekt in diesen Ordner verschieben und vor diesem Projekt einsortieren
                                  const draggedProj = (projects || []).find(p => p.id === draggingProject);
                                  if (draggedProj) {
                                    let updated = (projects || []).map(p => p.id === draggingProject ? { ...p, folderId: folder.id } : p);
                                    // Neu sortieren innerhalb des Ordners
                                    const inFolder = updated.filter(p => p.folderId === folder.id).sort((a, b) => (a.order || 0) - (b.order || 0));
                                    const targetIdx = inFolder.findIndex(p => p.id === project.id);
                                    const withoutDragged = inFolder.filter(p => p.id !== draggingProject);
                                    withoutDragged.splice(targetIdx, 0, { ...draggedProj, folderId: folder.id });
                                    withoutDragged.forEach((p, i) => { updated = updated.map(pr => pr.id === p.id ? { ...pr, order: i } : pr); });
                                    saveProjects(updated);
                                  }
                                }
                                setDraggingProject(null);
                                setDragOverProject(null);
                              }}
                              onClick={() => { setSelectedProjectId(project.id); setSelectedFolderId(null); setActiveBaseline(null); }}
                              className={`w-full pl-8 pr-3 py-1.5 text-left text-sm flex items-center gap-2 cursor-pointer ${selectedProjectId === project.id ? 'bg-indigo-600' : isDragOver ? 'bg-indigo-500 border-t-2 border-indigo-300' : 'hover:bg-slate-700'} ${draggingProject === project.id ? 'opacity-50' : ''}`}
                            >
                              <span className="w-2.5 h-2.5 rounded flex-shrink-0" style={{ backgroundColor: project.color }} />
                              <span className="truncate flex-1">{project.name}</span>
                              <span className="text-xs text-slate-400">{(workPackages || []).filter(wp => wp.projectId === project.id).length}</span>
                              {projectBaselines.length > 0 && <span className="text-xs">üìå</span>}
                            </div>
                          );
                        })}
                      </div>
                    );
                  })}
                  
                  {/* Ungrupierte Projekte (ohne Ordner) */}
                  {(() => {
                    const ungroupedProjects = (projects || []).filter(p => !p.folderId);
                    if (ungroupedProjects.length === 0 && (projectFolders || []).length > 0) return null;
                    
                    return (
                      <div 
                        className={`${(projectFolders || []).length > 0 ? 'border-t border-slate-700 mt-1 pt-1' : ''}`}
                        onDragOver={(e) => { e.preventDefault(); setDragOverFolder('ungrouped'); }}
                        onDragLeave={() => setDragOverFolder(null)}
                        onDrop={(e) => {
                          e.preventDefault();
                          setDragOverFolder(null);
                          if (draggingProject) {
                            const updated = (projects || []).map(p => p.id === draggingProject ? { ...p, folderId: null } : p);
                            saveProjects(updated);
                            setDraggingProject(null);
                          }
                        }}
                      >
                        {(projectFolders || []).length > 0 && (
                          <div className={`px-3 py-1 text-xs text-slate-500 ${dragOverFolder === 'ungrouped' ? 'bg-indigo-500 text-white' : ''}`}>
                            Ungrupiert
                          </div>
                        )}
                        {ungroupedProjects.sort((a, b) => (a.order || 0) - (b.order || 0)).map((project, idx) => {
                          const projectBaselines = (baselines || []).filter(b => b.projectId === project.id);
                          const isDragOver = dragOverProject === project.id;
                          return (
                            <div
                              key={project.id}
                              draggable
                              onDragStart={(e) => { e.stopPropagation(); setDraggingProject(project.id); }}
                              onDragEnd={() => { setDraggingProject(null); setDragOverFolder(null); setDragOverProject(null); }}
                              onDragOver={(e) => { e.preventDefault(); e.stopPropagation(); if (draggingProject && draggingProject !== project.id) setDragOverProject(project.id); }}
                              onDragLeave={() => setDragOverProject(null)}
                              onDrop={(e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                if (draggingProject && draggingProject !== project.id) {
                                  // Projekt hierhin verschieben (ungrupiert) und vor diesem Projekt einsortieren
                                  const draggedProj = (projects || []).find(p => p.id === draggingProject);
                                  if (draggedProj) {
                                    let updated = (projects || []).map(p => p.id === draggingProject ? { ...p, folderId: null } : p);
                                    // Neu sortieren innerhalb ungrupiert
                                    const inUngrouped = updated.filter(p => !p.folderId).sort((a, b) => (a.order || 0) - (b.order || 0));
                                    const targetIdx = inUngrouped.findIndex(p => p.id === project.id);
                                    const withoutDragged = inUngrouped.filter(p => p.id !== draggingProject);
                                    withoutDragged.splice(targetIdx, 0, { ...draggedProj, folderId: null });
                                    withoutDragged.forEach((p, i) => { updated = updated.map(pr => pr.id === p.id ? { ...pr, order: i } : pr); });
                                    saveProjects(updated);
                                  }
                                }
                                setDraggingProject(null);
                                setDragOverProject(null);
                              }}
                              onClick={() => { setSelectedProjectId(project.id); setSelectedFolderId(null); setActiveBaseline(null); }}
                              className={`w-full px-3 py-1.5 text-left text-sm flex items-center gap-2 cursor-pointer ${selectedProjectId === project.id ? 'bg-indigo-600' : isDragOver ? 'bg-indigo-500 border-t-2 border-indigo-300' : 'hover:bg-slate-700'} ${draggingProject === project.id ? 'opacity-50' : ''}`}
                            >
                              <span className="w-3 h-3 rounded flex-shrink-0" style={{ backgroundColor: project.color }} />
                              <span className="truncate flex-1">{project.name}</span>
                              <span className="text-xs text-slate-400">{(workPackages || []).filter(wp => wp.projectId === project.id).length}</span>
                              {projectBaselines.length > 0 && <span className="text-xs">üìå</span>}
                            </div>
                          );
                        })}
                      </div>
                    );
                  })()}
                </div>
              )}
              {!projectSidebarCollapsed && (
                <div className="p-2 border-t border-slate-700 space-y-1">
                  {/* Neuer Ordner Button */}
                  <button 
                    onClick={() => { 
                      const newFolder = { 
                        id: `folder_${Date.now()}`, 
                        name: `Neuer Ordner`, 
                        order: (projectFolders || []).length 
                      };
                      const newFolders = [...(projectFolders || []), newFolder];
                      saveProjectFolders(newFolders);
                      setEditingFolderId(newFolder.id);
                    }}
                    className="w-full px-3 py-1.5 text-left text-sm flex items-center gap-2 hover:bg-slate-700 rounded text-slate-300"
                  >
                    <span className="text-yellow-400">üìÅ</span>
                    <Plus className="w-3 h-3" />
                    <span>Neuer Ordner</span>
                  </button>
                  {/* Neues Projekt Button */}
                  <button 
                    onClick={() => { 
                      const colors = ['#6366f1', '#8b5cf6', '#ec4899', '#f43f5e', '#f97316', '#eab308', '#22c55e', '#14b8a6', '#0ea5e9'];
                      const newColor = colors[(projects || []).length % colors.length];
                      const newProject = { id: `proj_${Date.now()}`, name: `Neues Projekt ${(projects || []).length + 1}`, color: newColor, folderId: null };
                      const newProjects = [...(projects || []), newProject];
                      setProjects(newProjects);
                      saveProjects(newProjects);
                      setSelectedProjectId(newProject.id);
                    }}
                    className="w-full px-3 py-1.5 text-left text-sm flex items-center gap-2 hover:bg-slate-700 rounded text-slate-300"
                  >
                    <Plus className="w-4 h-4" />
                    <span>Neues Projekt</span>
                  </button>
                </div>
              )}
            </div>
            
            {/* Hauptinhalt */}
            <div className="flex-1 flex flex-col overflow-hidden relative">
            {/* Detail-Sidebar - f√ºr Einzel- und Multi-Select - schwebt √ºber Gantt */}
            {(sidebarWP || selectedWPs.length > 0) && (
              <div 
                className={`absolute top-0 bottom-0 bg-white/95 backdrop-blur-sm border-r shadow-2xl flex flex-col z-40 transition-all duration-200 ${detailsCollapsed ? 'w-8' : 'w-72'}`}
                style={{ left: leftPanelWidth }}
                onClick={(e) => e.stopPropagation()}
              >
                {detailsCollapsed ? (
                  /* Eingeklappter Zustand - nur schmaler Streifen */
                  <div className="flex-1 flex flex-col items-center py-2 bg-indigo-600/90">
                    <button 
                      onClick={() => setDetailsCollapsed(false)}
                      className="p-1.5 text-white hover:bg-white/20 rounded"
                      title="Details einblenden"
                    >
                      <ChevronRight className="w-4 h-4" />
                    </button>
                    <div className="flex-1 flex items-center justify-center">
                      <span className="text-white text-xs font-bold writing-mode-vertical" style={{ writingMode: 'vertical-rl', textOrientation: 'mixed' }}>
                        {selectedWPs.length > 0 ? `${selectedWPs.length} ausgew√§hlt` : 'Details'}
                      </span>
                    </div>
                  </div>
                ) : (
                  /* Ausgeklappter Zustand */
                  <React.Fragment>
                    {/* Header */}
                    <div className={`p-2 border-b flex items-center justify-between ${selectedWPs.length > 0 ? 'bg-indigo-600 text-white' : 'bg-indigo-50'}`}>
                      <div className="flex items-center gap-2 min-w-0 flex-1">
                        {selectedWPs.length > 0 ? (
                          <React.Fragment>
                            <span className="bg-white text-indigo-600 text-xs font-bold px-1.5 py-0.5 rounded-full">{selectedWPs.length}</span>
                            <span className="text-sm font-medium">ausgew√§hlt</span>
                          </React.Fragment>
                        ) : (
                          <h3 className="font-bold text-sm truncate">{sidebarWP?.name}</h3>
                        )}
                      </div>
                      <div className="flex items-center gap-0.5 flex-shrink-0">
                        {/* Einr√ºcken/Ausr√ºcken Buttons */}
                        {selectedWPs.length > 0 && (
                          <React.Fragment>
                            <button onClick={bulkOutdent} className="p-1 hover:bg-white/20 rounded" title="Ausr√ºcken"><ChevronLeft className="w-4 h-4" /></button>
                            <button onClick={bulkIndent} className="p-1 hover:bg-white/20 rounded" title="Einr√ºcken"><ChevronRight className="w-4 h-4" /></button>
                          </React.Fragment>
                        )}
                        {sidebarWP && selectedWPs.length === 0 && (
                          <React.Fragment>
                            <button onClick={() => outdentWorkPackage(sidebarWP.id)} className="p-1 hover:bg-indigo-100 rounded text-indigo-600" title="Ausr√ºcken"><ChevronLeft className="w-4 h-4" /></button>
                            <button onClick={() => indentWorkPackage(sidebarWP.id)} className="p-1 hover:bg-indigo-100 rounded text-indigo-600" title="Einr√ºcken"><ChevronRight className="w-4 h-4" /></button>
                          </React.Fragment>
                        )}
                        <div className={`w-px h-4 mx-0.5 ${selectedWPs.length > 0 ? 'bg-white/30' : 'bg-gray-300'}`} />
                        <button onClick={() => setDetailsCollapsed(true)} className={`p-1 rounded ${selectedWPs.length > 0 ? 'hover:bg-white/20' : 'hover:bg-indigo-100'}`} title="Einklappen"><ChevronLeft className="w-4 h-4" /></button>
                        <button onClick={(e) => { e.stopPropagation(); setSelectedWPs([]); setSidebarWPId(null); }} className={`p-1 rounded ${selectedWPs.length > 0 ? 'hover:bg-white/20' : 'hover:bg-indigo-100'}`} title="Schlie√üen"><X className="w-4 h-4" /></button>
                      </div>
                    </div>
                    
                    {/* Farben - kompakt */}
                    <div className="px-2 py-1.5 border-b bg-gray-50/80 flex items-center gap-1">
                      {wpColors.map(color => (
                        <button 
                          key={color}
                          onClick={() => selectedWPs.length > 0 ? bulkSetColor(color) : updateWorkPackage(sidebarWP.id, 'color', color)}
                          className="w-4 h-4 rounded border border-transparent hover:border-gray-400 hover:scale-125 transition-all"
                          style={{ backgroundColor: color }}
                        />
                      ))}
                      <button 
                        onClick={() => selectedWPs.length > 0 ? bulkSetColor(null) : updateWorkPackage(sidebarWP.id, 'color', null)}
                        className="w-4 h-4 rounded border border-gray-300 hover:border-gray-400 flex items-center justify-center text-gray-400"
                        style={{ fontSize: 8 }}
                      >
                        ‚úï
                      </button>
                    </div>
                    
                    {/* Multi-Select: Nur L√∂schen-Button */}
                    {selectedWPs.length > 0 && (
                      <div className="p-2">
                        <button 
                          onClick={bulkDelete}
                          className="w-full flex items-center justify-center gap-2 px-2 py-1.5 bg-red-50 hover:bg-red-100 text-red-600 rounded text-xs font-medium transition-colors"
                        >
                          <Trash2 className="w-3 h-3" />
                          L√∂schen
                        </button>
                      </div>
                    )}
                {/* Einzel-Auswahl: Alle Details */}
                {sidebarWP && selectedWPs.length === 0 && (
                <div className="flex-1 overflow-y-auto p-2 space-y-3">
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="text-xs font-semibold text-gray-600 block mb-1">Planstunden</label>
                      {getChildren(sidebarWP.id, workPackages).length > 0 ? (
                        <div className="text-sm text-gray-500 italic">{calculateTotalHours(sidebarWP.id)}h</div>
                      ) : (
                        <div className="flex items-center gap-1">
                          <input 
                            type="number" 
                            min="0" 
                            step="0.5" 
                            key={`plan-${sidebarWP.id}-${sidebarWP.plannedHours}`}
                            defaultValue={sidebarWP.plannedHours || 0} 
                            onClick={(e) => e.stopPropagation()} 
                            onBlur={(e) => updateWorkPackage(sidebarWP.id, 'plannedHours', parseFloat(e.target.value) || 0)}
                            onKeyDown={(e) => { if (e.key === 'Enter') e.target.blur(); }}
                            className="w-16 px-2 py-1 border rounded text-sm" 
                          />
                          <span className="text-xs text-gray-500">h</span>
                        </div>
                      )}
                    </div>
                    <div>
                      <label className="text-xs font-semibold text-gray-600 block mb-1">Zugewiesen</label>
                      <div className="text-sm font-medium" style={{ color: calculateAssignedHours(sidebarWP) > (sidebarWP.plannedHours || 0) ? '#ef4444' : calculateAssignedHours(sidebarWP) === (sidebarWP.plannedHours || 0) ? '#22c55e' : '#6b7280' }}>
                        {calculateAssignedHours(sidebarWP)}h
                        {sidebarWP.plannedHours > 0 && (
                          <span className="text-xs text-gray-400 ml-1">
                            ({(sidebarWP.plannedHours || 0) - calculateAssignedHours(sidebarWP) >= 0 
                              ? `+${(sidebarWP.plannedHours || 0) - calculateAssignedHours(sidebarWP)}h offen`
                              : `${(sidebarWP.plannedHours || 0) - calculateAssignedHours(sidebarWP)}h √ºberplant`})
                          </span>
                        )}
                      </div>
                    </div>
                  </div>
                  <div>
                    <label className="text-xs font-semibold text-gray-600 block mb-1">Zeitraum</label>
                    {getChildren(sidebarWP.id, workPackages).length > 0 ? (
                      <div className="text-sm text-gray-500 italic">{(() => { const dates = calculateDatesFromChildren(sidebarWP.id, workPackages); return dates ? `${new Date(dates.startDate).toLocaleDateString('de-DE')} - ${new Date(dates.endDate).toLocaleDateString('de-DE')}` : '-'; })()}<span className="block text-xs">(aus Unterpaketen)</span></div>
                    ) : (
                      <div className="grid grid-cols-2 gap-2">
                        <div><label className="text-xs text-gray-500">Start</label><input type="date" value={sidebarWP.startDate || ''} onClick={(e) => e.stopPropagation()} onChange={(e) => updateWorkPackage(sidebarWP.id, 'startDate', e.target.value)} className="w-full px-2 py-1 border rounded text-xs" /></div>
                        <div><label className="text-xs text-gray-500">Ende</label><input type="date" value={sidebarWP.endDate || ''} onClick={(e) => e.stopPropagation()} onChange={(e) => updateWorkPackage(sidebarWP.id, 'endDate', e.target.value)} className="w-full px-2 py-1 border rounded text-xs" /></div>
                      </div>
                    )}
                  </div>
                  <div>
                    <label className="flex items-center gap-2 text-xs cursor-pointer">
                      <input 
                        type="checkbox" 
                        checked={sidebarWP.allowWeekend || false} 
                        onChange={(e) => updateWorkPackage(sidebarWP.id, 'allowWeekend', e.target.checked)}
                        className="rounded"
                      />
                      <span className="font-semibold text-gray-600">üóìÔ∏è Wochenendarbeit erlaubt</span>
                    </label>
                    <p className="text-xs text-gray-400 mt-1">Wenn deaktiviert, werden Sa/So bei Verschiebungen √ºbersprungen</p>
                  </div>
                  <UserAssignmentSection wpId={sidebarWP.id} field="responsibles" label="Verantwortliche" filterKey="responsibles" />
                  <UserAssignmentSection wpId={sidebarWP.id} field="editors" label="Bearbeiter" filterKey="editors" />
                  <DivisionAssignmentSection wpId={sidebarWP.id} />
                  <div>
                    <label className="text-xs font-semibold text-gray-600 block mb-1">Abh√§ngigkeiten</label>
                    <div className="space-y-1">
                      {dependencies.filter(d => d.fromId === sidebarWP.id || d.toId === sidebarWP.id).map(dep => {
                        const isFrom = dep.fromId === sidebarWP.id;
                        const otherWP = workPackages.find(w => w.id === (isFrom ? dep.toId : dep.fromId));
                        return otherWP ? (
                          <div key={dep.id} className="flex items-center justify-between text-xs bg-gray-50 p-2 rounded">
                            <span>{isFrom ? '\u2192' : '\u2190'} {otherWP.name}</span>
                            <button onClick={(e) => { e.stopPropagation(); deleteDependency(dep.id); }} className="text-red-500 hover:text-red-700"><X className="w-3 h-3" /></button>
                          </div>
                        ) : null;
                      })}
                      {dependencies.filter(d => d.fromId === sidebarWP.id || d.toId === sidebarWP.id).length === 0 && <div className="text-xs text-gray-400 italic">Keine Abh√§ngigkeiten</div>}
                    </div>
                  </div>
                </div>
                )}
                  </React.Fragment>
                )}
              </div>
            )}
            
              {/* Header mit Monat, KW, Datum, Wochentag */}
              <div className="flex flex-shrink-0 bg-white border-b z-10">
                <div className="flex-shrink-0 bg-gray-100 relative" style={{ height: HEADER_HEIGHT, width: leftPanelWidth }}>
                  <div className="flex h-full items-end pb-2 text-xs font-semibold text-gray-600">
                    <div className="flex-1 px-2 border-r border-gray-300" style={{ minWidth: 100 }}>Arbeitspaket</div>
                    {ganttVisibleColumns.start && (
                      <div className="relative text-center border-r border-gray-300 flex-shrink-0 select-none" style={{ width: columnWidths.start }}>
                        Start
                        <div className="absolute right-0 top-0 bottom-0 w-2 cursor-col-resize bg-transparent hover:bg-indigo-400 z-20" style={{ transform: 'translateX(50%)' }} onMouseDown={(e) => { e.preventDefault(); e.stopPropagation(); setResizingColumn({ key: 'start', startX: e.clientX, startWidth: columnWidths.start }); }} />
                      </div>
                    )}
                    {ganttVisibleColumns.end && (
                      <div className="relative text-center border-r border-gray-300 flex-shrink-0 select-none" style={{ width: columnWidths.end }}>
                        Ende
                        <div className="absolute right-0 top-0 bottom-0 w-2 cursor-col-resize bg-transparent hover:bg-indigo-400 z-20" style={{ transform: 'translateX(50%)' }} onMouseDown={(e) => { e.preventDefault(); e.stopPropagation(); setResizingColumn({ key: 'end', startX: e.clientX, startWidth: columnWidths.end }); }} />
                      </div>
                    )}
                    {ganttVisibleColumns.hours && (
                      <div className="relative text-center border-r border-gray-300 flex-shrink-0 select-none" style={{ width: columnWidths.hours }}>
                        Plan h
                        <div className="absolute right-0 top-0 bottom-0 w-2 cursor-col-resize bg-transparent hover:bg-indigo-400 z-20" style={{ transform: 'translateX(50%)' }} onMouseDown={(e) => { e.preventDefault(); e.stopPropagation(); setResizingColumn({ key: 'hours', startX: e.clientX, startWidth: columnWidths.hours }); }} />
                      </div>
                    )}
                    {ganttVisibleColumns.days && (
                      <div className="relative text-center flex-shrink-0 select-none" style={{ width: columnWidths.days }}>
                        KT
                        <div className="absolute right-0 top-0 bottom-0 w-2 cursor-col-resize bg-transparent hover:bg-indigo-400 z-20" style={{ transform: 'translateX(50%)' }} onMouseDown={(e) => { e.preventDefault(); e.stopPropagation(); setResizingColumn({ key: 'days', startX: e.clientX, startWidth: columnWidths.days }); }} />
                      </div>
                    )}
                  </div>
                  {/* Resize Handle f√ºr die gesamte Liste - am rechten Rand */}
                  <div 
                    className="absolute right-0 top-0 bottom-0 w-3 cursor-col-resize bg-gray-300 hover:bg-indigo-500 active:bg-indigo-600 z-30 transition-colors"
                    onMouseDown={(e) => { e.preventDefault(); e.stopPropagation(); setIsResizingPanel(true); }}
                    title="Liste verbreitern/verkleinern"
                  />
                </div>
                <div 
                  ref={headerScrollRef}
                  className="flex-1 overflow-x-auto overflow-y-hidden hide-scrollbar"
                  onScroll={(e) => {
                    // Synchronisiere mit ganttHScrollRef
                    if (ganttHScrollRef.current && ganttHScrollRef.current.scrollLeft !== e.target.scrollLeft) {
                      ganttHScrollRef.current.scrollLeft = e.target.scrollLeft;
                    }
                  }}
                >
                  <div className="flex flex-col" style={{ minWidth: WEEKS_TO_SHOW * 7 * DAY_WIDTH }}>
                    {/* Monat Header */}
                    <div className="flex border-b bg-gray-50">
                      {monthHeaders.map((m, i) => (
                        <div key={i} style={{ width: m.weeks * 7 * DAY_WIDTH }} className="text-xs font-semibold text-center py-1 text-gray-700 border-r">{m.name}</div>
                      ))}
                    </div>
                    {/* KW + Datum + Wochentag */}
                    <div className="flex flex-1">
                      {weekNumbers.map(weekNum => {
                        const weekDates = getWeekDates(weekNum, new Date().getFullYear());
                        return (
                          <div key={weekNum} style={{ width: 7 * DAY_WIDTH }} className="flex-shrink-0 flex flex-col border-r">
                            <div className="text-xs font-semibold text-center bg-indigo-50 py-0.5 border-b" style={{ fontSize: zoomLevel < 75 ? 9 : 11 }}>KW {weekNum}</div>
                            <div className="flex border-b">
                              {weekDates.map((date, i) => {
                                const dateStr = formatDate(date);
                                const holiday = holidays[dateStr];
                                return (
                                  <div 
                                    key={i} 
                                    style={{ width: DAY_WIDTH }} 
                                    className={`text-center border-r border-gray-200 cursor-pointer ${holiday ? 'bg-red-200' : i >= 5 ? 'bg-gray-200' : 'bg-gray-50'}`}
                                    onContextMenu={(e) => { e.preventDefault(); setDayContextMenu({ x: e.clientX, y: e.clientY, date: dateStr }); }}
                                    title={holiday ? `${holiday.name} (${holiday.type === 'feiertag' ? 'Feiertag' : holiday.type === 'urlaub' ? 'Urlaub' : holiday.type === 'betriebsferien' ? 'Betriebsferien' : 'Frei'})` : ''}
                                  >
                                    <div className={`text-xs ${holiday ? 'text-red-700 font-semibold' : 'text-gray-500'}`} style={{ fontSize: zoomLevel < 75 ? 8 : 10 }}>{date.getDate()}</div>
                                  </div>
                                );
                              })}
                            </div>
                            <div className="flex flex-1">
                              {weekDates.map((date, i) => { 
                                const dateStr = formatDate(date);
                                const holiday = holidays[dateStr];
                                const isWeekend = i >= 5; 
                                const isToday = dateStr === formatDate(new Date()); 
                                return (
                                  <div 
                                    key={i} 
                                    style={{ width: DAY_WIDTH }} 
                                    className={`text-center py-0.5 border-r border-gray-200 flex items-center justify-center cursor-pointer ${holiday ? 'bg-red-300' : isWeekend ? 'bg-gray-300' : ''} ${isToday ? 'bg-indigo-200 font-bold' : ''}`}
                                    onContextMenu={(e) => { e.preventDefault(); setDayContextMenu({ x: e.clientX, y: e.clientY, date: dateStr }); }}
                                    title={holiday ? `${holiday.name} (${holiday.type === 'feiertag' ? 'Feiertag' : holiday.type === 'urlaub' ? 'Urlaub' : holiday.type === 'betriebsferien' ? 'Betriebsferien' : 'Frei'})` : ''}
                                  >
                                    <span className={holiday ? 'text-red-700' : ''} style={{ fontSize: zoomLevel < 75 ? 8 : 10 }}>{['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'][i]}</span>
                                  </div>
                                ); 
                              })}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                </div>
              </div>
              
              <div ref={ganttScrollRef} className="flex-1 overflow-y-auto overflow-x-hidden" style={{ scrollbarGutter: 'stable', overflowAnchor: 'none' }}>
                <div className="flex" style={{ overflowAnchor: 'none' }}>
                  <div className="flex-shrink-0 bg-white border-r relative" style={{ width: leftPanelWidth, overflowAnchor: 'none' }}>
                    {/* Resize Handle f√ºr die gesamte Liste */}
                    <div 
                      className="absolute right-0 top-0 bottom-0 w-3 cursor-col-resize bg-gray-300 hover:bg-indigo-500 active:bg-indigo-600 z-30 transition-colors"
                      onMouseDown={(e) => { e.preventDefault(); e.stopPropagation(); setIsResizingPanel(true); }}
                      title="Liste verbreitern/verkleinern"
                    />
                    {allProjectsData.map(({ project, flatList }) => (
                      <div key={project.id}>
                        <div className="bg-gray-50 flex items-center justify-between cursor-pointer hover:bg-gray-100 border-b" style={{ height: ROW_HEIGHT }} onContextMenu={(e) => { e.preventDefault(); setContextMenu({ x: e.clientX, y: e.clientY, type: 'project', project }); }}>
                          <div className="flex items-center gap-2 px-2 border-r border-gray-200 flex-1"><div className="w-3 h-3 rounded" style={{ backgroundColor: project.color }} /><span className="font-semibold text-sm">{project.name}</span><span className="text-xs text-gray-400">({flatList.length})</span></div>
                          <button onClick={() => addWorkPackage(project.id)} className="p-1 hover:bg-indigo-100 rounded text-indigo-600 mr-2"><Plus className="w-4 h-4" /></button>
                        </div>
                        {flatList.map((wp, wpIndex) => {
                          const hasChildren = getChildren(wp.id, workPackages).length > 0;
                          const isExpanded = expandedPackages[wp.id] !== false;
                          const calcDates = hasChildren ? calculateDatesFromChildren(wp.id, workPackages) : null;
                          const isResizingThis = resizingWP?.wp.id === wp.id;
                          const isDraggingThis = draggedWP?.wp.id === wp.id && !draggedWP.isSummary;
                          let displayStart = calcDates?.startDate || wp.startDate;
                          let displayEnd = calcDates?.endDate || wp.endDate;
                          // Zeige Preview w√§hrend Resizing/Dragging
                          if (isResizingThis && resizingWP.side === 'left' && resizingWP.previewStart) {
                            displayStart = resizingWP.previewStart;
                          } else if (isResizingThis && resizingWP.previewEnd) {
                            displayEnd = resizingWP.previewEnd;
                          } else if (isDraggingThis && draggedWP.previewStart) {
                            displayStart = draggedWP.previewStart;
                            displayEnd = draggedWP.previewEnd;
                          }
                          const days = displayStart && displayEnd ? Math.ceil((new Date(displayEnd) - new Date(displayStart)) / (1000 * 60 * 60 * 24)) + 1 : '-';
                          const isBeingDragged = rowDragWP?.id === wp.id;
                          const isDropBefore = dropTarget?.wpId === wp.id && dropTarget?.position === 'before';
                          const isDropAfter = dropTarget?.wpId === wp.id && dropTarget?.position === 'after';
                          const isDropChild = dropTarget?.wpId === wp.id && dropTarget?.position === 'child';
                          
                          return (
                            <div key={wp.id} className="relative">
                              {/* Drop-Indikator oben */}
                              {isDropBefore && <div className="absolute top-0 left-0 right-0 h-0.5 bg-indigo-500 z-10" />}
                              
                              <div 
                                className={`flex border-b border-gray-100 hover:bg-blue-50 items-center text-xs group cursor-pointer ${selectedWPs.includes(wp.id) ? 'bg-indigo-100 ring-2 ring-indigo-400' : selectedWP?.id === wp.id ? 'bg-indigo-50 ring-1 ring-indigo-300' : ''} ${isBeingDragged ? 'opacity-50 bg-gray-200' : ''} ${isDropChild ? 'bg-indigo-100 ring-2 ring-indigo-400' : ''}`} 
                                style={{ height: ROW_HEIGHT }} 
                                onClick={(e) => handleWPClick(e, wp, flatList)} 
                                onContextMenu={(e) => { e.preventDefault(); setContextMenu({ x: e.clientX, y: e.clientY, type: 'wp', wp, project }); }}
                                onMouseEnter={() => {
                                  if (rowDragWP && rowDragWP.id !== wp.id) {
                                    // Berechne ob wir im oberen, unteren oder mittleren Bereich sind
                                    setDropTarget({ wpId: wp.id, position: 'after' });
                                  }
                                }}
                                onMouseMove={(e) => {
                                  if (rowDragWP && rowDragWP.id !== wp.id) {
                                    const rect = e.currentTarget.getBoundingClientRect();
                                    const y = e.clientY - rect.top;
                                    const third = rect.height / 3;
                                    if (y < third) {
                                      setDropTarget({ wpId: wp.id, position: 'before' });
                                    } else if (y > third * 2) {
                                      setDropTarget({ wpId: wp.id, position: 'after' });
                                    } else {
                                      setDropTarget({ wpId: wp.id, position: 'child' });
                                    }
                                  }
                                }}
                                onMouseLeave={() => {
                                  if (rowDragWP && dropTarget?.wpId === wp.id) {
                                    setDropTarget(null);
                                  }
                                }}
                              >
                                <div className="flex-1 flex items-center gap-1 min-w-0 border-r border-gray-200 h-full" style={{ paddingLeft: 4 + wp._level * 20, minWidth: 120 }}>
                                  {/* Drag Handle */}
                                  <div 
                                    className="cursor-grab opacity-0 group-hover:opacity-50 hover:opacity-100 px-0.5 flex-shrink-0"
                                    onMouseDown={(e) => { e.stopPropagation(); e.preventDefault(); setRowDragWP(wp); }}
                                  >
                                    <GripVertical className="w-3 h-3 text-gray-400" />
                                  </div>
                                  {hasChildren ? <button onClick={(e) => { e.stopPropagation(); toggleExpand(wp.id); }} className="p-0.5 hover:bg-gray-200 rounded">{isExpanded ? <ChevronDown className="w-3 h-3" /> : <ChevronRight className="w-3 h-3" />}</button> : <span className="w-4" />}
                                  <div className="w-2 h-2 rounded-sm flex-shrink-0" style={{ backgroundColor: wp.color || project.color }} />
                                  {editingName === wp.id ? <input autoFocus type="text" defaultValue={wp.name} className="flex-1 min-w-0 px-1 border rounded text-xs" onClick={(e) => e.stopPropagation()} onBlur={(e) => { const updated = workPackages.map(w => w.id === wp.id ? { ...w, name: e.target.value } : w); saveWorkPackages(updated); setEditingName(null); }} onKeyDown={(e) => { if (e.key === 'Enter') e.target.blur(); if (e.key === 'Escape') setEditingName(null); }} /> : <span className="truncate cursor-text" onDoubleClick={(e) => { e.stopPropagation(); setEditingName(wp.id); }}>{wp.name}</span>}
                                </div>
                                {ganttVisibleColumns.start && <div className="text-center border-r border-gray-200 h-full flex items-center justify-center flex-shrink-0 overflow-hidden relative" style={{ width: columnWidths.start }}>{hasChildren ? <span className="text-gray-400 italic text-xs">auto</span> : <React.Fragment><span className="text-xs cursor-pointer hover:text-indigo-600" style={{ fontSize: 9 }} onClick={(e) => { e.stopPropagation(); const input = e.currentTarget.nextSibling; input.style.opacity = '1'; input.style.position = 'relative'; input.style.width = '100%'; input.focus(); }}>{formatDateShort(wp.startDate) || '-'}</span><input type="date" value={wp.startDate || ''} onChange={(e) => { const updated = workPackages.map(w => w.id === wp.id ? { ...w, startDate: e.target.value } : w); saveWorkPackages(updated); }} onBlur={(e) => { e.target.style.opacity = '0'; e.target.style.position = 'absolute'; e.target.style.width = '0'; }} className="absolute opacity-0 w-0 h-0 text-xs" style={{ fontSize: 9 }} /></React.Fragment>}</div>}
                                {ganttVisibleColumns.end && <div className="text-center border-r border-gray-200 h-full flex items-center justify-center flex-shrink-0 overflow-hidden relative" style={{ width: columnWidths.end }}>{hasChildren ? <span className="text-gray-400 italic text-xs">auto</span> : <React.Fragment><span className="text-xs cursor-pointer hover:text-indigo-600" style={{ fontSize: 9 }} onClick={(e) => { e.stopPropagation(); const input = e.currentTarget.nextSibling; input.style.opacity = '1'; input.style.position = 'relative'; input.style.width = '100%'; input.focus(); }}>{formatDateShort(wp.endDate) || '-'}</span><input type="date" value={wp.endDate || ''} onChange={(e) => { const updated = workPackages.map(w => w.id === wp.id ? { ...w, endDate: e.target.value } : w); saveWorkPackages(updated); }} onBlur={(e) => { e.target.style.opacity = '0'; e.target.style.position = 'absolute'; e.target.style.width = '0'; }} className="absolute opacity-0 w-0 h-0 text-xs" style={{ fontSize: 9 }} /></React.Fragment>}</div>}
                                {ganttVisibleColumns.hours && <div className="text-center text-gray-500 font-medium border-r border-gray-200 h-full flex items-center justify-center flex-shrink-0" style={{ width: columnWidths.hours, fontSize: 10 }}>{calculateTotalHours(wp.id) ? `${calculateTotalHours(wp.id)}h` : '-'}</div>}
                                {ganttVisibleColumns.days && <div className="text-center text-gray-500 h-full flex items-center justify-center flex-shrink-0" style={{ width: columnWidths.days }}>{days}</div>}
                              </div>
                              
                              {/* Drop-Indikator unten */}
                              {isDropAfter && <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-indigo-500 z-10" />}
                            </div>
                          );
                        })}
                        {flatList.length === 0 && <div className="px-4 text-xs text-gray-400 italic border-b flex items-center" style={{ height: ROW_HEIGHT }}>Keine Arbeitspakete</div>}
                      </div>
                    ))}
                  </div>
                  
                  <div 
                    ref={ganttHScrollRef} 
                    className="flex-1 overflow-x-auto" 
                    style={{ overflowAnchor: 'none' }}
                    onScroll={(e) => {
                      // Synchronisiere mit headerScrollRef
                      if (headerScrollRef.current && headerScrollRef.current.scrollLeft !== e.target.scrollLeft) {
                        headerScrollRef.current.scrollLeft = e.target.scrollLeft;
                      }
                    }}
                  >
                    <div className="min-w-max relative">
                      {allProjectsData.map(({ project, flatList }) => (
                        <div key={project.id}>
                          <div className="flex items-center bg-gray-50 border-b" style={{ height: ROW_HEIGHT }}>
                            <div className="font-semibold text-sm px-2 flex items-center gap-2" style={{ minWidth: WEEKS_TO_SHOW * 7 * DAY_WIDTH }}>
                              <div className="w-3 h-3 rounded" style={{ backgroundColor: project.color }} />{project.name}
                            </div>
                          </div>
                          {flatList.map(wp => {
                            const hasChildren = getChildren(wp.id, workPackages).length > 0;
                            const isExpanded = expandedPackages[wp.id] !== false;
                            const calcDates = hasChildren ? calculateDatesFromChildren(wp.id, workPackages) : null;
                            const isDragging = draggedWP?.wp.id === wp.id;
                            const isResizing = resizingWP?.wp.id === wp.id;
                            const hasPreview = previewPositions[wp.id]; // Live-Preview f√ºr abh√§ngige Balken
                            let displayStart, displayEnd;
                            if (isDragging && !draggedWP.isSummary) {
                              displayStart = draggedWP.previewStart;
                              displayEnd = draggedWP.previewEnd;
                            } else if (isResizing) {
                              if (resizingWP.side === 'left' && resizingWP.previewStart) {
                                displayStart = resizingWP.previewStart;
                                displayEnd = calcDates?.endDate || wp.endDate;
                              } else {
                                displayStart = calcDates?.startDate || wp.startDate;
                                displayEnd = resizingWP.previewEnd || (calcDates?.endDate || wp.endDate);
                              }
                            } else if (hasPreview) {
                              // Zeige Preview-Position f√ºr abh√§ngige Balken
                              displayStart = hasPreview.startDate;
                              displayEnd = hasPreview.endDate;
                            } else {
                              displayStart = calcDates?.startDate || wp.startDate;
                              displayEnd = calcDates?.endDate || wp.endDate;
                            }
                            
                            const bgStyle = {
                              height: ROW_HEIGHT, 
                              minWidth: WEEKS_TO_SHOW * 7 * DAY_WIDTH,
                              backgroundImage: `
                                repeating-linear-gradient(90deg, 
                                  transparent 0, transparent ${DAY_WIDTH - 1}px, 
                                  #e5e7eb ${DAY_WIDTH - 1}px, #e5e7eb ${DAY_WIDTH}px
                                ),
                                repeating-linear-gradient(90deg, 
                                  transparent 0, transparent ${DAY_WIDTH * 5}px, 
                                  #d1d5db ${DAY_WIDTH * 5}px, #d1d5db ${DAY_WIDTH * 7}px
                                )
                              `
                            };
                            
                            if (!displayStart || !displayEnd) return <div key={wp.id} className="border-b border-gray-100" style={bgStyle} />;
                            const x = dateToX(displayStart);
                            const endX = dateToX(displayEnd);
                            const width = endX - x + DAY_WIDTH;
                            const color = wp.color || project.color;
                            const isPreview = !!hasPreview || isDragging || isResizing;
                            const hasOriginal = originalPositions[wp.id]; // F√ºr violetten Schatten bei Drag
                            
                            // Baseline-Position finden
                            const baselineWP = activeBaseline?.workPackages.find(bwp => bwp.id === wp.id);
                            
                            // Violetter Schatten f√ºr Original-Position (beim Drag) oder Baseline
                            let shadowElement = null;
                            if (hasOriginal && (hasPreview || isDragging || isResizing)) {
                              // Drag-Preview Schatten
                              const origX = dateToX(hasOriginal.startDate);
                              const origEndX = dateToX(hasOriginal.endDate);
                              const origWidth = origEndX - origX + DAY_WIDTH;
                              shadowElement = (
                                <div 
                                  className="absolute rounded opacity-30 pointer-events-none"
                                  style={{ 
                                    left: origX, 
                                    width: origWidth, 
                                    top: hasChildren ? 4 : (wp._level > 0 ? 6 : 4), 
                                    height: hasChildren ? ROW_HEIGHT - 8 : (wp._level > 0 ? ROW_HEIGHT - 12 : ROW_HEIGHT - 8),
                                    backgroundColor: '#8b5cf6',
                                    border: '2px dashed #7c3aed'
                                  }} 
                                />
                              );
                            } else if (baselineWP && baselineWP.startDate && baselineWP.endDate) {
                              // Baseline Schatten (nur wenn Position anders ist)
                              const baselineStartDate = baselineWP.startDate;
                              const baselineEndDate = baselineWP.endDate;
                              const currentStart = calcDates?.startDate || wp.startDate;
                              const currentEnd = calcDates?.endDate || wp.endDate;
                              
                              if (baselineStartDate !== currentStart || baselineEndDate !== currentEnd) {
                                const baseX = dateToX(baselineStartDate);
                                const baseEndX = dateToX(baselineEndDate);
                                const baseWidth = baseEndX - baseX + DAY_WIDTH;
                                shadowElement = (
                                  <div 
                                    className="absolute rounded opacity-25 pointer-events-none"
                                    style={{ 
                                      left: baseX, 
                                      width: baseWidth, 
                                      top: hasChildren ? 4 : (wp._level > 0 ? 6 : 4), 
                                      height: hasChildren ? ROW_HEIGHT - 8 : (wp._level > 0 ? ROW_HEIGHT - 12 : ROW_HEIGHT - 8),
                                      backgroundColor: '#8b5cf6',
                                      border: '2px dashed #7c3aed'
                                    }} 
                                  />
                                );
                              }
                            }
                            
                            const isBeingDragged = rowDragWP?.id === wp.id;
                            const isDropBefore = dropTarget?.wpId === wp.id && dropTarget?.position === 'before';
                            const isDropAfter = dropTarget?.wpId === wp.id && dropTarget?.position === 'after';
                            const isDropChild = dropTarget?.wpId === wp.id && dropTarget?.position === 'child';
                            
                            return (
                              <div key={wp.id} className="relative">
                                {/* Drop-Indikator oben */}
                                {isDropBefore && <div className="absolute top-0 left-0 right-0 h-0.5 bg-indigo-500 z-10" />}
                                
                                <div 
                                  className={`relative border-b border-gray-100 group ${isBeingDragged ? 'opacity-50' : ''} ${isDropChild ? 'ring-2 ring-indigo-400 ring-inset' : ''}`} 
                                  style={bgStyle}
                                  onMouseEnter={() => {
                                    if (rowDragWP && rowDragWP.id !== wp.id) {
                                      setDropTarget({ wpId: wp.id, position: 'after' });
                                    }
                                  }}
                                  onMouseMove={(e) => {
                                    if (rowDragWP && rowDragWP.id !== wp.id) {
                                      const rect = e.currentTarget.getBoundingClientRect();
                                      const y = e.clientY - rect.top;
                                      const third = rect.height / 3;
                                      if (y < third) {
                                        setDropTarget({ wpId: wp.id, position: 'before' });
                                      } else if (y > third * 2) {
                                        setDropTarget({ wpId: wp.id, position: 'after' });
                                      } else {
                                        setDropTarget({ wpId: wp.id, position: 'child' });
                                      }
                                    }
                                  }}
                                  onMouseLeave={() => {
                                    if (rowDragWP && dropTarget?.wpId === wp.id) {
                                      setDropTarget(null);
                                    }
                                  }}
                                >
                                  {shadowElement}
                                  {hasChildren && isExpanded ? renderBracket(wp, x, width, color) : renderBar(wp, x, width, color, wp._level > 0)}
                                </div>
                                
                                {/* Drop-Indikator unten */}
                                {isDropAfter && <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-indigo-500 z-10" />}
                              </div>
                            );
                          })}
                          {flatList.length === 0 && <div className="border-b border-gray-100" style={{ height: ROW_HEIGHT, minWidth: WEEKS_TO_SHOW * 7 * DAY_WIDTH }} />}
                        </div>
                      ))}
                      <svg className="absolute top-0 left-0 pointer-events-none" style={{ width: WEEKS_TO_SHOW * 7 * DAY_WIDTH, height: '100%', overflow: 'visible' }}>
                        <defs>
                          <marker id="arrow-gray" markerWidth="5" markerHeight="4" refX="4" refY="2" orient="auto"><polygon points="0 0, 5 2, 0 4" fill="#9ca3af" /></marker>
                          <marker id="arrow-red" markerWidth="5" markerHeight="4" refX="4" refY="2" orient="auto"><polygon points="0 0, 5 2, 0 4" fill="#ef4444" /></marker>
                        </defs>
                        {dependencies.map(dep => {
                          const fromWP = workPackages.find(w => w.id === dep.fromId);
                          const toWP = workPackages.find(w => w.id === dep.toId);
                          if (!fromWP || !toWP) return null;
                          
                          const depType = dep.type || 'FS'; // Standard ist Finish-to-Start
                          const isSSType = depType === 'SS';
                          
                          // Ber√ºcksichtige Preview-Positionen f√ºr Pfeile
                          const fromPreview = previewPositions[dep.fromId];
                          const toPreview = previewPositions[dep.toId];
                          const fromDragged = draggedWP?.wp.id === dep.fromId;
                          const toDragged = draggedWP?.wp.id === dep.toId;
                          const fromResized = resizingWP?.wp.id === dep.fromId && resizingWP.previewEnd;
                          
                          let fromDate, toStartDate;
                          
                          // From-Datum berechnen (Ende bei FS, Start bei SS)
                          if (isSSType) {
                            // Start-to-Start: Vom Start des From-Balkens
                            if (fromDragged && !draggedWP.isSummary && draggedWP.previewStart) {
                              fromDate = draggedWP.previewStart;
                            } else if (fromDragged && draggedWP.isSummary && draggedWP.daysDiff) {
                              const origStart = new Date(fromWP.startDate);
                              origStart.setDate(origStart.getDate() + draggedWP.daysDiff);
                              fromDate = formatDate(origStart);
                            } else if (fromPreview) {
                              fromDate = fromPreview.startDate;
                            } else {
                              const fromDates = getChildren(fromWP.id, workPackages).length > 0 ? calculateDatesFromChildren(fromWP.id, workPackages) : { startDate: fromWP.startDate };
                              fromDate = fromDates?.startDate;
                            }
                          } else {
                            // Finish-to-Start: Vom Ende des From-Balkens
                            if (fromDragged && !draggedWP.isSummary && draggedWP.previewEnd) {
                              fromDate = draggedWP.previewEnd;
                            } else if (fromDragged && draggedWP.isSummary && draggedWP.daysDiff) {
                              const origEnd = new Date(fromWP.endDate);
                              origEnd.setDate(origEnd.getDate() + draggedWP.daysDiff);
                              fromDate = formatDate(origEnd);
                            } else if (fromResized) {
                              fromDate = resizingWP.previewEnd;
                            } else if (fromPreview) {
                              fromDate = fromPreview.endDate;
                            } else {
                              const fromDates = getChildren(fromWP.id, workPackages).length > 0 ? calculateDatesFromChildren(fromWP.id, workPackages) : { endDate: fromWP.endDate };
                              fromDate = fromDates?.endDate;
                            }
                          }
                          
                          // To-Start berechnen
                          if (toDragged && !draggedWP.isSummary && draggedWP.previewStart) {
                            toStartDate = draggedWP.previewStart;
                          } else if (toDragged && draggedWP.isSummary && draggedWP.daysDiff) {
                            const origStart = new Date(toWP.startDate);
                            origStart.setDate(origStart.getDate() + draggedWP.daysDiff);
                            toStartDate = formatDate(origStart);
                          } else if (toPreview) {
                            toStartDate = toPreview.startDate;
                          } else {
                            const toDates = getChildren(toWP.id, workPackages).length > 0 ? calculateDatesFromChildren(toWP.id, workPackages) : { startDate: toWP.startDate };
                            toStartDate = toDates?.startDate;
                          }
                          
                          if (!fromDate || !toStartDate) return null;
                          let fromY = 0, toY = 0, foundFrom = false, foundTo = false, currentY = 0;
                          allProjectsData.forEach(({ flatList }) => { currentY += ROW_HEIGHT; flatList.forEach(wp => { if (wp.id === fromWP.id) { fromY = currentY + ROW_HEIGHT / 2; foundFrom = true; } if (wp.id === toWP.id) { toY = currentY + ROW_HEIGHT / 2; foundTo = true; } currentY += ROW_HEIGHT; }); if (flatList.length === 0) currentY += ROW_HEIGHT; });
                          if (!foundFrom || !foundTo) return null;
                          
                          // Bei SS: Vom Start, bei FS: Vom Ende
                          const fromX = isSSType ? dateToX(fromDate) : dateToX(fromDate) + DAY_WIDTH;
                          const toStartX = dateToX(toStartDate);
                          const isHovered = hoveredDep === dep.id;
                          
                          const r = 6;
                          const barHeight = ROW_HEIGHT - 8;
                          const startX = isSSType ? fromX + DAY_WIDTH / 2 : fromX - DAY_WIDTH / 2;
                          const startY = fromY + barHeight / 2;
                          const endX = toStartX;
                          const endY = toY;
                          const goingDown = endY > startY;
                          const goingBack = isSSType ? (toStartX < fromX + DAY_WIDTH) : (toStartX < fromX);
                          
                          let path;
                          if (Math.abs(startY - endY) < 5 && !goingBack) {
                            path = `M ${fromX} ${fromY} L ${endX} ${endY}`;
                          } else if (goingBack) {
                            const firstDropY = startY + 12;
                            const leftX = Math.min(startX, endX) - 12;
                            
                            path = `M ${startX} ${startY}`;
                            path += ` L ${startX} ${firstDropY - r}`;
                            path += ` Q ${startX} ${firstDropY}, ${startX - r} ${firstDropY}`;
                            path += ` L ${leftX + r} ${firstDropY}`;
                            path += ` Q ${leftX} ${firstDropY}, ${leftX} ${firstDropY + (goingDown ? r : -r)}`;
                            path += ` L ${leftX} ${endY + (goingDown ? -r : r)}`;
                            path += ` Q ${leftX} ${endY}, ${leftX + r} ${endY}`;
                            path += ` L ${endX} ${endY}`;
                          } else {
                            path = `M ${startX} ${startY}`;
                            path += ` L ${startX} ${endY + (goingDown ? -r : r)}`;
                            path += ` Q ${startX} ${endY}, ${startX + r} ${endY}`;
                            path += ` L ${endX} ${endY}`;
                          }
                          
                          // Alle Pfeile grau (rot bei Hover)
                          const strokeColor = isHovered ? '#ef4444' : '#9ca3af';
                          const arrowMarker = isHovered ? 'url(#arrow-red)' : 'url(#arrow-gray)';
                          
                          // Berechne Position f√ºr L√∂sch-Symbol auf der Linie
                          let deleteX, deleteY;
                          if (Math.abs(startY - endY) < 5 && !goingBack) {
                            // Horizontaler Pfad - Mitte der Linie
                            deleteX = (fromX + endX) / 2;
                            deleteY = fromY;
                          } else if (goingBack) {
                            // R√ºckw√§rts-Pfad - auf dem vertikalen Teil links
                            const leftX = Math.min(startX, endX) - 12;
                            deleteX = leftX;
                            deleteY = (startY + 12 + endY) / 2;
                          } else {
                            // Normaler Pfad mit vertikalem Teil - auf dem vertikalen Segment
                            deleteX = startX;
                            deleteY = (startY + endY) / 2;
                          }
                          
                          return (
                            <g key={dep.id} onMouseEnter={() => setHoveredDep(dep.id)} onMouseLeave={() => setHoveredDep(null)} style={{ pointerEvents: 'stroke', cursor: 'pointer' }}>
                              <path d={path} fill="none" stroke="transparent" strokeWidth="12" />
                              <path d={path} fill="none" stroke={strokeColor} strokeWidth={isHovered ? 2.5 : 1.5} markerEnd={arrowMarker} />
                              {isHovered && (
                                <g transform={`translate(${deleteX - 8}, ${deleteY - 8})`} onClick={() => deleteDependency(dep.id)} style={{ cursor: 'pointer', pointerEvents: 'all' }}>
                                  <circle cx="8" cy="8" r="9" fill="white" stroke="#ef4444" strokeWidth="1.5" />
                                  <path d="M5 5 L11 11 M11 5 L5 11" stroke="#ef4444" strokeWidth="2" strokeLinecap="round" />
                                </g>
                              )}
                            </g>
                          );
                        })}
                      </svg>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          </div>
          
          {/* AUSKOMMENTIERT: Hover-Infofeld √ºber Gantt-Balken
          {hoveredWP && <div className="fixed bg-white rounded-lg shadow-xl border p-3 z-50 pointer-events-none" style={{ left: Math.min(hoveredWP.x, window.innerWidth - 280), top: hoveredWP.y, minWidth: 250, maxWidth: 300 }}>
            <div className="font-bold text-sm mb-2 text-gray-800">{hoveredWP.wp.name}</div>
            <div className="grid grid-cols-2 gap-x-4 gap-y-1 text-xs">
              <div className="text-gray-500">Zeitraum:</div>
              <div>{(() => { const cd = getChildren(hoveredWP.wp.id, workPackages).length > 0 ? calculateDatesFromChildren(hoveredWP.wp.id, workPackages) : null; const s = cd?.startDate || hoveredWP.wp.startDate; const e = cd?.endDate || hoveredWP.wp.endDate; return `${s ? new Date(s).toLocaleDateString('de-DE') : '-'} - ${e ? new Date(e).toLocaleDateString('de-DE') : '-'}`; })()}</div>
              <div className="text-gray-500">Planstunden:</div>
              <div className="text-gray-600">{hoveredWP.totalHours || 0}h</div>
              <div className="text-gray-500">Zugewiesen:</div>
              <div className="text-gray-600">{calculateAssignedHours(hoveredWP.wp)}h</div>
              {(hoveredWP.wp.responsibles?.length > 0) && <React.Fragment>
                <div className="text-gray-500">Verantwortlich:</div>
                <div>{hoveredWP.wp.responsibles.map(r => { const u = users.find(u => u.id === (typeof r === 'object' ? r.userId : r)); return u ? `${u.name}${typeof r === 'object' && r.hours ? ` (${r.hours}h)` : ''}` : null; }).filter(Boolean).join(', ') || '-'}</div>
              </React.Fragment>}
            </div>
            {dependencies.filter(d => d.fromId === hoveredWP.wp.id || d.toId === hoveredWP.wp.id).length > 0 && <div className="mt-2 pt-2 border-t text-xs"><span className="text-gray-500">Abh√§ngigkeiten: </span><span>{dependencies.filter(d => d.fromId === hoveredWP.wp.id || d.toId === hoveredWP.wp.id).length}</span></div>}
          </div>}
          */}
          
          {linkingFrom && linkMousePos && <svg className="fixed inset-0 pointer-events-none z-40" style={{ width: '100vw', height: '100vh' }}><line x1={linkingFrom.startX || 0} y1={linkingFrom.startY || 0} x2={linkMousePos.x} y2={linkMousePos.y} stroke="#9ca3af" strokeWidth="2" strokeDasharray="5,5" /><circle cx={linkMousePos.x} cy={linkMousePos.y} r="5" fill="#9ca3af" /></svg>}
          
          {contextMenu && <div className="fixed bg-white rounded-lg shadow-xl border py-1 z-50 min-w-48" style={{ left: contextMenu.x, top: contextMenu.y }}>
            {contextMenu.type === 'project' && <React.Fragment><div className="px-3 py-1 text-xs text-gray-500 border-b">{contextMenu.project.name}</div><button onClick={() => { addWorkPackage(contextMenu.project.id); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-indigo-50 flex items-center gap-2"><Plus className="w-4 h-4 text-indigo-600" /> Neues Arbeitspaket</button></React.Fragment>}
            {contextMenu.type === 'wp' && <React.Fragment><div className="px-3 py-1 text-xs text-gray-500 border-b truncate max-w-48">{contextMenu.wp.name}</div><button onClick={() => { addWorkPackage(contextMenu.wp.projectId, contextMenu.wp.id); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-indigo-50 flex items-center gap-2"><Plus className="w-4 h-4 text-green-600" /> Unter-Arbeitspaket</button><button onClick={() => { indentWorkPackage(contextMenu.wp.id); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-indigo-50 flex items-center gap-2"><ChevronRight className="w-4 h-4" /> Einr√ºcken</button><button onClick={() => { outdentWorkPackage(contextMenu.wp.id); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-indigo-50 flex items-center gap-2"><ChevronLeft className="w-4 h-4" /> Ausr√ºcken</button><div className="border-t my-1" /><button onClick={() => { deleteWorkPackage(contextMenu.wp.id); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-red-50 text-red-600 flex items-center gap-2"><Trash2 className="w-4 h-4" /> L√∂schen</button></React.Fragment>}
            {contextMenu.type === 'gantt-wp' && <React.Fragment>
              <div className="px-3 py-1 text-xs text-gray-500 border-b truncate max-w-48">{contextMenu.wp.name}</div>
              <div className="px-3 py-2 text-xs text-gray-600">Farbe w√§hlen:</div>
              <div className="px-3 pb-2 flex flex-wrap gap-1">
                {wpColors.map(color => <button key={color} onClick={() => { updateWorkPackage(contextMenu.wp.id, 'color', color); setContextMenu(null); }} className={`w-6 h-6 rounded border-2 ${contextMenu.wp.color === color ? 'border-gray-800' : 'border-transparent'} hover:scale-110 transition-transform`} style={{ backgroundColor: color }} />)}
                <button onClick={() => { updateWorkPackage(contextMenu.wp.id, 'color', null); setContextMenu(null); }} className="w-6 h-6 rounded border-2 border-gray-300 hover:scale-110 transition-transform text-xs text-gray-400">X</button>
              </div>
              <div className="border-t my-1" />
              <button onClick={() => { addWorkPackage(contextMenu.wp.projectId, contextMenu.wp.id); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-indigo-50 flex items-center gap-2"><Plus className="w-4 h-4 text-green-600" /> Unter-Arbeitspaket</button>
              <button onClick={() => { setSelectedWPs([]); setSidebarWPId(contextMenu.wp.id); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-indigo-50 flex items-center gap-2"><Settings className="w-4 h-4" /> Details bearbeiten</button>
              <div className="border-t my-1" />
              <button onClick={() => { deleteWorkPackage(contextMenu.wp.id); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-red-50 text-red-600 flex items-center gap-2"><Trash2 className="w-4 h-4" /> L√∂schen</button>
            </React.Fragment>}
          </div>}
          
          {/* Kontextmen√º f√ºr Tage (Feiertage/freie Tage) */}
          {dayContextMenu && (
            <div className="fixed bg-white rounded-lg shadow-xl border py-2 z-50 min-w-56" style={{ left: dayContextMenu.x, top: dayContextMenu.y }}>
              <div className="px-3 py-1 text-xs text-gray-500 border-b mb-1">
                {new Date(dayContextMenu.date).toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
              </div>
              {holidays[dayContextMenu.date] ? (
                <React.Fragment>
                  <div className="px-3 py-1.5 text-sm">
                    <div className="font-medium text-red-600">{holidays[dayContextMenu.date].name}</div>
                    <div className="text-xs text-gray-500">
                      {holidays[dayContextMenu.date].type === 'feiertag' ? 'üéâ Feiertag' : 
                       holidays[dayContextMenu.date].type === 'urlaub' ? 'üèñÔ∏è Urlaub' : 
                       holidays[dayContextMenu.date].type === 'betriebsferien' ? 'üè¢ Betriebsferien' : 'üìÖ Frei'}
                    </div>
                  </div>
                  <div className="border-t my-1" />
                  <button 
                    onClick={() => { setEditingHoliday({ date: dayContextMenu.date, ...holidays[dayContextMenu.date] }); setDayContextMenu(null); }}
                    className="w-full px-3 py-1.5 text-left text-sm hover:bg-gray-50 flex items-center gap-2"
                  >
                    <span>‚úèÔ∏è</span> Bearbeiten
                  </button>
                  <button 
                    onClick={() => { const h = { ...holidays }; delete h[dayContextMenu.date]; saveHolidays(h); setDayContextMenu(null); }}
                    className="w-full px-3 py-1.5 text-left text-sm hover:bg-red-50 text-red-600 flex items-center gap-2"
                  >
                    <Trash2 className="w-4 h-4" /> Entfernen
                  </button>
                </React.Fragment>
              ) : (
                <React.Fragment>
                  <div className="px-3 pb-1 text-xs text-gray-400">Als frei markieren:</div>
                  <button 
                    onClick={() => { setEditingHoliday({ date: dayContextMenu.date, type: 'feiertag', name: '' }); setDayContextMenu(null); }}
                    className="w-full px-3 py-1.5 text-left text-sm hover:bg-gray-50 flex items-center gap-2"
                  >
                    <span>üéâ</span> Feiertag
                  </button>
                  <button 
                    onClick={() => { setEditingHoliday({ date: dayContextMenu.date, type: 'urlaub', name: '' }); setDayContextMenu(null); }}
                    className="w-full px-3 py-1.5 text-left text-sm hover:bg-gray-50 flex items-center gap-2"
                  >
                    <span>üèñÔ∏è</span> Urlaub
                  </button>
                  <button 
                    onClick={() => { setEditingHoliday({ date: dayContextMenu.date, type: 'betriebsferien', name: '' }); setDayContextMenu(null); }}
                    className="w-full px-3 py-1.5 text-left text-sm hover:bg-gray-50 flex items-center gap-2"
                  >
                    <span>üè¢</span> Betriebsferien
                  </button>
                  <button 
                    onClick={() => { setEditingHoliday({ date: dayContextMenu.date, type: 'frei', name: '' }); setDayContextMenu(null); }}
                    className="w-full px-3 py-1.5 text-left text-sm hover:bg-gray-50 flex items-center gap-2"
                  >
                    <span>üìÖ</span> Sonstiger freier Tag
                  </button>
                </React.Fragment>
              )}
            </div>
          )}
          
          {/* Dialog zum Bearbeiten/Erstellen eines freien Tages */}
          {editingHoliday && (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setEditingHoliday(null)}>
              <div className="bg-white rounded-xl shadow-2xl p-6 w-96" onClick={(e) => e.stopPropagation()}>
                <h3 className="text-lg font-bold mb-4">
                  {editingHoliday.type === 'feiertag' ? 'üéâ Feiertag' : 
                   editingHoliday.type === 'urlaub' ? 'üèñÔ∏è Urlaub' : 
                   editingHoliday.type === 'betriebsferien' ? 'üè¢ Betriebsferien' : 'üìÖ Freier Tag'}
                </h3>
                <div className="text-sm text-gray-500 mb-4">
                  {new Date(editingHoliday.date).toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
                </div>
                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700 mb-1">Bezeichnung</label>
                  <input 
                    type="text"
                    autoFocus
                    value={editingHoliday.name}
                    onChange={(e) => setEditingHoliday({ ...editingHoliday, name: e.target.value })}
                    placeholder={editingHoliday.type === 'feiertag' ? 'z.B. Rosenmontag' : editingHoliday.type === 'urlaub' ? 'z.B. Teamurlaub' : 'Bezeichnung eingeben...'}
                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                  />
                </div>
                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700 mb-1">Typ</label>
                  <select 
                    value={editingHoliday.type}
                    onChange={(e) => setEditingHoliday({ ...editingHoliday, type: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                  >
                    <option value="feiertag">üéâ Feiertag</option>
                    <option value="urlaub">üèñÔ∏è Urlaub</option>
                    <option value="betriebsferien">üè¢ Betriebsferien</option>
                    <option value="frei">üìÖ Sonstiger freier Tag</option>
                  </select>
                </div>
                <div className="flex justify-end gap-2">
                  <button 
                    onClick={() => setEditingHoliday(null)}
                    className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg"
                  >
                    Abbrechen
                  </button>
                  <button 
                    onClick={() => {
                      if (editingHoliday.name.trim()) {
                        saveHolidays({ ...holidays, [editingHoliday.date]: { type: editingHoliday.type, name: editingHoliday.name.trim() } });
                        setEditingHoliday(null);
                      }
                    }}
                    disabled={!editingHoliday.name.trim()}
                    className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                  >
                    Speichern
                  </button>
                </div>
              </div>
            </div>
          )}
          
          <div className="bg-white border-t px-4 py-2 flex gap-6 text-xs text-gray-600 flex-shrink-0">
            <div className="flex items-center gap-2"><div className="w-6 h-2 border-t-2 border-l-2 border-r-2 border-indigo-500 rounded-t" /><span>Klammer = Eltern</span></div>
            <div className="flex items-center gap-2"><div className="w-6 h-3 bg-indigo-500 rounded" /><span>Balken</span></div>
            <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-gray-400 border-2 border-white" /><span>Abh√§ngigkeit</span></div>
            {selectedProjectId && (
              <div className="flex items-center gap-4 ml-4 pl-4 border-l">
                <span className="text-indigo-600 font-medium">{(workPackages || []).filter(wp => wp.projectId === selectedProjectId).length} Arbeitspakete</span>
                <span className="text-gray-500">{currentProjectBaselines.length} Baseline{currentProjectBaselines.length !== 1 ? 's' : ''}</span>
              </div>
            )}
            <div className="ml-auto text-gray-400">Rechtsklick f√ºr Men√º | Doppelklick zum Umbenennen</div>
          </div>
        </div>
      );
    };
    
    return <ProjectPlanningDashboard />;
  }


  const sortedProjects = [...projects].sort((a, b) => a.name.localeCompare(b.name));
  const filteredProjects = sortedProjects.filter(p => 
    p.name.toLowerCase().includes(projectSearchText.toLowerCase())
  );
  const displayUser = selectedUser || currentUser;

  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-50 to-purple-50">
      <div className="bg-white shadow-lg sticky top-0 z-10">
        <div className="max-w-full mx-auto px-6 py-4 flex justify-between">
          <div className="flex items-center gap-3">
            <Calendar className="w-6 h-6 text-indigo-600" />
            <h1 className="text-xl font-bold">Kapazit√§tsplaner V5</h1>
            {currentUser.teamRole === 'lead' ? (
              <select value={selectedUser?.id || ''} onChange={(e) => { const user = users.find(u => u.id === e.target.value); if (user) setSelectedUser(user); }}
                className="ml-4 px-4 py-2 border-2 border-indigo-600 rounded-xl font-semibold">
                {users.filter(u => u.role !== 'admin').map(u => (<option key={u.id} value={u.id}>{u.name}</option>))}
              </select>
            ) : (
              <span className="ml-4 px-4 py-2 font-semibold text-gray-600">- {displayUser?.name}</span>
            )}
          </div>
          <div className="flex gap-2">
            {/* Undo/Redo Buttons */}
            <button 
              onClick={undo} 
              disabled={undoStack.length === 0}
              className={`p-3 rounded-2xl ${undoStack.length > 0 ? 'hover:bg-gray-100' : 'opacity-30 cursor-not-allowed'}`}
              title={`R√ºckg√§ngig (${undoStack.length} verf√ºgbar)`}>
              ‚Ü∂
            </button>
            <button 
              onClick={redo} 
              disabled={redoStack.length === 0}
              className={`p-3 rounded-2xl ${redoStack.length > 0 ? 'hover:bg-gray-100' : 'opacity-30 cursor-not-allowed'}`}
              title={`Wiederholen (${redoStack.length} verf√ºgbar)`}>
              ‚Ü∑
            </button>
            
            {/* History Button */}
            <button 
              onClick={() => setShowHistory(!showHistory)} 
              className={`p-3 rounded-2xl ${showHistory ? 'bg-blue-100' : 'hover:bg-gray-100'}`}
              title="√Ñnderungshistorie">
              üìú
            </button>
            
            {/* Navigation - IMMER sichtbar, aktiver Button hervorgehoben */}
            <button 
              onClick={() => { setShowDashboard(false); setShowProjectDashboard(false); setShowProjectPlanning(false); }} 
              className={`px-4 py-2 rounded-2xl ${!showDashboard && !showProjectDashboard && !showProjectPlanning ? 'bg-indigo-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}
            >
              <Calendar className="w-4 h-4 inline mr-2" />Planung
            </button>
            <button 
              onClick={() => { setShowDashboard(true); setShowProjectDashboard(false); setShowProjectPlanning(false); }} 
              className={`px-4 py-2 rounded-2xl ${showDashboard ? 'bg-green-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}
            >
              <BarChart3 className="w-4 h-4 inline mr-2" />Team Dashboard
            </button>
            <button 
              onClick={() => { setShowDashboard(false); setShowProjectDashboard(true); setShowProjectPlanning(false); }} 
              className={`px-4 py-2 rounded-2xl ${showProjectDashboard ? 'bg-blue-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}
            >
              <BarChart3 className="w-4 h-4 inline mr-2" />Projekt Dashboard
            </button>
            <button 
              onClick={() => { setShowDashboard(false); setShowProjectDashboard(false); setShowProjectPlanning(true); }} 
              className={`px-4 py-2 rounded-2xl ${showProjectPlanning ? 'bg-orange-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}
            >
              üèóÔ∏è Projektplanung
            </button>
            
            {currentUser.role === 'admin' && (<button onClick={() => setShowAdmin(true)} className="px-4 py-2 bg-purple-600 text-white rounded-2xl">Admin</button>)}
            <button onClick={() => setShowSettings(true)} className="p-3 hover:bg-gray-100 rounded-2xl"><Settings className="w-5 h-5" /></button>
            <button onClick={() => { setCurrentUser(null); setSelectedUser(null); setShowLogin(true); setShowDashboard(false); }} 
              className="px-4 py-2 bg-gray-100 rounded-2xl"><LogOut className="w-4 h-4 inline mr-2" />Abmelden</button>
          </div>
        </div>
      </div>
      
      <div className="bg-white shadow">
        <div className="max-w-full mx-auto px-6 py-4 flex justify-between items-center">
          <button onClick={() => setCurrentWeek(w => w === 1 ? 52 : w - 1)} className="px-4 py-2 bg-indigo-600 text-white rounded-2xl"><ChevronLeft className="w-5 h-5" /></button>
          <div className="font-bold">KW {currentWeek} - {currentWeek + WEEKS_TO_SHOW - 1}</div>
          <button onClick={() => setCurrentWeek(w => w === 52 ? 1 : w + 1)} className="px-4 py-2 bg-indigo-600 text-white rounded-2xl"><ChevronRight className="w-5 h-5" /></button>
        </div>
      </div>

      <div className="max-w-full mx-auto px-6 py-6">
        <div className="bg-white rounded-3xl shadow-lg">
          <div className="bg-gradient-to-r from-indigo-600 to-purple-600 px-6 py-4">
            <h2 className="text-xl font-bold text-white">Wochenansicht - {displayUser?.name}</h2>
          </div>
          <div className="p-4 flex gap-4">
            <div className="w-56 bg-gray-50 rounded-2xl p-4 flex-shrink-0 flex flex-col" style={{maxHeight: '600px'}}>
              <h3 className="font-bold mb-3">Projekte</h3>
              
              {/* Suchfeld */}
              <div className="mb-3">
                <input 
                  type="text" 
                  placeholder="Suchen..." 
                  value={projectSearchText}
                  onChange={(e) => setProjectSearchText(e.target.value)}
                  className="w-full p-2 border rounded-lg text-sm"
                />
              </div>
              
              <div className="space-y-2 overflow-y-auto flex-1">
                {filteredProjects.map(p => (
                  <div key={p.id} draggable onDragStart={() => setDraggedProject(p)} 
                    className="flex items-center gap-2 p-3 rounded-xl cursor-move hover:shadow-lg bg-white border-2 transition-shadow" style={{borderColor: p.color}}>
                    <GripVertical className="w-4 h-4" />
                    <div className="w-4 h-4 rounded" style={{backgroundColor: p.color}}></div>
                    <span className="flex-1 text-sm">{p.name}</span>
                  </div>
                ))}
                {filteredProjects.length === 0 && projectSearchText && (
                  <div className="text-center text-gray-500 text-xs py-4">
                    Keine Projekte
                  </div>
                )}
              </div>
            </div>
            <div className="flex-1 overflow-x-auto preserve-scroll" ref={ganttScrollRef}>
              <div className="flex gap-4 pb-4">
                {displayUser && Array.from({length: WEEKS_TO_SHOW}, (_, i) => {
                  const weekNum = currentWeek + i;
                  return <WeekColumn key={weekNum} weekNum={weekNum} user={displayUser} />;
                })}
              </div>
            </div>
          </div>
        </div>
      </div>

      {showSettings && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-3xl p-6 max-w-[1400px] w-full max-h-[80vh] overflow-y-auto">
            <div className="flex justify-between mb-6">
              <h2 className="text-2xl font-bold">Einstellungen</h2>
              <button onClick={() => { setShowSettings(false); setProjectSearchText(''); }} className="text-2xl">‚úï</button>
            </div>
            <div className="mb-6">
              <h3 className="font-semibold mb-3">Schriftgr√∂√üe: {fontSize}px</h3>
              <input type="range" min="10" max="16" value={fontSize} onChange={(e) => setFontSize(parseInt(e.target.value))} className="w-full" />
            </div>
            
            {/* Arbeitszeiten & Pausen */}
            <div>
              <h3 className="font-semibold mb-3">Arbeitszeiten & Pausen</h3>
              <div className="p-3 bg-gray-50 rounded-xl">
                <div className="space-y-2">
                  {[{d:1,l:'Mo'},{d:2,l:'Di'},{d:3,l:'Mi'},{d:4,l:'Do'},{d:5,l:'Fr'}].map(({d,l}) => {
                    const sched = displayUser?.dailySchedule || DEFAULT_SCHEDULE;
                    const dayS  = sched[d] || {start:8, end:17, break1Start:9, break1Duration:0.25, break2Start:12.5, break2Duration:0.75};
                    const isOff = dayS.start >= dayS.end || (dayS.start === 0 && dayS.end === 0);
                    const toggleOff = () => {
                      const newSched = {...sched, [d]: isOff ? {start:8,end:17,break1Start:9,break1Duration:0.25,break2Start:12.5,break2Duration:0.75} : {start:0,end:0,break1Duration:0,break2Duration:0}};
                      const updatedUsers = users.map(u => u.id === displayUser.id ? {...u, dailySchedule: newSched} : u);
                      saveUsers(updatedUsers);
                      if (selectedUser?.id === displayUser.id) setSelectedUser({...displayUser, dailySchedule: newSched});
                    };
                    const setVal = (field, raw) => {
                      const val = (field === 'break1Duration' || field === 'break2Duration' || field === 'break1Start' || field === 'break2Start') 
                        ? parseFloat(raw) || 0 
                        : t2h(raw);
                      const newSched = {...sched, [d]: {...dayS, [field]: val}};
                      const updatedUsers = users.map(u => u.id === displayUser.id ? {...u, dailySchedule: newSched} : u);
                      saveUsers(updatedUsers);
                      if (selectedUser?.id === displayUser.id) setSelectedUser({...displayUser, dailySchedule: newSched});
                    };
                    const break1 = dayS.break1Duration || 0;
                    const break2 = (dayS.end > 13) ? (dayS.break2Duration || 0) : 0;
                    const netHours = Math.max(0, (dayS.end - dayS.start) - break1 - break2);
                    return (
                      <div key={d} className="space-y-1">
                        <div className="flex items-center gap-2 text-sm">
                          <span className="font-medium text-gray-700 w-20">{l}</span>
                          {isOff ? (
                            <>
                              <span className="text-red-500 italic flex-1">frei</span>
                              <button onClick={toggleOff} className="text-xs px-2 py-1 rounded font-semibold bg-green-100 text-green-700">An</button>
                            </>
                          ) : (
                            <>
                              <input 
                                type="text" 
                                defaultValue={h2t(dayS.start)}
                                key={`settings-start-${d}-${dayS.start}`}
                                onBlur={(e) => {
                                  const formatted = formatTimeInput(e.target.value);
                                  if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                    setVal('start', formatted);
                                  }
                                }}
                                onKeyDown={(e) => {
                                  if (e.key === 'Enter') {
                                    const formatted = formatTimeInput(e.target.value);
                                    if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                      setVal('start', formatted);
                                      e.target.blur();
                                    }
                                  }
                                }}
                                className="p-1.5 border rounded text-sm w-20"
                                placeholder="HH:MM" 
                              />
                              <span className="text-gray-400 text-sm">‚Äì</span>
                              <input 
                                type="text" 
                                defaultValue={h2t(dayS.end)}
                                key={`settings-end-${d}-${dayS.end}`}
                                onBlur={(e) => {
                                  const formatted = formatTimeInput(e.target.value);
                                  if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                    setVal('end', formatted);
                                  }
                                }}
                                onKeyDown={(e) => {
                                  if (e.key === 'Enter') {
                                    const formatted = formatTimeInput(e.target.value);
                                    if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                      setVal('end', formatted);
                                      e.target.blur();
                                    }
                                  }
                                }}
                                className="p-1.5 border rounded text-sm w-20"
                                placeholder="HH:MM"
                              />
                              <span className="font-semibold text-indigo-600 w-16 text-right text-sm">{netHours.toFixed(2)}h</span>
                              <button onClick={toggleOff} className="text-xs px-2 py-1 rounded font-semibold bg-red-100 text-red-600">Aus</button>
                            </>
                          )}
                        </div>
                        {!isOff && (
                          <div className="flex items-center gap-2 ml-24 text-sm text-gray-600">
                            <span className="font-medium">P1:</span>
                            <input 
                              type="text" 
                              defaultValue={h2t(dayS.break1Start || 9)}
                              key={`settings-b1s-${d}-${dayS.break1Start}`}
                              onBlur={(e) => {
                                const formatted = formatTimeInput(e.target.value);
                                if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                  setVal('break1Start', formatted);
                                }
                              }}
                              onKeyDown={(e) => {
                                if (e.key === 'Enter') {
                                  const formatted = formatTimeInput(e.target.value);
                                  if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                    setVal('break1Start', formatted);
                                    e.target.blur();
                                  }
                                }
                              }}
                              className="p-2 border rounded text-sm w-32" 
                              placeholder="HH:MM"
                              title="Pause 1 Start" />
                            <span className="text-gray-400">‚Äì</span>
                            <input 
                              type="text" 
                              defaultValue={h2t((dayS.break1Start || 9) + (dayS.break1Duration || 0.25))}
                              key={`settings-b1e-${d}-${dayS.break1Duration}`}
                              onBlur={(e) => {
                                const formatted = formatTimeInput(e.target.value);
                                if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                  const end = t2h(formatted);
                                  const start = dayS.break1Start || 9;
                                  const duration = Math.max(0, end - start);
                                  const newSched = {...sched, [d]: {...dayS, break1Duration: duration}};
                                  const updatedUsers = users.map(u => u.id === displayUser.id ? {...u, dailySchedule: newSched} : u);
                                  saveUsers(updatedUsers);
                                  if (selectedUser?.id === displayUser.id) setSelectedUser({...displayUser, dailySchedule: newSched});
                                }
                              }}
                              onKeyDown={(e) => {
                                if (e.key === 'Enter') {
                                  const formatted = formatTimeInput(e.target.value);
                                  if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                    const end = t2h(formatted);
                                    const start = dayS.break1Start || 9;
                                    const duration = Math.max(0, end - start);
                                    const newSched = {...sched, [d]: {...dayS, break1Duration: duration}};
                                    const updatedUsers = users.map(u => u.id === displayUser.id ? {...u, dailySchedule: newSched} : u);
                                    saveUsers(updatedUsers);
                                    if (selectedUser?.id === displayUser.id) setSelectedUser({...displayUser, dailySchedule: newSched});
                                    e.target.blur();
                                  }
                                }
                              }}
                              className="p-2 border rounded text-sm w-32" 
                              placeholder="HH:MM"
                              title="Pause 1 Ende" />
                            
                            <span className="text-gray-400 mx-1">|</span>
                            
                            <span className="font-medium">P2:</span>
                            <input 
                              type="text" 
                              defaultValue={h2t(dayS.break2Start || 12.5)}
                              key={`settings-b2s-${d}-${dayS.break2Start}`}
                              onBlur={(e) => {
                                const formatted = formatTimeInput(e.target.value);
                                if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                  setVal('break2Start', formatted);
                                }
                              }}
                              onKeyDown={(e) => {
                                if (e.key === 'Enter') {
                                  const formatted = formatTimeInput(e.target.value);
                                  if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                    setVal('break2Start', formatted);
                                    e.target.blur();
                                  }
                                }
                              }}
                              className="p-2 border rounded text-sm w-32" 
                              placeholder="HH:MM"
                              title="Pause 2 Start" />
                            <span className="text-gray-400">‚Äì</span>
                            <input 
                              type="text" 
                              defaultValue={h2t((dayS.break2Start || 12.5) + (dayS.break2Duration || 0.75))}
                              key={`settings-b2e-${d}-${dayS.break2Duration}`}
                              onBlur={(e) => {
                                const formatted = formatTimeInput(e.target.value);
                                if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                  const end = t2h(formatted);
                                  const start = dayS.break2Start || 12.5;
                                  const duration = Math.max(0, end - start);
                                  const newSched = {...sched, [d]: {...dayS, break2Duration: duration}};
                                  const updatedUsers = users.map(u => u.id === displayUser.id ? {...u, dailySchedule: newSched} : u);
                                  saveUsers(updatedUsers);
                                  if (selectedUser?.id === displayUser.id) setSelectedUser({...displayUser, dailySchedule: newSched});
                                }
                              }}
                              onKeyDown={(e) => {
                                if (e.key === 'Enter') {
                                  const formatted = formatTimeInput(e.target.value);
                                  if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                    const end = t2h(formatted);
                                    const start = dayS.break2Start || 12.5;
                                    const duration = Math.max(0, end - start);
                                    const newSched = {...sched, [d]: {...dayS, break2Duration: duration}};
                                    const updatedUsers = users.map(u => u.id === displayUser.id ? {...u, dailySchedule: newSched} : u);
                                    saveUsers(updatedUsers);
                                    if (selectedUser?.id === displayUser.id) setSelectedUser({...displayUser, dailySchedule: newSched});
                                    e.target.blur();
                                  }
                                }
                              }}
                              className="p-2 border rounded text-sm w-32" 
                              placeholder="HH:MM"
                              title="Pause 2 Ende" />
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
                <div className="text-sm text-gray-500 text-right pt-3 border-t mt-3">
                  Gesamt: <span className="font-bold text-indigo-600">{[1,2,3,4,5].reduce((s,d) => { 
                    const ds=(displayUser?.dailySchedule||DEFAULT_SCHEDULE)[d]||{start:8,end:17,break1Duration:0.25,break2Duration:0.75}; 
                    const gross=ds.end>ds.start?ds.end-ds.start:0; 
                    const b1=ds.break1Duration||0; 
                    const b2=(ds.end>13)?(ds.break2Duration||0):0; 
                    return s+Math.max(0,gross-b1-b2); 
                  }, 0).toFixed(2)}h / Woche</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {showAdmin && <AdminPanel />}
      
      {/* Global History Panel - fixed overlay f√ºr alle Views */}
      {showHistory && (
        <div className="fixed top-20 right-4 w-80 bg-white rounded-2xl shadow-2xl p-4 flex flex-col z-40 border-2 border-indigo-200" style={{maxHeight: '600px'}}>
          <div className="flex justify-between items-center mb-3">
            <h3 className="font-bold text-indigo-600">üìú √Ñnderungshistorie</h3>
            <button onClick={() => setShowHistory(false)} className="text-gray-400 hover:text-gray-600 text-xl">‚úï</button>
          </div>
          
          <div className="space-y-2 overflow-y-auto flex-1">
            {historyLog.length === 0 ? (
              <div className="text-center text-gray-400 text-sm py-8">
                Noch keine √Ñnderungen
              </div>
            ) : (
              historyLog.map(entry => {
                const date = new Date(entry.timestamp);
                const timeStr = date.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
                const dateStr = date.toLocaleDateString('de-DE', {day: '2-digit', month: '2-digit'});
                
                let icon = 'üìù';
                let actionText = entry.action;
                
                if (entry.action === 'task_create') { icon = '‚ûï'; actionText = 'Task erstellt'; }
                else if (entry.action === 'task_delete') { icon = 'üóëÔ∏è'; actionText = 'Task gel√∂scht'; }
                else if (entry.action === 'task_move') { icon = '‚ÜîÔ∏è'; actionText = 'Task verschoben'; }
                else if (entry.action === 'vacation_set') { icon = 'üèñÔ∏è'; actionText = 'Urlaub gesetzt'; }
                else if (entry.action === 'vacation_remove') { icon = '‚ùå'; actionText = 'Urlaub entfernt'; }
                else if (entry.action === 'project_create') { icon = 'üé®'; actionText = 'Projekt erstellt'; }
                else if (entry.action === 'project_delete') { icon = 'üóëÔ∏è'; actionText = 'Projekt gel√∂scht'; }
                else if (entry.action === 'undo') { icon = '‚Ü∂'; actionText = 'R√ºckg√§ngig'; }
                else if (entry.action === 'redo') { icon = '‚Ü∑'; actionText = 'Wiederherstellt'; }
                
                return (
                  <div key={entry.id} className="bg-gray-50 p-3 rounded-lg shadow-sm border border-gray-200 hover:bg-gray-100 transition-colors">
                    <div className="flex items-start gap-2">
                      <span className="text-lg">{icon}</span>
                      <div className="flex-1 min-w-0">
                        <div className="text-xs text-gray-500">{dateStr} {timeStr}</div>
                        <div className="font-medium text-sm">{entry.userName}</div>
                        <div className="text-sm text-gray-600 mt-1">{actionText}</div>
                        {entry.details && (
                          <div className="text-xs text-gray-500 mt-1 truncate" title={entry.details}>
                            {entry.details}
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                );
              })
            )}
          </div>
        </div>
      )}
    </div>
  );
};

    // App rendern
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<CapacityPlanner />);
  </script>
</body>
</html>
