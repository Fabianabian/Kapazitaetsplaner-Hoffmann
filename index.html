<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>KapazitÃ¤tsplaner V5 - Hierarchische Dashboards</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: system-ui, -apple-system, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .group:hover .group-hover\:opacity-100 { opacity: 1; }
    /* Scroll-Position beibehalten */
    .preserve-scroll { scroll-behavior: auto; }
    
    /* Verstecke Scrollbar fÃ¼r Header-Synchronisation */
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .hide-h-scroll { overflow-x: scroll !important; overflow-y: auto !important; scrollbar-width: thin; }
    .hide-h-scroll::-webkit-scrollbar:horizontal { height: 0; display: none; }
    .hide-h-scroll::-webkit-scrollbar:vertical { width: 10px; }
    .hide-h-scroll::-webkit-scrollbar-thumb:vertical { background: #94a3b8; border-radius: 5px; }
    .hide-h-scroll::-webkit-scrollbar-thumb:vertical:hover { background: #6366f1; }
    .hide-h-scroll::-webkit-scrollbar-track:vertical { background: #f1f5f9; }
    .dark .hide-h-scroll::-webkit-scrollbar-thumb:vertical { background: #4a4a5e; }
    .dark .hide-h-scroll::-webkit-scrollbar-track:vertical { background: #2a2a3e; }
    [data-panel-list]::-webkit-scrollbar { width: 6px; }
    [data-panel-list]::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
    [data-panel-list]::-webkit-scrollbar-thumb:hover { background: #6366f1; }
    [data-panel-list]::-webkit-scrollbar-track { background: transparent; }
    .dark [data-panel-list]::-webkit-scrollbar-thumb { background: #4a4a5e; }
    .dark [data-panel-list]::-webkit-scrollbar-track { background: transparent; }
    .thick-scrollbar::-webkit-scrollbar { height: 14px; }
    .thick-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 7px; }
    .thick-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 7px; border: 2px solid #f1f5f9; min-width: 60px; }
    .thick-scrollbar::-webkit-scrollbar-thumb:hover { background: #6366f1; }
    .thick-scrollbar::-webkit-scrollbar-thumb:active { background: #4f46e5; }
    .dark .thick-scrollbar::-webkit-scrollbar-track { background: #2a2a3e; }
    .dark .thick-scrollbar::-webkit-scrollbar-thumb { background: #4a4a5e; border-color: #2a2a3e; }
    .dark .thick-scrollbar::-webkit-scrollbar-thumb:hover { background: #6366f1; }
    
    /* Diagonale Schraffur fÃ¼r Pausenzeiten */
    .break-stripe {
      background-color: rgba(251, 146, 60, 0.2); /* Orange transparent */
      background-image: repeating-linear-gradient(
        45deg,
        rgba(251, 146, 60, 0.4) 0px,
        rgba(251, 146, 60, 0.4) 2px,
        transparent 2px,
        transparent 6px
      );
    }
    
    /* Mobile Touch-Optimierungen */
    @media (max-width: 768px) {
      /* Touch-Targets mindestens 44x44px */
      button { min-height: 44px; min-width: 44px; }
      
      /* Besseres Tap-Highlighting */
      button, a, [role="button"] {
        -webkit-tap-highlight-color: rgba(99, 102, 241, 0.3);
      }
      
      /* Verhindere Zoom bei Input-Focus */
      input, select, textarea {
        font-size: 16px !important;
      }
      
      /* Scrollbare Bereiche mit Momentum */
      .overflow-x-auto, .overflow-y-auto {
        -webkit-overflow-scrolling: touch;
      }
      
      /* Mobile: Kleinere Schrift im Gantt */
      .gantt-text {
        font-size: 10px !important;
      }
      
      /* Mobile: Admin Panel volle HÃ¶he */
      .admin-modal {
        max-height: 95vh !important;
        margin: 0.5rem !important;
      }
      
      /* Mobile: GrÃ¶ÃŸere Touch-Bereiche fÃ¼r Tasks */
      .task-block {
        min-height: 50px !important;
      }
    }
    
    /* Tablet Optimierungen */
    @media (min-width: 768px) and (max-width: 1024px) {
      /* Admin Panel auf Tablets */
      .admin-grid {
        grid-template-columns: 1fr 1fr !important;
      }
    }
    
    /* Sehr kleine Smartphones */
    @media (max-width: 480px) {
      /* Admin Panel einspaltiges Layout */
      .admin-grid {
        grid-template-columns: 1fr !important;
      }
      
      /* Kleinere Padding auf Mobile */
      .mobile-padding {
        padding: 0.5rem !important;
      }
      
      /* Dashboard Karten volle Breite */
      .dashboard-cards {
        grid-template-columns: 1fr !important;
      }
    }
    
    /* Verbesserte Touch-Gesten fÃ¼r Tasks */
    .task-touchable {
      cursor: pointer;
      touch-action: none;
    }
    
    @media (hover: none) {
      /* Auf Touch-GerÃ¤ten: Buttons immer sichtbar */
      .opacity-0.group-hover\:opacity-100 {
        opacity: 0.8 !important;
      }
    }
    
    /* ===== DARK MODE ===== */
    .dark { color-scheme: dark; }
    .dark, .dark input, .dark select, .dark textarea, .dark button { color: #ddd; }
    
    /* Main backgrounds */
    .dark .dm-root, .dark.dm-root { background: linear-gradient(135deg, #1e1e2e 0%, #2a2640 100%) !important; }
    .dark .dm-header, .dark.dm-header { background: #1a1a2e !important; box-shadow: 0 2px 8px rgba(0,0,0,0.4) !important; }
    .dark .dm-surface { background: #252536 !important; }
    .dark .dm-card { background: #2a2a3c !important; border-color: #3a3a4e !important; }
    .dark .dm-card *, .dark .dm-modal * { color: #d0d0e0; }
    .dark .dm-card h1, .dark .dm-card h2, .dark .dm-card h3, .dark .dm-modal h1, .dark .dm-modal h2, .dark .dm-modal h3 { color: #e8e8f0 !important; }
    
    /* Dashboard cards */
    .dark .rounded-2xl.bg-white, .dark .rounded-xl.bg-white, .dark .rounded-3xl.bg-white,
    .dark .rounded-lg.bg-white { background: #2a2a3c !important; border-color: #3a3a4e !important; }
    
    /* Text */
    .dark h1, .dark h2, .dark h3, .dark .dm-text { color: #e8e8f0 !important; }
    .dark .dm-text-secondary { color: #9a9ab0 !important; }
    .dark p, .dark span, .dark label, .dark td, .dark th { color: #d0d0e0; }
    
    /* Inputs & Controls */
    .dark input, .dark select, .dark textarea {
      background: #2a2a3c !important; border-color: #4a4a5e !important; color: #e0e0f0 !important;
    }
    .dark input:focus, .dark select:focus, .dark textarea:focus {
      border-color: #6366f1 !important; outline-color: #6366f1 !important;
    }
    .dark option { background: #2a2a3c; color: #e0e0f0; }
    
    /* Buttons â€“ soft dark */
    .dark .bg-gray-100, .dark .bg-gray-50 { background-color: #2a2a3e !important; }
    .dark .bg-gray-200 { background-color: #3a3a50 !important; }
    .dark .hover\:bg-gray-100:hover, .dark .hover\:bg-gray-200:hover { background-color: #35354a !important; }
    .dark .hover\:bg-blue-50:hover { background-color: #2e2e44 !important; }
    .dark .hover\:bg-gray-300:hover { background-color: #44445e !important; }
    .dark .focus\:bg-white:focus { background-color: #2e2e44 !important; }
    .dark .bg-white { background-color: #2e2e44 !important; }
    
    /* Borders */
    .dark .border-gray-50, .dark .border-gray-100, .dark .border-gray-200, .dark .border-gray-300 { border-color: #3a3a4e !important; }
    .dark .border-b, .dark .border-t, .dark .border-l, .dark .border-r { border-color: #3a3a4e !important; }
    .dark .divide-y > * + * { border-color: #3a3a4e; }
    
    /* Scrollbar */
    .dark ::-webkit-scrollbar { width: 8px; height: 8px; }
    .dark ::-webkit-scrollbar-track { background: #1e1e2e; }
    .dark ::-webkit-scrollbar-thumb { background: #4a4a5e; border-radius: 4px; }
    .dark ::-webkit-scrollbar-thumb:hover { background: #5a5a70; }
    
    /* Gantt specific */
    .dark .dm-gantt-header { background: #1e1e30 !important; }
    .dark .dm-gantt-row { background: #252536 !important; }
    .dark .dm-gantt-row-alt { background: #2a2a3e !important; }
    
    /* Workload panel */
    .dark .dm-wl-surface { background: #1e1e2e !important; border-color: #3a3a4e !important; }
    .dark .dm-wl-header { background: #252536 !important; border-color: #3a3a4e !important; }
    
    /* Tables & hierarchy rows */
    .dark [style*="background-color: #dcdcdc"] { background-color: #2a2a3e !important; }
    .dark [style*="background-color: #e2e2e2"] { background-color: #2a2a3e !important; }
    .dark [style*="background-color: #ececec"] { background-color: #2a2a3e !important; }
    .dark [style*="background-color: #f4f4f4"] { background-color: #2a2a3e !important; }
    .dark [style*="background-color: #f8f8f8"] { background-color: #2a2a3e !important; }
    .dark [style*="background-color: #fafafa"] { background-color: #2e2e44 !important; }
    .dark [style*="background-color: rgb(220, 220, 220)"] { background-color: #2a2a3e !important; }
    .dark [style*="background-color: rgb(226, 226, 226)"] { background-color: #2a2a3e !important; }
    .dark [style*="background-color: rgb(236, 236, 236)"] { background-color: #2a2a3e !important; }
    .dark [style*="background-color: rgb(244, 244, 244)"] { background-color: #2a2a3e !important; }
    .dark [style*="background-color: rgb(248, 248, 248)"] { background-color: #2a2a3e !important; }
    .dark [style*="background-color: rgb(250, 250, 250)"] { background-color: #2e2e44 !important; }
    /* Border colors in dark mode for workload rows */
    .dark [style*="border-color: #d0d0d0"], .dark [style*="border-color: rgb(208, 208, 208)"] { border-color: #3a3a4e !important; }
    .dark [style*="border-color: #d4d4d4"], .dark [style*="border-color: rgb(212, 212, 212)"] { border-color: #3a3a4e !important; }
    .dark [style*="border-color: #e0e0e0"], .dark [style*="border-color: rgb(224, 224, 224)"] { border-color: #3a3a4e !important; }
    .dark [style*="border-color: #e8e8e8"], .dark [style*="border-color: rgb(232, 232, 232)"] { border-color: #3a3a4e !important; }
    /* Text colors in dark mode for workload rows */
    .dark [style*="color: #333333"], .dark [style*="color: rgb(51, 51, 51)"] { color: #d0d0e0 !important; }
    .dark [style*="color: #444444"], .dark [style*="color: rgb(68, 68, 68)"] { color: #c0c0d8 !important; }
    .dark [style*="color: #555555"], .dark [style*="color: rgb(85, 85, 85)"] { color: #b0b0c8 !important; }
    
    /* Weekend/Holiday cells in dark */
    .dark .bg-gray-200\/50 { background-color: rgba(60,60,80,0.5) !important; }
    .dark .bg-gray-300 { background-color: #1a1a2a !important; }
    .dark .bg-red-100\/50 { background-color: rgba(100,40,40,0.5) !important; }
    .dark .bg-red-50 { background-color: rgba(80,30,30,0.5) !important; }
    .dark .bg-red-50\/50 { background-color: rgba(80,30,30,0.3) !important; }
    .dark .bg-red-100 { background-color: rgba(120,40,40,0.4) !important; }
    .dark .bg-red-200 { background-color: rgba(150,50,50,0.4) !important; }
    .dark .bg-red-300 { background-color: rgba(160,50,50,0.5) !important; }
    .dark .bg-green-50 { background-color: rgba(30,80,50,0.4) !important; }
    .dark .bg-amber-50 { background-color: rgba(100,80,20,0.4) !important; }
    .dark .bg-indigo-100 { background-color: rgba(80,70,140,0.4) !important; }
    .dark .bg-orange-100 { background-color: rgba(120,70,20,0.4) !important; }
    .dark .bg-rose-100 { background-color: rgba(120,40,50,0.4) !important; }
    .dark .bg-slate-100 { background-color: rgba(60,60,80,0.4) !important; }
    .dark .bg-blue-50 { background-color: rgba(30,50,100,0.4) !important; }
    
    /* Gradient backgrounds â†’ dark equivalents */
    .dark .from-indigo-50, .dark .from-blue-50 { --tw-gradient-from: #1e1e2e !important; }
    .dark .to-purple-50, .dark .to-indigo-50 { --tw-gradient-to: #2a2640 !important; }
    
    /* Shadows */
    .dark .shadow, .dark .shadow-lg, .dark .shadow-xl { 
      box-shadow: 0 2px 8px rgba(0,0,0,0.4) !important; 
    }
    
    /* Modals */
    .dark .dm-modal { background: #252536 !important; border: 1px solid #3a3a4e !important; }
    .dark .bg-black\/50 { background: rgba(0,0,0,0.7) !important; }
    
    /* Sidebar */
    .dark .dm-sidebar { background: #252536 !important; border-color: #3a3a4e !important; }

    /* Sidebar detail panel dark mode */
    .dark .bg-white\/80 { background-color: rgba(37,37,54,0.95) !important; }
    .dark .bg-white\/95 { background-color: rgba(37,37,54,0.98) !important; }
    .dark .bg-gray-50\/80 { background-color: rgba(42,42,60,0.8) !important; }
    .dark .bg-gray-200 { background-color: #3a3a50 !important; }

    /* Context menu & hover states in dark mode */
    .dark .hover\:bg-indigo-50:hover { background-color: rgba(80,70,140,0.3) !important; }
    .dark .hover\:bg-red-50:hover { background-color: rgba(120,40,40,0.3) !important; }
    .dark .hover\:bg-amber-50:hover { background-color: rgba(120,100,20,0.3) !important; }
    .dark .hover\:bg-green-50:hover { background-color: rgba(30,100,50,0.3) !important; }
    .dark .hover\:bg-purple-50:hover { background-color: rgba(80,50,120,0.3) !important; }
    .dark .hover\:bg-gray-50:hover { background-color: #35354a !important; }

    /* Toggle chips / pills in sidebar */
    .dark .bg-gray-50.border-gray-200 { background-color: #2a2a3e !important; border-color: #4a4a5e !important; }
    .dark .bg-blue-50.border-blue-300 { background-color: rgba(30,60,120,0.4) !important; }
    .dark .bg-orange-50.border-orange-300 { background-color: rgba(120,70,20,0.4) !important; }
    .dark .bg-green-50.border-green-300 { background-color: rgba(30,100,50,0.4) !important; }
    .dark .bg-amber-50.border-amber-300 { background-color: rgba(120,100,20,0.4) !important; }

    /* Progress bar bg */
    .dark .bg-gray-200.rounded-full { background-color: #3a3a50 !important; }
    .dark .bg-green-100.text-green-700 { background-color: rgba(30,100,50,0.3) !important; }
    .dark .bg-gray-100.text-gray-500 { background-color: #35354a !important; }
    
    /* Capacity bar dashed line */
    .dark [style*="border-top: 1.5px dashed"] { border-top-color: #666680 !important; }
    
    /* WP bar label text */
    .dark .text-gray-400 { color: #6a6a80 !important; }
    .dark .text-gray-500 { color: #8a8a9e !important; }
    .dark .text-gray-600 { color: #a0a0b0 !important; }
    .dark .text-gray-700 { color: #c0c0d0 !important; }
    
    /* Footer bar */
    .dark .dm-footer { background: #1a1a2e !important; border-color: #3a3a4e !important; }
    
    /* Smooth transition */
    .dark-transition { transition: background-color 0.3s ease, color 0.2s ease, border-color 0.3s ease; }
    /* Unified nav bar */
    .nav-bar { display: flex; gap: 6px; align-items: center; flex-wrap: nowrap; height: 40px; }
    .nav-bar button { white-space: nowrap; font-size: 13px; flex-shrink: 0; line-height: 1.2; height: 34px; display: inline-flex; align-items: center; justify-content: center; }
    /* Dispo grid scrollbars - always visible */
    .dispo-grid::-webkit-scrollbar { width: 12px; height: 12px; }
    .dispo-grid::-webkit-scrollbar-track { background: #f0f0f0; border-radius: 6px; }
    .dispo-grid::-webkit-scrollbar-thumb { background: #bbb; border-radius: 6px; border: 2px solid #f0f0f0; }
    .dispo-grid::-webkit-scrollbar-thumb:hover { background: #999; }
    .dispo-grid::-webkit-scrollbar-corner { background: #f0f0f0; }
    .dark .dispo-grid::-webkit-scrollbar-track { background: #1e1e32; }
    .dark .dispo-grid::-webkit-scrollbar-thumb { background: #4a4a6a; border-color: #1e1e32; }
    .dark .dispo-grid::-webkit-scrollbar-thumb:hover { background: #6a6a8a; }
    .dark .dispo-grid::-webkit-scrollbar-corner { background: #1e1e32; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // FIREBASE CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyBSPyPehsfFzYTL6Rdy7zVy2l-aLDunckI",
      authDomain: "kapazitaetsplanerhoffmann.firebaseapp.com",
      projectId: "kapazitaetsplanerhoffmann",
      storageBucket: "kapazitaetsplanerhoffmann.firebasestorage.app",
      messagingSenderId: "25183676841",
      appId: "1:25183676841:web:bb8ecbe3c6e185ca07bcb8"
    };

    // Firebase initialisieren
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    // Storage-Wrapper fÃ¼r Firebase (kompatibel mit alter window.storage API)
    window.storage = {
      async get(key) {
        try {
          const doc = await db.collection('data').doc(key).get();
          if (doc.exists) {
            return { key, value: doc.data().value };
          }
          return null;
        } catch (e) {
          console.error('Firebase get error:', e);
          return null;
        }
      },
      async set(key, value) {
        try {
          await db.collection('data').doc(key).set({ value, updated: new Date() });
          return { key, value };
        } catch (e) {
          console.error('Firebase set error:', e);
          return null;
        }
      }
    };

    // Lucide React Icons als inline SVG
    const Calendar = ({className, ...props}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
    );
    const Users = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
    );
    const LogOut = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
    );
    const Settings = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
    );
    const Plus = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14"/><path d="M12 5v14"/></svg>
    );
    const Trash2 = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
    );
    const GripVertical = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg>
    );
    const ChevronLeft = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m15 18-6-6 6-6"/></svg>
    );
    const ChevronRight = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m9 18 6-6-6-6"/></svg>
    );
    const StickyNote = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M15.5 3H5a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2V8.5L15.5 3Z"/><path d="M15 3v6h6"/></svg>
    );
    const BarChart3 = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>
    );
    const ChevronDown = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m6 9 6 6 6-6"/></svg>
    );
    const ChevronUp = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m18 15-6-6-6 6"/></svg>
    );
    const Umbrella = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 12a10.06 10.06 1 0 0-20 0Z"/><path d="M12 12v8a2 2 0 0 0 4 0"/><path d="M12 2v1"/></svg>
    );
    const Eye = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
    );
    const Building2 = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></svg>
    );
    const ArrowRight = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
    );
    const Copy = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
    );
    const X = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
    );
    const CheckCircle2 = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>
    );
    const CircleIcon = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/></svg>
    );
    const Check = ({className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 6 9 17l-5-5"/></svg>
    );

const CapacityPlanner = () => {
  const [currentUser, setCurrentUser] = useState(null);
  const [users, setUsers] = useState([]);
  const [teams, setTeams] = useState([]);
  const [divisions, setDivisions] = useState([]); // NEU: Abteilungen
  const [departments, setDepartments] = useState([]);
  const [projects, setProjects] = useState([]);
  const [projectFolders, setProjectFolders] = useState([]); // NEU: Ordner fÃ¼r Projekte
  const [tasks, setTasks] = useState([]);
  const [notes, setNotes] = useState([]);
  const [vacations, setVacations] = useState([]);
  const [resourceDowntime, setResourceDowntime] = useState([]); // {id, resId, date, type: 'ausfall'|'wartung'|'sonstiges'}
  const [currentWeek, setCurrentWeek] = useState(() => {
    const now = new Date();
    const d = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  });
  const [currentYear] = useState(new Date().getFullYear());
  // Cross-tab sync via BroadcastChannel
  const [syncChannel] = useState(() => new BroadcastChannel('kapplan_sync'));
  
  // Presence system
  const [sessionId] = useState(() => 'sess_' + Math.random().toString(36).substr(2, 8));
  const [onlineUsers, setOnlineUsers] = useState([]);
  const prevPresenceRef = React.useRef('');
  const PRESENCE_COLORS = ['#ef4444','#3b82f6','#22c55e','#f59e0b','#8b5cf6','#ec4899','#14b8a6','#f97316'];
  const PRESENCE_ANIMALS = ['ðŸ¦«','ðŸ¦Š','ðŸ»','ðŸ¼','ðŸ¦','ðŸ¨','ðŸ¯','ðŸ¦','ðŸ¸','ðŸ¦‰','ðŸ™','ðŸ¦‹','ðŸ¬','ðŸ¦„','ðŸº','ðŸ¦ˆ'];
  const myAnimalEmoji = PRESENCE_ANIMALS[sessionId.charCodeAt(sessionId.length - 1) % PRESENCE_ANIMALS.length];
  
  const [isAuthenticated, setIsAuthenticated] = useState(() => {
    try { return !!(new URLSearchParams(window.location.search).get('autoView')); } catch(e) { return false; }
  });
  const [passwordInput, setPasswordInput] = useState('');
  const [passwordError, setPasswordError] = useState(false);
  const [showLogin, setShowLogin] = useState(true);
  
  // ðŸ” PASSWORT HIER Ã„NDERN - dies ist das gemeinsame Team-Passwort
  const APP_PASSWORD = "Team2025";
  const [showSettings, setShowSettings] = useState(false);
  const [spOverlayMenu, setSpOverlayMenu] = useState(null); // {x, y, type:'pp'|'sp'|'dispo', projectId, wpId, projectName, wpName, userId}
  const [pendingHighlightWP, setPendingHighlightWP] = useState(null); // wpId to highlight when PP opens
  const [dayNoteEditor, setDayNoteEditor] = useState(null); // {userId, date, note?} for editing
  const [darkMode, setDarkMode] = useState(() => {
    try { return localStorage.getItem('kp5_dark') === '1'; } catch(e) { return false; }
  });
  React.useEffect(() => { try { localStorage.setItem('kp5_dark', darkMode ? '1' : '0'); } catch(e) {} }, [darkMode]);
  const [showAdmin, setShowAdmin] = useState(false);
  const [showDbTool, setShowDbTool] = useState(false);
  const [adminExpandedUsers, setAdminExpandedUsers] = useState({});
  const [adminExpandedResources, setAdminExpandedResources] = useState({});
  const [adminUserSort, setAdminUserSort] = useState('recent');
  const [adminResourceSort, setAdminResourceSort] = useState('recent');
  const [showDashboard, setShowDashboard] = useState(false);
  const [showProjectDashboard, setShowProjectDashboard] = useState(false); // Projektdashboard
  const [showProjectPlanning, setShowProjectPlanning] = useState(false); // NEU: Projektplanung
  const [showResourceCockpit, setShowResourceCockpit] = useState(false); // Ressourcencockpit (fullscreen workload)
  const [showDisposition, setShowDisposition] = useState(false); // Disposition (Excel-Style)
  const [dispoLayers, setDispoLayers] = useState({ pp: true, sp: true, dispo: true }); // persist across re-renders
  const dispoScrollPos = React.useRef({ left: 0, top: 0 }); // persist scroll across remounts
  const [dispositions, setDispositions] = useState([]); // [{id, userId, date, projectId, label, color, type}]
  const [dayNotes, setDayNotes] = useState([]); // [{id, userId, date, text, icon, color}]
  const cockpitPrevSettings = React.useRef(null);
  React.useEffect(() => {
    if (showResourceCockpit) {
      // Save current settings, apply cockpit defaults
      cockpitPrevSettings.current = { zoom: ganttZoomLevel, wlZoom: workloadZoom, fontSize: wlFontSize, expandedGroups: {...workloadExpandedGroups}, expandedUsers: {...workloadExpandedUsers} };
      setGanttZoomLevel(100);
      setWorkloadZoom(80);
      setWlFontSize(15);
      // Detail level 5: expand everything
      const newGroups = { ...workloadExpandedGroups };
      const newUsers = {};
      departments.forEach(d => { newGroups['wl_dept_' + d.id] = true; });
      divisions.forEach(d => { newGroups['wl_' + d.id] = true; });
      teams.forEach(t => { newGroups['wl_team_' + t.id] = true; });
      users.forEach(u => { newUsers[u.id] = true; });
      newGroups['wl_orphan'] = true;
      ['maschine', 'fahrzeug', 'werkzeug'].forEach(t => { newGroups['wl_res_' + t] = true; });
      newGroups['wl_res_header'] = true;
      resources.forEach(r => { newUsers['res_' + r.id] = true; });
      setWorkloadExpandedGroups(newGroups);
      setWorkloadExpandedUsers(newUsers);
    } else if (cockpitPrevSettings.current) {
      // Restore previous settings
      setGanttZoomLevel(cockpitPrevSettings.current.zoom);
      setWorkloadZoom(cockpitPrevSettings.current.wlZoom);
      setWlFontSize(cockpitPrevSettings.current.fontSize);
      setWorkloadExpandedGroups(cockpitPrevSettings.current.expandedGroups);
      setWorkloadExpandedUsers(cockpitPrevSettings.current.expandedUsers);
      cockpitPrevSettings.current = null;
    }
  }, [showResourceCockpit]);

  // URL parameter auto-navigation (for "open in new tab" feature)
  React.useEffect(() => {
    const params = new URLSearchParams(window.location.search);
    const autoView = params.get('autoView');
    const autoUser = params.get('autoUser');
    const autoProject = params.get('autoProject');
    if (autoView && users.length > 0) {
      // Auto-authenticate and login
      if (!isAuthenticated) setIsAuthenticated(true);
      const targetUser = autoUser ? users.find(u => u.id === autoUser) : users[0];
      if (targetUser && (showLogin || !currentUser)) {
        setCurrentUser(targetUser);
        setShowLogin(false);
        setTimeout(() => {
          if (autoView === 'projektplanung') {
            setShowDashboard(false); setShowProjectPlanning(true); setShowResourceCockpit(false); setShowDisposition(false);
            if (autoProject) {
              setGanttSelectedProjectId(autoProject);
              setGanttSelectedFolderId(null);
            }
          } else if (autoView === 'schnellplanung') {
            setShowDashboard(false); setShowProjectPlanning(false); setShowResourceCockpit(false); setShowDisposition(false);
          } else if (autoView === 'disposition') {
            setShowDashboard(false); setShowProjectPlanning(false); setShowResourceCockpit(false); setShowDisposition(true);
          } else if (autoView === 'ressourcencockpit') {
            setShowDashboard(false); setShowProjectPlanning(false); setShowResourceCockpit(true); setShowDisposition(false);
          }
        }, 100);
        // Clean URL without reload
        window.history.replaceState({}, '', window.location.pathname);
      }
    }
  }, [users.length]);
  const [projectPlanningView, setProjectPlanningView] = useState('projects'); // 'projects' oder 'resources'
  const [projectPhases, setProjectPhases] = useState([]); // Projekt-Phasen fÃ¼r Gantt
  const [workPackages, setWorkPackages] = useState([]); // NEU: Arbeitspakete unter Phasen
  const [dependencies, setDependencies] = useState([]); // NEU: AbhÃ¤ngigkeiten zwischen APs
  const [resources, setResources] = useState([]); // NEU: Ressourcen (Maschinen, Werkzeuge, Fahrzeuge)
  const [timelineScroll, setTimelineScroll] = useState(0); // NEU: Scroll-Position fÃ¼r Timeline
  const [dayWidth, setDayWidth] = useState(15); // NEU: Breite pro Tag (Zoom) - Standard 15px
  const [expandedProjects, setExpandedProjects] = useState({}); // Aufklapp-Status der Projekte
  const [expandedPhases, setExpandedPhases] = useState({}); // Aufklapp-Status der Phasen
  const [draggedProject, setDraggedProject] = useState(null);
  const [draggedTask, setDraggedTask] = useState(null);
  const [resizingTask, setResizingTask] = useState(null);
  const isDraggingRef = React.useRef(false);
  const isScrollingRef = React.useRef(false);
  const scrollTimeoutRef = React.useRef(null);
  // Keep ref in sync with drag state (so intervals can read it without stale closures)
  useEffect(() => { isDraggingRef.current = !!(draggedTask || draggedProject || resizingTask); }, [draggedTask, draggedProject, resizingTask]);

  // Detect scrolling (wheel/touch) to pause sync during scroll momentum
  useEffect(() => {
    const onWheel = () => {
      isScrollingRef.current = true;
      clearTimeout(scrollTimeoutRef.current);
      scrollTimeoutRef.current = setTimeout(() => { isScrollingRef.current = false; }, 800);
    };
    window.addEventListener('wheel', onWheel, { passive: true });
    window.addEventListener('touchmove', onWheel, { passive: true });
    return () => { window.removeEventListener('wheel', onWheel); window.removeEventListener('touchmove', onWheel); };
  }, []);
  const [fontSize, setFontSize] = useState(12);
  const [dashboardFontSize, setDashboardFontSize] = useState(10); // SchriftgrÃ¶ÃŸe fÃ¼r Dashboard
  const [expandedNotes, setExpandedNotes] = useState({});
  const [expandedMembers, setExpandedMembers] = useState({});
  const [selectedUser, setSelectedUser] = useState(null);
  const [detailViewUser, setDetailViewUser] = useState(null);
  const [projectSearchText, setProjectSearchText] = useState('');
  
  // Projektdashboard Filter (persistent pro User)
  const [projectDashboardFilters, setProjectDashboardFilters] = useState({
    department: 'all',
    division: 'all',
    team: 'all',
    user: 'all',
    projectSearch: ''
  });
  
  // History & Undo/Redo States
  const [historyLog, setHistoryLog] = useState([]);
  const [showHistory, setShowHistory] = useState(false);
  const [sidebarWPId, setSidebarWPId] = useState(null); // Sidebar fÃ¼r Projektplanung
  const [filterAssigned, setFilterAssigned] = useState({ responsibles: false, editors: false, divisions: false, maschinen: false, fahrzeuge: false, werkzeuge: false });
  const [resizeMode, setResizeMode] = useState('magnetic'); // 'magnetic' oder 'rigid'
  const [baselines, setBaselines] = useState([]); // Gespeicherte Baselines
  const [activeBaseline, setActiveBaseline] = useState(null); // Aktuell angezeigte Baseline
  const [ganttZoomLevel, setGanttZoomLevel] = useState(100); // Breite fÃ¼r Gantt (25-250%)
  const [ganttHeightZoom, setGanttHeightZoom] = useState(100); // HÃ¶he fÃ¼r Gantt (20-200%)
  const [ganttLeftPanelWidth, setGanttLeftPanelWidth] = useState(480); // Breite der linken Liste
  const [ganttColumnWidths, setGanttColumnWidths] = useState({ 
    start: 70,  // Start-Spalte
    end: 70,    // Ende-Spalte
    hours: 50,  // Plan h-Spalte
    days: 40    // KT-Spalte
  }); // Individuelle Spaltenbreiten
  const [ganttVisibleColumns, setGanttVisibleColumns] = useState({ start: true, end: true, hours: true, days: true }); // Sichtbare Spalten
  const [ganttProjectSidebarCollapsed, setGanttProjectSidebarCollapsed] = useState(false); // Projekt-Sidebar eingeklappt
  const [showProjectBarsOnly, setShowProjectBarsOnly] = useState(false); // Nur Projekt-Ãœbersicht
  const [ganttSelectedProjectId, setGanttSelectedProjectId] = useState(null); // AusgewÃ¤hltes Projekt
  const [ganttSelectedFolderId, setGanttSelectedFolderId] = useState(null); // AusgewÃ¤hlter Ordner
  const [ganttDetailsCollapsed, setGanttDetailsCollapsed] = useState(false); // Details-Panel eingeklappt
  const [detailsFloating, setDetailsFloating] = useState(false); // Details als schwebendes Fenster
  const [floatingPos, setFloatingPos] = useState({ x: 200, y: 80 }); // Position des schwebenden Fensters
  const [floatingSize, setFloatingSize] = useState({ w: 340, h: 500 }); // GrÃ¶ÃŸe des schwebenden Fensters
  const [detailViewMode, setDetailViewMode] = useState('compact'); // 'compact' (stacked) oder 'wide' (2-col)
  const [workloadPanelHeight, setWorkloadPanelHeight] = useState(0); // 0 = geschlossen
  const [workloadExpandedGroups, setWorkloadExpandedGroups] = useState({});
  const [ganttExpandedPackages, setGanttExpandedPackages] = useState({}); // Auf-/Zuklapp-Status der Arbeitspakete
  const [workloadExpandedUsers, setWorkloadExpandedUsers] = useState({});
  const [workloadFilter, setWorkloadFilter] = useState('ma_ressourcen');
  const [workloadZoom, setWorkloadZoom] = useState(90);
  const [wlFontSize, setWlFontSize] = useState(14); // Einheitliche SchriftgrÃ¶ÃŸe (8-36px)
  const [wlDecimals, setWlDecimals] = useState(0); // Dezimalstellen (0, 1, 2)
  const [wlBarMode, setWlBarMode] = useState('bar'); // 'bar' | 'number' | 'indicator'
  const [wlCustomPresets, setWlCustomPresets] = useState(() => { try { const raw = JSON.parse(localStorage.getItem('kp5_wlPresets') || '[]'); return Array.isArray(raw) ? raw.map(p => ({...p, userIds: p.userIds || [], resourceIds: p.resourceIds || []})) : []; } catch { return []; } });
  const [wlActivePreset, setWlActivePreset] = useState(null); // active preset id
  const [wlPresetModal, setWlPresetModal] = useState(null); // {id?, name, userIds:[], resourceIds:[]} or null
  const [wlPresetDropdown, setWlPresetDropdown] = useState(false);
  React.useEffect(() => { try { localStorage.setItem('kp5_wlPresets', JSON.stringify(wlCustomPresets)); } catch {} }, [wlCustomPresets]);
  const [colorThresholds, setColorThresholds] = useState({ green: 0, blue: 60, orange: 80, red: 100 }); // Auslastungs-Farbstufen in %
  const [wlFocusWP, setWlFocusWP] = useState(null); // { wpId, wpName, userIds: [], color } - Feinplanung-Filter
  const [wlFocusShowAll, setWlFocusShowAll] = useState(true); // true = alle APs des MA zeigen, false = nur fokussiertes AP
  const [highlightedDays, setHighlightedDays] = useState({}); // { "2026-02-14": "#fbbf24" } - Hervorgehobene Tage
  const [holidays, setHolidays] = useState({}); // Freie Tage: { "2026-02-16": { type: "feiertag", name: "Rosenmontag" } }
  
  // Freie Tage laden
  useEffect(() => {
    const loadHolidays = async () => {
      try {
        const saved = await window.storage.get('ganttHolidays', true);
        if (saved) setHolidays(JSON.parse(saved.value));
      } catch (e) { /* ignore */ }
    };
    loadHolidays();
  }, []);
  
  // Freie Tage speichern
  const saveHolidays = async (h) => {
    setHolidays(h);
    try {
      await window.storage.set('ganttHolidays', JSON.stringify(h), true);
      syncChannel.postMessage('ganttHolidays'); bumpSyncVersion();
    } catch (e) { /* ignore */ }
  };
  
  // Hervorgehobene Tage laden
  useEffect(() => {
    const load = async () => {
      try {
        const saved = await window.storage.get('highlightedDays', true);
        if (saved) setHighlightedDays(JSON.parse(saved.value));
      } catch (e) { /* ignore */ }
    };
    load();
  }, []);
  
  const saveHighlightedDays = async (h) => {
    setHighlightedDays(h);
    try { await window.storage.set('highlightedDays', JSON.stringify(h), true); syncChannel.postMessage('highlightedDays'); bumpSyncVersion(); } catch (e) { /* ignore */ }
  };
  
  // Baselines beim Start laden
  useEffect(() => {
    const loadBaselines = async () => {
      try {
        const saved = await window.storage.get('wpBaselines', true);
        if (saved) setBaselines(JSON.parse(saved.value));
      } catch (e) { /* ignore */ }
    };
    loadBaselines();
  }, []);
  
  const [undoStack, setUndoStack] = useState([]);
  const [redoStack, setRedoStack] = useState([]);
  const maxUndoSteps = 50; // Maximale Anzahl Undo-Schritte
  
  // Refs fÃ¼r Scroll-Position
  const ganttScrollRef = useRef(null);
  const [savedScrollPosition, setSavedScrollPosition] = useState(0);
  
  // Neue States fÃ¼r hierarchische Ãœbersichten
  const [expandedDepartments, setExpandedDepartments] = useState({});
  const [expandedTeams, setExpandedTeams] = useState({});

  // Ref fÃ¼r Admin-Panel Scroll-Position
  const adminScrollRef = useRef(null);
  const [lastScrollPosition, setLastScrollPosition] = useState(0);

  const WEEKS_TO_SHOW = 4;
  const SP_TOTAL_WEEKS = 26;
  const DW = 80, HH = 40;
  const GRID_START = 6;               // Gantt zeigt ab 6:00 â€¦
  const GRID_END   = 20;              // â€¦ bis 20:00
  const GRID_ROWS  = GRID_END - GRID_START; // 14 Zeilen
  
  // ðŸ“œ History & Undo/Redo Funktionen
  const createSnapshot = () => ({
    tasks: JSON.parse(JSON.stringify(tasks)),
    projects: JSON.parse(JSON.stringify(projects)),
    users: JSON.parse(JSON.stringify(users)),
    vacations: JSON.parse(JSON.stringify(vacations)),
    resourceDowntime: JSON.parse(JSON.stringify(resourceDowntime)),
    notes: JSON.parse(JSON.stringify(notes))
  });
  
  const saveSnapshot = () => {
    const snapshot = createSnapshot();
    setUndoStack(prev => [snapshot, ...prev].slice(0, maxUndoSteps));
    setRedoStack([]); // Redo-Stack leeren bei neuer Aktion
  };
  
  const addToHistory = (action, details) => {
    const entry = {
      id: Date.now(),
      timestamp: new Date().toISOString(),
      action, // z.B. 'task_create', 'task_move', 'vacation_set'
      userName: currentUser?.name || 'Unbekannt',
      userId: currentUser?.id,
      details
    };
    setHistoryLog(prev => [entry, ...prev].slice(0, 200)); // Max 200 EintrÃ¤ge
  };
  
  const undo = () => {
    if (undoStack.length === 0) return;
    
    const currentSnapshot = createSnapshot();
    setRedoStack(prev => [currentSnapshot, ...prev].slice(0, maxUndoSteps));
    
    const previousState = undoStack[0];
    setTasks(previousState.tasks);
    setProjects(previousState.projects);
    setUsers(previousState.users);
    setVacations(previousState.vacations);
    if (previousState.resourceDowntime) setResourceDowntime(previousState.resourceDowntime);
    setNotes(previousState.notes);
    setUndoStack(prev => prev.slice(1));
    
    addToHistory('undo', { info: 'Aktion rÃ¼ckgÃ¤ngig gemacht' });
  };
  
  const redo = () => {
    if (redoStack.length === 0) return;
    
    const currentSnapshot = createSnapshot();
    setUndoStack(prev => [currentSnapshot, ...prev].slice(0, maxUndoSteps));
    
    const nextState = redoStack[0];
    setTasks(nextState.tasks);
    setProjects(nextState.projects);
    setUsers(nextState.users);
    setVacations(nextState.vacations);
    if (nextState.resourceDowntime) setResourceDowntime(nextState.resourceDowntime);
    setNotes(nextState.notes);
    setRedoStack(prev => prev.slice(1));
    
    addToHistory('redo', { info: 'Aktion wiederhergestellt' });
  };
  
  // Standard: Vollzeit mit ZWEI Pausen
  const DEFAULT_SCHEDULE = {
    1: {start:8, end:17, break1Start:9, break1Duration:0.25, break2Start:12.5, break2Duration:0.75},
    2: {start:8, end:17, break1Start:9, break1Duration:0.25, break2Start:12.5, break2Duration:0.75},
    3: {start:8, end:17, break1Start:9, break1Duration:0.25, break2Start:12.5, break2Duration:0.75},
    4: {start:8, end:17, break1Start:9, break1Duration:0.25, break2Start:12.5, break2Duration:0.75},
    5: {start:8, end:17, break1Start:9, break1Duration:0.25, break2Start:12.5, break2Duration:0.75},
    6: {start:0, end:0, break1Start:0, break1Duration:0, break2Start:0, break2Duration:0},
    0: {start:0, end:0, break1Start:0, break1Duration:0, break2Start:0, break2Duration:0}
  };

  // 8.5  â†’  "08:30"   |   "08:30"  â†’  8.5
  const h2t = (h) => { const hh=Math.floor(h), mm=Math.round((h-hh)*60); return `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`; };
  const t2h = (s) => { const [h,m]=s.split(':').map(Number); return h+m/60; };
  
  // Smart Time Formatter - wandelt verschiedene Eingaben in HH:MM um
  const formatTimeInput = (input) => {
    if (!input) return '';
    
    // Nur Zahlen extrahieren
    const digits = input.replace(/[^0-9]/g, '');
    if (digits.length === 0) return '';
    
    // Verschiedene Formate handhaben
    if (digits.length === 1) {
      // "6" â†’ "06:00"
      return `${digits.padStart(2, '0')}:00`;
    } else if (digits.length === 2) {
      // "63" â†’ "06:30" oder "12" â†’ "12:00"
      const num = parseInt(digits);
      if (num > 23) {
        // Wahrscheinlich HM statt HH (z.B. 63 = 6:30)
        const h = digits[0];
        const m = digits[1] + '0';
        return `${h.padStart(2, '0')}:${m}`;
      } else {
        return `${digits}:00`;
      }
    } else if (digits.length === 3) {
      // "630" â†’ "06:30"
      const h = digits[0];
      const m = digits.substring(1);
      return `${h.padStart(2, '0')}:${m}`;
    } else if (digits.length >= 4) {
      // "1230" â†’ "12:30"
      const h = digits.substring(0, 2);
      const m = digits.substring(2, 4);
      return `${h}:${m}`;
    }
    
    return input;
  };

  // PrÃ¼fe ob eine Stunde in einer Pausenzeit liegt (ZWEI Pausen mÃ¶glich!)
  const isBreakHour = (user, date, hour) => {
    if (!date) return false;
    const dayNum = date.getDay();
    const sched = (user.dailySchedule || DEFAULT_SCHEDULE)[dayNum];
    if (!sched || (sched.start === 0 && sched.end === 0)) return false;
    
    // Pause 1 (z.B. 09:00-09:15)
    const break1Start = sched.break1Start || 0;
    const break1Duration = sched.break1Duration || 0;
    const break1End = break1Start + break1Duration;
    
    // Pause 2 (z.B. 12:30-13:15)
    const break2Start = sched.break2Start || 0;
    const break2Duration = sched.break2Duration || 0;
    const break2End = break2Start + break2Duration;
    
    // Teilzeit-Logik: Wenn Arbeitsende vor 13:00, dann Mittagspause entfÃ¤llt
    const workEnd = sched.end || 17;
    const hasBreak2 = workEnd > 13 && break2Duration > 0;
    
    // PrÃ¼fe ob Stunde in einer der Pausen liegt
    const inBreak1 = break1Duration > 0 && hour >= break1Start && hour < break1End;
    const inBreak2 = hasBreak2 && hour >= break2Start && hour < break2End;
    
    return inBreak1 || inBreak2;
  };
  
  // Berechne Netto-Stunden (Brutto minus ALLE PausenÃ¼berschneidungen)
  const calculateNetHours = (startHour, endHour, startDate, endDate, userId) => {
    const start = new Date(startDate + 'T12:00:00');
    const end = new Date(endDate + 'T12:00:00');
    const days = Math.round((end - start) / 86400000) + 1;
    const user = users.find(u => u.id === userId);
    
    let totalGross = 0;
    let totalBreak = 0;
    
    for (let d = 0; d < days; d++) {
      const currentDate = new Date(start);
      currentDate.setDate(start.getDate() + d);
      const dayNum = currentDate.getDay();
      
      // Wochenende Ã¼berspringen
      if (dayNum === 0 || dayNum === 6) continue;
      
      const sched = (user?.dailySchedule || DEFAULT_SCHEDULE)[dayNum];
      if (!sched) continue;
      
      const dayGross = endHour - startHour;
      totalGross += dayGross;
      
      // Pause 1 Ãœberschneidung
      const break1Start = sched.break1Start || 0;
      const break1Duration = sched.break1Duration || 0;
      const break1End = break1Start + break1Duration;
      
      if (break1Duration > 0) {
        const overlap1Start = Math.max(startHour, break1Start);
        const overlap1End = Math.min(endHour, break1End);
        if (overlap1Start < overlap1End) {
          totalBreak += (overlap1End - overlap1Start);
        }
      }
      
      // Pause 2 Ãœberschneidung (nur wenn nicht Teilzeit)
      const workEnd = sched.end || 17;
      const hasBreak2 = workEnd > 13;
      
      if (hasBreak2) {
        const break2Start = sched.break2Start || 0;
        const break2Duration = sched.break2Duration || 0;
        const break2End = break2Start + break2Duration;
        
        if (break2Duration > 0) {
          const overlap2Start = Math.max(startHour, break2Start);
          const overlap2End = Math.min(endHour, break2End);
          if (overlap2Start < overlap2End) {
            totalBreak += (overlap2End - overlap2Start);
          }
        }
      }
    }
    
    return {
      gross: totalGross,
      break: totalBreak,
      net: totalGross - totalBreak
    };
  };

  // Berechne Netto-Stunden fÃ¼r einen EINZELNEN Tag (fÃ¼r Dashboard Tages-Anzeige)
  const calculateDayNetHours = (userId, date, startHour, endHour) => {
    const user = users.find(u => u.id === userId);
    const dayNum = date.getDay();
    
    // Wochenende = 0 Stunden
    if (dayNum === 0 || dayNum === 6) return 0;
    
    const sched = (user?.dailySchedule || DEFAULT_SCHEDULE)[dayNum];
    if (!sched) return 0;
    
    let netHours = endHour - startHour;
    
    // Pause 1 abziehen falls Ãœberschneidung
    const break1Start = sched.break1Start;
    const break1Duration = sched.break1Duration || 0;
    if (break1Start !== undefined && break1Duration > 0) {
      const break1End = break1Start + break1Duration;
      const overlap1Start = Math.max(startHour, break1Start);
      const overlap1End = Math.min(endHour, break1End);
      if (overlap1Start < overlap1End) {
        netHours -= (overlap1End - overlap1Start);
      }
    }
    
    // Pause 2 abziehen falls Ãœberschneidung (nur bei Vollzeit)
    const workEnd = sched.end || 17;
    if (workEnd > 13) {
      const break2Start = sched.break2Start;
      const break2Duration = sched.break2Duration || 0;
      if (break2Start !== undefined && break2Duration > 0) {
        const break2End = break2Start + break2Duration;
        const overlap2Start = Math.max(startHour, break2Start);
        const overlap2End = Math.min(endHour, break2End);
        if (overlap2Start < overlap2End) {
          netHours -= (overlap2End - overlap2Start);
        }
      }
    }
    
    return netHours;
  };


  useEffect(() => {
    const init = async () => {
      try {
        // Migration: If shared storage is empty but personal data exists, copy it over
        const sharedCheck = await window.storage.get('users', true).catch(() => null);
        if (!sharedCheck) {
          const personalCheck = await window.storage.get('users', false).catch(() => null);
          if (personalCheck) {
            console.log('ðŸ”„ Migrating personal data to shared storage...');
            const keysToMigrate = ['users','teams','divisions','departments','projects','projectFolders','tasks','notes','vacations','resourceDowntime','projectPhases','workPackages','dependencies','resources','ganttHolidays','highlightedDays','wpBaselines','colorThresholds'];
            for (const key of keysToMigrate) {
              try {
                const personal = await window.storage.get(key, false).catch(() => null);
                if (personal) await window.storage.set(key, personal.value, true);
              } catch (e) { /* skip */ }
            }
            console.log('âœ… Migration complete!');
          }
        }
        
        const u = await window.storage.get('users', true).catch(() => null);
        const du = [
          { id: 'admin', name: 'Admin', role: 'admin', teamId: null, teamRole: null, departmentId: null },
          { id: 'p1', name: 'Person 1', role: 'member', teamId: 'team1', teamRole: 'lead', weeklyCapacity: 40, departmentId: null },
          { id: 'p2', name: 'Person 2', role: 'member', teamId: 'team1', teamRole: 'responsible', weeklyCapacity: 40, departmentId: null },
          { id: 'p3', name: 'Person 3', role: 'member', teamId: 'team1', teamRole: 'editor', weeklyCapacity: 40, departmentId: null },
          { id: 'p4', name: 'Person 4 (Bereichsleiter)', role: 'member', teamId: 'team2', teamRole: 'department_head', weeklyCapacity: 40, departmentId: 'dept1' },
          { id: 'p5', name: 'Person 5', role: 'member', teamId: 'team2', teamRole: 'editor', weeklyCapacity: 40, departmentId: null },
          { id: 'p6', name: 'Person 6 (Unternehmer)', role: 'member', teamId: null, teamRole: 'entrepreneur', weeklyCapacity: 40, departmentId: null }
        ];
        setUsers(u ? JSON.parse(u.value) : du);
        if (!u) await window.storage.set('users', JSON.stringify(du), true);

        const t = await window.storage.get('teams', true).catch(() => null);
        const dt = [
          { id: 'team1', name: 'Team Alpha', divisionId: 'div1' },
          { id: 'team2', name: 'Team Beta', divisionId: 'div1' }
        ];
        setTeams(t ? JSON.parse(t.value) : dt);
        if (!t) await window.storage.set('teams', JSON.stringify(dt), true);

        const div = await window.storage.get('divisions', true).catch(() => null);
        const ddiv = [
          { id: 'div1', name: 'Abteilung 1', departmentId: 'dept1' },
          { id: 'div2', name: 'Abteilung 2', departmentId: 'dept1' }
        ];
        setDivisions(div ? JSON.parse(div.value) : ddiv);
        if (!div) await window.storage.set('divisions', JSON.stringify(ddiv), true);

        const d = await window.storage.get('departments', true).catch(() => null);
        const dd = [
          { id: 'dept1', name: 'Bereich Nord' },
          { id: 'dept2', name: 'Bereich SÃ¼d' }
        ];
        setDepartments(d ? JSON.parse(d.value) : dd);
        if (!d) await window.storage.set('departments', JSON.stringify(dd), true);

        const p = await window.storage.get('projects', true).catch(() => null);
        const dp = [
          { id: 'p1', name: 'Projekt A', color: '#22c55e' },
          { id: 'p2', name: 'Projekt B', color: '#ef4444' },
          { id: 'p3', name: 'Projekt C', color: '#3b82f6' }
        ];
        setProjects(p ? JSON.parse(p.value) : dp);
        if (!p) await window.storage.set('projects', JSON.stringify(dp), true);

        const pf = await window.storage.get('projectFolders', true).catch(() => null);
        if (pf) setProjectFolders(JSON.parse(pf.value));

        const tk = await window.storage.get('tasks', true).catch(() => null);
        if (tk) setTasks(JSON.parse(tk.value));

        const n = await window.storage.get('notes', true).catch(() => null);
        if (n) setNotes(JSON.parse(n.value));

        const v = await window.storage.get('vacations', true).catch(() => null);
        if (v) setVacations(JSON.parse(v.value));
        const rdt = await window.storage.get('resourceDowntime', true).catch(() => null);
        if (rdt) setResourceDowntime(JSON.parse(rdt.value));
        
        const pp = await window.storage.get('projectPhases', true).catch(() => null);
        if (pp) setProjectPhases(JSON.parse(pp.value));
        
        const wp = await window.storage.get('workPackages', true).catch(() => null);
        if (wp) setWorkPackages(JSON.parse(wp.value));
        
        const deps = await window.storage.get('dependencies', true).catch(() => null);
        if (deps) setDependencies(JSON.parse(deps.value));
        
        const res = await window.storage.get('resources', true).catch(() => null);
        if (res) setResources(JSON.parse(res.value));
        
        const ct = await window.storage.get('colorThresholds', true).catch(() => null);
        if (ct) setColorThresholds(JSON.parse(ct.value));
        
        const disp = await window.storage.get('dispositions', true).catch(() => null);
        if (disp) setDispositions(JSON.parse(disp.value));
        const dn = await window.storage.get('dayNotes', true).catch(() => null);
        if (dn) setDayNotes(JSON.parse(dn.value));
      } catch (e) { console.error('Init error:', e); }
    };
    init();
  }, []);

  // Cross-tab sync: reload changed data when another tab saves (instant, same browser)
  useEffect(() => {
    const keySetterMap = {
      users: setUsers, teams: setTeams, divisions: setDivisions, departments: setDepartments,
      projects: setProjects, projectFolders: setProjectFolders, tasks: setTasks, notes: setNotes,
      vacations: setVacations, resourceDowntime: setResourceDowntime, projectPhases: setProjectPhases,
      workPackages: setWorkPackages, dependencies: setDependencies, resources: setResources,
      ganttHolidays: setHolidays, highlightedDays: setHighlightedDays, colorThresholds: setColorThresholds,
      dispositions: setDispositions,
      dayNotes: setDayNotes
    };
    const handler = async (e) => {
      if (isDraggingRef.current || isScrollingRef.current) return; // Don't interrupt drag/scroll
      const key = e.data;
      const setter = keySetterMap[key];
      if (!setter) return;
      try {
        const result = await window.storage.get(key, true);
        if (result) setter(JSON.parse(result.value));
        // Update version ref so poll doesn't redundantly reload
        const vResult = await window.storage.get('_syncVersion', true).catch(() => null);
        if (vResult) syncVersionRef.current = JSON.parse(vResult.value);
      } catch (err) { /* ignore */ }
    };
    syncChannel.addEventListener('message', handler);
    return () => syncChannel.removeEventListener('message', handler);
  }, [syncChannel]);

  // === OPTIMIZED SYNC: Version-based polling (1-2 reads instead of 16) ===
  const [lastSync, setLastSync] = useState(null);
  const syncVersionRef = React.useRef(0);
  
  // Increment version on every save (called from save functions)
  const bumpSyncVersion = async () => {
    try {
      syncVersionRef.current = Date.now();
      await window.storage.set('_syncVersion', JSON.stringify(syncVersionRef.current), true);
    } catch (e) { /* ignore */ }
  };
  
  useEffect(() => {
    const keySetterMap = {
      users: setUsers, teams: setTeams, divisions: setDivisions, departments: setDepartments,
      projects: setProjects, projectFolders: setProjectFolders, tasks: setTasks, notes: setNotes,
      vacations: setVacations, resourceDowntime: setResourceDowntime, projectPhases: setProjectPhases,
      workPackages: setWorkPackages, dependencies: setDependencies, resources: setResources,
      ganttHolidays: setHolidays, colorThresholds: setColorThresholds, dispositions: setDispositions
    };
    
    const reloadAll = async () => {
      for (const [key, setter] of Object.entries(keySetterMap)) {
        const result = await window.storage.get(key, true).catch(() => null);
        if (result) setter(JSON.parse(result.value));
      }
      // Remote-Daten empfangen â†’ Undo/Redo-Stack leeren um Konflikte zu vermeiden
      undoStackRef.current = [];
      redoStackRef.current = [];
    };
    
    const pollSync = async () => {
      try {
        if (isDraggingRef.current || isScrollingRef.current) return; // Don't interrupt drag/scroll
        // 1 read: check if version changed
        const vResult = await window.storage.get('_syncVersion', true).catch(() => null);
        const remoteVersion = vResult ? JSON.parse(vResult.value) : 0;
        if (remoteVersion > syncVersionRef.current) {
          syncVersionRef.current = remoteVersion;
          await reloadAll(); // Only reload when something changed
          setLastSync(new Date());
        }
      } catch (e) { /* ignore */ }
    };
    const interval = setInterval(pollSync, 5000);
    return () => clearInterval(interval);
  }, []);

  // === OPTIMIZED PRESENCE: Single shared key (2 ops per cycle) ===
  useEffect(() => {
    if (!isAuthenticated || !currentUser) return;
    
    const getCurrentView = () => {
      if (showDashboard) return 'grobplanung';
      if (showProjectDashboard) return 'teamdashboard';
      if (showProjectPlanning) return 'projektplanung';
      if (showResourceCockpit) return 'ressourcencockpit';
      if (showDisposition) return 'disposition';
      return 'grobplanung';
    };
    
    const syncPresence = async () => {
      try {
        if (isDraggingRef.current || isScrollingRef.current) return; // Don't interrupt drag/scroll
        // 1 read: get all presence data
        const result = await window.storage.get('_presence', true).catch(() => null);
        const allPresence = result ? JSON.parse(result.value) : {};
        const now = Date.now();
        
        // Update own entry
        allPresence[sessionId] = {
          sessionId,
          userId: currentUser.id,
          userName: currentUser.name || currentUser.id,
          view: getCurrentView(),
          selectedUserId: selectedUser?.id,
          selectedUserName: selectedUser?.name,
          lastSeen: now,
          color: PRESENCE_COLORS[currentUser.id.charCodeAt(currentUser.id.length - 1) % PRESENCE_COLORS.length],
          animal: myAnimalEmoji
        };
        
        // Clean stale + extract active others
        const active = [];
        let totalSessions = 0;
        for (const [sid, p] of Object.entries(allPresence)) {
          if (now - p.lastSeen > 30000) { delete allPresence[sid]; continue; }
          totalSessions++;
          if (sid !== sessionId && now - p.lastSeen < 20000) active.push(p);
        }
        
        // 1 write: save all presence
        await window.storage.set('_presence', JSON.stringify(allPresence), true);
        console.log(`[Presence] Sessions: ${totalSessions}, Others: ${active.length}, MyID: ${sessionId.slice(-4)}, MyAnimal: ${myAnimalEmoji}`);
        // Only update React state when user list/views change (NOT for cursor moves)
        const structureJson = JSON.stringify(active.map(a => a.sessionId + a.view + a.selectedUserId).sort());
        if (structureJson !== prevPresenceRef.current) {
          prevPresenceRef.current = structureJson;
          setOnlineUsers(active);
        }

      } catch (e) { /* ignore */ }
    };
    
    syncPresence();
    const presenceInterval = setInterval(syncPresence, 5000);
    
    return () => {
      clearInterval(presenceInterval);
      // Cleanup own presence on unmount
      (async () => {
        try {
          const result = await window.storage.get('_presence', true).catch(() => null);
          if (result) {
            const all = JSON.parse(result.value);
            delete all[sessionId];
            await window.storage.set('_presence', JSON.stringify(all), true);
          }
        } catch (e) { /* ignore */ }
      })();
    };
  }, [isAuthenticated, currentUser?.id, selectedUser?.id, showDashboard, showProjectDashboard, showProjectPlanning, showResourceCockpit, showDisposition]);

  useEffect(() => {
    if (currentUser && !selectedUser) setSelectedUser(currentUser);
    if (currentUser && selectedUser && currentUser.id !== selectedUser.id && currentUser.teamRole !== 'lead') {
      setSelectedUser(currentUser);
    }
  }, [currentUser]);

  // Scroll-Position nach State-Updates wiederherstellen
  useEffect(() => {
    if (ganttScrollRef.current && savedScrollPosition > 0) {
      ganttScrollRef.current.scrollLeft = savedScrollPosition;
      setSavedScrollPosition(0);
    }
  }, [tasks, expandedNotes, savedScrollPosition]);

  const getWeekDates = (w, y) => {
    try {
      // JahresÃ¼berlauf behandeln
      let week = parseInt(w) || 1;
      let year = parseInt(y) || 2025;
      while (week > 52) {
        week -= 52;
        year++;
      }
      while (week < 1) {
        week += 52;
        year--;
      }
      
      const s = new Date(year, 0, 1 + (week - 1) * 7);
      const d = s.getDay();
      const st = new Date(s);
      if (d <= 4) st.setDate(s.getDate() - s.getDay() + 1);
      else st.setDate(s.getDate() + 8 - s.getDay());
      const dates = [];
      for (let i = 0; i < 7; i++) {
        const dt = new Date(st);
        dt.setDate(st.getDate() + i);
        dt.setHours(12, 0, 0, 0);
        dates.push(dt);
      }
      return dates;
    } catch (e) {
      console.error('Date error:', e);
      return [];
    }
  };

  const formatDate = (d) => {
    const dt = new Date(d);
    const year = dt.getFullYear();
    const month = String(dt.getMonth() + 1).padStart(2, '0');
    const day = String(dt.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  };
  
  const getWeekNumber = (date) => {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  };

  const saveTasks = async (t) => { setTasks(t); await window.storage.set('tasks', JSON.stringify(t), true); syncChannel.postMessage('tasks'); bumpSyncVersion(); };
  const saveColorThresholds = async (ct) => { setColorThresholds(ct); await window.storage.set('colorThresholds', JSON.stringify(ct), true); syncChannel.postMessage('colorThresholds'); bumpSyncVersion(); };
  
  // Color tier helper: returns tier name based on ratio (0-1+) and thresholds
  const getColorTier = (ratio) => {
    const pct = ratio * 100;
    if (pct > colorThresholds.red) return 'red';
    if (pct > colorThresholds.orange) return 'orange';
    if (pct > colorThresholds.blue) return 'blue';
    return 'green';
  };
  const tierToHex = (tier) => ({ red: '#ef4444', orange: '#f59e0b', blue: '#6366f1', green: '#22c55e' }[tier] || '#22c55e');
  const pctTier = (pct) => getColorTier(pct / 100); // convenience for percentage values
  const saveProjects = async (p) => { setProjects(p); await window.storage.set('projects', JSON.stringify(p), true); syncChannel.postMessage('projects'); bumpSyncVersion(); };
  const saveProjectFolders = async (pf) => { setProjectFolders(pf); await window.storage.set('projectFolders', JSON.stringify(pf), true); syncChannel.postMessage('projectFolders'); bumpSyncVersion(); };
  const saveUsers = async (u) => { setUsers(u); await window.storage.set('users', JSON.stringify(u), true); syncChannel.postMessage('users'); bumpSyncVersion(); };
  const saveTeams = async (t) => { setTeams(t); await window.storage.set('teams', JSON.stringify(t), true); syncChannel.postMessage('teams'); bumpSyncVersion(); };
  const saveDivisions = async (d) => { setDivisions(d); await window.storage.set('divisions', JSON.stringify(d), true); syncChannel.postMessage('divisions'); bumpSyncVersion(); };
  const saveDepartments = async (d) => { setDepartments(d); await window.storage.set('departments', JSON.stringify(d), true); syncChannel.postMessage('departments'); bumpSyncVersion(); };
  const saveNotes = async (n) => { setNotes(n); await window.storage.set('notes', JSON.stringify(n), true); syncChannel.postMessage('notes'); bumpSyncVersion(); };
  const saveVacations = async (v) => { setVacations(v); await window.storage.set('vacations', JSON.stringify(v), true); syncChannel.postMessage('vacations'); bumpSyncVersion(); };
  const saveResourceDowntime = async (v) => { setResourceDowntime(v); await window.storage.set('resourceDowntime', JSON.stringify(v), true); syncChannel.postMessage('resourceDowntime'); bumpSyncVersion(); };
  
  const isResourceDown = (resId, date) => {
    const ds = typeof date === 'string' ? date : formatDate(date);
    return resourceDowntime.some(v => v.resId === resId && v.date === ds);
  };
  const getResourceDownType = (resId, date) => {
    const ds = typeof date === 'string' ? date : formatDate(date);
    const v = resourceDowntime.find(v => v.resId === resId && v.date === ds);
    return v?.type || 'ausfall';
  };
  const setResourceDownBatch = (resId, dateStrings, mode, type = 'ausfall') => {
    if (mode === 'add') {
      let updated = resourceDowntime.filter(v => !(v.resId === resId && dateStrings.includes(v.date)));
      const toAdd = dateStrings.map((ds, i) => ({ id: 'rd' + Date.now() + '_' + i, resId, date: ds, type }));
      saveResourceDowntime([...updated, ...toAdd]);
    } else {
      saveResourceDowntime(resourceDowntime.filter(v => !(v.resId === resId && dateStrings.includes(v.date))));
    }
  };
  const saveProjectPhases = async (pp) => { setProjectPhases(pp); await window.storage.set('projectPhases', JSON.stringify(pp), true); syncChannel.postMessage('projectPhases'); bumpSyncVersion(); };
  
  // === UNDO/REDO System (Snapshot, Stack wird bei Sync geleert) ===
  const undoStackRef = React.useRef([]);
  const redoStackRef = React.useRef([]);
  const undoSkipRef = React.useRef(false);
  
  const pushUndo = () => {
    if (undoSkipRef.current) return;
    undoStackRef.current.push({ wps: JSON.stringify(workPackages), deps: JSON.stringify(dependencies) });
    if (undoStackRef.current.length > 50) undoStackRef.current.shift();
    redoStackRef.current = [];
  };
  
  const saveWorkPackages = async (wp) => { pushUndo(); setWorkPackages(wp); await window.storage.set('workPackages', JSON.stringify(wp), true); syncChannel.postMessage('workPackages'); bumpSyncVersion(); };
  const saveDependencies = async (deps) => { pushUndo(); setDependencies(deps); await window.storage.set('dependencies', JSON.stringify(deps), true); syncChannel.postMessage('dependencies'); bumpSyncVersion(); };
  
  const performUndo = () => {
    if (undoStackRef.current.length === 0) return;
    const snapshot = undoStackRef.current.pop();
    redoStackRef.current.push({ wps: JSON.stringify(workPackages), deps: JSON.stringify(dependencies) });
    undoSkipRef.current = true;
    const wps = JSON.parse(snapshot.wps); const deps = JSON.parse(snapshot.deps);
    setWorkPackages(wps); setDependencies(deps);
    window.storage.set('workPackages', JSON.stringify(wps), true);
    window.storage.set('dependencies', JSON.stringify(deps), true);
    bumpSyncVersion();
    undoSkipRef.current = false;
  };
  
  const performRedo = () => {
    if (redoStackRef.current.length === 0) return;
    const snapshot = redoStackRef.current.pop();
    undoStackRef.current.push({ wps: JSON.stringify(workPackages), deps: JSON.stringify(dependencies) });
    undoSkipRef.current = true;
    const wps = JSON.parse(snapshot.wps); const deps = JSON.parse(snapshot.deps);
    setWorkPackages(wps); setDependencies(deps);
    window.storage.set('workPackages', JSON.stringify(wps), true);
    window.storage.set('dependencies', JSON.stringify(deps), true);
    bumpSyncVersion();
    undoSkipRef.current = false;
  };
  const saveResources = async (r) => { setResources(r); await window.storage.set('resources', JSON.stringify(r), true); syncChannel.postMessage('resources'); bumpSyncVersion(); };
  const saveDispositions = async (d) => { setDispositions(d); await window.storage.set('dispositions', JSON.stringify(d), true); syncChannel.postMessage('dispositions'); bumpSyncVersion(); };
  const saveDayNotes = async (dn) => { setDayNotes(dn); await window.storage.set('dayNotes', JSON.stringify(dn), true); syncChannel.postMessage('dayNotes'); bumpSyncVersion(); };
  
  // Predefined note types with icons and colors
  const NOTE_TYPES = [
    { icon: 'ðŸ”„', label: 'Wechsel', color: '#3b82f6' },
    { icon: 'ðŸ“‹', label: 'Info', color: '#6366f1' },
    { icon: 'ðŸŽ“', label: 'Schulung', color: '#8b5cf6' },
    { icon: 'ðŸ¥', label: 'Arzt', color: '#ec4899' },
    { icon: 'ðŸ”§', label: 'Wartung', color: '#f59e0b' },
    { icon: 'âš ï¸', label: 'Wichtig', color: '#ef4444' },
    { icon: 'ðŸ“ž', label: 'Termin', color: '#14b8a6' },
    { icon: 'âœˆï¸', label: 'Dienstreise', color: '#0ea5e9' },
    { icon: 'ðŸ“', label: 'Sonstiges', color: '#6b7280' },
  ];

  // Zeilen-Reihenfolge Ã¤ndern (Drag & Drop vertikal)
  const handleRowDrop = (draggedType, draggedId, targetType, targetId, position) => {
    if (draggedType === 'project' && targetType === 'project') {
      // Projekt verschieben
      const draggedIdx = projects.findIndex(p => p.id === draggedId);
      let targetIdx = projects.findIndex(p => p.id === targetId);
      if (draggedIdx === -1 || targetIdx === -1 || draggedIdx === targetIdx) return;
      
      const newProjects = [...projects];
      const [moved] = newProjects.splice(draggedIdx, 1);
      if (position === 'after') targetIdx = targetIdx >= draggedIdx ? targetIdx : targetIdx + 1;
      else targetIdx = targetIdx > draggedIdx ? targetIdx - 1 : targetIdx;
      newProjects.splice(targetIdx, 0, moved);
      
      // Order-Werte aktualisieren
      newProjects.forEach((p, i) => p.order = i);
      saveProjects(newProjects);
    }
    else if (draggedType === 'phase' && targetType === 'phase') {
      // Phase verschieben (nur innerhalb desselben Projekts)
      const draggedPhase = projectPhases.find(p => p.id === draggedId);
      const targetPhase = projectPhases.find(p => p.id === targetId);
      if (!draggedPhase || !targetPhase || draggedPhase.projectId !== targetPhase.projectId) return;
      
      const projectId = draggedPhase.projectId;
      const phasesInProject = projectPhases.filter(p => p.projectId === projectId);
      const otherPhases = projectPhases.filter(p => p.projectId !== projectId);
      
      const draggedIdx = phasesInProject.findIndex(p => p.id === draggedId);
      let targetIdx = phasesInProject.findIndex(p => p.id === targetId);
      if (draggedIdx === targetIdx) return;
      
      const [moved] = phasesInProject.splice(draggedIdx, 1);
      if (position === 'after') targetIdx = targetIdx >= draggedIdx ? targetIdx : targetIdx + 1;
      else targetIdx = targetIdx > draggedIdx ? targetIdx - 1 : targetIdx;
      phasesInProject.splice(targetIdx, 0, moved);
      
      phasesInProject.forEach((p, i) => p.order = i);
      saveProjectPhases([...otherPhases, ...phasesInProject]);
    }
    else if (draggedType === 'wp' && targetType === 'wp') {
      // Arbeitspaket verschieben (nur innerhalb derselben Phase)
      const draggedWP = workPackages.find(w => w.id === draggedId);
      const targetWP = workPackages.find(w => w.id === targetId);
      if (!draggedWP || !targetWP || draggedWP.phaseId !== targetWP.phaseId) return;
      
      const phaseId = draggedWP.phaseId;
      const wpsInPhase = workPackages.filter(w => w.phaseId === phaseId);
      const otherWPs = workPackages.filter(w => w.phaseId !== phaseId);
      
      const draggedIdx = wpsInPhase.findIndex(w => w.id === draggedId);
      let targetIdx = wpsInPhase.findIndex(w => w.id === targetId);
      if (draggedIdx === targetIdx) return;
      
      const [moved] = wpsInPhase.splice(draggedIdx, 1);
      if (position === 'after') targetIdx = targetIdx >= draggedIdx ? targetIdx : targetIdx + 1;
      else targetIdx = targetIdx > draggedIdx ? targetIdx - 1 : targetIdx;
      wpsInPhase.splice(targetIdx, 0, moved);
      
      wpsInPhase.forEach((w, i) => w.order = i);
      saveWorkPackages([...otherWPs, ...wpsInPhase]);
    }
  };

  const toggleVacation = (userId, date) => {
    // Scroll-Position speichern
    if (ganttScrollRef.current) {
      setSavedScrollPosition(ganttScrollRef.current.scrollLeft);
    }
    
    const dateStr = formatDate(date);
    const existing = vacations.find(v => v.userId === userId && v.date === dateStr);
    if (existing) {
      saveVacations(vacations.filter(v => !(v.userId === userId && v.date === dateStr)));
    } else {
      saveVacations([...vacations, {id: 'v' + Date.now(), userId, date: dateStr}]);
    }
  };

  const isVacation = (userId, date) => {
    const dateStr = formatDate(date);
    return vacations.some(v => v.userId === userId && v.date === dateStr);
  };
  
  const getVacationType = (userId, date) => {
    const dateStr = typeof date === 'string' ? date : formatDate(date);
    const v = vacations.find(v => v.userId === userId && v.date === dateStr);
    return v?.type || 'urlaub';
  };
  
  // Batch: mehrere Tage auf einmal als frei setzen/entfernen
  const setVacationBatch = (userId, dateStrings, mode, type = 'urlaub') => {
    if (mode === 'add') {
      // Bestehende updaten oder neue hinzufÃ¼gen
      let updated = vacations.filter(v => !(v.userId === userId && dateStrings.includes(v.date)));
      const toAdd = dateStrings.map((ds, i) => ({ id: 'v' + Date.now() + '_' + i, userId, date: ds, type }));
      saveVacations([...updated, ...toAdd]);
    } else {
      saveVacations(vacations.filter(v => !(v.userId === userId && dateStrings.includes(v.date))));
    }
  };

  const addTask = (uid, pid, date, sh, eh) => {
    const td = new Date(date);
    td.setHours(12, 0, 0, 0);
    saveTasks([...tasks, {
      id: 't' + Date.now(), userId: uid, projectId: pid,
      startDate: formatDate(td), endDate: formatDate(td),
      startHour: sh, endHour: eh
    }]);
  };

  // NEU: Kopiere Tasks aus Vorwoche
  const copyTasksFromPreviousWeek = (userId, targetWeekNum) => {
    // Scroll-Position speichern
    if (ganttScrollRef.current) {
      setSavedScrollPosition(ganttScrollRef.current.scrollLeft);
    }
    
    const sourceWeekNum = targetWeekNum - 1;
    const sourceWeekDates = getWeekDates(sourceWeekNum, currentYear);
    const targetWeekDates = getWeekDates(targetWeekNum, currentYear);
    
    if (sourceWeekDates.length === 0 || targetWeekDates.length === 0) return;
    
    const sourceStartDate = formatDate(sourceWeekDates[0]);
    const sourceEndDate = formatDate(sourceWeekDates[6]);
    const targetStartDate = formatDate(targetWeekDates[0]);
    
    // Finde alle Tasks der Vorwoche
    const previousWeekTasks = tasks.filter(t => 
      t.userId === userId && 
      t.startDate >= sourceStartDate && 
      t.startDate <= sourceEndDate
    );
    
    if (previousWeekTasks.length === 0) {
      alert('Keine Planung in der Vorwoche gefunden!');
      return;
    }
    
    // Berechne Tages-Offset
    const daysDiff = 7;
    
    // Kopiere Tasks
    const newTasks = previousWeekTasks.map(t => {
      const oldStart = new Date(t.startDate + 'T12:00:00');
      const oldEnd = new Date(t.endDate + 'T12:00:00');
      const newStart = new Date(oldStart);
      newStart.setDate(newStart.getDate() + daysDiff);
      const newEnd = new Date(oldEnd);
      newEnd.setDate(newEnd.getDate() + daysDiff);
      
      return {
        id: 't' + Date.now() + '_' + Math.random(),
        userId: t.userId,
        projectId: t.projectId,
        startDate: formatDate(newStart),
        endDate: formatDate(newEnd),
        startHour: t.startHour,
        endHour: t.endHour
      };
    });
    
    saveTasks([...tasks, ...newTasks]);
    alert(`${previousWeekTasks.length} Aufgabe(n) aus Vorwoche kopiert!`);
  };
  
  // NEU: Kopiere einzelnen Task in nÃ¤chste Woche
  const copyTaskToNextWeek = (task) => {
    // Scroll-Position speichern
    if (ganttScrollRef.current) {
      setSavedScrollPosition(ganttScrollRef.current.scrollLeft);
    }
    
    const oldStart = new Date(task.startDate + 'T12:00:00');
    const oldEnd = new Date(task.endDate + 'T12:00:00');
    const newStart = new Date(oldStart);
    newStart.setDate(newStart.getDate() + 7);
    const newEnd = new Date(oldEnd);
    newEnd.setDate(newEnd.getDate() + 7);
    
    const newTask = {
      id: 't' + Date.now(),
      userId: task.userId,
      projectId: task.projectId,
      startDate: formatDate(newStart),
      endDate: formatDate(newEnd),
      startHour: task.startHour,
      endHour: task.endHour
    };
    
    saveTasks([...tasks, newTask]);
  };

  const updateTask = (id, upd) => saveTasks(tasks.map(t => t.id === id ? { ...t, ...upd } : t));
  const deleteTask = (id) => {
    // Scroll-Position speichern
    if (ganttScrollRef.current) {
      setSavedScrollPosition(ganttScrollRef.current.scrollLeft);
    }
    saveTasks(tasks.filter(t => t.id !== id));
  };

  const getWeekNote = (userId, weekNum) => {
    return notes.find(n => n.userId === userId && n.week === weekNum && n.year === currentYear);
  };

  const updateWeekNote = (userId, weekNum, text) => {
    const existing = notes.find(n => n.userId === userId && n.week === weekNum && n.year === currentYear);
    if (existing) {
      saveNotes(notes.map(n => n.userId === userId && n.week === weekNum && n.year === currentYear ? {...n, text} : n));
    } else {
      saveNotes([...notes, {id: 'n' + Date.now(), userId, week: weekNum, year: currentYear, text}]);
    }
  };

  const getTeamMembers = (teamId) => users.filter(u => u.teamId === teamId && u.role !== 'admin');

  // Arbeitsplan eines Users fÃ¼r einen konkreten Tag
  const getDaySchedule = (user, date) => {
    const dow = date.getDay();
    return (user.dailySchedule || DEFAULT_SCHEDULE)[dow] || {start:0, end:0, break1Duration:0, break2Duration:0};
  };
  // Arbeitsstunden an einem Tag (= end âˆ’ start âˆ’ pause1 âˆ’ pause2, oder 0 wenn frei)
  const getDailyHours = (user, date) => {
    const s = getDaySchedule(user, date);
    const gross = s.end > s.start ? s.end - s.start : 0;
    const break1 = s.break1Duration || 0;
    const break2 = (s.end > 13) ? (s.break2Duration || 0) : 0; // Pause 2 nur bei Vollzeit
    return Math.max(0, gross - break1 - break2);
  };
  const isNonWorkingDay = (user, date) => getDailyHours(user, date) === 0;
  // PrÃ¼ft ob eine bestimmte Stunde (z.B. 9 = 9:00â€“10:00) innerhalb des Arbeitsplans liegt
  const isWorkingHour = (user, date, hour) => {
    const s = getDaySchedule(user, date);
    // Eine Stunden-Zelle ist "Arbeitszeit" wenn irgendein Teil davon in der Arbeitszeit liegt
    // Beispiel: hour=7 (7:00-8:00), s.start=7.5 (7:30) â†’ hour+1 > 7.5 â†’ true
    return (hour + 1) > s.start && hour < s.end;
  };
  // WochenkapazitÃ¤t eines Users (Urlaub-Tage werden abgezogen)
  const getWeekCapacity = (user, weekDates) => {
    return weekDates.reduce((sum, d) => {
      if (isVacation(user.id, d)) return sum;
      return sum + getDailyHours(user, d);
    }, 0);
  };

  useEffect(() => {
    const handleMouseMove = (e) => {
      if (draggedTask) {
        const dx = e.clientX - draggedTask.startX;
        const dy = e.clientY - draggedTask.startY;
        const daysMoved = Math.round(dx / DW);
        const hoursMoved = Math.round(dy / HH * 4) / 4; // 0,25h Schritte!
        const st = new Date(draggedTask.task.startDate);
        const newSt = new Date(st);
        newSt.setDate(st.getDate() + daysMoved);
        const ed = new Date(draggedTask.task.endDate);
        const newEd = new Date(ed);
        newEd.setDate(ed.getDate() + daysMoved);
        const newSh = Math.max(GRID_START, Math.min(GRID_END - 1, draggedTask.task.startHour - hoursMoved));
        const newEh = Math.max(GRID_START + 1, Math.min(GRID_END, draggedTask.task.endHour - hoursMoved));
        setDraggedTask({ ...draggedTask, previewStartDate: formatDate(newSt), previewEndDate: formatDate(newEd), previewStartHour: newSh, previewEndHour: newEh });
      }
      if (resizingTask) {
        if (resizingTask.dir === 'right') {
          const dx = e.clientX - resizingTask.startX;
          const daysMoved = Math.round(dx / DW);
          const ed = new Date(resizingTask.task.endDate);
          const newEd = new Date(ed);
          newEd.setDate(ed.getDate() + daysMoved);
          setResizingTask({ ...resizingTask, previewEndDate: formatDate(newEd) });
        } else if (resizingTask.dir === 'top') {
          const dy = e.clientY - resizingTask.startY;
          const hoursMoved = Math.round(dy / HH * 4) / 4; // 0,25h Schritte!
          const newEh = Math.max(resizingTask.task.startHour + 1, Math.min(GRID_END, resizingTask.origEnd - hoursMoved));
          setResizingTask({ ...resizingTask, previewEndHour: newEh });
        } else if (resizingTask.dir === 'bottom') {
          const dy = e.clientY - resizingTask.startY;
          const hoursMoved = Math.round(dy / HH * 4) / 4; // 0,25h Schritte!
          const newSh = Math.max(GRID_START, Math.min(resizingTask.task.endHour - 1, resizingTask.origStart - hoursMoved));
          setResizingTask({ ...resizingTask, previewStartHour: newSh });
        }
      }
    };
    const handleMouseUp = () => {
      if (draggedTask && draggedTask.previewStartDate) {
        updateTask(draggedTask.task.id, {
          startDate: draggedTask.previewStartDate, endDate: draggedTask.previewEndDate,
          startHour: draggedTask.previewStartHour, endHour: draggedTask.previewEndHour
        });
      }
      if (resizingTask) {
        const upd = {};
        if (resizingTask.previewEndDate) upd.endDate = resizingTask.previewEndDate;
        if (resizingTask.previewEndHour !== undefined) upd.endHour = resizingTask.previewEndHour;
        if (resizingTask.previewStartHour !== undefined) upd.startHour = resizingTask.previewStartHour;
        if (Object.keys(upd).length > 0) updateTask(resizingTask.task.id, upd);
      }
      setDraggedTask(null);
      setResizingTask(null);
    };
    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);
    return () => {
      document.removeEventListener('mousemove', handleMouseMove);
      document.removeEventListener('mouseup', handleMouseUp);
    };
  }, [draggedTask, resizingTask, tasks]);

  const AdminPanel = () => {
    const [localUsers, setLocalUsers] = React.useState(users);
    const [localTeams, setLocalTeams] = React.useState(teams);
    const [localDivisions, setLocalDivisions] = React.useState(divisions);
    const [localDepartments, setLocalDepartments] = React.useState(departments);
    const [localResources, setLocalResources] = React.useState(resources);
    const [expandedUsers, setExpandedUsers] = [adminExpandedUsers, setAdminExpandedUsers];
    const [expandedResources, setExpandedResources] = [adminExpandedResources, setAdminExpandedResources];
    const [userSort, setUserSort] = [adminUserSort, setAdminUserSort];
    const [resourceSort, setResourceSort] = [adminResourceSort, setAdminResourceSort];
    React.useEffect(() => { setLocalUsers(users); }, [users]);
    React.useEffect(() => { setLocalTeams(teams); }, [teams]);
    React.useEffect(() => { setLocalDivisions(divisions); }, [divisions]);
    React.useEffect(() => { setLocalDepartments(departments); }, [departments]);
    React.useEffect(() => { setLocalResources(resources); }, [resources]);
    
    // Robust scroll preservation â€“ capture before every re-render
    const scrollTopRef = React.useRef(0);
    const captureScroll = () => { if (adminScrollRef.current) scrollTopRef.current = adminScrollRef.current.scrollTop; };
    
    // Wrap all save functions to capture scroll first
    const saveAndKeepScroll = (saveFn, data) => { captureScroll(); saveFn(data); };
    
    // Restore scroll after ANY local state change
    React.useEffect(() => {
      if (adminScrollRef.current && scrollTopRef.current > 0) {
        adminScrollRef.current.scrollTop = scrollTopRef.current;
      }
    });
    
    return (
      <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 mobile-padding">
        <div className="dm-modal bg-white rounded-2xl w-[95%] max-w-[900px] max-h-[95vh] flex flex-col admin-modal">
          <div className="flex justify-between items-center px-5 py-3 border-b flex-shrink-0">
            <h2 className="text-lg font-bold">Admin Panel</h2>
            <button onClick={() => setShowAdmin(false)} className="text-xl text-gray-400 hover:text-gray-600">âœ•</button>
          </div>
          <div ref={adminScrollRef} onScroll={captureScroll} className="flex-1 overflow-y-auto p-4 space-y-2 text-xs">
            
            {/* BEREICHE */}
            {localDepartments.sort((a,b) => a.name.localeCompare(b.name)).map(dept => {
              const deptExpanded = expandedUsers['dept_' + dept.id];
              const deptDivisions = localDivisions.filter(d => d.departmentId === dept.id).sort((a,b) => a.name.localeCompare(b.name));
              return (
                <div key={dept.id} className="border rounded-lg overflow-hidden">
                  {/* Bereich Header */}
                  <div className="flex items-center gap-2 px-3 py-2 bg-slate-100 cursor-pointer hover:bg-slate-200" onClick={() => setExpandedUsers({...expandedUsers, ['dept_' + dept.id]: !deptExpanded})}>
                    <span className="text-gray-400 text-[10px]">{deptExpanded ? 'â–¼' : 'â–¶'}</span>
                    <div className="w-2 h-2 rounded-full bg-slate-500" />
                    <input type="text" value={dept.name} onClick={e => e.stopPropagation()} onChange={(e) => setLocalDepartments(localDepartments.map(x => x.id === dept.id ? {...x, name: e.target.value} : x))} onBlur={() => saveDepartments(localDepartments)} className="flex-1 bg-transparent font-semibold text-xs border-0 p-0 focus:outline-none focus:bg-white focus:px-1 focus:rounded" />
                    <span className="text-[10px] text-gray-400">{deptDivisions.length} Abt.</span>
                    <button onClick={(e) => { e.stopPropagation(); if (deptDivisions.length > 0) return alert('Bereich hat noch Abteilungen.'); if (confirm(`"${dept.name}" lÃ¶schen?`)) { const n = localDepartments.filter(x => x.id !== dept.id); setLocalDepartments(n); saveDepartments(n); }}} className="p-0.5 text-red-400 hover:text-red-600 hover:bg-red-50 rounded"><Trash2 className="w-3 h-3" /></button>
                  </div>
                  
                  {deptExpanded && (
                    <div className="px-3 py-2 space-y-1.5 bg-white">
                      {/* Abteilungen im Bereich */}
                      {deptDivisions.map(div => {
                        const divExpanded = expandedUsers['div_' + div.id];
                        const divTeams = localTeams.filter(t => t.divisionId === div.id).sort((a,b) => a.name.localeCompare(b.name));
                        const divResources = localResources.filter(r => r.abteilungId === div.id).sort((a,b) => a.name.localeCompare(b.name));
                        return (
                          <div key={div.id} className="border rounded-md overflow-hidden ml-3">
                            <div className="flex items-center gap-2 px-2.5 py-1.5 bg-blue-50 cursor-pointer hover:bg-orange-50" onClick={() => setExpandedUsers({...expandedUsers, ['div_' + div.id]: !divExpanded})}>
                              <span className="text-gray-400 text-[10px]">{divExpanded ? 'â–¼' : 'â–¶'}</span>
                              <div className="w-1.5 h-1.5 rounded-full bg-blue-500" />
                              <input type="text" value={div.name} onClick={e => e.stopPropagation()} onChange={(e) => setLocalDivisions(localDivisions.map(x => x.id === div.id ? {...x, name: e.target.value} : x))} onBlur={() => saveDivisions(localDivisions)} className="flex-1 bg-transparent font-medium text-xs border-0 p-0 focus:outline-none focus:bg-white focus:px-1 focus:rounded" />
                              <span className="text-[10px] text-gray-400">{divTeams.length}T {divResources.length}R</span>
                              <button onClick={(e) => { e.stopPropagation(); if (divTeams.length > 0) return alert('Abteilung hat noch Teams.'); if (confirm(`"${div.name}" lÃ¶schen?`)) { const n = localDivisions.filter(x => x.id !== div.id); setLocalDivisions(n); saveDivisions(n); }}} className="p-0.5 text-red-400 hover:text-red-600 hover:bg-red-50 rounded"><Trash2 className="w-3 h-3" /></button>
                            </div>
                            
                            {divExpanded && (
                              <div className="px-2.5 py-1.5 space-y-1.5 bg-white">
                                {/* Teams */}
                                {divTeams.map(team => {
                                  const teamExpanded = expandedUsers['team_' + team.id];
                                  const teamUsers = localUsers.filter(u => u.teamId === team.id && u.role !== 'admin').sort((a,b) => a.name.localeCompare(b.name));
                                  return (
                                    <div key={team.id} className="border rounded overflow-hidden ml-3">
                                      <div className="flex items-center gap-2 px-2 py-1.5 bg-indigo-50 cursor-pointer hover:bg-indigo-100" onClick={() => setExpandedUsers({...expandedUsers, ['team_' + team.id]: !teamExpanded})}>
                                        <span className="text-gray-400 text-[10px]">{teamExpanded ? 'â–¼' : 'â–¶'}</span>
                                        <div className="w-1.5 h-1.5 rounded-full bg-indigo-500" />
                                        <input type="text" value={team.name} onClick={e => e.stopPropagation()} onChange={(e) => setLocalTeams(localTeams.map(x => x.id === team.id ? {...x, name: e.target.value} : x))} onBlur={() => saveTeams(localTeams)} className="flex-1 bg-transparent font-medium text-xs border-0 p-0 focus:outline-none focus:bg-white focus:px-1 focus:rounded" />
                                        <span className="text-[10px] text-gray-400">{teamUsers.length} Pers.</span>
                                        <button onClick={(e) => { e.stopPropagation(); if (teamUsers.length > 0) return alert('Team hat noch Benutzer.'); if (confirm(`"${team.name}" lÃ¶schen?`)) { const n = localTeams.filter(x => x.id !== team.id); setLocalTeams(n); saveTeams(n); }}} className="p-0.5 text-red-400 hover:text-red-600 hover:bg-red-50 rounded"><Trash2 className="w-3 h-3" /></button>
                                      </div>
                                      
                                      {teamExpanded && (
                                        <div className="px-2 py-1 space-y-1 bg-white">
                                          {/* Benutzer */}
                                          {teamUsers.map(u => {
                                            const uExpanded = expandedUsers[u.id];
                                            const sched = u.dailySchedule || DEFAULT_SCHEDULE;
                                            const weekH = [1,2,3,4,5,6,0].reduce((s,d) => { const ds=sched[d]||{start:0,end:0,break1Duration:0,break2Duration:0}; const g=ds.end>ds.start?ds.end-ds.start:0; return s+Math.max(0,g-(ds.break1Duration||0)-((ds.end>13)?(ds.break2Duration||0):0)); }, 0);
                                            const roleLabel = u.teamRole === 'entrepreneur' ? 'UNT' : u.teamRole === 'department_head' ? 'BL' : u.teamRole === 'lead' ? 'FK' : u.teamRole === 'responsible' ? 'V' : 'B';
                                            return (
                                              <div key={u.id} className="border rounded overflow-hidden ml-3">
                                                <div className="flex items-center gap-1.5 px-2 py-1 bg-gray-50 cursor-pointer hover:bg-gray-100" onClick={() => setExpandedUsers({...expandedUsers, [u.id]: !uExpanded})}>
                                                  <span className="text-gray-400 text-[10px]">{uExpanded ? 'â–¼' : 'â–¶'}</span>
                                                  <span className="text-[10px] px-1 py-0.5 rounded bg-indigo-100 text-indigo-600 font-medium">{roleLabel}</span>
                                                  <span className="font-medium truncate flex-1">{u.name}</span>
                                                  <span className="text-[10px] text-gray-400">{weekH}h/W</span>
                                                  <button onClick={(e) => { e.stopPropagation(); if (tasks.some(t => t.userId === u.id)) return alert('Benutzer hat noch Tasks.'); if (confirm(`"${u.name}" lÃ¶schen?`)) { const n = localUsers.filter(x => x.id !== u.id); setLocalUsers(n); saveUsers(n); }}} className="p-0.5 text-red-400 hover:text-red-600 rounded"><Trash2 className="w-3 h-3" /></button>
                                                </div>
                                                {uExpanded && (
                                                  <div className="px-2 py-1.5 space-y-1.5 bg-white">
                                                    <input type="text" value={u.name} onChange={(e) => setLocalUsers(localUsers.map(x => x.id === u.id ? {...x, name: e.target.value} : x))} onBlur={() => saveUsers(localUsers)} className="w-full p-1.5 border rounded text-xs" placeholder="Name" />
                                                    <div className="flex gap-1.5">
                                                      <select value={u.teamId || ''} onChange={(e) => { const n = localUsers.map(x => x.id === u.id ? {...x, teamId: e.target.value} : x); setLocalUsers(n); saveUsers(n); }} className="flex-1 p-1.5 border rounded text-xs">
                                                        <option value="">Kein Team</option>
                                                        {localTeams.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                                                      </select>
                                                      <select value={u.teamRole || 'editor'} onChange={(e) => { const n = localUsers.map(x => x.id === u.id ? {...x, teamRole: e.target.value} : x); setLocalUsers(n); saveUsers(n); }} className="w-32 p-1.5 border rounded text-xs">
                                                        <option value="entrepreneur">Unternehmer</option>
                                                        <option value="department_head">Bereichsleitung</option>
                                                        <option value="lead">FÃ¼hrungskraft</option>
                                                        <option value="responsible">Verantwortlicher</option>
                                                        <option value="editor">Bearbeiter</option>
                                                      </select>
                                                    </div>
                                                    {(u.teamRole === 'department_head' || u.teamRole === 'entrepreneur') && (
                                                      <select value={u.departmentId || ''} onChange={(e) => { const n = localUsers.map(x => x.id === u.id ? {...x, departmentId: e.target.value || null} : x); setLocalUsers(n); saveUsers(n); }} className="w-full p-1.5 border rounded text-xs bg-yellow-50">
                                                        <option value="">Kein Bereich (sieht alle)</option>
                                                        {localDepartments.map(d => <option key={d.id} value={d.id}>{d.name}</option>)}
                                                      </select>
                                                    )}
                                                    {/* Fahrzeug & Schichtcode */}
                                                    <div className="flex gap-1.5">
                                                      <div className="flex-1">
                                                        <div className="text-[9px] text-gray-400 mb-0.5">ðŸš— Fahrzeug</div>
                                                        <select value={u.vehicle || ''} onChange={(e) => { const n = localUsers.map(x => x.id === u.id ? {...x, vehicle: e.target.value || null} : x); setLocalUsers(n); saveUsers(n); }} className="w-full p-1 border rounded text-xs">
                                                          <option value="">â€“</option>
                                                          <option value="PKW">PKW</option>
                                                          <option value="LKW 7,5">LKW 7,5</option>
                                                          <option value="LKW 12">LKW 12</option>
                                                          <option value="LKW 40">LKW 40</option>
                                                          <option value="Transporter">Transporter</option>
                                                          {resources.filter(r => r.type === 'fahrzeug').map(r => <option key={r.id} value={r.name}>{r.name}{r.kennzeichen ? ' ('+r.kennzeichen+')' : ''}</option>)}
                                                        </select>
                                                      </div>
                                                      <div className="w-20">
                                                        <div className="text-[9px] text-gray-400 mb-0.5">âš™ï¸ Code</div>
                                                        <input type="text" value={u.shiftCode || ''} onChange={(e) => { const n = localUsers.map(x => x.id === u.id ? {...x, shiftCode: e.target.value} : x); setLocalUsers(n); saveUsers(n); }} className="w-full p-1 border rounded text-xs" placeholder="MH, P..." />
                                                      </div>
                                                    </div>
                                                    {/* Arbeitszeiten kompakt */}
                                                    <div className="p-1.5 bg-gray-50 rounded border space-y-1">
                                                      <div className="flex items-center justify-between">
                                                        <div className="text-[10px] font-semibold text-gray-500">Arbeitszeiten</div>
                                                        <span className="text-[10px] font-medium px-1.5 py-0.5 rounded bg-indigo-50 text-indigo-600">{weekH}h/W</span>
                                                      </div>
                                                      {[{d:1,l:'Mo'},{d:2,l:'Di'},{d:3,l:'Mi'},{d:4,l:'Do'},{d:5,l:'Fr'},{d:6,l:'Sa'},{d:0,l:'So'}].map(({d,l}) => {
                                                        const dayS = sched[d] || {start:0, end:0, break1Start:0, break1Duration:0, break2Start:0, break2Duration:0};
                                                        const isOff = dayS.start >= dayS.end || (dayS.start === 0 && dayS.end === 0);
                                                        const toggleOff = () => { const ns = {...sched, [d]: isOff ? {start:8,end:17,break1Start:9,break1Duration:0.25,break2Start:12.5,break2Duration:0.75} : {start:0,end:0,break1Duration:0,break2Duration:0}}; const n = localUsers.map(x => x.id === u.id ? {...x, dailySchedule: ns} : x); setLocalUsers(n); saveUsers(n); };
                                                        const setVal = (field, raw) => { const val = (field === 'break1Duration' || field === 'break2Duration') ? parseFloat(raw) || 0 : t2h(raw); const ns = {...sched, [d]: {...dayS, [field]: val}}; const n = localUsers.map(x => x.id === u.id ? {...x, dailySchedule: ns} : x); setLocalUsers(n); saveUsers(n); };
                                                        const gross = dayS.end > dayS.start ? dayS.end - dayS.start : 0;
                                                        const net = Math.max(0, gross - (dayS.break1Duration||0) - ((dayS.end>13)?(dayS.break2Duration||0):0));
                                                        return (
                                                          <div key={d} className="space-y-0.5">
                                                            {d === 6 && <div className="border-t border-dashed border-gray-200 mt-1 pt-1" />}
                                                            <div className="flex items-center gap-1">
                                                              <button onClick={toggleOff} className={`w-6 text-center text-[10px] font-medium rounded py-0.5 ${isOff ? ((d === 6 || d === 0) ? 'bg-gray-100 text-gray-300' : 'bg-gray-200 text-gray-400') : ((d === 6 || d === 0) ? 'bg-orange-100 text-orange-700' : 'bg-indigo-100 text-indigo-700')}`}>{l}</button>
                                                              {isOff ? <span className="text-[10px] text-gray-400 italic">frei</span> : (
                                                                <React.Fragment>
                                                                  <input type="text" defaultValue={h2t(dayS.start)} key={`s-${u.id}-${d}-${dayS.start}`} onBlur={(e) => { const f = formatTimeInput(e.target.value); if (f) setVal('start', f); }} className="w-12 border rounded px-1 py-0.5 text-[10px] text-center" />
                                                                  <span className="text-gray-300">â€“</span>
                                                                  <input type="text" defaultValue={h2t(dayS.end)} key={`e-${u.id}-${d}-${dayS.end}`} onBlur={(e) => { const f = formatTimeInput(e.target.value); if (f) setVal('end', f); }} className="w-12 border rounded px-1 py-0.5 text-[10px] text-center" />
                                                                  <span className="text-[10px] text-gray-400 ml-auto">{net.toFixed(1)}h</span>
                                                                </React.Fragment>
                                                              )}
                                                            </div>
                                                            {!isOff && (
                                                              <div className="ml-7 flex items-center gap-1 text-[10px] text-gray-400">
                                                                <span className="w-5">P1:</span>
                                                                <input type="text" defaultValue={h2t(dayS.break1Start || 9)} key={`b1s-${u.id}-${d}-${dayS.break1Start}`} onBlur={(e) => { const f = formatTimeInput(e.target.value); if (f) setVal('break1Start', f); }} className="w-11 border rounded px-0.5 py-0.5 text-[10px] text-center text-gray-600" />
                                                                <span>â€“</span>
                                                                <input type="text" defaultValue={h2t((dayS.break1Start || 9) + (dayS.break1Duration || 0.25))} key={`b1e-${u.id}-${d}-${dayS.break1Duration}`} onBlur={(e) => { const f = formatTimeInput(e.target.value); if (f) { const dur = Math.max(0, t2h(f) - (dayS.break1Start || 9)); setVal('break1Duration', dur.toString()); }}} className="w-11 border rounded px-0.5 py-0.5 text-[10px] text-center text-gray-600" />
                                                                <span className="mx-1">P2:</span>
                                                                <input type="text" defaultValue={h2t(dayS.break2Start || 12.5)} key={`b2s-${u.id}-${d}-${dayS.break2Start}`} onBlur={(e) => { const f = formatTimeInput(e.target.value); if (f) setVal('break2Start', f); }} className="w-11 border rounded px-0.5 py-0.5 text-[10px] text-center text-gray-600" />
                                                                <span>â€“</span>
                                                                <input type="text" defaultValue={h2t((dayS.break2Start || 12.5) + (dayS.break2Duration || 0.75))} key={`b2e-${u.id}-${d}-${dayS.break2Duration}`} onBlur={(e) => { const f = formatTimeInput(e.target.value); if (f) { const dur = Math.max(0, t2h(f) - (dayS.break2Start || 12.5)); setVal('break2Duration', dur.toString()); }}} className="w-11 border rounded px-0.5 py-0.5 text-[10px] text-center text-gray-600" />
                                                              </div>
                                                            )}
                                                          </div>
                                                        );
                                                      })}
                                                    </div>
                                                  </div>
                                                )}
                                              </div>
                                            );
                                          })}
                                          <button onClick={() => {
                                            const nu = { id: 'p' + Date.now(), name: 'Neue Person', role: 'member', teamId: team.id, teamRole: 'editor', dailySchedule: {1:{start:8,end:17,break1Start:9,break1Duration:0.25,break2Start:12.5,break2Duration:0.75},2:{start:8,end:17,break1Start:9,break1Duration:0.25,break2Start:12.5,break2Duration:0.75},3:{start:8,end:17,break1Start:9,break1Duration:0.25,break2Start:12.5,break2Duration:0.75},4:{start:8,end:17,break1Start:9,break1Duration:0.25,break2Start:12.5,break2Duration:0.75},5:{start:8,end:17,break1Start:9,break1Duration:0.25,break2Start:12.5,break2Duration:0.75},6:{start:0,end:0,break1Duration:0,break2Duration:0},0:{start:0,end:0,break1Duration:0,break2Duration:0}}, departmentId: null };
                                            const n = [...localUsers, nu]; setLocalUsers(n); saveUsers(n); setExpandedUsers({...expandedUsers, [nu.id]: true});
                                          }} className="w-full ml-3 py-1 text-[10px] text-indigo-600 hover:bg-indigo-50 rounded border border-dashed border-indigo-300 flex items-center justify-center gap-1">
                                            <Plus className="w-3 h-3" /> Person
                                          </button>
                                        </div>
                                      )}
                                    </div>
                                  );
                                })}
                                
                                {/* Ressourcen der Abteilung */}
                                {divResources.length > 0 && (
                                  <div className="ml-3 mt-1">
                                    <div className="text-[10px] font-semibold text-gray-400 uppercase tracking-wide mb-1">Ressourcen</div>
                                    {divResources.map(r => {
                                      const rExpanded = expandedResources[r.id];
                                      const typeIcon = r.type === 'maschine' ? 'ðŸ­' : r.type === 'werkzeug' ? 'ðŸ”§' : 'ðŸš›';
                                      return (
                                        <div key={r.id} className="border rounded overflow-hidden ml-0 mb-1">
                                          <div className="flex items-center gap-1.5 px-2 py-1 bg-amber-50 cursor-pointer hover:bg-amber-100" onClick={() => setExpandedResources({...expandedResources, [r.id]: !rExpanded})}>
                                            <span className="text-gray-400 text-[10px]">{rExpanded ? 'â–¼' : 'â–¶'}</span>
                                            <span className="text-[10px]">{typeIcon}</span>
                                            <span className="font-medium truncate flex-1">{r.name}</span>
                                            {r.schichtmodell > 1 && <span className="text-[10px] text-gray-400">{r.schichtmodell}S</span>}
                                            {r.kuerzel && <span className="text-[10px] px-1 py-0.5 rounded bg-gray-100 font-mono">{r.kuerzel}</span>}
                                            <button onClick={(e) => { e.stopPropagation(); if (confirm(`"${r.name}" lÃ¶schen?`)) { const n = localResources.filter(x => x.id !== r.id); setLocalResources(n); saveResources(n); }}} className="p-0.5 text-red-400 hover:text-red-600 rounded"><Trash2 className="w-3 h-3" /></button>
                                          </div>
                                          {rExpanded && (
                                            <div className="px-2 py-1.5 space-y-1.5 bg-white">
                                              <input type="text" value={r.name} onChange={(e) => setLocalResources(localResources.map(x => x.id === r.id ? {...x, name: e.target.value} : x))} onBlur={() => saveResources(localResources)} className="w-full p-1.5 border rounded text-xs" />
                                              <div className="flex gap-1.5">
                                                <select value={r.type || 'maschine'} onChange={(e) => { const n = localResources.map(x => x.id === r.id ? {...x, type: e.target.value} : x); setLocalResources(n); saveResources(n); }} className="flex-1 p-1.5 border rounded text-xs">
                                                  <option value="maschine">ðŸ­ Maschine</option>
                                                  <option value="werkzeug">ðŸ”§ Werkzeug</option>
                                                  <option value="fahrzeug">ðŸš› Fahrzeug</option>
                                                </select>
                                                <select value={r.abteilungId || ''} onChange={(e) => { const n = localResources.map(x => x.id === r.id ? {...x, abteilungId: e.target.value || null} : x); setLocalResources(n); saveResources(n); }} className="flex-1 p-1.5 border rounded text-xs">
                                                  <option value="">Keine Abt.</option>
                                                  {localDivisions.map(d => <option key={d.id} value={d.id}>{d.name}</option>)}
                                                </select>
                                              </div>
                                              {(r.type === 'maschine' || r.type === 'fahrzeug' || r.type === 'werkzeug') && (
                                                <div className="flex items-center gap-2">
                                                  <span className="text-[10px] text-gray-500">Schicht:</span>
                                                  {[1,2,3].map(s => (
                                                    <button key={s} onClick={() => { const n = localResources.map(x => x.id === r.id ? {...x, schichtmodell: s} : x); setLocalResources(n); saveResources(n); }} className={`px-2 py-0.5 rounded text-[10px] font-medium ${r.schichtmodell === s ? 'bg-indigo-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}>{s}S</button>
                                                  ))}
                                                  <span className="text-[10px] text-gray-500 ml-2">h/S:</span>
                                                  <input type="number" value={r.stundenProSchicht || 8} min="1" max="24" step="0.5" onChange={(e) => { const n = localResources.map(x => x.id === r.id ? {...x, stundenProSchicht: parseFloat(e.target.value) || 8} : x); setLocalResources(n); saveResources(n); }} className="w-12 p-1 border rounded text-[10px] text-center" />
                                                  <span className="text-[10px] text-gray-400 ml-1">= {(r.schichtmodell || 1) * (r.stundenProSchicht || 8)}h/Tag</span>
                                                </div>
                                              )}
                                              {r.type === 'fahrzeug' && <input type="text" value={r.kennzeichen || ''} onChange={(e) => setLocalResources(localResources.map(x => x.id === r.id ? {...x, kennzeichen: e.target.value} : x))} onBlur={() => saveResources(localResources)} className="w-full p-1.5 border rounded text-xs" placeholder="Kennzeichen" />}
                                              <div className="flex items-center gap-2">
                                                <span className="text-[10px] text-gray-500">KÃ¼rzel:</span>
                                                <input type="text" value={r.kuerzel || ''} maxLength="4" onChange={(e) => setLocalResources(localResources.map(x => x.id === r.id ? {...x, kuerzel: e.target.value.toUpperCase()} : x))} onBlur={() => saveResources(localResources)} className="w-14 p-1 border rounded text-[10px] text-center font-mono" placeholder="CNC1" />
                                                <span className="text-[10px] text-gray-500">Farbe:</span>
                                                <input type="color" value={r.farbe || '#6366f1'} onChange={(e) => { const n = localResources.map(x => x.id === r.id ? {...x, farbe: e.target.value} : x); setLocalResources(n); saveResources(n); }} className="w-6 h-6 rounded cursor-pointer border-0" />
                                              </div>
                                              {r.type === 'maschine' && (
                                                <div className="flex items-center gap-2 mt-1">
                                                  <label className="flex items-center gap-1.5 cursor-pointer">
                                                    <input type="checkbox" checked={r.needsOperator !== false} onChange={(e) => { const n = localResources.map(x => x.id === r.id ? {...x, needsOperator: e.target.checked} : x); setLocalResources(n); saveResources(n); }} className="rounded" />
                                                    <span className="text-[10px] text-gray-600">ðŸ‘¤ Bediener erforderlich</span>
                                                  </label>
                                                  {r.needsOperator === false && <span className="text-[10px] px-1.5 py-0.5 rounded bg-emerald-50 text-emerald-600 font-medium">ðŸ¤– Autonom</span>}
                                                </div>
                                              )}
                                            </div>
                                          )}
                                        </div>
                                      );
                                    })}
                                  </div>
                                )}
                                
                                {/* Add-Buttons */}
                                <div className="flex gap-1.5 ml-3 mt-1">
                                  <button onClick={() => {
                                    const nt = { id: 'team' + Date.now(), name: 'Neues Team', divisionId: div.id };
                                    const n = [...localTeams, nt]; setLocalTeams(n); saveTeams(n); setExpandedUsers({...expandedUsers, ['team_' + nt.id]: true});
                                  }} className="flex-1 py-1 text-[10px] text-indigo-600 hover:bg-indigo-50 rounded border border-dashed border-indigo-300 flex items-center justify-center gap-1">
                                    <Plus className="w-3 h-3" /> Team
                                  </button>
                                  <button onClick={() => {
                                    const nr = { id: 'res_' + Date.now(), name: 'Neue Ressource', type: 'maschine', abteilungId: div.id, schichtmodell: 1, stundenProSchicht: 8, kuerzel: '', kennzeichen: '', farbe: '#6366f1', needsOperator: true };
                                    const n = [...localResources, nr]; setLocalResources(n); saveResources(n); setExpandedResources({...expandedResources, [nr.id]: true});
                                  }} className="flex-1 py-1 text-[10px] text-orange-600 hover:bg-amber-50 rounded border border-dashed border-amber-300 flex items-center justify-center gap-1">
                                    <Plus className="w-3 h-3" /> Ressource
                                  </button>
                                </div>
                              </div>
                            )}
                          </div>
                        );
                      })}
                      
                      {/* Abteilung hinzufÃ¼gen im Bereich */}
                      <button onClick={() => {
                        const nd = { id: 'div' + Date.now(), name: 'Neue Abteilung', departmentId: dept.id };
                        const n = [...localDivisions, nd]; setLocalDivisions(n); saveDivisions(n); setExpandedUsers({...expandedUsers, ['div_' + nd.id]: true});
                      }} className="w-full ml-3 py-1 text-[10px] text-blue-600 hover:bg-blue-50 rounded border border-dashed border-blue-300 flex items-center justify-center gap-1">
                        <Plus className="w-3 h-3" /> Abteilung
                      </button>
                    </div>
                  )}
                </div>
              );
            })}
            
            {/* Nicht zugeordnete Elemente */}
            {(() => {
              const orphanDivisions = localDivisions.filter(d => !d.departmentId || !localDepartments.some(dep => dep.id === d.departmentId));
              const orphanTeams = localTeams.filter(t => !t.divisionId || !localDivisions.some(d => d.id === t.divisionId));
              const orphanUsers = localUsers.filter(u => u.role !== 'admin' && (!u.teamId || !localTeams.some(t => t.id === u.teamId)));
              const orphanResources = localResources.filter(r => !r.abteilungId || !localDivisions.some(d => d.id === r.abteilungId));
              if (orphanDivisions.length === 0 && orphanTeams.length === 0 && orphanUsers.length === 0 && orphanResources.length === 0) return null;
              const orphExpanded = expandedUsers['_orphans'];
              return (
                <div className="border rounded-lg overflow-hidden border-orange-200">
                  <div className="flex items-center gap-2 px-3 py-2 bg-orange-50 cursor-pointer hover:bg-orange-100" onClick={() => setExpandedUsers({...expandedUsers, ['_orphans']: !orphExpanded})}>
                    <span className="text-gray-400 text-[10px]">{orphExpanded ? 'â–¼' : 'â–¶'}</span>
                    <span className="font-semibold text-xs text-orange-700">âš  Nicht zugeordnet</span>
                    <span className="text-[10px] text-orange-500">{orphanDivisions.length + orphanTeams.length + orphanUsers.length + orphanResources.length} Elemente</span>
                  </div>
                  {orphExpanded && (
                    <div className="px-3 py-2 space-y-1 bg-white text-xs">
                      {orphanDivisions.map(div => (
                        <div key={div.id} className="flex items-center gap-2 py-1 px-2 bg-blue-50 rounded">
                          <span className="text-[10px]">Abt:</span>
                          <span className="font-medium flex-1">{div.name}</span>
                          <select value={div.departmentId || ''} onChange={(e) => { const n = localDivisions.map(x => x.id === div.id ? {...x, departmentId: e.target.value} : x); setLocalDivisions(n); saveDivisions(n); }} className="p-1 border rounded text-[10px]">
                            <option value="">â†’ Bereich wÃ¤hlen</option>
                            {localDepartments.map(d => <option key={d.id} value={d.id}>{d.name}</option>)}
                          </select>
                        </div>
                      ))}
                      {orphanTeams.map(t => (
                        <div key={t.id} className="flex items-center gap-2 py-1 px-2 bg-indigo-50 rounded">
                          <span className="text-[10px]">Team:</span>
                          <span className="font-medium flex-1">{t.name}</span>
                          <select value={t.divisionId || ''} onChange={(e) => { const n = localTeams.map(x => x.id === t.id ? {...x, divisionId: e.target.value} : x); setLocalTeams(n); saveTeams(n); }} className="p-1 border rounded text-[10px]">
                            <option value="">â†’ Abteilung wÃ¤hlen</option>
                            {localDivisions.map(d => <option key={d.id} value={d.id}>{d.name}</option>)}
                          </select>
                        </div>
                      ))}
                      {orphanUsers.map(u => (
                        <div key={u.id} className="flex items-center gap-2 py-1 px-2 bg-gray-50 rounded">
                          <span className="text-[10px]">Person:</span>
                          <span className="font-medium flex-1">{u.name}</span>
                          <select value={u.teamId || ''} onChange={(e) => { const n = localUsers.map(x => x.id === u.id ? {...x, teamId: e.target.value} : x); setLocalUsers(n); saveUsers(n); }} className="p-1 border rounded text-[10px]">
                            <option value="">â†’ Team wÃ¤hlen</option>
                            {localTeams.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                          </select>
                        </div>
                      ))}
                      {orphanResources.map(r => (
                        <div key={r.id} className="flex items-center gap-2 py-1 px-2 bg-amber-50 rounded">
                          <span className="text-[10px]">{r.type === 'maschine' ? 'ðŸ­' : r.type === 'werkzeug' ? 'ðŸ”§' : 'ðŸš›'}</span>
                          <span className="font-medium flex-1">{r.name}</span>
                          <select value={r.abteilungId || ''} onChange={(e) => { const n = localResources.map(x => x.id === r.id ? {...x, abteilungId: e.target.value || null} : x); setLocalResources(n); saveResources(n); }} className="p-1 border rounded text-[10px]">
                            <option value="">â†’ Abteilung wÃ¤hlen</option>
                            {localDivisions.map(d => <option key={d.id} value={d.id}>{d.name}</option>)}
                          </select>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              );
            })()}
            
            {/* Bereich hinzufÃ¼gen */}
            <button onClick={() => {
              const nd = { id: 'dept' + Date.now(), name: 'Neuer Bereich' };
              const n = [...localDepartments, nd]; setLocalDepartments(n); saveDepartments(n); setExpandedUsers({...expandedUsers, ['dept_' + nd.id]: true});
            }} className="w-full py-2 text-xs text-slate-600 hover:bg-slate-50 rounded-lg border-2 border-dashed border-slate-300 flex items-center justify-center gap-1.5">
              <Plus className="w-3.5 h-3.5" /> Bereich hinzufÃ¼gen
            </button>
            
            {/* Farbskala Einstellungen */}
            <div className="mt-4 border rounded-xl p-4 bg-gray-50">
              <h3 className="text-sm font-bold mb-3 flex items-center gap-2">ðŸŽ¨ Auslastungs-Farbskala</h3>
              <p className="text-[10px] text-gray-500 mb-3">Schwellenwerte in % ab wann welche Farbe angezeigt wird (Workload-Matrix, Schnellplanung, Team Dashboard)</p>
              <div className="space-y-2">
                {[
                  { key: 'green', label: 'GrÃ¼n', color: '#22c55e', desc: 'Niedrige Auslastung' },
                  { key: 'blue', label: 'Blau', color: '#6366f1', desc: 'Mittlere Auslastung' },
                  { key: 'orange', label: 'Orange', color: '#f59e0b', desc: 'Hohe Auslastung' },
                  { key: 'red', label: 'Rot', color: '#ef4444', desc: 'Ãœberlastung' },
                ].map(tier => (
                  <div key={tier.key} className="flex items-center gap-3">
                    <div className="w-4 h-4 rounded-sm flex-shrink-0" style={{ backgroundColor: tier.color }} />
                    <span className="w-16 font-medium">{tier.label}</span>
                    <span className="text-gray-400 w-4">ab</span>
                    <input 
                      type="number" 
                      min="0" max="200" step="5"
                      value={colorThresholds[tier.key]} 
                      onChange={(e) => { 
                        const val = parseInt(e.target.value) || 0;
                        const newCt = { ...colorThresholds, [tier.key]: val };
                        saveColorThresholds(newCt);
                      }}
                      className="w-16 px-2 py-1 border rounded text-center font-mono"
                    />
                    <span className="text-gray-500">%</span>
                    <span className="text-[10px] text-gray-400 flex-1">{tier.desc}</span>
                  </div>
                ))}
              </div>
              {/* Preview bar */}
              <div className="mt-3 pt-3 border-t">
                <div className="text-[10px] text-gray-500 mb-1">Vorschau:</div>
                <div className="flex h-5 rounded overflow-hidden">
                  <div style={{ width: `${colorThresholds.blue}%`, backgroundColor: '#22c55e' }} className="flex items-center justify-center text-[8px] text-white font-bold">{colorThresholds.green}â€“{colorThresholds.blue}%</div>
                  <div style={{ width: `${colorThresholds.orange - colorThresholds.blue}%`, backgroundColor: '#6366f1' }} className="flex items-center justify-center text-[8px] text-white font-bold">{colorThresholds.blue}â€“{colorThresholds.orange}%</div>
                  <div style={{ width: `${colorThresholds.red - colorThresholds.orange}%`, backgroundColor: '#f59e0b' }} className="flex items-center justify-center text-[8px] text-white font-bold">{colorThresholds.orange}â€“{colorThresholds.red}%</div>
                  <div style={{ width: `${Math.max(130 - colorThresholds.red, 20)}%`, backgroundColor: '#ef4444' }} className="flex items-center justify-center text-[8px] text-white font-bold">{'>'}{colorThresholds.red}%</div>
                </div>
              </div>
            </div>
            
          </div>
        </div>
      </div>
    );
  };

  const DbTool = () => {
    const DB_KEYS = ['users','teams','divisions','departments','projects','projectFolders','tasks','notes','vacations','resourceDowntime','projectPhases','workPackages','dependencies','resources','ganttHolidays','highlightedDays','wpBaselines','colorThresholds'];
    const [dbData, setDbData] = React.useState({});
    const [loading, setLoading] = React.useState(true);
    const [inspectKey, setInspectKey] = React.useState(null);
    const [importText, setImportText] = React.useState('');
    const [showImport, setShowImport] = React.useState(false);
    
    React.useEffect(() => {
      (async () => {
        const data = {};
        for (const key of DB_KEYS) {
          try {
            const result = await window.storage.get(key, true);
            if (result) {
              const parsed = JSON.parse(result.value);
              data[key] = { raw: result.value, parsed, count: Array.isArray(parsed) ? parsed.length : typeof parsed === 'object' ? Object.keys(parsed).length : 1, size: result.value.length };
            }
          } catch(e) { /* key missing */ }
        }
        setDbData(data);
        setLoading(false);
      })();
    }, []);
    
    const deleteKey = async (key) => {
      if (confirm(`"${key}" wirklich lÃ¶schen? Beim nÃ¤chsten Laden werden Standarddaten verwendet.`)) {
        await window.storage.delete(key, true);
        const newData = {...dbData};
        delete newData[key];
        setDbData(newData);
      }
    };
    
    const exportAll = () => {
      const exp = {};
      Object.entries(dbData).forEach(([k, v]) => { exp[k] = v.parsed; });
      const blob = new Blob([JSON.stringify(exp, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `kp5_backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
      URL.revokeObjectURL(url);
    };
    
    const importAll = async () => {
      try {
        const data = JSON.parse(importText);
        for (const [key, value] of Object.entries(data)) {
          if (DB_KEYS.includes(key)) {
            await window.storage.set(key, JSON.stringify(value), true);
          }
        }
        alert('Import erfolgreich! Seite wird neu geladen...');
        window.location.reload();
      } catch(e) { alert('Fehler beim Import: ' + e.message); }
    };
    
    return (
      <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[60] p-4">
        <div className="dm-modal bg-white rounded-2xl w-[95%] max-w-[800px] max-h-[90vh] flex flex-col">
          <div className="flex justify-between items-center px-5 py-3 border-b flex-shrink-0">
            <h2 className="text-lg font-bold">ðŸ”§ Datenbank-Verwaltung</h2>
            <div className="flex gap-2">
              <button onClick={exportAll} className="px-3 py-1.5 bg-green-600 text-white rounded-lg text-sm font-medium">ðŸ“¥ Export</button>
              <button onClick={() => setShowImport(!showImport)} className={`px-3 py-1.5 rounded-lg text-sm font-medium ${showImport ? 'bg-blue-600 text-white' : 'bg-blue-100 text-blue-700'}`}>ðŸ“¤ Import</button>
              <button onClick={() => setShowDbTool(false)} className="text-xl text-gray-400 hover:text-gray-600 ml-2">âœ•</button>
            </div>
          </div>
          {showImport && (
            <div className="px-5 py-3 border-b bg-blue-50 space-y-2">
              <p className="text-sm text-blue-800 font-medium">JSON-Backup hier einfÃ¼gen:</p>
              <textarea value={importText} onChange={e => setImportText(e.target.value)} className="w-full h-24 text-xs font-mono border rounded-lg p-2" placeholder='{"users": [...], "teams": [...], ...}' />
              <button onClick={importAll} disabled={!importText.trim()} className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm disabled:bg-gray-300">Importieren & Neu laden</button>
            </div>
          )}
          <div className="flex-1 overflow-y-auto p-5">
            {loading ? (
              <div className="text-center py-8 text-gray-500">Lade Daten...</div>
            ) : (
              <div className="space-y-1">
                <div className="grid grid-cols-[1fr,80px,80px,120px] gap-2 text-xs font-semibold text-gray-500 px-3 pb-2 border-b">
                  <span>SchlÃ¼ssel</span><span className="text-right">EintrÃ¤ge</span><span className="text-right">GrÃ¶ÃŸe</span><span></span>
                </div>
                {DB_KEYS.map(key => {
                  const d = dbData[key];
                  const exists = !!d;
                  return (
                    <div key={key} className="border rounded-lg overflow-hidden">
                      <div className={`grid grid-cols-[1fr,80px,80px,120px] gap-2 items-center px-3 py-2 text-sm ${exists ? 'bg-white' : 'bg-red-50'}`}>
                        <span className="font-medium flex items-center gap-2">
                          <span className={`w-2 h-2 rounded-full ${exists ? 'bg-green-500' : 'bg-red-400'}`} />
                          {key}
                        </span>
                        <span className="text-right text-gray-600">{exists ? d.count : 'â€”'}</span>
                        <span className="text-right text-gray-400">{exists ? (d.size > 1024 ? (d.size/1024).toFixed(1)+'KB' : d.size+'B') : 'â€”'}</span>
                        <div className="flex gap-1 justify-end">
                          {exists && <button onClick={() => setInspectKey(inspectKey === key ? null : key)} className="px-2 py-1 bg-gray-100 rounded text-xs hover:bg-gray-200">ðŸ‘ï¸</button>}
                          {exists && <button onClick={() => deleteKey(key)} className="px-2 py-1 bg-red-100 text-red-600 rounded text-xs hover:bg-red-200">ðŸ—‘ï¸</button>}
                          {!exists && <span className="text-xs text-red-500 italic">fehlt</span>}
                        </div>
                      </div>
                      {inspectKey === key && d && (
                        <div className="border-t bg-gray-50 p-3">
                          <pre className="text-xs font-mono whitespace-pre-wrap max-h-60 overflow-y-auto bg-white border rounded p-2">{JSON.stringify(d.parsed, null, 2)}</pre>
                        </div>
                      )}
                    </div>
                  );
                })}
                <div className="mt-4 pt-4 border-t">
                  <p className="text-sm text-gray-500 mb-2">âš ï¸ SchlÃ¼ssel lÃ¶schen = beim nÃ¤chsten Laden werden Standarddaten verwendet</p>
                  <button onClick={() => { if(confirm('ALLE Daten lÃ¶schen und auf Werkseinstellungen zurÃ¼cksetzen?')) { Promise.all(DB_KEYS.map(k => window.storage.delete(k, true).catch(()=>{}))).then(() => { alert('Alle Daten gelÃ¶scht. Seite wird neu geladen...'); window.location.reload(); }); }}} className="px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium">ðŸ”„ Komplett-Reset</button>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    );
  };


  // WP-Stunden fÃ¼r einen Benutzer an einem bestimmten Tag (aus Projektplanung)
  const getWPHoursForDay = (userId, dateStr) => {
    let total = 0;
    const details = [];
    workPackages.forEach(wp => {
      if (!wp.startDate || !wp.endDate || dateStr < wp.startDate || dateStr > wp.endDate) return;
      const hasChildren = workPackages.some(w => w.parentId === wp.id);
      if (hasChildren) return;
      const allAssign = [
        ...((wp.responsibles || []).map(r => typeof r === 'object' ? r : { userId: r, hours: 0 })),
        ...((wp.editors || []).map(e => typeof e === 'object' ? e : { userId: e, hours: 0 }))
      ];
      const userAssign = allAssign.find(a => a.userId === userId && a.hours > 0);
      if (!userAssign) return;
      const start = new Date(wp.startDate + 'T12:00:00');
      const end = new Date(wp.endDate + 'T12:00:00');
      let workDayCount = 0;
      const d = new Date(start);
      while (d <= end) {
        const dow = d.getDay();
        const ds = formatDate(d);
        if (dow !== 0 && dow !== 6 && !holidays[ds]) workDayCount++;
        d.setDate(d.getDate() + 1);
      }
      if (workDayCount === 0) return;
      const hoursPerDay = userAssign.hours / workDayCount;
      const dayOverride = wp.dailyOverrides?.[userId]?.[dateStr];
      const dayHours = dayOverride !== undefined ? dayOverride : hoursPerDay;
      if (dayHours > 0) {
        total += dayHours;
        const proj = projects.find(p => p.id === wp.projectId);
        details.push({ name: proj?.name || wp.name, wpName: wp.name, projectName: proj?.name || '?', hours: dayHours, color: wp.color || proj?.color || '#6366f1', wpId: wp.id, projectId: wp.projectId });
      }
    });
    return { total, details };
  };

  const TeamDashboard = () => {
    // Berechne Team-Auslastung Ã¼ber alle angezeigten Wochen
    const calculateTeamUtilization = (teamId) => {
      const members = getTeamMembers(teamId);
      let totalHours = 0;
      let totalCapacity = 0;
      
      Array.from({length: WEEKS_TO_SHOW}, (_, weekOffset) => {
        const weekNum = currentWeek + weekOffset;
        const weekDates = getWeekDates(weekNum, currentYear);
        
        members.forEach(member => {
          weekDates.forEach(d => {
            const ds = formatDate(d);
            tasks.forEach(t => {
              if (t.userId === member.id && ds >= t.startDate && ds <= t.endDate) {
                // NUR Stunden fÃ¼r DIESEN Tag addieren!
                totalHours += calculateDayNetHours(member.id, d, t.startHour, t.endHour);
              }
            });
          });
          totalCapacity += getWeekCapacity(member, weekDates);
        });
      });
      
      const utilizationPercent = totalCapacity > 0 ? (totalHours / totalCapacity) * 100 : 0;
      return {
        totalHours: Math.round(totalHours),
        totalCapacity: Math.round(totalCapacity),
        utilizationPercent: Math.round(utilizationPercent),
        freeCapacity: Math.round(totalCapacity - totalHours)
      };
    };

    // NEU: Berechne Team-Auslastung PRO WOCHE
    const calculateTeamUtilizationPerWeek = (teamId) => {
      const members = getTeamMembers(teamId);
      const weeklyData = [];
      
      Array.from({length: WEEKS_TO_SHOW}, (_, weekOffset) => {
        const weekNum = currentWeek + weekOffset;
        const weekDates = getWeekDates(weekNum, currentYear);
        
        let weekHours = 0;
        let weekCapacity = 0;
        
        members.forEach(member => {
          weekDates.forEach(d => {
            const ds = formatDate(d);
            tasks.forEach(t => {
              if (t.userId === member.id && ds >= t.startDate && ds <= t.endDate) {
                // NUR Stunden fÃ¼r DIESEN Tag addieren!
                weekHours += calculateDayNetHours(member.id, d, t.startHour, t.endHour);
              }
            });
          });
          weekCapacity += getWeekCapacity(member, weekDates);
        });
        
        const utilizationPercent = weekCapacity > 0 ? (weekHours / weekCapacity) * 100 : 0;
        weeklyData.push({
          weekNum,
          hours: Math.round(weekHours),
          capacity: Math.round(weekCapacity),
          utilization: Math.round(utilizationPercent),
          free: Math.round(weekCapacity - weekHours)
        });
      });
      
      return weeklyData;
    };

    // Bestimme relevante Teams basierend auf Rolle
    let relevantTeams = [];
    let viewMode = 'team';
    
    if (currentUser.teamRole === 'entrepreneur') {
      relevantTeams = teams;
      viewMode = 'entrepreneur';
    } else if (currentUser.teamRole === 'department_head') {
      if (currentUser.departmentId) {
        // Finde alle divisions im Bereich
        const departmentDivisions = divisions.filter(d => d.departmentId === currentUser.departmentId);
        const divisionIds = departmentDivisions.map(d => d.id);
        // Finde alle teams in diesen divisions
        relevantTeams = teams.filter(t => divisionIds.includes(t.divisionId));
      } else {
        relevantTeams = teams;
      }
      viewMode = 'department';
    } else if (currentUser.teamRole === 'lead') {
      relevantTeams = teams.filter(t => t.id === currentUser.teamId);
      viewMode = 'team';
    }

    return (
      <div className="dm-root min-h-screen bg-gradient-to-br from-indigo-50 to-purple-50">
        <div className="dm-header bg-white shadow-lg sticky top-0 z-10">
          <div className="max-w-full mx-auto px-4 py-2 flex justify-between">
            <div className="flex items-center gap-3">
              <BarChart3 className="w-6 h-6 text-indigo-600" />
              <h1 className="text-lg font-bold">
                {viewMode === 'entrepreneur' && 'Unternehmens-Dashboard - Alle Teams'}
                {viewMode === 'department' && `Bereichs-Dashboard${currentUser.departmentId ? ' - ' + departments.find(d => d.id === currentUser.departmentId)?.name : ' - Alle Bereiche'}`}
                {viewMode === 'team' && 'Team-Dashboard'}
              </h1>
            </div>
            <div className="nav-bar flex gap-2 items-center">
              {/* SchriftgrÃ¶ÃŸe-Slider */}
              <div className="flex items-center gap-2 px-3 py-2 bg-gray-100 rounded-2xl">
                <span className="text-xs text-gray-600">A</span>
                <input 
                  type="range" 
                  min="10" 
                  max="30" 
                  value={dashboardFontSize} 
                  onChange={(e) => setDashboardFontSize(Number(e.target.value))}
                  className="w-32"
                  title={`SchriftgrÃ¶ÃŸe: ${dashboardFontSize}px`}
                />
                <span className="text-lg font-bold text-gray-800">A</span>
              </div>
              
              {/* Undo/Redo/History Buttons */}
              <button 
                onClick={undo} 
                disabled={undoStack.length === 0}
                className={`p-3 rounded-2xl ${undoStack.length > 0 ? 'hover:bg-gray-100' : 'opacity-30 cursor-not-allowed'}`}
                title={`RÃ¼ckgÃ¤ngig (${undoStack.length} verfÃ¼gbar)`}>
                â†¶
              </button>
              <button 
                onClick={redo} 
                disabled={redoStack.length === 0}
                className={`p-3 rounded-2xl ${redoStack.length > 0 ? 'hover:bg-gray-100' : 'opacity-30 cursor-not-allowed'}`}
                title={`Wiederholen (${redoStack.length} verfÃ¼gbar)`}>
                â†·
              </button>
              <button 
                onClick={() => setShowHistory(!showHistory)} 
                className={`p-3 rounded-2xl ${showHistory ? 'bg-blue-100' : 'hover:bg-gray-100'}`}
                title="Ã„nderungshistorie">
                ðŸ“œ
              </button>
              
              {/* Navigation Buttons */}
              <button 
                onClick={() => { setShowDashboard(false); setShowProjectDashboard(false); setShowProjectPlanning(false); setShowResourceCockpit(false); setShowDisposition(false); }} 
                className="px-3 py-1.5 rounded-2xl text-sm bg-gray-100 hover:bg-gray-200"
              >
                <Calendar className="w-4 h-4 inline mr-2" />Schnellplanung
              </button>
              <button 
                className="px-3 py-1.5 rounded-2xl text-sm bg-green-600 text-white"
              >
                <BarChart3 className="w-4 h-4 inline mr-2" />Team Dashboard
              </button>
              <button 
                onClick={() => { setShowDashboard(false); setShowProjectDashboard(true); setShowProjectPlanning(false); setShowResourceCockpit(false); setShowDisposition(false); }} 
                className="px-3 py-1.5 rounded-2xl text-sm bg-gray-100 hover:bg-gray-200"
              >
                <BarChart3 className="w-4 h-4 inline mr-2" />Projekt Dashboard
              </button>
              <button 
                onClick={() => { setShowDashboard(false); setShowProjectDashboard(false); setShowProjectPlanning(true); setShowResourceCockpit(false); setShowDisposition(false); }} 
                className="px-3 py-1.5 rounded-2xl text-sm bg-gray-100 hover:bg-gray-200"
              >
                ðŸ—ï¸ Projektplanung
              </button>
              <button 
                onClick={() => { setShowDashboard(false); setShowProjectDashboard(false); setShowProjectPlanning(false); setShowResourceCockpit(true); setShowDisposition(false); }} 
                className="px-3 py-1.5 rounded-2xl text-sm bg-gray-100 hover:bg-gray-200"
              >
                ðŸ‘¥ Ressourcencockpit
              </button>
              <button 
                onClick={() => { setShowDashboard(false); setShowProjectDashboard(false); setShowProjectPlanning(false); setShowResourceCockpit(false); setShowDisposition(true); }} 
                className="px-3 py-1.5 rounded-2xl text-sm bg-gray-100 hover:bg-gray-200"
              >
                ðŸ“‹ Disposition
              </button>
              
              {currentUser.role === 'admin' && (
                <button onClick={() => setShowAdmin(true)} className="px-3 py-1.5 bg-purple-600 text-sm text-white rounded-2xl">
                  Admin
                </button>
              )}
              <button onClick={() => setDarkMode(d => !d)} className={`p-3 rounded-2xl ${darkMode ? 'bg-indigo-600 text-yellow-200' : 'hover:bg-gray-100'}`} title={darkMode ? 'Light Mode' : 'Dark Mode'}>
                {darkMode ? 'â˜€ï¸' : 'ðŸŒ™'}
              </button>
              <button onClick={() => setShowSettings(true)} className="p-3 hover:bg-gray-100 rounded-2xl">
                <Settings className="w-5 h-5" />
              </button>
              <button onClick={() => { setCurrentUser(null); setSelectedUser(null); setShowLogin(true); setShowDashboard(false); }} 
                className="px-3 py-1.5 bg-gray-100 text-sm rounded-2xl">
                <LogOut className="w-4 h-4 inline mr-2" />Abmelden
              </button>
            </div>
          </div>
        </div>

        <div className="w-full px-2 py-6">
          <div className="bg-white shadow mb-4 rounded-2xl">
            <div className="px-4 py-2 flex justify-between items-center">
              <button onClick={() => setCurrentWeek(w => w === 1 ? 52 : w - 1)} className="px-3 py-1.5 bg-indigo-600 text-white rounded-2xl text-sm">
                <ChevronLeft className="w-5 h-5" />
              </button>
              <div className="font-bold">KW {currentWeek} - {currentWeek + WEEKS_TO_SHOW - 1}</div>
              <button onClick={() => setCurrentWeek(w => w === 52 ? 1 : w + 1)} className="px-3 py-1.5 bg-indigo-600 text-white rounded-2xl text-sm">
                <ChevronRight className="w-5 h-5" />
              </button>
            </div>
          </div>

          {/* TEAM-ÃœBERSICHTSKARTEN */}
          <div className="grid grid-cols-1 lg:grid-cols-2 2xl:grid-cols-3 gap-4 mb-6 dashboard-cards" style={{gridTemplateColumns: 'repeat(auto-fit, minmax(500px, 1fr))'}}>
            {relevantTeams.map(team => {
              const teamUtil = calculateTeamUtilization(team.id);
              const weeklyUtil = calculateTeamUtilizationPerWeek(team.id);
              const isExpanded = expandedTeams[team.id];
              // Hierarchie: team -> division -> department
              const teamDivision = divisions.find(d => d.id === team.divisionId);
              const teamDept = teamDivision ? departments.find(d => d.id === teamDivision.departmentId) : null;
              const members = getTeamMembers(team.id);
              
              return (
                <div key={team.id} className="bg-white rounded-2xl shadow-lg overflow-hidden border-2 border-gray-100">
                  {/* Team Header mit Auslastung */}
                  <div 
                    onClick={() => setExpandedTeams({...expandedTeams, [team.id]: !isExpanded})}
                    className="bg-gradient-to-r from-indigo-500 to-purple-500 p-4 cursor-pointer hover:from-indigo-600 hover:to-purple-600 transition-colors"
                  >
                    <div className="flex justify-between items-start mb-3">
                      <div className="flex-1">
                        <h3 className="text-lg font-bold text-white">{team.name}</h3>
                        {viewMode === 'entrepreneur' && (
                          <p className="text-sm text-purple-100">
                            {teamDivision?.name}{teamDept ? ` â€¢ ${teamDept.name}` : ''}
                          </p>
                        )}
                        <p className="text-xs text-purple-200 mt-1">{members.length} Mitarbeiter</p>
                      </div>
                      <div className="text-white">
                        {isExpanded ? <ChevronUp className="w-5 h-5" /> : <ChevronDown className="w-5 h-5" />}
                      </div>
                    </div>
                    
                    {/* GroÃŸe Auslastungs-Anzeige */}
                    <div className="bg-white/20 rounded-xl p-3 backdrop-blur-sm">
                      <div className="flex justify-between items-end mb-2">
                        <div>
                          <div className="text-3xl font-bold text-white">{teamUtil.utilizationPercent}%</div>
                          <div className="text-xs text-purple-100">Auslastung</div>
                        </div>
                        <div className="text-right">
                          <div className="text-sm font-semibold text-white">{teamUtil.totalHours}h / {teamUtil.totalCapacity}h</div>
                          <div className="text-xs text-purple-100">
                            {teamUtil.freeCapacity > 0 ? `${teamUtil.freeCapacity}h frei` : 'Ãœberlastet!'}
                          </div>
                        </div>
                      </div>
                      
                      {/* Balken */}
                      <div className="w-full bg-white/30 rounded-full h-3 overflow-hidden mb-3">
                        <div 
                          className={`h-full transition-all ${
                            ({ red: 'bg-red-400', orange: 'bg-orange-400', blue: 'bg-yellow-400', green: 'bg-green-400' }[pctTier(teamUtil.utilizationPercent)])
                          }`}
                          style={{width: `${Math.min(teamUtil.utilizationPercent, 100)}%`}}
                        />
                      </div>
                      
                      {/* Wochen-Ãœbersicht */}
                      <div className="grid grid-cols-4 gap-2">
                        {weeklyUtil.map((week, idx) => (
                          <div key={idx} className="bg-white/30 rounded-lg p-2">
                            <div className="text-xs font-semibold text-white mb-1 text-center">KW {week.weekNum}</div>
                            
                            {/* Prozent-Anzeige */}
                            <div className={`text-lg font-bold text-center mb-2 ${
                              ({ red: 'text-red-200', orange: 'text-orange-200', blue: 'text-yellow-200', green: 'text-green-200' }[pctTier(week.utilization)])
                            }`}>
                              {week.utilization}%
                            </div>
                            
                            {/* FÃ¼llstandsbalken */}
                            <div className="w-full bg-white/20 rounded-full h-2 overflow-hidden mb-2">
                              <div 
                                className={`h-full transition-all ${
                                  ({ red: 'bg-red-300', orange: 'bg-orange-300', blue: 'bg-yellow-300', green: 'bg-green-300' }[pctTier(week.utilization)])
                                }`}
                                style={{width: `${Math.min(week.utilization, 100)}%`}}
                              />
                            </div>
                            
                            {/* Stunden */}
                            <div className="text-xs text-purple-100 text-center">{week.hours}h / {week.capacity}h</div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                  
                  {/* Mitglieder-Liste (aufklappbar) */}
                  {isExpanded && (
                    <div className="p-4 bg-gray-50">
                      <h4 className="font-semibold text-sm text-gray-600 mb-3">Teammitglieder:</h4>
                      <div className="grid grid-cols-1 xl:grid-cols-2 gap-2">
                        {members.map(member => {
                          const isMemberExpanded = expandedMembers[member.id];
                          
                          // Berechne Mitarbeiter-Auslastung
                          let memberTotalHours = 0;
                          let memberTotalCapacity = 0;
                          Array.from({length: WEEKS_TO_SHOW}, (_, weekOffset) => {
                            const weekNum = currentWeek + weekOffset;
                            const weekDates = getWeekDates(weekNum, currentYear);
                            weekDates.forEach(d => {
                              const ds = formatDate(d);
                              tasks.forEach(t => {
                                if (t.userId === member.id && ds >= t.startDate && ds <= t.endDate) {
                                  // NUR Stunden fÃ¼r DIESEN Tag addieren, nicht den ganzen Task!
                                  memberTotalHours += calculateDayNetHours(member.id, d, t.startHour, t.endHour);
                                }
                              });
                            });
                            memberTotalCapacity += getWeekCapacity(member, weekDates);
                          });
                          const memberUtil = memberTotalCapacity > 0 ? (memberTotalHours / memberTotalCapacity) * 100 : 0;
                          
                          return (
                            <div key={member.id} className="bg-white rounded-xl border border-gray-200 overflow-hidden">
                              <div 
                                onClick={() => setExpandedMembers({...expandedMembers, [member.id]: !isMemberExpanded})}
                                className="p-3 flex justify-between items-center cursor-pointer hover:bg-gray-50"
                              >
                                <div className="flex items-center gap-3 flex-1">
                                  <div className="flex-1 min-w-0">
                                    <div className="flex items-center gap-3 mb-2">
                                      <span className="font-medium text-gray-800" style={{fontSize: `${dashboardFontSize + 2}px`}}>{member.name}</span>
                                      <button 
                                        onClick={(e) => { e.stopPropagation(); setDetailViewUser(member); }}
                                        className="p-1 hover:bg-indigo-100 rounded transition-colors" 
                                        title="Detailansicht"
                                      >
                                        <Eye className="w-4 h-4 text-indigo-600" />
                                      </button>
                                    </div>
                                    {/* FÃ¼llstandsbalken */}
                                    <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                      <div 
                                        className={`h-full transition-all ${
                                          ({ red: 'bg-red-500', orange: 'bg-orange-500', blue: 'bg-yellow-500', green: 'bg-green-500' }[pctTier(memberUtil)])
                                        }`}
                                        style={{width: `${Math.min(memberUtil, 100)}%`}}
                                      />
                                    </div>
                                  </div>
                                </div>
                                <div className="flex items-center gap-3">
                                  <div className="text-right">
                                    <div className={`font-semibold ${
                                      ({ red: 'text-red-600', orange: 'text-orange-600', blue: 'text-yellow-600', green: 'text-green-600' }[pctTier(memberUtil)])
                                    }`} style={{fontSize: `${dashboardFontSize + 2}px`}}>
                                      {Math.round(memberUtil)}%
                                    </div>
                                    <div className="text-gray-500" style={{fontSize: `${dashboardFontSize}px`}}>{Math.round(memberTotalHours)}h / {Math.round(memberTotalCapacity)}h</div>
                                  </div>
                                  {isMemberExpanded ? <ChevronUp className="w-4 h-4 text-gray-400" /> : <ChevronDown className="w-4 h-4 text-gray-400" />}
                                </div>
                              </div>
                              
                              {/* Wochen-Details pro Mitarbeiter */}
                              {isMemberExpanded && (
                                <div className="px-3 pb-3 pt-1 bg-gray-50 border-t">
                                  <div className="flex gap-2 overflow-hidden">
                                    {Array.from({length: WEEKS_TO_SHOW}, (_, weekOffset) => {
                                      const weekNum = currentWeek + weekOffset;
                                      const weekDates = getWeekDates(weekNum, currentYear);
                                      
                                      // Wochen-Gesamt berechnen
                                      let weekTotal = 0;
                                      let weekCapacity = getWeekCapacity(member, weekDates);
                                      weekDates.forEach(d => {
                                        const ds = formatDate(d);
                                        tasks.forEach(t => {
                                          if (t.userId === member.id && ds >= t.startDate && ds <= t.endDate) {
                                            weekTotal += calculateDayNetHours(member.id, d, t.startHour, t.endHour);
                                          }
                                        });
                                      });
                                      const weekUtil = weekCapacity > 0 ? (weekTotal / weekCapacity) * 100 : 0;
                                      
                                      return (
                                        <div key={weekNum} className="flex-shrink-0 bg-white rounded-lg p-2 border border-gray-200" style={{minWidth: '220px'}}>
                                          <div className="font-semibold mb-1 text-center text-gray-700" style={{fontSize: `${dashboardFontSize + 1}px`}}>KW {weekNum}</div>
                                          
                                          {/* Wochen-FÃ¼llstandsbalken */}
                                          <div className="mb-2">
                                            <div className="flex justify-between items-center mb-1" style={{fontSize: `${dashboardFontSize}px`}}>
                                              <span className={`font-semibold ${
                                                ({ red: 'text-red-600', orange: 'text-orange-600', blue: 'text-yellow-600', green: 'text-green-600' }[pctTier(weekUtil)])
                                              }`}>{Math.round(weekUtil)}%</span>
                                              <span className="text-gray-500 text-xs">{weekTotal.toFixed(1)}h / {weekCapacity}h</span>
                                            </div>
                                            <div className="w-full bg-gray-200 rounded-full h-1.5 overflow-hidden">
                                              <div 
                                                className={`h-full transition-all ${
                                                  ({ red: 'bg-red-500', orange: 'bg-orange-500', blue: 'bg-yellow-500', green: 'bg-green-500' }[pctTier(weekUtil)])
                                                }`}
                                                style={{width: `${Math.min(weekUtil, 100)}%`}}
                                              />
                                            </div>
                                          </div>
                                          
                                          <div className="space-y-1">
                                            {weekDates.slice(1, 6).map((d, i) => {
                                              const ds = formatDate(d);
                                              let tot = 0;
                                              tasks.forEach(t => {
                                                if (t.userId === member.id && ds >= t.startDate && ds <= t.endDate) {
                                                  // Nur Stunden fÃ¼r DIESEN Tag berechnen, nicht den ganzen Task!
                                                  tot += calculateDayNetHours(member.id, d, t.startHour, t.endHour);
                                                }
                                              });
                                              const isVac = isVacation(member.id, d);
                                              const isNonWork = isNonWorkingDay(member, d);
                                              const dayCapacity = getDailyHours(member, d);
                                              const utilization = dayCapacity > 0 ? (tot / dayCapacity) * 100 : 0;
                                              
                                              return (
                                                <div key={i} className="space-y-1">
                                                  <div className="flex justify-between items-center" style={{fontSize: `${dashboardFontSize}px`}}>
                                                    <span className="text-gray-600">
                                                      {['Mo','Di','Mi','Do','Fr'][i]} {d.getDate()}.{d.getMonth()+1}
                                                    </span>
                                                    <span className={`font-semibold ${
                                                      isVac ? 'text-orange-600' : 
                                                      isNonWork ? 'text-gray-400' :
                                                      tot > dayCapacity ? 'text-red-600' : 
                                                      tot > 0 ? 'text-green-600' : 
                                                      'text-gray-400'
                                                    }`}>
                                                      {isVac ? 'ðŸ–ï¸' : isNonWork ? 'frei' : `${tot.toFixed(2)}h`}
                                                    </span>
                                                  </div>
                                                  {/* Project names for this day */}
                                                  {!isVac && !isNonWork && tot > 0 && (() => {
                                                    const dayProjs = {};
                                                    tasks.forEach(t => {
                                                      if (t.userId === member.id && ds >= t.startDate && ds <= t.endDate) {
                                                        const p = projects.find(pr => pr.id === t.projectId);
                                                        if (p) {
                                                          dayProjs[p.id] = dayProjs[p.id] || { name: p.name, color: p.color };
                                                        }
                                                      }
                                                    });
                                                    const pList = Object.values(dayProjs);
                                                    if (pList.length === 0) return null;
                                                    return (
                                                      <div className="flex flex-wrap gap-0.5 mt-0.5">
                                                        {pList.map((p, pi) => (
                                                          <span key={pi} className="text-[8px] px-1 py-0 rounded truncate max-w-[90px]" style={{ backgroundColor: (p.color || '#6366f1') + '20', color: p.color || '#6366f1', fontWeight: 600 }}>{p.name}</span>
                                                        ))}
                                                      </div>
                                                    );
                                                  })()}
                                                  
                                                  {/* FÃ¼llstandsanzeige */}
                                                  {!isVac && !isNonWork && dayCapacity > 0 && (
                                                    <div className="w-full bg-gray-200 rounded-full h-1.5 overflow-hidden">
                                                      <div 
                                                        className={`h-full transition-all ${
                                                          utilization > 0 ? ({ red: 'bg-red-500', orange: 'bg-orange-500', blue: 'bg-yellow-500', green: 'bg-green-500' }[pctTier(utilization)]) : 'bg-gray-400'
                                                        }`}
                                                        style={{width: `${Math.min(utilization, 100)}%`}}
                                                        title={`${Math.round(utilization)}% ausgelastet`}
                                                      />
                                                    </div>
                                                  )}
                                                </div>
                                              );
                                            })}
                                          </div>
                                          
                                          {/* Notizen fÃ¼r diese Woche - IMMER SICHTBAR */}
                                          {(() => {
                                            const weekNote = getWeekNote(member.id, weekNum);
                                            const noteText = weekNote?.text?.trim() || '';
                                            return (
                                              <div className="mt-2 pt-2 border-t border-gray-200">
                                                <div className="flex items-start gap-1">
                                                  <StickyNote className="w-3 h-3 text-indigo-500 mt-0.5 flex-shrink-0" />
                                                  <div className="flex-1" style={{fontSize: `${dashboardFontSize}px`}}>
                                                    {noteText ? (
                                                      <div className="text-gray-700 bg-yellow-50 p-1.5 rounded border border-yellow-200 whitespace-pre-line">{noteText}</div>
                                                    ) : (
                                                      <div className="text-gray-400 italic">Keine Notizen</div>
                                                    )}
                                                  </div>
                                                </div>
                                              </div>
                                            );
                                          })()}
                                        </div>
                                      );
                                    })}
                                  </div>
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        </div>

        {/* Detailansicht Modal */}
        {detailViewUser && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-3xl p-6 w-full max-h-[90vh] overflow-y-auto" style={{maxWidth: '95%'}}>
              <div className="flex justify-between mb-6">
                <h2 className="text-2xl font-bold">Detailansicht: {detailViewUser.name}</h2>
                <button onClick={() => setDetailViewUser(null)} className="text-2xl">âœ•</button>
              </div>
              
              <div className="flex gap-4">
                <div className="w-56 bg-gray-50 rounded-2xl p-4 flex-shrink-0 flex flex-col" style={{maxHeight: '500px'}}>
                  <h3 className="font-bold mb-3">Projekte</h3>
                  <div className="space-y-2 overflow-y-auto flex-1">
                    {projects.sort((a, b) => a.name.localeCompare(b.name)).map(p => (
                      <div key={p.id} className="flex items-center gap-2 p-3 rounded-xl bg-white border-2" style={{borderColor: p.color}}>
                        <div className="w-4 h-4 rounded" style={{backgroundColor: p.color}}></div>
                        <span className="flex-1 text-sm">{p.name}</span>
                      </div>
                    ))}
                  </div>
                </div>
                <div className="flex-1 overflow-x-auto" ref={ganttScrollRef}>
                  <div className="flex gap-4">
                    {Array.from({length: WEEKS_TO_SHOW}, (_, i) => {
                      const weekNum = currentWeek + i;
                      return <WeekColumn key={weekNum} weekNum={weekNum} user={detailViewUser} />;
                    })}
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

        {showAdmin && <AdminPanel />}
      </div>
    );
  };

  const WeekColumn = ({ weekNum, user }) => {
    const weekDates = getWeekDates(weekNum, currentYear);
    if (weekDates.length === 0) return null;
    const weekNote = getWeekNote(user.id, weekNum);
    const isNoteExpanded = expandedNotes[`${user.id}-${weekNum}`] !== false;
    const [localNoteText, setLocalNoteText] = React.useState(weekNote?.text || '');
    React.useEffect(() => { setLocalNoteText(weekNote?.text || ''); }, [weekNote?.text]);

    return (
      <div className="flex-shrink-0" style={{width: 7 * DW + 50}}>
        <div className="bg-gray-50 rounded-2xl p-4">
          <h3 className="text-lg font-bold mb-2 text-center">KW {weekNum}</h3>
          {/* Presence: who else is viewing this user? */}
          {(() => {
            const viewers = onlineUsers.filter(p => p.selectedUserId === user.id);
            if (viewers.length === 0) return null;
            return (
              <div className="flex justify-center gap-1 mb-2">
                {viewers.map(p => (
                  <div key={p.sessionId} className="flex items-center gap-1 bg-white rounded-full px-2 py-0.5 shadow-sm border" style={{ borderColor: p.color }}>
                    <span className="w-2 h-2 rounded-full" style={{ backgroundColor: p.color }} />
                    <span className="text-[10px] font-medium" style={{ color: p.color }}>{p.userName}</span>
                    <span className="text-[9px] text-gray-400">{p.view === 'grobplanung' ? 'ðŸ“‹' : p.view === 'projektplanung' ? 'ðŸ“' : 'ðŸ“Š'}</span>
                  </div>
                ))}
              </div>
            );
          })()}
          
          {/* Button: Aus Vorwoche kopieren */}
          <div className="mb-3 flex justify-center gap-2">
            <button 
              onClick={() => copyTasksFromPreviousWeek(user.id, weekNum)}
              className="px-3 py-1.5 bg-indigo-500 text-white text-xs rounded-lg hover:bg-indigo-600 transition-colors flex items-center gap-1"
              title="Alle Aufgaben aus KW {weekNum - 1} in diese Woche kopieren"
            >
              <Copy className="w-3 h-3" />
              Aus KW {weekNum - 1} kopieren
            </button>
            <button 
              onClick={() => { 
                const weekStart = formatDate(weekDates[1]); // Monday
                const weekEnd = formatDate(weekDates[5]); // Friday
                const weekTasks = tasks.filter(t => t.userId === user.id && t.startDate <= weekEnd && t.endDate >= weekStart);
                if (weekTasks.length === 0) { alert('Keine EintrÃ¤ge in KW ' + weekNum); return; }
                if (confirm(`${weekTasks.length} EintrÃ¤ge in KW ${weekNum} fÃ¼r ${user.name} lÃ¶schen?`)) {
                  const weekTaskIds = new Set(weekTasks.map(t => t.id));
                  saveTasks(tasks.filter(t => !weekTaskIds.has(t.id)));
                }
              }}
              className="px-3 py-1.5 bg-red-100 text-red-600 text-xs rounded-lg hover:bg-red-200 transition-colors flex items-center gap-1"
              title={`Schnellplanung fÃ¼r KW ${weekNum} lÃ¶schen`}
            >
              <Trash2 className="w-3 h-3" />
              KW {weekNum} lÃ¶schen ({tasks.filter(t => t.userId === user.id && t.startDate <= formatDate(weekDates[5]) && t.endDate >= formatDate(weekDates[1])).length})
            </button>
          </div>
          
          <div className="flex mb-1" style={{marginLeft: '40px'}}>
            <div style={{display: 'grid', gridTemplateColumns: `repeat(7, ${DW}px)`, width: 7 * DW}}>
              {weekDates.map((d, i) => {
                const isVacationDay = isVacation(user.id, d);
                const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                const isNonWork = isNonWorkingDay(user, d);
                return (
                  <div key={i} className="flex justify-center">
                    {!isNonWork && (
                      <button onClick={(e) => { e.preventDefault(); e.stopPropagation(); toggleVacation(user.id, d); }}
                        className={`p-1 rounded transition-all ${isVacationDay ? 'bg-orange-400 text-white hover:bg-orange-500' : 'bg-gray-100 text-gray-400 hover:bg-gray-200'}`}
                        title={isVacationDay ? 'Urlaub entfernen' : 'Urlaub markieren'}>
                        <Umbrella className="w-4 h-4" />
                      </button>
                    )}
                  </div>
                );
              })}
            </div>
          </div>
          <div className="flex mb-2" style={{marginLeft: '40px'}}>
            <div style={{display: 'grid', gridTemplateColumns: `repeat(7, ${DW}px)`, width: 7 * DW}}>
              {weekDates.map((d, i) => {
                const isWe = d.getDay() === 0 || d.getDay() === 6;
                const isNonWork = isNonWorkingDay(user, d);
                const dayS = getDaySchedule(user, d);
                const hasSchedule = dayS.end > dayS.start;
                return (
                  <div key={i} className={`text-center flex flex-col justify-center ${isNonWork && !isWe ? 'bg-gray-300' : isWe && hasSchedule ? 'bg-orange-50 border border-orange-200' : isWe ? 'bg-gray-100 border border-gray-200' : 'bg-white border border-gray-200'}`} style={{height: '60px'}}>
                    <div className={`text-xs font-semibold ${isWe ? (hasSchedule ? 'text-orange-600' : 'text-gray-400') : ''}`}>{['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'][d.getDay()]}</div>
                    <div className="text-sm">{d.getDate()}.{d.getMonth() + 1}</div>
                    {hasSchedule ? (
                      <div className={`text-xs mt-0.5 ${isWe ? 'text-orange-500' : 'text-gray-400'}`}>
                        {isNonWork ? 'frei' : `${h2t(dayS.start)}â€“${h2t(dayS.end)}`}
                      </div>
                    ) : (
                      <div className={`text-xs mt-0.5 ${isNonWork ? 'text-gray-500 font-semibold' : 'text-gray-400'}`}>frei</div>
                    )}
                  </div>
                );
              })}
            </div>
          </div>
          <div className="flex">
            <div className="flex flex-col justify-between text-xs text-gray-500 pr-2" style={{width: '40px'}}>
              {Array.from({length: GRID_ROWS}, (_, i) => GRID_END - 1 - i).map(h => (
                <div key={h} className="text-right" style={{height: HH, lineHeight: `${HH}px`}}>{h}:00</div>
              ))}
            </div>
            <div className="relative bg-white rounded-xl" style={{width: 7 * DW, height: GRID_ROWS * HH}}
              onDrop={(e) => {
                e.preventDefault();
                if (draggedProject) {
                  const rect = e.currentTarget.getBoundingClientRect();
                  const x = e.clientX - rect.left;
                  const y = e.clientY - rect.top;
                  const day = Math.floor(x / DW);
                  const hourFloat = GRID_END - (y / HH);
                  const hour = Math.round(hourFloat * 4) / 4; // Auf 0,25h runden
                  
                  // PrÃ¼fe ob Urlaubstag
                  const dropDate = weekDates[day];
                  const isVacationDay = dropDate && isVacation(user.id, dropDate);
                  
                  if (day >= 0 && day < 7 && hour >= GRID_START && hour < GRID_END && !isVacationDay) {
                    addTask(user.id, draggedProject.id, weekDates[day], hour, Math.min(hour + 2, GRID_END));
                  }
                  setDraggedProject(null);
                }
              }}
              onDragOver={(e) => e.preventDefault()}>
              <div className="absolute inset-0" style={{display: 'grid', gridTemplateColumns: `repeat(7, ${DW}px)`, gridTemplateRows: `repeat(${GRID_ROWS}, ${HH}px)`}}>
                {Array.from({length: GRID_ROWS * 7}, (_, i) => {
                  const dayIndex  = i % 7;
                  const rowIndex  = Math.floor(i / 7);
                  const hourSlot  = GRID_END - 1 - rowIndex;
                  const dateForDay = weekDates[dayIndex];
                  const isWe       = dateForDay?.getDay() === 0 || dateForDay?.getDay() === 6;
                  const isVacDay   = dateForDay && isVacation(user.id, dateForDay);
                  const isNonWork  = dateForDay && isNonWorkingDay(user, dateForDay);
                  const isWorkH    = dateForDay && isWorkingHour(user, dateForDay, hourSlot);
                  const weHasSchedule = isWe && dateForDay && getDaySchedule(user, dateForDay).end > getDaySchedule(user, dateForDay).start;
                  // Farb-PrioritÃ¤t: Urlaub > nicht-arbeitstag > Wochenende (ohne Schedule) > auÃŸerhalb Arbeitszeit > normal
                  let bg = '';
                  if (isVacDay)                        bg = 'bg-orange-100';
                  else if (isWe && !weHasSchedule)     bg = 'bg-gray-100';
                  else if (isNonWork && !weHasSchedule) bg = 'bg-gray-100';
                  else if (!isWorkH)                   bg = isWe ? 'bg-orange-50' : 'bg-gray-100';
                  else if (isWe && isWorkH)            bg = 'bg-orange-50/30';
                  return <div key={i} className={`border border-gray-100 ${bg}`}></div>;
                })}
              </div>
              {/* Pausenbalken als proportionale Overlays */}
              {weekDates.map((d, dayIdx) => {
                const dayNum = d.getDay();
                
                // Richtigen Schedule holen
                const userSchedule = user?.dailySchedule || DEFAULT_SCHEDULE;
                const sched = userSchedule[dayNum] || DEFAULT_SCHEDULE[dayNum];
                if (!sched || sched.end <= sched.start) return null;
                
                const breakBars = [];
                
                // Nicht-Arbeitszeit VOR Arbeitsbeginn (grau) - 0,25h genau
                if (sched.start > GRID_START) {
                  const bottom = 0;
                  const height = (sched.start - GRID_START) * HH;
                  breakBars.push(
                    <div key={`${dayIdx}-before`} 
                      className="absolute bg-gray-100 pointer-events-none"
                      style={{
                        left: dayIdx * DW,
                        width: DW,
                        bottom: bottom,
                        height: height,
                        borderTop: '1px solid rgba(0,0,0,0.1)'
                      }}
                    />
                  );
                }
                
                // Nicht-Arbeitszeit NACH Arbeitsende (grau) - 0,25h genau
                if (sched.end < GRID_END) {
                  const bottom = (sched.end - GRID_START) * HH;
                  const height = (GRID_END - sched.end) * HH;
                  breakBars.push(
                    <div key={`${dayIdx}-after`} 
                      className="absolute bg-gray-100 pointer-events-none"
                      style={{
                        left: dayIdx * DW,
                        width: DW,
                        bottom: bottom,
                        height: height,
                        borderBottom: '1px solid rgba(0,0,0,0.1)'
                      }}
                    />
                  );
                }
                
                // Pause 1 - nur wenn explizit konfiguriert
                if (sched.break1Start !== undefined && sched.break1Duration > 0) {
                  const bottom = (sched.break1Start - GRID_START) * HH;
                  const height = sched.break1Duration * HH;
                  breakBars.push(
                    <div key={`${dayIdx}-b1`} 
                      className="absolute break-stripe pointer-events-none rounded"
                      style={{
                        left: dayIdx * DW,
                        width: DW,
                        bottom: bottom,
                        height: height
                      }}
                    />
                  );
                }
                
                // Pause 2 - nur wenn explizit konfiguriert UND Vollzeit
                const workEnd = sched.end || 17;
                const hasBreak2 = workEnd > 13;
                if (hasBreak2 && sched.break2Start !== undefined && sched.break2Duration > 0) {
                  const bottom = (sched.break2Start - GRID_START) * HH;
                  const height = sched.break2Duration * HH;
                  breakBars.push(
                    <div key={`${dayIdx}-b2`} 
                      className="absolute break-stripe pointer-events-none rounded"
                      style={{
                        left: dayIdx * DW,
                        width: DW,
                        bottom: bottom,
                        height: height
                      }}
                    />
                  );
                }
                
                return breakBars;
              }).flat()}
              {(() => {
                // Pre-compute: for each project, which OTHER users work on it?
                const projectOtherUsersMap = {};
                tasks.forEach(ot => {
                  if (ot.userId === user.id) return;
                  if (!projectOtherUsersMap[ot.projectId]) projectOtherUsersMap[ot.projectId] = new Set();
                  projectOtherUsersMap[ot.projectId].add(ot.userId);
                });
                return tasks.filter(t => t.userId === user.id).map(t => {
                const isDrag = draggedTask?.task?.id === t.id;
                const isResize = resizingTask?.task?.id === t.id;
                const startDate = isDrag && draggedTask.previewStartDate ? draggedTask.previewStartDate : t.startDate;
                const endDate = isDrag && draggedTask.previewEndDate ? draggedTask.previewEndDate : isResize && resizingTask.previewEndDate ? resizingTask.previewEndDate : t.endDate;
                const startHour = isDrag && draggedTask.previewStartHour !== undefined ? draggedTask.previewStartHour : isResize && resizingTask.previewStartHour !== undefined ? resizingTask.previewStartHour : t.startHour;
                const endHour = isDrag && draggedTask.previewEndHour !== undefined ? draggedTask.previewEndHour : isResize && resizingTask.previewEndHour !== undefined ? resizingTask.previewEndHour : t.endHour;
                const st = new Date(startDate + 'T12:00:00');
                const ed = new Date(endDate + 'T12:00:00');
                const fd = new Date(weekDates[0]);
                fd.setHours(12, 0, 0, 0);
                const diff = Math.round((st - fd) / 86400000);
                if (diff < 0 || diff >= 7) return null;
                const days = Math.round((ed - st) / 86400000) + 1;
                const proj = projects.find(p => p.id === t.projectId);
                const netHours = calculateNetHours(startHour, endHour, startDate, endDate, t.userId);
                const bottomPos = (startHour - GRID_START) * HH;
                const heightVal = Math.max((endHour - startHour) * HH, HH);
                return (
                  <div key={t.id} onMouseDown={(e) => { if (e.button === 0) { e.preventDefault(); setDraggedTask({ task: t, startX: e.clientX, startY: e.clientY }); } }}
                    onContextMenu={(e) => { e.preventDefault(); e.stopPropagation(); setSpOverlayMenu({ x: e.clientX, y: e.clientY, type: 'sp', projectId: t.projectId, projectName: proj?.name || '?', userId: t.userId }); }}
                    style={{ left: diff * DW, width: days * DW, bottom: bottomPos, height: heightVal, backgroundColor: proj?.color, opacity: 0.7 }} 
                    className="absolute rounded-lg shadow-lg flex flex-col items-center justify-center text-white font-bold cursor-move group">
                    <div onMouseDown={(e) => { e.stopPropagation(); setResizingTask({ task: t, dir: 'top', startX: e.clientX, startY: e.clientY, origEnd: t.endHour }); }}
                      className="absolute top-0 left-0 right-0 h-2 cursor-ns-resize hover:bg-black/20 z-10" />
                    <div className="text-sm font-bold pointer-events-none truncate px-1 text-center w-full">{proj?.name}</div>
                    {/* Other MAs on same project */}
                    {(() => {
                      const otherUserIds = projectOtherUsersMap[t.projectId];
                      if (!otherUserIds || otherUserIds.size === 0) return null;
                      const otherNames = [...otherUserIds].map(uid => users.find(u => u.id === uid)).filter(Boolean);
                      return (
                        <div className="absolute bottom-1 left-1 flex items-center gap-0.5 pointer-events-none" title={`Auch zugewiesen: ${otherNames.map(u => u.name).join(', ')}`}>
                          {otherNames.slice(0, 3).map((u, i) => (
                            <span key={i} className="text-[8px] bg-white text-gray-700 rounded-full w-4 h-4 flex items-center justify-center font-bold shadow-sm border border-gray-200">{u.name.split(' ').map(w => w[0]).join('').slice(0,2)}</span>
                          ))}
                          {otherNames.length > 3 && <span className="text-[8px] bg-white text-gray-600 rounded-full px-1 shadow-sm border border-gray-200">+{otherNames.length - 3}</span>}
                        </div>
                      );
                    })()}
                    <div className="text-xs pointer-events-none opacity-80">{h2t(startHour)}â€“{h2t(endHour)}</div>
                    <div className="text-xs pointer-events-none">
                      {netHours.break > 0 ? (
                        <span title={`${netHours.gross.toFixed(2)}h brutto - ${netHours.break.toFixed(2)}h Pause`}>
                          {netHours.net.toFixed(2)}h
                        </span>
                      ) : (
                        `${netHours.net.toFixed(2)}h`
                      )}
                    </div>
                    <div onMouseDown={(e) => { e.stopPropagation(); setResizingTask({ task: t, dir: 'right', startX: e.clientX, startY: e.clientY }); }}
                      className="absolute right-0 top-0 bottom-0 w-2 cursor-ew-resize hover:bg-black/20 z-10" />
                    <div onMouseDown={(e) => { e.stopPropagation(); setResizingTask({ task: t, dir: 'bottom', startX: e.clientX, startY: e.clientY, origStart: t.startHour }); }}
                      className="absolute bottom-0 left-0 right-0 h-2 cursor-ns-resize hover:bg-black/20 z-10" />
                    
                    {/* Button: In nÃ¤chste Woche kopieren */}
                    <button 
                      onMouseDown={(e) => e.stopPropagation()} 
                      onClick={(e) => { e.stopPropagation(); copyTaskToNextWeek(t); }} 
                      className="absolute top-1 right-7 opacity-0 group-hover:opacity-100 bg-green-500 hover:bg-green-600 rounded-lg p-1 z-20 min-w-[18px] min-h-[18px] flex items-center justify-center"
                      title="In nÃ¤chste Woche kopieren"
                    >
                      <ArrowRight className="w-3 h-3" />
                    </button>
                    
                    {/* Button: LÃ¶schen */}
                    <button onMouseDown={(e) => e.stopPropagation()} onClick={(e) => { e.stopPropagation(); deleteTask(t.id); }} 
                      className="absolute top-1 right-1 opacity-0 group-hover:opacity-100 bg-red-500 rounded-lg p-1 z-20 min-w-[18px] min-h-[18px] flex items-center justify-center">
                      <Trash2 className="w-3 h-3" />
                    </button>
                  </div>
                );
              }).filter(Boolean);
              })()}
              {/* WP-Stunden aus Projektplanung als Overlay */}
              {weekDates.map((d, dayIdx) => {
                const dayNum = d.getDay();
                const isWe = dayNum === 0 || dayNum === 6;
                const dayCapacity = getDailyHours(user, d);
                if (isWe && dayCapacity === 0) return null;
                const ds = formatDate(d);
                const wpData = getWPHoursForDay(user.id, ds);
                if (wpData.total <= 0) return null;
                const userSched = (user?.dailySchedule || DEFAULT_SCHEDULE)[dayNum];
                const workStart = userSched?.start || GRID_START;
                const bottomPos = (workStart - GRID_START) * HH;
                const maxBarH = GRID_ROWS * HH - bottomPos;
                // Render individual segments stacked from bottom
                let stackY = 0;
                return (
                  <React.Fragment key={'wp_' + dayIdx}>
                    {wpData.details.map((det, si) => {
                      const segH = Math.max(det.hours * HH, 22);
                      const y = stackY;
                      stackY += segH;
                      return (
                        <div key={`wp_${dayIdx}_${si}`}
                          className="absolute pointer-events-auto cursor-pointer group"
                          style={{ left: dayIdx * DW + 2, width: DW - 4, bottom: bottomPos + y, height: Math.min(segH, maxBarH - y), zIndex: 3 }}
                          title={`ðŸ“ ${det.projectName}\nâ†³ ${det.wpName}\n${det.hours.toFixed(1)}h`}
                          onClick={() => { setShowProjectPlanning(true); setShowDashboard(false); setShowProjectDashboard(false); setShowResourceCockpit(false); setShowDisposition(false); }}
                          onContextMenu={(e) => { e.preventDefault(); e.stopPropagation(); setSpOverlayMenu({ x: e.clientX, y: e.clientY, type: 'pp', projectId: det.projectId, wpId: det.wpId, projectName: det.projectName, wpName: det.wpName, userId: user.id }); }}
                        >
                          <div className="w-full h-full rounded" style={{ backgroundColor: det.color, opacity: 0.2, border: `2px dashed ${det.color}` }} />
                          <div className="absolute inset-0 flex flex-col items-center justify-center overflow-hidden px-1" style={{ fontSize: 10, lineHeight: '12px' }}>
                            <span className="truncate w-full text-center font-bold" style={{ color: det.color }}>ðŸ“ {det.projectName}</span>
                            {segH > 30 && det.wpName !== det.projectName && <span className="truncate w-full text-center" style={{ color: det.color, opacity: 0.7, fontSize: 9 }}>{det.wpName}</span>}
                            <span className="font-bold" style={{ color: det.color, fontSize: 11 }}>{det.hours.toFixed(1)}h</span>
                          </div>
                        </div>
                      );
                    })}
                  </React.Fragment>
                );
              })}
              {/* Disposition-EintrÃ¤ge als Overlay */}
              {weekDates.map((d, dayIdx) => {
                const dayNum = d.getDay();
                const isWe = dayNum === 0 || dayNum === 6;
                const dayCapacity = getDailyHours(user, d);
                if (isWe && dayCapacity === 0) return null;
                const ds = formatDate(d);
                const cell = (dispositions || []).find(de => de.userId === user.id && de.date === ds);
                if (!cell?.projectId) return null;
                const userSched = (user?.dailySchedule || DEFAULT_SCHEDULE)[dayNum];
                const workStart = userSched?.start || GRID_START;
                const workEnd = userSched?.end || GRID_END;
                const workH = workEnd - workStart;
                const barH = Math.max(workH * HH * 0.3, 20);
                const bottomPos = (workEnd - GRID_START) * HH - barH;
                return (
                  <div key={'dispo_' + dayIdx}
                    className="absolute pointer-events-auto cursor-pointer"
                    style={{ left: dayIdx * DW + 2, width: DW - 4, bottom: bottomPos, height: barH, zIndex: 2 }}
                    title={`âœï¸ Disposition\n${cell.label}\n(Klick â†’ Disposition Ã¶ffnen)`}
                    onClick={() => { setShowDisposition(true); setShowDashboard(false); setShowProjectDashboard(false); setShowProjectPlanning(false); setShowResourceCockpit(false); }}
                    onContextMenu={(e) => { e.preventDefault(); e.stopPropagation(); setSpOverlayMenu({ x: e.clientX, y: e.clientY, type: 'dispo', projectId: cell.projectId, projectName: cell.label, userId: user.id }); }}
                  >
                    <div className="w-full h-full rounded" style={{ backgroundColor: cell.color || '#94a3b8', opacity: 0.18, border: `2px dotted ${cell.color || '#94a3b8'}` }} />
                    <div className="absolute inset-0 flex flex-col items-center justify-center overflow-hidden px-1" style={{ fontSize: 10, lineHeight: '12px' }}>
                      <span className="truncate w-full text-center font-bold" style={{ color: cell.color || '#94a3b8' }}>âœï¸ {cell.label}</span>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
          <div className="border-t-2 mt-3 pt-3" style={{marginLeft: '40px'}}>
            <div style={{display: 'grid', gridTemplateColumns: `repeat(7, ${DW}px)`, width: 7 * DW}}>
              {weekDates.map((d, i) => {
                const ds = formatDate(d);
                let tot = 0;
                const dayNum = d.getDay();
                const sched = (user?.dailySchedule || DEFAULT_SCHEDULE)[dayNum];
                
                tasks.forEach(t => { 
                  if (t.userId === user.id && ds >= t.startDate && ds <= t.endDate) {
                    // Netto-Stunden fÃ¼r diesen Tag berechnen
                    const dayGross = t.endHour - t.startHour;
                    let dayNet = dayGross;
                    
                    // Nur Werktage
                    if (dayNum !== 0 && dayNum !== 6 && sched) {
                      // Pause 1 Ãœberschneidung
                      const break1Start = sched.break1Start || 0;
                      const break1Duration = sched.break1Duration || 0;
                      const break1End = break1Start + break1Duration;
                      
                      if (break1Duration > 0) {
                        const overlap1Start = Math.max(t.startHour, break1Start);
                        const overlap1End = Math.min(t.endHour, break1End);
                        if (overlap1Start < overlap1End) {
                          dayNet -= (overlap1End - overlap1Start);
                        }
                      }
                      
                      // Pause 2 Ãœberschneidung (nur wenn nicht Teilzeit)
                      const workEnd = sched.end || 17;
                      const hasBreak2 = workEnd > 13;
                      
                      if (hasBreak2) {
                        const break2Start = sched.break2Start || 0;
                        const break2Duration = sched.break2Duration || 0;
                        const break2End = break2Start + break2Duration;
                        
                        if (break2Duration > 0) {
                          const overlap2Start = Math.max(t.startHour, break2Start);
                          const overlap2End = Math.min(t.endHour, break2End);
                          if (overlap2Start < overlap2End) {
                            dayNet -= (overlap2End - overlap2Start);
                          }
                        }
                      }
                    }
                    
                    tot += dayNet;
                  }
                });
                const isWe = d.getDay() === 0 || d.getDay() === 6;
                const isVac = isVacation(user.id, d);
                const isNonWork = isNonWorkingDay(user, d);
                const dayCapacity = getDailyHours(user, d);
                const weWorking = isWe && dayCapacity > 0;
                const isEffectivelyOff = (isWe && !weWorking) || isNonWork;
                const wpData = (!isEffectivelyOff && !isVac) ? getWPHoursForDay(user.id, ds) : { total: 0, details: [] };
                const combinedTotal = tot + wpData.total;
                const ratio = dayCapacity > 0 ? combinedTotal / dayCapacity : 0;
                const tier = getColorTier(ratio);
                const tierColor = tier === 'red' ? 'bg-red-400 text-white' : tier === 'orange' ? 'bg-orange-400 text-white' : tier === 'blue' ? 'bg-blue-400 text-white' : combinedTotal > 0 ? 'bg-green-400 text-white' : 'bg-gray-200';
                return (
                  <div key={i} className="text-center px-1">
                    <div className={`py-1 rounded font-bold ${
                      isVac ? 'bg-orange-400 text-white' : 
                      isEffectivelyOff ? 'bg-gray-300 text-gray-500' :
                      weWorking ? (combinedTotal > 0 ? tierColor + ' ring-1 ring-orange-300' : 'bg-orange-100') :
                      tierColor
                    }`}>
                      {isVac ? 'ðŸ–ï¸' : isEffectivelyOff ? 'frei' : combinedTotal > 0 ? `${combinedTotal.toFixed(2)}h` : ''}
                    </div>
                    {/* Project names for this day */}
                    {!isEffectivelyOff && !isVac && (() => {
                      const dayProjects = {};
                      // SP tasks
                      tasks.forEach(t => {
                        if (t.userId === user.id && ds >= t.startDate && ds <= t.endDate) {
                          const p = projects.find(pr => pr.id === t.projectId);
                          if (p) {
                            const dayGross = t.endHour - t.startHour;
                            dayProjects['sp_' + p.id] = dayProjects['sp_' + p.id] || { name: p.name, color: p.color, hours: 0, source: 'ðŸ“‹' };
                            dayProjects['sp_' + p.id].hours += dayGross;
                          }
                        }
                      });
                      // PP WP details
                      wpData.details.forEach(det => {
                        const key = 'pp_' + det.wpId;
                        dayProjects[key] = { name: det.projectName, wpName: det.wpName, color: det.color, hours: det.hours, source: 'ðŸ“' };
                      });
                      // Dispo entry
                      const dispoCell = (dispositions || []).find(de => de.userId === user.id && de.date === ds);
                      if (dispoCell?.projectId) {
                        dayProjects['di_' + dispoCell.projectId] = { name: dispoCell.label, color: dispoCell.color || '#94a3b8', hours: 0, source: 'âœï¸' };
                      }
                      const projList = Object.values(dayProjects);
                      if (projList.length === 0) return null;
                      return (
                        <div className="mt-0.5 space-y-0">
                          {projList.map((p, pi) => (
                            <div key={pi} className="text-[10px] truncate font-medium flex items-center gap-0.5" style={{ color: p.color || '#6366f1' }} title={`${p.source} ${p.name}${p.wpName && p.wpName !== p.name ? ' â†’ ' + p.wpName : ''}: ${p.hours > 0 ? p.hours.toFixed(1) + 'h' : ''}`}>
                              <span style={{ fontSize: 8 }}>{p.source}</span>
                              <span className="truncate">{p.name}</span>
                            </div>
                          ))}
                        </div>
                      );
                    })()}
                    {/* Day Notes */}
                    {!isEffectivelyOff && !isVac && (() => {
                      const myNotes = (dayNotes || []).filter(n => n.userId === user.id && n.date === ds);
                      return (
                        <div className="mt-0.5">
                          {myNotes.map((n, ni) => (
                            <div key={ni} className="text-[9px] truncate rounded px-1 py-0.5 mt-0.5 cursor-pointer font-medium flex items-center gap-0.5"
                              style={{ backgroundColor: (n.color || '#6b7280') + '20', color: n.color || '#6b7280', border: `1px solid ${(n.color || '#6b7280')}40` }}
                              title={`${n.icon || 'ðŸ“'} ${n.text}`}
                              onClick={(e) => { e.stopPropagation(); setDayNoteEditor({ userId: user.id, date: ds, note: n }); }}>
                              <span>{n.icon || 'ðŸ“'}</span>
                              <span className="truncate">{n.text}</span>
                            </div>
                          ))}
                          <button className="text-[8px] mt-0.5 opacity-30 hover:opacity-100 transition-opacity"
                            onClick={(e) => { e.stopPropagation(); setDayNoteEditor({ userId: user.id, date: ds }); }}
                            title="Notiz hinzufÃ¼gen">
                            + Notiz
                          </button>
                        </div>
                      );
                    })()}
                  </div>
                );
              })}
            </div>
          </div>
          <div className="mt-3">
            <button onClick={() => { 
              // Scroll-Position speichern
              if (ganttScrollRef.current) {
                setSavedScrollPosition(ganttScrollRef.current.scrollLeft);
              }
              const key = `${user.id}-${weekNum}`; 
              setExpandedNotes(prev => ({...prev, [key]: prev[key] === false ? true : false})); 
            }} 
              className="flex items-center gap-2 text-sm text-indigo-600 hover:text-indigo-800">
              <StickyNote className="w-4 h-4" />
              Notizen KW {weekNum}
            </button>
            {isNoteExpanded && (
              <textarea value={localNoteText} onChange={(e) => setLocalNoteText(e.target.value)}
                onBlur={() => updateWeekNote(user.id, weekNum, localNoteText)}
                className="w-full mt-2 p-2 border rounded" rows="3" placeholder="Notizen fÃ¼r diese Woche..." />
            )}
          </div>
        </div>
      </div>
    );
  };

  // ðŸ” PASSWORT-SCREEN - wird als erstes gezeigt
  if (!isAuthenticated) {
    const handlePasswordSubmit = (e) => {
      e.preventDefault();
      if (passwordInput === APP_PASSWORD) {
        setIsAuthenticated(true);
        setPasswordError(false);
      } else {
        setPasswordError(true);
        setPasswordInput('');
      }
    };
    
    return (
      <div className="min-h-screen flex items-center justify-center relative overflow-hidden" style={{ backgroundImage: 'url(data:image/jpeg;base64,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)', backgroundSize: 'cover', backgroundPosition: 'center' }}>
        {/* Subtle vignette */}
        <div className="absolute inset-0" style={{ background: 'radial-gradient(ellipse at center, transparent 40%, rgba(0,0,0,0.2) 100%)' }} />
        
        {/* KapazitÃ¤tsplaner V5 - centered overlay */}
        <div className="absolute top-12 left-0 right-0 text-center pointer-events-none">
          <h1 className="text-white font-bold" style={{ fontSize: 48, textShadow: '0 2px 30px rgba(0,0,0,0.4)', letterSpacing: 4, fontFamily: 'system-ui' }}>KapazitÃ¤tsplaner V5</h1>
        </div>
        
        {/* Login card */}
        <div className="bg-white/95 backdrop-blur-sm rounded-3xl shadow-2xl p-8 max-w-md w-full relative z-10">
          <div className="text-center mb-6">
            <div className="w-16 h-16 mx-auto mb-4 bg-indigo-600 rounded-full flex items-center justify-center">
              <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
              </svg>
            </div>
            <p className="text-gray-500 text-sm">Bitte Passwort eingeben</p>
          </div>
          
          <form onSubmit={handlePasswordSubmit} className="space-y-4">
            <div>
              <input
                type="password"
                value={passwordInput}
                onChange={(e) => {setPasswordInput(e.target.value); setPasswordError(false);}}
                placeholder="Passwort"
                className={`w-full p-4 border-2 rounded-2xl text-lg focus:outline-none focus:border-indigo-600 transition-colors ${
                  passwordError ? 'border-red-500 bg-red-50' : 'border-gray-300'
                }`}
                autoFocus
              />
              {passwordError && (
                <p className="text-red-600 text-sm mt-2 flex items-center gap-2">
                  <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                  </svg>
                  Falsches Passwort. Bitte erneut versuchen.
                </p>
              )}
            </div>
            
            <button
              type="submit"
              className="w-full p-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-2xl font-bold text-lg hover:shadow-xl transition-shadow"
            >
              Anmelden
            </button>
          </form>
          
          <div className="mt-6 pt-6 border-t text-center">
            <p className="text-sm text-gray-500">
              Standard-Passwort: <code className="bg-gray-100 px-2 py-1 rounded">Team2025</code>
            </p>
            <p className="text-xs text-gray-400 mt-2">
              Hinweis: Passwort kann in der Datei geÃ¤ndert werden
            </p>
          </div>
        </div>
      </div>
    );
  }

  if (showLogin) {
    return (
      <div className="min-h-screen flex items-center justify-center" style={{ backgroundImage: 'url(data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/4gHYSUNDX1BST0ZJTEUAAQEAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADb/2wBDAAUDBAQEAwUEBAQFBQUGBwwIBwcHBw8LCwkMEQ8SEhEPERETFhwXExQaFRERGCEYGh0dHx8fExciJCIeJBweHx7/2wBDAQUFBQcGBw4ICA4eFBEUHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh7/wAARCAWGB9ADASIAAhEBAxEB/8QAHAABAQEBAQEBAQEAAAAAAAAAAAECAwcIBgUE/8QAHxABAQEBAQEBAQEBAQEAAAAAAAERAjEhQRJhUXGB/8QAHAEBAQEBAQEBAQEAAAAAAAAAAAECBwMGCAUE/8QAFxEBAQEBAAAAAAAAAAAAAAAAABEBEv/aAAwDAQACEQMRAD8A/U1mtM1zl/BRKtRRKxWqzWsEZq6VRipVqNYM1hq+stCdMtdM3/q4JWK3WL60M1K1WauDNZ6brHTWK51mt9MX1vBjrxiunTHTeDNc763WOmsGa59N3WK1gz1459OnTn03gxXPp0rHT0wYv1itVmt4MVit31jr41iufbnXTpz6emKx05dOneufT0wY68c630xW8GL4x1W+vHPpvBz6rF8brHT0wY6c+m659N4MdMdNdMV6YrHTl1661z6bxHO+s9N1it4Vixz6devHPp6YVjpmtdMVrFZrnW+vHOt4M1KqVvBiudb6YrWDNZq1K3gxWb630xWsERUUSs1qstGjPSpauIyzY2zVwZSqVrBGWqyoAAAAFEq4JUsaRRlFoYIAogAAAoAuGoFFRAFAAAAAAAAAAAAAAAAAAABAAAAUACAAgC4VUQAUAAAXBYqRVAAZAABfIkUWAKC4T1REkUFAFiooCofigJoAqLPVSKAsSKGgDSDWJPVEAAoC4qIsgoIoLiUAigKAkUwABZBEGhSpIYoImKBAAIAYuEEFwxRBcMBBcMBBcMBBcAqYuARKACgAAAACxKCwxIIYuGLFQaxMQBQKmCgMi4YCYY1iWAmCyGIILhhBBTFEGkxIIqhCsi4YQQXDATBcMIJhi4UEsFEEsTGsMIPrmpVrLhz/AFJUpfUaglZtarNUZKCiVlrpmtYM1m+tsdKJWK2zWsGWeo0l/wCVoYrNW+lUZrFbrFaVisVqs1vBm1jprpitYMWs3xusVvBisVvqMVrBmufTpWOm8HKsdOnTHTeDn16z0116xW8Gaz1410xY3iufTn06dOfTeKx05dOnTl29MGOmOm6x149MHPpjpvpi+N4MVz6btc+vj0wYrn03WOnpgxfHPt0rl01gx/jHbdY6emDnWa3fGOmxz6Y69dOnOt4rPTHS31i16YJ0xfGqz03iMJVS+NRWOo59OnXjHTeDFZrVZreDPTNXr1FESwp+NDPTONVFxGaz01Wa1is6uolUis1dRcRGWqjWCAKACQShQABRlK1UBkWoogqAAKACiFAEAABVwQAABYACAAAAAAAAAAAAAAAAAAAsRoQAESo0lFQBVFhiqAAgAIEFjQUgBoCiEUFABQUimMhCKoALGV/CCgC4mBVgLPVxBQUAFZAXAICxTQxcCImCigCwRBcMURSRQABAFkUQUBDFFgYAQABKAEKAuCILhhBBQEFwwAxcATDFATDFAEUBMVcMFQXBRBcMQqCgIKCILYYCC4mACmCoLhgVAxcIiLgpFZFphEQxcUgmJjRiQZMawIMi2GEEFMWCDWGJCsjWCwfWtSrUvjheP9jNRajQlZrbNijP4kaZq4FZrVSrgxWa1UrQxWa1WauDNZ68brHTeDNRaijHXjHXjpXLr1rFZrNa6YreIz0xW6xWsVmsdN1jqN4OfV/Ga11Gb63gx0xa6Vz6awYrHXjfTFbwc+memumK3gzWOr9b6c+vG8GOr9c+vW+vXO16YrHTn06Vz6bxXPpjpvpjp6YOdY7rdc+m8GL9c+2659vTBiufTp05X16YJfHLt1rl23isVz6dLjFjeI51jpu+s9PTBz6Y6dOo59etYrn0x143XPp6YM1mtVjr1vBGeqqVvBnpit9OdawZqXxazWsGemW6jQ52fRalaGalasZrSM1mtVFGcRqpYpWai1GhCgCVGmWsAEoACgipQSgAJYoDNRqoCBSNAAuCI0lgIAgLEAUVK1ggqKAAAAACQAEAAAAAAAAAAAFgEigMgACVUqxcRYKpQAUAEAFQikFBcIojKxRQAgi4YoqAEBQWNYiLDFEFiKpoCxURYKAAqUFFQFAIpAQBfxUQFkAxQWIAKALgIuAACqlQXDAQaFiIKEEMUBPigQoKYQqYLhhCoLhhEqC4EVFxQEwxQEwUCoKEKBi4pUFBKguGJCoYopUwawwKyKEKhiiQqYKmEKBi4pUwxQhTDFwxIVBcMWCEi4qQrIphBFxQiMjSYQQkXDCLUFwxYlQaEhX1nWa1WXCsf7majVGhlOlqKMs1qp0oh14WpVGb4zWqza0M31it1n9XBOnPp0rHTWDmCXxoZ6YrXTNbxWKyvSNYMdT6zc1rpjr1rBmsdX43WOm8GOvHPpus1vBhm+tVz68awZ6YrXTHXjeDNc611Wa3gxWOq10xXpisdOfXyOnVtc+m8HO3459Oncc69MGKx010x03iufTn1W+q5369MGKx03WOo3g59eOddenOx6YMdVy6+unbnW8GGeq3059N4Mdf4zWqy2MdOfTp0531vBz6YrfbFemKxWOvW+r6w3iM1G6x01hWOma1Wa3gzWK1Wa1iozWr4zWkZotRpdS+MVqstYjNRus1oZQoolZarKiUVMASqlXBChWhAAGa0zQAAAAEqoohiooIqAAKJYjSEEFqILFZaXBMFRcEFRQAAAAAQAEAAAAAAAFkAkUBkAAAUAFAAAAABcAxYKALBNIoKCwiiagouIARQikBFipFVAFxcKQFxUBQEigqCxGlTUUCIEFUAWCKAuIC4WKISLgBgCgpijKYZ9UUACALgQqCipUXFATDFATBQADABcMBBQEwxQExcAExcFwEFsMWIguGEKi4oQqYYoQrI0YQqYphhEBcQgAYQTEaxcItZwxcXCFTBQiVBcATDFAqChCoKuEKzFxcMCs4uLgRKyYq4QqYYuGEKmDWJiiGLiwg+sEpUrg7+glAUZqNVm+tCVmtJQYoVNawSsda1WerrQzUpazWsC1jpaxWsEtZtWs9NYM9Vi1qs9N4rNYrVZrWIzWK10zWsVms9NVjpoY6YrfTHTeDPXjn1GumLfreDFjHTfVc+m8GOmK3Wem8HKs3411/jHVbxWb659Vvpz6bwY6rFavrFemDHVc+m+mOnpiufXjnXXpy6bwYrN8Ws9VvBjpzrfVYreDHXrn030x03gxXLr66dOdeuDHTNbrFbwZ6c+m+qxW8HPr1iunUY6lbxXPtjxvpmt4jPVZrV+I1gxWK319rFbwYrNarNaGaKzWhOmVo3gyy1iWKJWatStYMdI1UsVWekaTFRAFggUUZKtSqIQGgSqlZEAWAAAAogqAiKgACgAAmKAmEUAABKKKIiiiAAAAAIAAABAFkU1EkUEQAAAUAIoLAASxQEWAAYKYIKjQNRIpiCyJGlTUFQRQMUFiRVTRYSKqALAMBppEigIAKgsRQFBUCCxQXEaVAAQWAoAqxKgsighPiggC4omLiioigAigAosEGsRBMXFwEqYNJiwqLihCphirCFRMXDFRMVcMBBQEMUQMTFFEwxQKYYBCmApCoLhhEqKuCwZGjAZFsMSFRTFWCYKAyuKAmCmERlcawwhUFwzAqDRgVkxcxcCs2LimESphjWFiwZxVxMIJhjWCDOKuCrX1ZUWpXBn9FASglRaxa0LazaWsrmCVKtZawSsVqsVoQqs9KM9MdNVmtYM1npqs3xvBis9NVi361is1mtX1mtYMdM1q/WK1gzWK30xb/ANbwY69Z6Ws1rBjpz6b7c69MGax23WO/W8GKx143WOm8HPpit9OfXreKzXPp0rn363iOdYrp05X43isdeudb73XPp6YrNc+m+r8c69MGKx1G6x03g51jpvpjqt4OfTFb6usPTBjqufVdOnLpvBlmtVjpvBmxmqz03gzWOm6591vBz6ZsaqVsZ68Yrd8YrWDNYrfTFaGazWqzWsGUrVY/WxLCrYlXNGalaZvxrNGKli1loEqouCVFPGhmo1SrUZqLUVRMVKozUaSqJBFQLEaRRBTFGRagCKgAAIKlXAAAAAAABREFMCoi4KqIoogAAuGAgpgIuKJUoAiACgAQAXFEUAAFgAILBSiMqSGKVFCKKCxUIoLiAEBYAqC4RTEAI0EVZFwiJFBU0AaQWQigihCIEL/xVAFixCRRcVEkUFgAsEFDFQBZAqYYqkSpIoKBigJ+rgsiiC4YJUWRRYUBcREMUUMMAhTDAWJQFCoLi4QrI1hhCsjRhCsquEhCphi4EEwxRRBVwiVBcAqC4YQqDRgVJDGsSkRDFwwgyuLhhCsri4uEKziqKVMXAIlDACguGBUFwwKguKsKyuKuERnDGsEgzirhixaiY1hiQqC4YQr6prNX1HBX9MrK1mrgWsVqs1rBkBoTrxlqs1cGemK1Wa0IlLWevVwSs9LWa1gzazatZaxUrn03Wa1gxWa1Wa2M1itdVi1cErFatY68bwYrNq1npvBnpyrpa59et4M1zrpXPr1vBisdN9Vz6reDPTlfXTqsWzW8Vi1jpuufbeDHVc+m+nPq/Xpis9OXTp1XOt4OfbN8a7YsemIxWOmqz03iufTn06dOdx6YMWM1qs9eN4OfUcunTrWLXpgxWK30zWsGL8jFb6YreDNc+m+3LpvBms1us43gzfGK3WOmsGL6lWpWhipWqzW8GL6zW6zY0JUWouCVjpusVrBn8SrRoZqL0i4IjSVcES0vo1giYpVwQBRMSz40KOdhGrGbFFEUEFQRDAESo0lgtQAUKC4IKgAAALBCACAABYAIKmNLQAKABQAQASAAoAABigSAAAKALhoRQEAFAAgC4KlSNAqAEUFAQWI0qAACwixpFgAgBFQWQVUqCwwCRQUAWRpCLhFEJAWKEhiispn1RcBI0iqgEXAQXAExZFMVCCgUMMVUQXBRMXFQKC4YJUVZBYJhirhEZwxrFkIVnFxrAKzhi0xUQXDATDFxcBlTFwEMUBMLFXFhWRbAhUkXFwxIlQaTFgYjQCI0AyNBEqYYuLgVmQxaBUwxcXAqJjeGEKyNYYsSsxcXFkIVnDGsMIVJCxrAiVnFXDFEMakXCFZwxcXCFZwxcWQhWMXFwxIV9SRKsSuBv6yVKJfWhKzWqyuDNCpWhOmbVrK4jN9ZrXTNaVGaus2tCVktZ1QuMX1qsdetYJax0vTNreDPTFrXTHXjWKzfWarNreCdeMWtdeMVoZrFb6YrWDn2xXS/XOt4M2ufbpXLr1vBisdN1jp6YMdudrp1HLqN4rPVZ6q2MdN4MdVitdMVvFY6Yrdc+npgx1WK10xa3iM9OfVa69Y6bxWOmK3WK9MGOmOm+mOr8bwc651068Yr0wYrPTdc7W8GazcWystYMdOfXjr05dvTBms1ay1glZrV8ZvxvBmxit2sVcGaz03WbG8GMTpqs1oZqNVlcErNjSNDOM2N1lpKzUasSris1K0zY1gzRcRoQVFDEUoIAojNbZqiACAAIi1AABBMUFZGsQESqKqAogAIAAAAAKBQBBaigAAAAAAC4CLIAAAACgKuKEgAgAAAApFVAAQAxYCkFQBYqEUIC4QWRcQigqALFQFFSgYAs8AUFiNNImKLBAFipTFgKgQVQxQwQWAAKqxKkhiyLgVDFFiGC4LEqC/qgkhiigC4Ig1/JilZxcawwSs4sUAkBcWJUFxSFTBQGVUBkXDAqLiilTDFMREVcAQUUqYuLhhCoYuGEKmGNBEZwxrBUTEaArI1hIQqYY1gsKmChESRcUIVMMawIMyLihAwwFgmEiriRKmGLi4sKmI1i4RKzhjUgQrOGNYEVnDG0wg+nxEcCf1ys2tXxi+mKMtM1oSp14WsqJrNq1lrMEtZq1L41gzWK1Wa0M1mtVmtYJWOmqzVwZvjFa6rNbGeqx010zWsGKxW+mK1is1m+tVztbwS36x01WOq1gzWL41fWOm8Ga59N9Vz6bwZrnWrWK3mDNY6rdc+m8GLfjHTVZreDn1/jFdOnOt4rn0xW+3OvTFZ6cq6dMVvEY6c+nSufTeK59M9eNVjqvTBjpjqt1z7emDHV1itJW8GOmK30xW8Gayt+stYM9OdjpY51vBiys46VmxvBhnpusdNYOfTNbrF9bwS+s1qs1oZ6Y69bqVoYStWJVwZRaNDN+MtVlUKhRcGai1LG8EqLUUM1lpmqBTSqIA0URUoVmrBIBRUsBKi1MXAD9AABAAEKUUQVABViDI0mAguGKILhgILhiiC4AyNICCgIuAAAsAAgAAKSKJQBYALioiyGKFEFEAMAIRWkAXAQXDFQigoRQVFigIAsXEFBUFIEABYCkitJUiwUQBYYmo1EitIAsUJFMURJFXDFiUimLgIoLEBcVUqYRRQFwIlTFxTFRMXFwBMUCAAsAXFErK4oIAAAKUDFwhUGsMIlZxcXFUZwxoCsjWGEEMXFwiVBcXFhUwxcUgyY0CM4NGAzhjWGLCs4uNYYQrI1hkIjJjWGEEwxoxYM4uKuERnDGsMIVnDGsXFhWMWRrDCFZwxrFIlZxVMIVMXDFwgmJjRhBCxrEwhUkMawwhX02zV1m1wB/ZLWaFVUSidLgzWavXqVpGais31pUqVpirgz0xW6xWsErNVLWsErHXq2s1rBms1emK2JaxWumK1gxUta6Y6axWeq59fW6z03gxfjFrfTnW8ErPSsdetYM9OfTfV+ufVbwY6Ysb6rHVbwYrn366X1z6bwYrFarDeDPTnW+mOm8VjpitdVjqt4MVit1jp6YVjquXTpWOvG8HLpi+unUZr0xWK5dT661z6+t4OdZ6brHXxvBisdN1mt4OdZut9Rm43gxWK3fWevG8HO/KVqxlrEYrHTp0x1GsKxWa30xW8GOmXSxhvBiwxpmqM1mt1mxrFZZrSWNYjLLViWKJWa1Z8Zq4ILUaRKmNIoyljaVVrGC2JVwSgNIAIJYjSUwQBRL6jVZUSgACwBBcQBKqVcAMUABAAAAUAFgAAAAgUWCAAC4YpUGsTBKguKCEiiAAoLgqpUUBABRFFIEAVKCw/RCKCgshIUEqkg0ixcIAAsVkxQVBZCCgCwRFiilAVUAXFQUFiGAsVKLCKAsFVBYCoC4fqoGKACyCxKmKq4qJi4BAAWJQXAKi4oqVFMUiVDFFKmLi4YCYY1gDKri4DOKYYQBcWLErJjeGEKzi4sXFiVMFxSJWTFwwhUGkwhUXDFUqYYuLhErOLiiwqYKuEKyNYhCpg1hhCsyLi4YIiqYsEwxqQwiVMFwIVDGhYlTBcXCFZVcWRUrK4uGEKkhjS4QrMhjWJhCpiZ/jeGEKzhjeGESvpSs1alfn5/dQoUVmoVK0M1lqs1pErNWs2rijHS2/Wa0M2pWqxWsErFarF9awKx0vVxm61glY6a6YtxvBms2nVZ6azBLWOltTrxrFZtY6a68Y6+xvBm1ztb6c61gluOfVrdc+m8GbWOm6x03g52sdN2sdN4MdeMdN9MdeN4OfTN8Xr1jqt4M1npqufWt4rPTnW+nOvTBm7GK3dY6axGK59Ot8cum8VmsVusV6YY59MXY6WMWN4VisdOlc+sbxWKzV6Zut4J1XLpvqs1vBipVvqN4MX1K1fWemsRis2tdMWVvBnpmtX/Wa3gzUVGkZsZrXTNXFZqNJW8KxfUarNVErLVZq4JUsWo0M1GqlUQwFgiVaLgyli2JVGaLUUAwxRKi1AAAAFGbEbSxRlpFARRBLExpAqCoFAAAFiUAUoAKAABFwKmGNJVSpgCgAAAQAXFiIKEKSCggAAAoEMVQAGRZCQqh/4oAEiyAUIpixEWGKoARWVkUFTQi4LABYIYoKguAoKi4qEgqqlSLVFRJGsILAUxVQkWEBBTCKiguKiLimKgYoALhipUXFFRMUXCFQxcVUrOLFxcCphjWCxKmGNBCphimEAxcXFiM4uKhCmC4YRKg0LBMUxcIlQUWFTDFUhWcXFxcWJWVxcMIlTDFxcWFZxcXAhWbCRrDCFQxoBMLFMEqYY1IuEKxhjeGKlYxcawwhWTG8MIlZwxvBYVnDGrAhWcMaxcIVnFxcUhUhi4uLErOLi4YqVBowKyLikKzi4q4QfR9Sqlfnt/fSpaWs1qKM2razfq4JWbVStCVmraxaolQrNrQvTnfV1mtZgX1irfjNrQz0zatZtawSsdLemb02MdM9NWsWtYYjHVW1i1rMUtY6vxazW8GbWK1azWsGenOt9eMVvBnqufTfX659VvBisdNVit4M9OfVb6rn03gx0zWqxW8Gax01Wem8HPpit31jpvBnpzrd9ZreDFY6/1vpz6bwZrPS2sXW8WJaxVvrPTeDPTl166dMWN4jFxmtVnptWKxW6zW8Rist1mtYuM1it1jpvEZ6ZsarNbwY6YrdZsbxWUrVnxiriJWa2xjeDNStVmtDN+M2N1loZqNdMWKACiWJjSWKMWI1UqiVFStYDNaSwGF9i2JFE8FqAliY0lUTBRSs1I1Yi4ABBBbEVAFBAsRARQggBACLiiC4YCYuKAmGKAigoAAlRRRBcFSpi4oIALAAQAFAMUgigqUAVBZCKAEUKiyAJRTFjQACARfxUAVQWEFQBYIKKqJigoCqqIsIqxBQkVBYLIsCKLFZJAWLBFi4SKlFwUZRZDFUAWRYlJFBUoLBUTFXFWJWVxcXCFSRcUxYgLgQQxVWCFXFErOLigVMUMWALhhEqGKuESpg1hiwqGLi4JWcMawIVMXFMWJUwXDFhQXBYVDFEiGCyGLEQxrFwhWMMbwwhWMXGsTAoLi4sSs4uKYQqYLi4JWVxqTBRBcXCFZJGsCCYYuGESpiyLi4sKzhjeEixKxi41i4QrGDeBErC41gRWcXGpDCFfRVSlrNr89PoUqWl9ZrWYFqaX1KsVLUtKzWsEtZtWsW61ELWSpa1ipUtS1m1oOqx1VrFazBKz1WrXPprMGazWqx00JaxVrLeCVmrWa0qWsW/VrFawKx1VY6azBnqs2rWLfreYM2udb6c63gzfWeqvTHTeDHVY6bvrHTeDNuOfTfTDeDNYrdYreDF9Y6rdc+o3gxWa1YzW8GL6x03WOm8HPqM2t9MVvBmsdN1nprBzrNa6YtbwZ6Y6brFbwZrNarNbwY6ZrdZvjWDFjNjdZsbwc+mXRitYMs2NepfG8GKx03Wa1gyy1U9bwYrNdLGbGsGErVStIzWbGqijOJWiz40MhYLCs2I1iWf4ozUq1FVBai4glKeqqVFqAgoqM0VKFSo0i4IKKILTAQABKoCIoCCgIoAAAgosAAgAYqAvwIVMKoqIjWIoAfqgBIAYoCYuARKALEBZFBJFAAkXBSiiqiYYoQABKEFVBQXEosMFAGliJIopEIAoLhFaQILFZIuLAEimLioYoRcQiixQWAsQjSKrISKKAsUSpi4SKsZpguLIomLiqqJhjUhIqJi4uGKlRcMUKmKCwBUhEoLi4pWcXFxcIlZGsXCJWcWRcXFhUwxrBYlQVcIlZMawxYVnFxrDCDOLimLETBrAghjWGERnDGsUgzIuNYY1iM4Y1hhErOGNYYkKzi4qrCs4Y1iyEKzlMbxFhUkMawwiVnCRrFwhWcGsXFiVnDGsCFZxcawwhWTGgiVMFxcWFQxrDBKguGEKmGNYYQrOLjWJiwr6E6Sl9H54x9IlY6q9Vi1vBdZtKlqwLWatY61cwS1nVsS/wDjUGaz1WqzWsVlmraza0M1m1ay1mCVi1usVrBms1pitDNYrVuMWt4M9Jq1mtKz1Wade/WbW8xCsdLbjHVazFxK59N2xztawZrFb68YreDHTFb6c63gz0xWqxa3gz0xfWumLW8E6YrbNawc+o5107c63gzXPpvr1mt4OfTF10rnXpgzZ8ZrVZ+tYM1jrxus9+NYOXTNjVSvTBisdR0sYrWDmjdjNaGKz1G6zY3g51mt9T6y3g51G+mK1gyzW6zW8GKzWqxfWsGbExqo3gljNbYrWDN+IvSVrBksVFRmxK3WWhKy1YlXEQq4YpXOmLZ9RVSxnG0q4MWI2li0ZLFKDMLFFGSrgqMimAhYuEUQKAVlpKuKgBASqUECKqVBQKgoFQUCphiglADAAUAFAXDFKgAlAFKCwEDFAAAAxcUqSKAgshiqACxKCyGKhIYoQRQxYgsFkEJDFFQBYoSACCkVUFkIuKlJFBQWRI0qAuCoLhFVExQxYgqyLipUVZDFSkFFShFkFQWRZFVDFCKguEWRYJGiLgm6hiipTExrCRUQkXFwhUxcXFxYlZXFUSs4q4uLErOLi4YsEXFxcWDOLi4ESpi4KQqC4uLETDGpDCFZwytixKzIuLi4QrOGNBErOLiriwrOGNYYRKkguLilYwxvDCJWZFxrAhWcVQhTDFMIlZxcXFxYVJDGsMWJWcXGjCJWcXGkqwrODeGJCs4Y0YQrK41kMWFTDFxcIlZxcaxMIlTFMMItBcpipXv99S01m1+eH0yVmxalaxWalVlcQZ6W1m1oTq/GbcLWa1ipbrNrTNXBmsVq3/WK3mKlZtarFawTq/GLVrNrWYJWOmrWLWswZ68Zq1mtYJWLV6YtbzBnpKVmt4JbrHVarFawS+MVazWsVnqsWtVit4M9Xf1i1rr4xW8wZrHTVZrWDn1Wa3WK3gjHVxq1jprBL4xWr4xW8GL9ZrdjFbGKx03Wetawc6z03WOm8GKz1WqzjeDFjNbrNawZrFbZ6jeDFZWw/Gxixmt1itYM9MVus1rBjrxit9es9N4VzrNbrNbwrFZxus1vBixGqlaxEZ6jVSrgzjNjZfGsHLEbStYMpVo0M1mxuoqVmKDSM2Mt1LBWUrWJYsKziNJYpWajVRSs0UsColUXBkXEUBUEErSWKILgLWcMWipUwxQKzRaRRBcMSCC4YsEFxSCYYosSphigACoAYAGLgMmLguCYYosADCAYohTAXFRFMVYJigsSgLhERRVEUMVKGGKoYsJFEqYoEQDFihAVRFhIqshBpUIpAQXCKomNRJFVAWLFSgLI0hiyEiwQaSK0yAqpUxZBqRYJIsi4sEMMVcVExcUVKmLIsgsTdBcWRcxEkWRcVYlZXFMVKkXFkWQiVnFXFxYlZWRqRcWFZXGggzi41hixKzhjWKsSsyGRrFwKzIY0YJWVxcMWFTDGsMIlZxcXFkWFTDGsFiVJFwUiVMMXDCFTFkXDFiVMMawwhWBvEwhUMawwhWcXFkWRUqYY1i4RKyY1hiwqYY0YRKkhjWGBUxMaFKzYSNYYkWouCrEqYYuLglZVcMIVMMXFkWJWZFxqQwgmGLikHvFYtW1m1+eI+oL9RNS1Q6rFpazW8wL0lqVKsC1mqzVxUtYrXVYtawKz1cXWK1ip1WLWqxa1glZtWsWtQSsdL1WbdbwS1m1brFawS1irUrWYM1mtWs9NYM2udarNbwZrFb6Y6axWOmL8brHTeDHVusVvpit4M1it1itYM9VitVmt4M1jpusdNYMVmxus1vBisWN9e+MWtYMVmt1itYMVmt1m+N4OeM1u+MWN4M9MV0rFawYqNWM1tGb6xW6xWsVKzWqzW8RisV0rHTWDnYzW6zXpgxWK6WazWsGMStJWsGLGa3YzW8GUqlXBmo0laGLEsaqfWsRmxmt1mxcGUaSxvEZoqYoJVRRAKonUZaZoJYi1FEotiLBCrhYoyLiAMtFgJFTFUZotiKILBRBcMCojWJYFAhioBhggLhgIKKEAAAWAAQBcMBKkawUqYYqKgLi4DK4oRDAAoAsQXCQUFCQSiwFAXBUoSKKlAWASAKmgqgmEiixKC4KgpIoCwVWQhIqgsIsVCRRWmQhFkWBGgXMZFJBUBqQWJUkahI1iokiqLAkUVYzUxcWRVzE3UxcWQxUqSKq4sSoYuLipUxcWLixKhirgiYuKLAFkVYlTBrASoYopTBcXFSsri4uESpIY1hixKmDWGBWRcXArK4uLixKziriyLCs4ZW8CJWcpjeGLCs4uLYYsSoY0CVkxoSFZwkawwhUwkXFxYILiyERMMawxSs4q4YQqYuLhhEqYY1hIsKzhi4qFTDFxcWJWcMawwhUxcXFWDODS4RKzIY1i4sSs4uLgQr3C1mramvzu+rS1mrWauYJWdWs2tCVC1nWoLWeqaz1VzBnr1LVtZrUVLWOrVtZtazBKzVtZ68axWemK0z1WsRm1m0rN+N4paxatZrWDNZtWsVrMDWaVm61mCVmraza1gzWeqtrHWtYVKzatZtbwZ6Y6Xpit4DHVW6zWsVm1i41Wa1glYrXTFbwSs1azWsRnpjqNdM1vFZZrdjNXBixjpvr6x03gzWa1Wa3gxWK6Vit4jFZrdZrQ51K3WWsGaxW+mb43g52M9OnXjnW8GazWrGbG8GbGemrEsawYrNbsZsawZxmxvErSOdmJW2bMrWDKVqxGsGUrVStYjCY0lUZZrpYxY1gyLYjQlFTFEqNJ4JqYljTNawrNgtiYoMtJVEKCwRGrEwgmFXBSs4uKCJjNaMMVhSzKqomGKAmJY0lWCYKhAAAAUUwiiVEaFKyuKBUxQAFwxYIYpVEwBUAXBEFwUTFwUiVJFAgBirBMUWQQkUFQAUAxQAFAVRABUFkJGlZTFBYCyGKqC4RZFgSLgLEFFVkJCKuCxQVnRYRYqEXCRcVEWRcVUMWQkVcxKLIRqNMphirFiVFUkVKYsg1IsSpIYq4sRnFi4uEQkMVcaggsi4JUxVxZFiVnFakMWJUMaxcWJWZFxcUiVnFxVxYlTDFxVEwxcXBGcVcXCFZwxrDFhUwXBUDFi4FTDFFiUwVcErJjWEgVnFxrEWIzg1hgMriyLhBJDGpDCJUwxTCFTFMWLCphjWGLEqDWBErODQQrI1hhCsrI0pCs4q4YCYLi4sKzIuNYYRKiyGKsRBcXCJXtTNpWbX52zH1y2s2lZaglSrWbVwSs0tZreYHVYtXpi1YLWbTUrWCWsVq+MVrMVLWatrHVrWYJ1WaVK1mCWsWrWbWsVms1usWtYM1it1jpvBm1mtVKozWLGrWdawZv1z6/431XO1vBLWOq1WbGsGaxW6zWsGKlaZ6awYrFbrF9bwZrFbrFawZrNaus2NjFStYzWsGbWOm6xfWsGKljVSt4rDFbrHTWIzWK2ljeDFZrdZrWDFjNjdZreDFjNbZq4jFc+o6Vmx6YrniVqpWhis1vGbGsRis9N2JY3gxWWqljSMpY0lawYxLGksawZZaTGhmo1WWsEqVrGf3GkSo1iYYjFG7NjDWKVloqjKVpFREqjQyVbAGDGsRoqYjQQZTGsMWFZFqYFQUCpYmNIqVBcMUqC4YFZRqwwKmGKLCplJFCAAQAXFggoJTBRSgGCAYuLBkXBSoKESgYuLBDFwAFwxYiLiilAwwQWQADFFSoKYAYsFQFxVSpiyEirEoCyKhFFkBFwiqUxRcVkkFWRUSRcFioYoRYmmLILIuYhFkJGmkRYNSKiNQWRU3TCRZFVmmCyKsZqRVxcXMSpIRcWRqJSRZFkWLEMMXFVKzi4uLixKki4RcWJUXFXCJUxcVcWJUMVZFiIYuKsEwxcVYiYuC4QqGNSGCVMUxcUqCqRKkgLiohkakMCoY1hixKzhjWBCpIuLi4RKgosSoY1hiwrOLgJCmAuLBBcXEiVkaxcWFZxVwxYlSRcXFwgyrUhixGcJG8SwKzhjWGEKmEjWLhCs4uKLEqYY0RYVMMXCQiVFxcMIVMXFxcWJXsdxm1aza/OuPsBm+lrNrWYLaxVtZtXMErNpaza1glv1mrWbWoFSs1LWoLax0WsWtZgVmrWOr9azBLUpaza0pfGKWs1rMC1m0qVrFZtY6atZrWCM9LUq4M9MdN1ztbwZrNarNawY6rNrVZ6jeDFqVqxmrmCVjpqs1oZrNWpWsGKxXTqMVrBmsVrqpW8Gay1Yz01gx0zWqzWhlnqNVL41g52M2N1mxvBio1iWNYMdRh0rFbxGaxW6zWsVistVmt4jNYsb/GbGsGbGb8brFbxGazWitYOdiWN1G8HOxLG2f1rBlmxuxK1iVjplus1rBmxLGkrQxYzjaWNDLN9aoqMpWqzWiozWirgwNJjSM1K1YYowNWJiggAlTGkawTExpFEwUWJWbCxqs1RLExrEFTDGsMBkLBQDFEqI1UqlTExpFhUwxoSCQUUACICwBMXAWFBZDFiVBoIJhiijIuKsSphiipUwxQKBi4CYoAAuLERcUATFFQBYQqLIqyKiLAVKsMIqoBIqhgsUSgRppKkirgRAXFVEii41EqRYsiyLGakjUgqoRcWRVRJFxZFixKkiyLIuLGaiyLIY1EosMXFSkWEjUispI1ISNNQTBTFjIouLERcWRViVFxVWIyuKsixExcVYsEwVcIlSQaBEwxcXFhUxcUkWJUVcCJUwxrDFiVnFxrDCJWcXFxVhUkXBcIiJjWLiwZxcawVKzIv8qpBnBrBYlZwxrDCFZwxrDCFTDGsMIlZxcawwhWcMaxZFiVnFxcXCDOGNLiwrOLi4ESoY0LCsjQQrKqSEKki4uLIsSphjQJWcWRcXCCYYoqGGKYFeu2sWr1Wa/OsfZFZqstYJUq1jqtCdVmlqLmBWOq1WK1glrHTXVYtazBGbS+s63A6rNWs9VcwSs1bWa1gzb9RazWlSs9VazWswSs2rfGbVxUtZtWs1qCVm5i2s1rMEtYq24lawZtZ6rVYrWCWs2rWa3glZ6W1m1RmpVt1mtYJ0521rqsVvBKlEaCsWNVmqM2YzWqzWsGbGa3Wa2MVmtX1nqNYM1Lfi1mxrBmsX63Yy3iVis1us1vErnUsbrNaxaxWem6xW8RlLFpW8GEq2IozYmfGma1iM2M42zY1gzWb61iY2jFTG7GWsGcSxus1rBixLG0saGKzY3YzWis2JWsMVGEaz6jQmGAqJWW7jPxrCiWNJVRmwVFESqYRUSqVrBkXDFRCxcAZFxLFgAuAzUxrEsUQaAZwxpFGcMUWFTFwBKmDWGKVBcUKzFxSAmGLYRYgKBUXAUpgphEZMaRQwACgEBSCoYYoImKCgC4QqLgqomLIuCoLhgoGLi4REWAoC4olIshIrWYgSLBUFhFVkIKqCyEirEosFioLIsiqgRYsixNRqQWRqM0UVcQJBqRrGRYSNSLEqSLjRixKiyKuNJUWLi4M1JFxcMVKSLILIsSmJjUi4qVMXFkVRMMUxUouGLIsSpg1hglTFFkWIi4sirEqYSKqxKmC5VwgyN4YsKziyNYYRKmGNGLErKtYYFZwxrFkWJWcXFwwhUwawwiVnFxrDFiMYuNYYQZwxrFxYVnDGjBEkFXFKmGKuESs4Y3gQrOGNCxKmI0uEKxhI3hhCs4uLhhCoLi4sSs4sjUi4FZwWwwhUXFwwhUXFwkIler3GS1m1+do+0W1i9FZrWYFrNpaza1mBalqWpasC9MddLbjFrWYJazatZrWYM1KvVYtbwLWbSs2rAtZtWs2tQSpaalq4Jaz1fq1jqtYqWpRK1BKzVrNXArFWs2tYM1LVrN8bGeqzVStZis2s36tRoZrNa6ZXBKzVrNaGeqxW7GK3iM1KtRpUSqlVGbGbGumK1glZrVZrWDFiVq1LjeDFZbrFaw1ms2NVlrEZ6YdKx03gylWpWsGOoxXSs2N4MVmt2M1rBmxltmt4jNSxpmxcRms1qpWsGL6laSt4MpY0ljWFYStVK1iMo0laGaljSVrBms1us1rEZrLVSxrERKpVVlLGhUZMUURK1WWsGRbEwEqY19MUZwaRUQXEWCVGhVZwXAghWgGDGjFGcMaMVGcMUxRBbEwAXDFEFwERYoIguCwRqAoWGGGAACURUUDFBEwUUAABcUhUwVcVEMXFwEBcVEUqqBCKqCkWKlTFFkIiYsikixDFwXFSoshIsVKLBZFQMWLipUWLIrUSki4oIGLFaSkikjSsosFazEFhIqskiyLGpGsZpIpFXEMFxZFiVJFiqqIshIsis7pIuKuLEqSKRqRYiYsijUSmGLiiVJDFxcWJUXFWRYlTFwi4sSpg0YRKmGNSLIsGcXGsMWJUMVcIVnFXFxYlZXFxcWFZxVxcIlZxVwwiVFxTFhUwxrCRYlZVrDCFZwxrAiVkawIVMFxcUqGLi4RKmGKpErOLikilSRcUVKmGNYYQrOGNYYQrOLi4SEKmLiyKIzIuKKISLi4FZwkawIVMFXBKyNCwr1Gs2lrFr865j7VbWLVrLUC1iraz1WsxRm0tZtazBKytS1cErNLWbWoJ1WbVrNawSs1alaGbWWqzWsErNXq/WbVwSsX1qs1oRKtZvxrFGejWasQtYtPEaipWatZtazBKzarNawS2IVGlS1mqzVwRmtVmtIzWK3Wa1is2I1WdawRmtVmriJWGqzW8Rms1qpY1gxWXTGbGsGKzfrVZsrWDNZrVZreDNYrdZrWDOfUrVStYjFZrVSxvBis1tmxrBms2N1LG8Rhmt1MawrnfWXSxmxrCsVGrPqNYjNStVGsGcZrbLWDNRpGkrLN9bZrWDJi1GsRmyazY3fqY0MJG8RrBmxMbRYMDVFGajVZq4JUaxLFhUGhUrKY1fUUQxRRmpjdRSs4Y0lWCRcRYQKimCILh+KVEXDFKyqgVMMUEqYYpiwBcMBBcMUQXFAAEqYYoqJiNICC4LBMXFFExTFERZBVgkXBSJQMXFRDFCCYuLhipUWKLAFxZFSki4CoLISLFQAxUIouLEJFkJGlZ3UkWLBUFhFWAosis0kXFkWKzuhirI1EqSLI1ILmJUxZFkakWJSRSK1jIsJGpFxndTFFjSGLFwxYzSLDGpFzERZFkWRYVJFiyKsZqYuLiyLEqYSNSLixKyY1hixKkjUiyLixEwxrBYlZxrFxZFhWcwaxcIlZwxrFxYlZxZFxViVMMVcEqYLIuEKzi4uLIsSs4Y1i4sKxiyNYmAC4YsRFxZFwhWcMaCJWcMXFwhWcVRYlQVcIVlTMXFKi4si4JWcWRcVYlZxcXFwiVDGsMUZwxRFTDFXATFwVYlTDFxSJWcTGsMIVmGNGEWphi4uESvSrWaWs6/O2Y+2LWbS1LWsxUtZtLWa1mCW6mpfiNQW1mlrFqwpUS1LWoHVYtW1mtRS1m36VKoVmlrNrUCs2lZrWYGs0tZt1oW+M0qVcErNq1itQLWbcWsdNZglrNaZrWKlZtarNilZt1FRoZqNJ0uDNSqzVwZrNaqVrFZZrf4zWsRipWqzWsRL4zWmbGsVmpWrEsaxGazWrErWDnWa30zWsHOxG6jeDnYzY6WM2NYMVmujNaxHOpY1YmN4jFZrdjNjWDFSt1lsYwarN9axGaljViNYMWJjViY1gxYy6WM2NYjLNjdjNbwZZaStYjKWNVGsExLGkrQwlbZqjNStFjSVmo1hYuDBi1GhEaxKuCJWsKqMRcVFEsMUxRkWwVGRUXFqCilZwWxBFgsKCAKJ9PqijJiqCYLgqUDDFhQMMIUDDCAGBEAigmGKKAClMMAQBcWCLiipUxTFwRFkBQUUSpii4sRBRSouKsWJSQFwiVFkUWIAqpTBVkUSRqQVWRZCQVBZCNLEJCLhIqEjUhIsipuiwkajWYymNSCyNZjIsgqoKYsi5iUiyLIuNRmki4RY1jO6SNSEiqhi5CNYsRJFxZFixN1MWQxYsZ3TFMVUMXCRVzGaSGLFjQmLiyLIsSpIuLgJUXFwxYlMFxViVJDFXFiVBVIlTDFxcIVDGsMVEkWRQgmKYqwqGKCUwxcFiVMFMItRcUVKmCriwrOGNYYkRnFxcFgmDRhEqYY1i4sRnDGsCFTFxQiJimLiwTDFCJURrDCLWVakMErMirhilJDFMIlTCxQhWRcXAqYpIuEK9DrOrWa/Oz7lLUtwtxm1pC3/AKxatus2tZioni1jq/8AGswOmbRm1qBazS1m1rMFrFpalVUqLWauBazS1m1rMCs0S1qCVBLVwRm0rNagVLSpVwS1m36t1K0JaxVqNCUq1KDNQqVoSs1an41ipWa1frNXCs2MtVK1glYvrVZrWIjNUaE/Eq1FwYqVvrxmtYM1mtVLGsHPpmt1LGsHOjViY3iVmxmt1lcK51K3YzY3gxYzY3Wa3iM1luxmtYMWMuljNjWFYsZsbsSxrEY/UsasSxvBllrErQzUasStYjNjNbrLWIxYzY3UreDLNjZY0lYqNVlrBmjVZxRMStJjWIyKNFZsZx0SxcKwljSfjSM4KLgiY1Yi4JgooymKKGM2NpVSsNC4pWbGcbxLAqC4eAmC0xYIjWIqIoKAsUKyuKLEqYjQQrI1hhCsrihCpiNYYsKmGLi4FQXDFiVMMUUQUIiKLilRcUETFMXFiIuC4pUxTFixKmGKuKlRTFWIAYIKY1iokhiqsKmNGKRKkUWLEMWQxWkpFkJFEFhGo1Gd1MUIqEbiSNSNZjOkaiSNYqIsiyLI1mJukiyEiqyLIsi4uYzUakIsjSC4sWKhIpIuNRmiyEjUWM1MUXFiVFixcWIkirIuNJUkWLjWKm6kiqRYzumGKolZxcWRcWFTDGjFSphjWGESs4rWLiwrMi4q4RKmGLiyLErOLjWGKVnDGsMCoLhFiJi4uGEKg0ESs5pjQpUwxrDBETGsMIVMMaxcIVnDGhUSQxVBDFxViVmRcawwiM4Y1i4sKzg1lQiVBUwWhiwWJUxcFwgguGESoLhiQqYLiipIoLB++Zpaxb/1+dsx9ytrFpajUBmraza0JWaWpbjWKWs2lrNqwLfrNVi361mIalpWbWopazatYqxS1m0tRoS1FrNaC1C3GdA6rKs1rArK1loKzVqfFEQvo0JWatZoFrNWpWhLGa1+M2qJWatrNazBKlVGhKxW7Ga0M4YqVREqpWsGKlbYrWDNSrUUZqVbDG0rLLVZsXEZrNaupW8GajVZsawZsYsb6TGsGKzjdiVvEZsZrdZs+tYMVmx0uM2N4MVluxlrEZStVK0jFZbsZawZZxtK1mDFSz411/1PxvEZRpGhjpG7PjONYiVFGsGKLYjWIlRoaGUrbNhhWalaxMaKyLYY0lSQxUqoiNIoz+mLRrFEz4oIyL+qsGStYUSsCiwqYKLCphVWwGRcFgi4CpTAAoLhhCoLiqjK4oQZVRYMqoQTDFFiVMGkCoLgCYoLEWKkVURcMVYGC4YJTDFFiAuCpUMVSCLCRVSkXCK1EIshIuCVFxZFxWWcakIsihIuLFXMSphimLEqwJFkXEJFkWRcajO6kjUhjUipSRRZGsxndJGpCRYsZ3RZBZGom6shIqyKykahIqxKSNQhI1ibqxSRYrOi4YuNRmgsWRQiyEjUipuki4Csi4SNYsSpIuLIYsZoSKY1EDGsWQSpiyC4oguGESmGLFWFSRcUxYlQXFEqYYoomGNSBEqYYqrCsmNYYRKmC4shCoZWpFxYlZwxrDCFZwaSwhUFxSLWVkXFkIlQxVxYlTBoWFTDFBAAAWRRKxhiilQxVxCpguEioi4pIQMMUBmwaMBnFxQg/bWs0tS1+eH3YzaWs2qFqWpay1FXWbS1m1rMCpS1m1qBbWbS1m1cwLWbSpa1mBWaW6lrUESlrNqwpalLUUqVCpWopqWlZqwKzVTpRKgVRmoqNBWatZqhWdKzii2s1bErWCVFwUZxMUUZsZ6jVStYMs2NVKqJWa0laKzjNjdZrQyzWkrWDKLUrWIzUsasSxoYrLdjONYM1LGrGWsRnqM1upjWDFZsbsZreDCY1YlaxGbGbG7Ga3gxfWbG7GbGsRnErViY3gwljViVvEYsTGqjWDHU+M43UxrEZxGsStJWWcbTGsGbGbHSs1rCsVGrEaSpUaviNYIljViYsRkasTGipYzY2mKjOFi4LBkP1cWDOJjeM2LmCYjRiwrIpixKguEUqJjVRSoYoQphgqozhi0WFSRcASgRVEFMBBTCCGNYuKlZwxbDAqYNYYFZxcUWFTDFMIlZGsMUQxVxYlZxZFxQqYKLEoC4pUxVMERcUXMShIsi41EqYpi4RKmKuEWJSRcWQVBZCNSLEqC4uLESNQkWRYm6kWRVixKmNSEi41Gd0WQkaxYlJBcWRqJSLIsixYzuhiyLI1GaSLISNYsSpI1ISNLmM7qYuLFkaiVJGpFkVYzupiyEjUXMZ3UWGNSNQSRqQkWLmM7phi4qxKiwkVYzRZFwVBZFkXFSpFFxRFiyLIuYlZxWsMWJWcXGsMIlQkawxYlRcXDFiVMGsFhUwawwiVkxrDCFTDFxcIJhjWGKiSGKuAmC4uEKgoRKyNGLCphihCphihCgLgIuLIuKlZwxrAgzirhhEqLi4YQqYlirijC41gJUWQUEMUBMMUBLPiNJgVFkXCLB+w6uMbSpr88x94Ws2lrNqxV1LWalqwW1Kn+s2tQW1m0tZtagtYtLU+LAtZtLiWqiWsralrQlSqzVBmrazfWsF1nSoqlrNVmrmB4zVqNKmpVqUESlqNYJUWs1cEqNVFE/EWouAlqpVGQo0M1nW6zYqJWWqi4jNSrYlawRGkaGbGLHSs9LgxfEaSxrBmpWksawrFTGqy1iM9M1vpMbwYqNWM1rBms2N1G8RzqN1mtYjKVqst4M1mtVK1hWbGa3WbG8Rms31us2NYMWJY2ljeJWKzW6zY1iMpY3ieNpWEbvjNXBKzWkreIlZxojQziY1UrWIziVoqjC4K0azYmNFWIzYlarPUUQDGoUSxcLCImGKNQZxMaRSoYq4pWamN2M4RKmGNGLCphihBKmNWJioI0LCoKEKguf4uLCsrFwwiILhIQRcUWCYphixKJi4uEKiY1gQrOGKYsSgYuKVDFXCImLimLEphgLEBcWQgmLi4sipUguKsEwi4uKiYuLi4REMXFxYlTFXFjSVJFXFkWM1Iq4sixKkjUgsWJukiyLIsazGd0xZBqRcxmpiyKsjUSpI0SNSNZjO6mLIsakWJUkWKSLEpFkWRZGozUkakWRZFjO6i4uGLEpjUhI01mImLg0sZqYYsiyLEqRqRcXFjO6zi4qyLEqYsiyKsKkWRZFixKmLjWC5jNTFFWImKpiwqKYqpUkUWRURcUwRMUxQMMWGEExcUVKmCmEEwxcXAqYLgqVFxTCFTDGsCDIthiolIuCRaimLipUXFwwhUFxViVlcUIILi4QSGKAguGKILgkSpi4AlMMAKgoLQUxUqLhFB+otZtW1m1+eY++E1LUt1qBazS1Lfi4pazaM2tQVm1LUrUQtTUpqhaialqhazVZrWBUKzVgt/8AWdLUUENS1cU1lbWbWsBLSpVECoBU/AiqiLUqiJVqKglKVREXUaEqLUUSo0lVGbjNbrNawZoUUSpVRrBlK1UrQxUarN9awZwarNXEZsSxqpW8GLGbHSstYMVK1UrWIxWa3UreGsVmxus1rEYsRusWY3iM1luxG8GKlbxLPjWIxZ8ZsbrN1vErNRqxMawZsZsbZbxGajVjLaInTSWLmDGJY3iWN4jGI3jNiiVmxpMaxEqVpGsKyYo1ESpWqli4J+JYo0M5EbxLFRCrnxPFhWZ6uCiM2C2IoBi4omJjSY0lTCKYQAwIJSKLgmCipUwUUoAFDFFgmGKEQwXDAQXDFSoNSLhCs4Y1hVSsi0UQUIVIosixBTFxSphIsi4qVJFxTCIEX4uKVDFkXFiVMVZFIlZWRcMaSkiiyKiLIuLIsSkiyEiyLGaC4sixEkakJGlxN0kWQiyNRmmKYuLEpI1ISNNZjO6LISNSNM1JFiyLIsTdSRrBqRcxndSRZFkWRrMZpIpIsixExqRZFxYlRYpipSRZCRprMZqSLiyLixmkhiyNSLErOLi4uLCouLIuLEqSKLFiGAqs1FMVYUwWGKiLimCAuLhBMUxVgmLguCILi4sSs4uLi4QrOLiipUwawwhWcXFwxYlQaCFZVTCJUwxTCCWDWGEWpgYACioi4shgVMMVQqCgVMMXAiUAWCYjSJBFMWRYJi4uGCVMMakKCSI0LEZXFEH6O1m1nqpa/PeY6AtupalrNtWKus2lrNrURbWalqWrgW/RLUWBUqWpqwWs2lZtag1bkY6prOrmKupb8NStCaUSqhazpalqwNTRLVD6U1LVVKipqh9NpqWiiUtTViFqF9TVCoCglWoolRUXASqlXESs1qs1rBAFETGkrSM2ItFGLGbG8SxrBms1upjWDFRuxmtJWazWkreDGJY116jWIxWem6zW8GErVRvEZrNbrNjWDFStYjeDOYXxal8axNYsSxqpfG8RiwaZreIzYzY3WbGsRmst1G8TWcRrExrBnErSfrWIzWa6X/jDeIiKY0JiWfGkvqpWDGsStCWI0jWIzYNYVSs4WKLmImM42lagzg0EGDGqixKmGLhgVMK1iWNYVBRUZGkwghjUhYuFZxMbwxYVnBrEIVDGgSoSLIqlTBcMIJi4pixEwxcUEDFkIiYWNYmKM4Y1i4ozhjQqVMJFxcURcMXCJUxcXDFSoLi4sKmLFwEooqxKkirIqxmphi4uNQqSLIuLIsZ3UkWRZFkWJUkakWRViVJFwxqRYlSRZFxcajNQjUhixKRZFkWRqM7pI1ISNSKm6kjUJFWM0XCRqRqM1JFiyLIuYlJFwkaaSpIuLFxYzuhi41FjNTFwVqJTFxZFkVmpIsiyKsQwxYqxKmLi4LiVMXFi40lZkXGpDCJWcVcXFhWVkXFkIlTFkaiyLErOLixcWJWcXFxZCJWcXGsMWFZxcawxYlZVcCFTFMXCIguGKVFwCFAUiJguGEEGsQggoQQXDCCLiyLiwZxVUiVkXDCLUxcUEqYKAALERG8+Ii1MFwqiKSKRAIuAhjQqVmRaogyFIQf3NS1LWbX58zHQVqalrNrUGrWbU1LVgus2lZXMF1mlrOrmC6lqWlagWslqVcxTUtGa1BrUtTUtIFqWmpVRKJaiwWoIqmiUtUKIGAlNS1UKgKtGatRQAEE+FGlEoVREqpVxEStIuEZwaqNYjKVpKoylarNURK1iY1gyzW7jNaxNRmtJW8RipY1UxrBis1u+pWsGMZrdjNbxGKlbsZreIzWcasSt4M1mt1K1gxYy2jeIxiVrpLG8RhK1UreIxUaxLGsKzUrSN4jKVqs1rEQqo0jNjOfW8TPreDOJjdTGsRnGbHTEsXMRmpYpWsRnEUazBkXBRKFRpKJWpDArIuCiI0jSUDDAoLgqM2I0YpWVxcXDCsjWGLmIzUawxqDJjWGEVDFxcEqSLgsCs4si4LERZFATFAhQDFSguCwrKrgZiVMMVcaKmDUi4RKzI1IKsSpg1hixKmGKLEMTGsMIlSRcXFxYVIqyLixKki4uLI1GakiyLi4uYlTGhZFiGGLi41EpIuEjUixndTFkXFXMZqYuLIuNRKSLIYsixKSNSEjUjUZqSLIuLIsZ3UxZFxZFiUkWRZFkaiVJGsMakWM7qYsirIsZqLIqyNRN1FkJFkWISNSLIuLGaki4sFiVMXFkVcxKmLIsWKlTFXBYzTCRcXFEwxqQVExVCFRVxYqIsgqxKAuAhIuCpTABKGLi4QrI1hilZXFBKmGKBQAQFwUMMUIJhi4uEVnDFMQBcFQkAUAATDGsUKxi4uGBUMXFCphn1RYlTDFMSFZXFwCooLAFwwiVAokUTFwIP61rNqalfn2OglqGpaoWpalqauYLWaWpa1AqalrOtQatSpqasVWbS1m1cF1E1NWC6WpahBbWU0tahBKalqgagqAmmgaqJaCs0tZUaZBQBFDTfggKIqgipVEKJ+qCVai4IZ8UqjNRrE/WsRmxK1UxcGUrWJWhmotK1iazUq1GsRijVjLeGs2I1UrWIzcYsdLGbG8GMZsbrNjeMs2MtpW8GKlasSxrBixLG6z1G8SsVK1fGa3iM1MaRvEZxLGqjeIxZ9Sxust4VhG7GWsxEStI3iMpWma1gJVg1iMlWpjSMpWsMUYsGrEXE1LExqz4jaM4NYzigYsgqVLEkaMWFYsG8SxYlZWRRYVLCLgQZFwiogqqJCqKIYosEwxQgmKLglQXDAQxYuLBnBRYGCmCINCwqGKYsSmC4LEqSKuGLEoLiyLErMi41IuLErOLi4uLErOGNYuEKzIuLi4sRMFxZFiVnGpGpDFiVMWRcXFiVFxcWRYiSKuLI1GakjUiyKqbqYpjUnxYiSauKsixndRZBZGolIsiyNSLGd1MWLIsis7pI0SK1mIYshIsaibpFwkaVmpI1hFWM6imLIsSkXFkWRUSRqRZFxrMSkFWRWakiwWLmJRYRY1EMFkXCImLi4KlMUWRYiLgshCpi4osSpiki4Ii4ClAXCIirgsSpirIASCggiiwTExoIJhimEAXBRDFWQEwXFWFZXFCJUxGhBkWoKLhihUkUBABYARcBMXAEoLhYCCyGCILYAgAACgYAtDFxER/QtZtS1Nfn6OhralqamtQXUqWs2rmC2pbqamrFWpqWpqwW1NS1m1rMGrWbU1NUXSpqaC2s6VNVV1NS01YLqWpamqjWs2oLBdTU1KI0moKFoixQEoRS0l+JQRb9BFFQ9FBDVUQEoFKfVaRkX9MFZpi1K1iMlXEUSpVStYiJVStYjNiWNYlbwZrLVSxrE1mxKtSt4JWK2jWIzfsZsbrNjeIwljV9St4M2fGWukbxGbGa3Wa3iMVL41iVvE1zo1WfxvES+M1pK1gzYjVSt4jNjN+Ns2N4iRLFhW8RlLFK1mIz+JjWI1gRKpn1rEZMUaiM2Mt1FzBm+GNI0lTEs+tSF9XEZwxokagziY6YzYuYjNRqi4lZFsWLCoYoQZwxoUrOGNIQqH4piwrOLikaiJg0lhCpFJFIVDFXFhUMXCwiVnFkXCRqFTDGsXEiVnBoWFQxVxUTCRVWJuphi4uLErMjUi4uLErKyKsVKmLi4qxKmGf4oQqYosixKYqyGLEqLi4sixKkjWLIsjUZ3WcWRqRcWJWZFak0xYiLIsirEpBZFkWJUkWRZGpFzGd1mRqRZFkajO6mLjWKsSpIshI1ixkxRZGolSNSLIsixndTFxSRqJSRcWRrFiJIuKSLEpIsiyKsZ3QkWLI1Gai4pFQkXFMXEqSNYsVYlTBVxYlRZDFxYVFxYESguCpUxcFIVBcVYiYYq4sSoYuKiJgosAAgBgoGCgmKLhBBcVSphiggAAAAGLgILhQQXAiIYuKFZVcMCoLgqIpi4QSRcFwgmLiioyAkUAAxMawwSs4uKBUwVCLUXFwIlf6NS1m1LXAI6LFtTWdNWEXUS1LfixVtS1nTViLazUtS1RalqWpqqumspVg1alqWxm1YNWs2palqwXTUhqw1dTS1NVF1E0CKVC1RN+mgCz36v4iWgAgimoRRamFNrUKU0QgpQEwAVUNVFQhVSrgiVSqM1F+GKjOlXpG8RkWxFwSs1qo3iMlxUrWDNjNbZs+t4jMSxqst4iM1qpWsGKy2y3iM1GqmN4jHTNb6jNbxGUrVjN9emJrNjLf6laxGErVR6ZiMpY1Wa3gmJY0zWsRMStJWsRipW74zW8SmMts1pEhViWLmFZ/StYjeIiY0Y1iVnExpLFhUFwrWIgDWAl9UBEaMaxGcMXBYjJjQCSGLhixEqNIYIRoxVqYljWGNM1IjeJhCpIuLgsKmLi4QiVFMVYlZXFMIVBrDFgiY1i4sGcXGsCJWcXFxcWIkiqKgLgsSopjUhE3WVxcWRqJWcXGjBKmLFkXFiVDGpFkaiVnFkaxcWJUkVZFkXMZqSLIpjUQMXFkWJUxZFkakWJusyLI1iyLErMjUiyLIsZqSLIsiyLESRrBZFzEqY1hI1I1GakiyLIuLGaiyLIsjUSpI1IsjUixKysi4uKlJBVkWM1JFFkWISLhixUMWQkakazGUkVTFQXCRYCSLijSAuAlTFBYgLIoVIpi4sRFwVUTFMMAMWRcBBcMCoKoVDFBEwxRQAAAwAWAJii4JUFwwKgKpUVcBEwxQExQIALFKiyKCVBQAAAAEpigJgoAAAAAigAANWpUtZvTgMdGW1NZtS1qDV6TWdQGqlqWs2rEatZtS1LWorWmsWpaQb6rOpamrmC2lZ01YLUS1NWDSampqwb1E1AXTUANNNRRV1IKi6giIuiIo0kQINWpqDSNJ+mkBUtVIgoamtCgAmmoqiJVSxcRDxUrWCdVCjSH4li/iVcSs1GqjYlZrVZrWIlStWMt4iVnGqzWsErNavjNbxGalaqVvEZsZb/Ga3iM1lqsvTBGa1Wa3ialZvrX6lbxKzWcbsZreIlZrSN4jOI0n43mIlZvrdjNaxEqY0lbxNRGsRvEZsMaStYlZpSiolRqxP1uFZkXFFiVkX9TFKmGKNYVMKqVUQXDFEFwxUQXDFhUXFBGRrBYlZwaFVMMXBWamH6pi4MrimKBixcETDGsMIVJDFWRqFQawwiVlYuEiwpIKLEqYY1IshE3WVxcXFjNSRcWQxYlTFXFxYlZxZFxcWJWVxrDFhUxqRZFWM7rOLI1i4uYlZxZFiyNRN1MXFxZFSpIY1IuLErMjUiyLIsZ3UxZGpFWJUwxcWRYiY1IYsaiUwxqRcWM1nFkaxZFiVMWGLixmpI1IsjWLErMjUiyK1E3UkVTFZoLi4sSpiyLIuKlTFFkWILISKsQikWRUJFMVYlTFWQVKALEFMUEwxrDFiVMWRRUBcMBFwkXARcMUKkUIqBigIKYJUFFKYAFBcUiJhiiwTDFAAxcSFQXFVKzi4pgIjWBCpiNJgIRcMAFAAAAJAJFwFiACpTEUFqCiQqCogACgAAAOepqWpa4G6MtqWpqasFtTUtS9LBamxLdZtWDVqWs6WrEW1LUtTVitWs6lqasGrTWSVRdGbTVgumpqaDWom4SqKalqUGtRFILq6yaRGkTRYQtVmNCBqWpqi/qjP6o0AIsohAFRQWJTU1cA0KoJfTBUCiLiIUqVrASqlaRCiVrBE/VK3iazUsW+o1iM1FqN4msp+qn63iMlWpW8Rk/Cl8bwYrLdZreMs1FqVvBn9Sxqo9MZYvqWNVK3hWT8WpW8RmpVqfreIlRqpW8RKlUaxERRvMSpjNbRqIxYNWJjQhio1jOoLnwxo3Wb6jVBGajVifqwoVcLGsSsrhFUqXxGqkiog1iLBKsgsipqI1hiwrI1hiwqC4uKyyq59FEMVcFZxqQxZFibqYq4CJixcMaiUwxcFSphimBTBqQxYlSRcXFxYlZxcaJFjNJDGpDFiM4uNYYsEwxuQxYlZkaxcXFiVnFXFxYlZxZGsXFiVMXFJFjNTFxqRcWJWcaxcVYzWcai4sixGcWRcVqFTFxZFkIlSRqQkakazGd1JFhiyLGaC4sixCRZFkXGsxKmNSEiyLmJQxVxYzUWRcXFiVJFxcMWJUXFkXFiVJFkXFkVKmLIsi4sSpFXBUqSKKsRBcXASRcXDFiVFkWLFSoY1hglTDGggmKYuLBBcBKmLgBQUxURcIqiYq4BUxMrQJWcVbEFBZDAqLiglTFwABcFgkXAEAFQAATFEEFBagoAAoACAAAAAAGAAJVE1cQMXEVDFFgAIP8upazaa4LHRltxLfjO/S1YFNS1NagqWpalpmCpqWprUF01nU1YNaaxaaQatTU1LVRrTWTSK1qammqLpqJqjQzumkGhmU0g0JpaRF01jWp4sGtTU0SCiasVGt+JEXQWLrOmiF9WJDVGtECCiSmqKhakXE1QFQE/SqJ6Hg0JUpaRrEP8SrUq4jNSr+pW8RL6lWo3gjLVRrGWUWo9MEZrVZreIiVcSt4ms1K0zW8RmpY0zXpiMpWqy3jKJfFxG8TUS+KlbxGaYo3gyjSVvEZqNJW8TWaYo1iH4i1GsRKjSZ9aRCxcRcNQUbZ1Ga2mKMjWGLgyNYlixmpIL+DUKiY1h+qVBcLFGVFkIyg1iNCGauAIqkjSBigJi4KsKgv6sWJUwxrFwiVlZFxqRqJus4SNYYsSs4sjSyESs4uNYSNQZxf5axcWM1mctYuGESoYuKsSoSLjUixKmDWLjUZrMi4uLIsSphjWLhErMi4uLIsKkiyLI1I1Gd1JFxZFWJUkMVcWJUFxqRYlZkXGsMWJUkXFkWLEqRcWRZFiJI1IuLIuYzUxZFxWolTFhIsixKYshI1IsZ3TDFIqGLILIsSki4SKqAuEiwpIsi4LGd0wFixEWRVixKmLixRKziqKlT8XDFwgSGKYQBcFSgCxAFwgiqLBMMUABcBFxQQAAAADDFAXIERDFCFMAEoAoAAC4YCLhFEqYYoQqItQUBYCC4YCDSYCC4gAAAAAuKCYYoDK4oKmCgVBUwH8/TWLUtcFjpEa1LUtTViLpU1m1cGrWbWdTWoNWs6mpqwbS1naaQXTWbTVg1qWpoQU1nTVGtqakCC6rOijWjIDQgsFGV0RTU1YIsECDREUguiBBRBUUD8BdLWdUF0QUWKyohT8S1Y0gVLfqfqigl9XEQUaRkpUrWCVFRvET1FRrE1KjVZbxEsZaqVvDWay0n43iM1LGqzfG8ZRmtZ9R6YjNZrXTL0xNRF/RvGdZStVG8Rmov6lbxGV/DCt4JWWrPiN4iRLFK3iJiWLg1iMmLRrETExpGolQXCtYms1GkjWBiNJjSVBcMIlRK0VrEZkMUVEwsakFKzgpYsKkikixUqJjWGKlZw/WsXFKmGNYLmImGNIsKmGKuKlSRr4kirEBZFkIVJFkXFxqImGNYuLErOLIuLhEqYYuLIsSpFXFkaZ3WcXGlk1YlYxcaxcWJWYsjWEixKmLi4uLmJWcXGpFxqJWZGv5WRcIlZxZFxcWJUxZFkWRYlSRZFxZGozUkWRcXFiVnFxcWSkSs4uNYsiwrOLI1IuLErMjWLiyNRmpIpirEpguEixCRcXFxYzUkXFi4sSpFkWRVRMWRZFkUqYsWQWM7pgLixEFxcWFSLi4qomLi4CUwXDFiGGLi4CLAUACJQFioGKACyGBUMVRKmCgAAAEgEXAWIYAFAFQAAAAAAFxQTDFCJUUCAAqAKCCpRUxQQABAAUABMMUFTFFwEFxAAAAAAAAAfyNTUtTXCI6Sums6aRF1NTWbWoNWs6lqWqNWprOoo3qf0zppBrTWNNUa1f6Y00g3qVnTVgurrGmrBpdY1dSC6u/WRRvTWNNBvfq6wspEa1WNWUGtIzq6I0upDQXU1CVYNRWV0iKlpqA1BIoLqRF0RUBrEFQUAKuGpVZ/VaRUoVURFrLWIIqNIlRajeCfqLUreIiVWa3mIlKFbxGL6LUbxGalaqV6ZiM1mxpOm8RlGkemM6zUVG8TWUbZsbxDEVG8xlKzfW2W8CxmtVP1vGUpA/GsEwCRpDMStVG8ZTEsaSrgmI1iY0lRTBpNSmfFwXARTFRJBYNRKQsWGfFiVjFWRVgyKSGYhiY0Y0M4q4uEEwkUxpkTGsMXMKkhFkXFibqDWGLEqSNSGLFgLISNSLE3UJGsMWM1FMXFKmLIsjWLGd1nFxZCRcxmkiyLiyNRNTDG8MWIzIuNYYRKmLIsiyNRN1nFxrFxYlZxcawkWJUxZFwkWJTBcWRUqSLiyLIuYlZWRqRZFiVmRrFxcWJWcWRVWJUxZFkVYlSRYsi4sZ3UwxqGKlTFxZFkWJUkXFxVRJFkFxYUxcXBYzTAVURcUWJSGLiqiYqyAVMUWLERZFXARcFwSoqgiYKY0Jg1hQrKi4CLgogAAAAYsgqGEgBQBSgAgCwEFwwEFxQTDFCJUxQWFAMEDFwAwwAMAAAAABAE1YACgAGLgCUACgBAKFWGIBiKChBAFgGKEH8K1KzamuEx0lrTWbfjOrCN6zams2rCNalqamrBdXWLTVg1prOmkRaM6asGhnSUGhnTVGk1LU0GtXWNWUg1qy/GNWVYNamoQg1q6zKREbnhKzpKsGzWTfpEblW1iVdSDWjMq6o0aysIi6rK6QUTT9Bo1BUUQixFVkUaRCqgA1gAi4yJQawLWbVStYiAN4iVlplvAqVWf1vGSs1ajeIlRUemIlRf1mt4mon60lemIjN9aZbxlmo1Ur0xEStVK1iMpVSvTEEVK1iILUemMljLSfrWAFGsxkS+qjWIgqNYgC4uIhSLjURnDFxcWFZwxRqFSRTDGoyKYKILTFiIYuKDIuGNBhVBKmLDGsVmpYjViSNZhSRcWRcWIhjUi4sKysiixN0kawjWLmM7rOLi4qxKmKuGNZiVIqyNYsZ3WcWRcVYlTGpCLixKi4q4sZrOLI1i4sSpIuEakWJWTGsXGolZkXFxoiVjFaxcVKziyNYsi5iVJFxZFaiVMUxZFiVMXFxcWJWcXFxcIlZkXFi4sSmGNSLIsSs4si4qomLFxViVJFkMVYlMBcWIi4YqxKEXFUTFXASmAsWIYYqwExcFwSouLgIAKARVSkUAAWAgoJUCgAosExQCgCoAAAuAguKFSKBEoAqAAAYsgIYoAAAAAAAAAAAAAlaBWcXAQoAQABABQAAAAAFABCgDQAI/OWpqal6cLjpa2palrNq5g1prFpKqNprNqWrBrTWdS0g1/RrKasG9Rm1dWIqysasqDWms2mqNWprOqsF01k0GtWX6zF0GtXWJWiC6usmg1pKkvw1UaE01IjUq6wsINSrrJpBvVYi6I1pqRVF0lZ1dBViGjK0iaKNCCipqCo0gjQtQRrGVtSiVoKgNYyIuo1giLUbxCsrfU8bxESrWa3iCVUr0xGal9arP63jJfGa1Wa9MRKVWa3mIlRfwemMoi1K1EZPw/B6YiFVK3iIUhW8ZqEFjWDK/gWNYmoLErcRBRYzoA0iKsT9axAMWRRlRVxEwxf0aZMSxQwqYYo0akFIqISNYqwrIuLIqbqKuCsphI1FawTDFWRYlQawkWFSRrBYuYzuki4RqNZjO6mEawVKQxZGpFiVnFxqQxYlSRZFxZFZ3UxcawaiVMXFxcWJWcWRrBYlIsWRcWJUwkakWRYlZkXGsFjNQxVWJUi4uLIsSpg1IuLErOLIuLixKmC4uKVDGsWQiVnGpFFQwXFWJUxZFwWJTAVYiKYqwTFMakVEkUxRKmKLixEXFkXATFwBKLiwEAXFEFxVSphigAGAGKKlABAFgILhiiCoAAAEUDFASgCwAIIC4YCCgJigAAAAAKgCigmGKAmGKAlhigGAAJVAZFsQAAAAAAAAABQFwwEVRBMKpQZAB+X34zqalrh0dMatTWdTSEatTWdS1RvS1j+jVGiVnfhqjWpazamkG5TWNNIN6azq6sF1dY1ZRF1ZWdTVRsZ0Bo1nV0g1KrGrpBraammkRqVdY1SDcprOhEb1dZXSDWms6LBvVYlXUiNausyhBpWdWUgsVldVlTWV1RpNTSLEaEFFqCKi6IVrENNQrWYgCN5iFRUrWIlBK3mIM31ajWYiVFqPTESotSt5ialCo3iIlVK9MZS1KqVvE1PwWo9MxlL4lWo3hqfiXxan63jJPEX8PI3iIE9K3jKUKRrERfxRrBEvqw/W8REaGsTUwXEqsiyI03iJYjQsRIfqoqaYKn6sQgouYJilFxKhFIoLAWIUkFjUZ3QxcXBKkiyCtLUahIsjWYzTDFxcWJWcWRVxYlJFWRcWM7rOLjWCpST4uKNJSLhIuLGaLCRqRcTUxZFwxqIYuLIuKlZxqQWRYm6SNYRWozUwUkEoY1irErOLGsFiVMXBqRcxKhi4uLEqLi4qokiyCwExcUxYlTFkUWJTAXFiILMVRMVcBKSCyLipUxRYREWQxVDDFxcEqLhFVExQIBi4qpUxQACRcETFwFSgAALgILiqJIoCUAARqAM4Y0BWVAhQBUBZADAAAAAAAABQCRcAAAAAAAAAAAAAAABMUBDFATDFFGRoxRlcUQTFwEAAAAAAEqNMg/I2prNqWuIR01rUtZ0tINams6aqNamoijcprGmg1ams/0asGjWQg1q6waQbtTU00g1KM6aqNStSsSgNWrrC6I3KSsSrKsG9NY1ZSDekrOrKRNa1dY1dIjcvwjOrL8INarGxd+CNLGVhBsZ1dINaIEGpTWV1WVhakoYNLGdNVNa1LUI0KalouJqjKtItQGsxCiFaxNKgN4iVCkaxNRFqN4mlZqpW8xEAemMlZvq1G8TUSrUreIgfqV6YzpUxRvGdZs+pWqlbxGf0KSPTMTSpYsK1iMlXEreJokUjWYgFI3iAtMaxmoA0hIX1UaxCRcIuNYmsi4ioCmKmoKjWYEii4RNQUajKLgsi4GBi4sEwXCRYyqNYn6uYGKshjSUjUhIrUZ1FMVUTFhjUhEJ4pI1I1jO6iyLIuNRKmLiyLIsRFkXFixCRcIsjUZ3SRcUkWJUXFwxYlMWRZFkWM1IY1g0lSRoxZFiVJFXFEQxrBUqSNSEaxUqYLIqxKysiyLiwqYuARKCwxYgYsirEqYY1gRKmEi4uKVMXBcERcJFUTFXADCLCKhihIIGLiqlTFAADBDDFFKACALgILiqJFAQAEAMUFhggALAAAMAKYAAAAAACwEFwwBQAAAAAAAAAAAAABQqAAALAAIABAAUFQBQVlEwxRRnDGgKyLUIoAQEqhB+JtKmlriMdNBLWbQb2Jb9Z1NUa01nTSDWprFpqwb01jTViNymsaaQb01z2rKsHTTWNNSDemsLqxG5TWNWUGtXWdLSI1qsaaQdNNZlNUblGdXURuUZlUG5TWZQiNLGdWVYNyrrGmkRvVlYXQdJTWNXQa01ldWMtSrGI1KQUQ1cRdNQ1YC1BYmioNMr+lTTW0BKNYgVKmtZgqCWt4yVCp+N5iLUEbzE0KfiWt5jKVAemYhUKN4iFCt5jOoUHpjLNKqVvEZvq0G8TUIVW8TUz6zWr4mNYzSEX8RrDRYjTeM6lRc+laxKmC4saRL5jP61UaxFhVT9aRFkMJ4pQxYKzUIo0GCyFiokFwxUSRZ6YsWIGKNFTFgsgzSJJ9aI1mIYuCxrMQxRZFSmGKsWJTCCxYysikjUjWM6SEWRWsQMWCpRZCRqRcxKkjUi4sXMZqLIqtZjO6mGKsixKSKLi4iYsi4qoki4qxUqYpi4qIuKqxKkiirEMBViILhgGEikixKCqqIpihQFwRFhi4IBiqEgqyCJhiiwAxYoiqYIC4mCCgoACALgGEiipQAAMUQwwAMAWAAAAAAJQUwEFUGVXAVEawBkasTAFMAAAAAAAAAoKBUFwEAFAUIIKKCKAyLhgtQDABVSpWVwClMFAAAAFAABmtJQQAUAB+F01z1dcRjprVqazqWrmDWmsamkG7U1nTVg1prCyrBrTWdTVg1ozq6IurrOgNyrsc9NIN6azoqNyrK56spBvTWdJSI3ozp/RB0lNYlalINKxKukG5SViVZSI6aSsaspEb1ZWFlIa3prMq6qNausLAb1dYXSDcqsLpGWjU01YNaahFiNJaloosvw1NIrLWoamtRFtJUXWsTTU0qNYi2olG8xCiU343mIUEbxNC+lRvGSpSo3iAVNbxnQB6ZiJUW+o3iaCfpW8Z1KlKSN5iCyfEqt4zqUBvESkUvjWMoQxY3hoA0yJVRrEUCtYiCjWIfiRRrAAWMkAXEFhCNAoRU3QUqpUaiLGsRUqoJpFCKi/hBY1iCixpCRSKrOgLPFQWEajSbqyKRpcZSRZBprETFJFkaZ3SRYSNSGJTFMWNM0kXCRWmUkakJFkAkXBYqIsMakVKmLIsVqM1MMUUBcBKRTFi5iJIouLEqLIYqoi4YoVFFhERcUWALICGCyLFRMMUIAGKCwxRAJFxUTFBSgAgCwEXFCJQAgBiqiYoAAEAUwKg1gFZGgSoKAyuKAQBVgBiALgJTDFFgmGKEExGkIIKEEUEAUaEwUSAigABAAUAAAAAAQ0AMUGQQUAAAAABoAAAAAAZotQXAAHn+prNprikdOb1NZ1LTMRrU1nTVgums6asVrTWdTSI1prOmrBrV1jV0GtVjTQb01iVrQa0Z00iNasrGrL9WDemsmkGtJfrKwiNyrrGrpEbi6xKukG9NZ0Ebi7jGqsRvVjEq6g3v+rrC6sRvVjnK1KQbVjVlIjWrrOoRG5VlYiyrBvV1kWIuqzFXMTV0lZXWsxF1E1Viaqalo1mJq/oalreYi6WojWYmqIa1mIaIa3mM6tZtLSt5jOoCPTMQAbxEp+FRvGQolemYglXUrWMoviFemJotQrWMgDeYmiVUjeYihBrE0AazESkWk9bQFqKyBFaw0qCtYiEX9FTSo0LmJUUWNImKEVNDFwqoYsiRqNRkxItIsKLISKsZTFkIsaxBVkFSpFXFxU3UirILEpGuUkb5jWMkahFkajO6RSLjSVJGhcVCKEVlYshIqsiyDUXAkBZFQxZBYqCwVrGQXDFRJFAQWEXFDFxTGmQMXAqRcAQBcWCLFXATFFkEDFFQAUAAFFVAhFVAAQAABZAIoKgSLICGAAAoILhgVGkxRAAABYABCABAAIALgpFRRAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAASAAgAAAAAKACgAAACI0lBABXnOmsauuLOntams6mkGtNZ01RrU1m01UaNZ1NBvTWdNWI1prJpBrTWdNIN6azq6Qa01jV0iRrVlZ01R01XPVl+JBslTTSI1pKzqyqjcq6xKsoNasrOkojWtSsasEb1ZWNXSDcprOrFiNStRhZUg6aaxKurEaaYNVGxnV0g1KusRViN6axq6sRrVZ01Yilqaa1iLPRNSVrMTWtELWkW1E01vMZUTRrMRUomt5jIVB6ZiaANYzomiV6ZiafoQbzE0viLWW8Z0RUreICNTxvGdMQStYigN4gH6N4zoC/jeJqLEX8aRCC+NIlAVKsKDSCg0ifq4LFZ1KLiY0CmfVgmoqjTNEUi4iwFjSGGKsVKkUVcQWJFazEFkIrSUUkFZ1SRYsVCetSJJ9bXE3SRSRptndICqySKEVFhILFiLGiRWoiRQEWKirEFiNRU1YpBpkBVRGpExRNFhFjSEUBAFxYEhIsIBhighFkMWKJigRACKC4KIihigSLBU0AEAAAWQCKCoBIogAAC4AKCAAAAACgAqgYuBUFwQqC4YUqRpFEAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAETRQEAAAAABQAUAAAAEUBmi1BceaaaxpK4xHT29/1LWKaQaN+s6asGtTU1FGtGdNBrTWdNBraazpojWrrGrqjWrrEq6I1qys7BBvRjWtVGpVlY36sv0g3q6xppBvV1iVdEb01nfhqxG5VYla0GorGromt6SskIjosc5WtWI2srGrKQb1ZWNXSDekrOkIy3q6xq6sGpfrTnL9a1YjRrOmtRG9LWZTVjOtaazDViNRfGJTWsxNa1NDWswVEtN+t5jLWiJa3jK6moreYipUGsxlRBvMQQo9MZVKalbzEVKTwazGSeItRvEIUHpjIA1mJoA2hChGsTSFXPiN4yKRWk1Cg1iaEgLiKBGmTBRrE0gCwBcMVCL+CriaZ8MFaZTCCxcTTFCNYmrgKIARvEWArWIpiwEFnpFaZGokaVCNJGpFxNXlSEbZWKiqyRUjUXE0xqI1IqKAqEUiqmgEVFixGuVxNUBrGVi4mKJoLgIoEU1QXGsQxYKCRRRKYSKKgAoAoUwiixADFDFAQAEAAFiRowAMVkWGAAAAuGBSRQEAAAFgACwAUCCwFASIAAAKAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACKAAIACAAAAAAoAKAAAADNaSg8u01nU1xp1Bu34lrOppBu1NZ00GtXWNNUb1KzpoNaazpqjWmswtBrVlc1lwg3prOkqxlvTWViQa1ZWRRvTWdNIjpKa5ytToG13/AFiVRG5V1z1ZSI3rUvxglBu1ZWNWLEblWViVZSI0srJoa6asYlWVUbXWNWUg1rWsaurEa1qMQ1YzrerKxppBvVYlVpluGs6Rcw1rTWRqMtaM6asRrTWd+q3mJqqwu/GsxNW1LRNbxF1d+MjWM6pEG8ZW0S1HpmI0In61jKoH69MRagN5jIItaZAG8QAaxkBK3gvqpPFaxnSkP0jWIfhEajWM6YjX4jWIIqNYirEVpABpBYixU1QFQiguYgv4FaxEWI1FQWJGlxnQD8aiBF/BoWLEixU1QWKyqxFkaRoBUa5ajPLUXGdVYQbZUCCLFnhIrSEbjLS4mixFVBQiskUWARqJFaZ0WCqgsRcGVAUMaiRpURQUFIKLFZUZURVBYSKIALgAsVCACAAAAAsUABWRYQAAAWI0GgAgAAAqwAUAAAAMXBUQAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAARNFAQAAAFABQAAAAEAVAB5VsTWdTXG3UGtGdNUa1NTU0GtNZ00GtNrOmqNSms6aDWrrGqDRrOijcq6xq6RGtWVjTSDpKaxKukRvTWdWUg1qxgIjpq6xCVUbXWNWUg3KusSrpEb1ZWNWVYN7SWs6aMukqy6xq6sNb1ZWJWpSI1qysSrpBuVdYirE1vfi6xpqxG1Z0WMt6axq6uYjerrG6asRvU1NGsxGhmGtRGtElNazEa0jOmtYzq2iareYguolrWYzq01EbzE1oQ1vMZW1EG8xnWqkTVjeYmqlVG2dIBG8TSn6DWIqVU9reMqAuJqwEbxkURpNWKDWJpSBGkPwKRrGSeqsiNYgA1gNJFgmgVeWsZ0F/VxUqTwq/o0iYoQRYoNYzooNYCxFioNRIrSLPVSKrKyNJFVBYjS4ixYcq1jOrAVpkWGEVGoQWKixUVcTVgkVU1ViRVQWIsXEWNRI01jO6kUBCKkjSoARRY0kVcQIEgKAoAKyNIsBVRRABaEUgqAAgAAsRYYCgrIBgLAAAXAJFAQAAAVYARQFwCoRREUAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBUSCgEAQAA0AEUUQRYAFAAo8l0tZ01x509rSsaugtqahasF01mUtINarGkukG01NNiwa/o1nQG9GF0G5V1gINyrrEq6sGlZ01IjcpKxq6sRvYuucrWg1K0xFVGosZ0lIjppKwsojcqysaaQb1dZlWKmtNc1jSUiOmmsasqxG5VYjUoOkprGmrGXSVZXPV1YmtyrrEq6sRqVrfjEq6sRdXWdVrMTWtJWdJVjOtjOmtZiNaaxqytRGtNSK1iKJKNYyomrreJoIWtpq6gN4zq6mg3jI1GTW8TWqiarWMipaNYmlIjUbxnSqRK2igNZjK1IDeIWkFi4yqfpaRrEVahWsxNFiRWk1agNIAKixqJD8VFWMxpcZ0i0iVrEIqRVBYkaaZFRVQAaFUFxkjUSLFTSLBqKmrAFRYqRWsTWoqRqNYwoEVFWI1FZIpBRYqRVRYCqmkVIqoNRI1FZ1YqRWmdFiLFxFAUCCwNWKkVcRQgoACACosaiRRNUAAACVUVcQAEAFFipFVNABBSeAAAKqKJoAAApguIqrqKKiACAAsABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQVKIUQAAUAQAAAAeQ6mpqa5C6gurrOmkGtTU0IKM6asGhnTSDVpKyBG9NYXRG9XWNNWDWtSsS/DSDcqyuerL9B00Z00StLrCykGtXWdNEdJWtcpWtWI3prGrKDerrC6I3KaysqxGtalc9a1U1u0ZURqVrWJV1Ua1qMLojekrEv1dWI6asY1dWJrZrEq6sRrV1nTWojcrWucq6RNb1NZ1ZW4mtaM6asZ1r9WM6utYmrq6zprWYy1prMVvMRrTWdGsxNa1A1vMZFQ1rMTV01BvGVVJ4NZjOqWpo3iLCg1jOjUZXW8TV0iLGsRRKsbxnQVGkAGsZFP0axFQVpFgQaxABcQaSLFTV8Aq4zpAitIfiLSNCgLjKxUWKmig1iALioRQiosaZkaVBqJGo0zoCrgRqeosVnWliK3jOqsRYINJFaZVUiqasILBBQXGVgCixqJFaZ1YpBWRYixUUACLBYosILPVQAXAAVkWIsBcUiiAAAEgEUFTQAxAFihFAxABUUAAAFipFEAAAGlwWIoaKisoAKACgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIaCiaaAqDIommgqIsWBiLURcAAAAAFHjmmpprkTqC2msroLommgomoDQyA1prK6C6srOmiNCbTao0Ss7TQbGZQHSU1iVdEjejGrpEblViVdWDUrUrnqykG9XWNWVUb01mVSI3KusasWI3F1iVdIN6srCyjLcqysSruLia6aaxprUHSVdc5WoRlqVdY1ZViN6rJqo2RnV1YjS6xqtRNa1WIq5ia1q6wsrTOtymsymtZia0s8ZhrWM61qamjeYjUq6ya1mMtjOmtYjSIsbxFVBrGVAbZAGsRpKajeMtJppGsxldXUI1iarUSFreJqiRVQAaxlYfpvxI3iNANMqEFw0AaxGoAuMr+JBYrKwqCgsRY0aoEVnVWA1jOroitYACjRAhjLUVIrTLUVmNRUFiLFxFXlF5XEaiosbxnVWIsE1Z6qRWmVVFXBViLFRSIqsqsSLFxNWKQVNWKkVWdFiLPRFAXAipFUai6zFVFAVABUFgsBVRRAABUVcQAEADAAijQAgsRYqAAAAKqRRAAABTABVFiLA1QEQAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQFQ1Ai6agLAAAAAAAAAAAAENVAXRkSDQmmkHjVqaia5G6g1qJqyguppqWg1KusSroNaazqSg3prOgNbFYNBvV1jV0RrTU1NWDZrOrqC6sZ1dUa01nV1UalXWF0RsjGtSg1F+Masqo3KusSrqo2axK1oNyrK561FZblXWJV0iNS/Wtc9WVYmumkrMqyrEa1ZWaaqN6srDUq4jWrrGrK1Ea1dY1ZVRvV1jWpVTWtNTRYy1Kus6StZia1KuskrWYmtfq6zBqMtGpprWYjQhreM61Kazo1mI1qysq0y1BIa1iNIit4ypqRWsTRUG8ZVYkX9axNVYg0yoi61iasE0axFipDWsZUBpFEiqi6qEaxnVWINI0JFVABWVpEVrAajLSpoT0J6uJqqDWIKitIAKLGkimMrFSK0ysVmNKir+IurgqxFistKkWNYzqrEWKzo0y00gqRQWKkVUVYkWLjKtMxY1iNQIKysVIqposRYIoACosaFioq4iwIKgAuIsajMagaKiiAAE9VIq4mgAgAAQFGgBBYhFRQDAABYrLUE0AAAVcAFBYgCqkVEAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAE0FRBKRdQBQAAAABAAAAAAAAAAWglUKMi1CgAUeL01NHJHUFGdNBoZ1rSAalTSDRqamkGtElCDWms6ukF1rWNWUGtTTUxUXVlQFa1WFlIjSysmqNrrGrojWrGSCNasrOimugxK1KqNSrKzF0ZaWX4zKqo1K1rnqyqNqxKsVlrWpWSURuX4srCtDSysa1PFxNaalY1dVnWtXWNXVRqVqVgazEb1ZWJVVG9NZVrGdaXWNXVRuU1nTWsZaJWdWVvEaWeJo1jOrqsrrTOtQ1nVlaxGhNI1iNCaSt5jLUEGsZaIkNaxGtEVtNXUBpFipFVk1UI2jSAuMrFRWsQWIsXEUiK3jOqE8FRYrMVUUQi4ixUitYmqRFiopAi4mqqK0gQFFWJFi4ysVIrSLPVZWVWVanrLXKmqBFRqeqkVWVjUZjTSCwJ6rKxplppkipFBYqRVRVSKqasCCo1FZajTI0ysVFE1qCKAILEWNCqimIsEnqqAC4yqxkUbEBIsVmNAKguIomrqJABQVFUUTTQUgsGQBcAAFisromqAAAAAtKAKoqRpNTQAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAVBEpF1ARQAAAAAAAAAAAAAAAAAAAAABKoDIqA8UW1ByZ1ABNIKsrMpVg1oyagtE00gq6yao1qsGg2M6upBV1nSKa1q7sZBGlY1Yo3prOmkGpVZXRGpV1jVlUala1hZRGtXWNa1YjUozF0RuVWJVlXEalXWSVUbWViVdVHSVZXNVR0NZmrqo1KsrOmqmtrrGrq4y1q6zKutZiNS/6uxglWI6SrrEVUalWVk1rGW4RmVdaRrTUI1mI1pKixrGWosrOjWMt6Mm61jOtLGTWkbNZXWsRVjMXW8TWtGVjTLRA1rGWhnV1rEXVZa1pF1AaQaSejTOrVjNWLiNQ36kWNYzqhBrGVVlVFWMq0zqgLiKRFi4LF36zpFZaWM78WVpGqJFaxNFlQVGhFhhqxYg1jLQkVUVUgqNLyzGoqNBKKjUVIrTKxqMxWmWhFVFWMxqLiKqLFRYqKqasVIKmrFRVRYqRVRYEFxNFiCo3okURVjKxUaistTxU0J6EUUBcZFRVFEigNMrBNUAABdCKimIAKgACxWVlBVQEFQVFVNUAlRQiiGiKAAAuAuooaoBRFRQAFAAAAAAAAAAAAAAAAAAAAAAAAAAEBEoAIoAAAAAAAAAAAAAAAAAAAAAAAAAAAAilB4jTU01yd1BRJUoNImmguiGg0iatA01AF0QUXV1klIN6azqg1KazKoi6srIo1q6zpoka0lSLoNErMaEaIkpqjSysSqsI3Kaysqo1KusrPFxNalaYlURvRmVdVlojOrFRvausxVTV1dZ1dWI1KsYitI6Q1jVlq4y2sZ1Y0y0uswUb01CLiNRWdXWsZa0lZ1Y1iNasZ0lazGWl1nRpG90Z1daZa01mK1iNaazqxrEaWMxprGdWKzpK1jLSsxW8ZXVZWetDUVldaZagixrGdDRNVGorMFTWoqRY1iasVIrbIAIoh+NIqpqqEVFi4zosRdVlRNJVwalWVnVlbqNDOtRUGmVgjUEVpBpldVFioLiNRYysVlqVphrlcNbJ6kVpho1BUjUVFjSaqz1CLia2sQistRUiqmioRRpYhFZaipFXEFSKqaAKixpmNTwTVILFTRYixRQFxFAXGQBRqCRQURpUAAAAFTFMQAVAAAgAqsrAUBWRYiwAAAAFNQCNCAimgqqWoANMmg0JpKIomgKCAoCgAAAgAFAEBQCgJqgCGgomm/QURCioCKAAAAAAAAAACaaCgAAaAJq6AAACaCiaaCiAKAAAAAAADw601ByiOoKammqKIaCoagKtrOroLFZ00FsMppoCKAqyskBrVlZAa1ZWFEaEAaisrqpqrKzpqo3prMrUoKqasVK0aguCrrOqI01Kxpqo3rUrnqyqy2sY1ViRuVdYiyqjZrMXWka1YzKsqo0usquMtasrCytJrcq6xqyqNyqxqytZjOtasZi6uM61qysjWI2azpGsZa1YzFaTWotrOq1jLREGsGhlZWsZbNZ3VaxnWtEWNYixWV1pnWtWMxdaxnWqMq1iNRWYKjQya0mtRWZV1cRqNRhdbxnWhNXVRaRNFxNaGdWKiho1iLFSKrKwQXEirGdVoaE1VRVQVFlVlYqNKmi4jQkWCLFSK0ysEiqmtRrliNxrEVplpcZ1YIqosalZiria0sZVplqKzFjTLUaZlWeGGqsQVGieosaxlpUniqhPVRYqaAKixqMNQTWhFVFgkVRYqRTE1RFioAKixWViirEA1VSKqACiiRUABWQAAABYiwFAE0AVDVQBQgAAAqAKaigauogjQhqlUApQBVAAXTUEFtQFBplUNVNTQhF1AUNNAABKAAAmmoKJoC1EAXTUAaTUAVWVBU1AFtQAAAWGoAqAAACiAAAAAAALpqALqsgNaaybRWjWdAjw4Q1yl1BRNNEUTTRVE0EUQBRIC6qs6oimppoLpKgDUqs81RC1dZWVVWVpklEahElVRRNNGValZFG9NZlVUalXWNVUbXWJVUb0ZWCNRWV1cRqLrMsWKmrq6ysqo1GtY1daxGtIhqs63qsyrqprUWMytSqirrOkaRvVlY1WkbisStSqyq6zFVlrTWVjeIqys6qs61KusxWsRqVqMRprEUTTWsTWorKtMtRWZVaxnWpVjKxrGdaRNFxGoqDWMqrK60NDKrjOqusxY2jWkqKqa1+KxFVnWhldaFipDdE1pYkVpmLKIa0iiLvxSKrMai4mrFZVrGVlVlZQirE0io0JqqirEixU1ViCstLGYqo1GozGo0y1FjMVrNTWllZlVWVWVBcNbisq0zrUWMxVxnWl1mVYqNKyoLrUZWNM60sZ1dVGhIq4iwILiaLKiqjUVIoyRUWNCxUiiaRUWKAAAC4kaEiiCosXNRQGgnqosEABAAAAAABYgDQmqIAKgACiRQA0AABRFBBQSIKAaqAKIKqiaIigLQAKABSgCAAAh/8AQCiAoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKaIBV01AK8NTSjlTqIuoAumoAogQXT8Q0iKJqgAEFhiAiqyA1PV1hdUaE00Roz/UlX8BYIao1ohBGhPgqNNMLKqNGskVG9WVlYo1KrMWCNRdZ01cRpdZVcRqX/V1hpUVrWJFVNb0ZitM61GpWJVVGtXWdWVcRpYxtWVR0lNZ1Y1jLSysxVxGtE01rGW/wlZitYyqxIrSLPWmNWVcZb3DWdVpFlaYXWsTWl1nVaTWorOm61jOtarMWNYzrUVnVjWI0rKxplSJpqourqaLiK1GVjSa1og1jOtSkZ1YuJGhJV1UFiNNIsq6zpqourrK61iNQTVUWLrOrqsxrTWV0pFWMrKtRpYgqLKuskqpG4sZlWKzreiGrUitMa1FTW4rMWNMtasZWVUaWMxWsRpUIrLUajCyribjZEVplqKzKsXEaisxVRpZWYqoqpKqosXWVVFjUZiqyqxlZVRqNMNRUUgLiKsRYookVUUSKAAAqKqRRARqVWVlVFEVRdENVFElUAAQAAAAWIAuqyA0JKokDQWgAIGgC6IAumoAogC6IsoAWpoKJqygohoRdNTQI1oiCRo1ECLp+pqCxRAFEAUNAA00ANTQUNTQURdADUtBRNAUTTQUNAAAA00AAANNAE1dAAAA0ATTQUNNARUAAQeGCaOWOpKAgDNFGkqBBRBBoSUEXVZFF1dQIi6JFAAMFisqqKsQBRNFGoMtQRYsZ1qVUURVFWMqIurKzPjS4yasqEUa1YysXEalxdZWCLKsQaNblW1hZRnWpV1lWkaisz1VRoZVU1ppmVdXGdalWVmErSNrrGrqo1qsRWsTW5V1iK1jOt6MxZWsTWhNNaZ1rV1mLGsTWorKxrGdai6kFxGiJKa1iNLKzFaxmNLGYrSNGsxVxloQVIqypBoaipKa1jDQixUUgKLoixaixUNXGV1dZI3iRqVWRUaipF1UWVWVUURYIqxNWKjWqzoqNCSqqLGozBU1vRIsVlViK1iNLGYqs61FZlalaRY0xGouI1KrKxazGosZitI3KrErUq4zuKsZWKjUWJFjTLUVIq4gsQBoRVZVdZlVRpYzFaRWpWVistRWY0qCoaqLGmV0FAVFEWAAAKgqKqAi6rOmqRsZ1dWpFEUDTQBdEIIoAQAVAAAAF01AF1WQGhkEjQysCKJpoRQCkAFoAJQAWgAUAChoIC6JoUiiGlIommpSAahSKushSNDIUjQypSKJppSKIpQAUABAAAAqmgCAJoqjIlI0IatIogUUQCKIFICCVV01AoumoAuiLsB4WBrlrqAaAAmlBRDQVKACsqJqkARQigGoAurKgQUBRdNRVRRNUBUUTRYmrFRQAX6srMURqU1BUbGZRUa1WcVRrVZVcZa1WFijejMqz/1Uai6zKKy3qsRqKLFZXWka1YyarLaysasqs7jcVmVWsZ3GorEq6uDS6xKsaxGpVZaaxGtViNRWdWKzqxrEajUZiytMa3qazqxpF1UFIqys6rTOtStMRdaZaXWYKjWqzFaNaNTTVZXWoxGo1iRpYxFlVmNCLK0kagmmqNRNTRWV1UWNIqxCKjUVkWo3KM6uqkVfjMqwo0JFVlYqaatGljKyriRpdZVUitRjWo1jOtRqMSrKrLS6mio0sQVGxJVaxGpVZlWLiNkqaRplpYyqo3BnWo1WdxZWoysVnW4sYlalVGhJVWoRplYooCstRWZVlXE1r8EWKmtERdVloSVRCKhrQ1FZWCKAtDV1AoauoAoiiACoNRkUaXWTQbGZVEUQBV1AF36ILUUTVCAaBADVIACQDQAAAAAAAABdQBdQAAAFQA0QSrFEIUiiaaEUSVQgApAAQAAAAAAXUAXTUAUQBTUAXTUNQaTWdUpAAICaaLFENEiiBViiaBFE0CKIBFAEAAAAeF1FRy+OoLoiqIKIIAkAAAABfqLAaisqMqIoIoi4KT0FRQDAWIKKrLQgAIsXUgoutSsNRU1VZUFEBNalVlYqNwZlXVZVYyqo0sZI0NrKzFlEalWVjVVGtWVlWkaisxZVZ1V1BpGpWtYn+rq4mtarOrK1iKsqC4y3CMxrVxNaVmVdaxNa01nVjSNarKxrGdajUY01pnW9RNXVRYrK6uJF1YyutI1KsrIuM63q6xq60jWjOrKqNLqEUbgkNaZa1WV1UXTU0axFioNI3CMytKysqsipGjWV0pF1WdVUjUWMxVRpdZi6qRdVlYqRqUQVGpWpWNWVcTWtWMyrFxluVWFjSNyrGZVi4jasaq1ncbiysasqpG4srMVpluUZjUXNTWiVlWkjSysxVxG4rMVpmNRZWVlWsxpZWYqo1qs6qpGtVjV1TcaWMrFZbEgqNCSqqRdalYFRs1nVEi6srJqjpKrmspUjYzKKkaGV0IoC0NNAFEBIoSgRV1kVGtENUU1NUFggJGhNNBRNNBRFAAWgAUACgAVDTQKGmgUNXUAiiBSKJpoRUQQUAUAAAAAAXUAUQWiiCoohoRRAIogEUTQIohqEU1nTSrFE01BRNNBbQABNNBRFAAAAAAAAAAWoGgUACK8LAcvdOUiCiooCAAAABqAoiwBfxFgyumiAoigsVICKmqmLgoigasqEUa1UBIqysqIq6zq6o1BmVRFXWYqoqsqqNasrJFSNarKxUalXWTRGpVZajSK1rAqNtOcWKmtyrrCyqjTUY1Y0jS6yLiNrKwurjOt6azqxrEXVSKqNSrKxFlaxltYzKa1iNau6xKsq4mtwlTSNI1qxFistQZaioEBpFXU01U3GtVhrWmYurKyapG1jEXVxI3qysSrrTLUqsasrWI1KuojSRvSJBajUWVhYVI2azq61UiqzKugqxBUaisxVZirGdXSjRqaKjWrrK6uam40RJVjTLUVmLqsta1GFipuNrGZRqst6srErUUaWMyqrLSxmVYqbjcq6xKsqo3KusRdaqNyrGNalVncblXWIrWaka1WdVqsxqKzF1U1slZVWWljMUwblVldaxnWpV1hdVI0akoUjWrrJKrMaEWKRRBai6srKg3KrnGpRGhDVqKqSikaEgIoAAC0DQBdEBIohqka01NNCLpqAjQgoommgpqaugGmpqUa0lZ1SkW1NAoauoFF01BakUQCKazoUjVqayosa0ZWUIpqWpokaGdXQjSJpoRRAI0M6aEaE00FE1QAQFAAAWgImpRbUBKoAtAAAAAAAABdQAAAXUAi6IBGhldEiiaAogCgA8LENcxjpyiAKgKGgJAAAAAAIKJq6IogqKIAurrKwGtEAiiLokUgAGitBoAg0yoiqgqRVZjQiiSqqDTKxRVTSVWWosTSVUaD4aosqsquI1IrOqrKyqgqNSqksNVGhNWNYLKrK6uM7jUWJprSNauxjSLiN6akFZaWVIRpGtWMrFRuKwutMt6rEqyrg3DWdVrGVXWYuqirGVaRrVYlXVSNETVVFVk1cRrTUg3iRuLrMNVmNjK6tRrTWdVSNSqwuqjeqxq6tRoZWUpGpVlZXWqzGjWZV0SNaazKq0jRqQXEaWVnVlVmNSrKzFVmNStMStRpnWljMVc1GtVjVi0jaysSrq1mN6srGtStVI1rUYlWVUjWtSsauqkb1WJVlWs7jcWMrKqNyqzKutVnca1WVio1qsrK1WdxqVdZ0WpG5VYlalWo3KazFWo0sZVUVdZirRoQ1WWpVZFqRrVZ1RFEXVpBZcQVGpVYXRI2M78XVosWVlSo1ozq6pFE00SLpqGixdVkKRoTTVRRNNBRFBdNQEi6IBFENCKIaEVWdXQgGgQAEUQ0F01AWAaaAGgACkAEIABBUAi6agEXVZAaGV1UWLrOqUNAKC6zpq0XS1NRKLpqALogUXUAF1dZAaE00FE00gommkFE00FTUAaEIUUAoALQAA1dQBdNQCPDAHMnTQAABEAFpQSoK0MroKJpoKJFRkioGCgKAALKrLUoACos8VPwBRFA1dQVldEWAAKjUqoAqypo0jRE1RFVnV1U1VZVUa1WVio1BF1cTVixlYqKsQlVGljOmqNxdYNaRv+l1hZVRpYzqxWWhFaRYsrMaVGpVZWVplqVWTVTW9TWVjWMtSrrCyqkblVjV1UbisautI1qs6aqNKzq6tSLqsasrSNaayqkblXXONa1WY0rOmrUjcprOrq1IurKypUa1dZlFRuKxqyrUjQkoo1Kusi1I1qs6soiytSsrFRoZVamqsqDSNxWV1ay1FZlWVazuNasrGqtSNqxK1K1mo1KRDRGpVZWVpI3F1jVlVmOkpKzq6tSNRZWZVlXNR0lVz1qVqsxrWpWNVUb1ZWJV1qpuOmjGrKtSN6rMWLWY1qxlYuJG5VjGrK1WW4MyrKqNasZVaRdXWdVUVdZ1YVI0Mrqo1KrItI1F1nTRI0Jq6tSKRNFqNGsroNaazKuiRdEFRpECjRrOrpRrRnTSjRrIUaWMijYzKuiKILRRkKRoZXQijK6EUTTSigFAAATTQUTTQUAAADTQA00AXTUANIALpqALogC6b9QEiiARRDRVEAUTV0QDQUAAAEAAgCaEUJRQDTUQDQAAFEAVWVBRNNBU0QF1AB4bpqDmjprQysBRFRABSCYoCYjQFQKCmiLBFAEUIAAKACCmpBcRpWdWKAAGrqKJqrEiiC4gqRVZFGlZ0io0sZAjYyKjfxZWIqprcGWpVTVlVlYuIuqixWQNFFlVlY0jUVmKCqhGk1WmVi4jSsrqstDOmqjpprGq1iRolSVWqysaZgqNLGdVUirKkFSNSrrJrWI3prGqqNasrEXVxHQY1ZWkaisrpUaNQaqLK1KwsWkbi6wsq1mNLrErWriRoZXVqRVjOqtGtNZXSpGjWVlWo2Ss6urUjS6xq6tZjWrKxq6tRvV1jWotSNSrrMWLUjWrrCyqkblViLq5rMbXWNXVqRuVZWNWVqpG11jVi1G9WVhZVxI01rEWLWdxuVqVzjUrSRuVdYlVay3KsrCyrUbl1WJV1akblac5WpWqzG41rEq60mtxWFXNSNyqxq61WY1KsrOmlSN6srGrKtSN6azqrUa1WNWVaRpdZ00SNms6urUjQzpKqNLrOroLqsrq1IumpppSNaazqrUirrJoRrRNNKkXTU0KRoZUqRRNNUimppoRrSVNNBrTWZYq1F0AoaaBRdNQUNNAF01k0GjWdNBrTWVBdEAUTTQU1NNKNaazppRrTWdXSkXTUFpGhldKRRNNEiiaaEUTTSigmoKJqgAAAFABQ0ADVQBdQEoAAAFABaAAGqgIogUi6mglAAVdEFoomroPDBcRzR0sAAVARoSUCgooioEBJ6BDFqAYLFSeqIAAuiBgogouiLBBUAa3U0h8qosq/UnxQFAQipPVAAVBYixRRFBYvxIKyvxUiqGqhKqNaairiRZV1lYqKsZWVUjSxlVRoiSrqoqs6KN6msq0y1ohKuI1FTTVRqLGV1UaGVlWpGtWVlZWqkaXWZV1ajRrOmqka01lWkaixmKrLQysWo1F1lYqRrV1kWo2usSi1I2MyrKtFajOqtRRNXVRZTUCjUq6w1FqbjWms6q1I1KsrC6qbjS6xrUq1nV1WdBI0srMqxajcq65ytStVNxuVZWNXVzUb1WNWVakb1WNXVrMa1ZWdNWpG9XWNWVpI2usSrq1I3rUc9WVazHTV1iUlWo3K1KxKsrSbjerKxq6rMbi6xKsq1I3KsrC6qRuVqVzlalXNRuVqViVWqzG5Wtc5WpWs1I3ozq6qNausaurUjWqzDVzUjcq6xq6rMb01mU1akb1dYi6tRrVlZlNKNarOhSNarOmrUjYzq6tSLq6zppUa01kWjSsmlGtNZ00pGxnTVqRoTTSka01nTQjQzqqkU1AIq6yBG9NZ0WpGtXWF0SNaM6aEaLWdQI1oyJSNCaLSKayJSNausmrSNaami0XTUCiqyQqNCKUACgsqCiiAKagCiCUUTTSiiaaUVdQKLpqARdNQKRVY01aRpWdWUSKJpoKAAAAAAJqCxVZXRIoigAAAAAACaaDxAE1zR0sMNCpUAUUQ1oXTUEFEFQAAAAXUBWhldEUBIACgABqoogAo1KMrKJGtEBGiMrKDQaaoBoqNDK6C6rOqqNRWdJVRoTTVTVaZ01YjQyRRvTUFRdWVmVVRo1lYqNLKyutI0MroLq6guaka1YxrUVNxrVZXVqLqpDVZalVnU1pG9NZ1ZVxF2rKgtSNasZiqka1WNXVqNLKzKq5qRrVY1dWpGl1jV1UjcNZXVSNLKzF1amtDMq6tRrVYVaNGsrpUalXWJV1ajWqxq6tGtNZlVay1ohFSNasZVUjSsasq1I1pqC1I3KusSrKtSNyrrGrKtSNrKxKurUbNZ1dWo1KsrC6tSOmjEq61UjcqysTpdWs7jerKyRc1I6asrEqytMxuVZWJWpVqNasrMqrWY3KuucalVNxtZWJVaqRuVqViLKuazuN6usa0qNStSuerK1UdNNY1ZVqRvTWYurUjWrKyatRuVZWNNWpG9XWNWVakb0lZ1SpGtXWF1akb01jV0Gta1z1dVGxiVdKkaGdN1aRrTWQpG9NZihFNQVIqshSNGpppSNaazppUjWrrGrqka01nV0IuqzpokaGRaRvU1NNEi6JppVimpppRdNQKi6ammg1ozpoRrTWdNUjQzq6UjQyBGtNZ1dKka/pNTRaRqU1k0pGtTUEpF01Ao1qWoFF2moFGtNZFo3qahoNaazpoNaazpoNaazpoNLrEqiRrTU01aNSiAjWmsiEa1ENWiiaugAKC6gA0yaDSammoRdQCgCKPEAHNHSQAQAUAFUAUABAAAAAAAAFisrAUABYiiaCaugAKAALFZVUUIKixWY0AsQDVAVCKgouqysEVdQVFXWdVUaWMrKqNCaq4gQAURWkXVZaEWCLFRTUVRYrOmqjWrrGq0jWkqRVqRqUZXVSKsTRUaajMFqRpdZ0lKzGxmKtFjUZNVGxldWoqyoLUjWmsrCpGorJq1I2azpKtSNasrOqtSNSqxKurmpGhNNWi6sZ1VqNRYzFVFXWdVakaGV1akaEJVqRrVlZFSN6azpq1I2usauqkb1ZWNXVqRvV1zlXVqR0lWVz1dWo6GsStauajS6yqpGua1K5rK1Wdx01ZWJV1am43K1K56utZrMdNXXOVqVay3qsa1FSNRZWdWVpI3qysaurUjerrGrKtSN6usSrq1mNyrrBq1I6asrnKurUjpoxq6tI3q6xq6tSN6M6auakb1dc9XVqR001jV1akaVjVlKka1dZ01aka01k0pGtWVhVqRuU1iVdKRrV1nTSo1prOmqN6axppRvTWdNKRvRnTVqRoZlNKRoZ1dhRrTWdNWjems6aVI1prOhSNausLKUjWpqaapF01NNCLpqGlIurrOqVFNZ0KNGoFFECiiGlGlZ01aka0ZCkaGV0pF1dZ0BoQVIogEUTTQiiaIRRCVSKGkokAAAAWVWRaNGoSpRV1BaLogEaGV0SKSpppSNan9MhSLogLGhldEiiaikVU01FeIgObx0YRQEFQDTTBVXRBUVWTQaMSUBcMAEAADDABKasGtViNJBRNCEURRCVUIooAAACxBRoSKrKqyaDRqKCiRWkAWCKIqoLKgCqzFXEWVqVhdVGxmVYtRTRNUa01nVVI1prKqjRrK6uI0rKqLFSKtZ0WIKNCaFSLq6gtRrV1jVlCN6Myrq1I1qys6urWdxrTU0lWpGorOmrUjS6yatI2M6LWY3prOmlI0rKyrUWLGV1UbTU01rEjWjOrKtRZVlZVUa1dY00qRuVdY1dWkb01mU1ajcq6xKurUjWrrIqRvRnVWkVdZNKkblXWJVlWpG5VYWVqsxpZWZVWjUqysLq1ncdJVYiyrUjcqs6StVI3F1iVqVazuNyqxpq1I3qysyq1WY3K1K5yrq1mN6srErUrWajerrEq6tSNSrrErWrUjWtSua6tSOmmsSmrUjpqsSrKVI1q6zoqRuVZWBakddNc5VlWpHTRjV1aRvTWNXVqRvSVnTSpG9NZ01aRvT+mNFqRv8ApZWDSkb01nV1akalNZ00qRvV1z1ZVpG9NZ00SNaMqUiiaatSKus6aUjWms6aUjWms6uhGt/01i0KRvV1z01aR0lXWJV0qRvU1nRaRvTWNNKRvRjV0pGhnTSpGhNJQUTTQa01NFDV1BEUZtXSkaNZ1dWkXV1kWouqgDWms6ulIumpoUgtrNoEUQBrTWZVCNGshUjS6zpq0jRrOmiRV1BRdNQBVZNCNaazpoRvU1nV0IpEAaGVCKJFCAmmiKGhQAB4kA5zjowAoAJAAIACAYDQYAAAAAAAQEsUAgCgACxZWQG9PjKiKIaChpqgAAuoKNCRRBZU0EaNZlXVGoM61qoKhqo0M6aI0ammg1ozF1pGtNQEaElVUFiCjQkVU1RFi1Fioqosq6yRajejKzQirEFRoZ1VSKsQ0RQFourGVgm40IatSNarMFSNLrKrUi6srIUa1dZ0VI00xqyribjWrrC60ka0QVIqxnTVqRvTWYLUjejOmrUjYzqyhGtEFSNSrrGrqpG9NY1dUjemsyrpUaWVhdWjS6zq6tTca1dYVazG5V1iUlWpHTVjEq61msxuVdYlWVakdJTWJWpWqka1ZWNXYVG5VlYlWVqpG5V1jVlWsx0lVzlWVakdFlY1darMdJVlc9WVakdBjVlWpG9WViVVqRvRnTVrMblalc9XVHTTWNNWpHTTWJV0qRvVc5WpVqRrV1hdWpGtWVhVpG5V1zWVakdNNY1dKjWms6urSNaM6urUjWrrGxSo1q6wurSNGs6aUjWrrGmrUjerrnq6UjemsaSlSOmmsf0urSNaazppUjWms6aUjWms6aUjWms6SlI1q6yFI1pqC1I1prOhSNausLq1I1pqamlI1qys6ao1prOgjemsaaK3prGmiRvTWF0G9IzqylI0Jpq1FW1AF0QVIpqBSNDOrpSKJsFIoAQNE0RdNTQWLKusqIqysgNKxKurUi6us6FWNDIVI0JpoKAouiCCiaaUXTUFRdJUAa1YzpuBHikAc5x0UAUAAAAAAAAAAAAAAAAACpQApQBatAAFiANAKgAAACyBAQAVAUxaIsUKEaZWCaoChFQ0qRQFQWEVU0NFioLKgDQmqtRdIirU1YqBUUTV1RVZXVqRrVjJqo1qsxVFE1RFlVkWpGjU1QURYqLqsrAVZWdVpFENKka01NBGjWdWVrEaVk1rEa1WdNWo0us6atGtNTQSNDK6pGtNZ00SNasrJqpG5TWdJVqRvTWdNWpGxnV0pF1ZWdVakalXWNNWpG9WViVdWkbla1zWVajasSrKtSNasrOqtZjcq6xF1akb1ZXOVqVqpG9JWZVWsxvVlYlFqR0lWVzlalWpG5WtYlVrNZjcqyuerq1I6Sq5yrq1I6aaxq6tSOkqzpzXVrMdNNc1lXNSN61Kxpq0jerrEqrWY1q6wurSN6v9Oerq1I6TpZ05yrKUjerrnq6tSOmmsaatSOmmuetatSN6azKatSN6axqlSN6axKulI3prGrq1I3/RrGppSOmmsaurSN6MRdEjQxq6DemsauqNaazpKUjWms6ulSNaazppSNausLq0jQzq6VI0rGrKtI0JpoimpppRrRNFqRRNFpGjWS1KRdVjV0pGhldWkU1NNEjWrrItI1KusaaVI6aaxpq0jpqaxq6VGl1klKNaus6FI0Mi0jWrrAVI1ohpSKJqwF0+ILRVZCpF0QKNGsrpRqDIpGhNNEXcNqALKIugAANMgRoTUWpGhldKR4sA506IAKAAAAAAACAAAApQAKABQAQAAXEWUDAUGVhUBoZaUAFAJFwRFgBRUVUUTVAAABoSpFBoAAWCKVlcVJVUDQEURYqACiyqysEa1AUXQgqaq6gIqys6rWGtSrrOmqzGhAI1qxnV0opoCLpqEaSNRWV1Uais6BGhnTVSNGpqKNKzqqiqzq60kU1AqRrTWVWjWrrBpUjemsi0jWrrC6VI3Kaxq6tSNjOi0jS6yRUjUXWTSpGtXWNXVpGtXWGtWpF1dZFqRuVdYlUqRrWpXPWpWs1I3qysSqtSN6usaurUjemsyrFrMblXWNXWqkb01jWpVqRrVlZVc1mNytSuTUq1Nx00YlWVakb01mVdWpGpVlYXVqR0lXXOVqVazuNms6atSNyrrGmtVI6SmsSrpSNyrrGqtSN6axqrUjTUrBq1G9XWNXSpGtXWNXVo1q6xq6tSNy/6f0xpq0jpKuucq/0VI3prGrpSN6axq7/q1I1prOmrUjcq656spTcbGdNWpG9NZ00qRrV1jTSka1dY1dKRo1nTVpG9NY1dKkblXWNFpG9GNNKkbGdJSkb01jV1aka2ms6aUa1dZ0WkaNTTSka1NZ00pG9NZ00pGtXWNUqRdXWTVpGtXWNXVSNLrC6UjWms6ulSNGsrq0jWjOqMxrVlY1dCNausf0apGhNNUikoAqsrKIspazoEaGdXQXV1kCNCJpUjQzq6opE1QWU1BaiqyulI1qamoVGtVjWpQUNCgCao8YAc6dDAAAFoAAAFAAoAFAAw0AVAAAXDAQXDAQXDAPhDFAAIACgAAuoKKIpEAWKguAlABQIAkVWV0FEVQNARRF1SLqsio0JqrUNVBUUAFisroigKLpEWVUagiwqAC0XVSKIAKjUVjWpVRRNVRZVZ01UiiaKRdNQBrTWTVRsZ0WkaWVnV0qRdNQVI1q6wulI0M6q1FVk0pGtVkWpGhlWqNasrGqVI1q6wuqka1ZWNWUpGtVjV1aka1dY1dKka01mVVpGtWViKrMbViVqVai61KyNVI3qsSrq1I3prMq6tSNyrK5rKtSOmkrMqrWY1Kus6LUjcq6wurUjaysSrKtSNa1KxpK1UjpLjWuUqylSOi6xpq1I3q6xq6tSN6uucq6tSN6srC6tSOkq65a1KtSOkpKxq61UjemsaulSN6axq6tSNyms6WlI3q65yrq1I3q656urUjejOmlSNausaatI3q6xKulG9NY01akbNY1dWkb/o1jTSkdNXXPTSpHTTWNTSkdNNYlNWkb1dc9XSpG9WVz1ZSkb1dc9XVqct6axq6VI3prGrq0jWrrGrpUjQzpq0jWrrGmlSN6axppSN6M6atGzWdNKNjO0lEb0QVI0MraUimsrKtI1prOqI1prJqkb01nVVI1prFqylSKqaBGjU01aka01k3Ab01klBrTUFGhldKka0Z00FtE1VQABdNQCLq6zaFSLohpSNKzopGhNNEi6v9MARvVYXQeNAOfOhUASFAAAEAAAAAAAAABpBUAaEigAAAAAAAKAAAALhhKKgAiAC0UlQUaE1dQAAAFBUII0ILRQADQVFEkURYqaqpFENBQFqC/8AqLqmqEFRZTUBGhlZVpF1UCo1ozq6pGhnTWka01nVVF1dYXQaVkVGtNZ1dKNDK6pFE1YENXUFRqU1k0RrVZlX9WkVdTQqLqsipGl1nUWkb0Z01SNCaaVGhBakaGQpG9NZ1dWpGousLoRpdZlNVI1FZ1ZVzWY1pKgqRuVdc9alaqRsZlXVRqVdYVajZrEta0I1GpWJVlWsxvRnVaqRrTWdXVSNLKwurUjerrEq6tSNyrKwatZjpKuuerq0jpprMpq1I3qysLq1I3KuuerpUjerKxq6tSN6uuerKtSOmrK56urUjemsaurSN6axq6tSN6axF0qRvTWdNWkbXWNJVqRvRnTSpG9NZ1NKR0lNY01akbXWNNKRvTWNXVqRrV1jTSkb0Z0Kka1dZ01aNSr/AExpq0b01nTSpG9NY1dWkb01j+l0pGtXWNXSpGtWVjTSkb1dY0lWpG9NZ0KRrRNNWpGjWdXSka0Z01akb01ldKkalP6ZFqRvTWNXSjemsyrq0a0jOrpUjWms6urSNGs6LUjQysCNSruMhUjUqsGrUjYzqylIq6zq6qNGsrpSNSjOmrUaGV0SKAtBdZ00pGtRAIoQBdVlYRFAKGqhFIoGqgsTQo8bAc+dAAigKggoigYYCCDQFZIuGC1QBEwxRRMMUUTBQAAAWUBBQRBRaVBQpUwxQKYACwsRqCJiNJQQBaAuGAasMEABQAVCVUAVUgCrEVamgAgAouqyGDS6zqqiiautILEFo0Jq6IAgLq6yKjQmioumoA0ayKRrVZVUVdZ01ajSsgRo1JVBdVk1oa1WdJRGhNNKKAqGrKgI1q6wqkaE00qRRNNUUTTQa1ZWNVaka01ldKRrRnV1ajRqQWka1dZNWpGyVldVI1Kusyrq1mNDOrpUjWrKxqtVI1qys6FSNyrrCyrUja6xq6tG5VlYlXVqbjcq6watSNrKzKatZjZrOrq1I1q6wq1I1qysaurUja6xKq1G9JWNVaN6usGrUjerKzKatSN6azpq1I3K1rmLUjpprEqlSNms6atI3KusaatSN6rEq6VI0usaatSN6axppSN6usaatI3q6xq6UjemsapUjWms6atSNaammlI1KusLq0jemsaulSNausaSrUjYzpKUjems6atSNarGrq0jWms6FSNyms6atG9NY00o3prGrpUb01nTQjeqxqrUa1dY1dCNyqxKbFqbjZrGrq1Iqs6soRTU01UjWrrIVI3KazotG9XWJVEb0Y1dWkaElNEXRlZVGoJoVGl1mU1qo1ptQQjWmsxSo1oyq0a01nSVUa01ApF0QhSNGs6sKRoTTVZjUVnTQaTU0CLKrK6CkTTVqPHVwHwD78AAAAAAABRBIKqCCiAKAAAuAAoAAAAGgCiRdEgAIAKAACoAsqsrAULU0FE1QAAAAAAoAqLogDQmijWiGiRQFQAWAAouqyKkblGdNUaE0VF01AFENEjUpqC0a0ZFRoSVQgaAi6rItI0amkEjWiC4KrOqqLqsrFGpRDSkaNTRajQkppSKAtSC6mhRfggCqysVFioFIommqihoC6usrKtSLKqGrUVdTRUjRrK6tRrVZ0KRpZWdFqRvVYVaka1ZWdItSN6usSrq1mNyrKwsq0jcq6561KqRuGs6urUjRqCpGtNZi6VI1KusLq1I2srnqyrUjerrJq1I3Kaxq6tI2usSrq1I3Kuuerq1G9XWNWVaka1dZ01akb01kWpGtXWNXSka1ZWJTVqRvV1jTSkb1ZWJV1akaIzq6VI1prOmrSNa1K56aVI6af0xppSN/wBH9MaatI6f0f0xppUjpprnq6tI3q656uhG1Y1dKka01nTVpG9GdNKka1qVjTVqbjerrBpSNWmsaurSNaus6aVI3prCrUjWrrGrKtI3KusSqVG9TWdNWpG9XWNXSka1WNXSo1qsLq1I3prOmrSNarOkpUjekrOqtSNarGmrUjWqxqwGtXWdVUjUq6wsqpGtGV1UVdTQqNGsauqRrRlZQiyqgJGlY1dWjQzqgoaKCs6sojQmmiKCAsq6yqhoAPIAg+BfegAAAAAAAAAC/iNJohiiCCgIoAANAAAKaCCgIKAQATQAQAAAAAAAAWVFmAoCgAsQAUWYrMaBMRpAQKAqooBqGtIogoumoCNaIAogtFE34aqRrTUAaE00qKqCkUBUACi6usijQmroACsrogo0MxdBdXUCoq6yRaNausgjWrrC6DWjOqpFE1dKi6rJpRoQ1aka0QUiqmioogEXV1BUi6usgNaazqrUa1dZ01aRoTV0qLqys6LUjekrMqrUjejMqyqirqaLUjUqsyqqRolZNWpHTV/pz1dKkb1dYlXVpG9NY1dWpG5TWZV1ajWjKxakalxdZXVqNaazpqpG5V1jTSpGzWZVWpGtXWF1aRr+l/pjSLUjpKusGrUb1djGmrSNq56uiRs1n+l1aRrTWZVKkXV1ldWpGtNZ00pGtNZFqRrTWQpG9XWNNKRvTWNXVqRrV1jV0pGtXWF1aka1WQqRrV1nSVaRpdY1dKja6xKao3qaxq6UjejMppSN6azpq1I2usaurUi6srOqqRrV1hZSpGl1jV0qRrVZ0Wka1WdItRvTWNWUpGtXWdFSN6azKq1GousaulI0JqylRZVZFSNLrOmqkXVlQWkalalY1YZrO41oiyrUiiaKNaISrUjRazpqkVdQEaJWV0GtGI1KCgAurKyq0iiaogqCimoCR5DFQj4J94oAAAAAAAAAEaSKmgAgAAAAiguAAqAAgAAaAq6ICLpqBBRAFEAURQAVYBgEFEFF0QqiiAkUQBRAFAUDU1QAFABaKIQRpFBARQAADQUUSKqRdEFRo1IA1ogEUTVVAAoLqCjQhKIoCouiAKagUXVZAjRqaKjQgUa01nTVGxmLoLq6yatRpdZFI1qsykokaE01aka0lQKRRBaNCaqpBYgIurrJpRsZlVakWVpk1Ua1YyLUjasasq1I1qysasqpG9NZlXVqRoZXQi6srOqtZjUqys6ao6GsyrKqRrTWVVGpV1jTVqR001jVlWkaEBI0srGmqkbXWZTVqRrVlZ0KRrVlZlNWpG9NZFqRrV1jV1aRrV1jTSpHTV1zlXVqbjems6FSN6ayatI3prGmlI2MaulGtNZ1dWo1prOqUirrJpSNausaq1I1q6wLUjemsLpSN6axq6JG9NZ0WkaXWdNKkaVnRUjWmpppRrV1klWo3q6xq6tI1q6xqlSNarGrq1I1Kus6q1I1q6zqKkb0YWUpG9NZ1VRqVWZTVRq0lZ1Yo3KrEalEa1dZ01UjWjKqkaNTRUaGVlEala1iLqpGhNXRATVUXRDSpGl1nTVouiKoohKVI1q6yFRuDOrqimpoC6srKyg0Mrq1HkWCj4SPuwBIAAAAAAAALFSKyAAAAAAAC4ACoAAAAACAAACgAAAAAtA0FFEWVIACAAtABQVAFEBIpagEFQVV1WV1UUAgAALqC1F1WQI0JFEAFBUFFENEihotIuqyFRoZXQU1NNBoQUiiLFRdXWQGhlQUTUBoQlEigBCLqC1F1WVlEirrKqKrJq0aGdXQaGdNUa01NNKjWrrGrqkbGNWCNaSsi0b0Z1VSNIilRSVFUirrOqIurrK6tSLqyoKjWms6ulSNaayurSNSrrJKtSN6usK1UjYzKulSNQ1nVWpGtXWNNWpG9XWNXVqNkY1ZQb1dYlWVajWqzq6qKus6atI1prOqVIqysikb1dc5VWpG9NZlXSpFVk1aNLrOmlRrV1jRakb01kKRrTWQpGzWTVqRvTWdNKRvSVk1akb1dY01akb01jV0pGtXWNNKN6azpKtGtXWdCpGtXWQpG9JWdFqRvSVmU1akb01mVdWpGjWQqRvSVjVlWkb1dYXSpGtWViVdWkbWViVdVI0rGmlSN6rEqyqkaWVk1Ujemsa1KVI1ozqyrUjWqzotI1rUrItZbNZ1YtRrV1jVWpGjWVikalWXWTVqRvTWdXSka0lZ1VqRtNZ1ZSpGhIatRYupoEaEiqgagCrGVBojOrv1UaTUCkalNZCkeTgPhn3IAAAAAAAQCCwRQGYUAIUAWFAFhQAgAEQAAAAAAAAAAAAAAAAAAAWgAoohqQUNAACgAoAABaaoAKguoFGpRldUUBIACi6ICRoTQRQFAAABQlXUAUQlCKAJBdQUaGV0RdNTVUiiAkUTV0AAFNQKNaMrFFDQQAEWVWRaRVZFI0JoVIuqgtFE1QVWRaNausyqqKIaEaWVkWo1q6zKokVWRSNaus6FSNCasqouqyurUiyqgqKusqtIurrII3qysRdWpG9GdNVI3prOrFqRoTVWpBYgtSNSqxq6tSNausymlI1q6xpq0b1ZWNWVajems6aI0rGrq0b01jV0qRoZ1dUjWmshUjWms6q0jWjKlSNaazq6DUqsaurUjQzppUjQmmrRV1NCi6usi1I0azppSN6srEXVSNaazoUjWrKwpRuU1k1Ujems6sq0XVlZ0Kkb01nTVqRs1nV1akb01iVdKkbGZV1akalWMaurRrV1mVSpFWVldWka1dYXVqRpdZlWKkaWVhVqRslYlWUqRvV1jVlarMbE00SLqyoKjUqsSqpGljOmlSNLrK6qNCRVF1WQqRvTWdFSNQQlWpGpV1i00pG1jMqiRdNTRSLpqARqLrGrq1I1oiwo8nAfDvuAAAAAAAABqMxo1NAEQAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGgNAF0QIKEoAWlqLgAKC6gCiLoQAEU1Ao0IaooBQAA1UBGhnV0RQFoAFABQNAFElXQACpABaLogI0MroKamqUXRApFEAiiauqkUQKLq6yFGhldVIomqtIsogqNCaaEa1NRVSKIaDWqzotGhNVQ1rWQSNGoKjQiwBdQEaNTRakalXWVVF1WV1UjUENWoqyoKkaGVlUVZUBGtNSCpGtXWVi1IsVkUaWVmKVIogqKupoo1prK6qRrRAqNGs6uqNaazqiRrTWVWjWjIUa01ldKi6us6apGhnVCKqQEXaushRvTWF1akaVmVdKRdXWdTVqRvRnTSpGl1nRaRrTWdXSpGtNZNWkb1ZWJVKka01k1aNyrrnrUpSNjOrKqRVlQWpGtXWNJVqRvVYWXFqRtZWdhpUjejC6tRvV1jV1ajUq6zKurRqVdYXRI0rGtRrEXVZNVNblWViVRI3KusSrq1mNKzKLUjWrrMpq0a3F1iKVI3KusRdWpG9NZXVpGpRDRFVnVUaGV1UirrOqJFXWYatSN6jMUpFlVldKRdXWTVR5WA+IfbgAAAAAAALFAZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFgALAAAAAAAAAAUAFAAAABZUAUTVEgAKpqAkXV1kBoZCjQkqqCxARoTTRFAAAWgAAAoauoIKIKKIaJFDQBdQEVWV0FE1VoAFDVQCKIKRRNXVRdNQBrRldWpFXWdXQiqyLUaJU0VI0IA1qs6LUjRqaoiiLqjWjK6CrEFRoSGqka01BUirrMqrUalVhZQjQmmrUa1WdFqNCaatGtNSAkaNSKqLpqCka01lVSNEZXSo1prOqpGhnV0qLpqaatRpdYXQjWms6qourrIUaGTVo1pqaaUjQzpoka1dZ0lWka01NCpGjWQo1q6wuqNaJpoRrTWdWCRdWVkWkbNZ00qRrVY1dUjWkrOrpUjQhq1I1prOqEalWVhdWpG9XWNNWo6aaxq6tI2MrKVI1KMrqpGtalYXVrMaXWZVVI0Ss6q1I1qsSrKuakalalYNxajpoxsWVUjcWVjV1aka1ZWdUqNRdZlXVqRrU1JVUjQzKq1I0usLCpGpV1kWpG9WMStKjRGdNUa1YypUihBQXUBGiMrq0jRrMURdGdUI8tAfFPtQAAAABYCxFgigIgAAAAAAAAAAAAAAAoALAAQAAACAAQACAAoAAAAAAAAAAALFgAiAC0AFAAAAAADV1AFCAAAAAguoA1oyspRQ0UWU1ASNDJoRoSU0RRNAUBQAQAAAANVBakUTTQihooumoCNDIDQyKNCaqguoFFEBIokqqLqsi1GhJVVF1WVlKKSiKkaEWUoukQEalVBaiqzKqi6usio3ozKqo0RlZQ1oQVGorMFqNLrOmqRoSU0qKsqC0jWjKrUiqguajRGV/AjQzKuqkUTTVqRrTWdXQVWVlKimgouiBSKICRRNNBrTU0BrTWRakaXWdNKRrVZFqNDK6ourrOmhGtGdUSLpqCjUq6zoUaWMaulRoTV1SKamppUjcq6xKulSNKzq6tF1WVWpF0QWka1ZWdJVrMb1dY1rVRpdZ1dBrTWVlVI0us6LUjUrUrnK1q5qbjSxmVdVlrRnVi4kVYgqNwZ1ZSpG4MrqpGtWViVVqNyms6qka0lZilSNarErS1I1pKzKq1I1q6wsWo0sZirRvTWZVVlpYzDVGtQEAlAGtGYrSCyoFHl4D4t9mAKACgACxUipqaAIgAAAAAAAAAAAuAAoAAAAAAAAAAAAAAAAAAAAAAAAALigCqAAAJEgAiAC0AAAEABaBoKKIaChoAAEABILqALqshRoTV1aAAAABoJUAANXUCkVWV1aQVNBFAAAAlVAIogtSKIKRQ0CLogpBZUBGhNVaEqoKRV1BajQi6VIEARVZXVFNSKIqysyqqNEqaaqNCaqgsQVI0IaI1KIKRo1nVVFisrAahqaa0jRrOtCLohqjUNTQI0MrqpFE00GtJUFxIomrqkWVWYoirqaCRoZ01SNDK6CiaaVFAUhFQEiiKCmomg3ozotSNCGlIommlI1prOqtRolZXSka0Z1VqRV1k0I1prOqDRrKxajWrKyFI3oxpq1I3prOrq1I1FZWUSLKsrKrSNSrKzotZjpKaxKu6pGtWVmUVG9VmLKVIurKyrSRqVqMRZVrOtms6Rakb0ZWKjUq6zpq1I3KsrC6tSNkZlaVFWJARdWMrFGpV1nVlKkaEhq1lqLrKxpFisrAa01BRqVdZCpF1WdJVI1pqAjUXWYoPMAHx77IAAAABYCgMsgAAAAAAAAAACgAoAAAAAAAAAAAAAAAAAAAAAAAAAC4ACgCgAoAAAIABEAEQAAAAAKACgSgoohqCgKAAAAAAkFlQBrRlQUTTQUAAAAAAABZUBGhk1aRQP/AKIomgKAoAAsEFFEWFABUiyqysqoqyoFFCUVFlVlZQUBUFQEaEiqiyiKosVldVlqU1nVUURQVYyKjRE1VRSVNDEjQmjQsq6gqNarMBGiJppRrRnV1RRNXVKsqsrKIommqKACymoCRoZXQixdZ1VRRDRIqs6aEbGdWVaKJqlQE0UiiaoGmgENVAIpqAkXV1kCNSqzKurUirrOi0jWmsyqDWmsrKVG5TWF1UjWqzqygpqaq1FiysmrSNjOtQqRVZXVqRrTWdVakalalc5WpVRqLrOmqkbixjWouI0us6arMaWVnVVI1KrOmrUjSsyqqRpYzpqo2sYlWVc1mN6srMWKRrRBUVYgI1qsxVRpdY1VqRrWoxFVI0MyrpRrU0FSKrOqDQmipFXWV1SPMgHx77EAAAAIANAMsgAAAAAAAAAAC4ACgAAAAAAAAAAAAAAAAAAAAAAAAANAAAAADQAAAAAIACCCgkBAIoAgAAAAAoGgosENQUNFAAABAAAAAAKLpqARrRkVI0Jq6AAAAAABoCosogEaRNAi6rI0RoRRCVUAUBQaZBGiJqqiiRSoumoFGhIqpBUFqNESKqKIRRViCo0RIqookqgBoJF1WVlaFWIKiqyqoqsmiNCARVjOmqRsZXVRRNUIuiCpFE1YUU1BRdVkBoZURrRmKCiGhGhNFRTUUDVZUFENEiiauhBUAi6rIqNCaaUUTTSigKRYICNaazqrUaENWka1WSURvVlYVakaVjV0GllZ1dVI2lrOrqpF1qVhZSkbIzKuqzrW/VjJK0kbWVmU0qNLrOrrSNxWJV1ay1pKzrQjSysasq0b0QlVNxpYysVmNStawsqpGpVlZWLmo0T1JVWiqyb9VGorK6JGlZlFqNLGdWKkaisrqoprOrCkaE01ai6IFHmoD5F9gAAAAAAsVIqamgCIAAAAAAAAANAAAAAAAAAAAAAAAAAAAAAAAAAALgAKAAAAALgAAAKADIAAAAAAAAACQACAAgAAAtAABdQUUQSiiauoAaAAAAAAAAApqC0a0ZBI0ayKRrTWQGioq0TVKngKGgC6gqNCaKikoAokq6AAtRYrKwqNaagEVZUgqNCRVSCoRcRVQUWKixUI0ysE1TQWoohFFAUWVWV1WVAWgAJFnqsroKIq0IqLBABUXTUCjQyqi6srOkokaEAUTV1aC6gVFisijQkNBQ0EAChq6gUXTUAaGV0F1WdVaKIaEUTVEgsqGg0MrKtRQFIaqGlSKsqQKNausLq1I1qsasqo1FZ1ZVo1qsrCosqoKkalXWNWVakalaYlai1FJU1VSK1GYKy3ohFqNSrKyKkbisyqqNRYysWmtLqGqy0azKpUbhrMqtI1rUrEWUqNarK6qNQSLFQXUFRqLKwurSOmozKokahE0XBrVZhqpGjWQR5uA+SfXgAAAAAEaBNTQBEAAAAAAAFABQAAAAAAAAAAAAAAAAAAAAAAAAAGgAAAAAAAAAABQAQAAAAAAAAAAAAABNABAAAAABQAQAAAADQBdAAAAAAAAAAAXAAUABF0AwRZQUUAABcF0BWVABQAABGgDEFBTRZQaxFAE0jQKiKCpqgKLFAZAFBYChAFNFgDKgLgAKaNAIAAsoCoAKgAYAC6KoAAAGgIaaALAFwFBQigMgAAAAAAALFAAAF1AUWAALoCaRQEFgNYhUAFAXBqG/QVFlaAQAXBYoCLF0FxnVWA0imgqLCUFxGjQMZWNb8BpNWVQUWUAZWNQGk0WUFxNVYAiykoKjUWUFQNBcTVgALFBoGgE0P0BFAUf//Z)', backgroundSize: 'cover', backgroundPosition: 'center' }}>
        <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full">
          <Calendar className="w-16 h-16 mx-auto text-indigo-600 mb-4" />
          <h1 className="text-3xl font-bold text-center mb-6">KapazitÃ¤tsplaner V5</h1>
          <div className="space-y-3">
            {users.map(u => (
              <button key={u.id} onClick={() => { setCurrentUser(u); setShowLogin(false); setShowDashboard(u.teamRole === 'lead' || u.teamRole === 'department_head' || u.teamRole === 'entrepreneur'); }} 
                className="w-full p-4 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-2xl hover:shadow-xl transition-shadow">
                {u.name} {u.teamRole === 'lead' && '(FÃ¼hrungskraft)'} {u.teamRole === 'department_head' && '(Bereichsleitung)'} {u.teamRole === 'entrepreneur' && '(Unternehmer)'}
              </button>
            ))}
          </div>
        </div>
      </div>
    );
  }

  if (showDashboard && (currentUser.teamRole === 'lead' || currentUser.teamRole === 'department_head' || currentUser.teamRole === 'entrepreneur' || currentUser.role === 'admin')) {
    return <div className={darkMode ? 'dark' : ''}><TeamDashboard /></div>;
  }

  // Projekt-Dashboard - FÃœR ALLE zugÃ¤nglich
  if (showProjectDashboard) {
    const ProjectDashboard = () => {
      // Helper-Funktionen
      const openSettings = () => {
        setShowSettings(true);
      };
      
      // Filter speichern - SOFORT State updaten, im Hintergrund speichern
      const updateFilter = (filterName, value) => {
        const newFilters = {...projectDashboardFilters, [filterName]: value};
        setProjectDashboardFilters(newFilters);
        // Im Hintergrund speichern ohne zu warten
        const key = `project-filters-${currentUser.id}`;
        window.storage.set(key, JSON.stringify(newFilters), true).catch(() => {});
      };
      
      // Berechne Stunden pro Projekt, gruppiert nach Department
      const calculateProjectHoursByDivision = (projectId, filters, project) => {
        const divisionHours = {};
        let totalHours = 0;
        
        // IST-Stunden berechnen
        tasks.forEach(t => {
          if (t.projectId === projectId) {
            const user = users.find(u => u.id === t.userId);
            if (!user) return;
            
            const team = teams.find(tm => tm.id === user?.teamId);
            const division = team ? divisions.find(d => d.id === team.divisionId) : null;
            const dept = division ? departments.find(d => d.id === division.departmentId) : null;
            
            // Filter anwenden
            if (filters.department !== 'all' && dept?.id !== filters.department) return;
            if (filters.division && filters.division !== 'all' && division?.id !== filters.division) return;
            if (filters.team !== 'all' && team?.id !== filters.team) return;
            if (filters.user !== 'all' && user?.id !== filters.user) return;
            
            const divName = division?.name || 'Ohne Abteilung';
            const divId = division?.id || 'none';
            const deptName = dept?.name || '';
            
            const netHours = calculateNetHours(t.startHour, t.endHour, t.startDate, t.endDate, t.userId);
            
            if (!divisionHours[divId]) {
              divisionHours[divId] = { 
                name: divName,
                departmentName: deptName,
                actualHours: 0,
                plannedHours: 0
              };
            }
            divisionHours[divId].actualHours += netHours.net;
            totalHours += netHours.net;
          }
        });
        
        // SOLL-Stunden aus projectPhases holen (Phasen basieren auf divisions!)
        projectPhases.forEach(phase => {
          if (phase.projectId === projectId && phase.hoursNeeded > 0) {
            const divId = phase.divisionId;
            const division = divisions.find(d => d.id === divId);
            const dept = division ? departments.find(d => d.id === division.departmentId) : null;
            
            if (!divisionHours[divId]) {
              divisionHours[divId] = {
                name: phase.divisionName || division?.name || 'Unbekannt',
                departmentName: dept?.name || '',
                actualHours: 0,
                plannedHours: 0
              };
            }
            divisionHours[divId].plannedHours += phase.hoursNeeded;
          }
        });
        
        return { divisionHours, totalHours };
      };
      
      // Filtern nach Projekt-Name UND Bereich
      const filteredProjects = projects.filter(p => {
        // Projekt-Name Filter
        if (!p.name.toLowerCase().includes(projectDashboardFilters.projectSearch.toLowerCase())) {
          return false;
        }
        
        // Bereich Filter: Nur Projekte zeigen die fÃ¼r den gewÃ¤hlten Bereich Stunden haben
        if (projectDashboardFilters.department !== 'all') {
          const deptHours = (p.departmentHours || {})[projectDashboardFilters.department] || 0;
          // PrÃ¼fe auch ob IST-Stunden fÃ¼r diesen Bereich existieren
          let hasActualHours = false;
          tasks.forEach(t => {
            if (t.projectId === p.id) {
              const user = users.find(u => u.id === t.userId);
              const team = teams.find(tm => tm.id === user?.teamId);
              const division = team ? divisions.find(d => d.id === team.divisionId) : null;
              const dept = division ? departments.find(d => d.id === division.departmentId) : null;
              if (dept?.id === projectDashboardFilters.department) {
                hasActualHours = true;
              }
            }
          });
          
          if (deptHours === 0 && !hasActualHours) {
            return false;
          }
        }
        
        // Abteilung Filter (NEU)
        if (projectDashboardFilters.division && projectDashboardFilters.division !== 'all') {
          let hasHoursInDivision = false;
          tasks.forEach(t => {
            if (t.projectId === p.id) {
              const user = users.find(u => u.id === t.userId);
              const team = teams.find(tm => tm.id === user?.teamId);
              if (team?.divisionId === projectDashboardFilters.division) {
                hasHoursInDivision = true;
              }
            }
          });
          if (!hasHoursInDivision) return false;
        }
        
        // Team Filter
        if (projectDashboardFilters.team !== 'all') {
          let hasHoursInTeam = false;
          tasks.forEach(t => {
            if (t.projectId === p.id) {
              const user = users.find(u => u.id === t.userId);
              if (user?.teamId === projectDashboardFilters.team) {
                hasHoursInTeam = true;
              }
            }
          });
          if (!hasHoursInTeam) return false;
        }
        
        return true;
      });
      
      return (
        <>
          <div className="dm-root min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50">
          <div className="dm-header bg-white shadow-lg sticky top-0 z-10">
            <div className="max-w-full mx-auto px-6 py-4">
              {/* Header mit Navigation */}
              <div className="flex justify-between items-center mb-4">
                <div className="flex items-center gap-3">
                  <span className="text-3xl">ðŸ“Š</span>
                  <h1 className="text-lg font-bold">Projekt-Dashboard - StundenÃ¼bersicht nach Bereichen</h1>
                  {lastSync && <span className="text-[9px] text-gray-400 flex items-center gap-1" title={`Letzter Sync: ${lastSync.toLocaleTimeString()}\nSession: ${sessionId.slice(-4)}\nDein Tier: ${myAnimalEmoji}`}><span className="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse" />{myAnimalEmoji}</span>}
                  {onlineUsers.length > 0 && (
                    <div className="flex items-center gap-1 ml-1">
                      {onlineUsers.map(p => {
                        const viewLabel = p.view === 'grobplanung' ? 'ðŸ“‹ Schnellplanung' : p.view === 'teamdashboard' ? 'ðŸ“Š Team DB' : p.view === 'projektplanung' ? 'ðŸ“ Projektplanung' : p.view === 'ressourcencockpit' ? 'ðŸ‘¥ Ressourcencockpit' : p.view === 'disposition' ? 'ðŸ“‹ Disposition' : p.view;
                        return (
                          <div key={p.sessionId} className="relative group">
                            <div className="w-7 h-7 rounded-full flex items-center justify-center text-white text-[10px] font-bold cursor-default border-2 border-white shadow-sm" style={{ backgroundColor: p.color }} title={`${p.userName} â€” ${viewLabel}`}>
                              <span style={{ fontSize: 16 }}>{p.animal || 'ðŸ¦«'}</span>
                            </div>
                            <span className="absolute -bottom-0.5 -right-0.5 w-2.5 h-2.5 bg-green-400 rounded-full border border-white" />
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>
                
                {/* Navigation Buttons */}
                <div className="nav-bar flex gap-2">
                  {/* Undo/Redo/History Buttons */}
                  <button 
                    onClick={undo} 
                    disabled={undoStack.length === 0}
                    className={`p-3 rounded-2xl ${undoStack.length > 0 ? 'hover:bg-gray-100' : 'opacity-30 cursor-not-allowed'}`}
                    title={`RÃ¼ckgÃ¤ngig (${undoStack.length} verfÃ¼gbar)`}>
                    â†¶
                  </button>
                  <button 
                    onClick={redo} 
                    disabled={redoStack.length === 0}
                    className={`p-3 rounded-2xl ${redoStack.length > 0 ? 'hover:bg-gray-100' : 'opacity-30 cursor-not-allowed'}`}
                    title={`Wiederholen (${redoStack.length} verfÃ¼gbar)`}>
                    â†·
                  </button>
                  <button 
                    onClick={() => setShowHistory(!showHistory)} 
                    className={`p-3 rounded-2xl ${showHistory ? 'bg-blue-100' : 'hover:bg-gray-100'}`}
                    title="Ã„nderungshistorie">
                    ðŸ“œ
                  </button>
                  
                  {/* Navigation */}
                  <button 
                    onClick={() => { setShowDashboard(false); setShowProjectDashboard(false); setShowProjectPlanning(false); setShowResourceCockpit(false); setShowDisposition(false); }} 
                    className="px-3 py-1.5 rounded-2xl text-sm bg-gray-100 hover:bg-gray-200"
                  >
                    <Calendar className="w-4 h-4 inline mr-2" />Schnellplanung
                  </button>
                  <button 
                    onClick={() => { setShowDashboard(true); setShowProjectDashboard(false); setShowProjectPlanning(false); setShowResourceCockpit(false); setShowDisposition(false); }} 
                    className="px-3 py-1.5 rounded-2xl text-sm bg-gray-100 hover:bg-gray-200"
                  >
                    <BarChart3 className="w-4 h-4 inline mr-2" />Team Dashboard
                  </button>
                  <button 
                    className="px-3 py-1.5 rounded-2xl text-sm bg-blue-600 text-white"
                  >
                    <BarChart3 className="w-4 h-4 inline mr-2" />Projekt Dashboard
                  </button>
                  <button 
                    onClick={() => { setShowDashboard(false); setShowProjectDashboard(false); setShowProjectPlanning(true); setShowResourceCockpit(false); setShowDisposition(false); }} 
                    className="px-3 py-1.5 rounded-2xl text-sm bg-gray-100 hover:bg-gray-200"
                  >
                    ðŸ—ï¸ Projektplanung
                  </button>
                  <button 
                    onClick={() => { setShowDashboard(false); setShowProjectDashboard(false); setShowProjectPlanning(false); setShowResourceCockpit(true); setShowDisposition(false); }} 
                    className="px-3 py-1.5 rounded-2xl text-sm bg-gray-100 hover:bg-gray-200"
                  >
                    ðŸ‘¥ Ressourcencockpit
                  </button>
                  <button 
                    onClick={() => { setShowDashboard(false); setShowProjectDashboard(false); setShowProjectPlanning(false); setShowResourceCockpit(false); setShowDisposition(true); }} 
                    className="px-3 py-1.5 rounded-2xl text-sm bg-gray-100 hover:bg-gray-200"
                  >
                    ðŸ“‹ Disposition
                  </button>
                  {currentUser.role === 'admin' && (
                    <button onClick={() => setShowAdmin(true)} className="px-3 py-1.5 bg-purple-600 text-white rounded-2xl text-sm">
                      Admin
                    </button>
                  )}
                  <button onClick={() => setDarkMode(d => !d)} className={`p-3 rounded-2xl ${darkMode ? 'bg-indigo-600 text-yellow-200' : 'hover:bg-gray-100'}`} title={darkMode ? 'Light Mode' : 'Dark Mode'}>
                    {darkMode ? 'â˜€ï¸' : 'ðŸŒ™'}
                  </button>
                  <button onClick={openSettings} className="p-3 hover:bg-gray-100 rounded-2xl">
                    <Settings className="w-5 h-5" />
                  </button>
                  <button 
                    onClick={() => { setCurrentUser(null); setSelectedUser(null); setShowLogin(true); setShowProjectDashboard(false); }} 
                    className="px-3 py-1.5 bg-gray-100 rounded-2xl text-sm"
                  >
                    <LogOut className="w-4 h-4 inline mr-2" />Abmelden
                  </button>
                </div>
              </div>
              
              {/* Filter */}
              <div className="grid grid-cols-1 md:grid-cols-5 gap-3 pb-4 border-b">
                {/* Bereich Filter */}
                <div>
                  <label className="text-xs font-semibold text-gray-600 mb-1 block">Bereich</label>
                  <select 
                    value={projectDashboardFilters.department}
                    onChange={(e) => updateFilter('department', e.target.value)}
                    className="w-full p-2 border rounded-lg text-sm"
                  >
                    <option value="all">Alle Bereiche</option>
                    {departments.sort((a, b) => a.name.localeCompare(b.name)).map(d => (
                      <option key={d.id} value={d.id}>{d.name}</option>
                    ))}
                  </select>
                </div>
                
                {/* Abteilung Filter (NEU) */}
                <div>
                  <label className="text-xs font-semibold text-gray-600 mb-1 block">Abteilung</label>
                  <select 
                    value={projectDashboardFilters.division || 'all'}
                    onChange={(e) => updateFilter('division', e.target.value)}
                    className="w-full p-2 border rounded-lg text-sm"
                  >
                    <option value="all">Alle Abteilungen</option>
                    {divisions.sort((a, b) => a.name.localeCompare(b.name)).map(div => {
                      const dept = departments.find(d => d.id === div.departmentId);
                      return (
                        <option key={div.id} value={div.id}>
                          {div.name}{dept ? ` (${dept.name})` : ''}
                        </option>
                      );
                    })}
                  </select>
                </div>
                
                {/* Team Filter */}
                <div>
                  <label className="text-xs font-semibold text-gray-600 mb-1 block">Team</label>
                  <select 
                    value={projectDashboardFilters.team}
                    onChange={(e) => updateFilter('team', e.target.value)}
                    className="w-full p-2 border rounded-lg text-sm"
                  >
                    <option value="all">Alle Teams</option>
                    {teams.sort((a, b) => a.name.localeCompare(b.name)).map(t => {
                      const div = divisions.find(d => d.id === t.divisionId);
                      const dept = div ? departments.find(d => d.id === div.departmentId) : null;
                      return (
                        <option key={t.id} value={t.id}>
                          {t.name}{div ? ` (${div.name})` : ''}{dept ? ` â€¢ ${dept.name}` : ''}
                        </option>
                      );
                    })}
                  </select>
                </div>
                
                {/* Mitglied Filter */}
                <div>
                  <label className="text-xs font-semibold text-gray-600 mb-1 block">Mitglied</label>
                  <select 
                    value={projectDashboardFilters.user}
                    onChange={(e) => updateFilter('user', e.target.value)}
                    className="w-full p-2 border rounded-lg text-sm"
                  >
                    <option value="all">Alle Mitglieder</option>
                    {users.filter(u => u.role !== 'admin').sort((a, b) => a.name.localeCompare(b.name)).map(u => (
                      <option key={u.id} value={u.id}>{u.name}</option>
                    ))}
                  </select>
                </div>
                
                {/* Projekt Suche */}
                <div>
                  <label className="text-xs font-semibold text-gray-600 mb-1 block">Projekt suchen</label>
                  <input 
                    type="text"
                    value={projectDashboardFilters.projectSearch}
                    onChange={(e) => updateFilter('projectSearch', e.target.value)}
                    placeholder="Projekt eingeben..."
                    className="w-full p-2 border rounded-lg text-sm"
                  />
                </div>
              </div>
              
              {/* Filter Reset */}
              {(projectDashboardFilters.department !== 'all' || 
                projectDashboardFilters.division !== 'all' ||
                projectDashboardFilters.team !== 'all' || 
                projectDashboardFilters.user !== 'all' || 
                projectDashboardFilters.projectSearch !== '') && (
                <div className="pt-2">
                  <button 
                    onClick={() => {
                      const resetFilters = {department: 'all', division: 'all', team: 'all', user: 'all', projectSearch: ''};
                      setProjectDashboardFilters(resetFilters);
                      window.storage.set(`project-filters-${currentUser.id}`, JSON.stringify(resetFilters), true);
                    }}
                    className="text-sm text-indigo-600 hover:text-indigo-800"
                  >
                    âœ• Filter zurÃ¼cksetzen
                  </button>
                </div>
              )}
            </div>
          </div>

          <div className="w-full px-4 py-6">
            <div className="grid grid-cols-1 lg:grid-cols-2 2xl:grid-cols-3 gap-6">
              {filteredProjects.sort((a, b) => a.name.localeCompare(b.name)).map(project => {
                const { divisionHours, totalHours } = calculateProjectHoursByDivision(project.id, projectDashboardFilters, project);
                
                // Nur Abteilungen mit SOLL>0 ODER IST>0 anzeigen
                const divArray = Object.entries(divisionHours)
                  .filter(([id, data]) => data.actualHours > 0 || data.plannedHours > 0)
                  .map(([id, data]) => ({
                    id,
                    name: data.name,
                    departmentName: data.departmentName,
                    actualHours: data.actualHours,
                    plannedHours: data.plannedHours,
                    utilization: data.plannedHours > 0 ? (data.actualHours / data.plannedHours) * 100 : 0,
                    percentage: totalHours > 0 ? (data.actualHours / totalHours) * 100 : 0
                  }))
                  .sort((a, b) => a.name.localeCompare(b.name)); // Alphabetisch!
                
                // Projekt ohne Abteilungen mit Stunden ausblenden
                if (divArray.length === 0) return null;
                
                // Gesamt-SOLL berechnen
                const totalPlannedHours = divArray.reduce((sum, d) => sum + d.plannedHours, 0);
                const totalUtilization = totalPlannedHours > 0 ? (totalHours / totalPlannedHours) * 100 : 0;
                
                return (
                  <div key={project.id} className="bg-white rounded-2xl shadow-lg overflow-hidden border-2 border-gray-100">
                    {/* Projekt Header */}
                    <div className="p-4 border-b" style={{backgroundColor: project.color + '20'}}>
                      <div className="flex items-center gap-3 mb-3">
                        <div 
                          className="w-6 h-6 rounded-full" 
                          style={{backgroundColor: project.color}}
                        />
                        <h3 className="text-lg font-bold text-gray-800 flex-1">{project.name}</h3>
                      </div>
                      
                      {/* Gesamt IST & SOLL */}
                      <div className="grid grid-cols-2 gap-3">
                        <div className="bg-white/50 rounded-lg p-2">
                          <div className="text-xs text-gray-600 mb-1">IST-Stunden</div>
                          <div className="text-2xl font-bold text-gray-700">{totalHours.toFixed(1)}h</div>
                        </div>
                        <div className="bg-white/50 rounded-lg p-2">
                          <div className="text-xs text-gray-600 mb-1">SOLL-Stunden</div>
                          <div className="text-2xl font-bold text-indigo-600">
                            {totalPlannedHours > 0 ? `${totalPlannedHours.toFixed(0)}h` : '-'}
                          </div>
                        </div>
                      </div>
                      
                      {/* Gesamt-Fortschritt (nur wenn SOLL > 0) */}
                      {totalPlannedHours > 0 && (
                        <div className="mt-3">
                          <div className="flex justify-between items-center mb-1">
                            <span className="text-xs text-gray-600">Gesamt-Fortschritt</span>
                            <span className={`text-sm font-bold ${
                              ({ red: 'text-red-600', orange: 'text-orange-600', blue: 'text-yellow-600', green: 'text-green-600' }[pctTier(totalUtilization)])
                            }`}>
                              {Math.round(totalUtilization)}%
                            </span>
                          </div>
                          <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                            <div 
                              className={`h-full transition-all ${
                                ({ red: 'bg-red-500', orange: 'bg-orange-500', blue: 'bg-yellow-500', green: 'bg-green-500' }[pctTier(totalUtilization)])
                              }`}
                              style={{width: `${Math.min(totalUtilization, 100)}%`}}
                            />
                          </div>
                        </div>
                      )}
                      
                      {/* Ãœberplanung Warnung */}
                      {totalPlannedHours > 0 && totalUtilization > 100 && (
                        <div className="mt-2 text-xs text-red-600 bg-red-50 rounded p-2">
                          âš ï¸ Ãœberplant um {(totalHours - totalPlannedHours).toFixed(1)}h ({Math.round(totalUtilization - 100)}%)
                        </div>
                      )}
                    </div>
                    
                    {/* Abteilungen-AufschlÃ¼sselung */}
                    <div className="p-4 space-y-3">
                      <div className="text-xs font-semibold text-gray-600 mb-2">Stunden pro Abteilung:</div>
                      
                      {divArray.map((div, idx) => (
                        <div key={div.id} className="bg-gray-50 rounded-lg p-3 border border-gray-200">
                          <div className="flex justify-between items-start mb-2">
                            <div className="flex-1">
                              <span className="font-semibold text-gray-700">{div.name}</span>
                              {div.departmentName && (
                                <span className="text-xs text-gray-500 ml-2">({div.departmentName})</span>
                              )}
                            </div>
                            <div className="text-right">
                              <div className="flex items-center gap-2">
                                <span className="text-lg font-bold text-gray-700">{div.actualHours.toFixed(1)}h</span>
                                {div.plannedHours > 0 && (
                                  <>
                                    <span className="text-gray-400">/</span>
                                    <span className="text-sm text-indigo-600">{div.plannedHours.toFixed(0)}h</span>
                                  </>
                                )}
                              </div>
                              {div.plannedHours > 0 && (
                                <div className={`text-xs font-semibold ${
                                  ({ red: 'text-red-600', orange: 'text-orange-600', blue: 'text-yellow-600', green: 'text-green-600' }[pctTier(div.utilization)])
                                }`}>
                                  {Math.round(div.utilization)}% Fortschritt
                                </div>
                              )}
                            </div>
                          </div>
                          
                          {/* FÃ¼llstandsbalken (IST vs SOLL wenn vorhanden, sonst Anteil am Gesamt) */}
                          {div.plannedHours > 0 ? (
                            <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                              <div 
                                className={`h-full transition-all ${
                                  ({ red: 'bg-red-500', orange: 'bg-orange-500', blue: 'bg-yellow-500', green: 'bg-green-500' }[pctTier(div.utilization)])
                                }`}
                                style={{width: `${Math.min(div.utilization, 100)}%`}}
                              />
                            </div>
                          ) : (
                            <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                              <div 
                                className={`h-full transition-all ${
                                  idx === 0 ? 'bg-indigo-500' :
                                  idx === 1 ? 'bg-blue-500' :
                                  idx === 2 ? 'bg-cyan-500' :
                                  'bg-teal-500'
                                }`}
                                style={{width: `${div.percentage}%`}}
                                title={`${Math.round(div.percentage)}% Anteil am Gesamt`}
                              />
                            </div>
                          )}
                          
                          {/* Warnung bei Ãœberplanung */}
                          {div.plannedHours > 0 && div.utilization > 100 && (
                            <div className="text-xs text-red-600 mt-1">
                              âš ï¸ +{(div.actualHours - div.plannedHours).toFixed(1)}h Ã¼ber Soll
                            </div>
                          )}
                        </div>
                      ))}
                      
                      {/* Verteilungs-Visualisierung (nur wenn >1 Abteilung) */}
                      {divArray.length > 1 && (
                        <div className="mt-4 pt-4 border-t">
                          <div className="text-xs font-semibold text-gray-500 mb-2 text-center">IST-Verteilung</div>
                          <div className="flex h-4 rounded-full overflow-hidden">
                            {divArray.map((div, idx) => (
                              <div 
                                key={div.id}
                                className={`${
                                  idx === 0 ? 'bg-indigo-500' :
                                  idx === 1 ? 'bg-blue-500' :
                                  idx === 2 ? 'bg-cyan-500' :
                                  'bg-teal-500'
                                }`}
                                style={{width: `${div.percentage}%`}}
                                title={`${div.name}: ${div.actualHours.toFixed(1)}h (${Math.round(div.percentage)}%)`}
                              />
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
            
            {/* Keine Projekte gefunden */}
            {filteredProjects.every(p => {
              const { divisionHours } = calculateProjectHoursByDivision(p.id, projectDashboardFilters, p);
              const hasAnyHours = Object.values(divisionHours).some(d => d.actualHours > 0 || d.plannedHours > 0);
              return !hasAnyHours;
            }) && (
              <div className="text-center py-12">
                <div className="text-6xl mb-4">ðŸ“Š</div>
                <h2 className="text-2xl font-bold text-gray-600 mb-2">
                  {projectDashboardFilters.department !== 'all' || 
                   projectDashboardFilters.division !== 'all' ||
                   projectDashboardFilters.team !== 'all' || 
                   projectDashboardFilters.user !== 'all' || 
                   projectDashboardFilters.projectSearch !== '' 
                    ? 'Keine Projekte gefunden'
                    : 'Noch keine Projekt-Stunden'
                  }
                </h2>
                <p className="text-gray-500">
                  {projectDashboardFilters.department !== 'all' || 
                   projectDashboardFilters.division !== 'all' ||
                   projectDashboardFilters.team !== 'all' || 
                   projectDashboardFilters.user !== 'all' || 
                   projectDashboardFilters.projectSearch !== '' 
                    ? 'Versuche andere Filter-Einstellungen'
                    : 'Erstelle Tasks mit Projektzuordnung oder definiere Soll-Stunden in den Einstellungen'
                  }
                </p>
              </div>
            )}
          </div>
        </div>
        
        </>
      );
    };
    
    return <div className={darkMode ? 'dark' : ''}><ProjectDashboard /></div>;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PROJEKTPLANUNG DASHBOARD - Das neue Feature! ðŸ”¥
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PROJEKTPLANUNG DASHBOARD - Hierarchische Arbeitspakete V11
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  // Globaler Scroll-Speicher - AUSSERHALB von React!
  const _scrollPositions = window._sidebarScrollPositions || (window._sidebarScrollPositions = {});
  
  // Shared Preset Modal renderer â€” used by Disposition and Projektplanung
  const renderPresetModal = () => {
    if (!wlPresetModal) return null;
    const pm = wlPresetModal;
    const toggleUser = (uid) => setWlPresetModal(prev => ({...prev, userIds: prev.userIds.includes(uid) ? prev.userIds.filter(x => x !== uid) : [...prev.userIds, uid]}));
    const toggleRes = (rid) => setWlPresetModal(prev => ({...prev, resourceIds: prev.resourceIds.includes(rid) ? prev.resourceIds.filter(x => x !== rid) : [...prev.resourceIds, rid]}));
    const savePreset = () => {
      if (!pm.name.trim()) return;
      if (pm.id) {
        setWlCustomPresets(prev => prev.map(p => p.id === pm.id ? {...pm} : p));
        if (wlActivePreset === pm.id) setWlActivePreset(pm.id);
      } else {
        const newPreset = {...pm, id: 'preset_' + Date.now()};
        setWlCustomPresets(prev => [...prev, newPreset]);
        setWlActivePreset(newPreset.id);
        setWorkloadFilter('ma_ressourcen');
      }
      setWlPresetModal(null);
    };
    const deletePreset = () => {
      if (pm.id) {
        setWlCustomPresets(prev => prev.filter(p => p.id !== pm.id));
        if (wlActivePreset === pm.id) setWlActivePreset(null);
      }
      setWlPresetModal(null);
    };
    const dm = darkMode;
    const sortedUsers = [...users].filter(u => u.role !== 'admin').sort((a,b) => a.name.localeCompare(b.name));
    const sortedRes = [...resources].sort((a,b) => a.name.localeCompare(b.name));
    const teamMap = {};
    sortedUsers.forEach(u => { const t = teams.find(t => t.id === u.teamId); const tName = t ? t.name : 'Ohne Team'; if (!teamMap[tName]) teamMap[tName] = []; teamMap[tName].push(u); });
    const resTypeMap = {};
    sortedRes.forEach(r => { const tName = r.type === 'maschine' ? 'ðŸ­ Maschinen' : r.type === 'fahrzeug' ? 'ðŸš› Fahrzeuge' : 'ðŸ”§ Werkzeuge'; if (!resTypeMap[tName]) resTypeMap[tName] = []; resTypeMap[tName].push(r); });
    return (
      <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[60] p-4" onClick={() => setWlPresetModal(null)}>
        <div className={`${dm ? 'bg-[#2a2a3e] text-white' : 'bg-white'} rounded-2xl shadow-2xl w-full max-w-lg max-h-[80vh] flex flex-col`} onClick={e => e.stopPropagation()}>
          <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: dm ? '#3a3a4e' : '#e5e7eb' }}>
            <span className="text-lg">â˜…</span>
            <input autoFocus value={pm.name} onChange={e => setWlPresetModal(prev => ({...prev, name: e.target.value}))} placeholder="Preset-Name (z.B. Montageteam)" className={`flex-1 text-lg font-bold bg-transparent outline-none ${dm ? 'text-white placeholder-gray-500' : 'text-gray-900 placeholder-gray-300'}`} onKeyDown={e => { if (e.key === 'Enter') savePreset(); }} />
            <button onClick={() => setWlPresetModal(null)} className="text-gray-400 hover:text-gray-600 text-xl">âœ•</button>
          </div>
          <div className="flex-1 overflow-y-auto p-4 space-y-4">
            <div>
              <div className="flex items-center justify-between mb-2">
                <span className="font-semibold text-sm" style={{ color: dm ? '#a0a0c0' : '#374151' }}>Mitarbeiter ({pm.userIds.length}/{sortedUsers.length})</span>
                <div className="flex gap-1">
                  <button onClick={() => setWlPresetModal(prev => ({...prev, userIds: sortedUsers.map(u => u.id)}))} className="text-[10px] px-2 py-0.5 rounded bg-indigo-100 text-indigo-700 hover:bg-indigo-200">Alle</button>
                  <button onClick={() => setWlPresetModal(prev => ({...prev, userIds: []}))} className="text-[10px] px-2 py-0.5 rounded bg-gray-100 text-gray-600 hover:bg-gray-200">Keine</button>
                </div>
              </div>
              {Object.entries(teamMap).map(([tName, tUsers]) => (
                <div key={tName} className="mb-2">
                  <div className="flex items-center gap-2 mb-1 cursor-pointer" onClick={() => { const allIn = tUsers.every(u => pm.userIds.includes(u.id)); if (allIn) setWlPresetModal(prev => ({...prev, userIds: prev.userIds.filter(id => !tUsers.some(u => u.id === id))})); else setWlPresetModal(prev => ({...prev, userIds: [...new Set([...prev.userIds, ...tUsers.map(u => u.id)])]})); }}>
                    <div className={`w-3.5 h-3.5 rounded border-2 flex items-center justify-center text-[8px] ${tUsers.every(u => pm.userIds.includes(u.id)) ? 'bg-indigo-600 border-indigo-600 text-white' : tUsers.some(u => pm.userIds.includes(u.id)) ? 'bg-indigo-200 border-indigo-400' : dm ? 'border-gray-600' : 'border-gray-300'}`}>{tUsers.every(u => pm.userIds.includes(u.id)) ? 'âœ“' : ''}</div>
                    <span className="text-xs font-semibold" style={{ color: dm ? '#8888a8' : '#6b7280' }}>{tName}</span>
                  </div>
                  <div className="ml-5 space-y-0.5">
                    {tUsers.map(u => (
                      <label key={u.id} className="flex items-center gap-2 py-0.5 cursor-pointer hover:bg-black/5 rounded px-1 -mx-1" onClick={() => toggleUser(u.id)}>
                        <div className={`w-3.5 h-3.5 rounded border-2 flex items-center justify-center text-[8px] flex-shrink-0 ${pm.userIds.includes(u.id) ? 'bg-indigo-600 border-indigo-600 text-white' : dm ? 'border-gray-600' : 'border-gray-300'}`}>{pm.userIds.includes(u.id) ? 'âœ“' : ''}</div>
                        <span className="text-sm">{u.name}</span>
                      </label>
                    ))}
                  </div>
                </div>
              ))}
            </div>
            {sortedRes.length > 0 && (
              <div>
                <div className="flex items-center justify-between mb-2">
                  <span className="font-semibold text-sm" style={{ color: dm ? '#a0a0c0' : '#374151' }}>Ressourcen ({pm.resourceIds.length}/{sortedRes.length})</span>
                  <div className="flex gap-1">
                    <button onClick={() => setWlPresetModal(prev => ({...prev, resourceIds: sortedRes.map(r => r.id)}))} className="text-[10px] px-2 py-0.5 rounded bg-indigo-100 text-indigo-700 hover:bg-indigo-200">Alle</button>
                    <button onClick={() => setWlPresetModal(prev => ({...prev, resourceIds: []}))} className="text-[10px] px-2 py-0.5 rounded bg-gray-100 text-gray-600 hover:bg-gray-200">Keine</button>
                  </div>
                </div>
                {Object.entries(resTypeMap).map(([typeName, typeRes]) => (
                  <div key={typeName} className="mb-2">
                    <div className="flex items-center gap-2 mb-1 cursor-pointer" onClick={() => { const allIn = typeRes.every(r => pm.resourceIds.includes(r.id)); if (allIn) setWlPresetModal(prev => ({...prev, resourceIds: prev.resourceIds.filter(id => !typeRes.some(r => r.id === id))})); else setWlPresetModal(prev => ({...prev, resourceIds: [...new Set([...prev.resourceIds, ...typeRes.map(r => r.id)])]})); }}>
                      <div className={`w-3.5 h-3.5 rounded border-2 flex items-center justify-center text-[8px] ${typeRes.every(r => pm.resourceIds.includes(r.id)) ? 'bg-teal-600 border-teal-600 text-white' : typeRes.some(r => pm.resourceIds.includes(r.id)) ? 'bg-teal-200 border-teal-400' : dm ? 'border-gray-600' : 'border-gray-300'}`}>{typeRes.every(r => pm.resourceIds.includes(r.id)) ? 'âœ“' : ''}</div>
                      <span className="text-xs font-semibold" style={{ color: dm ? '#8888a8' : '#6b7280' }}>{typeName}</span>
                    </div>
                    <div className="ml-5 space-y-0.5">
                      {typeRes.map(r => (
                        <label key={r.id} className="flex items-center gap-2 py-0.5 cursor-pointer hover:bg-black/5 rounded px-1 -mx-1" onClick={() => toggleRes(r.id)}>
                          <div className={`w-3.5 h-3.5 rounded border-2 flex items-center justify-center text-[8px] flex-shrink-0 ${pm.resourceIds.includes(r.id) ? 'bg-teal-600 border-teal-600 text-white' : dm ? 'border-gray-600' : 'border-gray-300'}`}>{pm.resourceIds.includes(r.id) ? 'âœ“' : ''}</div>
                          <span className="text-sm">{r.name}</span>
                          <span className="text-[10px] ml-auto px-1.5 rounded" style={{ color: dm ? '#666' : '#9ca3af', backgroundColor: dm ? '#333' : '#f3f4f6' }}>{r.code}</span>
                        </label>
                      ))}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
          <div className="p-4 border-t flex items-center gap-2" style={{ borderColor: dm ? '#3a3a4e' : '#e5e7eb' }}>
            {pm.id && <button onClick={deletePreset} className="px-3 py-1.5 rounded-lg text-sm text-red-500 hover:bg-red-50 font-medium">LÃ¶schen</button>}
            <div className="flex-1" />
            <button onClick={() => setWlPresetModal(null)} className={`px-4 py-1.5 rounded-lg text-sm font-medium ${dm ? 'text-gray-400 hover:bg-[#353550]' : 'text-gray-500 hover:bg-gray-100'}`}>Abbrechen</button>
            <button onClick={savePreset} disabled={!pm.name.trim() || (pm.userIds.length === 0 && pm.resourceIds.length === 0)} className={`px-4 py-1.5 rounded-lg text-sm font-medium text-white ${!pm.name.trim() || (pm.userIds.length === 0 && pm.resourceIds.length === 0) ? 'bg-gray-300 cursor-not-allowed' : 'bg-teal-600 hover:bg-teal-700'}`}>{pm.id ? 'Speichern' : 'Erstellen'}</button>
          </div>
        </div>
      </div>
    );
  };

  if (showDisposition) {
    // === DISPOSITION VIEW ===
    const DispositionBoard = () => {
      const parseLocalDate = (dateStr) => {
        if (!dateStr) return null;
        const parts = dateStr.split('-');
        return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
      };
      const [dispoWeekOffset, setDispoWeekOffset] = React.useState(0);
      const [dispoSelection, setDispoSelection] = React.useState(null);
      const [dispoSelecting, setDispoSelecting] = React.useState(null);
      const [dispoClipboard, setDispoClipboard] = React.useState(null);
      const [dispoClipBuffer, setDispoClipBuffer] = React.useState([]); // persistent clipboard history
      const [dispoContextMenu, setDispoContextMenu] = React.useState(null);
      const [dispoPresetDropdown, setDispoPresetDropdown] = React.useState(false);
      const [dispoExpandedGroups, setDispoExpandedGroups] = React.useState({});
      const [dispoSidebarOpen, setDispoSidebarOpen] = React.useState(true);
      const [dispoSidebarSearch, setDispoSidebarSearch] = React.useState('');
      const [dispoDragProject, setDispoDragProject] = React.useState(null); // dragging from sidebar
      const [dispoDragOver, setDispoDragOver] = React.useState(null); // {userId, date}
      const [dispoStretching, setDispoStretching] = React.useState(null); // {userId, date, entry, side}
      const [dispoMovingRun, setDispoMovingRun] = React.useState(null); // {userId, run, startX, daysDiff}
      const [dispoProjectView, setDispoProjectView] = React.useState(false); // bottom panel
      const [dispoPanelHeight, setDispoPanelHeight] = React.useState(250); // px
      const dispoPanelDragRef = React.useRef(null);
      const dispoGridRef = React.useRef(null);
      const dispoLeftRef = React.useRef(null);
      const dispoProjectGridRef = React.useRef(null);
      const dispoProjectLeftRef = React.useRef(null);
      const [dispoRowZoom, setDispoRowZoom] = React.useState(100); // %
      const [dispoColZoom, setDispoColZoom] = React.useState(100); // %
      const [dispoFontSize, setDispoFontSize] = React.useState(12); // px
      
      // Clipboard helper â€” sets active clipboard AND adds to persistent buffer
      const copyToClipboard = (clipData) => {
        setDispoClipboard(clipData);
        if (!clipData || !clipData.entries || clipData.entries.length === 0) return;
        const key = clipData.entries.map(e => e.label + '|' + (e.projectId || '') + '|' + (e.type || '')).join(',');
        setDispoClipBuffer(prev => {
          const filtered = prev.filter(b => b._key !== key);
          const item = { ...clipData, _key: key, _ts: Date.now() };
          return [item, ...filtered].slice(0, 8);
        });
      };
      
      const dm = darkMode;
      const CELL_W = Math.round(110 * dispoColZoom / 100);
      const ROW_H = Math.round(56 * dispoRowZoom / 100);
      const LEFT_W = Math.round(180 * dispoColZoom / 100);
      const WEEKS = 6;
      const today = new Date();
      
      // Generate days for the visible range
      const dispoDays = React.useMemo(() => {
        const start = new Date(today);
        start.setDate(start.getDate() - start.getDay() + 1 + (dispoWeekOffset * 7)); // Monday
        const days = [];
        for (let i = 0; i < WEEKS * 7; i++) {
          const d = new Date(start);
          d.setDate(d.getDate() + i);
          const ds = d.toISOString().slice(0, 10);
          const dow = d.getDay();
          days.push({ date: d, ds, dow, isWE: dow === 0 || dow === 6 });
        }
        return days;
      }, [dispoWeekOffset]);
      
      // Build disposition data: hours + dispo per cell
      const dispoData = React.useMemo(() => {
        const m = {}; // key -> { ppSegments, spSegments, dispo, capacity }
        const ensure = (key) => { if (!m[key]) m[key] = { ppSegments: [], spSegments: [], dispo: null, capacity: 8 }; return m[key]; };
        
        // 1. Projektplanung hours (from WP assignments with proper hours distribution)
        (workPackages || []).forEach(wp => {
          if (!wp.startDate || !wp.endDate) return;
          const hasChildren = workPackages.some(w => w.parentId === wp.id);
          if (hasChildren) return;
          const project = (projects || []).find(p => p.id === wp.projectId);
          const allAssign = [
            ...((wp.responsibles || []).map(r => typeof r === 'object' ? r : { userId: r, hours: 0 })),
            ...((wp.editors || []).map(e => typeof e === 'object' ? e : { userId: e, hours: 0 }))
          ];
          allAssign.forEach(a => {
            if (!a.hours || a.hours <= 0) return;
            // Count work days in WP range
            const start = parseLocalDate(wp.startDate);
            const end = parseLocalDate(wp.endDate);
            let workDays = 0;
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
              const dow = d.getDay();
              if (dow !== 0 && dow !== 6) workDays++;
            }
            if (workDays === 0) return;
            const hpd = a.hours / workDays;
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
              const dow = d.getDay();
              if (dow === 0 || dow === 6) continue;
              const ds = formatDate(d);
              const override = wp.dailyOverrides?.[a.userId]?.[ds];
              const dayH = override !== undefined ? (override === false ? 0 : override) : hpd;
              if (dayH <= 0) continue;
              const key = a.userId + '_' + ds;
              const cell = ensure(key);
              const existing = cell.ppSegments.find(s => s.projectId === wp.projectId);
              if (existing) existing.hours += dayH;
              else cell.ppSegments.push({ projectId: wp.projectId, name: project?.name || wp.name, color: wp.color || project?.color || '#6366f1', hours: dayH, wpId: wp.id });
            }
          });
        });
        
        // 2. Schnellplanung hours (from tasks with startHour/endHour)
        (tasks || []).forEach(t => {
          if (!t.userId || !t.startDate || !t.projectId) return;
          const project = (projects || []).find(p => p.id === t.projectId);
          if (!project) return;
          const start = parseLocalDate(t.startDate);
          const end = parseLocalDate(t.endDate || t.startDate);
          const grossH = (t.endHour || 17) - (t.startHour || 8);
          // Count work days
          let workDays = 0;
          for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
            const dow = d.getDay();
            if (dow !== 0 && dow !== 6) workDays++;
          }
          if (workDays === 0) return;
          const hpd = Math.max(0.5, grossH / workDays);
          for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
            const dow = d.getDay();
            if (dow === 0 || dow === 6) continue;
            const ds = formatDate(d);
            const key = t.userId + '_' + ds;
            const cell = ensure(key);
            const existing = cell.spSegments.find(s => s.projectId === t.projectId);
            if (existing) existing.hours += hpd;
            else cell.spSegments.push({ projectId: t.projectId, name: project.name, color: project.color || '#94a3b8', hours: hpd });
          }
        });
        
        // 2b. Projektplanung hours for RESOURCES (from WP resourceIds + resourceHours)
        (workPackages || []).forEach(wp => {
          if (!wp.startDate || !wp.endDate) return;
          const hasChildren = workPackages.some(w => w.parentId === wp.id);
          if (hasChildren) return;
          const project = (projects || []).find(p => p.id === wp.projectId);
          (wp.resourceIds || []).forEach(rid => {
            const rHours = (wp.resourceHours || {})[rid] || 0;
            if (rHours <= 0) return;
            const start = parseLocalDate(wp.startDate);
            const end = parseLocalDate(wp.endDate);
            let workDays = 0;
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
              const dow = d.getDay();
              if (dow !== 0 && dow !== 6) workDays++;
            }
            if (workDays === 0) return;
            const hpd = rHours / workDays;
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
              const dow = d.getDay();
              if (dow === 0 || dow === 6) continue;
              const ds = formatDate(d);
              const key = 'res_' + rid + '_' + ds;
              const cell = ensure(key);
              const existing = cell.ppSegments.find(s => s.projectId === wp.projectId);
              if (existing) existing.hours += hpd;
              else cell.ppSegments.push({ projectId: wp.projectId, name: project?.name || wp.name, color: wp.color || project?.color || '#6366f1', hours: hpd, wpId: wp.id });
            }
          });
        });
        
        // 3. Manual disposition entries
        dispositions.forEach(d => {
          const key = d.userId + '_' + d.date;
          const cell = ensure(key);
          cell.dispo = { ...d, source: 'manual' };
        });
        
        // 4. Capacity per cell (from user shift model)
        const allKeys = Object.keys(m);
        allKeys.forEach(key => {
          const [userId, ds] = key.split('_');
          const user = (users || []).find(u => u.id === userId);
          if (user) {
            const d = parseLocalDate(ds);
            m[key].capacity = getDailyHours(user, d) || 8;
          }
        });
        
        return m;
      }, [dispositions, workPackages, tasks, projects, users]);
      
      // Group users by team
      const dispoGroups = React.useMemo(() => {
        // Apply preset filter
        const preset = wlActivePreset ? (wlCustomPresets || []).find(p => p.id === wlActivePreset) : null;
        const presetUserIds = preset?.userIds?.length ? new Set(preset.userIds) : null;
        const presetResIds = preset?.resourceIds?.length ? new Set(preset.resourceIds) : null;
        const filteredUsers = presetUserIds ? (users || []).filter(u => presetUserIds.has(u.id)) : (users || []);
        const filteredRes = presetResIds ? (resources || []).filter(r => presetResIds.has(r.id)) : (resources || []);
        
        // Team groups with users
        const teamGroups = [];
        const grouped = {};
        (teams || []).forEach(t => { grouped[t.id] = { team: t, members: [] }; });
        grouped['_none'] = { team: { id: '_none', name: 'Ohne Team' }, members: [] };
        filteredUsers.forEach(u => {
          const key = u.teamId && grouped[u.teamId] ? u.teamId : '_none';
          grouped[key].members.push({ ...u, _kind: 'user' });
        });
        Object.values(grouped).filter(g => g.members.length > 0).forEach(g => teamGroups.push(g));
        
        // Resource type groups
        const resTypeGroups = [
          { type: 'maschine', label: 'ðŸ­ Maschinen', icon: 'ðŸ­' },
          { type: 'fahrzeug', label: 'ðŸš› Fahrzeuge', icon: 'ðŸš›' },
          { type: 'werkzeug', label: 'ðŸ”§ Werkzeuge', icon: 'ðŸ”§' },
        ];
        const resGroups = [];
        resTypeGroups.forEach(tg => {
          const items = filteredRes.filter(r => r.type === tg.type);
          if (items.length > 0) {
            resGroups.push({ team: { id: 'res_' + tg.type, name: tg.label }, members: items.map(r => ({ ...r, _kind: 'resource', _resId: r.id })), _isResGroup: true });
          }
        });
        // Resources without type
        const untypedRes = filteredRes.filter(r => !resTypeGroups.some(tg => tg.type === r.type));
        if (untypedRes.length > 0) {
          resGroups.push({ team: { id: 'res_other', name: 'ðŸ“¦ Sonstige Ressourcen' }, members: untypedRes.map(r => ({ ...r, _kind: 'resource', _resId: r.id })), _isResGroup: true });
        }
        
        return [...teamGroups, ...resGroups];
      }, [users, teams, resources, wlActivePreset, wlCustomPresets]);
      
      // All projects for picker
      
      // Sidebar projects (separate search)
      const sidebarProjects = React.useMemo(() => {
        const q = dispoSidebarSearch.toLowerCase();
        const filtered = (projects || []).filter(p => !q || p.name.toLowerCase().includes(q));
        // Group by folder
        const grouped = {};
        (projectFolders || []).forEach(f => { grouped[f.id] = { folder: f, projects: [] }; });
        grouped['_none'] = { folder: { id: '_none', name: 'Projekte' }, projects: [] };
        filtered.forEach(p => {
          const key = p.folderId && grouped[p.folderId] ? p.folderId : '_none';
          grouped[key].projects.push(p);
        });
        return Object.values(grouped).filter(g => g.projects.length > 0);
      }, [projects, projectFolders, dispoSidebarSearch]);
      
      // Project view: build rows per project showing which users are assigned per day
      const projectViewData = React.useMemo(() => {
        if (!dispoProjectView) return [];
        const projMap = {};
        Object.entries(dispoData).forEach(([key, cell]) => {
          const [userId, ds] = key.split('_');
          const user = (users || []).find(u => u.id === userId);
          if (!user) return;
          const addProj = (pId, source, hours) => {
            if (!pId) return;
            if (!projMap[pId]) projMap[pId] = {};
            if (!projMap[pId][ds]) projMap[pId][ds] = [];
            const existing = projMap[pId][ds].find(e => e.id === user.id);
            if (existing) {
              if (!existing.sources.includes(source)) existing.sources.push(source);
              if (hours) existing.hours = (existing.hours || 0) + hours;
            } else {
              projMap[pId][ds].push({ ...user, sources: [source], hours: hours || 0 });
            }
          };
          cell.ppSegments.forEach(s => addProj(s.projectId, 'pp', s.hours));
          cell.spSegments.forEach(s => addProj(s.projectId, 'sp', s.hours));
          if (cell.dispo?.projectId) addProj(cell.dispo.projectId, 'dispo', 0);
        });
        return Object.entries(projMap).map(([pId, days]) => {
          const project = (projects || []).find(p => p.id === pId);
          return { project, days };
        }).filter(d => d.project).sort((a, b) => a.project.name.localeCompare(b.project.name));
      }, [dispoProjectView, dispoData, users, projects]);
      
      // Handle drop from sidebar onto grid
      const handleDispoDrop = (userId, date) => {
        if (!dispoDragProject) return;
        const p = dispoDragProject;
        setDispo(userId, date, { projectId: p.id, label: p.name, color: p.color || '#6366f1', type: 'assignment' });
        // Don't clear dragProject so user can drop on multiple cells
      };
      
      // Handle stretch end
      React.useEffect(() => {
        if (!dispoStretching) return;
        const handleMouseMove = (e) => {
          const gridEl = dispoGridRef.current;
          if (!gridEl) return;
          const rect = gridEl.getBoundingClientRect();
          const scrollLeft = gridEl.scrollLeft;
          const x = e.clientX - rect.left + scrollLeft;
          const colIdx = Math.floor(x / CELL_W);
          if (colIdx >= 0 && colIdx < dispoDays.length && !dispoDays[colIdx].isWE) {
            setDispoDragOver({ userId: dispoStretching.userId, date: dispoDays[colIdx].ds });
          }
        };
        const handleMouseUp = (e) => {
          if (dispoStretching && dispoDragOver) {
            const startDate = dispoStretching.date < dispoDragOver.date ? dispoStretching.date : dispoDragOver.date;
            const endDate = dispoStretching.date > dispoDragOver.date ? dispoStretching.date : dispoDragOver.date;
            const entry = dispoStretching.entry;
            fillRange(dispoStretching.userId, startDate, endDate, { projectId: entry.projectId, label: entry.label, color: entry.color, type: entry.type });
          }
          setDispoStretching(null);
          setDispoDragOver(null);
        };
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        return () => { document.removeEventListener('mousemove', handleMouseMove); document.removeEventListener('mouseup', handleMouseUp); };
      }, [dispoStretching, dispoDragOver, dispoDays]);
      
      // Handle run move (drag entire block left/right)
      React.useEffect(() => {
        if (!dispoMovingRun) return;
        document.body.style.cursor = 'grabbing';
        const handleMouseMove = (e) => {
          const dx = e.clientX - dispoMovingRun.startX;
          const daysDiff = Math.round(dx / CELL_W);
          setDispoMovingRun(prev => prev ? { ...prev, daysDiff } : null);
        };
        const handleMouseUp = () => {
          const { userId, run, daysDiff } = dispoMovingRun;
          if (daysDiff && daysDiff !== 0) {
            if (dispoGridRef.current) dispoScrollPos.current = { left: dispoGridRef.current.scrollLeft, top: dispoGridRef.current.scrollTop };
            // Collect old run dates
            const oldDates = [];
            for (let di = run.startIdx; di <= run.endIdx; di++) {
              if (di >= 0 && di < dispoDays.length && !dispoDays[di].isWE) oldDates.push(dispoDays[di].ds);
            }
            // Calculate new dates
            const newDates = [];
            let valid = true;
            for (const od of oldDates) {
              const oi = dispoDays.findIndex(d => d.ds === od);
              const ni = oi + daysDiff;
              if (ni < 0 || ni >= dispoDays.length || dispoDays[ni].isWE) { valid = false; break; }
              newDates.push(dispoDays[ni].ds);
            }
            if (valid && newDates.length === oldDates.length) {
              const entry = run.dispo;
              const oldSet = new Set(oldDates);
              const newSet = new Set(newDates);
              // Remove old-only, keep overlap, add new-only
              let updated = (dispositions || []).filter(de => {
                if (de.userId !== userId) return true;
                if (oldSet.has(de.date) && !newSet.has(de.date) && de.projectId === entry.projectId) return false;
                return true;
              });
              // Add new dates (replace existing on those dates)
              newDates.forEach(nd => {
                updated = updated.filter(de => !(de.userId === userId && de.date === nd));
                updated.push({ id: 'dispo_' + Date.now() + '_' + nd, userId, date: nd, projectId: entry.projectId, label: entry.label, color: entry.color, type: entry.type || 'assignment' });
              });
              saveDispositions(updated);
            }
          }
          setDispoMovingRun(null);
          document.body.style.cursor = '';
        };
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        return () => { document.removeEventListener('mousemove', handleMouseMove); document.removeEventListener('mouseup', handleMouseUp); document.body.style.cursor = ''; };
      }, [dispoMovingRun, dispoDays, dispoData, dispositions]);
      
      // Special disposition types
      const SPECIAL_TYPES = [
        { type: 'urlaub', label: 'Urlaub', color: '#a855f7' },
        { type: 'dispo', label: 'Dispo', color: '#6366f1' },
        { type: 'frei', label: 'Frei', color: '#9ca3af' },
        { type: 'krank', label: 'Krank', color: '#ef4444' },
      ];
      
      const SHIFT_TYPES = [
        { key: 'frueh', label: 'FrÃ¼h', color: '#65a30d', bg: '#65a30d20', icon: 'ðŸŒ…' },
        { key: 'tag', label: 'Tag', color: '#dc2626', bg: '#dc262620', icon: 'â˜€ï¸' },
        { key: 'nacht', label: 'Nacht', color: '#3b82f6', bg: '#3b82f620', icon: 'ðŸŒ™' },
      ];
      
      // Scroll-preserving save wrapper â€” saves to parent-level ref that survives remount
      const saveDispoWithScroll = (newDisps) => {
        const grid = dispoGridRef.current;
        if (grid) {
          dispoScrollPos.current = { left: grid.scrollLeft, top: grid.scrollTop };
        }
        saveDispositions(newDisps);
      };
      
      const setDispo = (userId, date, entry) => {
        if (!entry) {
          saveDispoWithScroll(dispositions.filter(d => !(d.userId === userId && d.date === date)));
        } else {
          const existing = dispositions.findIndex(d => d.userId === userId && d.date === date);
          if (existing >= 0) {
            const updated = [...dispositions];
            updated[existing] = { ...updated[existing], ...entry };
            saveDispoWithScroll(updated);
          } else {
            saveDispoWithScroll([...dispositions, { id: `dispo_${Date.now()}_${Math.random().toString(36).slice(2,6)}`, userId, date, ...entry }]);
          }
        }
      };
      
      const fillRange = (userId, startDate, endDate, entry) => {
        const newDisps = dispositions.filter(d => !(d.userId === userId && d.date >= startDate && d.date <= endDate));
        const start = new Date(startDate);
        const end = new Date(endDate);
        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
          const dow = d.getDay();
          if (dow === 0 || dow === 6) continue;
          const ds = d.toISOString().slice(0, 10);
          newDisps.push({ id: `dispo_${Date.now()}_${Math.random().toString(36).slice(2,6)}`, userId, date: ds, ...entry });
        }
        saveDispoWithScroll(newDisps);
      };
      
      const clearRange = (userId, startDate, endDate) => {
        saveDispoWithScroll(dispositions.filter(d => !(d.userId === userId && d.date >= startDate && d.date <= endDate)));
      };
      
      // Keyboard: ESC close, Ctrl+C copy, Ctrl+V paste
      React.useEffect(() => {
        const handler = (e) => {
          if (document.activeElement?.tagName === 'INPUT' || document.activeElement?.tagName === 'TEXTAREA') return;
          if (e.key === 'Escape') { setDispoSelection(null); setDispoContextMenu(null); }
          if (e.key === 'Delete' && dispoSelection) {
            clearRange(dispoSelection.userId, dispoSelection.startDate, dispoSelection.endDate);
            setDispoSelection(null);
          }
          if ((e.ctrlKey || e.metaKey) && e.key === 'c' && dispoSelection) {
            e.preventDefault();
            // Copy the pattern of all entries in the selection range (for multi-day paste)
            const entries = [];
            const start = parseLocalDate(dispoSelection.startDate);
            const end = parseLocalDate(dispoSelection.endDate);
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
              const dow = d.getDay();
              if (dow === 0 || dow === 6) continue;
              const ds = formatDate(d);
              const cell = dispoData[dispoSelection.userId + '_' + ds];
              const entry = cell?.dispo || (cell?.ppSegments?.[0] ? { label: cell.ppSegments[0].name, color: cell.ppSegments[0].color, projectId: cell.ppSegments[0].projectId, type: 'assignment' } : null) || (cell?.spSegments?.[0] ? { label: cell.spSegments[0].name, color: cell.spSegments[0].color, projectId: cell.spSegments[0].projectId, type: 'assignment' } : null);
              if (entry) entries.push({ dayOffset: Math.round((d - start) / 86400000), label: entry.label, color: entry.color, projectId: entry.projectId, type: entry.type });
            }
            if (entries.length > 0) {
              copyToClipboard({ entries, patternDays: Math.round((end - start) / 86400000) + 1 });
            }
          }
          if ((e.ctrlKey || e.metaKey) && e.key === 'v' && dispoSelection && dispoClipboard) {
            e.preventDefault();
            const cb = dispoClipboard;
            const selStart = parseLocalDate(dispoSelection.startDate);
            const selEnd = parseLocalDate(dispoSelection.endDate);
            const selDays = Math.round((selEnd - selStart) / 86400000) + 1;
            const patDays = cb.patternDays || 1;
            
            // Paste repeating pattern across entire selection
            const newDisps = dispositions.filter(d => !(d.userId === dispoSelection.userId && d.date >= dispoSelection.startDate && d.date <= dispoSelection.endDate));
            for (let d = new Date(selStart); d <= selEnd; d.setDate(d.getDate() + 1)) {
              const dow = d.getDay();
              if (dow === 0 || dow === 6) continue;
              const ds = formatDate(d);
              const dayInPattern = Math.round((d - selStart) / 86400000) % patDays;
              // Find matching entry in pattern
              const match = cb.entries.find(e => e.dayOffset === dayInPattern) || (cb.entries.length === 1 ? cb.entries[0] : null);
              if (match) {
                newDisps.push({ id: `dispo_${Date.now()}_${Math.random().toString(36).slice(2,6)}`, userId: dispoSelection.userId, date: ds, label: match.label, color: match.color, projectId: match.projectId, type: match.type });
              }
            }
            saveDispoWithScroll(newDisps);
          }
        };
        document.addEventListener('keydown', handler);
        return () => document.removeEventListener('keydown', handler);
      }, [dispoSelection, dispoClipboard, dispositions]);
      
      // Sync scroll
      const onGridScroll = (e) => {
        if (dispoLeftRef.current) dispoLeftRef.current.scrollTop = e.target.scrollTop;
        if (dispoProjectGridRef.current) dispoProjectGridRef.current.scrollLeft = e.target.scrollLeft;
        // Track scroll position for restore after remount
        dispoScrollPos.current = { left: e.target.scrollLeft, top: e.target.scrollTop };
      };
      
      // Restore scroll position after remount (e.g. after state changes that remount component)
      React.useEffect(() => {
        const pos = dispoScrollPos.current;
        if (pos && (pos.left > 0 || pos.top > 0)) {
          const restore = () => {
            if (dispoGridRef.current) { dispoGridRef.current.scrollLeft = pos.left; dispoGridRef.current.scrollTop = pos.top; }
            if (dispoLeftRef.current) { dispoLeftRef.current.scrollTop = pos.top; }
          };
          requestAnimationFrame(restore);
          setTimeout(restore, 50);
        }
      }, []);
      // Wheel handler: vertical wheel scrolls vertically, shift+wheel or horizontal deltaX scrolls horizontally
      const onGridWheel = React.useCallback((e) => {
        const grid = dispoGridRef.current;
        if (!grid) return;
        if (e.deltaX !== 0) {
          grid.scrollLeft += e.deltaX;
          e.preventDefault();
        } else if (e.shiftKey && e.deltaY !== 0) {
          grid.scrollLeft += e.deltaY;
          e.preventDefault();
        }
      }, []);
      React.useEffect(() => {
        const el = dispoGridRef.current;
        if (!el) return;
        el.addEventListener('wheel', onGridWheel, { passive: false });
        return () => el.removeEventListener('wheel', onGridWheel);
      }, [onGridWheel]);
      
      // Get week numbers for header
      const weekHeaders = React.useMemo(() => {
        const weeks = [];
        for (let w = 0; w < WEEKS; w++) {
          const monday = dispoDays[w * 7];
          const sun = dispoDays[w * 7 + 6];
          const kw = (() => { const d = new Date(monday.date); d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7); const w1 = new Date(d.getFullYear(), 0, 4); return 1 + Math.round(((d - w1) / 86400000 - 3 + (w1.getDay() + 6) % 7) / 7); })();
          weeks.push({ kw, start: monday.ds, days: dispoDays.slice(w * 7, w * 7 + 7) });
        }
        return weeks;
      }, [dispoDays]);
      
      const todayStr = today.toISOString().slice(0, 10);
      const DAY_NAMES = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
      const MONTH_NAMES = ['Jan','Feb','MÃ¤r','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];
      
      return (
        <div className={`h-screen flex flex-col ${dm ? 'bg-[#1a1a2e] text-white' : 'bg-gray-50 text-gray-900'}`}>
          {/* Header Row 1: Title + Navigation */}
          <div className={`flex-shrink-0 px-4 py-1.5 flex items-center justify-between border-b ${dm ? 'bg-[#1e1e32] border-[#3a3a4e]' : 'bg-white border-gray-200'} shadow-sm`}>
            <div className="flex items-center gap-3">
              <h1 className="text-lg font-bold flex items-center gap-2">ðŸ“‹ Disposition</h1>
              {lastSync && <span className="text-[9px] text-gray-400 flex items-center gap-1" title={`Letzter Sync: ${lastSync.toLocaleTimeString()}\nSession: ${sessionId.slice(-4)}\nDein Tier: ${myAnimalEmoji}`}><span className="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse" />{myAnimalEmoji}</span>}
              {onlineUsers.length > 0 && (
                <div className="flex items-center gap-1 ml-1">
                  {onlineUsers.map(p => {
                    const viewLabel = p.view === 'grobplanung' ? 'ðŸ“‹ Schnellplanung' : p.view === 'teamdashboard' ? 'ðŸ“Š Team DB' : p.view === 'projektplanung' ? 'ðŸ“ Projektplanung' : p.view === 'ressourcencockpit' ? 'ðŸ‘¥ Ressourcencockpit' : p.view === 'disposition' ? 'ðŸ“‹ Disposition' : p.view;
                    return (
                      <div key={p.sessionId} className="relative group">
                        <div className="w-6 h-6 rounded-full flex items-center justify-center text-white text-[9px] font-bold cursor-default border-2 border-white shadow-sm" style={{ backgroundColor: p.color }} title={`${p.userName} â€” ${viewLabel}`}>
                          <span style={{ fontSize: 14 }}>{p.animal || 'ðŸ¦«'}</span>
                        </div>
                        <span className="absolute -bottom-0.5 -right-0.5 w-2 h-2 bg-green-400 rounded-full border border-white" />
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
            <div className="nav-bar flex gap-1.5 items-center">
              <button onClick={() => { setShowDisposition(false); setShowDashboard(false); setShowProjectDashboard(false); setShowProjectPlanning(false); setShowResourceCockpit(false); }} className={`px-3 py-1 rounded-2xl text-sm ${dm ? 'bg-[#2a2a3c] text-gray-300 hover:bg-[#353550]' : 'bg-gray-100 hover:bg-gray-200'}`}><Calendar className="w-3.5 h-3.5 inline mr-1" />Schnellplanung</button>
              {(currentUser.teamRole === 'lead' || currentUser.teamRole === 'department_head' || currentUser.teamRole === 'entrepreneur' || currentUser.role === 'admin') && (
                <button onClick={() => { setShowDisposition(false); setShowDashboard(true); }} className={`px-3 py-1 rounded-2xl text-sm ${dm ? 'bg-[#2a2a3c] text-gray-300 hover:bg-[#353550]' : 'bg-gray-100 hover:bg-gray-200'}`}><BarChart3 className="w-3.5 h-3.5 inline mr-1" />Team Dashboard</button>
              )}
              <button onClick={() => { setShowDisposition(false); setShowProjectPlanning(true); }} className={`px-3 py-1 rounded-2xl text-sm ${dm ? 'bg-[#2a2a3c] text-gray-300 hover:bg-[#353550]' : 'bg-gray-100 hover:bg-gray-200'}`}>ðŸ—ï¸ Projektplanung</button>
              <button onClick={() => { setShowDisposition(false); setShowResourceCockpit(true); }} className={`px-3 py-1 rounded-2xl text-sm ${dm ? 'bg-[#2a2a3c] text-gray-300 hover:bg-[#353550]' : 'bg-gray-100 hover:bg-gray-200'}`}>ðŸ‘¥ Ressourcencockpit</button>
              <button className="px-3 py-1 rounded-2xl bg-amber-600 text-white text-sm">ðŸ“‹ Disposition</button>
              <button onClick={() => setDarkMode(d => !d)} className={`p-1.5 rounded-2xl ${dm ? 'bg-indigo-600 text-yellow-200' : 'hover:bg-gray-100'}`}>{dm ? 'â˜€ï¸' : 'ðŸŒ™'}</button>
              <button onClick={() => { setCurrentUser(null); setSelectedUser(null); setShowLogin(true); setShowDisposition(false); }} className={`px-3 py-1 rounded-2xl text-sm ${dm ? 'bg-[#2a2a3c] text-gray-300 hover:bg-[#353550]' : 'bg-gray-100 hover:bg-gray-200'}`}><LogOut className="w-3.5 h-3.5 inline mr-1" />Abmelden</button>
            </div>
          </div>
          
          {/* Header Row 2: Controls & Tools */}
          <div className={`flex-shrink-0 px-4 py-1 flex items-center gap-3 border-b ${dm ? 'bg-[#1a1a2e] border-[#3a3a4e]' : 'bg-gray-50 border-gray-200'}`}>
            {/* Date Navigation */}
            <div className="flex items-center gap-1">
              <button onClick={() => setDispoWeekOffset(w => w - 1)} className={`px-2 py-0.5 rounded text-sm ${dm ? 'bg-[#2a2a3c] hover:bg-[#353550]' : 'bg-gray-100 hover:bg-gray-200'}`}>â—€</button>
              <button onClick={() => setDispoWeekOffset(0)} className={`px-3 py-0.5 rounded text-sm font-medium ${dm ? 'bg-teal-800 text-teal-200' : 'bg-teal-100 text-teal-700'}`}>Heute</button>
              <button onClick={() => setDispoWeekOffset(w => w + 1)} className={`px-2 py-0.5 rounded text-sm ${dm ? 'bg-[#2a2a3c] hover:bg-[#353550]' : 'bg-gray-100 hover:bg-gray-200'}`}>â–¶</button>
            </div>
            
            <div className={`w-px h-5 ${dm ? 'bg-[#3a3a4e]' : 'bg-gray-300'}`} />
            
            {/* Preset Filter */}
            <div className="relative">
              <button onClick={() => setDispoPresetDropdown(!dispoPresetDropdown)} className={`text-xs px-2 py-0.5 rounded font-medium flex items-center gap-1 ${wlActivePreset ? 'bg-teal-600 text-white' : (dm ? 'bg-[#2a2a3c] text-gray-400 hover:bg-[#353550]' : 'bg-gray-100 text-gray-500 hover:bg-gray-200')}`}>
                <span style={{ fontSize: 10 }}>â–¼</span>
                {wlActivePreset ? `â˜… ${(wlCustomPresets || []).find(p => p.id === wlActivePreset)?.name || 'Filter'}` : 'ðŸ” Filter / Preset'}
              </button>
              {dispoPresetDropdown && (
                <React.Fragment>
                  <div className="fixed inset-0 z-30" onClick={() => setDispoPresetDropdown(false)} />
                  <div className={`absolute left-0 top-full mt-1 rounded-lg shadow-xl border min-w-[240px] z-40 ${dm ? 'bg-[#2a2a3e] border-[#3a3a4e]' : 'bg-white border-gray-200'}`}>
                    {(wlCustomPresets || []).length > 0 && (
                      <div className={`border-b py-1 ${dm ? 'border-[#3a3a4e]' : 'border-gray-200'}`}>
                        {(wlCustomPresets || []).map(preset => (
                          <div key={preset.id} className={`flex items-center gap-2 px-3 py-1.5 text-sm cursor-pointer ${wlActivePreset === preset.id ? (dm ? 'bg-teal-900 text-teal-200' : 'bg-teal-50 text-teal-700') : (dm ? 'hover:bg-[#353550] text-gray-300' : 'hover:bg-gray-50 text-gray-700')}`}>
                            <span className="flex-1 truncate" onClick={() => { setWlActivePreset(wlActivePreset === preset.id ? null : preset.id); setDispoPresetDropdown(false); }}>â˜… {preset.name}</span>
                            <span className={`text-[9px] ${dm ? 'text-gray-500' : 'text-gray-400'}`}>{(preset.userIds || []).length} MA Â· {(preset.resourceIds || []).length} EH</span>
                            <button onClick={(e) => { e.stopPropagation(); setWlPresetModal({ ...preset, userIds: preset.userIds || [], resourceIds: preset.resourceIds || [] }); setDispoPresetDropdown(false); }} className={`p-0.5 rounded ${dm ? 'hover:bg-[#4a4a5e]' : 'hover:bg-gray-200'}`}>âœï¸</button>
                          </div>
                        ))}
                      </div>
                    )}
                    {wlActivePreset && (
                      <button onClick={() => { setWlActivePreset(null); setDispoPresetDropdown(false); }} className={`w-full text-left px-3 py-1.5 text-sm ${dm ? 'text-gray-400 hover:bg-[#353550]' : 'text-gray-500 hover:bg-gray-50'}`}>âœ• Filter zurÃ¼cksetzen</button>
                    )}
                    <button onClick={() => { setWlPresetModal({ id: null, name: '', userIds: [], resourceIds: [] }); setDispoPresetDropdown(false); }} className={`w-full text-left px-3 py-1.5 text-sm font-medium ${dm ? 'text-teal-400 hover:bg-[#353550]' : 'text-teal-600 hover:bg-teal-50'}`}>+ Neues Preset erstellen</button>
                  </div>
                </React.Fragment>
              )}
            </div>
            
            <div className={`w-px h-5 ${dm ? 'bg-[#3a3a4e]' : 'bg-gray-300'}`} />
            
            {/* Project View toggle */}
            <button onClick={() => setDispoProjectView(!dispoProjectView)} className={`text-xs px-2 py-0.5 rounded font-medium ${dispoProjectView ? (dm ? 'bg-orange-800 text-orange-200' : 'bg-orange-100 text-orange-700') : (dm ? 'bg-[#2a2a3c] text-gray-400' : 'bg-gray-100 text-gray-500')}`}>
              ðŸ¢ Projektansicht
            </button>
            
            <div className={`w-px h-5 ${dm ? 'bg-[#3a3a4e]' : 'bg-gray-300'}`} />
            
            {/* Layer visibility toggles */}
            <div className={`flex items-center gap-0.5 px-1 py-0.5 rounded ${dm ? 'bg-[#252540]' : 'bg-gray-100'}`}>
              <button onClick={() => setDispoLayers(l => ({...l, pp: !l.pp}))} className={`text-[10px] px-2 py-0.5 rounded-full font-medium transition-all ${dispoLayers.pp ? (dm ? 'bg-indigo-800 text-indigo-200 ring-1 ring-indigo-500' : 'bg-indigo-100 text-indigo-700 ring-1 ring-indigo-300') : (dm ? 'bg-[#2a2a3c] text-gray-500 line-through' : 'bg-gray-100 text-gray-400 line-through')}`}>
                ðŸ“ Projekt
              </button>
              <button onClick={() => setDispoLayers(l => ({...l, sp: !l.sp}))} className={`text-[10px] px-2 py-0.5 rounded-full font-medium transition-all ${dispoLayers.sp ? (dm ? 'bg-slate-700 text-slate-200 ring-1 ring-slate-500' : 'bg-slate-100 text-slate-700 ring-1 ring-slate-300') : (dm ? 'bg-[#2a2a3c] text-gray-500 line-through' : 'bg-gray-100 text-gray-400 line-through')}`}>
                ðŸ“‹ Schnell
              </button>
              <button onClick={() => setDispoLayers(l => ({...l, dispo: !l.dispo}))} className={`text-[10px] px-2 py-0.5 rounded-full font-medium transition-all ${dispoLayers.dispo ? (dm ? 'bg-orange-800 text-orange-200 ring-1 ring-orange-500' : 'bg-orange-100 text-orange-700 ring-1 ring-orange-300') : (dm ? 'bg-[#2a2a3c] text-gray-500 line-through' : 'bg-gray-100 text-gray-400 line-through')}`}>
                âœï¸ Dispo
              </button>
            </div>
            
            <div className={`w-px h-5 ${dm ? 'bg-[#3a3a4e]' : 'bg-gray-300'}`} />
            
            {/* Zoom & Font Controls */}
            <div className={`flex items-center gap-1 px-1.5 py-0.5 rounded ${dm ? 'bg-[#2a2a3c]' : 'bg-gray-100'}`}>
              <span className={`text-[10px] ${dm ? 'text-gray-500' : 'text-gray-400'}`}>â†•</span>
              <input type="range" min="50" max="200" step="10" value={dispoRowZoom} onChange={e => setDispoRowZoom(+e.target.value)} className="w-12 h-1 accent-teal-500" title={`HÃ¶he: ${dispoRowZoom}%`} />
              <span className={`text-[9px] w-6 ${dm ? 'text-gray-400' : 'text-gray-500'}`}>{dispoRowZoom}%</span>
            </div>
            <div className={`flex items-center gap-1 px-1.5 py-0.5 rounded ${dm ? 'bg-[#2a2a3c]' : 'bg-gray-100'}`}>
              <span className={`text-[10px] ${dm ? 'text-gray-500' : 'text-gray-400'}`}>â†”</span>
              <input type="range" min="50" max="200" step="10" value={dispoColZoom} onChange={e => setDispoColZoom(+e.target.value)} className="w-12 h-1 accent-teal-500" title={`Breite: ${dispoColZoom}%`} />
              <span className={`text-[9px] w-6 ${dm ? 'text-gray-400' : 'text-gray-500'}`}>{dispoColZoom}%</span>
            </div>
            <select value={dispoFontSize} onChange={e => setDispoFontSize(+e.target.value)} className={`text-[10px] px-1 py-0.5 rounded border ${dm ? 'bg-[#2a2a3c] border-[#3a3a4e] text-gray-300' : 'bg-white border-gray-200'}`} title="SchriftgrÃ¶ÃŸe">
              {[8,9,10,11,12,13,14,16].map(s => <option key={s} value={s}>{s}px</option>)}
            </select>
            
            {/* Clipboard indicator */}
            {/* Clipboard Buffer Tray */}
            {dispoClipBuffer.length > 0 && (
              <div className={`flex items-center gap-1 px-1.5 py-0.5 rounded ${dm ? 'bg-[#252540]' : 'bg-gray-100'}`}>
                <span className={`text-[9px] ${dm ? 'text-gray-500' : 'text-gray-400'}`}>ðŸ“‹</span>
                {dispoClipBuffer.map((buf, bi) => {
                  const label = buf.entries[0]?.label || '?';
                  const color = buf.entries[0]?.color || '#6366f1';
                  const isActive = dispoClipboard && dispoClipboard._key === buf._key;
                  return (
                    <button key={buf._key} onClick={() => setDispoClipboard(buf)}
                      title={`Klick = aktivieren fÃ¼r Ctrl+V\n${label}${buf.entries.length > 1 ? ' (' + buf.entries.length + ' Tage)' : ''}`}
                      className={`text-[10px] px-1.5 py-0.5 rounded cursor-pointer truncate max-w-[80px] font-medium transition-all ${isActive ? 'ring-2 ring-offset-1 shadow-sm' : 'opacity-70 hover:opacity-100'}`}
                      style={{
                        backgroundColor: color + (isActive ? '35' : '18'),
                        color: dm ? '#ddd' : color,
                        borderLeft: `3px solid ${color}`,
                        ringColor: color,
                      }}>
                      {label.length > 10 ? label.slice(0, 9) + 'â€¦' : label}
                    </button>
                  );
                })}
                <button onClick={() => { setDispoClipBuffer([]); setDispoClipboard(null); }} className={`text-[9px] px-1 py-0.5 rounded ${dm ? 'text-gray-500 hover:text-red-400 hover:bg-[#353550]' : 'text-gray-400 hover:text-red-500 hover:bg-red-50'}`} title="Zwischenspeicher leeren">âœ•</button>
              </div>
            )}
          </div>
          
          {/* Main Grid */}
          <div className="flex-1 flex overflow-hidden min-h-0">
            {/* Project Sidebar â€” collapsible */}
            <div className={`flex-shrink-0 flex ${dm ? 'bg-[#1e1e32]' : 'bg-white'}`}>
              {dispoSidebarOpen ? (
                <div className={`flex flex-col border-r ${dm ? 'border-[#3a3a4e]' : 'border-gray-200'}`} style={{ width: 200 }}>
                  <div className={`px-2 py-1.5 border-b flex items-center gap-1 ${dm ? 'border-[#3a3a4e]' : 'border-gray-200'}`}>
                    <span className="text-xs font-bold flex-1">ðŸ“‚ Projekte</span>
                    <button onClick={() => setDispoSidebarOpen(false)} className={`w-5 h-5 flex items-center justify-center rounded hover:bg-opacity-20 ${dm ? 'text-gray-400 hover:bg-gray-600 hover:text-gray-200' : 'text-gray-400 hover:bg-gray-200 hover:text-gray-600'}`} title="Einklappen">Â«</button>
                  </div>
                  <div className="px-2 py-1">
                    <input value={dispoSidebarSearch} onChange={e => setDispoSidebarSearch(e.target.value)} placeholder="Suchen..." className={`w-full text-xs px-2 py-1 rounded border ${dm ? 'bg-[#2a2a3c] border-[#3a3a4e] text-white' : 'bg-gray-50 border-gray-200'}`} />
                  </div>
                  <div className="flex-1 overflow-auto px-1 py-1">
                  {sidebarProjects.map(grp => (
                    <React.Fragment key={grp.folder.id}>
                      <div className={`text-[10px] font-bold px-1 py-0.5 ${dm ? 'text-gray-500' : 'text-gray-400'}`}>{grp.folder.name}</div>
                      {grp.projects.map(p => (
                        <div key={p.id}
                          draggable
                          onDragStart={(e) => { setDispoDragProject(p); e.dataTransfer.setData('text/plain', p.name); e.dataTransfer.effectAllowed = 'copy'; }}
                          onDragEnd={() => { if (dispoGridRef.current) dispoScrollPos.current = { left: dispoGridRef.current.scrollLeft, top: dispoGridRef.current.scrollTop }; setDispoDragProject(null); }}
                          className={`flex items-center gap-1.5 px-2 py-1 text-xs rounded cursor-grab active:cursor-grabbing mb-0.5 ${dm ? 'hover:bg-[#353550] text-gray-300' : 'hover:bg-gray-100 text-gray-700'} ${dispoDragProject?.id === p.id ? 'opacity-50' : ''}`}
                        >
                          <div className="w-3 h-3 rounded flex-shrink-0" style={{ backgroundColor: p.color || '#6366f1' }} />
                          <span className="truncate">{p.name}</span>
                        </div>
                      ))}
                    </React.Fragment>
                  ))}
                  {sidebarProjects.length === 0 && <div className="text-xs text-gray-400 px-2 py-4 text-center">Keine Projekte</div>}
                  <div className={`border-t mt-2 pt-2 ${dm ? 'border-[#3a3a4e]' : 'border-gray-200'}`}>
                    <div className={`text-[10px] font-bold px-1 py-0.5 ${dm ? 'text-gray-500' : 'text-gray-400'}`}>Spezial</div>
                    {SPECIAL_TYPES.map(st => (
                      <div key={st.type}
                        draggable
                        onDragStart={(e) => { setDispoDragProject({ id: null, name: st.label, color: st.color, _type: st.type }); e.dataTransfer.setData('text/plain', st.label); e.dataTransfer.effectAllowed = 'copy'; }}
                        onDragEnd={() => { if (dispoGridRef.current) dispoScrollPos.current = { left: dispoGridRef.current.scrollLeft, top: dispoGridRef.current.scrollTop }; setDispoDragProject(null); }}
                        className={`flex items-center gap-1.5 px-2 py-1 text-xs rounded cursor-grab active:cursor-grabbing mb-0.5 ${dm ? 'hover:bg-[#353550] text-gray-300' : 'hover:bg-gray-100 text-gray-700'}`}
                      >
                        <div className="w-3 h-3 rounded flex-shrink-0" style={{ backgroundColor: st.color }} />
                        <span>{st.label}</span>
                      </div>
                    ))}
                  </div>
                  {/* Maschinen & Schichten */}
                  {resources.filter(r => r.type === 'maschine').length > 0 && (
                    <div className={`border-t mt-2 pt-2 ${dm ? 'border-[#3a3a4e]' : 'border-gray-200'}`}>
                      <div className={`text-[10px] font-bold px-1 py-0.5 ${dm ? 'text-gray-500' : 'text-gray-400'}`}>ðŸ­ Maschinen & Schichten</div>
                      {resources.filter(r => r.type === 'maschine').sort((a,b) => a.name.localeCompare(b.name, 'de')).map(res => (
                        <React.Fragment key={res.id}>
                          {SHIFT_TYPES.map(sh => (
                            <div key={res.id + '_' + sh.key}
                              draggable
                              onDragStart={(e) => { 
                                setDispoDragProject({ 
                                  id: 'shift_' + res.id + '_' + sh.key, 
                                  name: res.name + ' ' + sh.label, 
                                  color: sh.color, 
                                  _type: 'shift',
                                  _resId: res.id,
                                  _shift: sh.key
                                }); 
                                e.dataTransfer.setData('text/plain', res.name + ' ' + sh.label); 
                                e.dataTransfer.effectAllowed = 'copy'; 
                              }}
                              onDragEnd={() => { if (dispoGridRef.current) dispoScrollPos.current = { left: dispoGridRef.current.scrollLeft, top: dispoGridRef.current.scrollTop }; setDispoDragProject(null); }}
                              className={`flex items-center gap-1 px-2 py-0.5 text-[11px] rounded cursor-grab active:cursor-grabbing mb-0.5 ${dm ? 'hover:bg-[#353550]' : 'hover:bg-gray-100'}`}
                              style={{ color: sh.color }}
                            >
                              <span className="text-[10px]">{sh.icon}</span>
                              <span className="truncate font-medium">{res.name} {sh.label}</span>
                            </div>
                          ))}
                        </React.Fragment>
                      ))}
                    </div>
                  )}
                  {/* Fahrzeuge */}
                  {resources.filter(r => r.type === 'fahrzeug').length > 0 && (
                    <div className={`border-t mt-2 pt-2 ${dm ? 'border-[#3a3a4e]' : 'border-gray-200'}`}>
                      <div className={`text-[10px] font-bold px-1 py-0.5 ${dm ? 'text-gray-500' : 'text-gray-400'}`}>ðŸš› Fahrzeuge</div>
                      {resources.filter(r => r.type === 'fahrzeug').sort((a,b) => a.name.localeCompare(b.name, 'de')).map(res => (
                        <div key={res.id}
                          draggable
                          onDragStart={(e) => { 
                            setDispoDragProject({ 
                              id: 'vehicle_' + res.id, 
                              name: res.name + (res.kennzeichen ? ' (' + res.kennzeichen + ')' : ''), 
                              color: '#0ea5e9', 
                              _type: 'vehicle',
                              _resId: res.id
                            }); 
                            e.dataTransfer.setData('text/plain', res.name); 
                            e.dataTransfer.effectAllowed = 'copy'; 
                          }}
                          onDragEnd={() => { if (dispoGridRef.current) dispoScrollPos.current = { left: dispoGridRef.current.scrollLeft, top: dispoGridRef.current.scrollTop }; setDispoDragProject(null); }}
                          className={`flex items-center gap-1.5 px-2 py-0.5 text-[11px] rounded cursor-grab active:cursor-grabbing mb-0.5 ${dm ? 'hover:bg-[#353550] text-gray-300' : 'hover:bg-gray-100 text-gray-700'}`}
                        >
                          <span className="text-[10px]">ðŸš›</span>
                          <span className="truncate font-medium">{res.name}</span>
                          {res.kennzeichen && <span className={`text-[8px] ml-auto ${dm ? 'text-gray-500' : 'text-gray-400'}`}>{res.kennzeichen}</span>}
                        </div>
                      ))}
                    </div>
                  )}
                </div>
                {/* Resize handle */}
                <div className={`w-1.5 cursor-ew-resize flex items-center justify-center group flex-shrink-0 ${dm ? 'bg-teal-900/30 hover:bg-teal-800/50' : 'bg-teal-100 hover:bg-teal-200'}`}>
                  <div className={`h-8 w-0.5 rounded ${dm ? 'bg-teal-500/30 group-hover:bg-teal-400/60' : 'bg-teal-400/50 group-hover:bg-teal-500'}`} />
                </div>
              </div>
              ) : (
                <div className={`flex flex-col items-center py-2 border-r cursor-pointer ${dm ? 'border-[#3a3a4e] hover:bg-[#252545]' : 'border-gray-200 hover:bg-gray-100'}`}
                  style={{ width: 28 }}
                  onClick={() => setDispoSidebarOpen(true)} title="Projekte & Maschinen einblenden">
                  <span className={`text-xs font-bold ${dm ? 'text-teal-400' : 'text-teal-600'}`}>Â»</span>
                  <span className={`text-[10px] mt-1 ${dm ? 'text-gray-500' : 'text-gray-400'}`} style={{ writingMode: 'vertical-rl', textOrientation: 'mixed' }}>Projekte & Schichten</span>
                </div>
              )}
            </div>
            
            {/* Employee + Grid Area */}
            <div className="flex-1 flex flex-col overflow-hidden min-h-0">
            <div className={`flex overflow-hidden ${dispoProjectView ? 'flex-1' : 'flex-1'}`} style={{ minHeight: dispoProjectView ? '50%' : '100%' }}>
            {/* Left Panel: Employee Names */}
            <div className="flex flex-col flex-shrink-0" style={{ width: LEFT_W }}>
              {/* Corner Header */}
              <div className={`border-b border-r flex-shrink-0 flex items-end px-2 py-1 font-semibold ${dm ? 'bg-[#1e1e32] border-[#3a3a4e]' : 'bg-gray-100 border-gray-300'}`} style={{ height: ROW_H * 2, fontSize: dispoFontSize }}>
                <span>MA / Ressourcen</span>
              </div>
              {/* Tree Rows */}
              <div ref={dispoLeftRef} className="flex-1 overflow-hidden" style={{ overflowY: 'hidden' }}>
                {dispoGroups.map((grp, gi) => {
                  const grpKey = 'dg_' + grp.team.id;
                  const isExp = dispoExpandedGroups[grpKey] !== false;
                  const isResGrp = grp._isResGroup;
                  const isLast = gi === dispoGroups.length - 1;
                  return (
                  <React.Fragment key={grp.team.id}>
                    <div className={`font-bold flex items-center border-b border-r cursor-pointer select-none ${dm ? 'bg-[#252540] border-[#3a3a4e]' : 'bg-gray-200 border-gray-300'}`}
                      style={{ height: ROW_H - 4, fontSize: dispoFontSize, color: isResGrp ? (dm ? '#c0a0e0' : '#7c3aed') : (dm ? '#5eead4' : '#0d9488') }}
                      onClick={() => setDispoExpandedGroups(prev => ({...prev, [grpKey]: !isExp}))}>
                      <span className={`ml-1 mr-1 text-[10px] ${dm ? 'text-gray-500' : 'text-gray-400'}`}>{isExp ? 'â–¼' : 'â–¶'}</span>
                      <span className="truncate flex-1">{grp.team.name}</span>
                      <span className={`text-[9px] mr-2 font-normal ${dm ? 'text-gray-500' : 'text-gray-400'}`}>{grp.members.length}</span>
                    </div>
                    {isExp && grp.members.map((m, mi) => {
                      const isLastM = mi === grp.members.length - 1;
                      const icon = m._kind === 'resource' ? (m.type === 'maschine' ? 'ðŸ­' : m.type === 'fahrzeug' ? 'ðŸš›' : m.type === 'werkzeug' ? 'ðŸ”§' : 'ðŸ“¦') : null;
                      return (
                      <div key={m.id} className={`flex items-center border-b border-r truncate ${dm ? 'border-[#3a3a4e]' : 'border-gray-200'}`} style={{ height: ROW_H, fontSize: dispoFontSize }}>
                        {/* Tree lines */}
                        <div className="flex-shrink-0 relative" style={{ width: 20, height: ROW_H }}>
                          <div className="absolute" style={{ left: 8, top: 0, width: 1, height: isLastM ? ROW_H / 2 : ROW_H, backgroundColor: dm ? '#3a3a4e' : '#d0d0d0' }} />
                          <div className="absolute" style={{ left: 8, top: ROW_H / 2, width: 8, height: 1, backgroundColor: dm ? '#3a3a4e' : '#d0d0d0' }} />
                        </div>
                        {icon && <span className="flex-shrink-0 mr-1" style={{ fontSize: dispoFontSize - 2 }}>{icon}</span>}
                        <span className={`truncate ${m._kind === 'resource' ? (dm ? 'text-purple-300' : 'text-purple-700') : ''}`}>{m.name}</span>
                        {/* Vehicle & shift code badges */}
                        {m._kind !== 'resource' && m.vehicle && (
                          <span className={`flex-shrink-0 ml-auto px-1 rounded text-[8px] font-bold ${dm ? 'bg-sky-900/40 text-sky-300' : 'bg-sky-100 text-sky-600'}`}>{m.vehicle}</span>
                        )}
                        {m._kind !== 'resource' && m.shiftCode && (
                          <span className={`flex-shrink-0 ml-0.5 px-1 rounded text-[8px] font-bold ${dm ? 'bg-amber-900/40 text-amber-300' : 'bg-amber-100 text-amber-700'}`}>{m.shiftCode}</span>
                        )}
                      </div>
                      );
                    })}
                  </React.Fragment>
                  );
                })}
                <div style={{ height: '50vh' }} />
              </div>
            </div>
            
            {/* Right Panel: Day Grid */}
            <div ref={dispoGridRef} className="dispo-grid flex-1 overflow-auto" onScroll={onGridScroll}
              style={{ scrollbarWidth: 'auto', scrollbarColor: dm ? '#4a4a6a #1e1e32' : '#c0c0c0 #f0f0f0' }}>
              {/* Week & Day Headers */}
              <div className="sticky top-0 z-10" style={{ minWidth: dispoDays.length * CELL_W }}>
                {/* KW row */}
                <div className="flex" style={{ height: ROW_H }}>
                  {weekHeaders.map((wk, wi) => (
                    <div key={wi} className={`flex-shrink-0 flex items-center justify-center font-bold border-b border-r ${dm ? 'bg-[#1e1e32] border-[#3a3a4e] text-gray-300' : 'bg-gray-100 border-gray-300'}`} style={{ width: CELL_W * 7, fontSize: dispoFontSize }}>
                      KW {wk.kw} â€” {MONTH_NAMES[wk.days[0].date.getMonth()]} {wk.days[0].date.getFullYear()}
                    </div>
                  ))}
                </div>
                {/* Day row */}
                <div className="flex" style={{ height: ROW_H }}>
                  {dispoDays.map((day, i) => (
                    <div key={i} className={`flex-shrink-0 flex flex-col items-center justify-center font-medium border-b border-r ${day.ds === todayStr ? 'ring-2 ring-inset ring-red-400' : ''} ${day.isWE ? (dm ? 'bg-[#1a1a2e] border-[#2a2a40] text-gray-600' : 'bg-gray-200 border-gray-300 text-gray-400') : (dm ? 'bg-[#1e1e32] border-[#3a3a4e]' : 'bg-gray-50 border-gray-300')}`} style={{ width: CELL_W, fontSize: dispoFontSize - 1 }}>
                      <span>{DAY_NAMES[day.dow]}</span>
                      <span>{day.date.getDate()}.{day.date.getMonth()+1}.</span>
                    </div>
                  ))}
                </div>
              </div>
              
              {/* Data Rows */}
              <div style={{ minWidth: dispoDays.length * CELL_W }}>
                {dispoGroups.map(grp => {
                  const grpKey = 'dg_' + grp.team.id;
                  const isExp = dispoExpandedGroups[grpKey] !== false;
                  return (
                  <React.Fragment key={grp.team.id}>
                    {/* Team/Group header row */}
                    <div className="flex" style={{ height: ROW_H - 4 }}>
                      {dispoDays.map((day, i) => (
                        <div key={i} className={`flex-shrink-0 border-b border-r ${dm ? 'bg-[#252540] border-[#3a3a4e]' : 'bg-gray-200 border-gray-300'}`} style={{ width: CELL_W }} />
                      ))}
                    </div>
                    {/* Member rows (users + resources) */}
                    {isExp && grp.members.map(u => {
                      const memberId = u._kind === 'resource' ? ('res_' + u._resId) : u.id;
                      // Compute dispo-only runs for background blocks
                      const dispoRuns = [];
                      let curRun = null;
                      dispoDays.forEach((day, i) => {
                        const cell = dispoData[memberId + '_' + day.ds];
                        const dispo = dispoLayers.dispo ? cell?.dispo : null;
                        if (dispo && !day.isWE) {
                          const rk = dispo.projectId || dispo.label || '';
                          if (curRun && curRun.key === rk) { curRun.endIdx = i; curRun.endDate = day.ds; }
                          else { if (curRun) dispoRuns.push(curRun); curRun = { key: rk, startIdx: i, endIdx: i, startDate: day.ds, endDate: day.ds, dispo }; }
                        } else {
                          if (curRun) { dispoRuns.push(curRun); curRun = null; }
                        }
                      });
                      if (curRun) dispoRuns.push(curRun);
                      
                      return (
                      <div key={memberId} className="flex relative" style={{ height: ROW_H }}>
                        {/* Grid cells with stacked hour bars */}
                        {dispoDays.map((day, i) => {
                          const key = memberId + '_' + day.ds;
                          const cell = dispoData[key];
                          const ppSegs = dispoLayers.pp ? (cell?.ppSegments || []) : [];
                          const spSegs = dispoLayers.sp ? (cell?.spSegments || []) : [];
                          const dispo = dispoLayers.dispo ? cell?.dispo : null;
                          const cap = cell?.capacity || 8;
                          const ppTotal = ppSegs.reduce((s, seg) => s + seg.hours, 0);
                          const spTotal = spSegs.reduce((s, seg) => s + seg.hours, 0);
                          const totalH = ppTotal + spTotal;
                          const isOverload = totalH > cap;
                          
                          // Conflict: dispo project differs from hour-planned projects
                          const plannedProjects = [...ppSegs, ...spSegs].map(s => s.projectId).filter(Boolean);
                          const hasConflict = dispo?.projectId && plannedProjects.length > 0 && !plannedProjects.includes(dispo.projectId);
                          
                          const isSelected = dispoSelection && dispoSelection.userId === memberId && day.ds >= dispoSelection.startDate && day.ds <= dispoSelection.endDate;
                          const isSelecting = dispoSelecting && dispoSelecting.userId === memberId && day.ds >= (dispoSelecting.startDate < dispoSelecting.endDate ? dispoSelecting.startDate : dispoSelecting.endDate) && day.ds <= (dispoSelecting.startDate > dispoSelecting.endDate ? dispoSelecting.startDate : dispoSelecting.endDate);
                          const isDragOver = dispoDragProject && dispoDragOver?.userId === memberId && dispoDragOver?.date === day.ds;
                          const isStretchTarget = dispoStretching?.userId === memberId && dispoDragOver && day.ds >= (dispoStretching.date < dispoDragOver.date ? dispoStretching.date : dispoDragOver.date) && day.ds <= (dispoStretching.date > dispoDragOver.date ? dispoStretching.date : dispoDragOver.date);
                          
                          // Bar geometry: symbolic fill, min height per segment
                          const barPad = 2;
                          const barH = ROW_H - barPad * 2;
                          const capLineY = barH; // capacity = full bar height (bottom = 0)
                          const minSegH = Math.max(16, ROW_H * 0.22); // minimum readable height
                          const allSegs = [...ppSegs.map(s => ({...s, source: 'projektplanung'})), ...spSegs.map(s => ({...s, source: 'grobplanung'}))];
                          // Compute natural heights, enforce minimum
                          const rawHeights = allSegs.map(s => Math.max(minSegH, (s.hours / Math.max(cap, 0.1)) * barH));
                          const rawTotal = rawHeights.reduce((a, b) => a + b, 0);
                          // Scale to fit if needed, but allow overflow for overload
                          const scale = rawTotal > 0 ? Math.min(1, barH / rawTotal) : 1;
                          const segments = [];
                          let yPos = 0;
                          allSegs.forEach((seg, si) => {
                            const h = rawHeights[si] * (isOverload ? (barH + barPad * 2) / rawTotal : scale);
                            segments.push({ ...seg, h: Math.max(h, minSegH), y: yPos });
                            yPos += Math.max(h, minSegH);
                          });
                          // Capacity line: from bottom, cap/maxH fraction
                          const capFraction = cap / Math.max(cap, totalH, 0.1);
                          
                          return (
                            <div key={i}
                              className={`flex-shrink-0 border-b border-r select-none cursor-pointer relative overflow-hidden ${day.isWE ? (dm ? 'bg-[#151528] border-[#2a2a40]' : 'bg-gray-200/80 border-gray-300') : (dm ? 'border-[#3a3a4e]' : 'border-gray-200')} ${isSelected || isSelecting ? 'ring-2 ring-inset ring-blue-500 z-[5]' : ''} ${isDragOver ? 'ring-2 ring-inset ring-teal-400 z-[5]' : ''} ${isStretchTarget ? 'ring-2 ring-inset ring-orange-400 z-[5]' : ''}`}
                              style={{ width: CELL_W, height: ROW_H, ...(day.isWE ? { backgroundImage: `repeating-linear-gradient(135deg, transparent, transparent 4px, ${dm ? 'rgba(255,255,255,0.03)' : 'rgba(0,0,0,0.04)'} 4px, ${dm ? 'rgba(255,255,255,0.03)' : 'rgba(0,0,0,0.04)'} 5px)` } : {}) }}
                              onDragOver={(e) => { if (!day.isWE) { e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; setDispoDragOver({ userId: memberId, date: day.ds }); }}}
                              onDragEnter={(e) => { if (!day.isWE) { e.preventDefault(); setDispoDragOver({ userId: memberId, date: day.ds }); }}}
                              onDragLeave={(e) => { if (!e.currentTarget.contains(e.relatedTarget)) setDispoDragOver(null); }}
                              onDrop={(e) => { e.preventDefault(); if (dispoGridRef.current) dispoScrollPos.current = { left: dispoGridRef.current.scrollLeft, top: dispoGridRef.current.scrollTop }; const p = dispoDragProject; if (p && !day.isWE) { const sel = dispoSelection && dispoSelection.userId === memberId ? dispoSelection : null; if (sel) { fillRange(memberId, sel.startDate, sel.endDate, { projectId: p.id, label: p.name, color: p.color || '#6366f1', type: p._type || 'assignment' }); } else { setDispo(memberId, day.ds, { projectId: p.id, label: p.name, color: p.color || '#6366f1', type: p._type || 'assignment' }); } } setDispoDragOver(null); }}
                              onClick={() => { if (day.isWE) return; setDispoSelection({ userId: memberId, startDate: day.ds, endDate: day.ds }); }}
                              onMouseDown={(e) => { if (e.button !== 0 || day.isWE) return; setDispoSelecting({ userId: memberId, startDate: day.ds, endDate: day.ds }); }}
                              onMouseEnter={() => { if (dispoSelecting && dispoSelecting.userId === memberId) setDispoSelecting(prev => ({ ...prev, endDate: day.ds })); }}
                              onMouseUp={() => { if (dispoSelecting) { const s = dispoSelecting.startDate < dispoSelecting.endDate ? dispoSelecting.startDate : dispoSelecting.endDate; const e2 = dispoSelecting.startDate > dispoSelecting.endDate ? dispoSelecting.startDate : dispoSelecting.endDate; setDispoSelection({ userId: dispoSelecting.userId, startDate: s, endDate: e2 }); setDispoSelecting(null); }}}
                              onContextMenu={(e) => { e.preventDefault(); setDispoContextMenu({ x: e.clientX, y: e.clientY, userId: memberId, date: day.ds, cell }); setDispoSelection({ userId: memberId, startDate: day.ds, endDate: day.ds }); }}
                              onDoubleClick={() => {
                                if (day.isWE) return;
                                if (ppSegs.length > 0) { setShowDisposition(false); setShowProjectPlanning(true); }
                                else if (spSegs.length > 0) { setShowDisposition(false); setShowDashboard(false); setShowProjectPlanning(false); setShowResourceCockpit(false); }
                              }}
                            >
                              {/* Stacked hour bar segments (bottomâ†’top) â€” border style per source + icon */}
                              {!day.isWE && segments.map((seg, si) => {
                                const isPP = seg.source === 'projektplanung';
                                const isSP = seg.source === 'grobplanung';
                                const bottom = barPad + seg.y;
                                const isTop = si === segments.length - 1;
                                const br = isTop ? '6px 6px 3px 3px' : '3px';
                                const rx = isTop ? 6 : 3;
                                const segW = CELL_W - 6;
                                const segH = Math.max(seg.h, 2);
                                const icon = isPP ? 'ðŸ“' : isSP ? 'ðŸ“‹' : 'âœï¸';
                                const borderStyle = isPP ? 'solid' : isSP ? 'dashed' : 'dotted';
                                return (
                                  <div key={si} className="absolute pointer-events-none overflow-hidden" style={{
                                    left: 3, right: 3, bottom, height: segH,
                                    backgroundColor: seg.color + (dm ? '45' : '25'),
                                    border: `2.5px ${borderStyle} ${seg.color}`,
                                    borderRadius: br,
                                  }}>
                                    {seg.h >= minSegH && <span className="truncate block px-1 pointer-events-none" style={{ fontSize: Math.min(dispoFontSize - 2, 11), color: dm ? '#ddd' : seg.color, lineHeight: Math.max(seg.h - 4, 10) + 'px', fontWeight: 600 }}>{icon} {seg.name}</span>}
                                  </div>
                                );
                              })}
                              {/* Red overload overlay â€” covers only the area above capacity line */}
                              {!day.isWE && isOverload && (() => {
                                const capBottom = barPad + capFraction * barH;
                                const overH = yPos - capFraction * barH; // how much extends above cap
                                return overH > 0 ? (
                                  <div className="absolute pointer-events-none" style={{
                                    left: 3, right: 3, bottom: capBottom, height: overH,
                                    backgroundColor: '#ef444435',
                                    borderRadius: '4px 4px 0 0',
                                    zIndex: 2,
                                  }} />
                                ) : null;
                              })()}
                              {/* Total hours label */}
                              {!day.isWE && totalH > 0 && (
                                <div className="absolute top-0 right-0.5 pointer-events-none z-[4]" style={{ fontSize: dispoFontSize - 3, fontWeight: 700, color: isOverload ? '#ef4444' : (dm ? '#aaa' : '#666') }}>
                                  {totalH.toFixed(1)}h
                                </div>
                              )}
                              {/* Conflict warning */}
                              {hasConflict && <div className="absolute top-0 left-0 z-[6] leading-none" style={{ fontSize: 16 }} title="Disposition â‰  Stundenplanung">âš ï¸</div>}
                              {/* Day note indicator */}
                              {(() => {
                                const cellNotes = (dayNotes || []).filter(n => n.userId === memberId && n.date === day.ds);
                                if (cellNotes.length === 0) return null;
                                return cellNotes.map((cn, cni) => (
                                  <div key={cni} className="absolute z-[5] pointer-events-auto cursor-pointer truncate"
                                    style={{ bottom: 1 + cni * 14, left: 1, right: 1, fontSize: dispoFontSize - 3, backgroundColor: (cn.color || '#6b7280') + '25', color: cn.color || '#6b7280', borderRadius: 3, padding: '0 2px', border: `1px solid ${(cn.color || '#6b7280')}40`, lineHeight: '13px', fontWeight: 600 }}
                                    title={`${cn.icon || 'ðŸ“'} ${cn.text}`}
                                    onClick={(e) => { e.stopPropagation(); setDayNoteEditor({ userId: memberId, date: day.ds, note: cn }); }}>
                                    {cn.icon || 'ðŸ“'} {cn.text}
                                  </div>
                                ));
                              })()}
                              <div className="absolute inset-0" />
                            </div>
                          );
                        })}
                        {/* Disposition background runs (dotted border, transparent fill, full row height) */}
                        {dispoRuns.map((run, ri) => {
                          const color = run.dispo.color || '#f97316';
                          const isMoving = dispoMovingRun?.userId === memberId && dispoMovingRun?.run?.startIdx === run.startIdx && dispoMovingRun?.run?.key === run.key;
                          const moveOffset = isMoving ? (dispoMovingRun.daysDiff || 0) * CELL_W : 0;
                          const left = run.startIdx * CELL_W + 1 + moveOffset;
                          const width = (run.endIdx - run.startIdx + 1) * CELL_W - 2;
                          return (
                            <div key={'dr'+ri} className={`absolute overflow-hidden z-[1] ${isMoving ? 'opacity-80 shadow-lg z-[10]' : ''}`}
                              style={{ left, width, top: 1, bottom: 1, backgroundColor: color + (dm ? '15' : '0a'), border: `2.5px dotted ${color}`, borderRadius: 8, cursor: 'grab', transition: isMoving ? 'none' : 'left 0.15s ease' }}
                              onMouseDown={(e) => {
                                if (e.target.classList.contains('stretch-handle')) return;
                                e.stopPropagation(); e.preventDefault();
                                setDispoMovingRun({ userId: memberId, run, startX: e.clientX, daysDiff: 0 });
                              }}>
                              <span className="absolute top-0.5 left-5 truncate font-semibold pointer-events-none whitespace-nowrap" style={{ fontSize: dispoFontSize - 2, color: dm ? '#e0e0e0' : color, opacity: 0.7 }}>
                                {(() => { const t = run.dispo.type; const icon = t === 'shift' ? (SHIFT_TYPES.find(s => run.dispo.label?.includes(s.label))?.icon || 'ðŸ­') : t === 'vehicle' ? 'ðŸš›' : 'âœï¸'; return icon; })()} {run.dispo.label}
                              </span>
                              {/* Stretch handles */}
                              <div className="stretch-handle absolute left-0 top-0 bottom-0 w-2.5 cursor-ew-resize opacity-0 hover:opacity-100" style={{ backgroundColor: color + '66', borderRadius: '8px 0 0 8px' }} onMouseDown={(e) => { e.stopPropagation(); e.preventDefault(); setDispoStretching({ userId: memberId, date: run.startDate, entry: run.dispo, side: 'left' }); }} />
                              <div className="stretch-handle absolute right-0 top-0 bottom-0 w-2.5 cursor-ew-resize opacity-0 hover:opacity-100" style={{ backgroundColor: color + '66', borderRadius: '0 8px 8px 0' }} onMouseDown={(e) => { e.stopPropagation(); e.preventDefault(); setDispoStretching({ userId: memberId, date: run.endDate, entry: run.dispo, side: 'right' }); }} />
                            </div>
                          );
                        })}
                      </div>
                      );
                    })}
                  </React.Fragment>
                  );
                })}
                <div style={{ height: '50vh', minWidth: 1 }} />
              </div>
            </div>
          </div>
          
          {/* Project View Panel â€” resizable */}
          {dispoProjectView && projectViewData.length > 0 && (
            <div className={`flex-shrink-0 flex flex-col ${dm ? 'border-2 border-purple-500/40 rounded-t-lg' : 'border-2 border-purple-300 rounded-t-lg'}`} style={{ height: dispoPanelHeight, minHeight: 80 }}>
              {/* Resize handle with title */}
              <div className={`h-6 cursor-ns-resize flex items-center group rounded-t-md flex-shrink-0 ${dm ? 'bg-purple-900/40 hover:bg-purple-800/50' : 'bg-purple-100 hover:bg-purple-200'}`}
                onMouseDown={(e) => {
                  e.preventDefault();
                  const startY = e.clientY;
                  const startH = dispoPanelHeight;
                  const onMove = (ev) => setDispoPanelHeight(Math.max(80, Math.min(window.innerHeight * 0.7, startH - (ev.clientY - startY))));
                  const onUp = () => { window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp); };
                  window.addEventListener('mousemove', onMove);
                  window.addEventListener('mouseup', onUp);
                }}>
                <span className={`px-2 font-bold ${dm ? 'text-purple-300' : 'text-purple-700'}`} style={{ fontSize: dispoFontSize }}>ðŸ¢ Projekte ({projectViewData.length})</span>
                <div className={`flex-1 flex justify-center`}><div className={`w-16 h-0.5 rounded ${dm ? 'bg-purple-400/50 group-hover:bg-purple-300' : 'bg-purple-400 group-hover:bg-purple-500'}`} /></div>
              </div>
              <div className="flex flex-1 overflow-hidden">
                <div className="flex flex-col flex-shrink-0" style={{ width: LEFT_W }}>
                  <div ref={dispoProjectLeftRef} className="flex-1 overflow-hidden">
                    {projectViewData.map(pv => (
                      <div key={pv.project.id} className={`flex items-center gap-1.5 px-2 border-b border-r truncate ${dm ? 'border-[#3a3a4e]' : 'border-gray-200'}`} style={{ height: ROW_H, fontSize: dispoFontSize + 1 }}>
                        <div className="w-3 h-3 rounded flex-shrink-0" style={{ backgroundColor: pv.project.color || '#6366f1' }} />
                        <span className="truncate font-semibold">{pv.project.name}</span>
                      </div>
                    ))}
                    <div style={{ height: '50vh' }} />
                  </div>
                </div>
                <div ref={dispoProjectGridRef} className="dispo-grid flex-1 overflow-auto" onScroll={(e) => {
                  if (dispoProjectLeftRef.current) dispoProjectLeftRef.current.scrollTop = e.target.scrollTop;
                  if (dispoGridRef.current) dispoGridRef.current.scrollLeft = e.target.scrollLeft;
                }}>
                  <div style={{ minWidth: dispoDays.length * CELL_W }}>
                    {projectViewData.map(pv => (
                      <div key={pv.project.id} className="flex" style={{ height: ROW_H }}>
                        {dispoDays.map((day, i) => {
                          const dayUsers = pv.days[day.ds] || [];
                          return (
                            <div key={i} className={`flex-shrink-0 border-b border-r flex flex-col justify-center px-1 overflow-hidden ${day.isWE ? (dm ? 'bg-[#151528] border-[#2a2a40]' : 'bg-gray-200/80 border-gray-300') : (dm ? 'border-[#3a3a4e]' : 'border-gray-200')}`}
                              style={{ width: CELL_W, backgroundColor: dayUsers.length > 0 && !day.isWE ? (pv.project.color || '#6366f1') + '18' : undefined, ...(day.isWE ? { backgroundImage: `repeating-linear-gradient(135deg, transparent, transparent 4px, ${dm ? 'rgba(255,255,255,0.03)' : 'rgba(0,0,0,0.04)'} 4px, ${dm ? 'rgba(255,255,255,0.03)' : 'rgba(0,0,0,0.04)'} 5px)` } : {}) }}>
                              {dayUsers.slice(0, 4).map((u, ui) => {
                                const short = u.name.split(' ').length > 1 ? u.name.split(' ')[0][0] + '. ' + u.name.split(' ').slice(-1)[0] : u.name;
                                const hasPP = (u.sources || []).includes('pp');
                                const hasSP = (u.sources || []).includes('sp');
                                const hasDispo = (u.sources || []).includes('dispo');
                                const bColor = pv.project.color || '#6366f1';
                                const sz = Math.max(dispoFontSize - 4, 6);
                                return (
                                  <div key={u.id} className={`flex items-center gap-0.5 truncate ${dm ? 'text-gray-300' : 'text-gray-600'}`} style={{ fontSize: dispoFontSize - 1, lineHeight: 1.3 }}>
                                    {/* Source icons */}
                                    {hasPP && <span className="flex-shrink-0" style={{ fontSize: sz }}>ðŸ“</span>}
                                    {hasSP && <span className="flex-shrink-0" style={{ fontSize: sz }}>ðŸ“‹</span>}
                                    {hasDispo && <span className="flex-shrink-0" style={{ fontSize: sz }}>âœï¸</span>}
                                    <span className="truncate font-medium">{short}</span>
                                    {u.hours > 0 && <span className={`flex-shrink-0 ${dm ? 'text-gray-500' : 'text-gray-400'}`} style={{ fontSize: dispoFontSize - 3 }}>{u.hours.toFixed(1)}h</span>}
                                  </div>
                                );
                              })}
                              {dayUsers.length > 4 && <span className="text-gray-400" style={{ fontSize: dispoFontSize - 4 }}>+{dayUsers.length - 4}</span>}
                            </div>
                          );
                        })}
                      </div>
                    ))}
                    <div style={{ height: '50vh' }} />
                  </div>
                </div>
              </div>
            </div>
          )}
          </div>
          </div>
          {dispoContextMenu && (() => {
            const cc = dispoContextMenu.cell;
            const ppSegs = cc?.ppSegments || [];
            const spSegs = cc?.spSegments || [];
            const dispo = cc?.dispo;
            const allItems = [
              ...ppSegs.map(s => ({ ...s, source: 'projektplanung', icon: 'ðŸ“', srcLabel: 'Projektplanung' })),
              ...spSegs.map(s => ({ ...s, source: 'grobplanung', icon: 'ðŸ“‹', srcLabel: 'Schnellplanung' })),
              ...(dispo ? [{ name: dispo.label, color: dispo.color, source: 'manual', icon: 'âœï¸', srcLabel: 'Disposition', hours: null, projectId: dispo.projectId }] : [])
            ];
            return (
            <React.Fragment>
              <div className="fixed inset-0 z-40" onClick={() => setDispoContextMenu(null)} />
              <div className={`fixed z-50 rounded-lg shadow-xl border py-1 min-w-[240px] ${dm ? 'bg-[#2a2a3e] border-[#3a3a4e]' : 'bg-white border-gray-200'}`}
                style={{ left: dispoContextMenu.x, top: dispoContextMenu.y }}>
                {allItems.length > 0 && (
                  <React.Fragment>
                    <div className={`px-3 py-1 text-[10px] font-bold ${dm ? 'text-gray-500' : 'text-gray-400'}`}>
                      {ppSegs.length + spSegs.length > 0 ? `${(ppSegs.reduce((s,x) => s+x.hours,0) + spSegs.reduce((s,x) => s+x.hours,0)).toFixed(1)}h / ${cc?.capacity || 8}h geplant` : 'Keine Stunden'}
                      {dispo ? ' Â· Dispo: ' + dispo.label : ''}
                    </div>
                    {allItems.map((item, ei) => (
                      <div key={ei} className={`px-3 py-1 text-xs flex items-center gap-2 ${dm ? 'text-gray-300' : 'text-gray-600'}`}>
                        <div className="w-2.5 h-2.5 rounded flex-shrink-0" style={{ backgroundColor: item.color || '#6366f1' }} />
                        <span className="truncate flex-1">{item.icon} {item.name}</span>
                        {item.hours != null && <span className={`text-[9px] font-mono ${dm ? 'text-gray-500' : 'text-gray-400'}`}>{item.hours.toFixed(1)}h</span>}
                        <span className={`text-[9px] ${dm ? 'text-gray-500' : 'text-gray-400'}`}>{item.srcLabel}</span>
                      </div>
                    ))}
                    <div className={`border-t my-1 ${dm ? 'border-[#3a3a4e]' : 'border-gray-200'}`} />
                    {ppSegs.length > 0 && (
                      <button className={`w-full px-3 py-1.5 text-left text-xs flex items-center gap-2 ${dm ? 'hover:bg-[#353550] text-blue-400' : 'hover:bg-blue-50 text-blue-600'}`} onClick={() => {
                        setDispoContextMenu(null); setShowDisposition(false); setShowProjectPlanning(true);
                      }}>ðŸ“ Ã–ffne Projektplanung</button>
                    )}
                    {ppSegs.length > 0 && (
                      <button className={`w-full px-3 py-1.5 text-left text-xs flex items-center gap-2 ${dm ? 'hover:bg-[#353550] text-indigo-400' : 'hover:bg-indigo-50 text-indigo-600'}`} onClick={() => {
                        const pId = ppSegs[0].projectId;
                        const url = `${window.location.pathname}?autoView=projektplanung&autoUser=${currentUser.id}${pId ? '&autoProject=' + pId : ''}`;
                        window.open(url, '_blank');
                        setDispoContextMenu(null);
                      }}>ðŸ“ Zeige im Gantt (neuer Tab)</button>
                    )}
                    {spSegs.length > 0 && (
                      <button className={`w-full px-3 py-1.5 text-left text-xs flex items-center gap-2 ${dm ? 'hover:bg-[#353550] text-green-400' : 'hover:bg-green-50 text-green-600'}`} onClick={() => {
                        setDispoContextMenu(null); setShowDisposition(false); setShowDashboard(false); setShowProjectPlanning(false); setShowResourceCockpit(false);
                      }}>ðŸ“‹ Ã–ffne Schnellplanung</button>
                    )}
                    {spSegs.length > 0 && (
                      <button className={`w-full px-3 py-1.5 text-left text-xs flex items-center gap-2 ${dm ? 'hover:bg-[#353550] text-emerald-400' : 'hover:bg-emerald-50 text-emerald-600'}`} onClick={() => {
                        const url = `${window.location.pathname}?autoView=schnellplanung&autoUser=${currentUser.id}`;
                        window.open(url, '_blank');
                        setDispoContextMenu(null);
                      }}>ðŸ“‹ Schnellplanung (neuer Tab)</button>
                    )}
                    <div className={`border-t my-1 ${dm ? 'border-[#3a3a4e]' : 'border-gray-200'}`} />
                  </React.Fragment>
                )}
                {/* Copy */}
                {allItems.length > 0 && (
                  <button className={`w-full px-3 py-1.5 text-left text-xs flex items-center gap-2 ${dm ? 'hover:bg-[#353550]' : 'hover:bg-gray-100'}`} onClick={() => {
                    const src = dispo || (ppSegs[0] ? { label: ppSegs[0].name, color: ppSegs[0].color, projectId: ppSegs[0].projectId, type: 'assignment' } : spSegs[0] ? { label: spSegs[0].name, color: spSegs[0].color, projectId: spSegs[0].projectId, type: 'assignment' } : null);
                    if (src) copyToClipboard({ entries: [{ dayOffset: 0, label: src.label, color: src.color, projectId: src.projectId, type: src.type || 'assignment' }], patternDays: 1 });
                    setDispoContextMenu(null);
                  }}>ðŸ“‹ Kopieren</button>
                )}
                {dispoClipBuffer.length > 0 && (
                  <React.Fragment>
                    <div className={`px-3 py-1 text-[10px] font-bold ${dm ? 'text-gray-500' : 'text-gray-400'}`}>Zwischenspeicher</div>
                    {dispoClipBuffer.map((buf) => {
                      const e0 = buf.entries[0];
                      const isActive = dispoClipboard && dispoClipboard._key === buf._key;
                      return (
                        <button key={buf._key} className={`w-full px-3 py-1.5 text-left text-xs flex items-center gap-2 ${isActive ? (dm ? 'bg-[#353550]' : 'bg-teal-50') : ''} ${dm ? 'hover:bg-[#353550]' : 'hover:bg-gray-100'}`} onClick={() => {
                          if (dispoSelection) fillRange(dispoSelection.userId, dispoSelection.startDate, dispoSelection.endDate, e0);
                          else setDispo(dispoContextMenu.userId, dispoContextMenu.date, e0);
                          setDispoClipboard(buf);
                          setDispoContextMenu(null);
                        }}>
                          <div className="w-2.5 h-2.5 rounded flex-shrink-0" style={{ backgroundColor: e0.color || '#6366f1' }} />
                          <span className="truncate flex-1">ðŸ“Œ {e0.label}</span>
                          {buf.entries.length > 1 && <span className={`text-[9px] ${dm ? 'text-gray-500' : 'text-gray-400'}`}>{buf.entries.length}d</span>}
                        </button>
                      );
                    })}
                  </React.Fragment>
                )}
                <div className={`border-t my-1 ${dm ? 'border-[#3a3a4e]' : 'border-gray-200'}`} />
                {SPECIAL_TYPES.map(st => (
                  <button key={st.type} className={`w-full px-3 py-1.5 text-left text-xs flex items-center gap-2 ${dm ? 'hover:bg-[#353550]' : 'hover:bg-gray-100'}`} onClick={() => {
                    if (dispoSelection) fillRange(dispoSelection.userId, dispoSelection.startDate, dispoSelection.endDate, { projectId: null, label: st.label, color: st.color, type: st.type });
                    else setDispo(dispoContextMenu.userId, dispoContextMenu.date, { projectId: null, label: st.label, color: st.color, type: st.type });
                    setDispoContextMenu(null);
                  }}>
                    <div className="w-3 h-3 rounded" style={{ backgroundColor: st.color }} /> {st.label}
                  </button>
                ))}
                <div className={`border-t my-1 ${dm ? 'border-[#3a3a4e]' : 'border-gray-200'}`} />
                <button className={`w-full px-3 py-1.5 text-left text-xs flex items-center gap-2 text-red-500 ${dm ? 'hover:bg-[#353550]' : 'hover:bg-red-50'}`} onClick={() => {
                  if (dispoSelection) clearRange(dispoSelection.userId, dispoSelection.startDate, dispoSelection.endDate);
                  else setDispo(dispoContextMenu.userId, dispoContextMenu.date, null);
                  setDispoContextMenu(null);
                }}>ðŸ—‘ï¸ Nur Dispo-EintrÃ¤ge lÃ¶schen</button>
                <button className={`w-full px-3 py-1.5 text-left text-xs flex items-center gap-2 text-red-500 ${dm ? 'hover:bg-[#353550]' : 'hover:bg-red-50'}`} onClick={() => {
                  // Delete all dispo entries for this user in the week of the clicked cell
                  const userId = dispoContextMenu.userId;
                  const clickDate = new Date(dispoContextMenu.date);
                  const dayOfWeek = clickDate.getDay();
                  const mon = new Date(clickDate); mon.setDate(mon.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
                  const fri = new Date(mon); fri.setDate(fri.getDate() + 4);
                  const monStr = mon.toISOString().slice(0, 10);
                  const friStr = fri.toISOString().slice(0, 10);
                  clearRange(userId, monStr, friStr);
                  setDispoContextMenu(null);
                }}>ðŸ—‘ï¸ Dispo dieser Woche lÃ¶schen</button>
                <div className={`border-t my-1 ${dm ? 'border-[#3a3a4e]' : 'border-gray-200'}`} />
                <button className={`w-full px-3 py-1.5 text-left text-xs flex items-center gap-2 ${dm ? 'hover:bg-[#353550] text-amber-400' : 'hover:bg-amber-50 text-amber-600'}`} onClick={() => {
                  const userId = dispoContextMenu.userId;
                  const date = dispoContextMenu.date;
                  setDispoContextMenu(null);
                  setDayNoteEditor({ userId, date });
                }}>ðŸ“ Notiz hinzufÃ¼gen</button>
                {(() => {
                  const existingNotes = (dayNotes || []).filter(n => n.userId === dispoContextMenu.userId && n.date === dispoContextMenu.date);
                  if (existingNotes.length === 0) return null;
                  return existingNotes.map((n, ni) => (
                    <button key={ni} className={`w-full px-3 py-1.5 text-left text-xs flex items-center gap-2 ${dm ? 'hover:bg-[#353550]' : 'hover:bg-gray-100'}`}
                      onClick={() => { setDispoContextMenu(null); setDayNoteEditor({ userId: dispoContextMenu.userId, date: dispoContextMenu.date, note: n }); }}>
                      <span style={{ color: n.color }}>{n.icon || 'ðŸ“'}</span>
                      <span className="truncate">{n.text}</span>
                    </button>
                  ));
                })()}
              </div>
            </React.Fragment>
            );
          })()}
          {/* Footer */}
          <div className={`flex-shrink-0 px-4 py-1.5 border-t flex items-center gap-4 text-xs ${dm ? 'bg-[#1e1e32] border-[#3a3a4e] text-gray-400' : 'bg-white border-gray-200 text-gray-500'}`}>
            <span>ðŸ“‚ Drag&Drop = Zuweisen</span>
            <span>Doppelklick = Zur Planung</span>
            <span>Maus-Drag = Bereich markieren</span>
            <span>Ctrl+C = Kopieren</span>
            <span>Ctrl+V = EinfÃ¼gen (wiederholt Ã¼ber Auswahl)</span>
            <span>Del = LÃ¶schen</span>
            <span>Rechtsklick = MenÃ¼</span>
            <div className="w-px h-3 bg-gray-300 mx-1" />
            <span className="flex items-center gap-1.5"><span className="inline-block w-10 h-5 rounded-md" style={{ border: '2.5px solid #6366f1', backgroundColor: '#6366f125' }} /> ðŸ“ aus Projektplanung</span>
            <span className="flex items-center gap-1.5"><span className="inline-block w-10 h-5 rounded-md" style={{ border: '2.5px dashed #94a3b8', backgroundColor: '#94a3b825' }} /> ðŸ“‹ aus Schnellplanung</span>
            <span className="flex items-center gap-1.5"><span className="inline-block w-10 h-5 rounded-lg" style={{ border: '2.5px dotted #f97316', backgroundColor: '#f9731610' }} /> âœï¸ aus Disposition</span>
            <span className="flex items-center gap-1.5"><span className="inline-block w-10 h-5 rounded" style={{ backgroundColor: '#ef444435' }} /> Ãœberlast</span>
            <span className="flex items-center gap-1.5">ðŸ“ Notizen</span>
            <span className={`flex items-center gap-1 ${dm ? 'text-gray-500' : 'text-gray-400'}`}>|</span>
            <span className="flex items-center gap-1" style={{ color: '#65a30d' }}>ðŸŒ… FrÃ¼h</span>
            <span className="flex items-center gap-1" style={{ color: '#dc2626' }}>â˜€ï¸ Tag</span>
            <span className="flex items-center gap-1" style={{ color: '#3b82f6' }}>ðŸŒ™ Nacht</span>
            <span className="flex items-center gap-1.5">âš ï¸ Konflikt</span>
            <span className="ml-auto">{dispositions.length} manuelle EintrÃ¤ge Â· {dispoGroups.reduce((s,g) => s + g.members.filter(m => m._kind !== 'resource').length, 0)} MA Â· {dispoGroups.reduce((s,g) => s + g.members.filter(m => m._kind === 'resource').length, 0)} EH</span>
          </div>
          {renderPresetModal()}
          {/* Day Note Editor (inside Disposition) */}
          {dayNoteEditor && (() => {
            const dn = dayNoteEditor;
            const existing = dn.note;
            return (
              <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-50" onClick={() => setDayNoteEditor(null)}>
                <div className={`rounded-2xl shadow-2xl p-5 w-96 ${dm ? 'bg-[#2a2a3c] text-gray-200' : 'bg-white text-gray-800'}`} onClick={(e) => e.stopPropagation()}>
                  <div className="flex items-center justify-between mb-3">
                    <h3 className="font-bold text-sm">{existing ? 'ðŸ“ Notiz bearbeiten' : 'ðŸ“ Neue Notiz'}</h3>
                    <span className={`text-xs ${dm ? 'text-gray-500' : 'text-gray-400'}`}>{dn.date}</span>
                  </div>
                  <div className="mb-3">
                    <label className={`text-xs font-medium mb-1 block ${dm ? 'text-gray-400' : 'text-gray-500'}`}>Kategorie</label>
                    <div className="flex flex-wrap gap-1.5">
                      {NOTE_TYPES.map((nt, i) => {
                        const isActive = (dayNoteEditor._icon || existing?.icon || 'ðŸ“') === nt.icon;
                        return (
                          <button key={i}
                            className={`px-2 py-1 rounded-lg text-xs font-medium transition-all ${isActive ? 'ring-2 ring-offset-1 shadow-md' : 'opacity-60 hover:opacity-100'}`}
                            style={{ backgroundColor: nt.color + '20', color: nt.color }}
                            onClick={() => setDayNoteEditor(prev => ({ ...prev, _icon: nt.icon, _color: nt.color, _label: nt.label }))}>
                            {nt.icon} {nt.label}
                          </button>
                        );
                      })}
                    </div>
                  </div>
                  <div className="mb-4">
                    <input type="text" autoFocus
                      defaultValue={existing?.text || dayNoteEditor._label || ''}
                      className={`w-full px-3 py-2 rounded-lg border text-sm ${dm ? 'bg-[#1e1e30] border-[#4a4a5e] text-gray-200' : 'bg-white border-gray-300'}`}
                      placeholder="z.B. Wechsel zur GU-Abteilung..."
                      id="dayNoteInputDispo"
                      onKeyDown={(e) => {
                        if (e.key === 'Enter') {
                          const text = e.target.value.trim(); if (!text) return;
                          const icon = dayNoteEditor._icon || existing?.icon || 'ðŸ“';
                          const color = dayNoteEditor._color || existing?.color || '#6b7280';
                          if (existing) saveDayNotes(dayNotes.map(n => n.id === existing.id ? { ...n, text, icon, color } : n));
                          else saveDayNotes([...dayNotes, { id: 'dn_' + Date.now(), userId: dn.userId, date: dn.date, text, icon, color }]);
                          setDayNoteEditor(null);
                        }
                      }} />
                  </div>
                  <div className="flex justify-between">
                    <div>{existing && <button className="px-3 py-1.5 rounded-lg text-xs font-medium bg-red-50 text-red-600 hover:bg-red-100" onClick={() => { saveDayNotes(dayNotes.filter(n => n.id !== existing.id)); setDayNoteEditor(null); }}>ðŸ—‘ï¸ LÃ¶schen</button>}</div>
                    <div className="flex gap-2">
                      <button className={`px-3 py-1.5 rounded-lg text-xs font-medium ${dm ? 'bg-[#353550] text-gray-300' : 'bg-gray-100 text-gray-600'}`} onClick={() => setDayNoteEditor(null)}>Abbrechen</button>
                      <button className="px-3 py-1.5 rounded-lg text-xs font-medium bg-indigo-600 text-white hover:bg-indigo-700" onClick={() => {
                        const text = document.getElementById('dayNoteInputDispo')?.value?.trim(); if (!text) return;
                        const icon = dayNoteEditor._icon || existing?.icon || 'ðŸ“';
                        const color = dayNoteEditor._color || existing?.color || '#6b7280';
                        if (existing) saveDayNotes(dayNotes.map(n => n.id === existing.id ? { ...n, text, icon, color } : n));
                        else saveDayNotes([...dayNotes, { id: 'dn_' + Date.now(), userId: dn.userId, date: dn.date, text, icon, color }]);
                        setDayNoteEditor(null);
                      }}>âœ“ Speichern</button>
                    </div>
                  </div>
                </div>
              </div>
            );
          })()}
        </div>
      );
    };
    return <DispositionBoard />;
  }
  
  if (showProjectPlanning || showResourceCockpit) {
    const ProjectPlanningDashboard = () => {
      const expandedPackages = ganttExpandedPackages;
      const setExpandedPackages = setGanttExpandedPackages;
      const [contextMenu, setContextMenu] = React.useState(null);
      const [draggedWP, setDraggedWP] = React.useState(null);
      const [resizingWP, setResizingWP] = React.useState(null);
      const [editingName, setEditingName] = React.useState(null);
      const [selectedWP, setSelectedWP] = React.useState(null);
      const [selectedWPs, setSelectedWPs] = React.useState([]); // Multi-Select: Array von WP-IDs
      const [lastClickedWP, setLastClickedWP] = React.useState(null); // FÃ¼r Shift-Auswahl
      const lastClickedWPRef = React.useRef(null); // Stabiler Anker-Ref
      const [hoveredWP, setHoveredWP] = React.useState(null);
      const [hoveredDep, setHoveredDep] = React.useState(null);
      const [dependencies, setDependencies] = React.useState([]);
      const [linkingFrom, setLinkingFrom] = React.useState(null);
      const [linkMousePos, setLinkMousePos] = React.useState(null);
      // Workload-Panel States die schnell wechseln (MÃœSSEN hier innen sein, sonst remounted der Parent die ganze Gantt-Ansicht)
      const [workloadContextMenu, setWorkloadContextMenu] = React.useState(null);
      const [vacationDrag, setVacationDrag] = React.useState(null);
      const [resDownDrag, setResDownDrag] = React.useState(null); // {resId, startIdx, endIdx}
      const [resDownTypePicker, setResDownTypePicker] = React.useState(null);
      const [vacationTypePicker, setVacationTypePicker] = React.useState(null);
      // sidebarWPId und filterAssigned kommen aus dem Parent-Scope
      const [showAssignments, setShowAssignments] = React.useState(true);
      const [showHours, setShowHours] = React.useState(true); // Stunden neben Balken anzeigen
      const [ganttSearch, setGanttSearch] = React.useState('');
      const [ganttSearchOpen, setGanttSearchOpen] = React.useState(false);
      const [showCriticalPath, setShowCriticalPath] = React.useState(false);
      const ganttSearchRef = React.useRef(null);
      const [previewPositions, setPreviewPositions] = React.useState({}); // Live-Preview fÃ¼r abhÃ¤ngige Balken
      const [originalPositions, setOriginalPositions] = React.useState({}); // Original-Positionen fÃ¼r Schatten
      const [baselineMenuOpen, setBaselineMenuOpen] = React.useState(false); // Baseline-Dropdown
      const [viewMenuOpen, setViewMenuOpen] = React.useState(false); // Ansicht-MenÃ¼
      const [rowDragWP, setRowDragWP] = React.useState(null); // WP das vertikal gezogen wird
      const [dropTarget, setDropTarget] = React.useState(null); // {wpId, position: 'before'|'after'|'child'}
      const [columnMenuOpen, setColumnMenuOpen] = React.useState(false); // Spalten-MenÃ¼
      // Nutze Parent-States fÃ¼r persistente Breiten
      const leftPanelWidth = ganttLeftPanelWidth;
      const setLeftPanelWidth = setGanttLeftPanelWidth;
      const columnWidths = ganttColumnWidths;
      const setColumnWidths = setGanttColumnWidths;
      if (!window._ganttResizingPanel) window._ganttResizingPanel = { active: false };
      const [isResizingPanel, _setIsResizingPanel] = React.useState(window._ganttResizingPanel.active);
      const setIsResizingPanel = (val) => { window._ganttResizingPanel.active = val; _setIsResizingPanel(val); };
      const [resizingColumn, setResizingColumn] = React.useState(null); // {key, startX, startWidth}
      // Nutze Parent-States fÃ¼r Sidebar (damit sie beim Zoom erhalten bleiben)
      const selectedProjectId = ganttSelectedProjectId;
      const setSelectedProjectId = setGanttSelectedProjectId;
      const selectedFolderId = ganttSelectedFolderId;
      const setSelectedFolderId = setGanttSelectedFolderId;
      const projectSidebarCollapsed = ganttProjectSidebarCollapsed;
      const setProjectSidebarCollapsed = setGanttProjectSidebarCollapsed;
      const [collapsedFolders, setCollapsedFolders] = React.useState({}); // Zugeklappte Ordner
      const [draggingProject, setDraggingProject] = React.useState(null); // Projekt das gezogen wird
      const [draggingFolder, setDraggingFolder] = React.useState(null); // Ordner der gezogen wird
      const [dragOverFolder, setDragOverFolder] = React.useState(null); // Ordner Ã¼ber dem gehovered wird
      const [dragOverProject, setDragOverProject] = React.useState(null); // Projekt Ã¼ber dem gehovered wird (fÃ¼r Sortierung)
      const [editingFolderId, setEditingFolderId] = React.useState(null); // Ordner der bearbeitet wird
      const [showArchive, setShowArchive] = React.useState(false); // Archiv ein-/ausblenden
      const [editingProjectId, setEditingProjectId] = React.useState(null); // Projekt umbenennen
      const [dayContextMenu, setDayContextMenu] = React.useState(null); // { x, y, date } fÃ¼r Rechtsklick auf Tag
      const [editingHoliday, setEditingHoliday] = React.useState(null); // { date, type, name } fÃ¼r Bearbeitung
      const [detailsCollapsed, setDetailsCollapsed] = [ganttDetailsCollapsed, setGanttDetailsCollapsed]; // Details-Panel - Parent-State
      const [isFloating, setIsFloating] = [detailsFloating, setDetailsFloating];
      const [floatPos, setFloatPos] = [floatingPos, setFloatingPos];
      const [floatSize, setFloatSize] = [floatingSize, setFloatingSize];
      const [viewMode, setViewMode] = [detailViewMode, setDetailViewMode];
      const originalPositionsRef = React.useRef({}); // Ref fÃ¼r Loop-freien Zugriff
      const ganttScrollRef = React.useRef(null); // Ref fÃ¼r Gantt-Scroll-Container
      const headerScrollRef = React.useRef(null); // Ref fÃ¼r Header-Scroll (synchronisiert mit ganttHScrollRef)
      
      // Globaler Scroll-Speicher (auÃŸerhalb React)
      if (!window._ganttScrollTop) window._ganttScrollTop = { value: 0, isDragging: false };
      if (!window._ganttScrollLeft) window._ganttScrollLeft = { value: Math.max(0, WEEKS_BEFORE * 7 * DAY_WIDTH - 100), initialized: false };
      const ganttHScrollRef = React.useRef(null);
      const bottomScrollRef = React.useRef(null);
      const workloadScrollRef = React.useRef(null);
      const workloadLeftRef = React.useRef(null);
      
      // Track actual gantt content width so workload can match it
      const [ganttContentWidth, setGanttContentWidth] = React.useState(0);
      
      React.useLayoutEffect(() => {
        const correctWidth = WEEKS_TO_SHOW * 7 * DAY_WIDTH;
        if (showResourceCockpit) {
          // In cockpit mode, gantt is hidden â€” use computed width
          if (ganttContentWidth !== correctWidth) setGanttContentWidth(correctWidth);
        } else if (ganttHScrollRef.current) {
          const w = ganttHScrollRef.current.scrollWidth;
          if (w !== ganttContentWidth) setGanttContentWidth(w);
        } else if (ganttContentWidth < correctWidth) {
          setGanttContentWidth(correctWidth);
        }
      });
      
      // Pick up pending WP highlight from Schnellplanung context menu
      React.useEffect(() => {
        if (pendingHighlightWP) {
          const wp = workPackages.find(w => w.id === pendingHighlightWP);
          if (wp) {
            setSelectedWP(wp);
            // Blink the bar
            setTimeout(() => {
              const bar = document.querySelector(`[data-wp-id="${wp.id}"]`);
              if (bar) {
                const glow = `0 0 12px 4px rgba(139,92,246,0.7)`;
                let blink = 0;
                const iv = setInterval(() => {
                  bar.style.boxShadow = blink % 2 === 0 ? glow : '';
                  blink++;
                  if (blink >= 7) { clearInterval(iv); bar.style.boxShadow = ''; }
                }, 250);
              }
            }, 300);
          }
          setPendingHighlightWP(null);
        }
      }, [pendingHighlightWP]);
      
      // Sync workload scroll when panel opens
      React.useEffect(() => {
        if ((workloadPanelHeight > 0 || showResourceCockpit) && workloadScrollRef.current) {
          // Ensure content width is current
          if (!showResourceCockpit && ganttHScrollRef.current) {
            setGanttContentWidth(ganttHScrollRef.current.scrollWidth);
          }
          const sync = () => {
            if (workloadScrollRef.current && window._ganttScrollLeft?.value !== undefined) {
              workloadScrollRef.current.scrollLeft = window._ganttScrollLeft.value;
            }
          };
          // Multiple retries for render timing
          sync();
          requestAnimationFrame(sync);
          setTimeout(sync, 50);
          setTimeout(sync, 150);
        }
      }, [workloadPanelHeight, ganttContentWidth, showResourceCockpit]);
      
      // Nutze Parent-States fÃ¼r Zoom und Spalten
      const zoomLevel = ganttZoomLevel;
      const changeZoom = (newLevel) => {
        // Preserve scroll ratio when zooming
        const oldDayWidth = Math.round(35 * ganttZoomLevel / 200);
        const newDayWidth = Math.round(35 * newLevel / 200);
        if (oldDayWidth > 0 && ganttHScrollRef.current) {
          const scrollLeft = ganttHScrollRef.current.scrollLeft;
          const ratio = scrollLeft / oldDayWidth;
          const newScroll = Math.round(ratio * newDayWidth);
          // Store for restoration after render
          window._zoomScrollTarget = newScroll;
        }
        setGanttZoomLevel(newLevel);
      };
      const setZoomLevel = changeZoom;
      
      // sidebarWP wird immer frisch aus workPackages geholt
      const sidebarWP = sidebarWPId ? workPackages.find(w => w.id === sidebarWPId) : null;
      
      // Sortierte Listen
      const sortedUsers = React.useMemo(() => [...users].sort((a, b) => a.name.localeCompare(b.name, 'de')), [users]);
      const sortedDivisions = React.useMemo(() => [...divisions].sort((a, b) => a.name.localeCompare(b.name, 'de')), [divisions]);
      
      // WICHTIG: Hilfsfunktionen fÃ¼r korrekte lokale Datums-Verarbeitung (keine UTC-Konvertierung!)
      const parseLocalDate = (dateStr) => {
        if (!dateStr) return null;
        if (dateStr instanceof Date) return dateStr;
        const parts = String(dateStr).split('-');
        if (parts.length !== 3) return null;
        // Setze Stunden auf 12:00 um Rundungsfehler zu vermeiden
        return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]), 12, 0, 0, 0);
      };
      
      const toLocalDateString = (date) => {
        if (!date) return '';
        const d = date instanceof Date ? date : new Date(date);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      };
      
      // Zoom-abhÃ¤ngige Breite
      const DAY_WIDTH = Math.round(35 * zoomLevel / 200);
      const ROW_HEIGHT = Math.round(32 * ganttHeightZoom / 100);
      const WEEKS_BEFORE = 12; // 12 Wochen in die Vergangenheit
      const WEEKS_FORWARD = Math.ceil(20 * 200 / zoomLevel);
      const WEEKS_TO_SHOW = WEEKS_BEFORE + WEEKS_FORWARD;
      const currentWeekNum = getWeekNumber(new Date());
      const timelineStartWeek = currentWeekNum - WEEKS_BEFORE;
      const weekNumbers = Array.from({length: WEEKS_TO_SHOW}, (_, i) => timelineStartWeek + i);
      const allDays = React.useMemo(() => {
        const days = [];
        weekNumbers.forEach(wn => { getWeekDates(wn, new Date().getFullYear()).forEach(d => days.push(d)); });
        return days;
      }, [weekNumbers.length, timelineStartWeek]);
      
      // Pre-computed day metadata â€“ avoids thousands of formatDate/getDay calls per render
      const dayMeta = React.useMemo(() => {
        const todayStr = formatDate(new Date());
        return allDays.map(day => {
          const ds = formatDate(day);
          const dow = day.getDay();
          return { day, ds, dow, isWE: dow === 0 || dow === 6, isHol: !!holidays[ds], isToday: ds === todayStr };
        });
      }, [allDays, holidays]);
      
      const wpColors = ['#6366f1', '#8b5cf6', '#ec4899', '#f43f5e', '#f97316', '#eab308', '#22c55e', '#14b8a6', '#0ea5e9', '#64748b'];
      
      const monthNames = ['Jan', 'Feb', 'MÃ¤r', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
      
      React.useEffect(() => {
        const loadDeps = async () => {
          const saved = await window.storage.get('wpDependencies', true).catch(() => null);
          if (saved) setDependencies(JSON.parse(saved.value));
        };
        loadDeps();
      }, []);
      
      // Scroll zur aktuellen Woche beim allerersten Mount
      if (!window._ganttInitScrolled) window._ganttInitScrolled = false;
      React.useEffect(() => {
        if (window._ganttInitScrolled) return;
        const scrollToToday = () => {
          const todayX = WEEKS_BEFORE * 7 * DAY_WIDTH;
          const scrollTarget = Math.max(0, todayX - 100);
          if (ganttHScrollRef.current) {
            ganttHScrollRef.current.scrollLeft = scrollTarget;
            window._ganttScrollLeft.value = scrollTarget;
            window._ganttInitScrolled = true;
          }
          if (headerScrollRef.current) {
            headerScrollRef.current.scrollLeft = scrollTarget;
            if (bottomScrollRef.current) bottomScrollRef.current.scrollLeft = scrollTarget;
          }
          if (workloadScrollRef.current) workloadScrollRef.current.scrollLeft = scrollTarget;
          window._ganttScrollLeft.value = scrollTarget;
          window._ganttInitScrolled = true;
        };
        requestAnimationFrame(scrollToToday);
        setTimeout(scrollToToday, 100);
        setTimeout(scrollToToday, 300);
      }, [DAY_WIDTH]);
      
      const saveDependencies = (deps) => {
        pushUndo();
        setDependencies(deps);
        window.storage.set('wpDependencies', JSON.stringify(deps), true);
      };
      
      // Hilfsfunktionen fÃ¼r Wochenend- und Feiertags-Berechnung
      const isWeekendDay = (date) => {
        const d = parseLocalDate(date) || new Date(date);
        return d.getDay() === 0 || d.getDay() === 6; // 0 = Sonntag, 6 = Samstag
      };
      
      // PrÃ¼ft ob ein Tag ein freier Tag ist (Wochenende ODER Feiertag)
      const isNonWorkDay = (date, allowWeekend = false) => {
        const d = parseLocalDate(date) || new Date(date);
        const dateStr = toLocalDateString(d);
        // Feiertag prÃ¼fen
        if (holidays[dateStr]) return true;
        // Wochenende prÃ¼fen (auÃŸer wenn erlaubt)
        if (!allowWeekend && isWeekendDay(d)) return true;
        return false;
      };
      
      const addWorkingDays = (startDate, days, allowWeekend) => {
        const result = parseLocalDate(startDate) || new Date(startDate);
        let remaining = days;
        
        if (allowWeekend && Object.keys(holidays).length === 0) {
          // Nur wenn keine Feiertage definiert sind, einfache Berechnung
          result.setDate(result.getDate() + days);
          return result;
        }
        
        while (remaining > 0) {
          result.setDate(result.getDate() + 1);
          if (!isNonWorkDay(result, allowWeekend)) {
            remaining--;
          }
        }
        return result;
      };
      
      const countWorkingDays = (startDate, endDate, allowWeekend) => {
        const start = parseLocalDate(startDate) || new Date(startDate);
        const end = parseLocalDate(endDate) || new Date(endDate);
        
        if (allowWeekend && Object.keys(holidays).length === 0) {
          return Math.ceil((end - start) / (1000 * 60 * 60 * 24));
        }
        
        let count = 0;
        const current = new Date(start);
        
        while (current <= end) {
          if (!isNonWorkDay(current, allowWeekend)) {
            count++;
          }
          current.setDate(current.getDate() + 1);
        }
        return count;
      };
      
      // Springt Ã¼ber freie Tage (Wochenende + Feiertage)
      const skipNonWorkDays = (date, forward = true, allowWeekend = false) => {
        const d = parseLocalDate(date) || new Date(date);
        while (isNonWorkDay(d, allowWeekend)) {
          d.setDate(d.getDate() + (forward ? 1 : -1));
        }
        return d;
      };
      
      const skipWeekend = (date, forward = true) => {
        const d = parseLocalDate(date) || new Date(date);
        while (isWeekendDay(d)) {
          d.setDate(d.getDate() + (forward ? 1 : -1));
        }
        return d;
      };
      
      // Baseline-Funktionen
      const createBaseline = (name) => {
        if (!selectedProjectId) {
          alert('Bitte wÃ¤hlen Sie zuerst ein einzelnes Projekt aus, um eine Baseline zu erstellen.');
          return null;
        }
        const projectWPs = workPackages.filter(wp => wp.projectId === selectedProjectId);
        const baseline = {
          id: `baseline_${Date.now()}`,
          projectId: selectedProjectId,
          name: name || `Baseline ${new Date().toLocaleDateString('de-DE')} ${new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })}`,
          createdAt: new Date().toISOString(),
          workPackages: projectWPs.map(wp => ({ id: wp.id, startDate: wp.startDate, endDate: wp.endDate }))
        };
        const newBaselines = [...baselines, baseline];
        setBaselines(newBaselines);
        window.storage.set('wpBaselines', JSON.stringify(newBaselines), true);
        return baseline;
      };
      
      const deleteBaseline = (baselineId) => {
        const newBaselines = baselines.filter(b => b.id !== baselineId);
        setBaselines(newBaselines);
        window.storage.set('wpBaselines', JSON.stringify(newBaselines), true);
        if (activeBaseline?.id === baselineId) setActiveBaseline(null);
      };
      
      const loadBaseline = (baselineId) => {
        const baseline = baselines.find(b => b.id === baselineId);
        if (baseline) {
          setActiveBaseline(activeBaseline?.id === baselineId ? null : baseline);
        }
      };
      
      const restoreBaseline = (baselineId) => {
        const baseline = baselines.find(b => b.id === baselineId);
        if (baseline) {
          const updated = workPackages.map(wp => {
            const savedWP = baseline.workPackages.find(bwp => bwp.id === wp.id);
            if (savedWP) {
              return { ...wp, startDate: savedWP.startDate, endDate: savedWP.endDate };
            }
            return wp;
          });
          saveWorkPackages(updated);
          setActiveBaseline(null);
        }
      };
      
      const getChildren = (wpId, allWPs) => allWPs.filter(wp => wp.parentId === wpId).sort((a, b) => (a.order || 0) - (b.order || 0));
      
      const getAllDescendants = (wpId, allWPs) => {
        const children = getChildren(wpId, allWPs);
        let descendants = [...children];
        children.forEach(child => { descendants = [...descendants, ...getAllDescendants(child.id, allWPs)]; });
        return descendants;
      };
      
      // Done-Status: FÃ¼r Eltern = alle Kinder done, fÃ¼r BlÃ¤tter = wp.done flag
      const isWPDone = (wpId, allWPs) => {
        const children = getChildren(wpId, allWPs);
        if (children.length === 0) {
          const wp = allWPs.find(w => w.id === wpId);
          return wp?.done || false;
        }
        return children.every(c => isWPDone(c.id, allWPs));
      };
      
      // Fortschritt: Anteil der erledigten Kinder (rekursiv auf Blatt-Ebene)
      const getWPProgress = (wpId, allWPs) => {
        const children = getChildren(wpId, allWPs);
        if (children.length === 0) {
          const wp = allWPs.find(w => w.id === wpId);
          return { done: wp?.done ? 1 : 0, total: 1 };
        }
        let done = 0, total = 0;
        children.forEach(c => { const p = getWPProgress(c.id, allWPs); done += p.done; total += p.total; });
        return { done, total };
      };
      
      const toggleWPDone = React.useCallback((wpId) => {
        const wp = workPackages.find(w => w.id === wpId);
        if (!wp) return;
        const children = getChildren(wpId, workPackages);
        if (children.length > 0) {
          // Toggle all descendants
          const allDone = isWPDone(wpId, workPackages);
          const descendants = getAllDescendants(wpId, workPackages);
          const leafIds = descendants.filter(d => getChildren(d.id, workPackages).length === 0).map(d => d.id);
          // If no leaf children, also include direct children
          if (leafIds.length === 0) return;
          const updated = workPackages.map(w => leafIds.includes(w.id) ? { ...w, done: !allDone } : w);
          saveWorkPackages(updated);
        } else {
          const updated = workPackages.map(w => w.id === wpId ? { ...w, done: !w.done } : w);
          saveWorkPackages(updated);
        }
      }, [workPackages]);
      
      const calculateDatesFromChildren = (wpId, allWPs) => {
        const getAllLeafDates = (id) => {
          const children = getChildren(id, allWPs);
          if (children.length === 0) {
            const wp = allWPs.find(w => w.id === id);
            return wp ? [{ start: wp.startDate, end: wp.endDate }] : [];
          }
          return children.flatMap(child => getAllLeafDates(child.id));
        };
        const dates = getAllLeafDates(wpId);
        if (dates.length === 0) return null;
        const validDates = dates.filter(d => d.start && d.end);
        if (validDates.length === 0) return null;
        const starts = validDates.map(d => new Date(d.start));
        const ends = validDates.map(d => new Date(d.end));
        return { startDate: formatDate(new Date(Math.min(...starts))), endDate: formatDate(new Date(Math.max(...ends))) };
      };
      
      const calculateTotalHours = (wpId) => {
        const wp = workPackages.find(w => w.id === wpId);
        if (!wp) return 0;
        const children = getChildren(wpId, workPackages);
        if (children.length === 0) return wp.plannedHours || 0;
        return children.reduce((sum, child) => sum + calculateTotalHours(child.id), 0);
      };
      
      const calculateAssignedHours = (wp) => {
        if (!wp) return 0;
        const respHours = (wp.responsibles || []).reduce((sum, r) => sum + (typeof r === 'object' ? (r.hours || 0) : 0), 0);
        const editHours = (wp.editors || []).reduce((sum, e) => sum + (typeof e === 'object' ? (e.hours || 0) : 0), 0);
        const resHours = (wp.resourceIds || []).reduce((sum, rid) => sum + ((wp.resourceHours || {})[rid] || 0), 0);
        return respHours + editHours + resHours;
      };
      
      const getAssignmentText = (wp) => {
        const assignments = [];
        (wp.responsibles || []).forEach(r => {
          const userId = typeof r === 'object' ? r.userId : r;
          const hours = typeof r === 'object' ? r.hours : 0;
          const user = users.find(u => u.id === userId);
          if (user) {
            const nameParts = user.name.split(' ');
            const shortName = nameParts.length > 1 ? `${nameParts[0][0]}.${nameParts[nameParts.length-1]}` : user.name;
            assignments.push(hours > 0 ? `${shortName} ${hours}h` : shortName);
          }
        });
        (wp.editors || []).forEach(e => {
          const userId = typeof e === 'object' ? e.userId : e;
          const hours = typeof e === 'object' ? e.hours : 0;
          const user = users.find(u => u.id === userId);
          if (user) {
            const nameParts = user.name.split(' ');
            const shortName = nameParts.length > 1 ? `${nameParts[0][0]}.${nameParts[nameParts.length-1]}` : user.name;
            if (!assignments.some(a => a.startsWith(shortName.split(' ')[0]))) {
              assignments.push(hours > 0 ? `${shortName} ${hours}h` : shortName);
            }
          }
        });
        // Resource assignments
        (wp.resourceIds || []).forEach(resId => {
          const res = resources.find(r => r.id === resId);
          if (res) {
            const resH = (wp.resourceHours || {})[resId] || 0;
            assignments.push(resH > 0 ? `${res.kuerzel || res.name} ${resH}h` : (res.kuerzel || res.name));
          }
        });
        return assignments.join(', ');
      };
      
      // Workload-Berechnung: Stunden pro Person pro Tag
      const calculateWorkload = React.useMemo(() => {
        const workload = {}; // { userId: { 'YYYY-MM-DD': { total: X, details: [{wpName, hours}] } } }
        
        workPackages.forEach(wp => {
          if (!wp.startDate || !wp.endDate) return;
          const hasChildren = workPackages.some(w => w.parentId === wp.id);
          if (hasChildren) return; // Nur Blatt-Pakete
          
          // Sammle alle Zuweisungen (responsibles + editors)
          const allAssignments = [
            ...((wp.responsibles || []).map(r => typeof r === 'object' ? r : { userId: r, hours: 0 })),
            ...((wp.editors || []).map(e => typeof e === 'object' ? e : { userId: e, hours: 0 }))
          ];
          
          if (allAssignments.length === 0) return;
          
          // Arbeitstage im WP berechnen
          const start = parseLocalDate(wp.startDate);
          const end = parseLocalDate(wp.endDate);
          const workDays = [];
          const d = new Date(start);
          while (d <= end) {
            const dow = d.getDay();
            const ds = formatDate(d);
            const isHoliday = holidays[ds];
            if (dow !== 0 && dow !== 6 && !isHoliday) {
              workDays.push(ds);
            } else if (wp.allowWeekend && dow !== 0 && dow !== 6) {
              workDays.push(ds);
            }
            d.setDate(d.getDate() + 1);
          }
          
          if (workDays.length === 0) return;
          
          allAssignments.forEach(assignment => {
            const userId = assignment.userId;
            const totalHours = assignment.hours || 0;
            if (totalHours <= 0) return;
            
            if (!workload[userId]) workload[userId] = {};
            
            // dailyOverrides prÃ¼fen
            const overrides = wp.dailyOverrides?.[userId];
            const hoursPerDay = totalHours / workDays.length;
            
            workDays.forEach(day => {
              const dayHours = overrides?.[day] !== undefined ? overrides[day] : hoursPerDay;
              if (!workload[userId][day]) workload[userId][day] = { total: 0, details: [] };
              workload[userId][day].total += dayHours;
              workload[userId][day].details.push({ wpName: wp.name, hours: dayHours, wpId: wp.id, color: wp.color });
            });
          });
        });
        
        // === Integrate Team Dashboard tasks (Schnellplanung) into workload ===
        tasks.forEach(t => {
          if (!t.userId || !t.startDate || !t.projectId) return;
          const project = projects.find(p => p.id === t.projectId);
          if (!project) return;
          
          const start = parseLocalDate(t.startDate);
          const end = parseLocalDate(t.endDate || t.startDate);
          const d = new Date(start);
          while (d <= end) {
            const dow = d.getDay();
            const ds = formatDate(d);
            if (dow !== 0 && dow !== 6 && !holidays[ds]) {
              // Use net hours (after break deduction) to match Schnellplanung display
              const dayHours = calculateDayNetHours(t.userId, d, t.startHour || 0, t.endHour || 0);
              if (dayHours > 0) {
                if (!workload[t.userId]) workload[t.userId] = {};
                if (!workload[t.userId][ds]) workload[t.userId][ds] = { total: 0, details: [] };
                workload[t.userId][ds].total += dayHours;
                workload[t.userId][ds].details.push({ 
                  wpName: project.name, 
                  hours: dayHours, 
                  source: 'planning', 
                  projectId: t.projectId, 
                  color: project.color || '#94a3b8' 
                });
              }
            }
            d.setDate(d.getDate() + 1);
          }
        });
        
        // === Integrate Disposition entries into workload ===
        dispositions.forEach(d => {
          if (!d.userId || !d.date || d.type === 'urlaub' || d.type === 'frei' || d.type === 'krank') return;
          const userId = d.userId;
          if (!workload[userId]) workload[userId] = {};
          if (!workload[userId][d.date]) workload[userId][d.date] = { total: 0, details: [] };
          // Check if this project already has hours from WP or Schnellplanung on this day
          const alreadyHasProject = d.projectId && workload[userId][d.date].details.some(det => det.projectId === d.projectId || det.wpName === d.label);
          if (!alreadyHasProject) {
            // Default 8h workday for dispo entries without specific hours
            const dayHours = d.hours || 8;
            workload[userId][d.date].total += dayHours;
            workload[userId][d.date].details.push({
              wpName: d.label || 'Disposition',
              hours: dayHours,
              source: 'disposition',
              projectId: d.projectId,
              color: d.color || '#6366f1'
            });
          }
        });
        
        return workload;
      }, [workPackages, holidays, tasks, projects, users, dispositions]);
      
      // TageskapazitÃ¤t einer Ressource (Schichten Ã— Stunden pro Schicht)
      const getResourceDailyCapacity = (res) => (res.schichtmodell || 1) * (res.stundenProSchicht || 8);
      
      // Stunden einer Ressource fÃ¼r ein WP
      const getResourceHours = (wp, resId) => (wp.resourceHours || {})[resId] || 0;
      
      // Workload-Berechnung fÃ¼r Ressourcen (analog zu MA)
      const calculateResourceWorkload = React.useMemo(() => {
        const workload = {}; // { resId: { 'YYYY-MM-DD': { total: X, details: [{wpName, hours, wpId, color}] } } }
        
        workPackages.forEach(wp => {
          if (!wp.startDate || !wp.endDate) return;
          const hasChildren = workPackages.some(w => w.parentId === wp.id);
          if (hasChildren) return;
          
          const resIds = wp.resourceIds || [];
          if (resIds.length === 0) return;
          
          const start = parseLocalDate(wp.startDate);
          const end = parseLocalDate(wp.endDate);
          const workDays = [];
          const d = new Date(start);
          while (d <= end) {
            const dow = d.getDay();
            const ds = formatDate(d);
            const isHoliday = holidays[ds];
            if (dow !== 0 && dow !== 6 && !isHoliday) {
              workDays.push(ds);
            } else if (wp.allowWeekend && dow !== 0 && dow !== 6) {
              workDays.push(ds);
            }
            d.setDate(d.getDate() + 1);
          }
          if (workDays.length === 0) return;
          
          resIds.forEach(resId => {
            const totalHours = (wp.resourceHours || {})[resId] || 0;
            if (totalHours <= 0) return;
            
            if (!workload[resId]) workload[resId] = {};
            
            const overrides = wp.resourceDailyOverrides?.[resId];
            // Active days (respect overrides)
            const activeDays = workDays.filter(day => overrides?.[day] !== false);
            if (activeDays.length === 0) return;
            const hoursPerDay = totalHours / activeDays.length;
            
            activeDays.forEach(day => {
              if (!workload[resId][day]) workload[resId][day] = { total: 0, details: [] };
              workload[resId][day].total += hoursPerDay;
              workload[resId][day].details.push({ wpName: wp.name, hours: hoursPerDay, wpId: wp.id, color: wp.color || projects.find(p => p.id === wp.projectId)?.color || '#6366f1' });
            });
          });
        });
        
        return workload;
      }, [workPackages, holidays, projects]);
      
      const isUserAssigned = (assignments, userId) => {
        if (!assignments) return false;
        return assignments.some(a => (typeof a === 'object' ? a.userId : a) === userId);
      };
      
      const getUserHours = (assignments, userId) => {
        if (!assignments) return 0;
        const found = assignments.find(a => (typeof a === 'object' ? a.userId : a) === userId);
        return found && typeof found === 'object' ? (found.hours || 0) : 0;
      };
      
      // Alle WPs eines Users (Blatt-Pakete mit Zuweisung und Stunden)
      const getUserWorkPackages = (userId) => {
        const wps = workPackages.filter(wp => {
          if (!wp.startDate || !wp.endDate) return false;
          const hasChildren = workPackages.some(w => w.parentId === wp.id);
          if (hasChildren) return false;
          const allAssign = [
            ...((wp.responsibles || []).map(r => typeof r === 'object' ? r : { userId: r, hours: 0 })),
            ...((wp.editors || []).map(e => typeof e === 'object' ? e : { userId: e, hours: 0 }))
          ];
          return allAssign.some(a => a.userId === userId && a.hours > 0);
        });
        // Sort by startDate to match Gantt timeline order
        return wps.sort((a, b) => {
          if (a.startDate && b.startDate) return a.startDate.localeCompare(b.startDate);
          return 0;
        });
      };
      
      // Unique projects from Team Dashboard tasks for a given user
      const getUserPlanningProjects = (userId) => {
        const userTasks = tasks.filter(t => t.userId === userId && t.projectId);
        const projectMap = {};
        userTasks.forEach(t => {
          if (!projectMap[t.projectId]) {
            const project = projects.find(p => p.id === t.projectId);
            if (project) {
              // Calculate date range and net hours (after break deduction)
              const projTasks = userTasks.filter(ut => ut.projectId === t.projectId);
              const allDates = projTasks.flatMap(ut => [ut.startDate, ut.endDate || ut.startDate]).sort();
              let totalHours = 0;
              projTasks.forEach(ut => {
                const tStart = new Date(ut.startDate + 'T12:00:00');
                const tEnd = new Date((ut.endDate || ut.startDate) + 'T12:00:00');
                const td = new Date(tStart);
                while (td <= tEnd) {
                  const dow = td.getDay();
                  const tds = formatDate(td);
                  if (dow !== 0 && dow !== 6 && !holidays[tds]) {
                    totalHours += calculateDayNetHours(userId, td, ut.startHour || 0, ut.endHour || 0);
                  }
                  td.setDate(td.getDate() + 1);
                }
              });
              projectMap[t.projectId] = {
                id: 'plan_' + t.projectId,
                projectId: t.projectId,
                name: project.name,
                color: project.color || '#94a3b8',
                startDate: allDates[0],
                endDate: allDates[allDates.length - 1],
                totalHours: totalHours,
                source: 'planning'
              };
            }
          }
        });
        return Object.values(projectMap).sort((a, b) => a.startDate.localeCompare(b.startDate));
      };
      
      // Arbeitstage eines WPs berechnen
      const getWPWorkDays = (wp) => {
        const start = parseLocalDate(wp.startDate);
        const end = parseLocalDate(wp.endDate);
        const days = [];
        const d = new Date(start);
        while (d <= end) {
          const dow = d.getDay();
          const ds = formatDate(d);
          if (dow !== 0 && dow !== 6 && !holidays[ds]) days.push(ds);
          d.setDate(d.getDate() + 1);
        }
        return days;
      };
      
      // Aktive Tage eines Users fÃ¼r ein WP ermitteln
      const getActiveDaysForWP = (wp, userId) => {
        const workDays = getWPWorkDays(wp);
        const overrides = wp.dailyOverrides?.[userId];
        if (!overrides || Object.keys(overrides).length === 0) return workDays; // alle aktiv
        return workDays.filter(d => (overrides[d] ?? -1) > 0);
      };
      
      // Tag togglen: Stunden gleichmÃ¤ÃŸig auf aktive Tage verteilen
      const toggleWPDayForUser = (wpId, userId, dayStr) => {
        const wp = workPackages.find(w => w.id === wpId);
        if (!wp) return;
        const allAssign = [
          ...((wp.responsibles || []).map(r => typeof r === 'object' ? r : { userId: r, hours: 0 })),
          ...((wp.editors || []).map(e => typeof e === 'object' ? e : { userId: e, hours: 0 }))
        ];
        const assignment = allAssign.find(a => a.userId === userId);
        if (!assignment || !assignment.hours) return;
        const totalHours = assignment.hours;
        const workDays = getWPWorkDays(wp);
        if (!workDays.includes(dayStr)) return;
        
        // Aktuelle Overrides holen oder initialisieren
        const current = { ...(wp.dailyOverrides?.[userId] || {}) };
        if (Object.keys(current).length === 0) {
          const hpd = totalHours / workDays.length;
          workDays.forEach(d => { current[d] = hpd; });
        }
        
        // Toggle
        const isActive = (current[dayStr] || 0) > 0;
        current[dayStr] = isActive ? 0 : 1; // temporÃ¤r
        
        // Aktive Tage und Neuverteilung
        const activeDays = workDays.filter(d => current[d] > 0);
        if (activeDays.length === 0) return; // mindestens 1 Tag muss aktiv sein
        
        const hpd = totalHours / activeDays.length;
        workDays.forEach(d => { current[d] = activeDays.includes(d) ? hpd : 0; });
        
        const newOverrides = { ...(wp.dailyOverrides || {}), [userId]: current };
        updateWorkPackage(wpId, 'dailyOverrides', newOverrides);
      };
      
      // Verschiebt alle dailyOverrides-Datums-Keys um daysDiff Tage
      const shiftDailyOverrides = (dailyOverrides, daysDiff) => {
        if (!dailyOverrides || daysDiff === 0) return dailyOverrides;
        const shifted = {};
        Object.entries(dailyOverrides).forEach(([userId, dayMap]) => {
          if (!dayMap || typeof dayMap !== 'object') { shifted[userId] = dayMap; return; }
          const newDayMap = {};
          Object.entries(dayMap).forEach(([dateStr, hours]) => {
            const d = parseLocalDate(dateStr);
            d.setDate(d.getDate() + daysDiff);
            newDayMap[formatDate(d)] = hours;
          });
          shifted[userId] = newDayMap;
        });
        return shifted;
      };
      
      // GleichmÃ¤ÃŸige Verteilung: dailyOverrides fÃ¼r User lÃ¶schen â†’ Fallback auf Default
      const resetDailyOverrides = (wpId, userId) => {
        const wp = workPackages.find(w => w.id === wpId);
        if (!wp || !wp.dailyOverrides) return;
        const newOverrides = { ...wp.dailyOverrides };
        delete newOverrides[userId];
        updateWorkPackage(wpId, 'dailyOverrides', Object.keys(newOverrides).length > 0 ? newOverrides : undefined);
      };
      
      // Ressourcen-Workload: WPs die einer Ressource zugewiesen sind
      const getResourceWorkPackages = (resId) => {
        return workPackages.filter(wp => {
          if (!wp.startDate || !wp.endDate) return false;
          if (workPackages.some(w => w.parentId === wp.id)) return false;
          return (wp.resourceIds || []).includes(resId);
        }).sort((a, b) => (a.startDate || '').localeCompare(b.startDate || ''));
      };
      
      // Aktive Tage einer Ressource fÃ¼r ein WP
      const getActiveDaysForResource = (wp, resId) => {
        const workDays = getWPWorkDays(wp);
        const overrides = wp.resourceDailyOverrides?.[resId];
        if (!overrides || Object.keys(overrides).length === 0) return workDays;
        return workDays.filter(d => overrides[d] !== false);
      };
      
      // Tag togglen fÃ¼r Ressource (kein Stunden-Redistribution, nur an/aus)
      const toggleWPDayForResource = (wpId, resId, dayStr) => {
        const wp = workPackages.find(w => w.id === wpId);
        if (!wp) return;
        const workDays = getWPWorkDays(wp);
        if (!workDays.includes(dayStr)) return;
        const current = { ...(wp.resourceDailyOverrides?.[resId] || {}) };
        // Toggle: false=off, undefined/true=on
        const isActive = current[dayStr] !== false;
        current[dayStr] = isActive ? false : undefined;
        // Clean up: remove undefined entries
        Object.keys(current).forEach(k => { if (current[k] === undefined) delete current[k]; });
        const activeDays = workDays.filter(d => current[d] !== false);
        if (activeDays.length === 0) return; // mindestens 1 Tag aktiv
        const newOverrides = { ...(wp.resourceDailyOverrides || {}), [resId]: Object.keys(current).length > 0 ? current : undefined };
        // Clean up empty
        Object.keys(newOverrides).forEach(k => { if (!newOverrides[k]) delete newOverrides[k]; });
        updateWorkPackage(wpId, 'resourceDailyOverrides', Object.keys(newOverrides).length > 0 ? newOverrides : undefined);
      };
      
      // Scroll zum Arbeitspaket im Gantt-Diagramm
      const scrollToWPInGantt = (wpId) => {
        const wp = workPackages.find(w => w.id === wpId);
        if (!wp) return;
        
        // Projektfilter anpassen falls nÃ¶tig
        if (selectedProjectId && selectedProjectId !== wp.projectId) {
          setSelectedProjectId(null); setSelectedFolderId(null);
        } else if (selectedFolderId) {
          const proj = projects.find(p => p.id === wp.projectId);
          if (proj && proj.folderId !== selectedFolderId) { setSelectedProjectId(null); setSelectedFolderId(null); }
        }
        // Alle Eltern-Pakete aufklappen
        const parentsToExpand = {};
        let pId = wp.parentId;
        while (pId) { parentsToExpand[pId] = true; const p = workPackages.find(w => w.id === pId); pId = p?.parentId; }
        if (Object.keys(parentsToExpand).length > 0) setExpandedPackages(prev => ({ ...prev, ...parentsToExpand }));
        // Only highlight, don't open sidebar details
        setSelectedWP(wp);
        
        // Polling: Zeile im DOM finden und hinscrollen
        let n = 0;
        const go = () => {
          n++;
          const row = document.querySelector('[data-wp-row="' + wpId + '"]') || document.querySelector('[data-wp-row-right="' + wpId + '"]');
          if (row) {
            // scrollIntoView auf das Flow-Element (nicht den absoluten Balken)
            row.scrollIntoView({ block: 'center', behavior: 'instant' });
            // 3-fach Blink-Highlight auf dem Gantt-Balken
            setTimeout(() => {
              const bar = document.querySelector('[data-wp-id="' + wpId + '"]');
              if (bar) {
                let blink = 0;
                const glow = '0 0 0 3px #6366f1, 0 0 12px 4px rgba(99,102,241,0.4)';
                bar.style.transition = 'box-shadow 0.15s';
                const doBlink = () => {
                  bar.style.boxShadow = blink % 2 === 0 ? glow : '';
                  blink++;
                  if (blink < 7) { // 3x an, 3x aus, 1x final an
                    setTimeout(doBlink, 200);
                  } else {
                    // Final glow kurz stehen lassen, dann ausblenden
                    bar.style.boxShadow = glow;
                    setTimeout(() => { bar.style.transition = 'box-shadow 0.5s'; bar.style.boxShadow = ''; }, 800);
                  }
                };
                doBlink();
              }
            }, 50);
          } else if (n < 25) {
            setTimeout(go, 80);
          }
        };
        setTimeout(go, 50);
      };
      
      // Ressourcen-Feinplanung: Workload Ã¶ffnen, auf beteiligte User filtern
      const showWPResourcePlanning = (wpId) => {
        const wp = workPackages.find(w => w.id === wpId);
        if (!wp) return;
        const userIds = [...new Set([
          ...((wp.responsibles || []).map(a => typeof a === 'object' ? a.userId : a)),
          ...((wp.editors || []).map(a => typeof a === 'object' ? a.userId : a))
        ])];
        // Ressourcen Ã¼ber resourceIds direkt und zusÃ¤tzlich Ã¼ber divisionIds (KompatibilitÃ¤t)
        const wpDivIds = wp.divisionIds || [];
        const wpResIds = wp.resourceIds || [];
        const divResourceIds = resources.filter(r => r.abteilungId && wpDivIds.includes(r.abteilungId)).map(r => r.id);
        const resourceIds = [...new Set([...wpResIds, ...divResourceIds])];
        
        if (userIds.length === 0 && resourceIds.length === 0) {
          // Nichts zugewiesen â†’ Sidebar Ã¶ffnen zum Zuweisen
          setSidebarWPId(wpId);
          return;
        }
        // Workload Panel Ã¶ffnen
        if (workloadPanelHeight === 0) setWorkloadPanelHeight(Math.round(window.innerHeight * 0.5));
        // Filter auf MA + Ressourcen setzen
        setWorkloadFilter('ma_ressourcen');
        setWlFocusWP({ wpId: wp.id, wpName: wp.name, userIds, resourceIds, color: wp.color || projects.find(p => p.id === wp.projectId)?.color || '#6366f1' });
        // User aufklappen
        setWorkloadExpandedUsers(prev => {
          const next = { ...prev };
          userIds.forEach(uid => { next[uid] = true; });
          resourceIds.forEach(rid => { next['res_' + rid] = true; });
          return next;
        });
      };
      
      const toggleUserAssignment = React.useCallback((wpId, field, userId, isChecked, hours = 0) => {
        const wp = workPackages.find(w => w.id === wpId);
        if (!wp) return;
        let current = wp[field] || [];
        current = current.map(a => typeof a === 'object' ? a : { userId: a, hours: 0 });
        let updated;
        if (isChecked) {
          if (!current.some(a => a.userId === userId)) {
            updated = [...current, { userId, hours }];
          } else {
            updated = current;
          }
        } else {
          updated = current.filter(a => a.userId !== userId);
        }
        const newWPs = workPackages.map(w => w.id === wpId ? { ...w, [field]: updated } : w);
        saveWorkPackages(newWPs);
      }, [workPackages]);
      
      const updateUserHours = React.useCallback((wpId, field, userId, hours) => {
        const wp = workPackages.find(w => w.id === wpId);
        if (!wp) return;
        let current = wp[field] || [];
        current = current.map(a => typeof a === 'object' ? a : { userId: a, hours: 0 });
        const updated = current.map(a => a.userId === userId ? { ...a, hours } : a);
        const newWPs = workPackages.map(w => w.id === wpId ? { ...w, [field]: updated } : w);
        saveWorkPackages(newWPs);
      }, [workPackages]);
      
      const getFlatSortedList = (projectId) => {
        const projectWPs = workPackages.filter(wp => wp.projectId === projectId);
        const result = [];
        const addWithChildren = (parentId, level, parentIsLastPath = []) => {
          const children = projectWPs.filter(wp => wp.parentId === parentId).sort((a, b) => (a.order || 0) - (b.order || 0));
          children.forEach((wp, idx) => {
            const hasChildren = projectWPs.some(w => w.parentId === wp.id);
            const isExpanded = expandedPackages[wp.id] !== false;
            const isLastChild = idx === children.length - 1;
            result.push({ ...wp, _level: level, _hasChildren: hasChildren, _isLastChild: isLastChild, _parentIsLastPath: [...parentIsLastPath] });
            if (hasChildren && isExpanded) addWithChildren(wp.id, level + 1, [...parentIsLastPath, isLastChild]);
          });
        };
        addWithChildren(null, 0);
        return result;
      };
      
      // Maximale Tiefe der Hierarchie berechnen
      const getMaxLevel = () => {
        let max = 0;
        const countLevel = (parentId, level) => {
          const children = workPackages.filter(w => w.parentId === parentId && workPackages.some(c => c.parentId === w.id));
          if (children.length > 0) {
            if (level + 1 > max) max = level + 1;
            children.forEach(c => countLevel(c.id, level + 1));
          }
        };
        workPackages.filter(w => !w.parentId).forEach(w => {
          if (workPackages.some(c => c.parentId === w.id)) { max = Math.max(max, 0); countLevel(w.id, 0); }
        });
        return max;
      };
      
      // Aktuelle Aufklapp-Tiefe ermitteln
      const getCurrentExpandLevel = () => {
        const maxLvl = getMaxLevel();
        for (let lvl = 0; lvl <= maxLvl; lvl++) {
          const parentsAtLevel = workPackages.filter(wp => {
            const getLevel = (id, l) => { const parent = workPackages.find(w => w.id === id)?.parentId; return parent ? getLevel(parent, l + 1) : l; };
            return getLevel(wp.id, 0) === lvl && workPackages.some(c => c.parentId === wp.id);
          });
          if (parentsAtLevel.some(wp => expandedPackages[wp.id] === false)) return lvl;
        }
        return maxLvl + 1;
      };
      
      // Eine Ebene mehr aufklappen
      const expandOneLevel = () => {
        const targetLevel = getCurrentExpandLevel();
        const newExpanded = { ...expandedPackages };
        workPackages.forEach(wp => {
          if (!workPackages.some(c => c.parentId === wp.id)) return;
          const getLevel = (id, l) => { const parent = workPackages.find(w => w.id === id)?.parentId; return parent ? getLevel(parent, l + 1) : l; };
          const lvl = getLevel(wp.id, 0);
          if (lvl <= targetLevel) newExpanded[wp.id] = true;
        });
        setExpandedPackages(newExpanded);
      };
      
      // Eine Ebene zuklappen
      const collapseOneLevel = () => {
        const currentLevel = getCurrentExpandLevel();
        const targetLevel = Math.max(0, currentLevel - 1);
        const newExpanded = { ...expandedPackages };
        workPackages.forEach(wp => {
          if (!workPackages.some(c => c.parentId === wp.id)) return;
          const getLevel = (id, l) => { const parent = workPackages.find(w => w.id === id)?.parentId; return parent ? getLevel(parent, l + 1) : l; };
          const lvl = getLevel(wp.id, 0);
          if (lvl >= targetLevel) newExpanded[wp.id] = false;
        });
        setExpandedPackages(newExpanded);
      };
      
      // Auf bestimmte Ebene aufklappen
      const expandToLevel = (targetLevel) => {
        const newExpanded = { ...expandedPackages };
        workPackages.forEach(wp => {
          if (!workPackages.some(c => c.parentId === wp.id)) return;
          const getLevel = (id, l) => { const parent = workPackages.find(w => w.id === id)?.parentId; return parent ? getLevel(parent, l + 1) : l; };
          const lvl = getLevel(wp.id, 0);
          newExpanded[wp.id] = lvl < targetLevel;
        });
        setExpandedPackages(newExpanded);
      };
      
      const dateToX = (dateStr) => {
        if (!dateStr) return 0;
        // Verwende parseLocalDate fÃ¼r konsistente Datums-Verarbeitung
        const date = parseLocalDate(dateStr);
        if (!date) return 0;
        const startOfTimeline = getWeekDates(timelineStartWeek, new Date().getFullYear())[0];
        return Math.round((date - startOfTimeline) / (1000 * 60 * 60 * 24)) * DAY_WIDTH;
      };
      
      const xToDate = (x) => {
        const startOfTimeline = getWeekDates(timelineStartWeek, new Date().getFullYear())[0];
        const days = Math.floor(x / DAY_WIDTH);
        const date = new Date(startOfTimeline);
        date.setDate(date.getDate() + days);
        return formatDate(date);
      };
      
      const addWorkPackage = (projectId, parentId = null, customStartDate = null) => {
        const siblings = workPackages.filter(wp => wp.projectId === projectId && wp.parentId === parentId);
        const maxOrder = siblings.length > 0 ? Math.max(...siblings.map(s => s.order || 0)) : 0;
        // Bei Tochter-Arbeitspaketen: Startdatum des Eltern-WPs Ã¼bernehmen
        const parentWP = parentId ? workPackages.find(w => w.id === parentId) : null;
        const baseDate = customStartDate || (parentWP?.startDate) || null;
        const startDate = baseDate ? new Date(baseDate + 'T12:00:00') : new Date();
        const endDate = new Date(startDate);
        endDate.setDate(endDate.getDate() + 4); // Standard: 5 Tage
        const newWP = {
          id: `wp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
          projectId, parentId, name: 'Neues Arbeitspaket',
          startDate: formatDate(startDate), endDate: formatDate(endDate),
          order: maxOrder + 1, color: '#6366f1', responsibles: [], editors: [], divisionIds: [], resourceIds: [], plannedHours: 0
        };
        saveWorkPackages([...workPackages, newWP]);
        setEditingName(newWP.id);
      };
      
      const addWorkPackageBelow = (wpId) => {
        const refWP = workPackages.find(w => w.id === wpId);
        if (!refWP) return;
        const refOrder = refWP.order || 0;
        // Alle Geschwister mit hÃ¶herer Order um 1 nach unten schieben
        const updated = workPackages.map(wp => 
          wp.projectId === refWP.projectId && wp.parentId === refWP.parentId && (wp.order || 0) > refOrder
            ? { ...wp, order: (wp.order || 0) + 1 }
            : wp
        );
        const startDate = refWP.startDate ? new Date(refWP.startDate + 'T12:00:00') : new Date();
        const endDate = new Date(startDate);
        endDate.setDate(endDate.getDate() + 4);
        const newWP = {
          id: `wp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
          projectId: refWP.projectId, parentId: refWP.parentId, name: 'Neues Arbeitspaket',
          startDate: formatDate(startDate), endDate: formatDate(endDate),
          order: refOrder + 1, color: '#6366f1', responsibles: [], editors: [], divisionIds: [], resourceIds: [], plannedHours: 0
        };
        saveWorkPackages([...updated, newWP]);
        setEditingName(newWP.id);
      };
      
      const deleteWorkPackage = (wpId) => {
        const toDelete = [wpId, ...getAllDescendants(wpId, workPackages).map(d => d.id)];
        saveWorkPackages(workPackages.filter(wp => !toDelete.includes(wp.id)));
        saveDependencies(dependencies.filter(d => !toDelete.includes(d.fromId) && !toDelete.includes(d.toId)));
        if (selectedWP?.id === wpId) setSelectedWP(null);
        if (sidebarWPId === wpId) setSidebarWPId(null);
      };
      
      // Projekt kopieren: Projekt + alle WPs + interne AbhÃ¤ngigkeiten
      const copyProject = (projectId) => {
        const project = projects.find(p => p.id === projectId);
        if (!project) return;
        const newProjectId = 'proj_' + Date.now();
        const newProject = { ...project, id: newProjectId, name: project.name + ' (Kopie)' };
        
        // ID-Mapping fÃ¼r WPs
        const projectWPs = workPackages.filter(wp => wp.projectId === projectId);
        const idMap = {};
        const ts = Date.now();
        projectWPs.forEach((wp, i) => { idMap[wp.id] = 'wp_' + (ts + i + 1); });
        
        const newWPs = projectWPs.map((wp, i) => ({
          ...wp,
          id: idMap[wp.id],
          projectId: newProjectId,
          parentId: wp.parentId ? idMap[wp.parentId] || null : null,
          done: false,
          dailyOverrides: undefined,
          resourceDailyOverrides: undefined,
        }));
        
        // Interne AbhÃ¤ngigkeiten kopieren
        const internalDeps = dependencies.filter(d => idMap[d.fromId] && idMap[d.toId]);
        const newDeps = internalDeps.map((d, i) => ({
          ...d,
          id: 'dep_' + (ts + projectWPs.length + i + 1),
          fromId: idMap[d.fromId],
          toId: idMap[d.toId],
        }));
        
        saveProjects([...(projects || []), newProject]);
        saveWorkPackages([...(workPackages || []), ...newWPs]);
        if (newDeps.length > 0) saveDependencies([...(dependencies || []), ...newDeps]);
      };
      
      // Arbeitspaket kopieren (inkl. aller Kinder)
      const copyWorkPackage = (wpId) => {
        const wp = workPackages.find(w => w.id === wpId);
        if (!wp) return;
        const descendants = getAllDescendants(wpId, workPackages);
        const allToCopy = [wp, ...descendants];
        
        const ts = Date.now();
        const idMap = {};
        allToCopy.forEach((w, i) => { idMap[w.id] = 'wp_' + (ts + i + 1); });
        
        // Siblings um Order zu finden
        const siblings = workPackages.filter(w => w.parentId === wp.parentId && w.projectId === wp.projectId);
        const maxOrder = siblings.reduce((max, s) => Math.max(max, s.order || 0), 0);
        
        const newWPs = allToCopy.map((w, i) => ({
          ...w,
          id: idMap[w.id],
          parentId: w.id === wpId ? wp.parentId : (idMap[w.parentId] || null),
          order: w.id === wpId ? maxOrder + 1 : w.order,
          name: w.id === wpId ? w.name + ' (Kopie)' : w.name,
          done: false,
          dailyOverrides: undefined,
          resourceDailyOverrides: undefined,
        }));
        
        // Interne AbhÃ¤ngigkeiten
        const internalDeps = dependencies.filter(d => idMap[d.fromId] && idMap[d.toId]);
        const newDeps = internalDeps.map((d, i) => ({
          ...d,
          id: 'dep_' + (ts + allToCopy.length + i + 1),
          fromId: idMap[d.fromId],
          toId: idMap[d.toId],
        }));
        
        saveWorkPackages([...(workPackages || []), ...newWPs]);
        if (newDeps.length > 0) saveDependencies([...(dependencies || []), ...newDeps]);
      };
      
      const addDependency = (fromId, toId, type = 'FS') => {
        if (fromId === toId) return;
        if (dependencies.some(d => d.fromId === fromId && d.toId === toId && d.type === type)) return;
        const fromWP = workPackages.find(w => w.id === fromId);
        const toWP = workPackages.find(w => w.id === toId);
        let lagDays = 0;
        if (fromWP && toWP) {
          // Use calculated dates for parent WPs
          const fromChildren = getChildren(fromWP.id, workPackages);
          const toChildren = getChildren(toWP.id, workPackages);
          const fromDates = fromChildren.length > 0 ? calculateDatesFromChildren(fromWP.id, workPackages) : { startDate: fromWP.startDate, endDate: fromWP.endDate };
          const toDates = toChildren.length > 0 ? calculateDatesFromChildren(toWP.id, workPackages) : { startDate: toWP.startDate, endDate: toWP.endDate };
          if (type === 'SS' && fromDates?.startDate && toDates?.startDate) {
            lagDays = Math.round((parseLocalDate(toDates.startDate) - parseLocalDate(fromDates.startDate)) / (1000 * 60 * 60 * 24));
          } else if (type === 'FS' && fromDates?.endDate && toDates?.startDate) {
            lagDays = Math.round((parseLocalDate(toDates.startDate) - parseLocalDate(fromDates.endDate)) / (1000 * 60 * 60 * 24));
          }
        }
        saveDependencies([...dependencies, { id: `dep_${Date.now()}`, fromId, toId, lagDays, type }]);
      };
      
      const deleteDependency = (depId) => saveDependencies(dependencies.filter(d => d.id !== depId));
      
      const updateWorkPackage = React.useCallback((wpId, field, value) => {
        const updated = workPackages.map(wp => wp.id === wpId ? { ...wp, [field]: value } : wp);
        saveWorkPackages(updated);
        if (selectedWP?.id === wpId) setSelectedWP(prev => prev ? { ...prev, [field]: value } : null);
      }, [workPackages, selectedWP]);
      
      const indentWorkPackage = (wpId) => {
        const wp = workPackages.find(w => w.id === wpId);
        if (!wp) return;
        const siblings = workPackages.filter(w => w.projectId === wp.projectId && w.parentId === wp.parentId).sort((a, b) => (a.order || 0) - (b.order || 0));
        const myIndex = siblings.findIndex(s => s.id === wpId);
        if (myIndex <= 0) return;
        const newParent = siblings[myIndex - 1];
        const newSiblings = workPackages.filter(w => w.parentId === newParent.id);
        const maxOrder = newSiblings.length > 0 ? Math.max(...newSiblings.map(s => s.order || 0)) : 0;
        const updated = workPackages.map(w => w.id === wpId ? { ...w, parentId: newParent.id, order: maxOrder + 1 } : w);
        saveWorkPackages(updated);
        setExpandedPackages(prev => ({ ...prev, [newParent.id]: true }));
      };
      
      const outdentWorkPackage = (wpId) => {
        const wp = workPackages.find(w => w.id === wpId);
        if (!wp || !wp.parentId) return;
        const parent = workPackages.find(w => w.id === wp.parentId);
        if (!parent) return;
        const newOrder = (parent.order || 0) + 0.5;
        const updated = workPackages.map(w => w.id === wpId ? { ...w, parentId: parent.parentId, order: newOrder } : w);
        const reordered = updated.filter(w => w.projectId === wp.projectId && w.parentId === parent.parentId).sort((a, b) => (a.order || 0) - (b.order || 0)).map((w, i) => ({ ...w, order: i + 1 }));
        const others = updated.filter(w => w.projectId !== wp.projectId || w.parentId !== parent.parentId);
        saveWorkPackages([...others, ...reordered]);
      };
      
      // Bulk-Operationen fÃ¼r Multi-Select
      const bulkIndent = () => {
        if (selectedWPs.length === 0) return;
        let updated = [...workPackages];
        const selectedSet = new Set(selectedWPs);
        
        // Process each selected WP individually, top-to-bottom
        // Use a copy because updated mutates during processing
        [...selectedWPs].forEach(wpId => {
          const wp = updated.find(w => w.id === wpId);
          if (!wp) return;
          
          // Get current siblings in the UPDATED state
          const siblings = updated
            .filter(w => w.projectId === wp.projectId && w.parentId === wp.parentId)
            .sort((a, b) => (a.order || 0) - (b.order || 0));
          
          const myIndex = siblings.findIndex(s => s.id === wp.id);
          if (myIndex <= 0) return; // First sibling â€” nothing above to indent under
          
          // The sibling directly above becomes the new parent
          // (whether it's selected or not â€” if selected, it was already moved, 
          //  so this WP follows it naturally)
          const newParent = siblings[myIndex - 1];
          
          // Move this WP under newParent
          const newSiblings = updated.filter(w => w.parentId === newParent.id);
          const maxOrder = newSiblings.length > 0 ? Math.max(...newSiblings.map(s => s.order || 0)) : 0;
          updated = updated.map(w => w.id === wpId ? { ...w, parentId: newParent.id, order: maxOrder + 1 } : w);
          setExpandedPackages(prev => ({ ...prev, [newParent.id]: true }));
        });
        
        saveWorkPackages(updated);
      };
      
      const bulkOutdent = () => {
        if (selectedWPs.length === 0) return;
        let updated = [...workPackages];
        
        // Process in reverse order (bottom-to-top) for clean outdenting
        [...selectedWPs].reverse().forEach(wpId => {
          const wp = updated.find(w => w.id === wpId);
          if (!wp || !wp.parentId) return;
          const parent = updated.find(w => w.id === wp.parentId);
          if (!parent) return;
          
          const insertOrder = (parent.order || 0) + 0.5;
          updated = updated.map(w => w.id === wpId ? { ...w, parentId: parent.parentId, order: insertOrder } : w);
        });
        
        // Reorder all affected levels to clean up fractional orders
        const projectIds = [...new Set(selectedWPs.map(id => updated.find(w => w.id === id)?.projectId).filter(Boolean))];
        projectIds.forEach(pid => {
          const parentIds = [...new Set(updated.filter(w => w.projectId === pid).map(w => w.parentId))];
          parentIds.forEach(parentId => {
            const siblings = updated.filter(w => w.projectId === pid && w.parentId === parentId).sort((a, b) => (a.order || 0) - (b.order || 0));
            siblings.forEach((w, i) => { updated = updated.map(u => u.id === w.id ? { ...u, order: i + 1 } : u); });
          });
        });
        
        saveWorkPackages(updated);
      };
      
      const bulkDelete = () => {
        if (selectedWPs.length === 0) return;
        if (!confirm(`${selectedWPs.length} Arbeitspakete lÃ¶schen?`)) return;
        const updated = workPackages.filter(wp => !selectedWPs.includes(wp.id));
        saveWorkPackages(updated);
        setSelectedWPs([]);
      };
      
      const bulkSetColor = (color) => {
        if (selectedWPs.length === 0) return;
        const updated = workPackages.map(wp => selectedWPs.includes(wp.id) ? { ...wp, color } : wp);
        saveWorkPackages(updated);
      };
      
      // Sidebar Ã¶ffnen (Scroll wird automatisch durch useLayoutEffect wiederhergestellt)
      const openSidebar = (wpId) => {
        setSelectedWPs([]);
        setSidebarWPId(wpId);
      };
      
      // Click-Handler: Normaler Klick Ã¶ffnet Sidebar, bei aktiver Auswahl: toggle
      const handleWPClick = (e, wp, flatList) => {
        e.stopPropagation();
        if (selectedWPs.length > 0) {
          // Bei aktiver Auswahl: Klick togglet Checkbox
          handleWPCheckbox(e, wp);
          return;
        }
        openSidebar(wp.id);
      };
      
      // Checkbox-Handler fÃ¼r Multi-Select
      const handleWPCheckbox = (e, wp) => {
        e.stopPropagation();
        setSidebarWPId(null);
        
        if (e.shiftKey && lastClickedWPRef.current) {
          // Shift+Checkbox: Range auswÃ¤hlen
          const visProjects = selectedProjectId ? projects.filter(p => p.id === selectedProjectId) : selectedFolderId ? projects.filter(p => p.folderId === selectedFolderId && !p.archived) : projects.filter(p => !p.archived);
          const globalFlatList = visProjects.flatMap(p => getFlatSortedList(p.id));
          const lastIndex = globalFlatList.findIndex(w => w.id === lastClickedWPRef.current);
          const currentIndex = globalFlatList.findIndex(w => w.id === wp.id);
          if (lastIndex !== -1 && currentIndex !== -1) {
            const start = Math.min(lastIndex, currentIndex);
            const end = Math.max(lastIndex, currentIndex);
            const rangeIds = globalFlatList.slice(start, end + 1).map(w => w.id);
            setSelectedWPs(rangeIds);
          }
        } else {
          // Normal: toggle
          setSelectedWPs(prev => prev.includes(wp.id) ? prev.filter(id => id !== wp.id) : [...prev, wp.id]);
        }
        lastClickedWPRef.current = wp.id;
      };
      
      // Auswahl aufheben bei Klick auÃŸerhalb
      const clearSelection = () => {
        if (selectedWPs.length > 0) {
          setSelectedWPs([]);
        }
      };
      
      // Verschiebt ein WP an eine neue Position (vor/nach einem anderen WP oder als Kind)
      const moveWorkPackage = (draggedId, targetId, position) => {
        if (draggedId === targetId) return;
        const draggedWp = workPackages.find(w => w.id === draggedId);
        const targetWp = workPackages.find(w => w.id === targetId);
        if (!draggedWp || !targetWp) return;
        
        // PrÃ¼fe ob target ein Nachkomme von dragged ist (wÃ¼rde Zirkelbezug erzeugen)
        const isDescendant = (parentId, checkId) => {
          if (parentId === checkId) return true;
          const children = workPackages.filter(w => w.parentId === parentId);
          return children.some(c => isDescendant(c.id, checkId));
        };
        if (isDescendant(draggedId, targetId)) return;
        
        let newParentId, newOrder;
        
        if (position === 'child') {
          // Als Kind des Targets einfÃ¼gen
          newParentId = targetId;
          const children = workPackages.filter(w => w.parentId === targetId);
          newOrder = children.length > 0 ? Math.max(...children.map(c => c.order || 0)) + 1 : 1;
        } else {
          // Vor oder nach dem Target als Geschwister
          newParentId = targetWp.parentId;
          const siblings = workPackages.filter(w => w.projectId === targetWp.projectId && w.parentId === newParentId && w.id !== draggedId);
          const targetOrder = targetWp.order || 0;
          newOrder = position === 'before' ? targetOrder - 0.5 : targetOrder + 0.5;
        }
        
        // Update das gezogene WP
        let updated = workPackages.map(w => w.id === draggedId ? { ...w, parentId: newParentId, order: newOrder } : w);
        
        // Reorder alle Geschwister um saubere Nummern zu haben
        const siblingsToReorder = updated.filter(w => w.projectId === draggedWp.projectId && w.parentId === newParentId);
        const reordered = siblingsToReorder.sort((a, b) => (a.order || 0) - (b.order || 0)).map((w, i) => ({ ...w, order: i + 1 }));
        const others = updated.filter(w => w.projectId !== draggedWp.projectId || w.parentId !== newParentId);
        
        saveWorkPackages([...others, ...reordered]);
        
        // Expand parent wenn als Kind eingefÃ¼gt
        if (position === 'child') {
          setExpandedPackages(prev => ({ ...prev, [targetId]: true }));
        }
      };
      
      const toggleExpand = (wpId) => setExpandedPackages(prev => ({ ...prev, [wpId]: prev[wpId] === false ? true : false }));
      
      const moveWithDependencies = (wpId, newStartDate, newEndDate) => {
        const wp = workPackages.find(w => w.id === wpId);
        if (!wp) return;
        
        const oldEndDate = parseLocalDate(wp.endDate);
        const newEnd = parseLocalDate(newEndDate);
        const daysDiff = Math.round((newEnd - oldEndDate) / (1000 * 60 * 60 * 24));
        
        let updated = workPackages.map(w => w.id === wpId ? { ...w, startDate: newStartDate, endDate: newEndDate } : w);
        let updatedDeps = [...dependencies];
        
        if (daysDiff > 0) {
          // Nach RECHTS geschoben (spÃ¤ter) â†’ je nach Modus
          if (resizeMode === 'rigid') {
            // Starr: Alle Nachfolger sofort mitschieben, Lag bleibt erhalten
            const processSuccessorsRigid = (sourceId, shiftAmount) => {
              dependencies.filter(d => d.fromId === sourceId).forEach(dep => {
                const depWP = updated.find(w => w.id === dep.toId);
                if (depWP && depWP.startDate) {
                  // Ãœberspringe gesperrte WPs
                  if (depWP.locked) return;
                  const newDepStart = parseLocalDate(depWP.startDate);
                  newDepStart.setDate(newDepStart.getDate() + shiftAmount);
                  const newDepEnd = parseLocalDate(depWP.endDate);
                  newDepEnd.setDate(newDepEnd.getDate() + shiftAmount);
                  updated = updated.map(w => w.id === dep.toId ? { ...w, startDate: formatDate(newDepStart), endDate: formatDate(newDepEnd) } : w);
                  processSuccessorsRigid(dep.toId, shiftAmount);
                }
              });
            };
            processSuccessorsRigid(wpId, daysDiff);
          } else {
            // Magnetisch: Puffer erst aufbrauchen, dann verschieben
            const processSuccessorsMagnetic = (sourceId, remainingShift) => {
              dependencies.filter(d => d.fromId === sourceId).forEach(dep => {
                const depIndex = updatedDeps.findIndex(d => d.id === dep.id);
                const currentLag = dep.lagDays || 0;
                const depWP = updated.find(w => w.id === dep.toId);
                
                // Ãœberspringe gesperrte WPs
                if (depWP && depWP.locked) return;
                
                if (currentLag >= remainingShift) {
                  // Lag reicht aus - nur Lag reduzieren, B bleibt
                  if (depIndex >= 0) {
                    updatedDeps[depIndex] = { ...updatedDeps[depIndex], lagDays: currentLag - remainingShift };
                  }
                } else {
                  // Lag reicht nicht - Lag auf 0 setzen und Rest verschieben
                  const shiftAmount = remainingShift - currentLag;
                  if (depIndex >= 0) {
                    updatedDeps[depIndex] = { ...updatedDeps[depIndex], lagDays: 0 };
                  }
                  
                  if (depWP && depWP.startDate) {
                    const newDepStart = parseLocalDate(depWP.startDate);
                    newDepStart.setDate(newDepStart.getDate() + shiftAmount);
                    const newDepEnd = parseLocalDate(depWP.endDate);
                    newDepEnd.setDate(newDepEnd.getDate() + shiftAmount);
                    updated = updated.map(w => w.id === dep.toId ? { ...w, startDate: formatDate(newDepStart), endDate: formatDate(newDepEnd) } : w);
                    processSuccessorsMagnetic(dep.toId, shiftAmount);
                  }
                }
              });
            };
            processSuccessorsMagnetic(wpId, daysDiff);
          }
        } else if (daysDiff < 0) {
          // Nach LINKS geschoben (frÃ¼her)
          if (resizeMode === 'rigid') {
            // Starr: Alle Nachfolger auch nach links mitschieben, Lag bleibt erhalten
            const processSuccessorsRigidLeft = (sourceId, shiftAmount) => {
              dependencies.filter(d => d.fromId === sourceId).forEach(dep => {
                const depWP = updated.find(w => w.id === dep.toId);
                if (depWP && depWP.startDate) {
                  if (depWP.locked) return;
                  const newDepStart = parseLocalDate(depWP.startDate);
                  newDepStart.setDate(newDepStart.getDate() + shiftAmount); // shiftAmount ist negativ
                  const newDepEnd = parseLocalDate(depWP.endDate);
                  newDepEnd.setDate(newDepEnd.getDate() + shiftAmount);
                  updated = updated.map(w => w.id === dep.toId ? { ...w, startDate: formatDate(newDepStart), endDate: formatDate(newDepEnd) } : w);
                  processSuccessorsRigidLeft(dep.toId, shiftAmount);
                }
              });
            };
            processSuccessorsRigidLeft(wpId, daysDiff);
          } else {
            // Magnetisch: Abstand wird grÃ¶ÃŸer, B bleibt wo es ist
            dependencies.filter(d => d.fromId === wpId).forEach(dep => {
              const depIndex = updatedDeps.findIndex(d => d.id === dep.id);
              if (depIndex >= 0) {
                const currentLag = dep.lagDays || 0;
                updatedDeps[depIndex] = { ...updatedDeps[depIndex], lagDays: currentLag + Math.abs(daysDiff) };
              }
            });
          }
        }
        
        // dailyOverrides fÃ¼r alle verschobenen WPs mitverschieben
        updated = updated.map(w => {
          const orig = workPackages.find(o => o.id === w.id);
          if (orig && w.startDate !== orig.startDate && (w.dailyOverrides || w.resourceDailyOverrides)) {
            const diff = Math.round((parseLocalDate(w.startDate) - parseLocalDate(orig.startDate)) / (1000 * 60 * 60 * 24));
            return { ...w, dailyOverrides: shiftDailyOverrides(w.dailyOverrides, diff), resourceDailyOverrides: shiftDailyOverrides(w.resourceDailyOverrides, diff) };
          }
          return w;
        });
        
        saveWorkPackages(updated);
        saveDependencies(updatedDeps);
      };
      
      const moveSummaryWithChildren = (wpId, daysDiff) => {
        const descendants = getAllDescendants(wpId, workPackages);
        // Wenn ein Kind fixiert ist, darf der Summary-Balken nicht verschoben werden
        if (descendants.some(d => d.locked)) return;
        const idsToMove = [wpId, ...descendants.map(d => d.id)];
        
        let updated = workPackages.map(wp => {
          if (idsToMove.includes(wp.id) && wp.startDate && wp.endDate) {
            const newStart = parseLocalDate(wp.startDate);
            newStart.setDate(newStart.getDate() + daysDiff);
            const newEnd = parseLocalDate(wp.endDate);
            newEnd.setDate(newEnd.getDate() + daysDiff);
            return { ...wp, startDate: formatDate(newStart), endDate: formatDate(newEnd) };
          }
          return wp;
        });
        
        let updatedDeps = [...dependencies];
        
        if (daysDiff > 0) {
          // Nach RECHTS â†’ externe AbhÃ¤ngigkeiten je nach Modus behandeln
          if (resizeMode === 'rigid') {
            // Starr: Alle externen Nachfolger sofort mitschieben
            const processExternalRigid = (sourceIds, shiftAmount) => {
              dependencies.filter(d => sourceIds.includes(d.fromId) && !idsToMove.includes(d.toId)).forEach(dep => {
                const depWP = updated.find(w => w.id === dep.toId);
                if (depWP && depWP.startDate) {
                  if (depWP.locked) return;
                  const newDepStart = parseLocalDate(depWP.startDate);
                  newDepStart.setDate(newDepStart.getDate() + shiftAmount);
                  const newDepEnd = parseLocalDate(depWP.endDate);
                  newDepEnd.setDate(newDepEnd.getDate() + shiftAmount);
                  updated = updated.map(w => w.id === dep.toId ? { ...w, startDate: formatDate(newDepStart), endDate: formatDate(newDepEnd) } : w);
                  processExternalRigid([dep.toId], shiftAmount);
                }
              });
            };
            processExternalRigid(idsToMove, daysDiff);
          } else {
            // Magnetisch: Puffer aufbrauchen, dann verschieben
            const processExternalMagnetic = (sourceIds, remainingShift) => {
              dependencies.filter(d => sourceIds.includes(d.fromId) && !idsToMove.includes(d.toId)).forEach(dep => {
                const depWP = updated.find(w => w.id === dep.toId);
                if (depWP && depWP.locked) return;
                const depIndex = updatedDeps.findIndex(d => d.id === dep.id);
                const currentLag = dep.lagDays || 0;
                
                if (currentLag >= remainingShift) {
                  if (depIndex >= 0) {
                    updatedDeps[depIndex] = { ...updatedDeps[depIndex], lagDays: currentLag - remainingShift };
                  }
                } else {
                  const shiftAmount = remainingShift - currentLag;
                  if (depIndex >= 0) {
                    updatedDeps[depIndex] = { ...updatedDeps[depIndex], lagDays: 0 };
                  }
                  
                  const depWP = updated.find(w => w.id === dep.toId);
                  if (depWP && depWP.startDate) {
                    const newDepStart = parseLocalDate(depWP.startDate);
                    newDepStart.setDate(newDepStart.getDate() + shiftAmount);
                    const newDepEnd = parseLocalDate(depWP.endDate);
                    newDepEnd.setDate(newDepEnd.getDate() + shiftAmount);
                    updated = updated.map(w => w.id === dep.toId ? { ...w, startDate: formatDate(newDepStart), endDate: formatDate(newDepEnd) } : w);
                    processExternalMagnetic([dep.toId], shiftAmount);
                  }
                }
              });
            };
            processExternalMagnetic(idsToMove, daysDiff);
          }
        } else if (daysDiff < 0) {
          // Nach LINKS
          if (resizeMode === 'rigid') {
            // Starr: Alle externen Nachfolger auch nach links mitschieben
            const processExternalRigidLeft = (sourceIds, shiftAmount) => {
              dependencies.filter(d => sourceIds.includes(d.fromId) && !idsToMove.includes(d.toId)).forEach(dep => {
                const depWP = updated.find(w => w.id === dep.toId);
                if (depWP && depWP.startDate) {
                  if (depWP.locked) return;
                  const newDepStart = parseLocalDate(depWP.startDate);
                  newDepStart.setDate(newDepStart.getDate() + shiftAmount);
                  const newDepEnd = parseLocalDate(depWP.endDate);
                  newDepEnd.setDate(newDepEnd.getDate() + shiftAmount);
                  updated = updated.map(w => w.id === dep.toId ? { ...w, startDate: formatDate(newDepStart), endDate: formatDate(newDepEnd) } : w);
                  processExternalRigidLeft([dep.toId], shiftAmount);
                }
              });
            };
            processExternalRigidLeft(idsToMove, daysDiff);
          } else {
            // Magnetisch: Abstand wird grÃ¶ÃŸer, externe Nachfolger bleiben
            dependencies.filter(d => idsToMove.includes(d.fromId) && !idsToMove.includes(d.toId)).forEach(dep => {
              const depIndex = updatedDeps.findIndex(d => d.id === dep.id);
              if (depIndex >= 0) {
                const currentLag = dep.lagDays || 0;
                updatedDeps[depIndex] = { ...updatedDeps[depIndex], lagDays: currentLag + Math.abs(daysDiff) };
              }
            });
          }
        }
        
        // dailyOverrides fÃ¼r alle verschobenen WPs mitverschieben
        updated = updated.map(w => {
          const orig = workPackages.find(o => o.id === w.id);
          if (orig && w.startDate !== orig.startDate && (w.dailyOverrides || w.resourceDailyOverrides)) {
            const diff = Math.round((parseLocalDate(w.startDate) - parseLocalDate(orig.startDate)) / (1000 * 60 * 60 * 24));
            return { ...w, dailyOverrides: shiftDailyOverrides(w.dailyOverrides, diff), resourceDailyOverrides: shiftDailyOverrides(w.resourceDailyOverrides, diff) };
          }
          return w;
        });
        
        saveWorkPackages(updated);
        saveDependencies(updatedDeps);
      };
      
      // Gesamtes Projekt verschieben (alle WPs um daysDiff Tage)
      const moveProject = (projectId, daysDiff) => {
        if (daysDiff === 0) return;
        const projectWPs = workPackages.filter(wp => wp.projectId === projectId);
        if (projectWPs.length === 0) return;
        // Wenn irgendein AP fixiert ist, gesamtes Projekt nicht verschieben
        if (projectWPs.some(wp => wp.locked)) return;
        
        const updated = workPackages.map(wp => {
          if (wp.projectId === projectId && wp.startDate && wp.endDate) {
            const newStart = parseLocalDate(wp.startDate);
            newStart.setDate(newStart.getDate() + daysDiff);
            const newEnd = parseLocalDate(wp.endDate);
            newEnd.setDate(newEnd.getDate() + daysDiff);
            return { ...wp, startDate: formatDate(newStart), endDate: formatDate(newEnd) };
          }
          return wp;
        });
        saveWorkPackages(updated);
      };
      
      const resizeWithDependencies = (wpId, newEndDate) => {
        const wp = workPackages.find(w => w.id === wpId);
        if (!wp) return;
        
        const oldEndDate = parseLocalDate(wp.endDate);
        const newEnd = parseLocalDate(newEndDate);
        const daysDiff = Math.round((newEnd - oldEndDate) / (1000 * 60 * 60 * 24));
        
        let updated = workPackages.map(w => w.id === wpId ? { ...w, endDate: newEndDate } : w);
        let updatedDeps = [...dependencies];
        
        if (daysDiff > 0) {
          if (resizeMode === 'rigid') {
            // Starr: Alle Nachfolger sofort mitschieben, Lag bleibt erhalten
            const processSuccessorsRigid = (sourceId, shiftAmount) => {
              dependencies.filter(d => d.fromId === sourceId).forEach(dep => {
                const depWP = updated.find(w => w.id === dep.toId);
                if (depWP && depWP.startDate) {
                  if (depWP.locked) return;
                  const newDepStart = parseLocalDate(depWP.startDate);
                  newDepStart.setDate(newDepStart.getDate() + shiftAmount);
                  const newDepEnd = parseLocalDate(depWP.endDate);
                  newDepEnd.setDate(newDepEnd.getDate() + shiftAmount);
                  updated = updated.map(w => w.id === dep.toId ? { ...w, startDate: formatDate(newDepStart), endDate: formatDate(newDepEnd) } : w);
                  processSuccessorsRigid(dep.toId, shiftAmount);
                }
              });
            };
            processSuccessorsRigid(wpId, daysDiff);
          } else {
            // Magnetisch: Puffer erst aufbrauchen, dann verschieben
            const processSuccessorsMagnetic = (sourceId, remainingShift) => {
              dependencies.filter(d => d.fromId === sourceId).forEach(dep => {
                const _depWPLock = updated.find(w => w.id === dep.toId);
                if (_depWPLock && _depWPLock.locked) return;
                const depIndex = updatedDeps.findIndex(d => d.id === dep.id);
                const currentLag = dep.lagDays || 0;
                
                if (currentLag >= remainingShift) {
                  if (depIndex >= 0) {
                    updatedDeps[depIndex] = { ...updatedDeps[depIndex], lagDays: currentLag - remainingShift };
                  }
                } else {
                  const shiftAmount = remainingShift - currentLag;
                  if (depIndex >= 0) {
                    updatedDeps[depIndex] = { ...updatedDeps[depIndex], lagDays: 0 };
                  }
                  
                  const depWP = updated.find(w => w.id === dep.toId);
                  if (depWP && depWP.startDate) {
                    const newDepStart = parseLocalDate(depWP.startDate);
                    newDepStart.setDate(newDepStart.getDate() + shiftAmount);
                    const newDepEnd = parseLocalDate(depWP.endDate);
                    newDepEnd.setDate(newDepEnd.getDate() + shiftAmount);
                    updated = updated.map(w => w.id === dep.toId ? { ...w, startDate: formatDate(newDepStart), endDate: formatDate(newDepEnd) } : w);
                    processSuccessorsMagnetic(dep.toId, shiftAmount);
                  }
                }
              });
            };
            processSuccessorsMagnetic(wpId, daysDiff);
          }
        } else if (daysDiff < 0) {
          // Balken wird VERKLEINERT â†’ Abstand wird grÃ¶ÃŸer, B bleibt wo es ist
          dependencies.filter(d => d.fromId === wpId).forEach(dep => {
            const depIndex = updatedDeps.findIndex(d => d.id === dep.id);
            if (depIndex >= 0) {
              const currentLag = dep.lagDays || 0;
              updatedDeps[depIndex] = { ...updatedDeps[depIndex], lagDays: currentLag + Math.abs(daysDiff) };
            }
          });
        }
        
        saveWorkPackages(updated);
        saveDependencies(updatedDeps);
      };
      
      // Berechne Preview-Positionen fÃ¼r abhÃ¤ngige Balken wÃ¤hrend Drag/Resize
      const calculatePreviewPositions = (wpId, newEndDate) => {
        const wp = workPackages.find(w => w.id === wpId);
        if (!wp) return {};
        
        const oldEndDate = parseLocalDate(wp.endDate);
        const newEnd = parseLocalDate(newEndDate);
        const daysDiff = Math.round((newEnd - oldEndDate) / (1000 * 60 * 60 * 24));
        
        if (daysDiff === 0) return {};
        
        const previews = {};
        
        if (daysDiff > 0) {
          // Nach rechts
          if (resizeMode === 'rigid') {
            const processRigid = (sourceId, shiftAmount) => {
              dependencies.filter(d => d.fromId === sourceId).forEach(dep => {
                const depWP = workPackages.find(w => w.id === dep.toId);
                if (depWP && depWP.startDate) {
                  // Fixierte Termine nicht verschieben
                  if (depWP.locked) return;
                  const existingPreview = previews[dep.toId];
                  const baseStart = existingPreview ? parseLocalDate(existingPreview.startDate) : parseLocalDate(depWP.startDate);
                  const baseEnd = existingPreview ? parseLocalDate(existingPreview.endDate) : parseLocalDate(depWP.endDate);
                  const newDepStart = new Date(baseStart.getTime());
                  newDepStart.setDate(newDepStart.getDate() + shiftAmount);
                  const newDepEnd = new Date(baseEnd.getTime());
                  newDepEnd.setDate(newDepEnd.getDate() + shiftAmount);
                  previews[dep.toId] = { startDate: formatDate(newDepStart), endDate: formatDate(newDepEnd) };
                  processRigid(dep.toId, shiftAmount);
                }
              });
            };
            processRigid(wpId, daysDiff);
          } else {
            const processMagnetic = (sourceId, remainingShift) => {
              dependencies.filter(d => d.fromId === sourceId).forEach(dep => {
                const depWP = workPackages.find(w => w.id === dep.toId);
                if (depWP && depWP.startDate) {
                  // Fixierte Termine nicht verschieben
                  if (depWP.locked) return;
                  const currentLag = dep.lagDays || 0;
                  if (currentLag < remainingShift) {
                    const shiftAmount = remainingShift - currentLag;
                    const existingPreview = previews[dep.toId];
                    const baseStart = existingPreview ? parseLocalDate(existingPreview.startDate) : parseLocalDate(depWP.startDate);
                    const baseEnd = existingPreview ? parseLocalDate(existingPreview.endDate) : parseLocalDate(depWP.endDate);
                    const newDepStart = new Date(baseStart.getTime());
                    newDepStart.setDate(newDepStart.getDate() + shiftAmount);
                    const newDepEnd = new Date(baseEnd.getTime());
                    newDepEnd.setDate(newDepEnd.getDate() + shiftAmount);
                    previews[dep.toId] = { startDate: formatDate(newDepStart), endDate: formatDate(newDepEnd) };
                    processMagnetic(dep.toId, shiftAmount);
                  }
                }
              });
            };
            processMagnetic(wpId, daysDiff);
          }
        } else if (daysDiff < 0 && resizeMode === 'rigid') {
          // Nach links - nur bei rigid Mode werden Nachfolger mitgezogen
          const processRigidLeft = (sourceId, shiftAmount) => {
            dependencies.filter(d => d.fromId === sourceId).forEach(dep => {
              const depWP = workPackages.find(w => w.id === dep.toId);
              if (depWP && depWP.startDate) {
                // Fixierte Termine nicht verschieben
                if (depWP.locked) return;
                const existingPreview = previews[dep.toId];
                const baseStart = existingPreview ? parseLocalDate(existingPreview.startDate) : parseLocalDate(depWP.startDate);
                const baseEnd = existingPreview ? parseLocalDate(existingPreview.endDate) : parseLocalDate(depWP.endDate);
                const newDepStart = new Date(baseStart.getTime());
                newDepStart.setDate(newDepStart.getDate() + shiftAmount);
                const newDepEnd = new Date(baseEnd.getTime());
                newDepEnd.setDate(newDepEnd.getDate() + shiftAmount);
                previews[dep.toId] = { startDate: formatDate(newDepStart), endDate: formatDate(newDepEnd) };
                processRigidLeft(dep.toId, shiftAmount);
              }
            });
          };
          processRigidLeft(wpId, daysDiff);
        }
        
        return previews;
      };
      
      React.useEffect(() => {
        const handleMouseMove = (e) => {
          if (draggedWP) {
            const dx = e.clientX - draggedWP.startX;
            const daysDiff = Math.round(dx / DAY_WIDTH);
            
            if (draggedWP.isProject) {
              setDraggedWP(prev => ({ ...prev, daysDiff }));
            } else if (draggedWP.isSummary) {
              setDraggedWP(prev => ({ ...prev, daysDiff }));
              // Preview fÃ¼r Summary-Drag berechnen
              if (daysDiff !== 0) {
                const wp = workPackages.find(w => w.id === draggedWP?.wp?.id);
                if (wp && wp.endDate) {
                  const newEnd = parseLocalDate(wp.endDate);
                  newEnd.setDate(newEnd.getDate() + daysDiff);
                  const previews = calculatePreviewPositions(draggedWP?.wp?.id, formatDate(newEnd));
                  setPreviewPositions(previews);
                  // Speichere Original-Positionen fÃ¼r Schatten (nur einmal)
                  if (Object.keys(originalPositionsRef.current).length === 0) {
                    const originals = { [draggedWP?.wp?.id]: { startDate: wp.startDate, endDate: wp.endDate } };
                    Object.keys(previews).forEach(id => {
                      const origWP = workPackages.find(w => w.id === id);
                      if (origWP) originals[id] = { startDate: origWP.startDate, endDate: origWP.endDate };
                    });
                    originalPositionsRef.current = originals;
                    setOriginalPositions(originals);
                  }
                }
              } else {
                setPreviewPositions({});
              }
            } else if (draggedWP.wp) {
              let newStart = xToDate(draggedWP.originalX + dx);
              const wp = draggedWP.wp;
              const allowWeekend = wp.allowWeekend === true; // Default: NICHT erlaubt (Standard-Arbeitswoche)
              
              // Wenn freie Tage nicht erlaubt, zum nÃ¤chsten Arbeitstag springen
              if (isNonWorkDay(newStart, allowWeekend)) {
                const skipped = skipNonWorkDays(newStart, true, allowWeekend);
                newStart = formatDate(skipped);
              }
              
              // Dauer berechnen (in Arbeitstagen oder KTn)
              const origStart = parseLocalDate(wp.startDate);
              const origEnd = parseLocalDate(wp.endDate);
              let duration;
              
              if (!allowWeekend || Object.keys(holidays).length > 0) {
                // ZÃ¤hle Arbeitstage (berÃ¼cksichtigt Wochenenden UND Feiertage)
                duration = countWorkingDays(origStart, origEnd, allowWeekend) - 1;
                const newEnd = addWorkingDays(parseLocalDate(newStart), duration, allowWeekend);
                setDraggedWP(prev => ({ ...prev, previewStart: newStart, previewEnd: formatDate(newEnd) }));
              } else {
                // Normale KT (nur wenn allowWeekend UND keine Feiertage)
                duration = (origEnd - origStart) / (1000 * 60 * 60 * 24);
                const newEnd = parseLocalDate(newStart);
                newEnd.setDate(newEnd.getDate() + duration);
                setDraggedWP(prev => ({ ...prev, previewStart: newStart, previewEnd: formatDate(newEnd) }));
              }
              
              // Preview fÃ¼r normale Drag berechnen
              const previewEnd = draggedWP.previewEnd || formatDate(new Date(parseLocalDate(newStart).setDate(parseLocalDate(newStart).getDate() + duration)));
              const previews = calculatePreviewPositions(wp.id, previewEnd);
              setPreviewPositions(previews);
              // Speichere Original-Positionen fÃ¼r Schatten (nur einmal)
              if (Object.keys(originalPositionsRef.current).length === 0) {
                const originals = { [wp.id]: { startDate: wp.startDate, endDate: wp.endDate } };
                Object.keys(previews).forEach(id => {
                  const origWP = workPackages.find(w => w.id === id);
                  if (origWP) originals[id] = { startDate: origWP.startDate, endDate: origWP.endDate };
                });
                originalPositionsRef.current = originals;
                setOriginalPositions(originals);
              }
            }
          }
          if (resizingWP) {
            const dx = e.clientX - resizingWP.startX;
            if (resizingWP.side === 'left') {
              // Links resizen - Start Ã¤ndern
              const newStart = xToDate(resizingWP.originalStartX + dx);
              if (parseLocalDate(newStart) <= new Date(resizingWP.wp.endDate)) {
                setResizingWP(prev => ({ ...prev, previewStart: newStart }));
                // Speichere Original-Positionen fÃ¼r Schatten (nur einmal)
                if (Object.keys(originalPositionsRef.current).length === 0) {
                  const wp = resizingWP.wp;
                  const originals = { [wp.id]: { startDate: wp.startDate, endDate: wp.endDate } };
                  originalPositionsRef.current = originals;
                  setOriginalPositions(originals);
                }
              }
            } else {
              // Rechts resizen - Ende Ã¤ndern (wie bisher)
              const newEnd = xToDate(resizingWP.originalEndX + dx);
              if (parseLocalDate(newEnd) >= new Date(resizingWP.wp.startDate)) {
                setResizingWP(prev => ({ ...prev, previewEnd: newEnd }));
                // Preview fÃ¼r Resize berechnen
                const previews = calculatePreviewPositions(resizingWP.wp.id, newEnd);
                setPreviewPositions(previews);
                // Speichere Original-Positionen fÃ¼r Schatten (nur einmal)
                if (Object.keys(originalPositionsRef.current).length === 0) {
                  const wp = resizingWP.wp;
                  const originals = { [wp.id]: { startDate: wp.startDate, endDate: wp.endDate } };
                  Object.keys(previews).forEach(id => {
                    const origWP = workPackages.find(w => w.id === id);
                    if (origWP) originals[id] = { startDate: origWP.startDate, endDate: origWP.endDate };
                  });
                  originalPositionsRef.current = originals;
                  setOriginalPositions(originals);
                }
              }
            }
          }
          if (linkingFrom) setLinkMousePos({ x: e.clientX, y: e.clientY });
        };
        const handleMouseUp = (e) => {
          if (draggedWP) {
            if (draggedWP.isProject && draggedWP.daysDiff !== 0) {
              moveProject(draggedWP.projectId, draggedWP.daysDiff);
            } else if (draggedWP.isSummary && draggedWP.daysDiff !== 0) {
              moveSummaryWithChildren(draggedWP?.wp?.id, draggedWP.daysDiff);
            } else if (draggedWP.previewStart) {
              moveWithDependencies(draggedWP?.wp?.id, draggedWP.previewStart, draggedWP.previewEnd);
            }
          }
          if (resizingWP) {
            if (resizingWP.side === 'left' && resizingWP.previewStart) {
              // Links resizen - nur Start Ã¤ndern, Ende bleibt
              const updated = workPackages.map(w => w.id === resizingWP.wp.id ? { ...w, startDate: resizingWP.previewStart } : w);
              saveWorkPackages(updated);
            } else if (resizingWP.previewEnd) {
              resizeWithDependencies(resizingWP.wp.id, resizingWP.previewEnd);
            }
          }
          if (linkingFrom) {
            const target = e.target.closest('[data-wp-id]');
            if (target && target.dataset.wpId !== linkingFrom.id) addDependency(linkingFrom.id, target.dataset.wpId, linkingFrom.fromStart ? 'SS' : 'FS');
          }
          setDraggedWP(null); setResizingWP(null); setLinkingFrom(null); setLinkMousePos(null); setPreviewPositions({}); 
          originalPositionsRef.current = {};
          setOriginalPositions({});
        };
        if (draggedWP || resizingWP || linkingFrom) {
          // Markiere als Dragging
          window._ganttScrollTop.isDragging = true;
          
          const wrappedMouseMove = (e) => {
            // Scroll VOR dem Handler aktualisieren (vertikal + horizontal)
            if (ganttScrollRef.current) {
              window._ganttScrollTop.value = ganttScrollRef.current.scrollTop;
            }
            if (ganttHScrollRef.current) {
              window._ganttScrollLeft.value = ganttHScrollRef.current.scrollLeft;
            }
            handleMouseMove(e);
            // Scroll nach State-Update wiederherstellen (mehrfach zur Sicherheit)
            const restore = () => {
              if (ganttScrollRef.current && window._ganttScrollTop.isDragging) {
                ganttScrollRef.current.scrollTop = window._ganttScrollTop.value;
              }
              if (ganttHScrollRef.current && window._ganttScrollTop.isDragging) {
                ganttHScrollRef.current.scrollLeft = window._ganttScrollLeft.value;
              }
              if (headerScrollRef.current && window._ganttScrollTop.isDragging) {
                headerScrollRef.current.scrollLeft = window._ganttScrollLeft.value;
              }
              if (workloadScrollRef.current) workloadScrollRef.current.scrollLeft = window._ganttScrollLeft.value;
              if (bottomScrollRef.current) bottomScrollRef.current.scrollLeft = window._ganttScrollLeft.value;
            };
            requestAnimationFrame(restore);
            setTimeout(restore, 0);
            setTimeout(restore, 16);
          };
          
          const wrappedMouseUp = (e) => {
            const scrollPosV = window._ganttScrollTop.value;
            const scrollPosH = window._ganttScrollLeft.value;
            handleMouseUp(e);
            // Scroll nach mouseUp wiederherstellen
            const restore = () => {
              if (ganttScrollRef.current) {
                ganttScrollRef.current.scrollTop = scrollPosV;
              }
              if (ganttHScrollRef.current) {
                ganttHScrollRef.current.scrollLeft = scrollPosH;
              }
              if (headerScrollRef.current) {
                headerScrollRef.current.scrollLeft = scrollPosH;
              }
            };
            requestAnimationFrame(restore);
            setTimeout(restore, 0);
            setTimeout(restore, 50);
            // Reset nach Delay
            setTimeout(() => {
              window._ganttScrollTop.isDragging = false;
            }, 100);
          };
          
          document.addEventListener('mousemove', wrappedMouseMove);
          document.addEventListener('mouseup', wrappedMouseUp);
          return () => { 
            document.removeEventListener('mousemove', wrappedMouseMove); 
            document.removeEventListener('mouseup', wrappedMouseUp); 
          };
        }
      }, [draggedWP, resizingWP, linkingFrom, workPackages, dependencies, DAY_WIDTH, resizeMode]);
      
      // Scroll-Position bei JEDEM Render wiederherstellen (Komponente wird bei Parent-State-Ã„nderungen remounted)
      if (!window._workloadScroll) window._workloadScroll = { top: 0 };
      React.useLayoutEffect(() => {
        // Zoom scroll restoration (takes priority)
        if (window._zoomScrollTarget !== undefined) {
          const target = window._zoomScrollTarget;
          delete window._zoomScrollTarget;
          if (ganttHScrollRef.current) {
            ganttHScrollRef.current.scrollLeft = target;
            window._ganttScrollLeft.value = target;
          }
          if (headerScrollRef.current) headerScrollRef.current.scrollLeft = target;
          if (workloadScrollRef.current) workloadScrollRef.current.scrollLeft = target;
          if (bottomScrollRef.current) bottomScrollRef.current.scrollLeft = target;
          // Also restore vertical scroll
          if (ganttScrollRef.current && window._ganttScrollTop.value !== undefined) {
            ganttScrollRef.current.scrollTop = window._ganttScrollTop.value;
          }
          return;
        }
        if (window._ganttInitScrolled) {
          if (ganttScrollRef.current && window._ganttScrollTop.value !== undefined) {
            ganttScrollRef.current.scrollTop = window._ganttScrollTop.value;
          }
          if (ganttHScrollRef.current && window._ganttScrollLeft.value !== undefined) {
            ganttHScrollRef.current.scrollLeft = window._ganttScrollLeft.value;
          }
          if (headerScrollRef.current && window._ganttScrollLeft.value !== undefined) {
            headerScrollRef.current.scrollLeft = window._ganttScrollLeft.value;
          }
          if (window._ganttScrollLeft.value !== undefined) {
            if (workloadScrollRef.current) workloadScrollRef.current.scrollLeft = window._ganttScrollLeft.value;
              if (bottomScrollRef.current) bottomScrollRef.current.scrollLeft = window._ganttScrollLeft.value;
          }
          // Workload vertical scroll restore
          if (workloadLeftRef.current) workloadLeftRef.current.scrollTop = window._workloadScroll.top;
          if (workloadScrollRef.current) workloadScrollRef.current.scrollTop = window._workloadScroll.top;
        }
      });
      
      React.useEffect(() => {
        if (!contextMenu) return;
        const handleClick = () => setContextMenu(null);
        const timer = setTimeout(() => document.addEventListener('click', handleClick), 10);
        return () => { clearTimeout(timer); document.removeEventListener('click', handleClick); };
      }, [contextMenu]);
      
      // Baseline-MenÃ¼ schlieÃŸen bei Klick auÃŸerhalb
      React.useEffect(() => {
        if (!baselineMenuOpen) return;
        const handleClick = () => setBaselineMenuOpen(false);
        const timer = setTimeout(() => document.addEventListener('click', handleClick), 10);
        return () => { clearTimeout(timer); document.removeEventListener('click', handleClick); };
      }, [baselineMenuOpen]);
      
      // Ansicht-MenÃ¼ schlieÃŸen bei Klick auÃŸerhalb
      React.useEffect(() => {
        if (!viewMenuOpen) return;
        const handleClick = () => setViewMenuOpen(false);
        const timer = setTimeout(() => document.addEventListener('click', handleClick), 10);
        return () => { clearTimeout(timer); document.removeEventListener('click', handleClick); };
      }, [viewMenuOpen]);
      
      // Spalten-MenÃ¼ schlieÃŸen bei Klick auÃŸerhalb
      React.useEffect(() => {
        if (!columnMenuOpen) return;
        const handleClick = () => setColumnMenuOpen(false);
        const timer = setTimeout(() => document.addEventListener('click', handleClick), 10);
        return () => { clearTimeout(timer); document.removeEventListener('click', handleClick); };
      }, [columnMenuOpen]);
      
      // Tag-KontextmenÃ¼ schlieÃŸen bei Klick auÃŸerhalb
      React.useEffect(() => {
        if (!dayContextMenu) return;
        const handleClick = () => setDayContextMenu(null);
        const timer = setTimeout(() => document.addEventListener('click', handleClick), 10);
        return () => { clearTimeout(timer); document.removeEventListener('click', handleClick); };
      }, [dayContextMenu]);
      
      // Workload-KontextmenÃ¼ schlieÃŸen bei Klick auÃŸerhalb
      React.useEffect(() => {
        if (!workloadContextMenu) return;
        const handleClick = () => setWorkloadContextMenu(null);
        const timer = setTimeout(() => document.addEventListener('click', handleClick), 10);
        return () => { clearTimeout(timer); document.removeEventListener('click', handleClick); };
      }, [workloadContextMenu]);
      
      // Vacation-Drag: global mousemove + mouseup
      React.useEffect(() => {
        if (!vacationDrag) return;
        const handleMouseMove = (e) => {
          const cell = e.target.closest('[data-vac-idx]');
          if (cell && cell.dataset.vacUserId === vacationDrag.userId) {
            const idx = parseInt(cell.dataset.vacIdx);
            setVacationDrag(prev => prev ? { ...prev, endIdx: idx } : null);
          }
        };
        const handleMouseUp = (e) => {
          if (vacationDrag && vacationDrag.endIdx !== undefined) {
            const minIdx = Math.min(vacationDrag.startIdx, vacationDrag.endIdx);
            const maxIdx = Math.max(vacationDrag.startIdx, vacationDrag.endIdx);
            const dates = [];
            for (let i = minIdx; i <= maxIdx; i++) {
              if (i >= 0 && i < allDays.length) {
                const day = allDays[i];
                const dow = day.getDay();
                if (dow !== 0 && dow !== 6) dates.push(formatDate(day));
              }
            }
            if (dates.length > 0) {
              const hasExisting = dates.some(ds => vacations.some(v => v.userId === vacationDrag.userId && v.date === ds));
              setVacationTypePicker({ x: e.clientX, y: e.clientY, userId: vacationDrag.userId, dates, hasExisting });
            }
          }
          setVacationDrag(null);
        };
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        return () => {
          document.removeEventListener('mousemove', handleMouseMove);
          document.removeEventListener('mouseup', handleMouseUp);
        };
      }, [vacationDrag, allDays, vacations]);
      
      // Resource Downtime Drag
      React.useEffect(() => {
        if (!resDownDrag) return;
        const handleMouseMove = (e) => {
          const cell = e.target.closest('[data-rdt-idx]');
          if (cell && cell.dataset.rdtResId === resDownDrag.resId) {
            const idx = parseInt(cell.dataset.rdtIdx);
            setResDownDrag(prev => prev ? { ...prev, endIdx: idx } : null);
          }
        };
        const handleMouseUp = (e) => {
          if (resDownDrag && resDownDrag.endIdx !== undefined) {
            const minIdx = Math.min(resDownDrag.startIdx, resDownDrag.endIdx);
            const maxIdx = Math.max(resDownDrag.startIdx, resDownDrag.endIdx);
            const dates = [];
            for (let i = minIdx; i <= maxIdx; i++) {
              if (i >= 0 && i < allDays.length) {
                const day = allDays[i];
                const dow = day.getDay();
                if (dow !== 0 && dow !== 6) dates.push(formatDate(day));
              }
            }
            if (dates.length > 0) {
              const hasExisting = dates.some(ds => resourceDowntime.some(v => v.resId === resDownDrag.resId && v.date === ds));
              setResDownTypePicker({ x: e.clientX, y: e.clientY, resId: resDownDrag.resId, dates, hasExisting });
            }
          }
          setResDownDrag(null);
        };
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        return () => {
          document.removeEventListener('mousemove', handleMouseMove);
          document.removeEventListener('mouseup', handleMouseUp);
        };
      }, [resDownDrag, allDays, resourceDowntime]);
      
      // Resource Downtime Typ-Picker schlieÃŸen
      React.useEffect(() => {
        if (!resDownTypePicker) return;
        const handleClick = () => setResDownTypePicker(null);
        setTimeout(() => document.addEventListener('click', handleClick), 0);
        return () => document.removeEventListener('click', handleClick);
      }, [resDownTypePicker]);
      
      // Vacation-Typ-Picker schlieÃŸen bei Klick auÃŸerhalb
      React.useEffect(() => {
        if (!vacationTypePicker) return;
        const handleClick = () => setVacationTypePicker(null);
        const timer = setTimeout(() => document.addEventListener('click', handleClick), 10);
        return () => { clearTimeout(timer); document.removeEventListener('click', handleClick); };
      }, [vacationTypePicker]);
      
      // ESC-Taste zum Aufheben der Multi-Auswahl, Tab/Shift+Tab zum EinrÃ¼cken/AusrÃ¼cken
      React.useEffect(() => {
        const handleKeyDown = (e) => {
          const isInput = ['INPUT', 'TEXTAREA'].includes(document.activeElement?.tagName);
          // Ctrl+Z = Undo
          if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey && !isInput) {
            e.preventDefault(); performUndo();
          }
          // Ctrl+Y or Ctrl+Shift+Z = Redo
          if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey)) && !isInput) {
            e.preventDefault(); performRedo();
          }
          // Ctrl+F = Suche
          if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
            e.preventDefault(); setGanttSearchOpen(true); setTimeout(() => ganttSearchRef.current?.focus(), 50);
          }
          if (e.key === 'Escape') {
            if (ganttSearchOpen) { setGanttSearchOpen(false); setGanttSearch(''); }
            if (selectedWPs.length > 0) setSelectedWPs([]);
          }
          // F2 = Umbenennen (wenn ein WP selektiert)
          if (e.key === 'F2' && selectedWP && !isInput) {
            e.preventDefault(); setEditingName(selectedWP.id);
          }
          // Tab = EinrÃ¼cken, Shift+Tab = AusrÃ¼cken (nur wenn WPs selektiert)
          if (e.key === 'Tab' && selectedWPs.length > 0) {
            e.preventDefault();
            if (e.shiftKey) { bulkOutdent(); } else { bulkIndent(); }
          }
          // Delete = LÃ¶schen (nur wenn WPs selektiert und kein Input fokussiert)
          if (e.key === 'Delete' && selectedWPs.length > 0 && !isInput) {
            e.preventDefault(); bulkDelete();
          }
        };
        document.addEventListener('keydown', handleKeyDown);
        return () => document.removeEventListener('keydown', handleKeyDown);
      }, [selectedWPs.length, selectedWP, ganttSearchOpen]);
      
      // Panel-Resize Handler (window-scope fÃ¼r Remount-StabilitÃ¤t)
      React.useEffect(() => {
        if (!isResizingPanel) return;
        const sidebarWidth = projectSidebarCollapsed ? 40 : 224;
        const handleMouseMove = (e) => {
          let newWidth = Math.round(Math.max(0, Math.min(800, e.clientX - sidebarWidth)));
          if (newWidth < 80) newWidth = 0;
          else if (newWidth < 200) newWidth = 200;
          // Direkt DOM manipulieren wÃ¤hrend des Resize fÃ¼r flÃ¼ssiges Ergebnis
          const listEls = document.querySelectorAll('[data-panel-list]');
          listEls.forEach(el => { el.style.width = newWidth + 'px'; });
          window._ganttResizingPanel.lastWidth = newWidth;
        };
        const handleMouseUp = () => {
          const finalWidth = window._ganttResizingPanel.lastWidth;
          if (finalWidth !== undefined) setLeftPanelWidth(finalWidth);
          setIsResizingPanel(false);
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        };
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        return () => {
          document.removeEventListener('mousemove', handleMouseMove);
          document.removeEventListener('mouseup', handleMouseUp);
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        };
      }, [isResizingPanel, projectSidebarCollapsed]);
      
      // Column-Resize Handler (fÃ¼r individuelle Spaltenbreiten)
      React.useEffect(() => {
        if (!resizingColumn) return;
        let lastWidth = resizingColumn.startWidth;
        const handleMouseMove = (e) => {
          const diff = e.clientX - resizingColumn.startX;
          const newWidth = Math.round(Math.max(35, Math.min(200, resizingColumn.startWidth + diff)));
          if (newWidth !== lastWidth) {
            lastWidth = newWidth;
            setColumnWidths(prev => ({ ...prev, [resizingColumn.key]: newWidth }));
          }
        };
        const handleMouseUp = () => {
          setResizingColumn(null);
        };
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        return () => {
          document.removeEventListener('mousemove', handleMouseMove);
          document.removeEventListener('mouseup', handleMouseUp);
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        };
      }, [resizingColumn, setColumnWidths]);
      
      // Hilfsfunktion: Datum als dd.mm.yy formatieren
      const formatDateShort = (dateStr) => {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = String(d.getFullYear()).slice(-2);
        return `${day}.${month}.${year}`;
      };
      
      // Row-Drag Handler
      React.useEffect(() => {
        if (!rowDragWP) return;
        
        const handleMouseUp = () => {
          if (dropTarget && rowDragWP) {
            moveWorkPackage(rowDragWP.id, dropTarget.wpId, dropTarget.position);
          }
          setRowDragWP(null);
          setDropTarget(null);
        };
        
        document.addEventListener('mouseup', handleMouseUp);
        return () => document.removeEventListener('mouseup', handleMouseUp);
      }, [rowDragWP, dropTarget]);
      
      const renderBracket = (wp, x, width, color) => {
        const totalHours = calculateTotalHours(wp.id);
        const isDragging = draggedWP?.wp?.id === wp.id;
        const displayX = isDragging && draggedWP.daysDiff ? x + (draggedWP.daysDiff * DAY_WIDTH) : x;
        const assignmentText = showAssignments ? getAssignmentText(wp) : '';
        
        return (
          <React.Fragment>
            {/* Link handles for dependencies */}
            <div 
              className="absolute"
              data-wp-id={wp.id}
              style={{ left: displayX, width: Math.max(width, DAY_WIDTH), top: 0, height: ROW_HEIGHT, zIndex: 5, overflow: 'visible' }}
              onMouseEnter={(e) => { if (!draggedWP && !resizingWP && !linkingFrom) { setHoveredWP({ wp, totalHours }); }}}
              onMouseLeave={(e) => { if (!draggedWP && !resizingWP && !linkingFrom) setHoveredWP(null); }}
            >
              {hoveredWP?.wp.id === wp.id && (
                <React.Fragment>
                  <div className="link-handle absolute w-5 h-5 rounded-full bg-indigo-500 border-2 border-white shadow-lg cursor-crosshair hover:bg-indigo-600 hover:scale-125 transition-all"
                    style={{ left: -20, top: '50%', transform: 'translateY(-50%)', zIndex: 35 }}
                    onMouseDown={(e) => { e.stopPropagation(); e.preventDefault(); const rect = e.target.getBoundingClientRect(); setLinkingFrom({ ...wp, startX: rect.left + rect.width / 2, startY: rect.top + rect.height / 2, fromStart: true }); setLinkMousePos({ x: e.clientX, y: e.clientY }); }}
                    title="Start-AbhÃ¤ngigkeit (SS)" />
                  <div className="link-handle absolute w-5 h-5 rounded-full bg-indigo-500 border-2 border-white shadow-lg cursor-crosshair hover:bg-indigo-600 hover:scale-125 transition-all"
                    style={{ right: -20, top: '50%', transform: 'translateY(-50%)', zIndex: 35 }}
                    onMouseDown={(e) => { e.stopPropagation(); e.preventDefault(); const rect = e.target.getBoundingClientRect(); setLinkingFrom({ ...wp, startX: rect.left + rect.width / 2, startY: rect.top + rect.height / 2, fromStart: false }); setLinkMousePos({ x: e.clientX, y: e.clientY }); }}
                    title="Ende-AbhÃ¤ngigkeit (FS)" />
                </React.Fragment>
              )}
            </div>
            <div 
              className="absolute cursor-move group"
              style={{ left: displayX, width, top: 4, height: ROW_HEIGHT - 8, opacity: isDragging ? 0.6 : isWPDone(wp.id, workPackages) ? 0.4 : 1 }}
              data-wp-id={wp.id}
              onMouseEnter={(e) => { if (!draggedWP) { const rect = e.currentTarget.getBoundingClientRect(); setHoveredWP({ wp, x: rect.left, y: rect.bottom + 5, totalHours }); }}}
              onMouseLeave={() => setHoveredWP(null)}
              onClick={(e) => { e.stopPropagation(); if (sidebarWPId && !detailsCollapsed) { openSidebar(wp.id); } else { setSelectedWP(wp); } }}
              onDoubleClick={(e) => { e.stopPropagation(); e.preventDefault(); openSidebar(wp.id); }}
              onContextMenu={(e) => { e.preventDefault(); e.stopPropagation(); setContextMenu({ x: e.clientX, y: e.clientY, type: 'gantt-wp', wp, project: projects.find(p => p.id === wp.projectId) }); }}
              onMouseDown={(e) => { if (e.detail > 1) return; if (getAllDescendants(wp.id, workPackages).some(d => d.locked)) return; e.preventDefault(); if (ganttScrollRef.current) { window._ganttScrollTop.value = ganttScrollRef.current.scrollTop; window._ganttScrollTop.isDragging = true; } if (ganttHScrollRef.current) { window._ganttScrollLeft.value = ganttHScrollRef.current.scrollLeft; } const calcDates = calculateDatesFromChildren(wp.id, workPackages); setDraggedWP({ wp, startX: e.clientX, originalX: dateToX(calcDates?.startDate), isSummary: true, daysDiff: 0 }); }}
            >
              <div className="absolute left-0 top-0 w-1.5 h-full" style={{ borderLeft: `2px solid ${color}`, borderTop: `2px solid ${color}`, borderTopLeftRadius: 3 }} />
              <div className="absolute top-0 left-1.5 right-1.5" style={{ borderTop: `2px solid ${color}` }} />
              <div className="absolute left-1/2 -translate-x-1/2 -top-1"><div className="w-2 h-2 rotate-45" style={{ backgroundColor: color }} /></div>
              <div className="absolute right-0 top-0 w-1.5 h-full" style={{ borderRight: `2px solid ${color}`, borderTop: `2px solid ${color}`, borderTopRightRadius: 3 }} />
            </div>
            <div className="absolute text-xs whitespace-nowrap pointer-events-none flex items-center" style={{ left: displayX + width + 8, top: ROW_HEIGHT / 2 - 7 }}>
              {(() => { const progress = getWPProgress(wp.id, workPackages); const pct = progress.total > 0 ? Math.round(progress.done / progress.total * 100) : 0; return pct === 100 ? <span className="text-green-500 mr-1"><CheckCircle2 className="w-3.5 h-3.5" /></span> : progress.total > 0 ? <span className="text-gray-400 mr-1 text-[10px] font-medium">{pct}%</span> : null; })()}
              {criticalPathIds.has(wp.id) && <span className="text-red-500 mr-1 text-[10px]" title="Kritischer Pfad">â—</span>}
              <span className={`text-gray-700 font-medium ${isWPDone(wp.id, workPackages) ? 'line-through opacity-50' : ''}`}>{wp.name}</span>
              {showHours && totalHours > 0 && <span className="text-gray-500 ml-2">{totalHours}h</span>}
              {assignmentText && <span className="text-indigo-500 ml-2">{assignmentText}</span>}
            </div>
          </React.Fragment>
        );
      };
      
      const renderBar = (wp, x, width, color, isChild) => {
        const isDragging = draggedWP?.wp?.id === wp.id;
        const isResizing = resizingWP?.wp.id === wp.id;
        const hasChildren = getChildren(wp.id, workPackages).length > 0;
        const isSelected = selectedWP?.id === wp.id;
        const isSidebarActive = sidebarWPId === wp.id;
        const totalHours = calculateTotalHours(wp.id);
        const textWidth = wp.name.length * 6;
        const textFitsInBar = textWidth < width - 10;
        const assignmentText = showAssignments ? getAssignmentText(wp) : '';
        const isCritical = criticalPathIds.has(wp.id);
        const isSearchMatch = searchMatchIds.has(wp.id);
        const progress = getWPProgress(wp.id, workPackages);
        const checklistPct = progress.total > 0 ? Math.round(progress.done / progress.total * 100) : 0;
        const hoursPct = (wp.actualHours > 0 && wp.plannedHours > 0) ? Math.min(100, Math.round((wp.actualHours / wp.plannedHours) * 100)) : 0;
        const progressPct = Math.max(checklistPct, hoursPct);
        
        return (
          <React.Fragment>
            {/* Hover-Container fÃ¼r Link-Handles - BalkengrÃ¶ÃŸe, Dots ragen raus */}
            <div 
              className="absolute"
              style={{ left: x, width: Math.max(width, DAY_WIDTH), top: 0, height: ROW_HEIGHT, zIndex: 5, overflow: 'visible' }}
              onMouseEnter={(e) => { if (!draggedWP && !resizingWP && !linkingFrom) { setHoveredWP({ wp, totalHours }); }}}
              onMouseLeave={(e) => { 
                if (!draggedWP && !resizingWP && !linkingFrom) setHoveredWP(null); 
              }}
            >
              {/* Link-Handles - weiter auÃŸen vom Balken */}
              {hoveredWP?.wp.id === wp.id && (
                <React.Fragment>
                  <div className="link-handle absolute w-5 h-5 rounded-full bg-indigo-500 border-2 border-white shadow-lg cursor-crosshair hover:bg-indigo-600 hover:scale-125 transition-all"
                    style={{ left: -20, top: '50%', transform: 'translateY(-50%)', zIndex: 35 }}
                    onMouseDown={(e) => { e.stopPropagation(); e.preventDefault(); const rect = e.target.getBoundingClientRect(); setLinkingFrom({ ...wp, startX: rect.left + rect.width / 2, startY: rect.top + rect.height / 2, fromStart: true }); setLinkMousePos({ x: e.clientX, y: e.clientY }); }}
                    title="Start-AbhÃ¤ngigkeit (SS)" />
                  <div className="link-handle absolute w-5 h-5 rounded-full bg-indigo-500 border-2 border-white shadow-lg cursor-crosshair hover:bg-indigo-600 hover:scale-125 transition-all"
                    style={{ right: -20, top: '50%', transform: 'translateY(-50%)', zIndex: 35 }}
                    onMouseDown={(e) => { e.stopPropagation(); e.preventDefault(); const rect = e.target.getBoundingClientRect(); setLinkingFrom({ ...wp, startX: rect.left + rect.width / 2, startY: rect.top + rect.height / 2, fromStart: false }); setLinkMousePos({ x: e.clientX, y: e.clientY }); }}
                    title="Ende-AbhÃ¤ngigkeit (FS)" />
                </React.Fragment>
              )}
            </div>
            <div data-wp-id={wp.id} className={`absolute rounded shadow-sm cursor-pointer group ${isSidebarActive ? 'ring-2 ring-blue-500 ring-offset-1' : isSelected ? 'ring-2 ring-indigo-500 ring-offset-1' : isSearchMatch ? 'ring-2 ring-yellow-400 ring-offset-1' : isCritical ? 'ring-2 ring-red-500 ring-offset-1' : ''}`}
              style={{ left: x, width: Math.max(width, DAY_WIDTH), top: isChild ? 6 : 4, height: isChild ? ROW_HEIGHT - 12 : ROW_HEIGHT - 8, backgroundColor: color, opacity: isDragging || isResizing ? 0.6 : isWPDone(wp.id, workPackages) ? 0.45 : 1, zIndex: 6, overflow: 'hidden' }}
              onClick={(e) => { e.stopPropagation(); if (sidebarWPId && !detailsCollapsed) { openSidebar(wp.id); } else { setSelectedWP(wp); } }}
              onDoubleClick={(e) => { e.stopPropagation(); e.preventDefault(); openSidebar(wp.id); }}
              onContextMenu={(e) => { e.preventDefault(); e.stopPropagation(); setContextMenu({ x: e.clientX, y: e.clientY, type: 'gantt-wp', wp, project: projects.find(p => p.id === wp.projectId) }); }}
              onMouseEnter={(e) => { if (!draggedWP && !resizingWP && !linkingFrom) { setHoveredWP({ wp, totalHours }); }}}
              onMouseDown={(e) => { if (e.detail > 1) return; if (wp.locked || e.target.classList.contains('resize-handle') || e.target.classList.contains('link-handle')) return; if (hasChildren && getAllDescendants(wp.id, workPackages).some(d => d.locked)) return; e.preventDefault(); if (ganttScrollRef.current) { window._ganttScrollTop.value = ganttScrollRef.current.scrollTop; window._ganttScrollTop.isDragging = true; } if (ganttHScrollRef.current) { window._ganttScrollLeft.value = ganttHScrollRef.current.scrollLeft; } if (hasChildren) { const calcDates = calculateDatesFromChildren(wp.id, workPackages); setDraggedWP({ wp, startX: e.clientX, originalX: dateToX(calcDates?.startDate), isSummary: true, daysDiff: 0 }); } else { setDraggedWP({ wp, startX: e.clientX, originalX: x, isSummary: false }); } }}>
              {/* Progress fill */}
              {progressPct > 0 && progressPct < 100 && <div className="absolute left-0 top-0 bottom-0 rounded-l" style={{ width: `${progressPct}%`, backgroundColor: 'rgba(255,255,255,0.25)', pointerEvents: 'none' }} />}
              {textFitsInBar && <div className="px-1 text-white text-xs truncate relative" style={{ fontSize: 10, lineHeight: `${isChild ? ROW_HEIGHT - 12 : ROW_HEIGHT - 8}px` }}>{wp.name}</div>}
              {!hasChildren && !wp.locked && <div className="resize-handle absolute left-0 top-0 bottom-0 w-3 cursor-ew-resize opacity-0 group-hover:opacity-100 bg-white/30 rounded-l" onMouseDown={(e) => { e.stopPropagation(); if (ganttScrollRef.current) { window._ganttScrollTop.value = ganttScrollRef.current.scrollTop; window._ganttScrollTop.isDragging = true; } if (ganttHScrollRef.current) { window._ganttScrollLeft.value = ganttHScrollRef.current.scrollLeft; } setResizingWP({ wp, startX: e.clientX, originalStartX: x, originalEndX: x + width, side: 'left' }); }} />}
              {!hasChildren && !wp.locked && <div className="resize-handle absolute right-0 top-0 bottom-0 w-3 cursor-ew-resize opacity-0 group-hover:opacity-100 bg-white/30 rounded-r" onMouseDown={(e) => { e.stopPropagation(); if (ganttScrollRef.current) { window._ganttScrollTop.value = ganttScrollRef.current.scrollTop; window._ganttScrollTop.isDragging = true; } if (ganttHScrollRef.current) { window._ganttScrollLeft.value = ganttHScrollRef.current.scrollLeft; } setResizingWP({ wp, startX: e.clientX, originalStartX: x, originalEndX: x + width, side: 'right' }); }} />}
            </div>
            <div className="absolute text-xs whitespace-nowrap pointer-events-none flex items-center" style={{ left: x + width + 4, top: ROW_HEIGHT / 2 - 7 }}>
              {isWPDone(wp.id, workPackages) && <span className="text-green-500 mr-1 flex-shrink-0"><CheckCircle2 className="w-3.5 h-3.5" /></span>}
              {!isWPDone(wp.id, workPackages) && progressPct > 0 && <span className="text-gray-400 mr-1 text-[10px] font-medium">{progressPct}%</span>}
              {wp.locked && <span className="text-orange-500 mr-1" title="Termin fixiert">ðŸ”’</span>}
              {isCritical && <span className="text-red-500 mr-1 text-[10px]" title="Kritischer Pfad">â—</span>}
              {showHours && totalHours > 0 && <span className="text-gray-500">{totalHours}h</span>}
              {!textFitsInBar && <span className={`ml-1 text-gray-600 ${isWPDone(wp.id, workPackages) ? 'line-through opacity-50' : ''}`}>{wp.name}</span>}
              {assignmentText && <span className="text-indigo-500 ml-2">{assignmentText}</span>}
            </div>
          </React.Fragment>
        );
      };
      
      const renderMilestone = (wp, x, color) => {
        const isDragging = draggedWP?.wp?.id === wp.id;
        const isSelected = selectedWP?.id === wp.id;
        const isSidebarActive = sidebarWPId === wp.id;
        const assignmentText = showAssignments ? getAssignmentText(wp) : '';
        const size = 14;
        const centerX = x + Math.floor(DAY_WIDTH / 2);
        
        let displayX = centerX - size / 2;
        if (isDragging && draggedWP.previewStart) {
          displayX = dateToX(draggedWP.previewStart) + Math.floor(DAY_WIDTH / 2) - size / 2;
        }
        
        return (
          <React.Fragment>
            {/* Hit area for interactions + link handles */}
            <div 
              className="absolute"
              data-wp-id={wp.id}
              style={{ left: displayX - 10, width: size + 20, top: 0, height: ROW_HEIGHT, zIndex: 5, overflow: 'visible' }}
              onMouseEnter={(e) => { if (!draggedWP && !resizingWP && !linkingFrom) { setHoveredWP({ wp, totalHours: 0 }); }}}
              onMouseLeave={(e) => { if (!draggedWP && !resizingWP && !linkingFrom) setHoveredWP(null); }}
            >
              {hoveredWP?.wp.id === wp.id && (
                <React.Fragment>
                  <div className="link-handle absolute w-5 h-5 rounded-full bg-indigo-500 border-2 border-white shadow-lg cursor-crosshair hover:bg-indigo-600 hover:scale-125 transition-all"
                    style={{ left: -14, top: '50%', transform: 'translateY(-50%)', zIndex: 35 }}
                    onMouseDown={(e) => { e.stopPropagation(); e.preventDefault(); const rect = e.target.getBoundingClientRect(); setLinkingFrom({ ...wp, startX: rect.left + rect.width / 2, startY: rect.top + rect.height / 2, fromStart: true }); setLinkMousePos({ x: e.clientX, y: e.clientY }); }}
                    title="Start-AbhÃ¤ngigkeit (SS)" />
                  <div className="link-handle absolute w-5 h-5 rounded-full bg-indigo-500 border-2 border-white shadow-lg cursor-crosshair hover:bg-indigo-600 hover:scale-125 transition-all"
                    style={{ right: -14, top: '50%', transform: 'translateY(-50%)', zIndex: 35 }}
                    onMouseDown={(e) => { e.stopPropagation(); e.preventDefault(); const rect = e.target.getBoundingClientRect(); setLinkingFrom({ ...wp, startX: rect.left + rect.width / 2, startY: rect.top + rect.height / 2, fromStart: false }); setLinkMousePos({ x: e.clientX, y: e.clientY }); }}
                    title="Ende-AbhÃ¤ngigkeit (FS)" />
                </React.Fragment>
              )}
            </div>
            {/* Diamond shape */}
            <div 
              className="absolute cursor-move"
              style={{ left: displayX, top: ROW_HEIGHT / 2 - size / 2, width: size, height: size, opacity: isDragging ? 0.6 : isWPDone(wp.id, workPackages) ? 0.4 : 1, zIndex: 6 }}
              data-wp-id={wp.id}
              onMouseEnter={(e) => { if (!draggedWP) { const rect = e.currentTarget.getBoundingClientRect(); setHoveredWP({ wp, x: rect.left, y: rect.bottom + 5, totalHours: 0 }); }}}
              onMouseLeave={() => setHoveredWP(null)}
              onClick={(e) => { e.stopPropagation(); if (sidebarWPId && !detailsCollapsed) { openSidebar(wp.id); } else { setSelectedWP(wp); } }}
              onDoubleClick={(e) => { e.stopPropagation(); e.preventDefault(); openSidebar(wp.id); }}
              onContextMenu={(e) => { e.preventDefault(); e.stopPropagation(); setContextMenu({ x: e.clientX, y: e.clientY, type: 'gantt-wp', wp, project: projects.find(p => p.id === wp.projectId) }); }}
              onMouseDown={(e) => { 
                if (e.detail > 1) return; 
                if (wp.locked) return;
                e.preventDefault(); 
                if (ganttScrollRef.current) { window._ganttScrollTop.value = ganttScrollRef.current.scrollTop; window._ganttScrollTop.isDragging = true; } 
                if (ganttHScrollRef.current) { window._ganttScrollLeft.value = ganttHScrollRef.current.scrollLeft; } 
                setDraggedWP({ wp, startX: e.clientX, originalX: x, isSummary: false, daysDiff: 0 }); 
              }}
            >
              <div className="w-full h-full rotate-45" style={{ 
                backgroundColor: color, 
                border: (isSelected || isSidebarActive) ? '2px solid #312e81' : 'none',
                boxShadow: isSidebarActive ? '0 0 0 2px rgba(99,102,241,0.4)' : criticalPathIds.has(wp.id) ? '0 0 0 3px rgba(239,68,68,0.6)' : searchMatchIds.has(wp.id) ? '0 0 0 3px rgba(250,204,21,0.6)' : undefined
              }} />
            </div>
            {/* Label */}
            <div className="absolute text-xs whitespace-nowrap pointer-events-none flex items-center" style={{ left: displayX + size + 8, top: ROW_HEIGHT / 2 - 7 }}>
              {isWPDone(wp.id, workPackages) && <span className="text-green-500 mr-1 flex-shrink-0"><CheckCircle2 className="w-3.5 h-3.5" /></span>}
              {wp.locked && <span className="text-orange-500 mr-1" title="Termin fixiert">ðŸ”’</span>}
              {criticalPathIds.has(wp.id) && <span className="text-red-500 mr-1 text-[10px]" title="Kritischer Pfad">â—</span>}
              <span className={`text-gray-600 ${isWPDone(wp.id, workPackages) ? 'line-through opacity-50' : ''}`}>{wp.name}</span>
              {assignmentText && <span className="text-indigo-500 ml-2">{assignmentText}</span>}
            </div>
          </React.Fragment>
        );
      };
      
      // Projekt-Filterung (muss VOR allProjectsData definiert werden!)
      // PrioritÃ¤t: einzelnes Projekt > Ordner > alle
      const filteredProjects = selectedProjectId 
        ? (projects || []).filter(p => p.id === selectedProjectId && !p.archived) 
        : selectedFolderId
          ? (projects || []).filter(p => p.folderId === selectedFolderId && !p.archived)
          : (projects || []).filter(p => !p.archived);
      
      const allProjectsData = (filteredProjects || []).map(project => ({
        project,
        flatList: getFlatSortedList(project.id)
      }));
      
      // === Kritischer Pfad Berechnung ===
      const criticalPathIds = React.useMemo(() => {
        if (!showCriticalPath || dependencies.length === 0) return new Set();
        // Build adjacency list and compute earliest/latest dates
        const wpMap = {};
        workPackages.forEach(wp => {
          const children = getChildren(wp.id, workPackages);
          const dates = children.length > 0 ? calculateDatesFromChildren(wp.id, workPackages) : { startDate: wp.startDate, endDate: wp.endDate };
          wpMap[wp.id] = { start: dates?.startDate ? parseLocalDate(dates.startDate).getTime() : 0, end: dates?.endDate ? parseLocalDate(dates.endDate).getTime() : 0, duration: 0 };
          if (wpMap[wp.id].start && wpMap[wp.id].end) wpMap[wp.id].duration = (wpMap[wp.id].end - wpMap[wp.id].start) / 86400000;
        });
        // Forward pass: earliest start
        const earliest = {};
        const successors = {};
        const predecessors = {};
        dependencies.forEach(dep => {
          if (!successors[dep.fromId]) successors[dep.fromId] = [];
          successors[dep.fromId].push(dep);
          if (!predecessors[dep.toId]) predecessors[dep.toId] = [];
          predecessors[dep.toId].push(dep);
        });
        const allWPIds = new Set(dependencies.flatMap(d => [d.fromId, d.toId]));
        // Find roots (no predecessors)
        const roots = [...allWPIds].filter(id => !predecessors[id] || predecessors[id].length === 0);
        // BFS forward pass
        allWPIds.forEach(id => { earliest[id] = wpMap[id]?.start || 0; });
        const queue = [...roots];
        const visited = new Set();
        while (queue.length > 0) {
          const id = queue.shift();
          if (visited.has(id)) continue;
          visited.add(id);
          (successors[id] || []).forEach(dep => {
            const fromEnd = wpMap[dep.fromId]?.end || 0;
            if (fromEnd > (earliest[dep.toId] || 0)) earliest[dep.toId] = fromEnd;
            queue.push(dep.toId);
          });
        }
        // Find the latest end time among all nodes
        let projectEnd = 0;
        allWPIds.forEach(id => { const e = wpMap[id]?.end || 0; if (e > projectEnd) projectEnd = e; });
        // Backward pass: latest finish
        const latest = {};
        allWPIds.forEach(id => { latest[id] = projectEnd; });
        const leaves = [...allWPIds].filter(id => !successors[id] || successors[id].length === 0);
        const bQueue = [...leaves];
        const bVisited = new Set();
        while (bQueue.length > 0) {
          const id = bQueue.shift();
          if (bVisited.has(id)) continue;
          bVisited.add(id);
          (predecessors[id] || []).forEach(dep => {
            const toStart = earliest[dep.toId] || 0;
            const slack = toStart - (wpMap[dep.fromId]?.end || 0);
            const latestForFrom = (latest[id] || projectEnd) - (wpMap[id]?.duration || 0) * 86400000;
            if (latestForFrom < (latest[dep.fromId] || projectEnd)) latest[dep.fromId] = latestForFrom;
            bQueue.push(dep.fromId);
          });
        }
        // Critical = no slack (earliest â‰ˆ latest within 1 day tolerance)
        const critical = new Set();
        const tolerance = 86400000; // 1 day
        allWPIds.forEach(id => {
          const es = earliest[id] || 0;
          const ls = latest[id] || projectEnd;
          const wpEnd = wpMap[id]?.end || 0;
          if (Math.abs(ls - wpEnd) <= tolerance || Math.abs(es - (earliest[id] || 0)) <= tolerance) {
            // Simplified: node is critical if it's on a path from root to leaf with minimal slack
            const slack = (wpMap[id]?.end || 0) > 0 ? Math.abs(ls - (wpMap[id]?.end || 0)) : Infinity;
            if (slack <= tolerance) critical.add(id);
          }
        });
        return critical;
      }, [showCriticalPath, dependencies, workPackages]);
      
      // === Suche: Treffer-IDs ===
      const searchMatchIds = React.useMemo(() => {
        if (!ganttSearch.trim()) return new Set();
        const q = ganttSearch.toLowerCase().trim();
        return new Set(workPackages.filter(wp => wp.name?.toLowerCase().includes(q)).map(wp => wp.id));
      }, [ganttSearch, workPackages]);
      
      // Berechne Monate fÃ¼r Header
      const getMonthsForWeeks = () => {
        const months = [];
        let currentMonth = null;
        let startWeekIdx = 0;
        
        weekNumbers.forEach((weekNum, idx) => {
          const weekDates = getWeekDates(weekNum, new Date().getFullYear());
          const monthIdx = weekDates[0].getMonth();
          const monthName = monthNames[monthIdx];
          
          if (monthName !== currentMonth) {
            if (currentMonth !== null) {
              months.push({ name: currentMonth, weeks: idx - startWeekIdx });
            }
            currentMonth = monthName;
            startWeekIdx = idx;
          }
        });
        months.push({ name: currentMonth, weeks: weekNumbers.length - startWeekIdx });
        return months;
      };
      
      const monthHeaders = getMonthsForWeeks();
      
      const UserAssignmentSection = ({ wpId, field, label, filterKey, stretch }) => {
        const wp = workPackages.find(w => w.id === wpId);
        const scrollRef = React.useRef(null);
        const scrollKey = `${wpId}-${field}`;
        const [searchText, setSearchText] = React.useState('');
        
        // Scroll-Position nach jedem Render wiederherstellen
        React.useLayoutEffect(() => {
          if (scrollRef.current && _scrollPositions[scrollKey]) {
            scrollRef.current.scrollTop = _scrollPositions[scrollKey];
          }
        });
        
        if (!wp) return null;
        const assignments = wp[field] || [];
        const isFiltered = filterAssigned[filterKey];
        let filteredUsers = isFiltered ? sortedUsers.filter(u => isUserAssigned(assignments, u.id)) : sortedUsers;
        if (searchText.trim()) {
          const q = searchText.trim().toLowerCase();
          filteredUsers = filteredUsers.filter(u => u.name.toLowerCase().includes(q));
        }
        
        const saveScroll = () => {
          if (scrollRef.current) _scrollPositions[scrollKey] = scrollRef.current.scrollTop;
        };
        
        const handleToggle = (userId, checked) => {
          saveScroll();
          toggleUserAssignment(wpId, field, userId, checked, 0);
        };
        
        const handleHoursChange = (userId, value) => {
          saveScroll();
          updateUserHours(wpId, field, userId, parseFloat(value) || 0);
        };
        
        return (
          <div className={stretch ? 'flex flex-col flex-1 min-h-0' : ''}>
            <div className="flex items-center justify-between mb-1 flex-shrink-0">
              <label className="text-xs font-semibold text-gray-600">{label}</label>
              <button onClick={(e) => { e.stopPropagation(); setFilterAssigned(prev => ({ ...prev, [filterKey]: !prev[filterKey] })); }} className={`text-xs px-2 py-0.5 rounded ${isFiltered ? 'bg-indigo-100 text-indigo-700' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}>
                {isFiltered ? 'Alle zeigen' : 'Nur zugewiesene'}
              </button>
            </div>
            <div className="mb-1 flex-shrink-0">
              <input 
                type="text" 
                value={searchText} 
                onChange={(e) => setSearchText(e.target.value)} 
                placeholder="ðŸ” Suchen..." 
                onClick={(e) => e.stopPropagation()} 
                className="w-full px-2 py-0.5 border rounded text-xs bg-gray-50 focus:bg-white focus:ring-1 focus:ring-indigo-300 focus:outline-none"
              />
            </div>
            <div ref={scrollRef} className={`space-y-0.5 overflow-y-auto border rounded p-1.5 ${stretch ? 'flex-1 min-h-0' : (viewMode === 'wide' ? 'max-h-20' : 'max-h-28')}`}>
              {filteredUsers.length === 0 ? (
                <div className="text-xs text-gray-400 italic">{searchText ? 'Keine Treffer' : 'Keine Zuweisungen'}</div>
              ) : filteredUsers.map(user => {
                const isAssigned = isUserAssigned(assignments, user.id);
                const hours = getUserHours(assignments, user.id);
                return (
                  <div key={user.id} className="flex items-center gap-2 text-xs hover:bg-gray-50 p-1 rounded">
                    <input type="checkbox" checked={isAssigned} onClick={(e) => e.stopPropagation()} onChange={(e) => handleToggle(user.id, e.target.checked)} className="rounded flex-shrink-0" />
                    <span className="flex-1 truncate">{user.name}</span>
                    {isAssigned && (
                      <input 
                        type="number" 
                        min="0" 
                        step="0.5" 
                        key={`${user.id}-${hours}`}
                        defaultValue={hours || ''} 
                        placeholder="0" 
                        onClick={(e) => e.stopPropagation()} 
                        onBlur={(e) => handleHoursChange(user.id, e.target.value)}
                        onKeyDown={(e) => { if (e.key === 'Enter') e.target.blur(); }}
                        className="w-14 px-1 py-0.5 border rounded text-xs text-right" 
                      />
                    )}
                    {isAssigned && <span className="text-gray-400 text-xs">h</span>}
                  </div>
                );
              })}
            </div>
          </div>
        );
      };
      
      const ResourceAssignmentSection = ({ wpId, resourceType, label, icon, filterKey, stretch }) => {
        const wp = workPackages.find(w => w.id === wpId);
        const scrollRef = React.useRef(null);
        const scrollKey = `${wpId}-${resourceType}`;
        const [searchText, setSearchText] = React.useState('');
        
        React.useLayoutEffect(() => {
          if (scrollRef.current && _scrollPositions[scrollKey]) {
            scrollRef.current.scrollTop = _scrollPositions[scrollKey];
          }
        });
        
        if (!wp) return null;
        const isFiltered = filterAssigned[filterKey];
        const resourceIds = wp.resourceIds || [];
        const typeResources = resources.filter(r => r.type === resourceType).sort((a, b) => a.name.localeCompare(b.name, 'de'));
        let filteredResources = isFiltered ? typeResources.filter(r => resourceIds.includes(r.id)) : typeResources;
        if (searchText.trim()) {
          const q = searchText.trim().toLowerCase();
          filteredResources = filteredResources.filter(r => 
            r.name.toLowerCase().includes(q) || 
            (r.kuerzel && r.kuerzel.toLowerCase().includes(q)) ||
            (r.kennzeichen && r.kennzeichen.toLowerCase().includes(q))
          );
        }
        
        const saveScroll = () => {
          if (scrollRef.current) _scrollPositions[scrollKey] = scrollRef.current.scrollTop;
        };
        
        const handleToggle = (resId, checked) => {
          saveScroll();
          const updated = checked ? [...resourceIds, resId] : resourceIds.filter(id => id !== resId);
          updateWorkPackage(wpId, 'resourceIds', updated);
          // Remove hours if unchecked
          if (!checked && wp.resourceHours?.[resId]) {
            const newHours = { ...wp.resourceHours };
            delete newHours[resId];
            updateWorkPackage(wpId, 'resourceHours', Object.keys(newHours).length > 0 ? newHours : undefined);
          }
        };
        
        const handleResHoursChange = (resId, hours) => {
          saveScroll();
          const newHours = { ...(wp.resourceHours || {}), [resId]: parseFloat(hours) || 0 };
          updateWorkPackage(wpId, 'resourceHours', newHours);
        };
        
        return (
          <div className={stretch ? 'flex flex-col flex-1 min-h-0' : ''}>
            <div className="flex items-center justify-between mb-1 flex-shrink-0">
              <label className="text-xs font-semibold text-gray-600">{icon} {label}</label>
              <button onClick={(e) => { e.stopPropagation(); setFilterAssigned(prev => ({ ...prev, [filterKey]: !prev[filterKey] })); }} className={`text-xs px-2 py-0.5 rounded ${isFiltered ? 'bg-indigo-100 text-indigo-700' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}>
                {isFiltered ? 'Alle zeigen' : 'Nur zugewiesene'}
              </button>
            </div>
            <div className="mb-1 flex-shrink-0">
              <input 
                type="text" 
                value={searchText} 
                onChange={(e) => setSearchText(e.target.value)} 
                placeholder="ðŸ” Suchen..." 
                onClick={(e) => e.stopPropagation()} 
                className="w-full px-2 py-0.5 border rounded text-xs bg-gray-50 focus:bg-white focus:ring-1 focus:ring-indigo-300 focus:outline-none"
              />
            </div>
            <div ref={scrollRef} className={`space-y-0.5 overflow-y-auto border rounded p-1.5 ${stretch ? 'flex-1 min-h-0' : (viewMode === 'wide' ? 'max-h-20' : 'max-h-28')}`}>
              {filteredResources.length === 0 ? (
                <div className="text-xs text-gray-400 italic">{searchText ? 'Keine Treffer' : (typeResources.length === 0 ? `Keine ${label} vorhanden` : 'Keine Zuweisungen')}</div>
              ) : filteredResources.map(res => {
                const isAssigned = resourceIds.includes(res.id);
                const resHours = (wp.resourceHours || {})[res.id] || 0;
                const resCap = getResourceDailyCapacity(res);
                return (
                <label key={res.id} className="flex items-center gap-2 text-xs cursor-pointer hover:bg-gray-50 p-1 rounded">
                  <input type="checkbox" checked={isAssigned} onClick={(e) => e.stopPropagation()} onChange={(e) => handleToggle(res.id, e.target.checked)} className="rounded" />
                  <span className="flex-1 truncate">{res.name}</span>
                  {res.kuerzel && <span className="text-[10px] px-1 py-0.5 rounded bg-gray-100 font-mono text-gray-500">{res.kuerzel}</span>}
                  {res.type === 'maschine' && <span className="text-[9px]" title={res.needsOperator !== false ? 'Bediener erforderlich' : 'Autonom'}>{res.needsOperator !== false ? 'ðŸ‘¤' : 'ðŸ¤–'}</span>}
                  {isAssigned && (
                    <input 
                      type="number" min="0" step="0.5"
                      key={`${res.id}-${resHours}`}
                      defaultValue={resHours || ''} 
                      placeholder="0"
                      onClick={(e) => e.stopPropagation()} 
                      onBlur={(e) => handleResHoursChange(res.id, e.target.value)}
                      onKeyDown={(e) => { if (e.key === 'Enter') e.target.blur(); }}
                      className={`w-12 px-1 py-0.5 border rounded text-[10px] text-center ${resHours > 0 ? 'border-indigo-300 bg-indigo-50' : 'border-gray-200'}`}
                      title={`Stunden zuweisen (KapazitÃ¤t: ${resCap}h/Tag)`}
                    />
                  )}
                  {isAssigned && resHours > 0 && <span className="text-[10px] text-gray-400">h</span>}
                </label>
                );
              })}
            </div>
          </div>
        );
      };
      
      const HEADER_HEIGHT = 76; // Monat + KW + Datum + Wochentag
      
      // Baselines fÃ¼r aktuelles Projekt
      const currentProjectBaselines = selectedProjectId 
        ? (baselines || []).filter(b => b.projectId === selectedProjectId)
        : [];
      
      return (
        <div className={`dm-root h-screen flex flex-col ${darkMode ? 'dark' : ''}`} style={{background: darkMode ? '#1e1e2e' : '#f9fafb'}}>
          <div className="dm-header bg-white shadow px-4 py-2 flex items-center justify-between flex-shrink-0">
            <div className="flex items-center gap-3">
              <Calendar className="w-6 h-6 text-indigo-600" />
              <h1 className="text-lg font-bold">{showResourceCockpit ? 'ðŸ‘¥ Ressourcencockpit' : 'Projektplanung'}</h1>
              {lastSync && <span className="text-[9px] text-gray-400 flex items-center gap-1" title={`Letzter Sync: ${lastSync.toLocaleTimeString()}\nSession: ${sessionId.slice(-4)}\nDein Tier: ${myAnimalEmoji}`}><span className="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse" />{myAnimalEmoji}</span>}
              {onlineUsers.length > 0 && (
                <div className="flex items-center gap-1 ml-1">
                  {onlineUsers.map(p => {
                    const viewLabel = p.view === 'grobplanung' ? 'ðŸ“‹ Schnellplanung' : p.view === 'teamdashboard' ? 'ðŸ“Š Team DB' : p.view === 'projektplanung' ? 'ðŸ“ Projektplanung' : p.view === 'ressourcencockpit' ? 'ðŸ‘¥ Ressourcencockpit' : p.view === 'disposition' ? 'ðŸ“‹ Disposition' : p.view;
                    return (
                      <div key={p.sessionId} className="relative group">
                        <div className="w-7 h-7 rounded-full flex items-center justify-center text-white text-[10px] font-bold cursor-default border-2 border-white shadow-sm" style={{ backgroundColor: p.color }} title={`${p.userName} â€” ${viewLabel}`}>
                          <span style={{ fontSize: 16 }}>{p.animal || 'ðŸ¦«'}</span>
                        </div>
                        <span className="absolute -bottom-0.5 -right-0.5 w-2.5 h-2.5 bg-green-400 rounded-full border border-white" />
                      </div>
                    );
                  })}
                </div>
              )}
              {selectedFolderId && !selectedProjectId && (
                <React.Fragment>
                  <ChevronRight className="w-4 h-4 text-gray-400" />
                  <span className="text-yellow-500">ðŸ“</span>
                  <span className="text-lg font-semibold text-indigo-600">{(projectFolders || []).find(f => f.id === selectedFolderId)?.name}</span>
                  <span className="text-sm text-gray-400 ml-1">({filteredProjects.length} Projekte)</span>
                </React.Fragment>
              )}
              {selectedProjectId && (
                <React.Fragment>
                  <ChevronRight className="w-4 h-4 text-gray-400" />
                  <span className="text-lg font-semibold text-indigo-600">{(projects || []).find(p => p.id === selectedProjectId)?.name}</span>
                </React.Fragment>
              )}
              {!selectedProjectId && !selectedFolderId && !showResourceCockpit && <span className="text-sm text-gray-400 ml-2">({(projects || []).length} Projekte)</span>}
              {showResourceCockpit && <span className="text-sm text-gray-400 ml-2">({wlActivePreset && wlCustomPresets.find(p => p.id === wlActivePreset) ? `â˜… ${wlCustomPresets.find(p => p.id === wlActivePreset).name}` : `${users.length} MA Â· ${resources.length} Ressourcen`} Â· {(projects || []).length} Projekte)</span>}
            </div>
            <div className="nav-bar flex gap-2 items-center">
              <button onClick={() => { setShowDashboard(false); setShowProjectDashboard(false); setShowProjectPlanning(false); setShowResourceCockpit(false); setShowDisposition(false); }} className="px-3 py-1.5 rounded-2xl text-sm bg-gray-100 hover:bg-gray-200">
                <Calendar className="w-4 h-4 inline mr-2" />Schnellplanung
              </button>
              {(currentUser.teamRole === 'lead' || currentUser.teamRole === 'department_head' || currentUser.teamRole === 'entrepreneur' || currentUser.role === 'admin') && (
                <button onClick={() => { setShowDashboard(true); setShowProjectDashboard(false); setShowProjectPlanning(false); setShowResourceCockpit(false); setShowDisposition(false); }} className="px-3 py-1.5 rounded-2xl text-sm bg-gray-100 hover:bg-gray-200">
                  <BarChart3 className="w-4 h-4 inline mr-2" />Team Dashboard
                </button>
              )}
              <button onClick={() => { setShowDashboard(false); setShowProjectDashboard(true); setShowProjectPlanning(false); setShowResourceCockpit(false); setShowDisposition(false); }} className="px-3 py-1.5 rounded-2xl text-sm bg-gray-100 hover:bg-gray-200">
                <BarChart3 className="w-4 h-4 inline mr-2" />Projekt Dashboard
              </button>
              <button className={`px-4 py-2 rounded-2xl ${!showResourceCockpit ? 'bg-orange-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`} onClick={showResourceCockpit ? () => { setShowResourceCockpit(false); setShowProjectPlanning(true); } : undefined}>
                ðŸ—ï¸ Projektplanung
              </button>
              <button className={`px-4 py-2 rounded-2xl ${showResourceCockpit ? 'bg-teal-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`} onClick={!showResourceCockpit ? () => { setShowResourceCockpit(true); setShowProjectPlanning(false); } : undefined}>
                ðŸ‘¥ Ressourcencockpit
              </button>
              <button onClick={() => { setShowDashboard(false); setShowProjectDashboard(false); setShowProjectPlanning(false); setShowResourceCockpit(false); setShowDisposition(true); }} className="px-3 py-1.5 rounded-2xl text-sm bg-gray-100 hover:bg-gray-200">
                ðŸ“‹ Disposition
              </button>
              {currentUser.role === 'admin' && (<button onClick={() => setShowAdmin(true)} className="px-3 py-1.5 bg-purple-600 text-sm text-white rounded-2xl">Admin</button>)}
              <button onClick={() => setDarkMode(d => !d)} className={`p-3 rounded-2xl ${darkMode ? 'bg-indigo-600 text-yellow-200' : 'hover:bg-gray-100'}`} title={darkMode ? 'Light Mode' : 'Dark Mode'}>
                {darkMode ? 'â˜€ï¸' : 'ðŸŒ™'}
              </button>
              <button onClick={() => setShowSettings(true)} className="p-3 hover:bg-gray-100 rounded-2xl"><Settings className="w-5 h-5" /></button>
              <button onClick={() => { setCurrentUser(null); setSelectedUser(null); setShowLogin(true); setShowProjectPlanning(false); setShowResourceCockpit(false); setShowDisposition(false); }} className="px-3 py-1.5 bg-gray-100 rounded-2xl text-sm"><LogOut className="w-4 h-4 inline mr-2" />Abmelden</button>
            </div>
          </div>
          
          <div className="dm-surface bg-white border-b px-2 py-1 flex items-center gap-4 flex-shrink-0" style={{ display: showResourceCockpit ? 'none' : undefined }}>
            {/* Anzeige Dropdown - enthÃ¤lt alles */}
            <div className="relative">
              <button 
                onClick={() => setViewMenuOpen(!viewMenuOpen)}
                className="text-xs px-3 py-1.5 rounded bg-gray-100 text-gray-700 hover:bg-gray-200 flex items-center gap-1.5 font-medium"
              >
                <span>âš™ï¸ Anzeige</span>
                <ChevronDown className="w-3 h-3" />
              </button>
              {viewMenuOpen && (
                <div className="absolute left-0 top-full mt-1 dm-card bg-white rounded-lg shadow-xl border py-2 min-w-56 z-50" onClick={(e) => e.stopPropagation()}>
                  {/* Anzeige-Optionen */}
                  <div className="px-3 pb-1 text-xs font-semibold text-gray-400 uppercase">Anzeige</div>
                  <label className="flex items-center gap-2 px-3 py-1.5 hover:bg-gray-50 cursor-pointer text-sm">
                    <input type="checkbox" checked={showAssignments} onChange={(e) => setShowAssignments(e.target.checked)} className="rounded" />
                    <Users className="w-3.5 h-3.5 text-indigo-500" />
                    <span>Zuweisungen</span>
                  </label>
                  <label className="flex items-center gap-2 px-3 py-1.5 hover:bg-gray-50 cursor-pointer text-sm">
                    <input type="checkbox" checked={showHours} onChange={(e) => setShowHours(e.target.checked)} className="rounded" />
                    <span>â±ï¸</span>
                    <span>Stunden</span>
                  </label>
                  
                  {/* Spalten */}
                  <div className="border-t my-2" />
                  <div className="px-3 pb-1 text-xs font-semibold text-gray-400 uppercase">Spalten</div>
                  {[
                    { key: 'start', label: 'Start' },
                    { key: 'end', label: 'Ende' },
                    { key: 'hours', label: 'Plan h' },
                    { key: 'days', label: 'KT' }
                  ].map(col => (
                    <label key={col.key} className="flex items-center gap-2 px-3 py-1.5 hover:bg-gray-50 cursor-pointer text-sm">
                      <input type="checkbox" checked={ganttVisibleColumns[col.key]} onChange={(e) => setGanttVisibleColumns(prev => ({ ...prev, [col.key]: e.target.checked }))} className="rounded" />
                      <span>{col.label}</span>
                    </label>
                  ))}
                  
                  {/* Baselines - nur wenn Projekt ausgewÃ¤hlt */}
                  {selectedProjectId && (
                    <React.Fragment>
                      <div className="border-t my-2" />
                      <div className="px-3 pb-1 text-xs font-semibold text-gray-400 uppercase">Baselines</div>
                      <button 
                        onClick={() => { createBaseline(); }} 
                        className="w-full px-3 py-1.5 text-left text-sm hover:bg-violet-50 flex items-center gap-2"
                      >
                        <Plus className="w-3.5 h-3.5 text-violet-600" />
                        <span>Neue Baseline erstellen</span>
                      </button>
                      {currentProjectBaselines.map(baseline => (
                        <div key={baseline.id} className="px-3 py-1.5 hover:bg-gray-50 flex items-center justify-between">
                          <div className="flex items-center gap-2 flex-1 min-w-0">
                            <button 
                              onClick={() => loadBaseline(baseline.id)}
                              className={`text-xs ${activeBaseline?.id === baseline.id ? 'text-violet-600' : 'text-gray-400'}`}
                            >
                              {activeBaseline?.id === baseline.id ? 'ðŸ‘ï¸' : 'ðŸ‘ï¸â€ðŸ—¨ï¸'}
                            </button>
                            <span className="text-sm truncate">{baseline.name}</span>
                          </div>
                          <button onClick={() => deleteBaseline(baseline.id)} className="text-red-400 hover:text-red-600 text-xs ml-2">ðŸ—‘ï¸</button>
                        </div>
                      ))}
                      {currentProjectBaselines.length === 0 && (
                        <div className="px-3 py-1.5 text-xs text-gray-400 italic">Keine Baselines</div>
                      )}
                    </React.Fragment>
                  )}
                </div>
              )}
            </div>
            
            {/* Breite - separat */}
            <div className="flex items-center gap-2 ml-2">
              <span className="text-xs text-gray-500">Breite:</span>
              <button onClick={() => setZoomLevel(Math.max(25, zoomLevel - 25))} className="w-6 h-6 rounded bg-gray-100 hover:bg-gray-200 text-gray-600 text-sm">-</button>
              <span className="text-xs w-10 text-center">{zoomLevel}%</span>
              <button onClick={() => setZoomLevel(Math.min(250, zoomLevel + 25))} className="w-6 h-6 rounded bg-gray-100 hover:bg-gray-200 text-gray-600 text-sm">+</button>
            </div>
            
            {/* HÃ¶he */}
            <div className="flex items-center gap-2 ml-1">
              <span className="text-xs text-gray-500">HÃ¶he:</span>
              <button onClick={() => setGanttHeightZoom(Math.max(20, ganttHeightZoom - 20))} className="w-6 h-6 rounded bg-gray-100 hover:bg-gray-200 text-gray-600 text-sm">-</button>
              <span className="text-xs w-10 text-center">{ganttHeightZoom}%</span>
              <button onClick={() => setGanttHeightZoom(Math.min(200, ganttHeightZoom + 20))} className="w-6 h-6 rounded bg-gray-100 hover:bg-gray-200 text-gray-600 text-sm">+</button>
            </div>
            
            {/* Abstand halten */}
            <label className="flex items-center gap-1.5 ml-3 cursor-pointer text-xs">
              <input type="checkbox" checked={resizeMode === 'rigid'} onChange={(e) => setResizeMode(e.target.checked ? 'rigid' : 'magnetic')} className="rounded w-3 h-3" />
              <span className="text-gray-600">ðŸ”— Abstand</span>
            </label>
            
            <div className="w-px h-5 bg-gray-200 ml-2" />
            
            {/* Undo/Redo */}
            <div className="flex items-center gap-0.5 ml-2">
              <button onClick={performUndo} className={`w-6 h-6 rounded flex items-center justify-center text-sm ${undoStackRef.current.length > 0 ? 'bg-gray-100 hover:bg-gray-200 text-gray-600' : 'text-gray-300 cursor-not-allowed'}`} title="RÃ¼ckgÃ¤ngig (Ctrl+Z)">â†©</button>
              <button onClick={performRedo} className={`w-6 h-6 rounded flex items-center justify-center text-sm ${redoStackRef.current.length > 0 ? 'bg-gray-100 hover:bg-gray-200 text-gray-600' : 'text-gray-300 cursor-not-allowed'}`} title="Wiederholen (Ctrl+Y)">â†ª</button>
            </div>
            
            {/* Suche */}
            <div className="flex items-center gap-1 ml-2">
              {ganttSearchOpen ? (
                <div className="flex items-center gap-1 bg-white border border-indigo-300 rounded-md px-2 py-0.5 shadow-sm">
                  <span className="text-gray-400 text-xs">ðŸ”</span>
                  <input ref={ganttSearchRef} autoFocus value={ganttSearch} onChange={(e) => setGanttSearch(e.target.value)} placeholder="AP suchen..." className="text-xs w-32 outline-none bg-transparent" onKeyDown={(e) => { if (e.key === 'Escape') { setGanttSearchOpen(false); setGanttSearch(''); } }} />
                  {ganttSearch && <span className="text-[10px] text-indigo-500 font-medium">{searchMatchIds.size}</span>}
                  <button onClick={() => { setGanttSearchOpen(false); setGanttSearch(''); }} className="text-gray-400 hover:text-gray-600 text-xs">âœ•</button>
                </div>
              ) : (
                <button onClick={() => { setGanttSearchOpen(true); setTimeout(() => ganttSearchRef.current?.focus(), 50); }} className="w-6 h-6 rounded bg-gray-100 hover:bg-gray-200 text-gray-500 flex items-center justify-center text-xs" title="Suche (Ctrl+F)">ðŸ”</button>
              )}
            </div>
            
            {/* Kritischer Pfad */}
            <button onClick={() => setShowCriticalPath(!showCriticalPath)} className={`text-xs px-2 py-1 rounded ml-1 font-medium flex items-center gap-1 ${showCriticalPath ? 'bg-red-100 text-red-700 border border-red-300' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`} title="Kritischer Pfad hervorheben">
              ðŸ”´ Krit. Pfad
            </button>
            
            {/* Aktive Baseline Anzeige */}
            {activeBaseline && selectedProjectId && (
              <span className="text-xs text-violet-600 bg-violet-50 px-2 py-0.5 rounded ml-auto">
                ðŸ“Œ {activeBaseline.name}
              </span>
            )}
          </div>

          
          <div className="flex-1 flex overflow-hidden relative min-h-0">
            {/* Projekt-Sidebar mit Ordner-Struktur */}
            <div className={`${projectSidebarCollapsed ? 'w-10' : 'w-56'} bg-slate-800 text-white flex flex-col flex-shrink-0 transition-all duration-200 border-r-2 border-slate-600`} style={{ display: showResourceCockpit ? 'none' : undefined }}>
              <div className="p-2 border-b border-slate-700 flex items-center justify-between bg-slate-900">
                {!projectSidebarCollapsed && <span className="text-xs font-semibold text-slate-400 uppercase tracking-wide">Projekte</span>}
                <button 
                  onClick={() => setProjectSidebarCollapsed(!projectSidebarCollapsed)} 
                  className="p-1 hover:bg-slate-700 rounded text-slate-400 hover:text-white transition-colors"
                >
                  {projectSidebarCollapsed ? <ChevronRight className="w-4 h-4" /> : <ChevronLeft className="w-4 h-4" />}
                </button>
              </div>
              {!projectSidebarCollapsed && (
                <div className="flex-1 overflow-y-auto">
                  {/* Alle Projekte Button */}
                  <button 
                    onClick={() => { setSelectedProjectId(null); setSelectedFolderId(null); setActiveBaseline(null); }}
                    className={`w-full px-3 py-2 text-left text-sm flex items-center gap-2 ${selectedProjectId === null && selectedFolderId === null ? 'bg-indigo-600' : 'hover:bg-slate-700'}`}
                  >
                    <span className="w-3 h-3 rounded bg-gradient-to-br from-indigo-400 to-purple-500" />
                    <span className="truncate">Alle Projekte</span>
                    <span className="text-xs text-slate-400 ml-auto">{(projects || []).length}</span>
                  </button>
                  
                  {/* Ordner mit Projekten - sortiert nach order */}
                  {(projectFolders || []).sort((a, b) => (a.order || 0) - (b.order || 0)).map((folder, folderIdx) => {
                    const folderProjects = (projects || []).filter(p => p.folderId === folder.id && !p.archived);
                    const isCollapsed = collapsedFolders[folder.id];
                    const isDragOver = dragOverFolder === folder.id;
                    const isFolderSelected = selectedFolderId === folder.id && selectedProjectId === null;
                    const isFolderDragOver = draggingFolder && draggingFolder !== folder.id && dragOverFolder === folder.id;
                    
                    return (
                      <div key={folder.id}>
                        {/* Ordner-Header */}
                        <div 
                          draggable
                          onDragStart={(e) => { e.stopPropagation(); setDraggingFolder(folder.id); }}
                          onDragEnd={() => { setDraggingFolder(null); setDragOverFolder(null); }}
                          className={`w-full px-2 py-1.5 text-left text-sm flex items-center gap-1 cursor-pointer ${isFolderSelected ? 'bg-indigo-600' : isFolderDragOver ? 'bg-slate-600 border-t-2 border-indigo-400' : isDragOver && draggingProject ? 'bg-indigo-500' : 'hover:bg-slate-700'} ${draggingFolder === folder.id ? 'opacity-50' : ''}`}
                          onClick={() => { setSelectedFolderId(folder.id); setSelectedProjectId(null); setActiveBaseline(null); setCollapsedFolders(prev => ({ ...prev, [folder.id]: false })); }}
                          onDragOver={(e) => { e.preventDefault(); setDragOverFolder(folder.id); }}
                          onDragLeave={() => setDragOverFolder(null)}
                          onDrop={(e) => {
                            e.preventDefault();
                            setDragOverFolder(null);
                            // Ordner sortieren
                            if (draggingFolder && draggingFolder !== folder.id) {
                              const sorted = (projectFolders || []).sort((a, b) => (a.order || 0) - (b.order || 0));
                              const targetIdx = sorted.findIndex(f => f.id === folder.id);
                              const withoutDragged = sorted.filter(f => f.id !== draggingFolder);
                              const draggedF = sorted.find(f => f.id === draggingFolder);
                              if (draggedF) {
                                withoutDragged.splice(targetIdx, 0, draggedF);
                                const updated = withoutDragged.map((f, i) => ({ ...f, order: i }));
                                saveProjectFolders(updated);
                              }
                              setDraggingFolder(null);
                            }
                            // Projekt in Ordner verschieben
                            if (draggingProject) {
                              const updated = (projects || []).map(p => p.id === draggingProject ? { ...p, folderId: folder.id } : p);
                              saveProjects(updated);
                              setDraggingProject(null);
                            }
                          }}
                        >
                          <button className="p-0.5 hover:bg-slate-600 rounded" onClick={(e) => { e.stopPropagation(); setCollapsedFolders(prev => ({ ...prev, [folder.id]: !prev[folder.id] })); }}>
                            {isCollapsed ? <ChevronRight className="w-3 h-3" /> : <ChevronDown className="w-3 h-3" />}
                          </button>
                          <span className="text-yellow-400">ðŸ“</span>
                          {editingFolderId === folder.id ? (
                            <input
                              autoFocus
                              type="text"
                              defaultValue={folder.name}
                              className="flex-1 bg-slate-700 text-white text-sm px-1 rounded border-0 outline-none"
                              onClick={(e) => e.stopPropagation()}
                              onBlur={(e) => {
                                const updated = (projectFolders || []).map(f => f.id === folder.id ? { ...f, name: e.target.value } : f);
                                saveProjectFolders(updated);
                                setEditingFolderId(null);
                              }}
                              onKeyDown={(e) => { if (e.key === 'Enter') e.target.blur(); if (e.key === 'Escape') setEditingFolderId(null); }}
                            />
                          ) : (
                            <span 
                              className="truncate flex-1" 
                              onDoubleClick={(e) => { e.stopPropagation(); setEditingFolderId(folder.id); }}
                            >
                              {folder.name}
                            </span>
                          )}
                          <span className="text-xs text-slate-400">{folderProjects.length}</span>
                          <button 
                            className="p-0.5 hover:bg-red-600 rounded opacity-50 hover:opacity-100"
                            onClick={(e) => { 
                              e.stopPropagation(); 
                              if (confirm('Ordner lÃ¶schen? Projekte werden nicht gelÃ¶scht.')) {
                                // Projekte aus Ordner entfernen
                                const updatedProjects = (projects || []).map(p => p.folderId === folder.id ? { ...p, folderId: null } : p);
                                saveProjects(updatedProjects);
                                // Ordner lÃ¶schen
                                const updatedFolders = (projectFolders || []).filter(f => f.id !== folder.id);
                                saveProjectFolders(updatedFolders);
                                // Falls dieser Ordner ausgewÃ¤hlt war, zurÃ¼cksetzen
                                if (selectedFolderId === folder.id) setSelectedFolderId(null);
                              }
                            }}
                            title="Ordner lÃ¶schen"
                          >
                            <Trash2 className="w-3 h-3" />
                          </button>
                        </div>
                        
                        {/* Projekte im Ordner - sortiert nach order */}
                        {!isCollapsed && folderProjects.sort((a, b) => (a.order || 0) - (b.order || 0)).map((project, idx) => {
                          const projectBaselines = (baselines || []).filter(b => b.projectId === project.id);
                          const isDragOver = dragOverProject === project.id;
                          return (
                            <div
                              key={project.id}
                              draggable
                              onDragStart={(e) => { e.stopPropagation(); setDraggingProject(project.id); }}
                              onDragEnd={() => { setDraggingProject(null); setDragOverFolder(null); setDragOverProject(null); }}
                              onDragOver={(e) => { e.preventDefault(); e.stopPropagation(); if (draggingProject && draggingProject !== project.id) setDragOverProject(project.id); }}
                              onDragLeave={() => setDragOverProject(null)}
                              onDrop={(e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                if (draggingProject && draggingProject !== project.id) {
                                  // Projekt in diesen Ordner verschieben und vor diesem Projekt einsortieren
                                  const draggedProj = (projects || []).find(p => p.id === draggingProject);
                                  if (draggedProj) {
                                    let updated = (projects || []).map(p => p.id === draggingProject ? { ...p, folderId: folder.id } : p);
                                    // Neu sortieren innerhalb des Ordners
                                    const inFolder = updated.filter(p => p.folderId === folder.id).sort((a, b) => (a.order || 0) - (b.order || 0));
                                    const targetIdx = inFolder.findIndex(p => p.id === project.id);
                                    const withoutDragged = inFolder.filter(p => p.id !== draggingProject);
                                    withoutDragged.splice(targetIdx, 0, { ...draggedProj, folderId: folder.id });
                                    withoutDragged.forEach((p, i) => { updated = updated.map(pr => pr.id === p.id ? { ...pr, order: i } : pr); });
                                    saveProjects(updated);
                                  }
                                }
                                setDraggingProject(null);
                                setDragOverProject(null);
                              }}
                              onClick={() => { setSelectedProjectId(project.id); setSelectedFolderId(null); setActiveBaseline(null); }}
                              onContextMenu={(e) => { e.preventDefault(); e.stopPropagation(); setContextMenu({ x: e.clientX, y: e.clientY, type: 'sidebar-project', project }); }}
                              className={`w-full pl-8 pr-3 py-1.5 text-left text-sm flex items-center gap-2 cursor-pointer ${selectedProjectId === project.id ? 'bg-indigo-600' : isDragOver ? 'bg-indigo-500 border-t-2 border-indigo-300' : 'hover:bg-slate-700'} ${draggingProject === project.id ? 'opacity-50' : ''}`}
                            >
                              <span className="w-2.5 h-2.5 rounded flex-shrink-0" style={{ backgroundColor: project.color }} />
                              {editingProjectId === project.id ? (
                                <input autoFocus type="text" defaultValue={project.name} className="flex-1 min-w-0 px-1 py-0 rounded text-xs text-gray-800 bg-white" onClick={(e) => e.stopPropagation()} onBlur={(e) => { saveProjects((projects || []).map(p => p.id === project.id ? { ...p, name: e.target.value } : p)); setEditingProjectId(null); }} onKeyDown={(e) => { if (e.key === 'Enter') e.target.blur(); if (e.key === 'Escape') setEditingProjectId(null); }} />
                              ) : (
                                <span className="truncate flex-1" onDoubleClick={(e) => { e.stopPropagation(); setEditingProjectId(project.id); }}>{project.name}</span>
                              )}
                              <span className="text-xs text-slate-400">{(workPackages || []).filter(wp => wp.projectId === project.id).length}</span>
                              {projectBaselines.length > 0 && <span className="text-xs">ðŸ“Œ</span>}
                            </div>
                          );
                        })}
                      </div>
                    );
                  })}
                  
                  {/* Ungrupierte Projekte (ohne Ordner) */}
                  {(() => {
                    const ungroupedProjects = (projects || []).filter(p => !p.folderId && !p.archived);
                    if (ungroupedProjects.length === 0 && (projectFolders || []).length > 0) return null;
                    
                    return (
                      <div 
                        className={`${(projectFolders || []).length > 0 ? 'border-t border-slate-700 mt-1 pt-1' : ''}`}
                        onDragOver={(e) => { e.preventDefault(); setDragOverFolder('ungrouped'); }}
                        onDragLeave={() => setDragOverFolder(null)}
                        onDrop={(e) => {
                          e.preventDefault();
                          setDragOverFolder(null);
                          if (draggingProject) {
                            const updated = (projects || []).map(p => p.id === draggingProject ? { ...p, folderId: null } : p);
                            saveProjects(updated);
                            setDraggingProject(null);
                          }
                        }}
                      >
                        {(projectFolders || []).length > 0 && (
                          <div className={`px-3 py-1 text-xs text-slate-500 ${dragOverFolder === 'ungrouped' ? 'bg-indigo-500 text-white' : ''}`}>
                            Ungrupiert
                          </div>
                        )}
                        {ungroupedProjects.sort((a, b) => (a.order || 0) - (b.order || 0)).map((project, idx) => {
                          const projectBaselines = (baselines || []).filter(b => b.projectId === project.id);
                          const isDragOver = dragOverProject === project.id;
                          return (
                            <div
                              key={project.id}
                              draggable
                              onDragStart={(e) => { e.stopPropagation(); setDraggingProject(project.id); }}
                              onDragEnd={() => { setDraggingProject(null); setDragOverFolder(null); setDragOverProject(null); }}
                              onDragOver={(e) => { e.preventDefault(); e.stopPropagation(); if (draggingProject && draggingProject !== project.id) setDragOverProject(project.id); }}
                              onDragLeave={() => setDragOverProject(null)}
                              onDrop={(e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                if (draggingProject && draggingProject !== project.id) {
                                  // Projekt hierhin verschieben (ungrupiert) und vor diesem Projekt einsortieren
                                  const draggedProj = (projects || []).find(p => p.id === draggingProject);
                                  if (draggedProj) {
                                    let updated = (projects || []).map(p => p.id === draggingProject ? { ...p, folderId: null } : p);
                                    // Neu sortieren innerhalb ungrupiert
                                    const inUngrouped = updated.filter(p => !p.folderId).sort((a, b) => (a.order || 0) - (b.order || 0));
                                    const targetIdx = inUngrouped.findIndex(p => p.id === project.id);
                                    const withoutDragged = inUngrouped.filter(p => p.id !== draggingProject);
                                    withoutDragged.splice(targetIdx, 0, { ...draggedProj, folderId: null });
                                    withoutDragged.forEach((p, i) => { updated = updated.map(pr => pr.id === p.id ? { ...pr, order: i } : pr); });
                                    saveProjects(updated);
                                  }
                                }
                                setDraggingProject(null);
                                setDragOverProject(null);
                              }}
                              onClick={() => { setSelectedProjectId(project.id); setSelectedFolderId(null); setActiveBaseline(null); }}
                              onContextMenu={(e) => { e.preventDefault(); e.stopPropagation(); setContextMenu({ x: e.clientX, y: e.clientY, type: 'sidebar-project', project }); }}
                              className={`w-full px-3 py-1.5 text-left text-sm flex items-center gap-2 cursor-pointer ${selectedProjectId === project.id ? 'bg-indigo-600' : isDragOver ? 'bg-indigo-500 border-t-2 border-indigo-300' : 'hover:bg-slate-700'} ${draggingProject === project.id ? 'opacity-50' : ''}`}
                            >
                              <span className="w-3 h-3 rounded flex-shrink-0" style={{ backgroundColor: project.color }} />
                              {editingProjectId === project.id ? (
                                <input autoFocus type="text" defaultValue={project.name} className="flex-1 min-w-0 px-1 py-0 rounded text-xs text-gray-800 bg-white" onClick={(e) => e.stopPropagation()} onBlur={(e) => { saveProjects((projects || []).map(p => p.id === project.id ? { ...p, name: e.target.value } : p)); setEditingProjectId(null); }} onKeyDown={(e) => { if (e.key === 'Enter') e.target.blur(); if (e.key === 'Escape') setEditingProjectId(null); }} />
                              ) : (
                                <span className="truncate flex-1" onDoubleClick={(e) => { e.stopPropagation(); setEditingProjectId(project.id); }}>{project.name}</span>
                              )}
                              <span className="text-xs text-slate-400">{(workPackages || []).filter(wp => wp.projectId === project.id).length}</span>
                              {projectBaselines.length > 0 && <span className="text-xs">ðŸ“Œ</span>}
                            </div>
                          );
                        })}
                      </div>
                    );
                  })()}
                </div>
              )}
              {/* Archiv */}
              {!projectSidebarCollapsed && (() => {
                const archivedProjects = (projects || []).filter(p => p.archived);
                if (archivedProjects.length === 0) return null;
                return (
                  <div className="border-t border-slate-700">
                    <div 
                      className="px-3 py-1.5 flex items-center gap-2 cursor-pointer hover:bg-slate-700 text-slate-400 text-xs"
                      onClick={() => setShowArchive(!showArchive)}
                    >
                      <span>{showArchive ? 'â–¼' : 'â–¶'}</span>
                      <span>ðŸ“¦ Archiv</span>
                      <span className="ml-auto text-slate-500">{archivedProjects.length}</span>
                    </div>
                    {showArchive && archivedProjects.map(project => (
                      <div 
                        key={project.id}
                        className="w-full px-3 pl-6 py-1 text-left text-xs flex items-center gap-2 text-slate-500 hover:bg-slate-700 group"
                        onContextMenu={(e) => { e.preventDefault(); e.stopPropagation(); setContextMenu({ x: e.clientX, y: e.clientY, type: 'archived-project', project }); }}
                      >
                        <span className="w-2 h-2 rounded flex-shrink-0 opacity-50" style={{ backgroundColor: project.color }} />
                        <span className="truncate flex-1">{project.name}</span>
                        <button 
                          onClick={(e) => { e.stopPropagation(); saveProjects((projects || []).map(p => p.id === project.id ? { ...p, archived: false } : p)); }}
                          className="text-[10px] px-1.5 py-0.5 rounded bg-slate-700 hover:bg-indigo-600 text-slate-300 opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0"
                          title="Wiederherstellen"
                        >â†©</button>
                      </div>
                    ))}
                  </div>
                );
              })()}
              {!projectSidebarCollapsed && (
                <div className="p-2 border-t border-slate-700 space-y-1">
                  {/* Neuer Ordner Button */}
                  <button 
                    onClick={() => { 
                      const newFolder = { 
                        id: `folder_${Date.now()}`, 
                        name: `Neuer Ordner`, 
                        order: (projectFolders || []).length 
                      };
                      const newFolders = [...(projectFolders || []), newFolder];
                      saveProjectFolders(newFolders);
                      setEditingFolderId(newFolder.id);
                    }}
                    className="w-full px-3 py-1.5 text-left text-sm flex items-center gap-2 hover:bg-slate-700 rounded text-slate-300"
                  >
                    <span className="text-yellow-400">ðŸ“</span>
                    <Plus className="w-3 h-3" />
                    <span>Neuer Ordner</span>
                  </button>
                  {/* Neues Projekt Button */}
                  <button 
                    onClick={() => { 
                      const colors = ['#6366f1', '#8b5cf6', '#ec4899', '#f43f5e', '#f97316', '#eab308', '#22c55e', '#14b8a6', '#0ea5e9'];
                      const newColor = colors[(projects || []).length % colors.length];
                      const newProject = { id: `proj_${Date.now()}`, name: `Neues Projekt ${(projects || []).length + 1}`, color: newColor, folderId: null };
                      const newProjects = [...(projects || []), newProject];
                      setProjects(newProjects);
                      saveProjects(newProjects);
                      setSelectedProjectId(newProject.id);
                    }}
                    className="w-full px-3 py-1.5 text-left text-sm flex items-center gap-2 hover:bg-slate-700 rounded text-slate-300"
                  >
                    <Plus className="w-4 h-4" />
                    <span>Neues Projekt</span>
                  </button>
                </div>
              )}
            </div>
            
            {/* Hauptinhalt */}
            <div className="flex-1 flex flex-col overflow-hidden relative min-h-0">
            {/* Detail-Sidebar - fÃ¼r Einzel- und Multi-Select - schwebt Ã¼ber Gantt */}
            {(sidebarWP || selectedWPs.length > 0) && (
              <div 
                className={`${isFloating ? 'fixed rounded-lg overflow-hidden bg-white' : 'absolute top-0 bg-white/80 backdrop-blur-sm'} border-r shadow-2xl flex flex-col transition-all duration-200 ${detailsCollapsed && !isFloating ? 'w-8' : isFloating ? '' : ''}`}
                style={isFloating 
                  ? { left: floatPos.x, top: floatPos.y, width: floatSize.w, height: floatSize.h, border: `1px solid ${darkMode ? '#3a3a4e' : '#d1d5db'}`, boxShadow: darkMode ? '0 20px 60px rgba(0,0,0,0.6)' : '0 20px 60px rgba(0,0,0,0.3)', zIndex: 9999 }
                  : { left: Math.max(leftPanelWidth, 40), zIndex: 40, bottom: 16, ...(detailsCollapsed ? {} : { width: viewMode === 'wide' ? 520 : 288 }) }
                }
                onClick={(e) => e.stopPropagation()}
              >
                {/* Floating drag handle */}
                {isFloating && (
                  <div 
                    className="h-2.5 cursor-move bg-gray-200 hover:bg-gray-300 flex-shrink-0 flex items-center justify-center"
                    onMouseDown={(e) => {
                      e.preventDefault();
                      const startX = e.clientX - floatPos.x;
                      const startY = e.clientY - floatPos.y;
                      const onMove = (ev) => setFloatPos({ x: Math.max(0, ev.clientX - startX), y: Math.max(0, ev.clientY - startY) });
                      const onUp = () => { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); };
                      document.addEventListener('mousemove', onMove);
                      document.addEventListener('mouseup', onUp);
                    }}
                  >
                    <div className="w-8 h-1 rounded-full bg-gray-400" />
                  </div>
                )}
                {/* Resize handles for floating mode */}
                {isFloating && <React.Fragment>
                  {/* Right edge */}
                  <div className="absolute right-0 top-0 bottom-0 w-1.5 cursor-ew-resize hover:bg-indigo-400/30 z-50" onMouseDown={(e) => {
                    e.preventDefault(); e.stopPropagation();
                    const startX = e.clientX; const startW = floatSize.w;
                    const onMove = (ev) => setFloatSize(prev => ({ ...prev, w: Math.max(280, startW + ev.clientX - startX) }));
                    const onUp = () => { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); };
                    document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onUp);
                  }} />
                  {/* Bottom edge */}
                  <div className="absolute bottom-0 left-0 right-0 h-1.5 cursor-ns-resize hover:bg-indigo-400/30 z-50" onMouseDown={(e) => {
                    e.preventDefault(); e.stopPropagation();
                    const startY = e.clientY; const startH = floatSize.h;
                    const onMove = (ev) => setFloatSize(prev => ({ ...prev, h: Math.max(200, startH + ev.clientY - startY) }));
                    const onUp = () => { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); };
                    document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onUp);
                  }} />
                  {/* Bottom-right corner */}
                  <div className="absolute bottom-0 right-0 w-3 h-3 cursor-nwse-resize z-50" onMouseDown={(e) => {
                    e.preventDefault(); e.stopPropagation();
                    const startX = e.clientX; const startY = e.clientY; const startW = floatSize.w; const startH = floatSize.h;
                    const onMove = (ev) => setFloatSize({ w: Math.max(280, startW + ev.clientX - startX), h: Math.max(200, startH + ev.clientY - startY) });
                    const onUp = () => { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); };
                    document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onUp);
                  }}>
                    <svg width="10" height="10" viewBox="0 0 10 10" className="absolute bottom-0.5 right-0.5 text-gray-400"><path d="M9 1L1 9M9 5L5 9" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round"/></svg>
                  </div>
                  {/* Left edge */}
                  <div className="absolute left-0 top-0 bottom-0 w-1.5 cursor-ew-resize hover:bg-indigo-400/30 z-50" onMouseDown={(e) => {
                    e.preventDefault(); e.stopPropagation();
                    const startX = e.clientX; const startW = floatSize.w; const startLeft = floatPos.x;
                    const onMove = (ev) => { const dx = ev.clientX - startX; const newW = Math.max(280, startW - dx); setFloatSize(prev => ({ ...prev, w: newW })); setFloatPos(prev => ({ ...prev, x: startLeft + startW - newW })); };
                    const onUp = () => { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); };
                    document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onUp);
                  }} />
                  {/* Top edge */}
                  <div className="absolute top-0 left-0 right-0 h-1.5 cursor-ns-resize hover:bg-indigo-400/30 z-50" onMouseDown={(e) => {
                    e.preventDefault(); e.stopPropagation();
                    const startY = e.clientY; const startH = floatSize.h; const startTop = floatPos.y;
                    const onMove = (ev) => { const dy = ev.clientY - startY; const newH = Math.max(200, startH - dy); setFloatSize(prev => ({ ...prev, h: newH })); setFloatPos(prev => ({ ...prev, y: startTop + startH - newH })); };
                    const onUp = () => { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); };
                    document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onUp);
                  }} />
                </React.Fragment>}
                {detailsCollapsed && !isFloating ? (
                  /* Eingeklappter Zustand - nur schmaler Streifen */
                  <div className="flex-1 flex flex-col items-center py-2" style={{ backgroundColor: sidebarWP?.color ? `${sidebarWP.color}e6` : 'rgba(99,102,241,0.9)' }}>
                    <button 
                      onClick={() => setDetailsCollapsed(false)}
                      className="p-1.5 text-white hover:bg-white/20 rounded"
                      title="Details einblenden"
                    >
                      <ChevronRight className="w-4 h-4" />
                    </button>
                    <div className="flex-1 flex items-center justify-center">
                      <span className="text-white text-xs font-bold writing-mode-vertical" style={{ writingMode: 'vertical-rl', textOrientation: 'mixed' }}>
                        {selectedWPs.length > 0 ? `${selectedWPs.length} ausgewÃ¤hlt` : 'Details'}
                      </span>
                    </div>
                  </div>
                ) : (
                  /* Ausgeklappter Zustand */
                  <React.Fragment>
                    {/* Header */}
                    <div className={`p-2 border-b flex items-center justify-between ${selectedWPs.length > 0 ? 'bg-indigo-600 text-white' : 'text-white'}`} style={selectedWPs.length === 0 ? { backgroundColor: sidebarWP?.color || '#6366f1' } : undefined}>
                      <div className="flex items-center gap-2 min-w-0 flex-1">
                        {selectedWPs.length > 0 ? (
                          <React.Fragment>
                            <span className="bg-white text-indigo-600 text-xs font-bold px-1.5 py-0.5 rounded-full">{selectedWPs.length}</span>
                            <span className="text-sm font-medium">ausgewÃ¤hlt</span>
                          </React.Fragment>
                        ) : (
                          <h3 className="font-bold text-sm truncate">{sidebarWP?.name}</h3>
                        )}
                      </div>
                      <div className="flex items-center gap-0.5 flex-shrink-0">
                        {/* EinrÃ¼cken/AusrÃ¼cken Buttons */}
                        {selectedWPs.length > 0 && (
                          <React.Fragment>
                            <button onClick={(e) => { e.stopPropagation(); bulkOutdent(); }} className="p-1 hover:bg-white/20 rounded" title="AusrÃ¼cken"><ChevronLeft className="w-4 h-4" /></button>
                            <button onClick={(e) => { e.stopPropagation(); bulkIndent(); }} className="p-1 hover:bg-white/20 rounded" title="EinrÃ¼cken"><ChevronRight className="w-4 h-4" /></button>
                          </React.Fragment>
                        )}
                        {sidebarWP && selectedWPs.length === 0 && (
                          <React.Fragment>
                            <button onClick={(e) => { e.stopPropagation(); outdentWorkPackage(sidebarWP.id); }} className="p-1 hover:bg-white/20 rounded text-white" title="AusrÃ¼cken"><svg className="w-4 h-4" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.5"><line x1="5" y1="3" x2="14" y2="3"/><line x1="5" y1="7" x2="14" y2="7"/><line x1="2" y1="11" x2="14" y2="11"/><line x1="2" y1="15" x2="14" y2="15"/><polyline points="4,5 1,7 4,9" strokeWidth="1.5" fill="none"/></svg></button>
                            <button onClick={(e) => { e.stopPropagation(); indentWorkPackage(sidebarWP.id); }} className="p-1 hover:bg-white/20 rounded text-white" title="EinrÃ¼cken"><svg className="w-4 h-4" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.5"><line x1="5" y1="3" x2="14" y2="3"/><line x1="5" y1="7" x2="14" y2="7"/><line x1="2" y1="11" x2="14" y2="11"/><line x1="2" y1="15" x2="14" y2="15"/><polyline points="1,5 4,7 1,9" strokeWidth="1.5" fill="none"/></svg></button>
                          </React.Fragment>
                        )}
                        <div className="w-px h-4 mx-0.5 bg-white/30" />
                        {/* View toggle */}
                        <button onClick={() => { const newMode = viewMode === 'compact' ? 'wide' : 'compact'; setViewMode(newMode); if (isFloating) setFloatSize(prev => ({ w: newMode === 'wide' ? Math.max(prev.w, 520) : Math.min(prev.w, 380), h: newMode === 'wide' ? Math.max(prev.h, 550) : prev.h })); }} className={`p-1 rounded hover:bg-white/20`} title={viewMode === 'compact' ? 'Breite Ansicht (2-spaltig)' : 'Kompakte Ansicht (1-spaltig)'}>
                          {viewMode === 'compact' 
                            ? <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="18" rx="1"/><rect x="14" y="3" width="7" height="18" rx="1"/></svg>
                            : <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="1"/></svg>
                          }
                        </button>
                        <div className="w-px h-4 mx-0.5 bg-white/30" />
                        {isFloating ? (
                          <button onClick={() => { setIsFloating(false); setDetailsCollapsed(false); }} className="p-1 rounded hover:bg-white/20" title="Andocken">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="6" width="16" height="14" rx="2" /><path d="M22 2v4h-4" /><path d="M18 6l4-4" /></svg>
                          </button>
                        ) : (
                          <React.Fragment>
                            <button onClick={() => { setIsFloating(true); setFloatPos({ x: Math.max(200, Math.max(leftPanelWidth, 40) + 10), y: 80 }); setFloatSize({ w: viewMode === 'wide' ? 580 : 340, h: viewMode === 'wide' ? 600 : 500 }); }} className="p-1 rounded hover:bg-white/20" title="Abdocken / Schwebendes Fenster">
                              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="2" width="16" height="16" rx="2" /><path d="M6 18h12a2 2 0 0 0 2-2V8" /><path d="M18 22v-4h4" /><path d="M22 18l-4 4" /></svg>
                            </button>
                            <button onClick={() => setDetailsCollapsed(true)} className="p-1 rounded hover:bg-white/20" title="Einklappen"><ChevronLeft className="w-4 h-4" /></button>
                          </React.Fragment>
                        )}
                        <button onClick={(e) => { e.stopPropagation(); setSelectedWPs([]); setSidebarWPId(null); setIsFloating(false); }} className="p-1 rounded hover:bg-white/20" title="SchlieÃŸen"><X className="w-4 h-4" /></button>
                      </div>
                    </div>
                    
                    {/* Farben - kompakt */}
                    <div className="px-2 py-1.5 border-b bg-gray-50/80 flex items-center gap-1">
                      {wpColors.map(color => (
                        <button 
                          key={color}
                          onClick={() => selectedWPs.length > 0 ? bulkSetColor(color) : updateWorkPackage(sidebarWP.id, 'color', color)}
                          className="w-4 h-4 rounded border border-transparent hover:border-gray-400 hover:scale-125 transition-all"
                          style={{ backgroundColor: color }}
                        />
                      ))}
                      <button 
                        onClick={() => selectedWPs.length > 0 ? bulkSetColor(null) : updateWorkPackage(sidebarWP.id, 'color', null)}
                        className="w-4 h-4 rounded border border-gray-300 hover:border-gray-400 flex items-center justify-center text-gray-400"
                        style={{ fontSize: 8 }}
                      >
                        âœ•
                      </button>
                    </div>
                    
                    {/* Multi-Select: Nur LÃ¶schen-Button */}
                    {selectedWPs.length > 0 && (
                      <div className="p-2">
                        <button 
                          onClick={bulkDelete}
                          className="w-full flex items-center justify-center gap-2 px-2 py-1.5 bg-red-50 hover:bg-red-100 text-red-600 rounded text-xs font-medium transition-colors"
                        >
                          <Trash2 className="w-3 h-3" />
                          LÃ¶schen
                        </button>
                      </div>
                    )}
                {/* Einzel-Auswahl: Alle Details */}
                {sidebarWP && selectedWPs.length === 0 && (
                <div className={`flex-1 overflow-y-auto p-2 ${viewMode === 'wide' ? 'flex flex-col gap-2' : 'space-y-2'}`}>
                  {/* Stunden-Tabelle: Plan | Zugewiesen | Offen | Fortschritt */}
                  {(() => {
                    const hasKids = getChildren(sidebarWP.id, workPackages).length > 0;
                    const planned = hasKids ? (calculateTotalHours(sidebarWP.id) || 0) : (sidebarWP.plannedHours || 0);
                    const maHours = (sidebarWP.responsibles || []).reduce((s, r) => s + (typeof r === 'object' ? (r.hours || 0) : 0), 0)
                      + (sidebarWP.editors || []).reduce((s, e) => s + (typeof e === 'object' ? (e.hours || 0) : 0), 0);
                    const resIds = sidebarWP.resourceIds || [];
                    const resH = sidebarWP.resourceHours || {};
                    let mrHours = 0, fzUnits = 0, wzHours = 0;
                    let mrNeedsOp = false;
                    resIds.forEach(rid => {
                      const res = resources.find(r => r.id === rid);
                      const h = resH[rid] || 0;
                      if (res?.type === 'maschine') { mrHours += h; if (res.needsOperator !== false) mrNeedsOp = true; }
                      else if (res?.type === 'fahrzeug') fzUnits += h;
                      else if (res?.type === 'werkzeug') wzHours += h;
                    });
                    const hasWZ = resIds.some(rid => resources.find(r => r.id === rid)?.type === 'werkzeug');
                    const maOpen = Math.max(0, planned - maHours);
                    const maOver = maHours > planned && planned > 0;
                    const actual = sidebarWP.actualHours || 0;
                    const progressPct = planned > 0 ? Math.min(100, Math.round((actual / planned) * 100)) : 0;
                    
                    const cellCls = 'px-1.5 py-1 text-right tabular-nums text-[11px]';
                    const labelCls = 'px-1.5 py-1 text-left text-[11px]';
                    const headCls = 'px-1.5 py-1 text-[10px] font-semibold text-gray-500 text-right';
                    const headLCls = 'px-1.5 py-1 text-[10px] font-semibold text-gray-500 text-left';
                    
                    return (
                      <div className="flex-shrink-0 rounded-lg border overflow-hidden" style={{ borderColor: darkMode ? '#3a3a4e' : '#e5e7eb' }}>
                        <table className="w-full border-collapse" style={{ fontSize: 11 }}>
                          <thead>
                            <tr style={{ backgroundColor: darkMode ? '#252540' : '#f9fafb' }}>
                              <th className={headLCls}></th>
                              <th className={headCls}>Plan</th>
                              <th className={headCls}>Zugewiesen</th>
                              <th className={headCls}>Offen</th>
                              <th className={headCls}>Fortschritt</th>
                            </tr>
                          </thead>
                          <tbody>
                            {/* MA row */}
                            <tr style={{ borderTop: `1px solid ${darkMode ? '#3a3a4e' : '#f0f0f0'}` }}>
                              <td className={labelCls}><span className="flex items-center gap-1"><span>ðŸ‘¤</span><span className={`font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>MA</span></span></td>
                              <td className={cellCls}>
                                {hasKids ? (
                                  <span className={darkMode ? 'text-gray-400 italic' : 'text-gray-500 italic'}>{planned}h</span>
                                ) : (
                                  <input type="number" min="0" step="0.5" key={`plan-${sidebarWP.id}-${sidebarWP.plannedHours}`}
                                    defaultValue={sidebarWP.plannedHours || 0} onClick={(e) => e.stopPropagation()}
                                    onBlur={(e) => updateWorkPackage(sidebarWP.id, 'plannedHours', parseFloat(e.target.value) || 0)}
                                    onKeyDown={(e) => { if (e.key === 'Enter') e.target.blur(); }}
                                    className={`w-14 px-1 py-0.5 border rounded text-[11px] text-right ${darkMode ? 'bg-[#2a2a3e] border-[#3a3a4e] text-gray-200' : ''}`} />
                                )}
                              </td>
                              <td className={cellCls}>
                                <span className={`font-medium ${darkMode ? 'text-gray-200' : 'text-gray-800'}`}>{maHours}h</span>
                              </td>
                              <td className={cellCls}>
                                {planned > 0 ? (
                                  <span className={`px-1 py-0.5 rounded text-[10px] font-medium ${maOver ? 'bg-red-500/15 text-red-500' : maOpen === 0 ? 'bg-emerald-500/15 text-emerald-500' : 'bg-orange-500/15 text-orange-500'}`}>
                                    {maOver ? `-${maHours - planned}h` : maOpen === 0 ? 'âœ“' : `${maOpen}h`}
                                  </span>
                                ) : <span className="text-gray-400">â€“</span>}
                              </td>
                              <td className={cellCls}>
                                <div className="flex items-center gap-1 justify-end">
                                  <input type="number" min="0" step="0.5" key={`actual-${sidebarWP.id}-${sidebarWP.actualHours}`}
                                    defaultValue={actual || ''} placeholder="0" onClick={(e) => e.stopPropagation()}
                                    onBlur={(e) => updateWorkPackage(sidebarWP.id, 'actualHours', parseFloat(e.target.value) || 0)}
                                    onKeyDown={(e) => { if (e.key === 'Enter') e.target.blur(); }}
                                    className={`w-12 px-1 py-0.5 border rounded text-[10px] text-right ${darkMode ? 'bg-[#2a2a3e] border-[#3a3a4e] text-gray-200' : ''}`} />
                                  {planned > 0 && actual > 0 && <span className={`text-[9px] ${progressPct >= 100 ? 'text-emerald-500' : 'text-gray-400'}`}>{progressPct}%</span>}
                                </div>
                              </td>
                            </tr>
                            {/* MR row */}
                            <tr style={{ borderTop: `1px solid ${darkMode ? '#3a3a4e' : '#f0f0f0'}` }}>
                              <td className={labelCls}>
                                <span className="flex items-center gap-1">
                                  <span>ðŸ­</span>
                                  <span className={`font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>MR</span>
                                  {mrNeedsOp && <span className="text-[8px] text-orange-500" title="Bediener erforderlich">ðŸ‘¤</span>}
                                </span>
                              </td>
                              <td className={`${cellCls} text-gray-400`}>â€“</td>
                              <td className={cellCls}><span className={`font-medium ${darkMode ? 'text-gray-200' : 'text-gray-800'}`}>{mrHours}h</span></td>
                              <td className={`${cellCls} text-gray-400`}>â€“</td>
                              <td className={`${cellCls} text-gray-400`}>â€“</td>
                            </tr>
                            {/* FZ row */}
                            <tr style={{ borderTop: `1px solid ${darkMode ? '#3a3a4e' : '#f0f0f0'}` }}>
                              <td className={labelCls}><span className="flex items-center gap-1"><span>ðŸš›</span><span className={`font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>FZ</span></span></td>
                              <td className={`${cellCls} text-gray-400`}>â€“</td>
                              <td className={cellCls}><span className={`font-medium ${darkMode ? 'text-gray-200' : 'text-gray-800'}`}>{fzUnits} EH</span></td>
                              <td className={`${cellCls} text-gray-400`}>â€“</td>
                              <td className={`${cellCls} text-gray-400`}>â€“</td>
                            </tr>
                            {/* WZ row - conditional */}
                            {hasWZ && (
                              <tr style={{ borderTop: `1px solid ${darkMode ? '#3a3a4e' : '#f0f0f0'}` }}>
                                <td className={labelCls}><span className="flex items-center gap-1"><span>ðŸ”§</span><span className={`font-medium ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>WZ</span></span></td>
                                <td className={`${cellCls} text-gray-400`}>â€“</td>
                                <td className={cellCls}><span className={`font-medium ${darkMode ? 'text-gray-200' : 'text-gray-800'}`}>{wzHours}h</span></td>
                                <td className={`${cellCls} text-gray-400`}>â€“</td>
                                <td className={`${cellCls} text-gray-400`}>â€“</td>
                              </tr>
                            )}
                            {/* Summe row */}
                            <tr style={{ borderTop: `2px solid ${darkMode ? '#4a4a5e' : '#d1d5db'}`, backgroundColor: darkMode ? '#252540' : '#f9fafb' }}>
                              <td className={labelCls}><span className={`font-bold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Î£</span></td>
                              <td className={cellCls}><span className={`font-bold ${darkMode ? 'text-gray-200' : 'text-gray-800'}`}>{planned}h</span></td>
                              <td className={cellCls}><span className={`font-bold ${darkMode ? 'text-gray-200' : 'text-gray-800'}`}>{maHours + mrHours + fzUnits + wzHours}h</span></td>
                              <td className={cellCls}>
                                {planned > 0 ? (
                                  <span className={`font-bold ${maOver ? 'text-red-500' : maOpen === 0 ? 'text-emerald-500' : 'text-orange-500'}`}>
                                    {maOver ? `-${maHours - planned}h` : maOpen === 0 ? 'âœ“' : `${maOpen}h`}
                                  </span>
                                ) : <span className="text-gray-400">â€“</span>}
                              </td>
                              <td className={cellCls}>
                                {planned > 0 && actual > 0 && (
                                  <div className="flex items-center gap-1 justify-end">
                                    <span className={`font-bold ${progressPct >= 100 ? 'text-emerald-500' : darkMode ? 'text-gray-200' : 'text-gray-800'}`}>{actual}h</span>
                                    <span className={`text-[9px] ${progressPct >= 100 ? 'text-emerald-500' : 'text-gray-400'}`}>{progressPct}%</span>
                                  </div>
                                )}
                              </td>
                            </tr>
                          </tbody>
                        </table>
                        {/* Progress bar */}
                        {planned > 0 && (
                          <div className="h-1.5 w-full" style={{ backgroundColor: darkMode ? '#2a2a3e' : '#f0f0f0' }}>
                            <div className="h-full rounded-r transition-all" style={{ width: `${Math.min(progressPct, 100)}%`, backgroundColor: progressPct >= 100 ? '#22c55e' : progressPct >= 50 ? '#3b82f6' : '#f59e0b' }} />
                          </div>
                        )}
                        {/* Operator warning */}
                        {mrNeedsOp && mrHours > 0 && maHours < mrHours && planned > 0 && (
                          <div className="px-2 py-1 text-[10px] flex items-center gap-1" style={{ backgroundColor: darkMode ? '#332b00' : '#fef3c7', color: darkMode ? '#fbbf24' : '#92400e' }}>
                            <span>âš ï¸</span> Maschine benÃ¶tigt Bediener â€“ MA-Stunden prÃ¼fen
                          </div>
                        )}
                      </div>
                    );
                  })()}
                  <div className="flex-shrink-0">
                  <div>
                    {getChildren(sidebarWP.id, workPackages).length > 0 ? (
                      <div className="text-sm text-gray-500 italic">{(() => { const dates = calculateDatesFromChildren(sidebarWP.id, workPackages); return dates ? `${parseLocalDate(dates.startDate).toLocaleDateString('de-DE')} - ${parseLocalDate(dates.endDate).toLocaleDateString('de-DE')}` : '-'; })()}<span className="block text-xs">(aus Unterpaketen)</span></div>
                    ) : (
                      <div className="grid grid-cols-2 gap-2">
                        <div><label className="text-xs text-gray-500">Start</label><input type="date" value={sidebarWP.startDate || ''} onClick={(e) => e.stopPropagation()} onChange={(e) => updateWorkPackage(sidebarWP.id, 'startDate', e.target.value)} className="w-full px-2 py-1 border rounded text-xs" /></div>
                        <div><label className="text-xs text-gray-500">Ende</label><input type="date" value={sidebarWP.endDate || ''} onClick={(e) => e.stopPropagation()} onChange={(e) => updateWorkPackage(sidebarWP.id, 'endDate', e.target.value)} className="w-full px-2 py-1 border rounded text-xs" /></div>
                      </div>
                    )}
                  </div>
                  {/* Optionen als kompakte Toggle-Chips */}
                  <div className="flex flex-wrap items-center gap-1.5 mt-2">
                    {(() => {
                      const wpDone = isWPDone(sidebarWP.id, workPackages);
                      const hasKids = getChildren(sidebarWP.id, workPackages).length > 0;
                      return (
                        <React.Fragment>
                          <button
                            onClick={(e) => { e.stopPropagation(); updateWorkPackage(sidebarWP.id, 'allowWeekend', !sidebarWP.allowWeekend); }}
                            className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px] border transition-colors ${sidebarWP.allowWeekend ? 'bg-blue-50 border-blue-300 text-blue-700' : 'bg-gray-50 border-gray-200 text-gray-500 hover:border-gray-300'}`}
                            title="Wochenenden und Feiertage als Arbeitstage zÃ¤hlen"
                          >ðŸ—“ï¸ inkl. Wochenende</button>
                          <button
                            onClick={(e) => { e.stopPropagation(); updateWorkPackage(sidebarWP.id, 'locked', !sidebarWP.locked); }}
                            className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px] border transition-colors ${sidebarWP.locked ? 'bg-orange-50 border-orange-300 text-orange-700' : 'bg-gray-50 border-gray-200 text-gray-500 hover:border-gray-300'}`}
                            title="Termin wird nicht durch AbhÃ¤ngigkeiten verschoben"
                          >ðŸ”’ Fixiert</button>
                          {!hasKids && (
                            <button
                              onClick={(e) => { e.stopPropagation(); toggleWPDone(sidebarWP.id); }}
                              className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px] border transition-colors ${wpDone ? 'bg-green-50 border-green-300 text-green-700' : 'bg-gray-50 border-gray-200 text-gray-500 hover:border-gray-300'}`}
                              title="Als erledigt markieren"
                            >{wpDone ? 'âœ… Erledigt' : 'â˜ Erledigt'}</button>
                          )}
                          {!hasKids && (
                            <button
                              onClick={(e) => { e.stopPropagation(); const updated = workPackages.map(w => w.id === sidebarWP.id ? { ...w, isMilestone: !w.isMilestone, endDate: !w.isMilestone ? w.startDate : w.endDate } : w); saveWorkPackages(updated); }}
                              className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px] border transition-colors ${sidebarWP.isMilestone ? 'bg-amber-50 border-amber-300 text-amber-700' : 'bg-gray-50 border-gray-200 text-gray-500 hover:border-gray-300'}`}
                              title="Als Meilenstein darstellen (1 Tag, Raute)"
                            >â—† Meilenstein</button>
                          )}
                        </React.Fragment>
                      );
                    })()}
                  </div>
                  </div>
                  {/* Kinder-Checkliste (nur bei Eltern-WPs) */}
                  {(() => {
                    const children = getChildren(sidebarWP.id, workPackages);
                    if (children.length > 0) {
                      const progress = getWPProgress(sidebarWP.id, workPackages);
                      const pct = progress.total > 0 ? Math.round(progress.done / progress.total * 100) : 0;
                      return (
                  <div className="flex-shrink-0">
                        <div>
                          <div className="flex items-center justify-between mb-1">
                            <label className="text-xs font-semibold text-gray-600">Unterpakete</label>
                            <span className={`text-xs font-medium px-1.5 py-0.5 rounded ${pct === 100 ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}`}>{progress.done}/{progress.total} ({pct}%)</span>
                          </div>
                          <div className="w-full bg-gray-200 rounded-full h-1.5 mb-2">
                            <div className="h-1.5 rounded-full transition-all" style={{ width: `${pct}%`, backgroundColor: pct === 100 ? '#22c55e' : '#6366f1' }} />
                          </div>
                          <div className="space-y-0.5 max-h-36 overflow-y-auto border rounded p-1.5">
                            {children.map(child => {
                              const childDone = isWPDone(child.id, workPackages);
                              const childHasKids = getChildren(child.id, workPackages).length > 0;
                              const childProgress = childHasKids ? getWPProgress(child.id, workPackages) : null;
                              return (
                                <div key={child.id} className="flex items-center gap-2 text-xs p-1 rounded hover:bg-gray-50 group">
                                  <button 
                                    onClick={(e) => { e.stopPropagation(); toggleWPDone(child.id); }} 
                                    className={`flex-shrink-0 transition-colors ${childDone ? 'text-green-500' : 'text-gray-300 hover:text-gray-400'}`}
                                  >
                                    {childDone ? <CheckCircle2 className="w-3.5 h-3.5" /> : <CircleIcon className="w-3.5 h-3.5" />}
                                  </button>
                                  <span 
                                    className={`flex-1 truncate cursor-pointer hover:text-indigo-600 ${childDone ? 'line-through text-gray-400' : 'text-gray-700'}`}
                                    onClick={(e) => { e.stopPropagation(); openSidebar(child.id); }}
                                    title={child.name}
                                  >{child.name}</span>
                                  {childProgress && <span className="text-[10px] text-gray-400">{childProgress.done}/{childProgress.total}</span>}
                                </div>
                              );
                            })}
                          </div>
                        </div>
                  </div>
                      );
                    }
                    return null;
                  })()}
                  {/* Zuweisungen - zwei View-Modi */}
                  {viewMode === 'compact' ? (
                    <React.Fragment>
                      <UserAssignmentSection wpId={sidebarWP.id} field="responsibles" label="Verantwortliche" filterKey="responsibles" />
                      <UserAssignmentSection wpId={sidebarWP.id} field="editors" label="Bearbeiter" filterKey="editors" />
                      <ResourceAssignmentSection wpId={sidebarWP.id} resourceType="maschine" label="Maschinen" icon="ðŸ­" filterKey="maschinen" />
                      <ResourceAssignmentSection wpId={sidebarWP.id} resourceType="fahrzeug" label="Fahrzeuge" icon="ðŸš›" filterKey="fahrzeuge" />
                      <ResourceAssignmentSection wpId={sidebarWP.id} resourceType="werkzeug" label="Werkzeuge" icon="ðŸ”§" filterKey="werkzeuge" />
                    </React.Fragment>
                  ) : (
                    <div className="flex gap-3 flex-1 min-h-0">
                      <div className="flex-1 flex flex-col gap-2 min-w-0">
                        <div className="flex-1 flex flex-col min-h-0">
                          <UserAssignmentSection wpId={sidebarWP.id} field="responsibles" label="Verantwortliche" filterKey="responsibles" stretch />
                        </div>
                        <div className="flex-1 flex flex-col min-h-0">
                          <UserAssignmentSection wpId={sidebarWP.id} field="editors" label="Bearbeiter" filterKey="editors" stretch />
                        </div>
                      </div>
                      <div className="flex-1 flex flex-col gap-2 min-w-0">
                        <div className="flex-1 flex flex-col min-h-0">
                          <ResourceAssignmentSection wpId={sidebarWP.id} resourceType="maschine" label="Maschinen" icon="ðŸ­" filterKey="maschinen" stretch />
                        </div>
                        <div className="flex-1 flex flex-col min-h-0">
                          <ResourceAssignmentSection wpId={sidebarWP.id} resourceType="fahrzeug" label="Fahrzeuge" icon="ðŸš›" filterKey="fahrzeuge" stretch />
                        </div>
                        <div className="flex-1 flex flex-col min-h-0">
                          <ResourceAssignmentSection wpId={sidebarWP.id} resourceType="werkzeug" label="Werkzeuge" icon="ðŸ”§" filterKey="werkzeuge" stretch />
                        </div>
                      </div>
                    </div>
                  )}
                  <div className="flex-shrink-0">
                    <label className="text-xs font-semibold text-gray-600 block mb-1">AbhÃ¤ngigkeiten</label>
                    <div className="space-y-1">
                      {dependencies.filter(d => d.fromId === sidebarWP.id || d.toId === sidebarWP.id).map(dep => {
                        const isFrom = dep.fromId === sidebarWP.id;
                        const otherWP = workPackages.find(w => w.id === (isFrom ? dep.toId : dep.fromId));
                        const depType = dep.type || 'FS';
                        return otherWP ? (
                          <div key={dep.id} className="flex items-center justify-between text-xs bg-gray-50 p-2 rounded hover:bg-purple-50 group transition-colors"
                            onMouseEnter={() => setHoveredDep(dep.id)}
                            onMouseLeave={() => setHoveredDep(null)}
                            style={hoveredDep === dep.id ? { backgroundColor: '#fae8ff', outline: '2px solid #d946ef', outlineOffset: -1 } : undefined}
                          >
                            <div className="flex items-center gap-1.5 min-w-0 flex-1">
                              <span className={`px-1 py-0.5 rounded text-white font-bold ${isFrom ? 'bg-blue-500' : 'bg-orange-500'}`} style={{ fontSize: 9 }}>{isFrom ? 'NACH' : 'VON'}</span>
                              <span className="truncate" title={otherWP.name}>{otherWP.name}</span>
                              <span className="text-gray-400 flex-shrink-0">({depType})</span>
                            </div>
                            <button onClick={(e) => { e.stopPropagation(); deleteDependency(dep.id); }} className="text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity p-0.5" title="AbhÃ¤ngigkeit lÃ¶schen"><X className="w-3.5 h-3.5" /></button>
                          </div>
                        ) : null;
                      })}
                      {dependencies.filter(d => d.fromId === sidebarWP.id || d.toId === sidebarWP.id).length === 0 && <div className="text-xs text-gray-400 italic">Keine AbhÃ¤ngigkeiten</div>}
                    </div>
                  </div>
                </div>
                )}
                </React.Fragment>
                )}
              </div>
            )}
            
            {/* Header mit Monat, KW, Datum, Wochentag */}
            <div className="flex flex-shrink-0 bg-white border-b z-10" style={{ display: showResourceCockpit ? 'none' : undefined }}>
                {/* Liste-Header - eingeklappt oder ausgeklappt */}
                {leftPanelWidth <= 40 ? (
                  /* Eingeklappter Zustand - nur schmaler Streifen */
                  <div className="w-10 bg-gray-200 flex items-center justify-center flex-shrink-0 border-r" style={{ height: HEADER_HEIGHT }}>
                    <button 
                      onClick={() => setLeftPanelWidth(384)}
                      className="p-1 hover:bg-gray-300 rounded text-gray-600 hover:text-gray-800 transition-colors"
                      title="Liste einblenden"
                    >
                      <ChevronRight className="w-4 h-4" />
                    </button>
                  </div>
                ) : (
                  /* Ausgeklappter Zustand */
                  <div data-panel-list className="flex-shrink-0 dm-surface bg-gray-100 relative" style={{ height: HEADER_HEIGHT, width: leftPanelWidth }}>
                    <div className="flex h-full items-end pb-2 text-xs font-semibold text-gray-600">
                      <div className="flex-1 px-2 border-r border-gray-300 flex items-center gap-1 overflow-visible relative z-10" style={{ minWidth: 160 }}>
                        <span className="flex-shrink-0">Arbeitspaket</span>
                        <div className="flex items-center gap-0.5 ml-auto flex-shrink-0">
                          <button onClick={collapseOneLevel} className="p-0.5 hover:bg-gray-300 rounded text-gray-500 hover:text-gray-700" title="Eine Ebene zuklappen"><ChevronLeft className="w-3.5 h-3.5" /></button>
                          <button onClick={() => setShowProjectBarsOnly(!showProjectBarsOnly)} className={`w-4 h-4 rounded text-[9px] font-medium flex items-center justify-center ${showProjectBarsOnly ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-500 hover:bg-gray-300'}`} title="Nur Projekte anzeigen">P</button>
                          {Array.from({ length: Math.min(getMaxLevel() + 2, 10) }, (_, i) => (
                            <button key={i} onClick={() => { setShowProjectBarsOnly(false); expandToLevel(i); }} className={`w-4 h-4 rounded text-[9px] font-medium flex items-center justify-center ${!showProjectBarsOnly && getCurrentExpandLevel() === i ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-500 hover:bg-gray-300'}`} title={i === 0 ? 'Alles zuklappen' : `Ebene ${i}`}>{i}</button>
                          ))}
                          <button onClick={expandOneLevel} className="p-0.5 hover:bg-gray-300 rounded text-gray-500 hover:text-gray-700" title="Eine Ebene aufklappen"><ChevronRight className="w-3.5 h-3.5" /></button>
                        </div>
                      </div>
                      {ganttVisibleColumns.start && (
                        <div className="relative text-center border-r border-gray-300 flex-shrink-0 select-none" style={{ width: columnWidths.start }}>
                          Start
                          <div className="absolute right-0 top-0 bottom-0 w-3 cursor-col-resize bg-transparent hover:bg-indigo-400 z-20" onMouseDown={(e) => { e.preventDefault(); e.stopPropagation(); setResizingColumn({ key: 'start', startX: e.clientX, startWidth: columnWidths.start }); }} />
                        </div>
                      )}
                      {ganttVisibleColumns.end && (
                        <div className="relative text-center border-r border-gray-300 flex-shrink-0 select-none" style={{ width: columnWidths.end }}>
                          Ende
                          <div className="absolute right-0 top-0 bottom-0 w-3 cursor-col-resize bg-transparent hover:bg-indigo-400 z-20" onMouseDown={(e) => { e.preventDefault(); e.stopPropagation(); setResizingColumn({ key: 'end', startX: e.clientX, startWidth: columnWidths.end }); }} />
                        </div>
                      )}
                      {ganttVisibleColumns.hours && (
                        <div className="relative text-center border-r border-gray-300 flex-shrink-0 select-none" style={{ width: columnWidths.hours }}>
                          Plan h
                          <div className="absolute right-0 top-0 bottom-0 w-3 cursor-col-resize bg-transparent hover:bg-indigo-400 z-20" onMouseDown={(e) => { e.preventDefault(); e.stopPropagation(); setResizingColumn({ key: 'hours', startX: e.clientX, startWidth: columnWidths.hours }); }} />
                        </div>
                      )}
                      {ganttVisibleColumns.days && (
                        <div className="relative text-center flex-shrink-0 select-none" style={{ width: columnWidths.days }}>
                          KT
                          <div className="absolute right-0 top-0 bottom-0 w-3 cursor-col-resize bg-transparent hover:bg-indigo-400 z-20" onMouseDown={(e) => { e.preventDefault(); e.stopPropagation(); setResizingColumn({ key: 'days', startX: e.clientX, startWidth: columnWidths.days }); }} />
                        </div>
                      )}
                    </div>
                    {/* Resize Handle + Einklapp-Button fÃ¼r die gesamte Liste - am rechten Rand */}
                    <div 
                      className="absolute right-0 top-0 bottom-0 w-1 cursor-col-resize bg-gray-300 hover:bg-indigo-500 hover:w-2 active:bg-indigo-600 z-50 transition-all"
                      onMouseDown={(e) => { 
                        e.preventDefault(); 
                        e.stopPropagation(); 
                        setIsResizingPanel(true); 
                      }}
                      title="Liste verbreitern/verkleinern"
                    />
                    {/* Einklapp-Button */}
                    <button
                      onClick={() => setLeftPanelWidth(0)}
                      className="absolute right-1 top-1 w-5 h-5 flex items-center justify-center bg-gray-200 hover:bg-indigo-500 hover:text-white rounded text-gray-500 z-50 transition-colors"
                      title="Liste ausblenden"
                    >
                      <ChevronLeft className="w-3 h-3" />
                    </button>
                  </div>
                )}
                <div 
                  ref={headerScrollRef}
                  className="flex-1 overflow-x-auto overflow-y-hidden hide-scrollbar"
                  onScroll={(e) => {
                    // Synchronisiere mit ganttHScrollRef
                    if (ganttHScrollRef.current && ganttHScrollRef.current.scrollLeft !== e.target.scrollLeft) {
                      ganttHScrollRef.current.scrollLeft = e.target.scrollLeft;
                    }
                    if (bottomScrollRef.current && bottomScrollRef.current.scrollLeft !== e.target.scrollLeft) {
                      bottomScrollRef.current.scrollLeft = e.target.scrollLeft;
                    }
                  }}
                >
                  <div className="flex flex-col" style={{ minWidth: ganttContentWidth }}>
                    {/* Monat Header */}
                    <div className="flex border-b bg-gray-50">
                      {monthHeaders.map((m, i) => (
                        <div key={i} style={{ width: m.weeks * 7 * DAY_WIDTH }} className="text-xs font-semibold text-center py-1 text-gray-700 border-r">{m.name}</div>
                      ))}
                    </div>
                    {/* KW + Datum + Wochentag */}
                    <div className="flex flex-1">
                      {weekNumbers.map(weekNum => {
                        const weekDates = getWeekDates(weekNum, new Date().getFullYear());
                        const displayWeekNum = weekDates.length > 0 ? getWeekNumber(weekDates[0]) : weekNum;
                        return (
                          <div key={weekNum} style={{ width: 7 * DAY_WIDTH }} className="flex-shrink-0 flex flex-col border-r">
                            <div className="text-xs font-semibold text-center py-0.5 border-b" style={{ fontSize: zoomLevel < 150 ? 9 : 11, backgroundColor: darkMode ? '#2a2a3e' : '#eef2ff' }}>KW {displayWeekNum}</div>
                            <div className="flex border-b">
                              {weekDates.map((date, i) => {
                                const dateStr = formatDate(date);
                                const holiday = holidays[dateStr];
                                const isToday = dateStr === formatDate(new Date());
                                const isHighlighted = highlightedDays[dateStr];
                                return (
                                  <div 
                                    key={i} 
                                    className={`text-center border-r cursor-pointer`}
                                    style={{ width: DAY_WIDTH, borderBottom: isHighlighted ? `3px solid ${isHighlighted}` : undefined, backgroundColor: isToday ? (darkMode ? '#4a2028' : '#fecaca') : holiday ? (darkMode ? '#4a2028' : '#fecaca') : i >= 5 ? (darkMode ? '#1a1a2a' : '#e5e7eb') : (darkMode ? '#2a2a3e' : '#f9fafb'), borderColor: darkMode ? '#3a3a4e' : undefined }}
                                    onContextMenu={(e) => { e.preventDefault(); setDayContextMenu({ x: e.clientX, y: e.clientY, date: dateStr }); }}
                                    title={holiday ? `${holiday.name} (${holiday.type === 'feiertag' ? 'Feiertag' : holiday.type === 'urlaub' ? 'Urlaub' : holiday.type === 'betriebsferien' ? 'Betriebsferien' : 'Frei'})` : ''}
                                  >
                                    <div className={`text-xs ${isToday ? 'text-red-600 font-bold' : holiday ? 'text-red-700 font-semibold' : 'text-gray-500'}`} style={{ fontSize: zoomLevel < 150 ? 8 : 10 }}>{date.getDate()}</div>
                                  </div>
                                );
                              })}
                            </div>
                            <div className="flex flex-1">
                              {weekDates.map((date, i) => { 
                                const dateStr = formatDate(date);
                                const holiday = holidays[dateStr];
                                const isWeekend = i >= 5; 
                                const isToday = dateStr === formatDate(new Date());
                                const isHighlighted = highlightedDays[dateStr];
                                return (
                                  <div 
                                    key={i} 
                                    className={`text-center py-0.5 border-r flex items-center justify-center cursor-pointer ${isToday ? 'font-bold' : ''}`}
                                    style={{ width: DAY_WIDTH, borderBottom: isHighlighted ? `3px solid ${isHighlighted}` : undefined, backgroundColor: isToday ? (darkMode ? '#4a2028' : '#fecaca') : holiday ? (darkMode ? '#5a2020' : '#fca5a5') : isWeekend ? (darkMode ? '#1a1a2a' : '#d1d5db') : (darkMode ? '#2a2a3e' : undefined), borderColor: darkMode ? '#3a3a4e' : undefined }}
                                    onContextMenu={(e) => { e.preventDefault(); setDayContextMenu({ x: e.clientX, y: e.clientY, date: dateStr }); }}
                                    title={holiday ? `${holiday.name} (${holiday.type === 'feiertag' ? 'Feiertag' : holiday.type === 'urlaub' ? 'Urlaub' : holiday.type === 'betriebsferien' ? 'Betriebsferien' : 'Frei'})` : ''}
                                  >
                                    <span className={isToday ? 'text-red-600' : holiday ? 'text-red-700' : ''} style={{ fontSize: zoomLevel < 150 ? 8 : 10 }}>{['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'][i]}</span>
                                  </div>
                                ); 
                              })}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                </div>
              </div>
              
              <div ref={ganttScrollRef} className="flex-1 overflow-y-auto overflow-x-hidden" style={{ overflowAnchor: 'none', display: showResourceCockpit ? 'none' : undefined }}
                onScroll={(e) => { window._ganttScrollTop.value = e.target.scrollTop; }}
              >
                <div className="flex" style={{ overflowAnchor: 'none' }}>
                  {/* Liste-Body - eingeklappt oder ausgeklappt */}
                  {leftPanelWidth <= 40 ? (
                    /* Eingeklappter Zustand - nur schmaler Streifen */
                    <div className="w-10 bg-gray-100 flex-shrink-0 border-r" />
                  ) : (
                    /* Ausgeklappter Zustand */
                    <div data-panel-list className="flex-shrink-0 dm-sidebar bg-white border-r relative" style={{ width: leftPanelWidth, overflowAnchor: 'none' }}>
                      {/* Resize Handle fÃ¼r die gesamte Liste */}
                      <div 
                        className="absolute right-0 top-0 bottom-0 w-1 cursor-col-resize bg-gray-300 hover:bg-indigo-500 hover:w-2 active:bg-indigo-600 z-50 transition-all"
                        onMouseDown={(e) => { e.preventDefault(); e.stopPropagation(); setIsResizingPanel(true); }}
                        title="Liste verbreitern/verkleinern"
                      />
                    {allProjectsData.map(({ project, flatList }) => (
                      <div key={project.id}>
                        {(() => {
                          const projectHasLocked = workPackages.some(w => w.projectId === project.id && w.locked);
                          return (
                        <div className={`flex items-center justify-between ${projectHasLocked ? 'cursor-not-allowed' : 'cursor-grab active:cursor-grabbing'} hover:bg-gray-100 border-b ${draggedWP?.isProject && draggedWP?.projectId === project.id ? 'bg-indigo-50' : 'bg-gray-50'}`} style={{ height: ROW_HEIGHT }}
                          title={projectHasLocked ? 'Projekt hat fixierte Termine â€“ Verschieben gesperrt' : 'Ziehen zum Verschieben'} 
                          onContextMenu={(e) => { e.preventDefault(); setContextMenu({ x: e.clientX, y: e.clientY, type: 'project', project }); }}
                          onMouseDown={(e) => {
                            if (e.button !== 0) return;
                            if (e.target.closest('button')) return;
                            if (projectHasLocked) return;
                            e.preventDefault();
                            if (ganttScrollRef.current) { window._ganttScrollTop.value = ganttScrollRef.current.scrollTop; window._ganttScrollTop.isDragging = true; }
                            if (ganttHScrollRef.current) { window._ganttScrollLeft.value = ganttHScrollRef.current.scrollLeft; }
                            const projectWPs = workPackages.filter(w => w.projectId === project.id);
                            let pStart = null, pEnd = null;
                            projectWPs.forEach(wp => {
                              const hasKids = getChildren(wp.id, workPackages).length > 0;
                              const calc = hasKids ? calculateDatesFromChildren(wp.id, workPackages) : null;
                              const s = calc?.startDate || wp.startDate;
                              const eDate = calc?.endDate || wp.endDate;
                              if (s && (!pStart || s < pStart)) pStart = s;
                              if (eDate && (!pEnd || eDate > pEnd)) pEnd = eDate;
                            });
                            setDraggedWP({ isProject: true, projectId: project.id, startX: e.clientX, daysDiff: 0, origStart: pStart, origEnd: pEnd });
                          }}
                        >
                          {(() => {
                            const isDraggingThis = draggedWP?.isProject && draggedWP?.projectId === project.id;
                            return (
                              <div className={`flex items-center gap-2 px-2 border-r border-gray-200 flex-1 ${isDraggingThis ? 'bg-indigo-50' : ''}`}>
                                <div className="w-3 h-3 rounded" style={{ backgroundColor: project.color }} />
                                <span className="font-semibold text-sm">{project.name}</span>
                                <span className="text-xs text-gray-400">({flatList.length})</span>
                                {isDraggingThis && draggedWP.daysDiff !== 0 && (
                                  <span className="bg-indigo-600 text-white px-1.5 py-0.5 rounded text-[10px] ml-auto">{draggedWP.daysDiff > 0 ? '+' : ''}{draggedWP.daysDiff} Tage</span>
                                )}
                              </div>
                            );
                          })()}
                          <button onClick={(e) => { e.stopPropagation(); addWorkPackage(project.id); }} className="p-1 hover:bg-indigo-100 rounded text-indigo-600 mr-2"><Plus className="w-4 h-4" /></button>
                          {projectHasLocked && <span className="text-orange-400 mr-2 text-xs" title="Projekt hat fixierte Termine â€“ Verschieben gesperrt">ðŸ”’</span>}
                        </div>
                          );
                        })()}
                        {!showProjectBarsOnly && flatList.map((wp, wpIndex) => {
                          const hasChildren = getChildren(wp.id, workPackages).length > 0;
                          const isExpanded = expandedPackages[wp.id] !== false;
                          const calcDates = hasChildren ? calculateDatesFromChildren(wp.id, workPackages) : null;
                          const isResizingThis = resizingWP?.wp.id === wp.id;
                          const isDraggingThis = draggedWP?.wp?.id === wp.id && !draggedWP.isSummary;
                          let displayStart = calcDates?.startDate || wp.startDate;
                          let displayEnd = calcDates?.endDate || wp.endDate;
                          // Zeige Preview wÃ¤hrend Resizing/Dragging
                          if (isResizingThis && resizingWP.side === 'left' && resizingWP.previewStart) {
                            displayStart = resizingWP.previewStart;
                          } else if (isResizingThis && resizingWP.previewEnd) {
                            displayEnd = resizingWP.previewEnd;
                          } else if (isDraggingThis && draggedWP.previewStart) {
                            displayStart = draggedWP.previewStart;
                            displayEnd = draggedWP.previewEnd;
                          }
                          const days = displayStart && displayEnd ? Math.ceil((parseLocalDate(displayEnd) - parseLocalDate(displayStart)) / (1000 * 60 * 60 * 24)) + 1 : '-';
                          const isBeingDragged = rowDragWP?.id === wp.id;
                          const isDropBefore = dropTarget?.wpId === wp.id && dropTarget?.position === 'before';
                          const isDropAfter = dropTarget?.wpId === wp.id && dropTarget?.position === 'after';
                          const isDropChild = dropTarget?.wpId === wp.id && dropTarget?.position === 'child';
                          
                          return (
                            <div key={wp.id} className="relative" data-wp-row={wp.id}>
                              {/* Drop-Indikator oben */}
                              {isDropBefore && <div className="absolute top-0 left-0 right-0 h-0.5 bg-indigo-500 z-10" />}
                              
                              <div 
                                className={`flex border-b items-center text-xs group cursor-pointer ${darkMode ? 'border-[#2a2a3e] hover:bg-[#2a2a3e]' : 'border-gray-100 hover:bg-blue-50'} ${selectedWPs.includes(wp.id) ? (darkMode ? 'bg-indigo-900/30 ring-1 ring-indigo-500/50' : 'bg-indigo-100 ring-2 ring-indigo-400') : sidebarWPId === wp.id ? (darkMode ? 'bg-blue-900/25 ring-1 ring-blue-500/40' : 'bg-blue-100 ring-2 ring-blue-400') : selectedWP?.id === wp.id ? (darkMode ? 'bg-indigo-900/20 ring-1 ring-indigo-500/30' : 'bg-indigo-50 ring-1 ring-indigo-300') : searchMatchIds.has(wp.id) ? (darkMode ? 'bg-yellow-900/20 ring-1 ring-yellow-500/30' : 'bg-yellow-50 ring-1 ring-yellow-300') : criticalPathIds.has(wp.id) ? (darkMode ? 'bg-red-900/15' : 'bg-red-50/50') : ''} ${isBeingDragged ? 'opacity-50' : ''} ${isDropChild ? (darkMode ? 'bg-indigo-900/30 ring-1 ring-indigo-500/50' : 'bg-indigo-100 ring-2 ring-indigo-400') : ''}`} 
                                style={{ height: ROW_HEIGHT }} 
                                onClick={(e) => handleWPClick(e, wp, flatList)} 
                                onContextMenu={(e) => { e.preventDefault(); setContextMenu({ x: e.clientX, y: e.clientY, type: 'wp', wp, project }); }}
                                onMouseEnter={() => {
                                  if (rowDragWP && rowDragWP.id !== wp.id) {
                                    // Berechne ob wir im oberen, unteren oder mittleren Bereich sind
                                    setDropTarget({ wpId: wp.id, position: 'after' });
                                  }
                                }}
                                onMouseMove={(e) => {
                                  if (rowDragWP && rowDragWP.id !== wp.id) {
                                    const rect = e.currentTarget.getBoundingClientRect();
                                    const y = e.clientY - rect.top;
                                    const third = rect.height / 3;
                                    if (y < third) {
                                      setDropTarget({ wpId: wp.id, position: 'before' });
                                    } else if (y > third * 2) {
                                      setDropTarget({ wpId: wp.id, position: 'after' });
                                    } else {
                                      setDropTarget({ wpId: wp.id, position: 'child' });
                                    }
                                  }
                                }}
                                onMouseLeave={() => {
                                  if (rowDragWP && dropTarget?.wpId === wp.id) {
                                    setDropTarget(null);
                                  }
                                }}
                              >
                                <div className="flex-1 flex items-center min-w-0 border-r border-gray-200 h-full" style={{ minWidth: 120 }}>
                                  {/* Checkbox fÃ¼r Multi-Select */}
                                  <input 
                                    type="checkbox"
                                    checked={selectedWPs.includes(wp.id)}
                                    readOnly
                                    onClick={(e) => { e.stopPropagation(); handleWPCheckbox(e, wp); }}
                                    className="w-3 h-3 ml-1 flex-shrink-0 accent-indigo-600 cursor-pointer"
                                  />
                                  {/* Drag Handle */}
                                  <div 
                                    className="cursor-grab opacity-0 group-hover:opacity-50 hover:opacity-100 px-0.5 flex-shrink-0"
                                    onMouseDown={(e) => { e.stopPropagation(); e.preventDefault(); setRowDragWP(wp); }}
                                  >
                                    <GripVertical className="w-3 h-3 text-gray-400" />
                                  </div>
                                  {/* Tree Lines */}
                                  <div className="flex items-center h-full flex-shrink-0" style={{ width: wp._level * 18 }}>
                                    {Array.from({ length: wp._level }).map((_, lvl) => {
                                      const isConnector = lvl === wp._level - 1;
                                      // Continuation line: draw if the ancestor at this level is NOT the last child
                                      // _parentIsLastPath[lvl] = true means ancestor at level lvl was last child â†’ no line needed
                                      const shouldDrawContinuation = !isConnector && !wp._parentIsLastPath[lvl];
                                      return (
                                        <div key={lvl} className="relative h-full flex-shrink-0" style={{ width: 18 }}>
                                          {isConnector ? (
                                            <React.Fragment>
                                              {/* Vertical line from top */}
                                              <div className="absolute left-2 top-0" style={{ width: 1, height: wp._isLastChild ? '50%' : '100%', backgroundColor: '#d1d5db' }} />
                                              {/* Horizontal connector */}
                                              <div className="absolute left-2 top-1/2" style={{ width: 10, height: 1, backgroundColor: '#d1d5db' }} />
                                            </React.Fragment>
                                          ) : (
                                            /* Continuation line for non-last ancestors */
                                            shouldDrawContinuation && <div className="absolute left-2 top-0 bottom-0" style={{ width: 1, backgroundColor: '#d1d5db' }} />
                                          )}
                                        </div>
                                      );
                                    })}
                                  </div>
                                  {/* Expand/Collapse */}
                                  {hasChildren ? (
                                    <button onClick={(e) => { e.stopPropagation(); toggleExpand(wp.id); }} className="p-0.5 hover:bg-gray-200 rounded flex-shrink-0">
                                      {isExpanded ? <ChevronDown className="w-3.5 h-3.5 text-gray-600" /> : <ChevronRight className="w-3.5 h-3.5 text-gray-600" />}
                                    </button>
                                  ) : <span className="w-4 flex-shrink-0" />}
                                  {/* Done Check */}
                                  <button 
                                    onClick={(e) => { e.stopPropagation(); toggleWPDone(wp.id); }} 
                                    className={`flex-shrink-0 transition-colors ${isWPDone(wp.id, workPackages) ? 'text-green-500 hover:text-green-600' : 'text-gray-300 hover:text-gray-400'}`}
                                    title={isWPDone(wp.id, workPackages) ? 'Als offen markieren' : 'Als erledigt markieren'}
                                  >
                                    {isWPDone(wp.id, workPackages) ? <CheckCircle2 className="w-4 h-4" /> : <CircleIcon className="w-4 h-4" />}
                                  </button>
                                  {/* Color dot */}
                                  {wp.isMilestone ? (
                                    <div className="w-2.5 h-2.5 rotate-45 flex-shrink-0 mx-0.5" style={{ backgroundColor: wp.color || project.color }} />
                                  ) : (
                                    <div className="w-2.5 h-2.5 rounded-sm flex-shrink-0 mx-0.5" style={{ backgroundColor: wp.color || project.color }} />
                                  )}
                                  {/* Name */}
                                  {editingName === wp.id ? <input autoFocus type="text" defaultValue={wp.name} className="flex-1 min-w-0 px-1 border rounded text-xs" onClick={(e) => e.stopPropagation()} onBlur={(e) => { const updated = workPackages.map(w => w.id === wp.id ? { ...w, name: e.target.value } : w); saveWorkPackages(updated); setEditingName(null); }} onKeyDown={(e) => { if (e.key === 'Enter') e.target.blur(); if (e.key === 'Escape') setEditingName(null); }} /> : <span className={`truncate cursor-text ${hasChildren ? 'font-semibold text-gray-800' : 'text-gray-700'} ${isWPDone(wp.id, workPackages) ? 'line-through opacity-50' : ''}`} onDoubleClick={(e) => { e.stopPropagation(); setEditingName(wp.id); }}>{wp.name}</span>}
                                </div>
                                {ganttVisibleColumns.start && <div className="text-center border-r border-gray-200 h-full flex items-center justify-center flex-shrink-0 overflow-hidden relative" style={{ width: columnWidths.start }}>{hasChildren ? <span className="text-gray-400 italic text-xs">auto</span> : <React.Fragment><span className="text-xs cursor-pointer hover:text-indigo-600" style={{ fontSize: 9 }} onClick={(e) => { e.stopPropagation(); const input = e.currentTarget.nextSibling; input.style.opacity = '1'; input.style.position = 'relative'; input.style.width = '100%'; input.focus(); }}>{formatDateShort(wp.startDate) || '-'}</span><input type="date" value={wp.startDate || ''} onChange={(e) => { const updated = workPackages.map(w => w.id === wp.id ? { ...w, startDate: e.target.value } : w); saveWorkPackages(updated); }} onBlur={(e) => { e.target.style.opacity = '0'; e.target.style.position = 'absolute'; e.target.style.width = '0'; }} className="absolute opacity-0 w-0 h-0 text-xs" style={{ fontSize: 9 }} /></React.Fragment>}</div>}
                                {ganttVisibleColumns.end && <div className="text-center border-r border-gray-200 h-full flex items-center justify-center flex-shrink-0 overflow-hidden relative" style={{ width: columnWidths.end }}>{hasChildren ? <span className="text-gray-400 italic text-xs">auto</span> : <React.Fragment><span className="text-xs cursor-pointer hover:text-indigo-600" style={{ fontSize: 9 }} onClick={(e) => { e.stopPropagation(); const input = e.currentTarget.nextSibling; input.style.opacity = '1'; input.style.position = 'relative'; input.style.width = '100%'; input.focus(); }}>{formatDateShort(wp.endDate) || '-'}</span><input type="date" value={wp.endDate || ''} onChange={(e) => { const updated = workPackages.map(w => w.id === wp.id ? { ...w, endDate: e.target.value } : w); saveWorkPackages(updated); }} onBlur={(e) => { e.target.style.opacity = '0'; e.target.style.position = 'absolute'; e.target.style.width = '0'; }} className="absolute opacity-0 w-0 h-0 text-xs" style={{ fontSize: 9 }} /></React.Fragment>}</div>}
                                {ganttVisibleColumns.hours && <div className="text-center text-gray-500 font-medium border-r border-gray-200 h-full flex items-center justify-center flex-shrink-0 relative overflow-hidden" style={{ width: columnWidths.hours, fontSize: 10 }}>{hasChildren ? <span className="text-gray-400 italic text-xs" title="Summe aus Unterpaketen">{calculateTotalHours(wp.id) || 0}h</span> : <React.Fragment><span className="cursor-pointer hover:text-indigo-600 hover:bg-indigo-50 px-1 rounded" onClick={(e) => { e.stopPropagation(); const input = e.currentTarget.nextSibling; input.style.opacity = '1'; input.style.width = '100%'; input.focus(); input.select(); }}>{wp.plannedHours ? `${wp.plannedHours}h` : '-'}</span><input type="number" min="0" step="0.5" defaultValue={wp.plannedHours || ''} placeholder="0" onClick={(e) => e.stopPropagation()} onFocus={(e) => { e.target.style.opacity = '1'; e.target.style.width = '100%'; }} onBlur={(e) => { const val = parseFloat(e.target.value) || 0; if (val !== (wp.plannedHours || 0)) { const updated = workPackages.map(w => w.id === wp.id ? { ...w, plannedHours: val } : w); saveWorkPackages(updated); } e.target.style.opacity = '0'; e.target.style.width = '0'; }} onKeyDown={(e) => { if (e.key === 'Enter') e.target.blur(); if (e.key === 'Escape') { e.target.value = wp.plannedHours || ''; e.target.blur(); } }} className="absolute inset-0 opacity-0 w-0 text-center text-xs bg-white border border-indigo-300 rounded" style={{ fontSize: 10 }} /></React.Fragment>}</div>}
                                {ganttVisibleColumns.days && <div className="text-center text-gray-500 h-full flex items-center justify-center flex-shrink-0" style={{ width: columnWidths.days }}>{days}</div>}
                              </div>
                              
                              {/* Drop-Indikator unten */}
                              {isDropAfter && <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-indigo-500 z-10" />}
                            </div>
                          );
                        })}
                        {!showProjectBarsOnly && flatList.length === 0 && <div className="px-4 text-xs text-gray-400 italic border-b flex items-center" style={{ height: ROW_HEIGHT }}>Keine Arbeitspakete</div>}
                      </div>
                    ))}
                    {/* Extra Scroll-Raum unten (synchron mit Gantt) */}
                    <div style={{ height: 500 }} />
                  </div>
                  )}
                  
                  <div 
                    ref={ganttHScrollRef} 
                    className="flex-1 overflow-x-auto" 
                    style={{ overflowAnchor: 'none' }}
                    onScroll={(e) => {
                      window._ganttScrollLeft.value = e.target.scrollLeft;
                      // Track content width changes
                      if (e.target.scrollWidth !== ganttContentWidth) setGanttContentWidth(e.target.scrollWidth);
                      // Sync header
                      if (headerScrollRef.current && headerScrollRef.current.scrollLeft !== e.target.scrollLeft) {
                        headerScrollRef.current.scrollLeft = e.target.scrollLeft;
                      }
                      // Sync workload
                      if (workloadScrollRef.current && workloadScrollRef.current.scrollLeft !== e.target.scrollLeft) {
                        workloadScrollRef.current.scrollLeft = e.target.scrollLeft;
                      }
                      // Sync bottom scrollbar
                      if (bottomScrollRef.current && bottomScrollRef.current.scrollLeft !== e.target.scrollLeft) {
                        bottomScrollRef.current.scrollLeft = e.target.scrollLeft;
                      }
                    }}
                  >
                    <div className="min-w-max relative"
                      onContextMenu={(e) => {
                        // Nur wenn direkt auf Hintergrund geklickt (nicht auf einen Balken)
                        if (e.target.closest('[data-wp-id]')) return;
                        e.preventDefault();
                        // Datum aus X-Position berechnen
                        const rect = e.currentTarget.getBoundingClientRect();
                        const relX = e.clientX - rect.left;
                        const clickedDate = xToDate(relX);
                        // Projekt ermitteln (ausgewÃ¤hltes oder erstes)
                        const targetProject = selectedProjectId 
                          ? projects.find(p => p.id === selectedProjectId) 
                          : projects[0];
                        if (targetProject) {
                          setContextMenu({ 
                            x: e.clientX, y: e.clientY, type: 'gantt-bg', 
                            date: clickedDate, project: targetProject 
                          });
                        }
                      }}
                    >
                      {/* Feiertags-Overlay - halbtransparente Streifen fÃ¼r jeden Feiertag/freien Tag */}
                      {Object.keys(holidays).length > 0 && (
                        <div className="absolute inset-0 pointer-events-none z-5">
                          {Object.entries(holidays).map(([dateStr, holiday]) => {
                            const dayX = dateToX(dateStr);
                            if (dayX < 0 || dayX > WEEKS_TO_SHOW * 7 * DAY_WIDTH) return null;
                            const colorMap = {
                              feiertag: 'rgba(239, 68, 68, 0.15)',      // rot
                              urlaub: 'rgba(249, 115, 22, 0.15)',       // orange  
                              betriebsferien: 'rgba(168, 85, 247, 0.15)', // lila
                              frei: 'rgba(107, 114, 128, 0.15)'         // grau
                            };
                            return (
                              <div
                                key={dateStr}
                                className="absolute top-0 bottom-0"
                                style={{ 
                                  left: dayX, 
                                  width: DAY_WIDTH, 
                                  backgroundColor: colorMap[holiday.type] || 'rgba(239, 68, 68, 0.15)'
                                }}
                                title={`${holiday.name} (${holiday.type})`}
                              />
                            );
                          })}
                        </div>
                      )}
                      {allProjectsData.map(({ project, flatList }) => {
                        const gridBgImage = darkMode ? `
                          repeating-linear-gradient(90deg, transparent 0, transparent ${DAY_WIDTH - 1}px, #2e2e44 ${DAY_WIDTH - 1}px, #2e2e44 ${DAY_WIDTH}px),
                          repeating-linear-gradient(90deg, transparent 0, transparent ${DAY_WIDTH * 5}px, #1a1a2a ${DAY_WIDTH * 5}px, #1a1a2a ${DAY_WIDTH * 7}px)
                        ` : `
                          repeating-linear-gradient(90deg, transparent 0, transparent ${DAY_WIDTH - 1}px, #e5e7eb ${DAY_WIDTH - 1}px, #e5e7eb ${DAY_WIDTH}px),
                          repeating-linear-gradient(90deg, transparent 0, transparent ${DAY_WIDTH * 5}px, #d1d5db ${DAY_WIDTH * 5}px, #d1d5db ${DAY_WIDTH * 7}px)
                        `;
                        return (
                        <div key={project.id}>
                          {(() => {
                            // Calculate project span from all WPs
                            const projectWPs = workPackages.filter(w => w.projectId === project.id);
                            let projStart = null, projEnd = null;
                            projectWPs.forEach(wp => {
                              const hasKids = getChildren(wp.id, workPackages).length > 0;
                              const calc = hasKids ? calculateDatesFromChildren(wp.id, workPackages) : null;
                              const s = calc?.startDate || wp.startDate;
                              const e = calc?.endDate || wp.endDate;
                              if (s && (!projStart || s < projStart)) projStart = s;
                              if (e && (!projEnd || e > projEnd)) projEnd = e;
                            });
                            const totalHours = projectWPs.reduce((sum, wp) => {
                              const hrs = wp.responsibles?.reduce((s, a) => s + (typeof a === 'object' ? (a.hours || 0) : 0), 0) || 0;
                              const eHrs = wp.editors?.reduce((s, a) => s + (typeof a === 'object' ? (a.hours || 0) : 0), 0) || 0;
                              return sum + hrs + eHrs;
                            }, 0);
                            return (
                            <div className={`relative flex items-center border-b ${darkMode ? 'border-[#2a2a3e]' : 'border-gray-100'} ${projectWPs.some(w => w.locked) ? 'cursor-not-allowed' : 'cursor-grab active:cursor-grabbing'} ${draggedWP?.isProject && draggedWP?.projectId === project.id ? (darkMode ? 'bg-indigo-900/20' : 'bg-indigo-50') : (darkMode ? '' : 'bg-gray-50')}`} style={{ height: ROW_HEIGHT, minWidth: WEEKS_TO_SHOW * 7 * DAY_WIDTH, backgroundImage: gridBgImage }}
                              title={projectWPs.some(w => w.locked) ? 'Projekt hat fixierte Termine â€“ Verschieben gesperrt' : 'Ziehen zum Verschieben aller Arbeitspakete'}
                              onMouseDown={(e) => {
                                if (e.button !== 0) return;
                                if (projectWPs.some(w => w.locked)) return;
                                e.stopPropagation(); e.preventDefault();
                                if (ganttScrollRef.current) { window._ganttScrollTop.value = ganttScrollRef.current.scrollTop; window._ganttScrollTop.isDragging = true; }
                                if (ganttHScrollRef.current) { window._ganttScrollLeft.value = ganttHScrollRef.current.scrollLeft; }
                                setDraggedWP({ isProject: true, projectId: project.id, startX: e.clientX, daysDiff: 0, origStart: projStart, origEnd: projEnd });
                              }}
                            >
                              {projStart && projEnd && (() => {
                                const isDraggingProject = draggedWP?.isProject && draggedWP?.projectId === project.id;
                                const dragOffset = isDraggingProject ? (draggedWP.daysDiff || 0) * DAY_WIDTH : 0;
                                const x = dateToX(projStart) + dragOffset;
                                const endX = dateToX(projEnd) + DAY_WIDTH + dragOffset;
                                const w = endX - x;
                                const barH = showProjectBarsOnly ? ROW_HEIGHT - 8 : 8;
                                const barOpacity = showProjectBarsOnly ? 0.85 : 0.35;
                                return (
                                  <React.Fragment>
                                  {/* Ghost at original position during drag */}
                                  {isDraggingProject && dragOffset !== 0 && (
                                    <div className="absolute flex items-center opacity-25" style={{ left: dateToX(projStart), width: dateToX(projEnd) + DAY_WIDTH - dateToX(projStart), height: ROW_HEIGHT - 4, top: 2 }}>
                                      <div className="w-full rounded-sm" style={{ height: barH, backgroundColor: project.color }} />
                                    </div>
                                  )}
                                  <div className={`absolute flex items-center ${isDraggingProject ? 'z-20' : ''}`} style={{ left: x, width: w, height: ROW_HEIGHT - 4, top: 2, opacity: isDraggingProject ? 0.8 : 1, pointerEvents: 'none' }}>
                                    {/* Diamond start */}
                                    <div className="absolute" style={{ left: -4, top: '50%', transform: 'translateY(-50%) rotate(45deg)', width: 8, height: 8, backgroundColor: project.color, opacity: 0.8 }} />
                                    {/* Bar */}
                                    <div className="w-full rounded-sm" style={{ height: barH, backgroundColor: project.color, opacity: barOpacity }} />
                                    {/* Diamond end */}
                                    <div className="absolute" style={{ right: -4, top: '50%', transform: 'translateY(-50%) rotate(45deg)', width: 8, height: 8, backgroundColor: project.color, opacity: 0.8 }} />
                                    {/* Label */}
                                    <span className="absolute text-xs font-semibold whitespace-nowrap pointer-events-none" style={{ left: w + 8, color: project.color }}>
                                      {isDraggingProject && draggedWP.daysDiff !== 0 
                                        ? <span className="bg-indigo-600 text-white px-1.5 py-0.5 rounded text-[10px]">{draggedWP.daysDiff > 0 ? '+' : ''}{draggedWP.daysDiff} Tage</span>
                                        : (showProjectBarsOnly ? `${project.name}  ${showHours && totalHours > 0 ? totalHours + 'h' : ''}` : (showHours && totalHours > 0 ? `${totalHours}h` : ''))
                                      }
                                    </span>
                                    {showProjectBarsOnly && <span className="absolute text-xs text-white font-medium whitespace-nowrap pointer-events-none px-2" style={{ left: 4 }}>{projStart} â€“ {projEnd}</span>}
                                  </div>
                                  </React.Fragment>
                                );
                              })()}
                            </div>
                            );
                          })()}
                          {!showProjectBarsOnly && flatList.map(wp => {
                            const hasChildren = getChildren(wp.id, workPackages).length > 0;
                            const isExpanded = expandedPackages[wp.id] !== false;
                            const calcDates = hasChildren ? calculateDatesFromChildren(wp.id, workPackages) : null;
                            const isDragging = draggedWP?.wp?.id === wp.id;
                            const isResizing = resizingWP?.wp.id === wp.id;
                            const hasPreview = previewPositions[wp.id]; // Live-Preview fÃ¼r abhÃ¤ngige Balken
                            let displayStart, displayEnd;
                            if (isDragging && !draggedWP.isSummary) {
                              displayStart = draggedWP.previewStart;
                              displayEnd = draggedWP.previewEnd;
                            } else if (isResizing) {
                              if (resizingWP.side === 'left' && resizingWP.previewStart) {
                                displayStart = resizingWP.previewStart;
                                displayEnd = calcDates?.endDate || wp.endDate;
                              } else {
                                displayStart = calcDates?.startDate || wp.startDate;
                                displayEnd = resizingWP.previewEnd || (calcDates?.endDate || wp.endDate);
                              }
                            } else if (hasPreview) {
                              // Zeige Preview-Position fÃ¼r abhÃ¤ngige Balken
                              displayStart = hasPreview.startDate;
                              displayEnd = hasPreview.endDate;
                            } else {
                              displayStart = calcDates?.startDate || wp.startDate;
                              displayEnd = calcDates?.endDate || wp.endDate;
                            }
                            
                            const isRowSelected = selectedWPs.includes(wp.id) || sidebarWPId === wp.id || selectedWP?.id === wp.id;
                            const bgStyle = {
                              height: ROW_HEIGHT, 
                              minWidth: WEEKS_TO_SHOW * 7 * DAY_WIDTH,
                              backgroundImage: gridBgImage,
                              ...(isRowSelected ? { backgroundColor: darkMode ? 'rgba(99,102,241,0.08)' : 'rgba(99,102,241,0.06)' } : {})
                            };
                            
                            if (!displayStart || !displayEnd) return <div key={wp.id} className={`border-b ${darkMode ? 'border-[#2a2a3e]' : 'border-gray-100'}`} style={bgStyle} />;
                            const x = dateToX(displayStart);
                            const endX = dateToX(displayEnd);
                            const width = endX - x + DAY_WIDTH;
                            const color = wp.color || project.color;
                            const isPreview = !!hasPreview || isDragging || isResizing;
                            const hasOriginal = originalPositions[wp.id]; // FÃ¼r violetten Schatten bei Drag
                            
                            // Baseline-Position finden
                            const baselineWP = activeBaseline?.workPackages.find(bwp => bwp.id === wp.id);
                            
                            // Violetter Schatten fÃ¼r Original-Position (beim Drag) oder Baseline
                            let shadowElement = null;
                            if (hasOriginal && (hasPreview || isDragging || isResizing)) {
                              // Drag-Preview Schatten
                              const origX = dateToX(hasOriginal.startDate);
                              const origEndX = dateToX(hasOriginal.endDate);
                              const origWidth = origEndX - origX + DAY_WIDTH;
                              shadowElement = (
                                <div 
                                  className="absolute rounded opacity-30 pointer-events-none"
                                  style={{ 
                                    left: origX, 
                                    width: origWidth, 
                                    top: hasChildren ? 4 : (wp._level > 0 ? 6 : 4), 
                                    height: hasChildren ? ROW_HEIGHT - 8 : (wp._level > 0 ? ROW_HEIGHT - 12 : ROW_HEIGHT - 8),
                                    backgroundColor: '#8b5cf6',
                                    border: '2px dashed #7c3aed'
                                  }} 
                                />
                              );
                            } else if (baselineWP && baselineWP.startDate && baselineWP.endDate) {
                              // Baseline Schatten (nur wenn Position anders ist)
                              const baselineStartDate = baselineWP.startDate;
                              const baselineEndDate = baselineWP.endDate;
                              const currentStart = calcDates?.startDate || wp.startDate;
                              const currentEnd = calcDates?.endDate || wp.endDate;
                              
                              if (baselineStartDate !== currentStart || baselineEndDate !== currentEnd) {
                                const baseX = dateToX(baselineStartDate);
                                const baseEndX = dateToX(baselineEndDate);
                                const baseWidth = baseEndX - baseX + DAY_WIDTH;
                                shadowElement = (
                                  <div 
                                    className="absolute rounded opacity-25 pointer-events-none"
                                    style={{ 
                                      left: baseX, 
                                      width: baseWidth, 
                                      top: hasChildren ? 4 : (wp._level > 0 ? 6 : 4), 
                                      height: hasChildren ? ROW_HEIGHT - 8 : (wp._level > 0 ? ROW_HEIGHT - 12 : ROW_HEIGHT - 8),
                                      backgroundColor: '#8b5cf6',
                                      border: '2px dashed #7c3aed'
                                    }} 
                                  />
                                );
                              }
                            }
                            
                            const isBeingDragged = rowDragWP?.id === wp.id;
                            const isDropBefore = dropTarget?.wpId === wp.id && dropTarget?.position === 'before';
                            const isDropAfter = dropTarget?.wpId === wp.id && dropTarget?.position === 'after';
                            const isDropChild = dropTarget?.wpId === wp.id && dropTarget?.position === 'child';
                            
                            return (
                              <div key={wp.id} className="relative" data-wp-row-right={wp.id}>
                                {/* Drop-Indikator oben */}
                                {isDropBefore && <div className="absolute top-0 left-0 right-0 h-0.5 bg-indigo-500 z-10" />}
                                
                                <div 
                                  className={`relative border-b group ${darkMode ? 'border-[#2a2a3e]' : 'border-gray-100'} ${isBeingDragged ? 'opacity-50' : ''} ${isDropChild ? 'ring-2 ring-indigo-400 ring-inset' : ''}`} 
                                  style={bgStyle}
                                  onMouseEnter={() => {
                                    if (rowDragWP && rowDragWP.id !== wp.id) {
                                      setDropTarget({ wpId: wp.id, position: 'after' });
                                    }
                                  }}
                                  onMouseMove={(e) => {
                                    if (rowDragWP && rowDragWP.id !== wp.id) {
                                      const rect = e.currentTarget.getBoundingClientRect();
                                      const y = e.clientY - rect.top;
                                      const third = rect.height / 3;
                                      if (y < third) {
                                        setDropTarget({ wpId: wp.id, position: 'before' });
                                      } else if (y > third * 2) {
                                        setDropTarget({ wpId: wp.id, position: 'after' });
                                      } else {
                                        setDropTarget({ wpId: wp.id, position: 'child' });
                                      }
                                    }
                                  }}
                                  onMouseLeave={() => {
                                    if (rowDragWP && dropTarget?.wpId === wp.id) {
                                      setDropTarget(null);
                                    }
                                  }}
                                >
                                  {shadowElement}
                                  {wp.isMilestone ? renderMilestone(wp, x, color) : hasChildren && isExpanded ? renderBracket(wp, x, width, color) : renderBar(wp, x, width, color, wp._level > 0)}
                                </div>
                                
                                {/* Drop-Indikator unten */}
                                {isDropAfter && <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-indigo-500 z-10" />}
                              </div>
                            );
                          })}
                          {!showProjectBarsOnly && flatList.length === 0 && <div className="border-b border-gray-100" style={{ height: ROW_HEIGHT, minWidth: WEEKS_TO_SHOW * 7 * DAY_WIDTH, backgroundImage: gridBgImage }} />}
                        </div>
                      );})}
                      {/* Extra Scroll-Raum unten */}
                      <div style={{ height: 500, minWidth: WEEKS_TO_SHOW * 7 * DAY_WIDTH, backgroundImage: darkMode ? `repeating-linear-gradient(90deg, transparent 0, transparent ${DAY_WIDTH * 5}px, #1a1a2a ${DAY_WIDTH * 5}px, #1a1a2a ${DAY_WIDTH * 7}px)` : `repeating-linear-gradient(90deg, transparent 0, transparent ${DAY_WIDTH * 5}px, #d1d5db ${DAY_WIDTH * 5}px, #d1d5db ${DAY_WIDTH * 7}px)` }} />
                      {/* Hervorgehobene Tage */}
                      {Object.keys(highlightedDays).length > 0 && (
                        <div className="absolute inset-0 pointer-events-none" style={{ zIndex: 2 }}>
                          {Object.entries(highlightedDays).map(([dateStr, color]) => {
                            const dayX = dateToX(dateStr);
                            if (dayX < 0 || dayX > WEEKS_TO_SHOW * 7 * DAY_WIDTH) return null;
                            return (
                              <div
                                key={`hl-${dateStr}`}
                                className="absolute top-0 bottom-0"
                                style={{ left: dayX, width: DAY_WIDTH, backgroundColor: color, opacity: 0.2 }}
                              />
                            );
                          })}
                        </div>
                      )}
                      {/* Heutige-Tag Markierung - Roter Strich (nach Rows gerendert = Ã¼ber Backgrounds, z-3 < Balken z-6) */}
                      {(() => {
                        const todayX = dateToX(formatDate(new Date()));
                        if (todayX >= 0 && todayX <= WEEKS_TO_SHOW * 7 * DAY_WIDTH) {
                          return (
                            <div 
                              className="absolute top-0 bottom-0 pointer-events-none"
                              style={{ left: todayX + Math.floor(DAY_WIDTH / 2) - 1, width: 2, backgroundColor: '#ef4444', zIndex: 3 }}
                            />
                          );
                        }
                        return null;
                      })()}
                      {!showProjectBarsOnly && <svg className="absolute top-0 left-0 pointer-events-none" style={{ width: WEEKS_TO_SHOW * 7 * DAY_WIDTH, height: '100%', overflow: 'visible' }}>
                        <defs>
                          <marker id="arrow-gray" markerWidth="5" markerHeight="4" refX="4" refY="2" orient="auto"><polygon points="0 0, 5 2, 0 4" fill="#9ca3af" /></marker>
                          <marker id="arrow-red" markerWidth="5" markerHeight="4" refX="4" refY="2" orient="auto"><polygon points="0 0, 5 2, 0 4" fill="#ef4444" /></marker>
                          <marker id="arrow-orange" markerWidth="5" markerHeight="4" refX="4" refY="2" orient="auto"><polygon points="0 0, 5 2, 0 4" fill="#f97316" /></marker>
                          <marker id="arrow-magenta" markerWidth="5" markerHeight="4" refX="4" refY="2" orient="auto"><polygon points="0 0, 5 2, 0 4" fill="#d946ef" /></marker>
                          <filter id="glow-magenta" x="-50%" y="-50%" width="200%" height="200%">
                            <feGaussianBlur stdDeviation="3" result="blur" />
                            <feMerge><feMergeNode in="blur" /><feMergeNode in="blur" /><feMergeNode in="SourceGraphic" /></feMerge>
                          </filter>
                        </defs>
                        {dependencies.map(dep => {
                          const fromWP = workPackages.find(w => w.id === dep.fromId);
                          const toWP = workPackages.find(w => w.id === dep.toId);
                          if (!fromWP || !toWP) return null;
                          
                          const depType = dep.type || 'FS'; // Standard ist Finish-to-Start
                          const isSSType = depType === 'SS';
                          
                          // PrÃ¼fe ob Ziel gesperrt ist und Konflikt besteht
                          const toIsLocked = toWP.locked === true;
                          let hasConflict = false;
                          if (toIsLocked && !isSSType) {
                            // FS: Konflikt wenn VorgÃ¤nger-Ende >= Nachfolger-Start
                            const fromEndDate = getChildren(fromWP.id, workPackages).length > 0 
                              ? calculateDatesFromChildren(fromWP.id, workPackages)?.endDate 
                              : fromWP.endDate;
                            const toStartDate = getChildren(toWP.id, workPackages).length > 0 
                              ? calculateDatesFromChildren(toWP.id, workPackages)?.startDate 
                              : toWP.startDate;
                            if (fromEndDate && toStartDate && parseLocalDate(fromEndDate) >= parseLocalDate(toStartDate)) {
                              hasConflict = true;
                            }
                          } else if (toIsLocked && isSSType) {
                            // SS: Konflikt wenn VorgÃ¤nger-Start > Nachfolger-Start
                            const fromStartDate = getChildren(fromWP.id, workPackages).length > 0 
                              ? calculateDatesFromChildren(fromWP.id, workPackages)?.startDate 
                              : fromWP.startDate;
                            const toStartDate = getChildren(toWP.id, workPackages).length > 0 
                              ? calculateDatesFromChildren(toWP.id, workPackages)?.startDate 
                              : toWP.startDate;
                            if (fromStartDate && toStartDate && parseLocalDate(fromStartDate) > parseLocalDate(toStartDate)) {
                              hasConflict = true;
                            }
                          }
                          
                          // BerÃ¼cksichtige Preview-Positionen fÃ¼r Pfeile
                          const fromPreview = previewPositions[dep.fromId];
                          const toPreview = previewPositions[dep.toId];
                          const fromDragged = draggedWP?.wp?.id === dep.fromId;
                          const toDragged = draggedWP?.wp?.id === dep.toId;
                          const fromResized = resizingWP?.wp.id === dep.fromId && resizingWP.previewEnd;
                          
                          let fromDate, toStartDate;
                          
                          // From-Datum berechnen (Ende bei FS, Start bei SS)
                          if (isSSType) {
                            // Start-to-Start: Vom Start des From-Balkens
                            if (fromDragged && !draggedWP.isSummary && draggedWP.previewStart) {
                              fromDate = draggedWP.previewStart;
                            } else if (fromDragged && draggedWP.isSummary && draggedWP.daysDiff) {
                              const origStart = parseLocalDate(fromWP.startDate);
                              origStart.setDate(origStart.getDate() + draggedWP.daysDiff);
                              fromDate = formatDate(origStart);
                            } else if (fromPreview) {
                              fromDate = fromPreview.startDate;
                            } else {
                              const fromDates = getChildren(fromWP.id, workPackages).length > 0 ? calculateDatesFromChildren(fromWP.id, workPackages) : { startDate: fromWP.startDate };
                              fromDate = fromDates?.startDate;
                            }
                          } else {
                            // Finish-to-Start: Vom Ende des From-Balkens
                            if (fromDragged && !draggedWP.isSummary && draggedWP.previewEnd) {
                              fromDate = draggedWP.previewEnd;
                            } else if (fromDragged && draggedWP.isSummary && draggedWP.daysDiff) {
                              const origEnd = parseLocalDate(fromWP.endDate);
                              origEnd.setDate(origEnd.getDate() + draggedWP.daysDiff);
                              fromDate = formatDate(origEnd);
                            } else if (fromResized) {
                              fromDate = resizingWP.previewEnd;
                            } else if (fromPreview) {
                              fromDate = fromPreview.endDate;
                            } else {
                              const fromDates = getChildren(fromWP.id, workPackages).length > 0 ? calculateDatesFromChildren(fromWP.id, workPackages) : { endDate: fromWP.endDate };
                              fromDate = fromDates?.endDate;
                            }
                          }
                          
                          // To-Start berechnen
                          if (toDragged && !draggedWP.isSummary && draggedWP.previewStart) {
                            toStartDate = draggedWP.previewStart;
                          } else if (toDragged && draggedWP.isSummary && draggedWP.daysDiff) {
                            const origStart = parseLocalDate(toWP.startDate);
                            origStart.setDate(origStart.getDate() + draggedWP.daysDiff);
                            toStartDate = formatDate(origStart);
                          } else if (toPreview) {
                            toStartDate = toPreview.startDate;
                          } else {
                            const toDates = getChildren(toWP.id, workPackages).length > 0 ? calculateDatesFromChildren(toWP.id, workPackages) : { startDate: toWP.startDate };
                            toStartDate = toDates?.startDate;
                          }
                          
                          if (!fromDate || !toStartDate) return null;
                          let fromY = 0, toY = 0, foundFrom = false, foundTo = false, currentY = 0;
                          allProjectsData.forEach(({ flatList }) => { currentY += ROW_HEIGHT; flatList.forEach(wp => { if (wp.id === fromWP.id) { fromY = currentY + ROW_HEIGHT / 2; foundFrom = true; } if (wp.id === toWP.id) { toY = currentY + ROW_HEIGHT / 2; foundTo = true; } currentY += ROW_HEIGHT; }); if (flatList.length === 0) currentY += ROW_HEIGHT; });
                          if (!foundFrom || !foundTo) return null;
                          
                          // Bei SS: Vom Start, bei FS: Vom Ende
                          const fromX = isSSType ? dateToX(fromDate) : dateToX(fromDate) + DAY_WIDTH;
                          const toStartX = dateToX(toStartDate);
                          const isHovered = hoveredDep === dep.id;
                          
                          const r = 6;
                          const barHeight = ROW_HEIGHT - 8;
                          const startX = isSSType ? fromX + DAY_WIDTH / 2 : fromX - DAY_WIDTH / 2;
                          const startY = fromY + barHeight / 2;
                          const endX = toStartX;
                          const endY = toY;
                          const goingDown = endY > startY;
                          const goingBack = isSSType ? (toStartX < fromX + DAY_WIDTH) : (toStartX < fromX);
                          
                          let path;
                          if (Math.abs(startY - endY) < 5 && !goingBack) {
                            path = `M ${fromX} ${fromY} L ${endX} ${endY}`;
                          } else if (goingBack) {
                            const firstDropY = startY + 12;
                            const leftX = Math.min(startX, endX) - 12;
                            
                            path = `M ${startX} ${startY}`;
                            path += ` L ${startX} ${firstDropY - r}`;
                            path += ` Q ${startX} ${firstDropY}, ${startX - r} ${firstDropY}`;
                            path += ` L ${leftX + r} ${firstDropY}`;
                            path += ` Q ${leftX} ${firstDropY}, ${leftX} ${firstDropY + (goingDown ? r : -r)}`;
                            path += ` L ${leftX} ${endY + (goingDown ? -r : r)}`;
                            path += ` Q ${leftX} ${endY}, ${leftX + r} ${endY}`;
                            path += ` L ${endX} ${endY}`;
                          } else {
                            path = `M ${startX} ${startY}`;
                            path += ` L ${startX} ${endY + (goingDown ? -r : r)}`;
                            path += ` Q ${startX} ${endY}, ${startX + r} ${endY}`;
                            path += ` L ${endX} ${endY}`;
                          }
                          
                          // Alle Pfeile grau (magenta bei Hover, orange bei Konflikt)
                          const isCriticalDep = criticalPathIds.has(dep.fromId) && criticalPathIds.has(dep.toId);
                          const strokeColor = hasConflict ? '#f97316' : isCriticalDep ? '#ef4444' : (isHovered ? '#d946ef' : '#9ca3af');
                          const arrowMarker = hasConflict ? 'url(#arrow-orange)' : isCriticalDep ? 'url(#arrow-red)' : (isHovered ? 'url(#arrow-magenta)' : 'url(#arrow-gray)');
                          const strokeDasharray = hasConflict ? '6,3' : 'none';
                          
                          // Berechne Mittelpunkt entlang des Pfadverlaufs
                          let midX, midY;
                          if (Math.abs(startY - endY) < 5 && !goingBack) {
                            // Rein horizontal: Mitte der Linie
                            midX = (startX + endX) / 2;
                            midY = (startY + endY) / 2;
                          } else if (goingBack) {
                            // U-Form: Sammle Wegpunkte und finde den Mittelpunkt entlang des Pfads
                            const firstDropY = startY + 12;
                            const leftX = Math.min(startX, endX) - 12;
                            const pts = [
                              [startX, startY], [startX, firstDropY],
                              [leftX, firstDropY], [leftX, endY], [endX, endY]
                            ];
                            let totalLen = 0;
                            const segs = [];
                            for (let si = 1; si < pts.length; si++) {
                              const segLen = Math.abs(pts[si][0] - pts[si-1][0]) + Math.abs(pts[si][1] - pts[si-1][1]);
                              segs.push({ from: pts[si-1], to: pts[si], len: segLen });
                              totalLen += segLen;
                            }
                            let halfLen = totalLen / 2, acc = 0;
                            for (const seg of segs) {
                              if (acc + seg.len >= halfLen) {
                                const t = (halfLen - acc) / seg.len;
                                midX = seg.from[0] + (seg.to[0] - seg.from[0]) * t;
                                midY = seg.from[1] + (seg.to[1] - seg.from[1]) * t;
                                break;
                              }
                              acc += seg.len;
                            }
                          } else {
                            // L-Form: Wegpunkte startX,startY â†’ startX,endY â†’ endX,endY
                            const vertLen = Math.abs(endY - startY);
                            const horizLen = Math.abs(endX - startX);
                            const totalLen = vertLen + horizLen;
                            const halfLen = totalLen / 2;
                            if (halfLen <= vertLen) {
                              // Mittelpunkt auf dem vertikalen Segment
                              midX = startX;
                              midY = startY + (endY - startY) * (halfLen / vertLen);
                            } else {
                              // Mittelpunkt auf dem horizontalen Segment
                              const t = (halfLen - vertLen) / horizLen;
                              midX = startX + (endX - startX) * t;
                              midY = endY;
                            }
                          }
                          
                          return (
                            <g key={dep.id} onMouseEnter={() => setHoveredDep(dep.id)} onMouseLeave={() => setHoveredDep(null)} style={{ pointerEvents: 'stroke', cursor: 'pointer' }}>
                              <path d={path} fill="none" stroke="transparent" strokeWidth="24" />
                              <path d={path} fill="none" stroke={strokeColor} strokeWidth={isHovered ? 3.5 : hasConflict ? 2.5 : isCriticalDep ? 2.5 : 1.5} strokeDasharray={strokeDasharray} markerEnd={arrowMarker} filter={isHovered ? 'url(#glow-magenta)' : undefined} />
                              {/* Warnsymbol bei Konflikt */}
                              {hasConflict && (
                                <g transform={`translate(${midX - 10}, ${midY - 10})`} style={{ pointerEvents: 'all' }} title="Terminkonflikt: Ziel ist fixiert">
                                  <circle cx="10" cy="10" r="10" fill="#fef3c7" stroke="#f97316" strokeWidth="1.5" />
                                  <text x="10" y="14" textAnchor="middle" fontSize="13" fontWeight="bold" fill="#f97316">âš </text>
                                </g>
                              )}
                              {/* LÃ¶sch-Button - nur bei Hover auf der Mitte des horizontalen Segments */}
                              {isHovered && (
                                <g transform={`translate(${hasConflict ? midX + 4 : midX - 8}, ${midY - 8})`} onClick={() => deleteDependency(dep.id)} style={{ cursor: 'pointer', pointerEvents: 'all' }}>
                                  <circle cx="8" cy="8" r="9" fill="white" stroke="#d946ef" strokeWidth="1.5" />
                                  <path d="M5 5 L11 11 M11 5 L5 11" stroke="#d946ef" strokeWidth="1.5" strokeLinecap="round" />
                                </g>
                              )}
                            </g>
                          );
                        })}
                      </svg>}
                    </div>
                  </div>
                </div>
              </div>
          
          {linkingFrom && linkMousePos && <svg className="fixed inset-0 pointer-events-none z-40" style={{ width: '100vw', height: '100vh' }}><line x1={linkingFrom.startX || 0} y1={linkingFrom.startY || 0} x2={linkMousePos.x} y2={linkMousePos.y} stroke="#9ca3af" strokeWidth="2" strokeDasharray="5,5" /><circle cx={linkMousePos.x} cy={linkMousePos.y} r="5" fill="#9ca3af" /></svg>}

          {/* Preset Modal */}
          {wlPresetModal && (() => {
            const pm = wlPresetModal;
            const toggleUser = (uid) => setWlPresetModal(prev => ({...prev, userIds: prev.userIds.includes(uid) ? prev.userIds.filter(x => x !== uid) : [...prev.userIds, uid]}));
            const toggleRes = (rid) => setWlPresetModal(prev => ({...prev, resourceIds: prev.resourceIds.includes(rid) ? prev.resourceIds.filter(x => x !== rid) : [...prev.resourceIds, rid]}));
            const savePreset = () => {
              if (!pm.name.trim()) return;
              if (pm.id) {
                setWlCustomPresets(prev => prev.map(p => p.id === pm.id ? {...pm} : p));
                if (wlActivePreset === pm.id) setWlActivePreset(pm.id);
              } else {
                const newPreset = {...pm, id: 'preset_' + Date.now()};
                setWlCustomPresets(prev => [...prev, newPreset]);
                setWlActivePreset(newPreset.id);
                setWorkloadFilter('ma_ressourcen');
              }
              setWlPresetModal(null);
            };
            const deletePreset = () => {
              if (pm.id) {
                setWlCustomPresets(prev => prev.filter(p => p.id !== pm.id));
                if (wlActivePreset === pm.id) setWlActivePreset(null);
              }
              setWlPresetModal(null);
            };
            const dm = darkMode;
            const sortedUsers = [...users].filter(u => u.role !== 'admin').sort((a,b) => a.name.localeCompare(b.name));
            const sortedRes = [...resources].sort((a,b) => a.name.localeCompare(b.name));
            const teamMap = {};
            sortedUsers.forEach(u => {
              const t = teams.find(t => t.id === u.teamId);
              const tName = t ? t.name : 'Ohne Team';
              if (!teamMap[tName]) teamMap[tName] = [];
              teamMap[tName].push(u);
            });
            const resTypeMap = {};
            sortedRes.forEach(r => {
              const tName = r.type === 'maschine' ? 'ðŸ­ Maschinen' : r.type === 'fahrzeug' ? 'ðŸš› Fahrzeuge' : 'ðŸ”§ Werkzeuge';
              if (!resTypeMap[tName]) resTypeMap[tName] = [];
              resTypeMap[tName].push(r);
            });
            return (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[60] p-4" onClick={() => setWlPresetModal(null)}>
              <div className={`${dm ? 'bg-[#2a2a3e] text-white' : 'bg-white'} rounded-2xl shadow-2xl w-full max-w-lg max-h-[80vh] flex flex-col`} onClick={e => e.stopPropagation()}>
                <div className="p-4 border-b flex items-center gap-3" style={{ borderColor: dm ? '#3a3a4e' : '#e5e7eb' }}>
                  <span className="text-lg">â˜…</span>
                  <input autoFocus value={pm.name} onChange={e => setWlPresetModal(prev => ({...prev, name: e.target.value}))} placeholder="Preset-Name (z.B. Montageteam)" className={`flex-1 text-lg font-bold bg-transparent outline-none ${dm ? 'text-white placeholder-gray-500' : 'text-gray-900 placeholder-gray-300'}`} onKeyDown={e => { if (e.key === 'Enter') savePreset(); }} />
                  <button onClick={() => setWlPresetModal(null)} className="text-gray-400 hover:text-gray-600 text-xl">âœ•</button>
                </div>
                <div className="flex-1 overflow-y-auto p-4 space-y-4">
                  {/* Mitarbeiter */}
                  <div>
                    <div className="flex items-center justify-between mb-2">
                      <span className="font-semibold text-sm" style={{ color: dm ? '#a0a0c0' : '#374151' }}>Mitarbeiter ({pm.userIds.length}/{sortedUsers.length})</span>
                      <div className="flex gap-1">
                        <button onClick={() => setWlPresetModal(prev => ({...prev, userIds: sortedUsers.map(u => u.id)}))} className="text-[10px] px-2 py-0.5 rounded bg-indigo-100 text-indigo-700 hover:bg-indigo-200">Alle</button>
                        <button onClick={() => setWlPresetModal(prev => ({...prev, userIds: []}))} className="text-[10px] px-2 py-0.5 rounded bg-gray-100 text-gray-600 hover:bg-gray-200">Keine</button>
                      </div>
                    </div>
                    {Object.entries(teamMap).map(([tName, tUsers]) => (
                      <div key={tName} className="mb-2">
                        <div className="flex items-center gap-2 mb-1 cursor-pointer" onClick={() => { const allIn = tUsers.every(u => pm.userIds.includes(u.id)); if (allIn) setWlPresetModal(prev => ({...prev, userIds: prev.userIds.filter(id => !tUsers.some(u => u.id === id))})); else setWlPresetModal(prev => ({...prev, userIds: [...new Set([...prev.userIds, ...tUsers.map(u => u.id)])]})); }}>
                          <div className={`w-3.5 h-3.5 rounded border-2 flex items-center justify-center text-[8px] ${tUsers.every(u => pm.userIds.includes(u.id)) ? 'bg-indigo-600 border-indigo-600 text-white' : tUsers.some(u => pm.userIds.includes(u.id)) ? 'bg-indigo-200 border-indigo-400' : dm ? 'border-gray-600' : 'border-gray-300'}`}>{tUsers.every(u => pm.userIds.includes(u.id)) ? 'âœ“' : ''}</div>
                          <span className="text-xs font-semibold" style={{ color: dm ? '#8888a8' : '#6b7280' }}>{tName}</span>
                        </div>
                        <div className="ml-5 space-y-0.5">
                          {tUsers.map(u => (
                            <label key={u.id} className="flex items-center gap-2 py-0.5 cursor-pointer hover:bg-black/5 rounded px-1 -mx-1" onClick={() => toggleUser(u.id)}>
                              <div className={`w-3.5 h-3.5 rounded border-2 flex items-center justify-center text-[8px] flex-shrink-0 ${pm.userIds.includes(u.id) ? 'bg-indigo-600 border-indigo-600 text-white' : dm ? 'border-gray-600' : 'border-gray-300'}`}>{pm.userIds.includes(u.id) ? 'âœ“' : ''}</div>
                              <span className="text-sm">{u.name}</span>
                            </label>
                          ))}
                        </div>
                      </div>
                    ))}
                  </div>
                  {/* Ressourcen */}
                  {sortedRes.length > 0 && (
                    <div>
                      <div className="flex items-center justify-between mb-2">
                        <span className="font-semibold text-sm" style={{ color: dm ? '#a0a0c0' : '#374151' }}>Ressourcen ({pm.resourceIds.length}/{sortedRes.length})</span>
                        <div className="flex gap-1">
                          <button onClick={() => setWlPresetModal(prev => ({...prev, resourceIds: sortedRes.map(r => r.id)}))} className="text-[10px] px-2 py-0.5 rounded bg-indigo-100 text-indigo-700 hover:bg-indigo-200">Alle</button>
                          <button onClick={() => setWlPresetModal(prev => ({...prev, resourceIds: []}))} className="text-[10px] px-2 py-0.5 rounded bg-gray-100 text-gray-600 hover:bg-gray-200">Keine</button>
                        </div>
                      </div>
                      {Object.entries(resTypeMap).map(([typeName, typeRes]) => (
                        <div key={typeName} className="mb-2">
                          <div className="flex items-center gap-2 mb-1 cursor-pointer" onClick={() => { const allIn = typeRes.every(r => pm.resourceIds.includes(r.id)); if (allIn) setWlPresetModal(prev => ({...prev, resourceIds: prev.resourceIds.filter(id => !typeRes.some(r => r.id === id))})); else setWlPresetModal(prev => ({...prev, resourceIds: [...new Set([...prev.resourceIds, ...typeRes.map(r => r.id)])]})); }}>
                            <div className={`w-3.5 h-3.5 rounded border-2 flex items-center justify-center text-[8px] ${typeRes.every(r => pm.resourceIds.includes(r.id)) ? 'bg-teal-600 border-teal-600 text-white' : typeRes.some(r => pm.resourceIds.includes(r.id)) ? 'bg-teal-200 border-teal-400' : dm ? 'border-gray-600' : 'border-gray-300'}`}>{typeRes.every(r => pm.resourceIds.includes(r.id)) ? 'âœ“' : ''}</div>
                            <span className="text-xs font-semibold" style={{ color: dm ? '#8888a8' : '#6b7280' }}>{typeName}</span>
                          </div>
                          <div className="ml-5 space-y-0.5">
                            {typeRes.map(r => (
                              <label key={r.id} className="flex items-center gap-2 py-0.5 cursor-pointer hover:bg-black/5 rounded px-1 -mx-1" onClick={() => toggleRes(r.id)}>
                                <div className={`w-3.5 h-3.5 rounded border-2 flex items-center justify-center text-[8px] flex-shrink-0 ${pm.resourceIds.includes(r.id) ? 'bg-teal-600 border-teal-600 text-white' : dm ? 'border-gray-600' : 'border-gray-300'}`}>{pm.resourceIds.includes(r.id) ? 'âœ“' : ''}</div>
                                <span className="text-sm">{r.name}</span>
                                <span className="text-[10px] ml-auto px-1.5 rounded" style={{ color: dm ? '#666' : '#9ca3af', backgroundColor: dm ? '#333' : '#f3f4f6' }}>{r.code}</span>
                              </label>
                            ))}
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
                <div className="p-4 border-t flex items-center gap-2" style={{ borderColor: dm ? '#3a3a4e' : '#e5e7eb' }}>
                  {pm.id && <button onClick={deletePreset} className="px-3 py-1.5 rounded-lg text-sm text-red-500 hover:bg-red-50 font-medium">LÃ¶schen</button>}
                  <div className="flex-1" />
                  <button onClick={() => setWlPresetModal(null)} className={`px-4 py-1.5 rounded-lg text-sm font-medium ${dm ? 'text-gray-400 hover:bg-[#353550]' : 'text-gray-500 hover:bg-gray-100'}`}>Abbrechen</button>
                  <button onClick={savePreset} disabled={!pm.name.trim() || (pm.userIds.length === 0 && pm.resourceIds.length === 0)} className={`px-4 py-1.5 rounded-lg text-sm font-medium text-white ${!pm.name.trim() || (pm.userIds.length === 0 && pm.resourceIds.length === 0) ? 'bg-gray-300 cursor-not-allowed' : 'bg-teal-600 hover:bg-teal-700'}`}>{pm.id ? 'Speichern' : 'Erstellen'}</button>
                </div>
              </div>
            </div>
            );
          })()}
          
          {contextMenu && <div className="fixed dm-card bg-white rounded-lg shadow-xl border py-1 z-50 min-w-48" style={{ left: contextMenu.x, top: contextMenu.y }}>
            {contextMenu.type === 'project' && <React.Fragment>
              <div className="px-3 py-1 text-xs text-gray-500 border-b">{contextMenu.project.name}</div>
              <button onClick={() => { addWorkPackage(contextMenu.project.id); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-indigo-50 flex items-center gap-2"><Plus className="w-4 h-4 text-indigo-600" /> Neues Arbeitspaket</button>
              <div className="border-t my-1" />
              <button onClick={() => { setEditingProjectId(contextMenu.project.id); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-indigo-50 flex items-center gap-2"><span className="w-4 h-4 text-center">âœï¸</span> Umbenennen</button>
              <button onClick={() => { copyProject(contextMenu.project.id); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-indigo-50 flex items-center gap-2"><Copy className="w-4 h-4 text-blue-600" /> Kopieren</button>
              <button onClick={() => { saveProjects((projects || []).map(p => p.id === contextMenu.project.id ? { ...p, archived: true } : p)); if (selectedProjectId === contextMenu.project.id) setSelectedProjectId(null); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-amber-50 text-amber-700 flex items-center gap-2"><span className="w-4 h-4 text-center">ðŸ“¦</span> Archivieren</button>
              <button onClick={() => { if (confirm(`Projekt "${contextMenu.project.name}" und alle zugehÃ¶rigen Arbeitspakete unwiderruflich lÃ¶schen?`)) { const projId = contextMenu.project.id; saveProjects((projects || []).filter(p => p.id !== projId)); saveWorkPackages((workPackages || []).filter(wp => wp.projectId !== projId)); saveDependencies((dependencies || []).filter(d => { const fromWP = (workPackages || []).find(w => w.id === d.fromId); const toWP = (workPackages || []).find(w => w.id === d.toId); return fromWP?.projectId !== projId && toWP?.projectId !== projId; })); if (selectedProjectId === projId) setSelectedProjectId(null); } setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-red-50 text-red-600 flex items-center gap-2"><Trash2 className="w-4 h-4" /> LÃ¶schen</button>
            </React.Fragment>}
            {contextMenu.type === 'sidebar-project' && <React.Fragment>
              <div className="px-3 py-1 text-xs text-gray-500 border-b">{contextMenu.project.name}</div>
              <button onClick={() => { setEditingProjectId(contextMenu.project.id); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-indigo-50 flex items-center gap-2"><span className="w-4 h-4 text-center">âœï¸</span> Umbenennen</button>
              <button onClick={() => { copyProject(contextMenu.project.id); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-indigo-50 flex items-center gap-2"><Copy className="w-4 h-4 text-blue-600" /> Kopieren</button>
              <button onClick={() => { saveProjects((projects || []).map(p => p.id === contextMenu.project.id ? { ...p, archived: true } : p)); if (selectedProjectId === contextMenu.project.id) setSelectedProjectId(null); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-amber-50 text-amber-700 flex items-center gap-2"><span className="w-4 h-4 text-center">ðŸ“¦</span> Archivieren</button>
              <div className="border-t my-1" />
              <button onClick={() => { if (confirm(`Projekt "${contextMenu.project.name}" und alle zugehÃ¶rigen Arbeitspakete unwiderruflich lÃ¶schen?`)) { const projId = contextMenu.project.id; saveProjects((projects || []).filter(p => p.id !== projId)); saveWorkPackages((workPackages || []).filter(wp => wp.projectId !== projId)); saveDependencies((dependencies || []).filter(d => { const fromWP = (workPackages || []).find(w => w.id === d.fromId); const toWP = (workPackages || []).find(w => w.id === d.toId); return fromWP?.projectId !== projId && toWP?.projectId !== projId; })); if (selectedProjectId === projId) setSelectedProjectId(null); } setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-red-50 text-red-600 flex items-center gap-2"><Trash2 className="w-4 h-4" /> LÃ¶schen</button>
            </React.Fragment>}
            {contextMenu.type === 'archived-project' && <React.Fragment>
              <div className="px-3 py-1 text-xs text-gray-500 border-b">ðŸ“¦ {contextMenu.project.name}</div>
              <button onClick={() => { saveProjects((projects || []).map(p => p.id === contextMenu.project.id ? { ...p, archived: false } : p)); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-green-50 text-green-700 flex items-center gap-2"><span className="w-4 h-4 text-center">â†©ï¸</span> Wiederherstellen</button>
              <div className="border-t my-1" />
              <button onClick={() => { if (confirm(`Projekt "${contextMenu.project.name}" und alle zugehÃ¶rigen Arbeitspakete unwiderruflich lÃ¶schen?`)) { const projId = contextMenu.project.id; saveProjects((projects || []).filter(p => p.id !== projId)); saveWorkPackages((workPackages || []).filter(wp => wp.projectId !== projId)); saveDependencies((dependencies || []).filter(d => { const fromWP = (workPackages || []).find(w => w.id === d.fromId); const toWP = (workPackages || []).find(w => w.id === d.toId); return fromWP?.projectId !== projId && toWP?.projectId !== projId; })); } setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-red-50 text-red-600 flex items-center gap-2"><Trash2 className="w-4 h-4" /> EndgÃ¼ltig lÃ¶schen</button>
            </React.Fragment>}
            {contextMenu.type === 'wp' && <React.Fragment><div className="px-3 py-1 text-xs text-gray-500 border-b truncate max-w-48">{contextMenu.wp.name}</div><button onClick={() => { setEditingName(contextMenu.wp.id); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-indigo-50 flex items-center gap-2"><span className="w-4 h-4 flex items-center justify-center text-gray-500">âœï¸</span> Umbenennen</button><button onClick={() => { addWorkPackage(contextMenu.wp.projectId, contextMenu.wp.id); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-indigo-50 flex items-center gap-2"><Plus className="w-4 h-4 text-green-600" /> Tochter-Arbeitspaket</button><button onClick={() => { addWorkPackageBelow(contextMenu.wp.id); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-indigo-50 flex items-center gap-2"><Plus className="w-4 h-4 text-indigo-600" /> Arbeitspaket darunter</button><button onClick={() => { copyWorkPackage(contextMenu.wp.id); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-indigo-50 flex items-center gap-2"><Copy className="w-4 h-4 text-blue-600" /> Kopieren</button><button onClick={() => { indentWorkPackage(contextMenu.wp.id); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-indigo-50 flex items-center gap-2"><ChevronRight className="w-4 h-4" /> EinrÃ¼cken</button><button onClick={() => { outdentWorkPackage(contextMenu.wp.id); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-indigo-50 flex items-center gap-2"><ChevronLeft className="w-4 h-4" /> AusrÃ¼cken</button><button onClick={() => { const wp = contextMenu.wp; const updated = workPackages.map(w => w.id === wp.id ? { ...w, isMilestone: !w.isMilestone, endDate: !w.isMilestone ? w.startDate : w.endDate } : w); saveWorkPackages(updated); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-indigo-50 flex items-center gap-2"><span className="w-4 h-4 flex items-center justify-center text-amber-600">â—†</span> {contextMenu.wp.isMilestone ? 'Zu Arbeitspaket' : 'Zu Meilenstein'}</button><div className="border-t my-1" /><button onClick={() => { showWPResourcePlanning(contextMenu.wp.id); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-indigo-50 flex items-center gap-2"><span className="w-4 h-4 flex items-center justify-center text-orange-600">ðŸ“Š</span> Ressourcen-Feinplanung</button><div className="border-t my-1" /><button onClick={() => { deleteWorkPackage(contextMenu.wp.id); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-red-50 text-red-600 flex items-center gap-2"><Trash2 className="w-4 h-4" /> LÃ¶schen</button></React.Fragment>}
            {contextMenu.type === 'gantt-wp' && <React.Fragment>
              <div className="px-3 py-1 text-xs text-gray-500 border-b truncate max-w-48">{contextMenu.wp.name}</div>
              <div className="px-3 py-2 text-xs text-gray-600">Farbe wÃ¤hlen:</div>
              <div className="px-3 pb-2 flex flex-wrap gap-1">
                {wpColors.map(color => <button key={color} onClick={() => { updateWorkPackage(contextMenu.wp.id, 'color', color); setContextMenu(null); }} className={`w-6 h-6 rounded border-2 ${contextMenu.wp.color === color ? 'border-gray-800' : 'border-transparent'} hover:scale-110 transition-transform`} style={{ backgroundColor: color }} />)}
                <button onClick={() => { updateWorkPackage(contextMenu.wp.id, 'color', null); setContextMenu(null); }} className="w-6 h-6 rounded border-2 border-gray-300 hover:scale-110 transition-transform text-xs text-gray-400">X</button>
              </div>
              <div className="border-t my-1" />
              <button onClick={() => { addWorkPackage(contextMenu.wp.projectId, contextMenu.wp.id); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-indigo-50 flex items-center gap-2"><Plus className="w-4 h-4 text-green-600" /> Tochter-Arbeitspaket</button>
              <button onClick={() => { addWorkPackageBelow(contextMenu.wp.id); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-indigo-50 flex items-center gap-2"><Plus className="w-4 h-4 text-indigo-600" /> Arbeitspaket darunter</button>
              <button onClick={() => { copyWorkPackage(contextMenu.wp.id); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-indigo-50 flex items-center gap-2"><Copy className="w-4 h-4 text-blue-600" /> Kopieren</button>
              <button onClick={() => { updateWorkPackage(contextMenu.wp.id, 'allowWeekend', !contextMenu.wp.allowWeekend); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-indigo-50 flex items-center gap-2">
                {contextMenu.wp.allowWeekend ? <span className="w-4 h-4 text-center">âœ…</span> : <span className="w-4 h-4 text-center text-gray-300">â˜</span>}
                ðŸ—“ï¸ Wochenend/Feiertagsarbeit
              </button>
              <button onClick={() => { updateWorkPackage(contextMenu.wp.id, 'locked', !contextMenu.wp.locked); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-indigo-50 flex items-center gap-2">
                {contextMenu.wp.locked ? <span className="w-4 h-4 text-center">âœ…</span> : <span className="w-4 h-4 text-center text-gray-300">â˜</span>}
                ðŸ”’ Termin fixiert
              </button>
              <button onClick={() => { const wp = contextMenu.wp; const updated = workPackages.map(w => w.id === wp.id ? { ...w, isMilestone: !w.isMilestone, endDate: !w.isMilestone ? w.startDate : w.endDate } : w); saveWorkPackages(updated); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-indigo-50 flex items-center gap-2"><span className="w-4 h-4 flex items-center justify-center text-amber-600">â—†</span> {contextMenu.wp.isMilestone ? 'Zu Arbeitspaket' : 'Zu Meilenstein'}</button>
              <button onClick={() => { setEditingName(contextMenu.wp.id); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-indigo-50 flex items-center gap-2"><span className="w-4 h-4 flex items-center justify-center text-gray-500">âœï¸</span> Umbenennen</button><button onClick={() => { setSelectedWPs([]); setSidebarWPId(contextMenu.wp.id); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-indigo-50 flex items-center gap-2"><Settings className="w-4 h-4" /> Details bearbeiten</button>
              <button onClick={() => { showWPResourcePlanning(contextMenu.wp.id); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-indigo-50 flex items-center gap-2"><span className="w-4 h-4 flex items-center justify-center text-orange-600">ðŸ“Š</span> Ressourcen-Feinplanung</button>
              <div className="border-t my-1" />
              <button onClick={() => { deleteWorkPackage(contextMenu.wp.id); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-red-50 text-red-600 flex items-center gap-2"><Trash2 className="w-4 h-4" /> LÃ¶schen</button>
            </React.Fragment>}
            {contextMenu.type === 'gantt-bg' && <React.Fragment>
              <div className="px-3 py-1 text-xs text-gray-500 border-b">
                {new Date(contextMenu.date + 'T12:00:00').toLocaleDateString('de-DE', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' })}
              </div>
              <button onClick={() => { addWorkPackage(contextMenu.project.id, null, contextMenu.date); setContextMenu(null); }} className="w-full px-3 py-2 text-left text-sm hover:bg-indigo-50 flex items-center gap-2">
                <Plus className="w-4 h-4 text-green-600" /> Neues Arbeitspaket
              </button>
              <div className="border-t my-1" />
              <div className="px-3 py-1 text-xs text-gray-500">Tag hervorheben:</div>
              <div className="px-3 pb-2 flex flex-wrap gap-1">
                {['#fbbf24', '#34d399', '#60a5fa', '#f87171', '#c084fc', '#fb923c'].map(color => (
                  <button 
                    key={color} 
                    onClick={() => { 
                      saveHighlightedDays({ ...highlightedDays, [contextMenu.date]: color }); 
                      setContextMenu(null); 
                    }} 
                    className={`w-6 h-6 rounded border-2 ${highlightedDays[contextMenu.date] === color ? 'border-gray-800' : 'border-transparent'} hover:scale-110 transition-transform`} 
                    style={{ backgroundColor: color }} 
                  />
                ))}
                {highlightedDays[contextMenu.date] && (
                  <button 
                    onClick={() => { 
                      const next = {...highlightedDays}; delete next[contextMenu.date]; saveHighlightedDays(next); 
                      setContextMenu(null); 
                    }} 
                    className="w-6 h-6 rounded border-2 border-gray-300 hover:scale-110 transition-transform text-xs text-gray-400"
                  >âœ•</button>
                )}
              </div>
            </React.Fragment>}
          </div>}
          
          {/* KontextmenÃ¼ fÃ¼r Tage (Feiertage/freie Tage) */}
          {dayContextMenu && (
            <div className="fixed dm-card bg-white rounded-lg shadow-xl border py-2 z-50 min-w-56" style={{ left: dayContextMenu.x, top: dayContextMenu.y }}>
              <div className="px-3 py-1 text-xs text-gray-500 border-b mb-1">
                {new Date(dayContextMenu.date).toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
              </div>
              {holidays[dayContextMenu.date] ? (
                <React.Fragment>
                  <div className="px-3 py-1.5 text-sm">
                    <div className="font-medium text-red-600">{holidays[dayContextMenu.date].name}</div>
                    <div className="text-xs text-gray-500">
                      {holidays[dayContextMenu.date].type === 'feiertag' ? 'ðŸŽ‰ Feiertag' : 
                       holidays[dayContextMenu.date].type === 'urlaub' ? 'ðŸ–ï¸ Urlaub' : 
                       holidays[dayContextMenu.date].type === 'betriebsferien' ? 'ðŸ¢ Betriebsferien' : 'ðŸ“… Frei'}
                    </div>
                  </div>
                  <div className="border-t my-1" />
                  <button 
                    onClick={() => { setEditingHoliday({ date: dayContextMenu.date, ...holidays[dayContextMenu.date] }); setDayContextMenu(null); }}
                    className="w-full px-3 py-1.5 text-left text-sm hover:bg-gray-50 flex items-center gap-2"
                  >
                    <span>âœï¸</span> Bearbeiten
                  </button>
                  <button 
                    onClick={() => { const h = { ...holidays }; delete h[dayContextMenu.date]; saveHolidays(h); setDayContextMenu(null); }}
                    className="w-full px-3 py-1.5 text-left text-sm hover:bg-red-50 text-red-600 flex items-center gap-2"
                  >
                    <Trash2 className="w-4 h-4" /> Entfernen
                  </button>
                </React.Fragment>
              ) : (
                <React.Fragment>
                  <div className="px-3 pb-1 text-xs text-gray-400">Als frei markieren:</div>
                  <button 
                    onClick={() => { setEditingHoliday({ date: dayContextMenu.date, type: 'feiertag', name: '' }); setDayContextMenu(null); }}
                    className="w-full px-3 py-1.5 text-left text-sm hover:bg-gray-50 flex items-center gap-2"
                  >
                    <span>ðŸŽ‰</span> Feiertag
                  </button>
                  <button 
                    onClick={() => { setEditingHoliday({ date: dayContextMenu.date, type: 'urlaub', name: '' }); setDayContextMenu(null); }}
                    className="w-full px-3 py-1.5 text-left text-sm hover:bg-gray-50 flex items-center gap-2"
                  >
                    <span>ðŸ–ï¸</span> Urlaub
                  </button>
                  <button 
                    onClick={() => { setEditingHoliday({ date: dayContextMenu.date, type: 'betriebsferien', name: '' }); setDayContextMenu(null); }}
                    className="w-full px-3 py-1.5 text-left text-sm hover:bg-gray-50 flex items-center gap-2"
                  >
                    <span>ðŸ¢</span> Betriebsferien
                  </button>
                  <button 
                    onClick={() => { setEditingHoliday({ date: dayContextMenu.date, type: 'frei', name: '' }); setDayContextMenu(null); }}
                    className="w-full px-3 py-1.5 text-left text-sm hover:bg-gray-50 flex items-center gap-2"
                  >
                    <span>ðŸ“…</span> Sonstiger freier Tag
                  </button>
                </React.Fragment>
              )}
            </div>
          )}
          
          {/* Workload-KontextmenÃ¼ */}
          {workloadContextMenu && (
            <div className="fixed dm-card bg-white rounded-lg shadow-xl border py-1 z-50 min-w-52" style={{ left: workloadContextMenu.x, top: workloadContextMenu.y }} onClick={(e) => e.stopPropagation()}>
              <div className="px-3 py-1.5 text-xs text-gray-500 border-b truncate">
                <span className="font-medium text-gray-700">{workloadContextMenu.projectName}</span>
                <span className="mx-1 text-gray-400">â€º</span>
                <span>{workloadContextMenu.wpName}</span>
                {workloadContextMenu.resName && <span className="ml-1 text-gray-400">({workloadContextMenu.resName})</span>}
              </div>
              {workloadContextMenu.userId && <button 
                onClick={() => { resetDailyOverrides(workloadContextMenu.wpId, workloadContextMenu.userId); setWorkloadContextMenu(null); }}
                className="w-full px-3 py-2 text-left text-sm hover:bg-indigo-50 flex items-center gap-2"
              >
                <span>âš–ï¸</span> GleichmÃ¤ÃŸige Verteilung
              </button>}
              {workloadContextMenu.resId && <button 
                onClick={() => { 
                  const wp = workPackages.find(w => w.id === workloadContextMenu.wpId);
                  if (!wp) { setWorkloadContextMenu(null); return; }
                  const newOverrides = { ...(wp.resourceDailyOverrides || {}) };
                  delete newOverrides[workloadContextMenu.resId];
                  updateWorkPackage(wp.id, 'resourceDailyOverrides', Object.keys(newOverrides).length > 0 ? newOverrides : undefined);
                  setWorkloadContextMenu(null); 
                }}
                className="w-full px-3 py-2 text-left text-sm hover:bg-indigo-50 flex items-center gap-2"
              >
                <span>âš–ï¸</span> Alle Tage aktivieren
              </button>}
              <button 
                onClick={() => { scrollToWPInGantt(workloadContextMenu.wpId); setWorkloadContextMenu(null); }}
                className="w-full px-3 py-2 text-left text-sm hover:bg-blue-50 flex items-center gap-2"
              >
                <span>ðŸ”</span> Im Gantt-Diagramm anzeigen
              </button>
              <button 
                onClick={() => { updateWorkPackage(workloadContextMenu.wpId, 'locked', !workloadContextMenu.locked); setWorkloadContextMenu(null); }}
                className="w-full px-3 py-2 text-left text-sm hover:bg-indigo-50 flex items-center gap-2"
              >
                {workloadContextMenu.locked ? <span>ðŸ”“</span> : <span>ðŸ”’</span>}
                {workloadContextMenu.locked ? 'Termin freigeben' : 'Termin fixieren'}
              </button>
              <button 
                onClick={() => { openSidebar(workloadContextMenu.wpId); setWorkloadContextMenu(null); }}
                className="w-full px-3 py-2 text-left text-sm hover:bg-gray-50 flex items-center gap-2"
              >
                <span>ðŸ“‹</span> Details Ã¶ffnen
              </button>
              {workloadContextMenu.resId && <button 
                onClick={() => { 
                  const wp = workPackages.find(w => w.id === workloadContextMenu.wpId);
                  if (wp) {
                    const newResIds = (wp.resourceIds || []).filter(id => id !== workloadContextMenu.resId);
                    updateWorkPackage(wp.id, 'resourceIds', newResIds.length > 0 ? newResIds : undefined);
                  }
                  setWorkloadContextMenu(null); 
                }}
                className="w-full px-3 py-2 text-left text-sm hover:bg-red-50 text-red-600 flex items-center gap-2"
              >
                <span>ðŸ—‘ï¸</span> Ressource entfernen
              </button>}
            </div>
          )}
          
          {/* Vacation-Typ-Picker */}
          {vacationTypePicker && (
            <div className="fixed dm-card bg-white rounded-lg shadow-xl border py-1 z-50 min-w-44" style={{ left: vacationTypePicker.x, top: vacationTypePicker.y }} onClick={(e) => e.stopPropagation()}>
              <div className="px-3 py-1.5 text-xs text-gray-500 border-b">
                {vacationTypePicker.dates.length} Tag{vacationTypePicker.dates.length > 1 ? 'e' : ''} markiert
              </div>
              <button 
                onClick={() => { setVacationBatch(vacationTypePicker.userId, vacationTypePicker.dates, 'add', 'urlaub'); setVacationTypePicker(null); }}
                className="w-full px-3 py-2 text-left text-sm hover:bg-orange-50 flex items-center gap-2"
              >
                <span>ðŸ–ï¸</span> Urlaub
              </button>
              <button 
                onClick={() => { setVacationBatch(vacationTypePicker.userId, vacationTypePicker.dates, 'add', 'krank'); setVacationTypePicker(null); }}
                className="w-full px-3 py-2 text-left text-sm hover:bg-rose-50 flex items-center gap-2"
              >
                <span>ðŸ¤’</span> Krank
              </button>
              <button 
                onClick={() => { setVacationBatch(vacationTypePicker.userId, vacationTypePicker.dates, 'add', 'sonstige'); setVacationTypePicker(null); }}
                className="w-full px-3 py-2 text-left text-sm hover:bg-gray-50 flex items-center gap-2"
              >
                <span>ðŸ“…</span> Sonstiges
              </button>
              {vacationTypePicker.hasExisting && (
                <React.Fragment>
                  <div className="border-t my-1" />
                  <button 
                    onClick={() => { setVacationBatch(vacationTypePicker.userId, vacationTypePicker.dates, 'remove'); setVacationTypePicker(null); }}
                    className="w-full px-3 py-2 text-left text-sm hover:bg-red-50 text-red-600 flex items-center gap-2"
                  >
                    <span>âœ•</span> Entfernen
                  </button>
                </React.Fragment>
              )}
            </div>
          )}
          
          {/* Resource Downtime Typ-Picker */}
          {resDownTypePicker && (
            <div className="fixed dm-card bg-white rounded-lg shadow-xl border py-1 z-50 min-w-44" style={{ left: resDownTypePicker.x, top: resDownTypePicker.y }} onClick={(e) => e.stopPropagation()}>
              <div className="px-3 py-1.5 text-xs text-gray-500 border-b">
                {resDownTypePicker.dates.length} Tag{resDownTypePicker.dates.length > 1 ? 'e' : ''} markiert
              </div>
              <button 
                onClick={() => { setResourceDownBatch(resDownTypePicker.resId, resDownTypePicker.dates, 'add', 'ausfall'); setResDownTypePicker(null); }}
                className="w-full px-3 py-2 text-left text-sm hover:bg-red-50 flex items-center gap-2"
              >
                <span>â›”</span> Ausfall
              </button>
              <button 
                onClick={() => { setResourceDownBatch(resDownTypePicker.resId, resDownTypePicker.dates, 'add', 'wartung'); setResDownTypePicker(null); }}
                className="w-full px-3 py-2 text-left text-sm hover:bg-amber-50 flex items-center gap-2"
              >
                <span>ðŸ”§</span> Wartung / Instandhaltung
              </button>
              <button 
                onClick={() => { setResourceDownBatch(resDownTypePicker.resId, resDownTypePicker.dates, 'add', 'sonstiges'); setResDownTypePicker(null); }}
                className="w-full px-3 py-2 text-left text-sm hover:bg-gray-50 flex items-center gap-2"
              >
                <span>ðŸ“…</span> Sonstiges
              </button>
              {resDownTypePicker.hasExisting && (
                <React.Fragment>
                  <div className="border-t my-1" />
                  <button 
                    onClick={() => { setResourceDownBatch(resDownTypePicker.resId, resDownTypePicker.dates, 'remove'); setResDownTypePicker(null); }}
                    className="w-full px-3 py-2 text-left text-sm hover:bg-red-50 text-red-600 flex items-center gap-2"
                  >
                    <span>âœ•</span> Entfernen
                  </button>
                </React.Fragment>
              )}
            </div>
          )}
          
          {/* Dialog zum Bearbeiten/Erstellen eines freien Tages */}
          {editingHoliday && (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setEditingHoliday(null)}>
              <div className="dm-modal bg-white rounded-xl shadow-2xl p-6 w-96" onClick={(e) => e.stopPropagation()}>
                <h3 className="text-lg font-bold mb-4">
                  {editingHoliday.type === 'feiertag' ? 'ðŸŽ‰ Feiertag' : 
                   editingHoliday.type === 'urlaub' ? 'ðŸ–ï¸ Urlaub' : 
                   editingHoliday.type === 'betriebsferien' ? 'ðŸ¢ Betriebsferien' : 'ðŸ“… Freier Tag'}
                </h3>
                <div className="text-sm text-gray-500 mb-4">
                  {new Date(editingHoliday.date).toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
                </div>
                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700 mb-1">Bezeichnung</label>
                  <input 
                    type="text"
                    autoFocus
                    value={editingHoliday.name}
                    onChange={(e) => setEditingHoliday({ ...editingHoliday, name: e.target.value })}
                    placeholder={editingHoliday.type === 'feiertag' ? 'z.B. Rosenmontag' : editingHoliday.type === 'urlaub' ? 'z.B. Teamurlaub' : 'Bezeichnung eingeben...'}
                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                  />
                </div>
                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700 mb-1">Typ</label>
                  <select 
                    value={editingHoliday.type}
                    onChange={(e) => setEditingHoliday({ ...editingHoliday, type: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                  >
                    <option value="feiertag">ðŸŽ‰ Feiertag</option>
                    <option value="urlaub">ðŸ–ï¸ Urlaub</option>
                    <option value="betriebsferien">ðŸ¢ Betriebsferien</option>
                    <option value="frei">ðŸ“… Sonstiger freier Tag</option>
                  </select>
                </div>
                <div className="flex justify-end gap-2">
                  <button 
                    onClick={() => setEditingHoliday(null)}
                    className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg"
                  >
                    Abbrechen
                  </button>
                  <button 
                    onClick={() => {
                      if (editingHoliday.name.trim()) {
                        saveHolidays({ ...holidays, [editingHoliday.date]: { type: editingHoliday.type, name: editingHoliday.name.trim() } });
                        setEditingHoliday(null);
                      }
                    }}
                    disabled={!editingHoliday.name.trim()}
                    className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                  >
                    Speichern
                  </button>
                </div>
              </div>
            </div>
          )}
          
          {/* ========== WORKLOAD PANEL ========== */}
          {(workloadPanelHeight > 0 || showResourceCockpit) && (
            <div className={`dm-wl-surface bg-white flex flex-col ${showResourceCockpit ? 'flex-1 min-h-0' : 'flex-shrink-0'}`} style={{ ...(showResourceCockpit ? {} : { height: workloadPanelHeight }), border: wlFocusWP ? `2px solid ${wlFocusWP.color}` : '2px solid #d4d4d4', borderRadius: wlFocusWP ? 6 : 0 }}>
              {/* Dynamic font scaling for workload panel */}
              <style dangerouslySetInnerHTML={{ __html: `
                .wl-content { font-size: ${wlFontSize}px !important; }
                .wl-content .wl-t-sm, .wl-content .wl-t-xs, .wl-content .wl-t-xxs, .wl-content .wl-t-tiny { font-size: ${wlFontSize}px !important; }
                .wl-content .wl-icon { font-size: ${Math.max(wlFontSize - 1, 8)}px !important; }
                .wl-content .wl-separator { height: 1px; background: #e0e0e0; border: none; flex-shrink: 0; }
                .dark .wl-content .wl-separator { background: #3a3a4e; }
                .wl-content .border-b:not(.wl-bar-cell) { border-bottom: 1px solid #e0e0e0 !important; }
                .wl-content .border-r:not(.wl-bar-cell) { border-right: 1px solid #e0e0e0 !important; }
                .dark .wl-content .border-b:not(.wl-bar-cell) { border-bottom: 1px solid #3a3a4e !important; }
                .dark .wl-content .border-r:not(.wl-bar-cell) { border-right: 1px solid #3a3a4e !important; }
                .wl-content .wl-bar-cell { border-bottom: 1px solid #e0e0e0; border-right: 1px solid #e0e0e0; }
                .dark .wl-content .wl-bar-cell { border-bottom: 1px solid #3a3a4e; border-right: 1px solid #3a3a4e; }
              `}} />
              {/* Karteikarte bei Feinplanung - OBEN */}
              {wlFocusWP && (workloadFilter === 'mitarbeiter' || workloadFilter === 'ma_ressourcen' || workloadFilter === 'ressourcen') && (() => {
                const focusWP = workPackages.find(w => w.id === wlFocusWP.wpId);
                const focusProject = focusWP ? projects.find(p => p.id === focusWP.projectId) : null;
                return (
                  <div className="flex items-center gap-3 px-4 py-1.5 flex-shrink-0" style={{ backgroundColor: wlFocusWP.color + '12', borderBottom: `2px solid ${wlFocusWP.color}40` }}>
                    <div className="w-4 h-4 rounded flex-shrink-0" style={{ backgroundColor: wlFocusWP.color }} />
                    <div className="flex flex-col min-w-0">
                      <span className="font-bold text-sm truncate" style={{ color: '#222' }}>ðŸ“Š {wlFocusWP.wpName}</span>
                      {focusProject && <span className="text-xs truncate" style={{ color: '#666' }}>{focusProject.name} â€“ Ressourcen-Feinplanung</span>}
                    </div>
                    <div className="flex items-center gap-1.5 ml-auto flex-shrink-0">
                      <button onClick={() => setWlFocusShowAll(false)} className={`text-xs px-2.5 py-1 rounded-md font-medium ${!wlFocusShowAll ? 'text-white' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`} style={!wlFocusShowAll ? { backgroundColor: wlFocusWP.color } : undefined} title="Nur dieses Arbeitspaket anzeigen">Fokus auf AP</button>
                      <button onClick={() => setWlFocusShowAll(true)} className={`text-xs px-2.5 py-1 rounded-md font-medium ${wlFocusShowAll ? 'text-white' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`} style={wlFocusShowAll ? { backgroundColor: wlFocusWP.color } : undefined} title="Alle Arbeitspakete der Mitarbeiter anzeigen">Alle APs zeigen</button>
                      <div className="w-px h-5 bg-gray-300 mx-1" />
                      <button onClick={() => setWlFocusWP(null)} className="px-2 py-1 rounded-md text-sm hover:bg-black/10 transition" style={{ color: '#555' }} title="Feinplanung verlassen">âœ•</button>
                    </div>
                  </div>
                );
              })()}
              {/* Resize Handle */}
              {!showResourceCockpit && (
              <div 
                className="h-1.5 cursor-ns-resize transition-colors flex-shrink-0 flex items-center justify-center bg-indigo-100 hover:bg-indigo-200"
                onMouseDown={(e) => {
                  e.preventDefault();
                  const startY = e.clientY;
                  const startH = workloadPanelHeight;
                  const onMove = (ev) => {
                    const diff = startY - ev.clientY;
                    setWorkloadPanelHeight(Math.max(80, Math.min(Math.round(window.innerHeight * 0.8), startH + diff)));
                  };
                  const onUp = () => { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); };
                  document.addEventListener('mousemove', onMove);
                  document.addEventListener('mouseup', onUp);
                }}
              >
                <div className="w-8 h-0.5 bg-indigo-400 rounded" />
              </div>
              )}
              {/* Header with filter tabs */}
              {(() => {
                const isCk = showResourceCockpit;
                const btnCls = isCk ? 'text-sm px-3 py-1.5 rounded-lg font-medium' : 'text-xs px-2.5 py-1 rounded-md font-medium';
                const ctrlBtn = isCk ? 'w-7 h-7 rounded-lg text-sm' : 'w-6 h-6 rounded-md text-xs';
                const lblCls = isCk ? 'text-xs text-gray-400' : 'text-[11px] text-gray-400';
                const valCls = isCk ? 'text-xs text-gray-500 w-8 text-center' : 'text-[11px] text-gray-500 w-8 text-center';
                const sepCls = isCk ? 'w-px h-6 bg-gray-200 mx-2' : 'w-px h-5 bg-gray-200 mx-1.5';
                return (
              <div className={`flex items-center justify-between bg-white border-b flex-shrink-0 ${isCk ? 'px-4 py-2 gap-2' : 'px-3 py-1.5 gap-1'}`}>
                <div className={`flex items-center ${isCk ? 'gap-2' : 'gap-1'}`}>
                  {[
                    { key: 'bereiche', label: 'Bereiche' },
                    { key: 'abteilungen', label: 'Abteilungen' },
                    { key: 'teams', label: 'Teams' },
                    { key: 'mitarbeiter', label: 'Mitarbeiter' },
                    { key: 'ressourcen', label: 'Ressourcen' },
                    { key: 'ma_ressourcen', label: 'MA + Ressourcen' },
                  ].map(f => (
                    <button key={f.key} onClick={() => { setWorkloadFilter(f.key); setWlActivePreset(null); if (f.key !== 'mitarbeiter' && f.key !== 'ma_ressourcen' && f.key !== 'ressourcen') setWlFocusWP(null); }} className={`${btnCls} ${workloadFilter === f.key && !wlActivePreset ? 'bg-indigo-600 text-white' : darkMode ? 'bg-[#2a2a3c] text-gray-400 hover:bg-[#353550]' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}>
                      {f.label}
                    </button>
                  ))}
                  <div className={sepCls} style={{ backgroundColor: darkMode ? '#4a4a5e' : '#d1d5db' }} />
                  <div className="relative">
                    <button onClick={() => setWlPresetDropdown(!wlPresetDropdown)} className={`${btnCls} flex items-center gap-1 ${wlActivePreset ? 'text-white' : darkMode ? 'bg-[#2a2a3c] text-gray-400 hover:bg-[#353550]' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`} style={wlActivePreset ? { backgroundColor: '#0d9488' } : {}} title="Filter-Presets">
                      <span style={{ display: 'inline-block', width: 0, height: 0, borderLeft: '5px solid transparent', borderRight: '5px solid transparent', borderTop: `7px solid ${wlActivePreset ? '#fff' : darkMode ? '#9ca3af' : '#6b7280'}` }} />
                      {wlActivePreset && wlCustomPresets.find(p => p.id === wlActivePreset) ? wlCustomPresets.find(p => p.id === wlActivePreset).name : ''}
                    </button>
                    {wlPresetDropdown && (
                      <React.Fragment>
                        <div className="fixed inset-0 z-30" onClick={() => setWlPresetDropdown(false)} />
                        <div className={`absolute left-0 top-full mt-1 z-40 rounded-lg shadow-xl border min-w-[200px] py-1 ${darkMode ? 'bg-[#2a2a3e] border-[#3a3a4e]' : 'bg-white border-gray-200'}`}>
                          {wlCustomPresets.length > 0 && wlCustomPresets.map(preset => (
                            <div key={preset.id} className={`flex items-center gap-2 px-3 py-2 cursor-pointer text-sm ${wlActivePreset === preset.id ? (darkMode ? 'bg-teal-900/40 text-teal-300' : 'bg-teal-50 text-teal-700') : darkMode ? 'text-gray-300 hover:bg-[#353550]' : 'text-gray-700 hover:bg-gray-50'}`}>
                              <span className="flex-1 truncate" onClick={() => { setWlActivePreset(wlActivePreset === preset.id ? null : preset.id); if (wlActivePreset !== preset.id) setWorkloadFilter('ma_ressourcen'); setWlPresetDropdown(false); }}>â˜… {preset.name}</span>
                              <span className="flex items-center gap-0.5 flex-shrink-0">
                                <button onClick={(e) => { e.stopPropagation(); setWlPresetModal({ ...preset, userIds: preset.userIds || [], resourceIds: preset.resourceIds || [] }); setWlPresetDropdown(false); }} className={`p-0.5 rounded ${darkMode ? 'hover:bg-[#4a4a5e]' : 'hover:bg-gray-200'}`} title="Bearbeiten">âœï¸</button>
                                <button onClick={(e) => { e.stopPropagation(); setWlCustomPresets(prev => prev.filter(p => p.id !== preset.id)); if (wlActivePreset === preset.id) setWlActivePreset(null); }} className={`p-0.5 rounded ${darkMode ? 'hover:bg-[#4a4a5e]' : 'hover:bg-gray-200'}`} title="LÃ¶schen">ðŸ—‘ï¸</button>
                              </span>
                            </div>
                          ))}
                          {wlCustomPresets.length > 0 && <div className="border-t my-1" style={{ borderColor: darkMode ? '#3a3a4e' : '#e5e7eb' }} />}
                          {wlActivePreset && (
                            <React.Fragment>
                              <button onClick={() => { setWlActivePreset(null); setWlPresetDropdown(false); }} className={`w-full text-left px-3 py-2 text-sm ${darkMode ? 'text-gray-400 hover:bg-[#353550]' : 'text-gray-500 hover:bg-gray-50'}`}>âœ• Filter zurÃ¼cksetzen</button>
                              <div className="border-t my-1" style={{ borderColor: darkMode ? '#3a3a4e' : '#e5e7eb' }} />
                            </React.Fragment>
                          )}
                          <button onClick={() => { setWlPresetModal({ id: null, name: '', userIds: [], resourceIds: [] }); setWlPresetDropdown(false); }} className={`w-full text-left px-3 py-2 text-sm font-medium ${darkMode ? 'text-teal-400 hover:bg-[#353550]' : 'text-teal-600 hover:bg-teal-50'}`}>+ Neues Preset erstellen</button>
                        </div>
                      </React.Fragment>
                    )}
                  </div>
                </div>
                <div className={`flex items-center ${isCk ? 'gap-2' : 'gap-1'}`}>
                  <span className={lblCls}>Breite</span>
                  <button onClick={() => setZoomLevel(Math.max(25, zoomLevel - 25))} className={`${ctrlBtn} bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold flex items-center justify-center`} title="Schmaler">âˆ’</button>
                  <span className={valCls}>{zoomLevel}%</span>
                  <button onClick={() => setZoomLevel(Math.min(250, zoomLevel + 25))} className={`${ctrlBtn} bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold flex items-center justify-center`} title="Breiter">+</button>
                  <div className={sepCls} />
                  <span className={lblCls}>HÃ¶he</span>
                  <button onClick={() => setWorkloadZoom(z => Math.max(50, z - 10))} className={`${ctrlBtn} bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold flex items-center justify-center`} title="Zeilen verkleinern">âˆ’</button>
                  <span className={valCls}>{workloadZoom}%</span>
                  <button onClick={() => setWorkloadZoom(z => Math.min(150, z + 10))} className={`${ctrlBtn} bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold flex items-center justify-center`} title="Zeilen vergrÃ¶ÃŸern">+</button>
                  <div className={sepCls} />
                  <span className={lblCls}>Aa</span>
                  <input type="range" min="8" max={isCk ? 36 : 24} value={wlFontSize} onChange={(e) => setWlFontSize(Number(e.target.value))} className={`${isCk ? 'w-24 h-4' : 'w-16 h-4'} accent-indigo-500`} title={`SchriftgrÃ¶ÃŸe: ${wlFontSize}px`} />
                  <span className={`${lblCls} w-5`}>{wlFontSize}</span>
                  <div className={sepCls} />
                  <span className={lblCls} title="Dezimalstellen">.</span>
                  {[0,1,2].map(d => (
                    <button key={d} onClick={() => setWlDecimals(d)} className={`${isCk ? 'w-7 h-7 rounded-lg text-xs' : 'w-5 h-5 rounded-md text-[10px]'} font-medium flex items-center justify-center ${wlDecimals === d ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`} title={`${d} Dezimalstellen`}>{d}</button>
                  ))}
                  <div className={sepCls} />
                  <div className="flex rounded overflow-hidden border" style={{ borderColor: darkMode ? '#4a4a5e' : '#d1d5db' }}>
                    <button onClick={() => { setWlBarMode('bar'); if (wlBarMode === 'indicator') { if (isCk) { setWorkloadZoom(90); setGanttZoomLevel(175); setWlFontSize(16); } else { setWorkloadZoom(90); } } }} className={`${isCk ? 'px-2.5 h-7 text-sm' : 'px-2 h-6 text-xs'} font-medium flex items-center ${wlBarMode === 'bar' ? 'bg-indigo-600 text-white' : darkMode ? 'bg-[#2a2a3c] text-gray-400 hover:bg-[#353550]' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}`} title="Balken">ðŸ“Š</button>
                    <button onClick={() => { setWlBarMode('number'); if (isCk) { setWorkloadZoom(90); setGanttZoomLevel(175); setWlFontSize(16); } else { setWorkloadZoom(80); } }} className={`${isCk ? 'px-2.5 h-7 text-sm' : 'px-2 h-6 text-xs'} font-medium flex items-center border-l border-r ${wlBarMode === 'number' ? 'bg-indigo-600 text-white' : darkMode ? 'bg-[#2a2a3c] text-gray-400 hover:bg-[#353550]' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}`} style={{ borderColor: darkMode ? '#4a4a5e' : '#d1d5db' }} title="Zahlen">ðŸ”¢</button>
                    <button onClick={() => { setWlBarMode('indicator'); if (isCk) { setWorkloadZoom(100); setGanttZoomLevel(175); setWlFontSize(16); } else { setWorkloadZoom(80); } }} className={`${isCk ? 'px-2.5 h-7 text-sm' : 'px-2 h-6 text-xs'} font-medium flex items-center ${wlBarMode === 'indicator' ? 'bg-emerald-600 text-white' : darkMode ? 'bg-[#2a2a3c] text-gray-400 hover:bg-[#353550]' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}`} title="Indikator">ðŸŸ¢</button>
                  </div>
                  {/* Detailgrad-Buttons */}
                  {(() => {
                    // Hierarchy: 1=Bereiche, 2=+Abteilungen, 3=+Teams, 4=+Mitarbeiter, 5=+APs
                    const labels = ['Bereiche', 'Abteilungen', 'Teams', 'Mitarbeiter', 'Arbeitspakete'];
                    const maxDetail = (workloadFilter === 'mitarbeiter' || workloadFilter === 'ma_ressourcen') ? 5 : workloadFilter === 'teams' ? 4 : workloadFilter === 'abteilungen' ? 3 : workloadFilter === 'bereiche' ? 2 : 0;
                    
                    // Detect current level
                    const getCurrentWlDetail = () => {
                      const anyUserExp = Object.values(workloadExpandedUsers).some(v => v);
                      if (anyUserExp) return 5;
                      const anyTeamExp = Object.keys(workloadExpandedGroups).some(k => k.startsWith('wl_team_') && workloadExpandedGroups[k] !== false);
                      if (anyTeamExp) return 4;
                      const anyDivExp = Object.keys(workloadExpandedGroups).some(k => k.startsWith('wl_') && !k.startsWith('wl_dept_') && !k.startsWith('wl_team_') && !k.startsWith('wl_orphan') && !k.startsWith('wl_res') && workloadExpandedGroups[k] !== false);
                      if (anyDivExp) return 3;
                      const anyDeptExp = Object.keys(workloadExpandedGroups).some(k => k.startsWith('wl_dept_') && workloadExpandedGroups[k] !== false);
                      if (anyDeptExp) return 2;
                      return 1;
                    };
                    
                    const setWlDetailLevel = (level) => {
                      const newGroups = { ...workloadExpandedGroups };
                      const newUsers = {};
                      departments.forEach(d => { newGroups['wl_dept_' + d.id] = level >= 2; });
                      divisions.forEach(d => { newGroups['wl_' + d.id] = level >= 3; });
                      teams.forEach(t => { newGroups['wl_team_' + t.id] = level >= 4; });
                      users.forEach(u => { newUsers[u.id] = level >= 5; });
                      newGroups['wl_orphan'] = level >= 2;
                      ['maschine', 'fahrzeug', 'werkzeug'].forEach(t => { 
                        newGroups['wl_res_' + t] = level >= 3;
                      });
                      newGroups['wl_res_header'] = level >= 2;
                      // Resource user expansion
                      resources.forEach(r => { newUsers['res_' + r.id] = level >= 5; });
                      setWorkloadExpandedGroups(newGroups);
                      setWorkloadExpandedUsers(newUsers);
                    };
                    
                    const currentDetail = getCurrentWlDetail();
                    if (maxDetail === 0) return null;
                    return (
                      <React.Fragment>
                        <div className={sepCls} />
                        <span className={`${lblCls} flex-shrink-0`}>Detailgrad</span>
                        {Array.from({ length: maxDetail }, (_, i) => i + 1).map(lvl => (
                          <button key={lvl} onClick={() => setWlDetailLevel(lvl)} className={`${isCk ? 'px-2 h-7 rounded-lg text-xs' : 'px-1.5 h-5 rounded-md text-[10px]'} font-medium flex items-center justify-center flex-shrink-0 ${currentDetail === lvl ? 'bg-indigo-600 text-white' : darkMode ? 'bg-[#2a2a3c] text-gray-400 hover:bg-[#353550]' : 'bg-gray-100 text-gray-500 hover:bg-gray-300'}`} title={labels[lvl - 1]}>{lvl}</button>
                        ))}
                      </React.Fragment>
                    );
                  })()}
                  <div className={sepCls} />
                  {!showResourceCockpit && <button onClick={() => setWorkloadPanelHeight(0)} className={`text-gray-400 hover:text-gray-600 ${isCk ? 'text-base' : 'text-sm'}`}>âœ•</button>}
                </div>
              </div>
              ); })()}
              {/* Content */}
              <div className="wl-content flex flex-1 overflow-hidden min-h-0">
                {/* Left: Names â€” SAME width as gantt left panel, no separate resize */}
                <div data-panel-list className={`flex-shrink-0 border-r bg-white ${showResourceCockpit ? '' : 'hide-scrollbar'}`} ref={workloadLeftRef} style={{ width: leftPanelWidth, overflowX: 'hidden', overflowY: 'auto' }} onScroll={(e) => { window._workloadScroll.top = e.target.scrollTop; if (workloadScrollRef.current && workloadScrollRef.current.scrollTop !== e.target.scrollTop) workloadScrollRef.current.scrollTop = e.target.scrollTop; }}>
                  {showResourceCockpit && (() => {
                    const _ap = wlActivePreset ? wlCustomPresets.find(p => p.id === wlActivePreset) : null;
                    const _pUserIds = _ap?.userIds ? new Set(_ap.userIds) : null;
                    const _pResIds = _ap?.resourceIds ? new Set(_ap.resourceIds) : null;
                    const _users = _pUserIds ? (users || []).filter(u => _pUserIds.has(u.id)) : (users || []);
                    const _res = _pResIds ? (resources || []).filter(r => _pResIds.has(r.id)) : (resources || []);
                    const machCount = _res.filter(r => r.type === 'maschine').length;
                    const fahrzCount = _res.filter(r => r.type === 'fahrzeug').length;
                    const werkzCount = _res.filter(r => r.type === 'werkzeug').length;
                    const fsMon = Math.round(wlFontSize * 1.3);
                    const fsKW = wlFontSize;
                    const fsDay = Math.max(7, wlFontSize - 2);
                    const padMon = `${Math.max(1, Math.round(wlFontSize * 0.15))}px 8px`;
                    const padKW = `${Math.max(1, Math.round(wlFontSize * 0.1))}px 8px`;
                    const bc = darkMode ? '#3a3a4e' : '#e0e0e0';
                    return (
                    <div className="sticky top-0 z-20 flex flex-col" style={{ backgroundColor: darkMode ? '#252536' : '#f1f5f9', boxShadow: '0 2px 4px rgba(0,0,0,0.1)' }}>
                      {/* Row 1 = Month row */}
                      <div className="px-3 font-bold truncate" style={{ fontSize: fsMon, padding: padMon, borderBottom: `1px solid ${bc}`, borderRight: `1px solid ${bc}`, backgroundColor: darkMode ? '#252536' : '#f1f5f9', color: darkMode ? '#e0e0f0' : '#1e293b' }}>{_ap ? `â˜… ${_ap.name}` : `${_users.length} Mitarbeiter`}</div>
                      {/* Row 2 = KW row */}
                      <div className="px-3 flex items-center gap-2 truncate" style={{ fontSize: fsKW, padding: padKW, borderBottom: `1px solid ${bc}`, borderRight: `1px solid ${bc}`, backgroundColor: darkMode ? '#2a2a3e' : '#eef2ff', color: darkMode ? '#9090b0' : '#64748b' }}>
                        {_ap && <span>ðŸ‘¤ {_users.length}</span>}
                        {machCount > 0 && <span>ðŸ­ {machCount}</span>}
                        {fahrzCount > 0 && <span>ðŸš› {fahrzCount}</span>}
                        {werkzCount > 0 && <span>ðŸ”§ {werkzCount}</span>}
                      </div>
                      {/* Row 3 = Date row */}
                      <div className="px-3" style={{ fontSize: fsDay, borderBottom: `1px solid ${bc}`, borderRight: `1px solid ${bc}`, backgroundColor: darkMode ? '#2a2a3e' : '#f9fafb', color: darkMode ? '#8888a8' : '#6b7280' }}>&nbsp;</div>
                      {/* Row 4 = Weekday row */}
                      <div className="px-3" style={{ fontSize: fsDay, borderBottom: `1px solid ${bc}`, borderRight: `1px solid ${bc}`, backgroundColor: darkMode ? '#2a2a3e' : '#f9fafb', color: darkMode ? '#8888a8' : '#6b7280' }}>&nbsp;</div>
                    </div>
                    );
                  })()}
                  {(() => {
                    const rows = [];
                    const WLR = Math.round(ROW_HEIGHT * workloadZoom / 100);
                    const WLR_SUM = wlBarMode === 'bar' ? Math.round(WLR * 1.4) : WLR;
                    const WLR_WP = Math.round(WLR * 0.8);
                    const WLR_GRP = WLR_SUM;
                    const wlFmt = (v) => { const s = v.toFixed(wlDecimals); return wlDecimals === 0 ? s : s.replace(/\.?0+$/, '') || '0'; };
                    
                    const dm = darkMode;
                    const dBg = (light, dark) => dm ? dark : light;
                    const grpBorder = dm ? '#3a3a4e' : '#e0e0e0';
                    // Preset filter: wenn aktiv, nur ausgewÃ¤hlte MA/Ressourcen zeigen
                    const activePresetObj = wlActivePreset ? wlCustomPresets.find(p => p.id === wlActivePreset) : null;
                    const presetUserIds = activePresetObj?.userIds ? new Set(activePresetObj.userIds) : null;
                    const presetResIds = activePresetObj?.resourceIds ? new Set(activePresetObj.resourceIds) : null;
                    const pUsers = presetUserIds ? (users || []).filter(u => presetUserIds.has(u.id)) : (users || []);
                    const pResources = presetResIds ? (resources || []).filter(r => presetResIds.has(r.id)) : (resources || []);
                    // Shared helpers for all workload views
                    const TreeLines = ({ level, isLast, parentLines }) => (
                        <div className="flex items-center h-full flex-shrink-0" style={{ width: level * 16 }}>
                          {Array.from({ length: level }).map((_, lvl) => {
                            const isConnector = lvl === level - 1;
                            const showContinuation = parentLines[lvl];
                            return (
                              <div key={lvl} className="relative h-full flex-shrink-0" style={{ width: 16 }}>
                                {isConnector ? (
                                  <React.Fragment>
                                    <div className="absolute left-2 top-0" style={{ width: 1, height: isLast ? '50%' : '100%', backgroundColor: '#cccccc' }} />
                                    <div className="absolute left-2 top-1/2" style={{ width: 8, height: 1, backgroundColor: '#cccccc' }} />
                                  </React.Fragment>
                                ) : (
                                  showContinuation && <div className="absolute left-2 top-0 bottom-0" style={{ width: 1, backgroundColor: '#cccccc' }} />
                                )}
                              </div>
                            );
                          })}
                        </div>
                      );
                    const toggleGroup = (key) => { const sL = workloadLeftRef.current?.scrollTop; const sR = workloadScrollRef.current?.scrollTop; setWorkloadExpandedGroups(prev => ({...prev, [key]: prev[key] === false ? true : (prev[key] === undefined ? false : !prev[key])})); requestAnimationFrame(() => { if (workloadLeftRef.current && sL !== undefined) workloadLeftRef.current.scrollTop = sL; if (workloadScrollRef.current && sR !== undefined) workloadScrollRef.current.scrollTop = sR; }); };
                    const isGroupExp = (key) => workloadExpandedGroups[key] !== false;
                    
                    if (workloadFilter === 'bereiche') {
                      departments.sort((a,b) => a.name.localeCompare(b.name)).forEach(dept => {
                        const deptDivs = divisions.filter(d => d.departmentId === dept.id);
                        const deptTeams = teams.filter(t => deptDivs.some(d => d.id === t.divisionId));
                        const deptUsers = pUsers.filter(u => u.role !== 'admin' && deptTeams.some(t => t.id === u.teamId));
                        rows.push(
                          <div key={dept.id} className="flex items-center gap-1.5 px-2 py-1 border-b wl-t-sm text-[11px] font-semibold" style={{ height: WLR_GRP, backgroundColor: dm ? '#2a2a3e' : '#f1f5f9', color: dm ? '#c0c0d8' : '#334155' }}>
                            <div className="w-2 h-2 rounded-full bg-slate-500 flex-shrink-0" />
                            <span className="truncate">{dept.name}</span>
                            <span className="wl-t-xs text-[10px] text-slate-400 ml-auto">{deptUsers.length}P</span>
                          </div>
                        );
                      });
                    } else if (workloadFilter === 'abteilungen') {
                      divisions.sort((a,b) => a.name.localeCompare(b.name)).forEach(div => {
                        const divTeams = teams.filter(t => t.divisionId === div.id);
                        const divUsers = pUsers.filter(u => u.role !== 'admin' && divTeams.some(t => t.id === u.teamId));
                        if (divUsers.length === 0) return;
                        rows.push(
                          <div key={div.id} className="flex items-center gap-1.5 px-2 py-1 border-b wl-t-sm text-[11px] font-semibold" style={{ height: WLR_GRP, backgroundColor: dm ? '#2a2a3e' : '#eff6ff', color: dm ? '#c0c0d8' : '#1d4ed8' }}>
                            <div className="w-1.5 h-1.5 rounded-full bg-blue-500 flex-shrink-0" />
                            <span className="truncate">{div.name}</span>
                            <span className="wl-t-xs text-[10px] text-stone-400 ml-auto">{divUsers.length}P</span>
                          </div>
                        );
                      });
                    } else if (workloadFilter === 'teams') {
                      teams.sort((a,b) => a.name.localeCompare(b.name)).forEach(team => {
                        const teamUsers = pUsers.filter(u => u.role !== 'admin' && u.teamId === team.id);
                        if (teamUsers.length === 0) return;
                        rows.push(
                          <div key={team.id} className="flex items-center gap-1.5 px-2 py-1 border-b wl-t-sm text-[11px] font-semibold" style={{ height: WLR_GRP, backgroundColor: dm ? '#2a2a3e' : '#eef2ff', color: dm ? '#b0b0c8' : '#4338ca' }}>
                            <div className="w-1.5 h-1.5 rounded-full bg-indigo-500 flex-shrink-0" />
                            <span className="truncate">{team.name}</span>
                            <span className="wl-t-xs text-[10px] text-stone-400 ml-auto">{teamUsers.length}P</span>
                          </div>
                        );
                      });
                    } else if (workloadFilter === 'mitarbeiter' || workloadFilter === 'ma_ressourcen') {
                      
                      const renderUserWithWPs = (u, level, isLastUser, parentLines) => {
                        let userWPs = getUserWorkPackages(u.id);
                        const planProjects = getUserPlanningProjects(u.id);
                        // Bei Fokus auf einzelnes AP: nur das fokussierte AP zeigen
                        if (wlFocusWP && !wlFocusShowAll) {
                          userWPs = userWPs.filter(wp => wp.id === wlFocusWP.wpId);
                        }
                        const isUserExp = workloadExpandedUsers[u.id];
                        const wpCount = userWPs.length + planProjects.length;
                        const userParentLines = [...parentLines.slice(0, level - 1), !isLastUser];
                        rows.push(
                          <div key={u.id} className={`flex items-center gap-1 pr-2 py-1 border-b wl-t-sm font-medium ${wpCount > 0 ? 'cursor-pointer' : ''} relative`} style={{ height: WLR_SUM, backgroundColor: dm ? '#2a2a3e' : '#f4f4f4', borderColor: grpBorder, color: dm ? '#d0d0e0' : '#333333' }} onClick={() => { if (wpCount > 0) { const scrollL = workloadLeftRef.current?.scrollTop; const scrollR = workloadScrollRef.current?.scrollTop; setWorkloadExpandedUsers(prev => ({...prev, [u.id]: !prev[u.id]})); requestAnimationFrame(() => { if (workloadLeftRef.current && scrollL !== undefined) workloadLeftRef.current.scrollTop = scrollL; if (workloadScrollRef.current && scrollR !== undefined) workloadScrollRef.current.scrollTop = scrollR; }); } }}>
                            <TreeLines level={level} isLast={isLastUser} parentLines={parentLines} />
                            {wpCount > 0 && <span className="wl-t-tiny flex-shrink-0" style={{ color: '#999999' }}>{isUserExp ? 'â–¼' : 'â–¶'}</span>}
                            {wpCount === 0 && <span style={{ width: 8 }} className="flex-shrink-0" />}
                            <span className="truncate">{u.name}</span>
                            {onlineUsers.filter(p => p.selectedUserId === u.id).map(p => (
                              <span key={p.sessionId} className="w-2 h-2 rounded-full flex-shrink-0 animate-pulse" style={{ backgroundColor: p.color }} title={`${p.userName} schaut gerade hier`} />
                            ))}
                            {wpCount > 0 && <span className="wl-t-xxs ml-auto flex-shrink-0" style={{ color: '#999999' }}>{userWPs.length > 0 ? userWPs.length + ' AP' : ''}{userWPs.length > 0 && planProjects.length > 0 ? ' Â· ' : ''}{planProjects.length > 0 ? planProjects.length + ' ðŸ“‹' : ''}</span>}
                          </div>
                        );
                        if (isUserExp) {
                          const wpLevel = level + 1;
                          const wpParentLines = [...parentLines, !isLastUser];
                          const allItems = [...userWPs.map(wp => ({...wp, _type: 'wp'})), ...planProjects.map(pp => ({...pp, _type: 'plan'}))];
                          allItems.forEach((item, itemIdx) => {
                            const isLastItem = itemIdx === allItems.length - 1;
                            if (item._type === 'wp') {
                              const wp = item;
                              const project = projects.find(p => p.id === wp.projectId);
                              const wpColor = wp.color || project?.color || '#6366f1';
                              rows.push(
                                <div key={u.id + '_' + wp.id} className="flex items-center gap-0 pr-2 py-0 border-b wl-t-xs relative" style={{ height: WLR_WP, backgroundColor: dm ? '#2e2e44' : '#fafafa', borderColor: grpBorder, color: dm ? '#b0b0c8' : '#555555' }}>
                                  <TreeLines level={wpLevel} isLast={isLastItem} parentLines={wpParentLines} />
                                  <div className="flex items-center gap-1.5 flex-1 min-w-0">
                                    <div className="w-2.5 h-2.5 rounded-sm flex-shrink-0" style={{ backgroundColor: wpColor }} />
                                    <span className="truncate">{wp.name}</span>
                                    {wp.locked && <span className="text-orange-500 flex-shrink-0" title="Termin fixiert">ðŸ”’</span>}
                                    {(() => {
                                      const allAssigned = [...(wp.responsibles || []), ...(wp.editors || [])].map(a => typeof a === 'object' ? a.userId : a);
                                      const others = [...new Set(allAssigned.filter(uid => uid !== u.id))];
                                      if (others.length === 0) return null;
                                      const names = others.map(uid => pUsers.find(x => x.id === uid)).filter(Boolean);
                                      return (
                                        <div className="flex items-center gap-px flex-shrink-0" title={`Auch: ${names.map(n => n.name).join(', ')}`}>
                                          {names.slice(0, 2).map((n, i) => (
                                            <span key={i} className="w-3.5 h-3.5 rounded-full text-[6px] font-bold flex items-center justify-center" style={{ backgroundColor: dm ? '#4a4a5e' : '#e0e7ff', color: dm ? '#b0b0c8' : '#4338ca' }}>{n.name.split(' ').map(w => w[0]).join('').slice(0,2)}</span>
                                          ))}
                                          {names.length > 2 && <span className="text-[7px]" style={{ color: '#94a3b8' }}>+{names.length - 2}</span>}
                                        </div>
                                      );
                                    })()}
                                    <span className="wl-t-tiny ml-auto flex-shrink-0" style={{ color: '#999999' }}>{getUserHours([...(wp.responsibles || []), ...(wp.editors || [])], u.id)}h</span>
                                  </div>
                                </div>
                              );
                            } else {
                              const pp = item;
                              rows.push(
                                <div key={u.id + '_plan_' + pp.projectId} className="flex items-center gap-0 pr-2 py-0 border-b wl-t-xs relative" style={{ height: WLR_WP, backgroundColor: dm ? '#2e2e44' : '#fafafa', borderColor: grpBorder, color: dm ? '#b0b0c8' : '#555555' }}>
                                  <TreeLines level={wpLevel} isLast={isLastItem} parentLines={wpParentLines} />
                                  <div className="flex items-center gap-1.5 flex-1 min-w-0">
                                    <span className="flex-shrink-0" style={{ fontSize: 9 }}>ðŸ“‹</span>
                                    <span className="truncate" style={{ fontStyle: 'italic' }}>{pp.name}</span>
                                    {(() => {
                                      const others = [...new Set(tasks.filter(ot => ot.projectId === pp.projectId && ot.userId !== u.id).map(ot => ot.userId))];
                                      if (others.length === 0) return null;
                                      const names = others.map(uid => pUsers.find(x => x.id === uid)).filter(Boolean);
                                      return (
                                        <div className="flex items-center gap-px flex-shrink-0" title={`Auch: ${names.map(n => n.name).join(', ')}`}>
                                          {names.slice(0, 2).map((n, i) => (
                                            <span key={i} className="w-3.5 h-3.5 rounded-full text-[6px] font-bold flex items-center justify-center" style={{ backgroundColor: dm ? '#4a4a5e' : '#e0e7ff', color: dm ? '#b0b0c8' : '#4338ca' }}>{n.name.split(' ').map(w => w[0]).join('').slice(0,2)}</span>
                                          ))}
                                          {names.length > 2 && <span className="text-[7px]" style={{ color: '#94a3b8' }}>+{names.length - 2}</span>}
                                        </div>
                                      );
                                    })()}
                                    <span className="wl-t-tiny ml-auto flex-shrink-0" style={{ color: '#94a3b8' }}>{Math.round(pp.totalHours)}h</span>
                                  </div>
                                </div>
                              );
                            }
                          });
                        }
                      };

                      // Focus-Mode: Nur beteiligte Mitarbeiter anzeigen
                      if (wlFocusWP) {
                        const focusUsers = pUsers.filter(u => wlFocusWP.userIds.includes(u.id)).sort((a,b) => a.name.localeCompare(b.name));
                        focusUsers.forEach((u, uIdx) => {
                          renderUserWithWPs(u, 0, uIdx === focusUsers.length - 1, []);
                        });
                      } else {
                      // Full hierarchy: Bereich â†’ Abteilung â†’ Team â†’ Mitarbeiter
                      const activeDepts = departments.filter(dept => {
                        const deptDivisions = divisions.filter(d => d.departmentId === dept.id);
                        return pUsers.some(u => u.role !== 'admin' && teams.some(t => t.id === u.teamId && deptDivisions.some(d => d.id === t.divisionId)));
                      }).sort((a,b) => a.name.localeCompare(b.name));
                      
                      activeDepts.forEach((dept, deptIdx) => {
                        const deptDivisions = divisions.filter(d => d.departmentId === dept.id);
                        const deptAllUsers = pUsers.filter(u => u.role !== 'admin' && teams.some(t => t.id === u.teamId && deptDivisions.some(d => d.id === t.divisionId)));
                        const deptKey = 'wl_dept_' + dept.id;
                        const deptExp = isGroupExp(deptKey);
                        const isLastDept = deptIdx === activeDepts.length - 1;
                        rows.push(
                          <div key={deptKey} className="flex items-center gap-1 px-2 py-1 border-b cursor-pointer font-bold" style={{ height: WLR_GRP, backgroundColor: dm ? '#2a2a3e' : '#dcdcdc', borderColor: grpBorder, color: dm ? '#c0c0d8' : '#444444' }} onClick={() => toggleGroup(deptKey)}>
                            <span style={{ color: '#888888' }}>{deptExp ? 'â–¼' : 'â–¶'}</span>
                            <span className="truncate">{dept.name}</span>
                            <span className="ml-auto font-normal" style={{ color: '#888888' }}>{deptAllUsers.length} MA</span>
                          </div>
                        );
                        if (deptExp) {
                          const activeDivisions = deptDivisions.filter(d => {
                            const divTeams = teams.filter(t => t.divisionId === d.id);
                            return pUsers.some(u => u.role !== 'admin' && divTeams.some(t => t.id === u.teamId));
                          }).sort((a,b) => a.name.localeCompare(b.name));
                          
                          activeDivisions.forEach((div, divIdx) => {
                            const divTeams = teams.filter(t => t.divisionId === div.id);
                            const divAllUsers = pUsers.filter(u => u.role !== 'admin' && divTeams.some(t => t.id === u.teamId));
                            if (divAllUsers.length === 0) return;
                            const divKey = 'wl_' + div.id;
                            const divExp = isGroupExp(divKey);
                            const isLastDiv = divIdx === activeDivisions.length - 1;
                            rows.push(
                              <div key={divKey} className="flex items-center gap-1 pr-2 py-1 border-b cursor-pointer font-semibold relative" style={{ height: WLR_GRP, backgroundColor: dm ? '#2a2a3e' : '#e2e2e2', borderColor: grpBorder, color: dm ? '#c0c0d8' : '#444444' }} onClick={() => toggleGroup(divKey)}>
                                <TreeLines level={1} isLast={isLastDiv} parentLines={[]} />
                                <span style={{ color: '#999999' }}>{divExp ? 'â–¼' : 'â–¶'}</span>
                                <span className="truncate">{div.name}</span>
                                <span className="ml-auto font-normal" style={{ color: '#999999' }}>{divAllUsers.length} MA</span>
                              </div>
                            );
                            if (divExp) {
                              const activeTeams = divTeams.filter(t => pUsers.some(u => u.role !== 'admin' && u.teamId === t.id)).sort((a,b) => a.name.localeCompare(b.name));
                              
                              activeTeams.forEach((team, teamIdx) => {
                                const teamUsers = pUsers.filter(u => u.role !== 'admin' && u.teamId === team.id);
                                if (teamUsers.length === 0) return;
                                const teamKey = 'wl_team_' + team.id;
                                const teamExp = isGroupExp(teamKey);
                                const isLastTeam = teamIdx === activeTeams.length - 1;
                                const teamParentLines = [!isLastDiv];
                                rows.push(
                                  <div key={teamKey} className="flex items-center gap-1 pr-2 py-1 border-b cursor-pointer font-medium relative" style={{ height: WLR_GRP, backgroundColor: dm ? '#2a2a3e' : '#ececec', borderColor: grpBorder, color: dm ? '#b0b0c8' : '#555555' }} onClick={() => toggleGroup(teamKey)}>
                                    <TreeLines level={2} isLast={isLastTeam} parentLines={teamParentLines} />
                                    <span style={{ color: '#aaaaaa' }}>{teamExp ? 'â–¼' : 'â–¶'}</span>
                                    <span className="truncate">{team.name}</span>
                                    <span className="ml-auto font-normal" style={{ color: '#aaaaaa' }}>{teamUsers.length} MA</span>
                                  </div>
                                );
                                if (teamExp) {
                                  const userParentLines = [!isLastDiv, !isLastTeam];
                                  teamUsers.sort((a,b) => a.name.localeCompare(b.name)).forEach((u, uIdx) => {
                                    renderUserWithWPs(u, 3, uIdx === teamUsers.length - 1, userParentLines);
                                  });
                                }
                              });
                            }
                          });
                        }
                      });
                      
                      // Orphan users (no team or team not in any division/department)
                      const assignedUserIds = new Set();
                      departments.forEach(dept => {
                        divisions.filter(d => d.departmentId === dept.id).forEach(div => {
                          teams.filter(t => t.divisionId === div.id).forEach(team => {
                            pUsers.filter(u => u.role !== 'admin' && u.teamId === team.id).forEach(u => assignedUserIds.add(u.id));
                          });
                        });
                      });
                      const orphans = pUsers.filter(u => u.role !== 'admin' && !assignedUserIds.has(u.id));
                      if (orphans.length > 0) {
                        const orphKey = 'wl_orphan';
                        const orphExp = isGroupExp(orphKey);
                        rows.push(
                          <div key="_orph" className="flex items-center gap-1 px-2 py-1 border-b cursor-pointer font-semibold" style={{ height: WLR_GRP, backgroundColor: dm ? '#2a2a3e' : '#ececec', borderColor: grpBorder, color: dm ? '#b0b0c8' : '#555555' }} onClick={() => toggleGroup(orphKey)}>
                            <span style={{ color: '#aaaaaa' }}>{orphExp ? 'â–¼' : 'â–¶'}</span>
                            <span>Nicht zugeordnet</span>
                            <span className="ml-auto font-normal" style={{ color: '#aaaaaa' }}>{orphans.length} MA</span>
                          </div>
                        );
                        if (orphExp) orphans.sort((a,b) => a.name.localeCompare(b.name)).forEach((u, uIdx) => renderUserWithWPs(u, 1, uIdx === orphans.length - 1, []));
                      }
                      } // end else (non-focus mode)
                      
                      // In combined mode: add Ressourcen below Mitarbeiter
                      if (workloadFilter === 'ma_ressourcen') {
                        const focusResIds = wlFocusWP?.resourceIds || [];
                        const filteredResources = wlFocusWP ? pResources.filter(r => focusResIds.includes(r.id)) : pResources;
                        
                        if (filteredResources.length > 0) {
                          rows.push(<div key="_res_divider" style={{ height: 3, background: 'linear-gradient(90deg, #6366f1, #8b5cf6)', flexShrink: 0 }} />);
                          const resHeaderKey = 'wl_res_header';
                          const resHeaderExp = isGroupExp(resHeaderKey);
                          rows.push(
                            <div key={resHeaderKey} className="flex items-center gap-1 px-2 py-1 border-b cursor-pointer font-bold" style={{ height: WLR_GRP, backgroundColor: dm ? '#2a2a3e' : '#dcdcdc', borderColor: grpBorder, color: dm ? '#c0c0d8' : '#444444' }} onClick={() => toggleGroup(resHeaderKey)}>
                              <span style={{ color: '#888888' }}>{resHeaderExp ? 'â–¼' : 'â–¶'}</span>
                              <span className="truncate">Ressourcen</span>
                              <span className="ml-auto font-normal" style={{ color: '#888888' }}>{filteredResources.length} EH</span>
                            </div>
                          );
                          if (resHeaderExp) {
                          const resTypeGroups = [
                            { type: 'maschine', label: 'ðŸ­ Maschinen' },
                            { type: 'fahrzeug', label: 'ðŸš› Fahrzeuge' },
                            { type: 'werkzeug', label: 'ðŸ”§ Werkzeuge' },
                          ];
                          const activeTypeGroups = resTypeGroups.filter(tg => filteredResources.some(r => r.type === tg.type));
                          activeTypeGroups.forEach((tg, tgIdx) => {
                            const grouped = filteredResources.filter(r => r.type === tg.type);
                            if (grouped.length === 0) return;
                            const tgKey = 'wl_res_' + tg.type;
                            const isExp = workloadExpandedGroups[tgKey] !== false;
                            const isLastTg = tgIdx === activeTypeGroups.length - 1;
                            rows.push(
                              <div key={'cmb_rg_' + tg.type} className="flex items-center gap-1 pr-2 py-1 border-b cursor-pointer font-semibold relative" style={{ height: WLR_GRP, backgroundColor: dm ? '#2a2a3e' : '#e2e2e2', borderColor: grpBorder, color: dm ? '#c0c0d8' : '#444444' }} onClick={() => toggleGroup(tgKey)}>
                                <TreeLines level={1} isLast={isLastTg} parentLines={[]} />
                                <span style={{ color: '#999999' }}>{isExp ? 'â–¼' : 'â–¶'}</span>
                                <span className="truncate">{tg.label}</span>
                                <span className="ml-auto font-normal" style={{ color: '#999999' }}>{grouped.length} EH</span>
                              </div>
                            );
                            if (isExp) {
                              const sortedRes = grouped.sort((a,b) => a.name.localeCompare(b.name));
                              sortedRes.forEach((r, rIdx) => {
                              const resWPs = getResourceWorkPackages(r.id);
                              const wpCount = resWPs.length;
                              const isResExp = workloadExpandedUsers['res_' + r.id];
                              const resTotalHours = resWPs.reduce((sum, wp) => sum + getResourceHours(wp, r.id), 0);
                              const isLastRes = rIdx === sortedRes.length - 1;
                              const resParentLines = [!isLastTg];
                              rows.push(
                                <div key={'cmb_' + r.id} className={`flex items-center gap-1 pr-2 py-1 border-b wl-t-sm font-medium ${wpCount > 0 ? 'cursor-pointer' : ''} relative`} style={{ height: WLR_SUM, backgroundColor: dm ? '#2a2a3e' : '#f4f4f4', borderColor: grpBorder, color: dm ? '#d0d0e0' : '#333333' }}
                                  onClick={() => { if (wpCount > 0) { const sL = workloadLeftRef.current?.scrollTop; const sR = workloadScrollRef.current?.scrollTop; setWorkloadExpandedUsers(prev => ({...prev, ['res_' + r.id]: !prev['res_' + r.id]})); requestAnimationFrame(() => { if (workloadLeftRef.current && sL !== undefined) workloadLeftRef.current.scrollTop = sL; if (workloadScrollRef.current && sR !== undefined) workloadScrollRef.current.scrollTop = sR; }); } }}
                                >
                                  <TreeLines level={2} isLast={isLastRes} parentLines={resParentLines} />
                                  {wpCount > 0 && <span className="wl-t-tiny flex-shrink-0" style={{ color: '#999999' }}>{isResExp ? 'â–¼' : 'â–¶'}</span>}
                                  {wpCount === 0 && <span style={{ width: 8 }} className="flex-shrink-0" />}
                                  {r.kuerzel && <span className="wl-t-xxs text-[9px] px-1 py-0.5 rounded bg-gray-100 font-mono flex-shrink-0">{r.kuerzel}</span>}
                                  <span className="truncate">{r.name}</span>
                                  {r.schichtmodell > 1 && <span className="wl-t-xxs text-[9px] flex-shrink-0" style={{ color: '#999999' }}>{r.schichtmodell}S</span>}
                                  <span className="wl-t-xxs ml-auto flex-shrink-0" style={{ color: '#999999' }}>{wpCount > 0 ? `${wpCount} AP` : ''}</span>
                                </div>
                              );
                              if (isResExp && wpCount > 0) {
                                const wpParentLines = [!isLastTg, !isLastRes];
                                resWPs.forEach((wp, wpIdx) => {
                                  const project = projects.find(p => p.id === wp.projectId);
                                  const barColor = wp.color || project?.color || '#6366f1';
                                  const resH = getResourceHours(wp, r.id);
                                  const isLastWP = wpIdx === resWPs.length - 1;
                                  rows.push(
                                    <div key={'cmb_' + r.id + '_wp_' + wp.id} className="flex items-center gap-0 pr-2 py-0 border-b wl-t-xs relative cursor-pointer" style={{ height: WLR_WP, backgroundColor: dm ? '#2e2e44' : '#fafafa', borderColor: grpBorder, color: dm ? '#b0b0c8' : '#555555' }}
                                      onContextMenu={(e) => { e.preventDefault(); setWorkloadContextMenu({ x: e.clientX, y: e.clientY, wpId: wp.id, resId: r.id, resName: r.name, wpName: wp.name, projectName: project?.name, locked: wp.locked }); }}
                                      onClick={(e) => { e.stopPropagation(); openSidebar(wp.id); }}
                                    >
                                      <TreeLines level={3} isLast={isLastWP} parentLines={wpParentLines} />
                                      <div className="flex items-center gap-1.5 flex-1 min-w-0">
                                        <div className="w-2.5 h-2.5 rounded-sm flex-shrink-0" style={{ backgroundColor: barColor }} />
                                        <span className="truncate">{wp.name}</span>
                                        {wp.locked && <span className="text-orange-500 flex-shrink-0" title="Termin fixiert">ðŸ”’</span>}
                                        <span className="wl-t-tiny ml-auto flex-shrink-0" style={{ color: '#999999' }}>{resH > 0 ? `${resH}h` : ''}</span>
                                      </div>
                                    </div>
                                  );
                                });
                              }
                              });
                            }
                          });
                          }
                        }
                      }
                    } else if (workloadFilter === 'ressourcen') {
                      const focusResIds = wlFocusWP?.resourceIds || [];
                      const allRes = wlFocusWP ? pResources.filter(r => focusResIds.includes(r.id)) : pResources;
                      const typeGroups = [
                        { type: 'maschine', label: 'ðŸ­ Maschinen' },
                        { type: 'fahrzeug', label: 'ðŸš› Fahrzeuge' },
                        { type: 'werkzeug', label: 'ðŸ”§ Werkzeuge' },
                      ];
                      const activeTypeGroups = typeGroups.filter(tg => allRes.some(r => r.type === tg.type));
                      activeTypeGroups.forEach((tg, tgIdx) => {
                        const grouped = allRes.filter(r => r.type === tg.type);
                        if (grouped.length === 0) return;
                        const tgKey = 'wl_res_' + tg.type;
                        const isExp = workloadExpandedGroups[tgKey] !== false;
                        const isLastTg = tgIdx === activeTypeGroups.length - 1;
                        rows.push(
                          <div key={'rg_' + tg.type} className="flex items-center gap-1 px-2 py-1 border-b cursor-pointer font-bold" style={{ height: WLR_GRP, backgroundColor: dm ? '#2a2a3e' : '#dcdcdc', borderColor: grpBorder, color: dm ? '#c0c0d8' : '#444444' }} onClick={() => toggleGroup(tgKey)}>
                            <span style={{ color: '#888888' }}>{isExp ? 'â–¼' : 'â–¶'}</span>
                            <span className="truncate">{tg.label}</span>
                            <span className="ml-auto font-normal" style={{ color: '#888888' }}>{grouped.length} EH</span>
                          </div>
                        );
                        if (isExp) {
                          const sortedRes = grouped.sort((a,b) => a.name.localeCompare(b.name));
                          sortedRes.forEach((r, rIdx) => {
                          const resWPs = getResourceWorkPackages(r.id);
                          const wpCount = resWPs.length;
                          const isResExp = workloadExpandedUsers['res_' + r.id];
                          const isLastRes = rIdx === sortedRes.length - 1;
                          rows.push(
                            <div key={r.id} className={`flex items-center gap-1 pr-2 py-1 border-b wl-t-sm font-medium ${wpCount > 0 ? 'cursor-pointer' : ''} relative`} style={{ height: WLR_SUM, backgroundColor: dm ? '#2a2a3e' : '#f4f4f4', borderColor: grpBorder, color: dm ? '#d0d0e0' : '#333333' }}
                              onClick={() => { if (wpCount > 0) { const sL = workloadLeftRef.current?.scrollTop; const sR = workloadScrollRef.current?.scrollTop; setWorkloadExpandedUsers(prev => ({...prev, ['res_' + r.id]: !prev['res_' + r.id]})); requestAnimationFrame(() => { if (workloadLeftRef.current && sL !== undefined) workloadLeftRef.current.scrollTop = sL; if (workloadScrollRef.current && sR !== undefined) workloadScrollRef.current.scrollTop = sR; }); } }}
                            >
                              <TreeLines level={1} isLast={isLastRes} parentLines={[]} />
                              {wpCount > 0 && <span className="wl-t-tiny flex-shrink-0" style={{ color: '#999999' }}>{isResExp ? 'â–¼' : 'â–¶'}</span>}
                              {wpCount === 0 && <span style={{ width: 8 }} className="flex-shrink-0" />}
                              {r.kuerzel && <span className="wl-t-xxs text-[9px] px-1 py-0.5 rounded bg-gray-100 font-mono flex-shrink-0">{r.kuerzel}</span>}
                              <span className="truncate">{r.name}</span>
                              {r.schichtmodell > 1 && <span className="wl-t-xxs text-[9px] flex-shrink-0" style={{ color: '#999999' }}>{r.schichtmodell}S</span>}
                              <span className="wl-t-xxs ml-auto flex-shrink-0" style={{ color: '#999999' }}>{wpCount > 0 ? `${wpCount} AP` : ''}</span>
                            </div>
                          );
                          if (isResExp && wpCount > 0) {
                            const wpParentLines = [!isLastRes];
                            resWPs.forEach((wp, wpIdx) => {
                              const project = projects.find(p => p.id === wp.projectId);
                              const barColor = wp.color || project?.color || '#6366f1';
                              const resH = getResourceHours(wp, r.id);
                              const isLastWP = wpIdx === resWPs.length - 1;
                              rows.push(
                                <div key={r.id + '_wp_' + wp.id} className="flex items-center gap-0 pr-2 py-0 border-b wl-t-xs relative cursor-pointer" style={{ height: WLR_WP, backgroundColor: dm ? '#2e2e44' : '#fafafa', borderColor: grpBorder, color: dm ? '#b0b0c8' : '#555555' }}
                                  onContextMenu={(e) => { e.preventDefault(); setWorkloadContextMenu({ x: e.clientX, y: e.clientY, wpId: wp.id, resId: r.id, resName: r.name, wpName: wp.name, projectName: project?.name, locked: wp.locked }); }}
                                  onClick={(e) => { e.stopPropagation(); openSidebar(wp.id); }}
                                >
                                  <TreeLines level={2} isLast={isLastWP} parentLines={wpParentLines} />
                                  <div className="flex items-center gap-1.5 flex-1 min-w-0">
                                    <div className="w-2.5 h-2.5 rounded-sm flex-shrink-0" style={{ backgroundColor: barColor }} />
                                    <span className="truncate">{wp.name}</span>
                                    {wp.locked && <span className="text-orange-500 flex-shrink-0" title="Termin fixiert">ðŸ”’</span>}
                                    <span className="wl-t-tiny ml-auto flex-shrink-0" style={{ color: '#999999' }}>{resH > 0 ? `${resH}h` : ''}</span>
                                  </div>
                                </div>
                              );
                            });
                          }
                          });
                        }
                      });
                    }
                    
                    // Add bottom spacer in cockpit mode so last resource can be scrolled to top
                    if (showResourceCockpit) {
                      rows.push(<div key="_bottom_spacer" style={{ height: '60vh', flexShrink: 0 }} />);
                    }
                    
                    return rows;
                  })()}
                </div>
                {/* Resize handle for left panel (cockpit mode) */}
                {showResourceCockpit && (
                  <div 
                    className="flex-shrink-0 cursor-col-resize hover:bg-indigo-300 active:bg-indigo-400 transition-colors"
                    style={{ width: 4, backgroundColor: darkMode ? '#3a3a4e' : '#e2e8f0' }}
                    onMouseDown={(e) => {
                      e.preventDefault();
                      const startX = e.clientX;
                      const startW = leftPanelWidth;
                      const onMove = (ev) => setLeftPanelWidth(Math.max(120, Math.min(600, startW + (ev.clientX - startX))));
                      const onUp = () => { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); };
                      document.addEventListener('mousemove', onMove);
                      document.addEventListener('mouseup', onUp);
                    }}
                  />
                )}
                {/* Right: IDENTICAL to headerScrollRef â€” proven pattern that syncs perfectly */}
                <div 
                  ref={workloadScrollRef}
                  className={`flex-1 overflow-auto ${showResourceCockpit ? 'hide-h-scroll' : 'hide-scrollbar'}`}
                  onScroll={(e) => {
                    // Bidirectional horizontal sync (same as header)
                    if (ganttHScrollRef.current && ganttHScrollRef.current.scrollLeft !== e.target.scrollLeft) {
                      ganttHScrollRef.current.scrollLeft = e.target.scrollLeft;
                    }
                    if (headerScrollRef.current && headerScrollRef.current.scrollLeft !== e.target.scrollLeft) {
                      headerScrollRef.current.scrollLeft = e.target.scrollLeft;
                    }
                    window._ganttScrollLeft.value = e.target.scrollLeft;
                    // Sync bottom scrollbar
                    if (bottomScrollRef.current && bottomScrollRef.current.scrollLeft !== e.target.scrollLeft) {
                      bottomScrollRef.current.scrollLeft = e.target.scrollLeft;
                    }
                    // Vertical sync to left names
                    if (workloadLeftRef.current) workloadLeftRef.current.scrollTop = e.target.scrollTop;
                    window._workloadScroll.top = e.target.scrollTop;
                  }}
                >
                  <div style={{ minWidth: ganttContentWidth, position: 'relative' }}>
                      {/* Cockpit mode: sticky date header (3 rows like Projektplanung) */}
                      {showResourceCockpit && (
                        <div className="sticky top-0 z-20 flex flex-col" style={{ minWidth: ganttContentWidth, boxShadow: '0 2px 4px rgba(0,0,0,0.1)' }}>
                          {/* Row 1: Months */}
                          <div className="flex" style={{ backgroundColor: darkMode ? '#252536' : '#f1f5f9', borderBottom: `1px solid ${darkMode ? '#3a3a4e' : '#e0e0e0'}` }}>
                            {monthHeaders.map((m, i) => (
                              <div key={i} className="font-semibold text-center" style={{ width: m.weeks * 7 * DAY_WIDTH, borderRight: `1px solid ${darkMode ? '#3a3a4e' : '#e0e0e0'}`, color: darkMode ? '#b0b0c8' : '#374151', backgroundColor: darkMode ? '#252536' : '#f1f5f9', fontSize: Math.round(wlFontSize * 1.3), padding: `${Math.max(1, Math.round(wlFontSize * 0.15))}px 0` }}>{m.name}</div>
                            ))}
                          </div>
                          {/* Row 2: KW + Row 3: Dates + Weekdays */}
                          <div className="flex" style={{ backgroundColor: darkMode ? '#2a2a3e' : '#f9fafb' }}>
                            {weekNumbers.map(weekNum => {
                              const weekDates = getWeekDates(weekNum, new Date().getFullYear());
                              const displayWeekNum = weekDates.length > 0 ? getWeekNumber(weekDates[0]) : weekNum;
                              const hbc = darkMode ? '#3a3a4e' : '#e0e0e0';
                              return (
                                <div key={weekNum} className="flex-shrink-0 flex flex-col" style={{ width: 7 * DAY_WIDTH }}>
                                  <div className="text-center font-semibold" style={{ fontSize: wlFontSize, padding: `${Math.max(1, Math.round(wlFontSize * 0.1))}px 0`, backgroundColor: darkMode ? '#2a2a3e' : '#eef2ff', borderRight: `1px solid ${hbc}`, borderBottom: `1px solid ${hbc}`, color: darkMode ? '#a0a0c0' : '#4338ca' }}>KW {displayWeekNum}</div>
                                  <div className="flex" style={{ borderBottom: `1px solid ${hbc}` }}>
                                    {weekDates.map((date, i) => {
                                      const dateStr = formatDate(date);
                                      const holiday = holidays[dateStr];
                                      const isToday = dateStr === formatDate(new Date());
                                      return (
                                        <div key={i} className="text-center" style={{ width: DAY_WIDTH, fontSize: Math.max(7, wlFontSize - 2), borderRight: `1px solid ${hbc}`, backgroundColor: isToday ? (darkMode ? '#4a2028' : '#fecaca') : holiday ? (darkMode ? '#4a2028' : '#fecaca') : i >= 5 ? (darkMode ? '#1a1a2a' : '#e5e7eb') : (darkMode ? '#2a2a3e' : '#f9fafb'), color: isToday ? '#ef4444' : holiday ? '#dc2626' : (darkMode ? '#8888a8' : '#6b7280') }}>
                                          {date.getDate()}
                                        </div>
                                      );
                                    })}
                                  </div>
                                  <div className="flex">
                                    {weekDates.map((date, i) => {
                                      const dateStr = formatDate(date);
                                      const holiday = holidays[dateStr];
                                      const isToday = dateStr === formatDate(new Date());
                                      return (
                                        <div key={i} className="text-center flex items-center justify-center" style={{ width: DAY_WIDTH, fontSize: Math.max(7, wlFontSize - 2), borderRight: `1px solid ${hbc}`, backgroundColor: isToday ? (darkMode ? '#4a2028' : '#fecaca') : holiday ? (darkMode ? '#5a2020' : '#fca5a5') : i >= 5 ? (darkMode ? '#1a1a2a' : '#d1d5db') : (darkMode ? '#2a2a3e' : 'transparent'), color: isToday ? '#ef4444' : holiday ? '#dc2626' : (darkMode ? '#8888a8' : '#6b7280') }}>
                                          {['Mo','Di','Mi','Do','Fr','Sa','So'][i]}
                                        </div>
                                      );
                                    })}
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      )}
                      {/* Today line */}
                      {(() => {
                        const todayIdx = dayMeta.findIndex(dm => dm.isToday);
                        if (todayIdx >= 0) {
                          const todayX = todayIdx * DAY_WIDTH + Math.floor(DAY_WIDTH / 2) - 1;
                          return <div className="absolute top-0 bottom-0 pointer-events-none" style={{ left: todayX, width: 2, backgroundColor: '#ef4444', zIndex: 3 }} />;
                        }
                        return null;
                      })()}
                      {(() => {
                      const gridRows = [];
                      const WLR = Math.round(ROW_HEIGHT * workloadZoom / 100);
                      const WLR_SUM = wlBarMode === 'bar' ? Math.round(WLR * 1.4) : WLR;
                      const WLR_WP = Math.round(WLR * 0.8);
                      const WLR_GRP = WLR_SUM;
                      const wlFmt = (v) => { const s = v.toFixed(wlDecimals); return wlDecimals === 0 ? s : s.replace(/\.?0+$/, '') || '0'; };
                      const dm = darkMode;
                      const dBg = (light, dark) => dm ? dark : light;
                      const _activePresetObj = wlActivePreset ? wlCustomPresets.find(p => p.id === wlActivePreset) : null;
                      const _presetUserIds = _activePresetObj?.userIds ? new Set(_activePresetObj.userIds) : null;
                      const _presetResIds = _activePresetObj?.resourceIds ? new Set(_activePresetObj.resourceIds) : null;
                      const pUsers = _presetUserIds ? (users || []).filter(u => _presetUserIds.has(u.id)) : (users || []);
                      const pResources = _presetResIds ? (resources || []).filter(r => _presetResIds.has(r.id)) : (resources || []);
                      
                      const renderUserRow = (u, key) => {
                        const REF_MAX = 12; // 12h = cell top
                        return (
                        <div key={key || u.id} className="flex border-b" style={{ height: WLR_SUM, backgroundColor: dBg('#f8f8f8','#2a2a3e'), borderColor: grpBorder }}>
                          {dayMeta.map((dm, i) => {
                            const { day, ds, isWE, isHol, isToday } = dm;
                            const isVac = isVacation(u.id, day);
                            const vacType = isVac ? getVacationType(u.id, day) : null;
                            const data = calculateWorkload[u.id]?.[ds];
                            const hours = data?.total || 0;
                            const rawCap = getDailyHours(u, day);
                            const dailyCapacity = isVac ? 0 : rawCap;
                            
                            // Drag-Selection highlight
                            const isDragSelected = vacationDrag && vacationDrag.userId === u.id && vacationDrag.endIdx !== undefined &&
                              i >= Math.min(vacationDrag.startIdx, vacationDrag.endIdx) && i <= Math.max(vacationDrag.startIdx, vacationDrag.endIdx) && !isWE;
                            
                            const vacIcons = { urlaub: 'ðŸ–ï¸', krank: 'ðŸ¤’', sonstige: 'ðŸ“…' };
                            
                            // Bar chart calculations
                            const capLinePct = (!isWE && !isHol) ? Math.min(90, (rawCap / REF_MAX) * 100) : 0;
                            const normalHours = Math.min(hours, dailyCapacity);
                            const overHours = Math.max(0, hours - dailyCapacity);
                            const normalPct = dailyCapacity > 0 ? (normalHours / REF_MAX) * 100 : (hours > 0 ? Math.min((hours / REF_MAX) * 100, 100) : 0);
                            const overPct = (overHours / REF_MAX) * 100;
                            const totalBarPct = Math.min(normalPct + overPct, 90);
                            
                            // Background
                            let bgStyle = { borderColor: grpBorder };
                            const ratio = dailyCapacity > 0 ? hours / dailyCapacity : (hours > 0 ? 2 : 0);
                            if (isDragSelected) bgStyle.backgroundColor = dBg('#e0e7ff', '#3a3860');
                            else if (isVac && !isWE && hours > 0) bgStyle.backgroundColor = dBg('#fecaca', '#5a2020');
                            else if (isVac && !isWE) { const vc = { urlaub: dBg('#fff7ed','#4a3020'), krank: dBg('#fff1f2','#4a2028'), sonstige: dBg('#f8fafc','#30304a') }; bgStyle.backgroundColor = vc[vacType] || dBg('#fff7ed','#4a3020'); }
                            else if (isToday) bgStyle.backgroundColor = dBg('#fef2f2', '#3a2028');
                            else if (isHol) bgStyle.backgroundColor = dBg('#fee2e2', '#4a2020');
                            else if (isWE) bgStyle.backgroundColor = dBg('#e5e7eb', '#1a1a2a');
                            else if (wlBarMode === 'number' && hours > 0 && getColorTier(ratio) === 'red') bgStyle.backgroundColor = dBg('#fecaca', '#5a1a1a');
                            else if (wlBarMode === 'number' && hours > 0 && getColorTier(ratio) === 'orange') bgStyle.backgroundColor = dBg('#fed7aa', '#5a3a10');
                            else if (wlBarMode === 'number' && hours > 0 && getColorTier(ratio) === 'blue') bgStyle.backgroundColor = dBg('#c7d2fe', '#2a2a60');
                            else if (wlBarMode === 'number' && hours > 0) bgStyle.backgroundColor = dBg('#bbf7d0', '#1a4028');
                            else if (darkMode) bgStyle.backgroundColor = '#2a2a3e';
                            const numTextColor = isVac && !isWE ? 'text-orange-500' : ({ red: 'text-red-700 font-bold', orange: 'text-orange-700 font-bold', blue: 'text-indigo-700 font-bold', green: hours > 0 ? 'text-green-700 font-bold' : 'text-gray-300' }[getColorTier(ratio)]);
                            
                            return (
                              <div 
                                key={i} 
                                data-vac-idx={i}
                                data-vac-user-id={u.id}
                                className={`flex-shrink-0 border-r border-b flex ${wlBarMode === 'bar' ? 'items-end' : 'items-center'} justify-center ${!isWE ? 'cursor-cell' : 'cursor-default'} select-none relative overflow-hidden`} 
                                style={{ width: DAY_WIDTH, height: WLR_SUM, ...bgStyle }} 
                                title={isVac ? `${vacIcons[vacType] || 'ðŸ–ï¸'} ${vacType === 'krank' ? 'Krank' : vacType === 'sonstige' ? 'Sonstiges' : 'Urlaub'} â€“ ${u.name}` : `${u.name} â€“ ${ds}\nKapazitÃ¤t: ${dailyCapacity}h / Belegt: ${hours}h` + (data?.details?.length ? '\n' + data.details.map(d => `${d.wpName}: ${d.hours.toFixed(1)}h`).join('\n') : '')}
                                onMouseDown={(e) => {
                                  if (e.button !== 0 || isWE) return;
                                  e.preventDefault();
                                  setVacationDrag({ userId: u.id, startIdx: i, endIdx: i });
                                }}
                                onContextMenu={(e) => {
                                  if (isWE) return;
                                  e.preventDefault();
                                  setVacationTypePicker({ x: e.clientX, y: e.clientY, userId: u.id, dates: [ds], hasExisting: isVac });
                                }}
                              >
                                {wlBarMode === 'bar' ? (
                                  <React.Fragment>
                                    {/* Capacity reference line (dashed) */}
                                    {capLinePct > 0 && !isVac && hours > 0 && (
                                      <div className="absolute left-0 right-0 pointer-events-none" style={{ bottom: `${capLinePct}%`, height: 0, borderTop: darkMode ? '1.5px dashed #606080' : '1.5px dashed #b8b8b8' }} />
                                    )}
                                    {/* Bar chart visualization */}
                                    {hours > 0 && !isWE && !isHol && !isVac ? (
                                      <div className="absolute bottom-0 left-[2px] right-[2px] flex flex-col justify-end pointer-events-none" style={{ height: `${totalBarPct}%` }}>
                                        {overPct > 0 && (
                                          <div style={{ height: `${(overPct / totalBarPct) * 100}%`, backgroundColor: tierToHex(getColorTier(ratio)), borderRadius: '2px 2px 0 0', minHeight: 2 }} />
                                        )}
                                        <div style={{ flex: overPct > 0 ? undefined : 1, height: overPct > 0 ? `${(normalPct / totalBarPct) * 100}%` : '100%', backgroundColor: '#6366f1', borderRadius: overPct > 0 ? '0' : '2px 2px 0 0', minHeight: 2 }} />
                                      </div>
                                    ) : isVac && !isWE ? (
                                      <div className="relative z-10 flex items-center justify-center" style={{ height: '100%', width: '100%' }}>
                                        {hours > 0 ? <span className="wl-icon" style={{ fontSize: 9 }}>âš ï¸</span> : <span className="wl-icon" style={{ fontSize: 9 }}>{vacIcons[vacType] || 'ðŸ–ï¸'}</span>}
                                      </div>
                                    ) : null}
                                  </React.Fragment>
                                ) : wlBarMode === 'indicator' ? (
                                  <React.Fragment>
                                    {isVac && !isWE ? (
                                      <span className="wl-icon" style={{ fontSize: 9 }}>{hours > 0 ? 'âš ï¸' : (vacIcons[vacType] || 'ðŸ–ï¸')}</span>
                                    ) : !isWE && !isHol && dailyCapacity > 0 ? (
                                      <div style={{ width: Math.max(4, Math.round(DAY_WIDTH * 0.6)), height: Math.max(4, Math.round(WLR_SUM * 0.6)), borderRadius: 3, backgroundColor: hours === 0 ? dBg('#e8e8e8','#3a3a4e') : tierToHex(getColorTier(ratio)) }} />
                                    ) : null}
                                  </React.Fragment>
                                ) : (
                                  <div className="relative z-10 flex items-center justify-center" style={{ height: '100%' }}>
                                    {isVac && !isWE && hours > 0 ? (
                                      <span className="wl-icon" style={{ fontSize: 9 }}>âš ï¸</span>
                                    ) : isVac && !isWE ? (
                                      <span className="wl-icon" style={{ fontSize: 9 }}>{vacIcons[vacType] || 'ðŸ–ï¸'}</span>
                                    ) : hours > 0 ? (
                                      <span className={`wl-t-xxs text-[9px] ${numTextColor}`}>{wlFmt(hours)}</span>
                                    ) : null}
                                  </div>
                                )}
                              </div>
                            );
                          })}
                        </div>
                        );
                      };
                      
                      const grpBorder = darkMode ? '#3a3a4e' : '#e0e0e0';
                      const GRP_REF_MAX = 12; // same reference as individual rows
                      const renderGroupRow = (userGroup, bgClass, key, rowStyle) => {
                        return (
                        <div key={key} className={`flex border-b ${bgClass}`} style={{ height: WLR_SUM, borderColor: grpBorder, ...rowStyle }}>
                          {dayMeta.map((dm, i) => {
                            const { day, ds, isWE, isHol, isToday } = dm;
                            const total = userGroup.reduce((sum, u) => sum + (calculateWorkload[u.id]?.[ds]?.total || 0), 0);
                            const totalCap = userGroup.reduce((sum, u) => sum + getDailyHours(u, day), 0);
                            const ratio = totalCap > 0 ? total / totalCap : 0;
                            
                            // Bar chart calculations
                            const capLinePct = (!isWE && !isHol && totalCap > 0) ? Math.min(90, (totalCap / (totalCap * 1.5)) * 100) : 0;
                            const normalHours = Math.min(total, totalCap);
                            const overHours = Math.max(0, total - totalCap);
                            const refMax = Math.max(totalCap * 1.5, GRP_REF_MAX);
                            const normalPct = totalCap > 0 ? (normalHours / refMax) * 100 : (total > 0 ? Math.min((total / refMax) * 100, 100) : 0);
                            const overPct = (overHours / refMax) * 100;
                            const totalBarPct = Math.min(normalPct + overPct, 90);
                            const capPct = totalCap > 0 ? Math.min(90, (totalCap / refMax) * 100) : 0;
                            
                            const numTextColor = ({ red: darkMode ? 'text-red-300 font-bold' : 'text-red-700 font-bold', orange: darkMode ? 'text-orange-300 font-bold' : 'text-orange-700 font-bold', blue: darkMode ? 'text-indigo-300 font-bold' : 'text-indigo-700 font-bold', green: total > 0 ? (darkMode ? 'text-green-300 font-bold' : 'text-green-700 font-bold') : '' }[getColorTier(ratio)]);
                            const cellBg = isToday ? dBg('#fef2f2','#3a2028') : isHol ? dBg('#fee2e2','#4a2020') : isWE ? dBg('#e5e7eb','#1a1a2a') : (darkMode ? '#2a2a3e' : undefined);
                            
                            // Number mode backgrounds
                            let numBg = cellBg;
                            if (wlBarMode === 'number' && !isWE && !isHol && !isToday && totalCap > 0) {
                              numBg = ({ red: dBg('#fecaca','#5a1a1a'), orange: dBg('#fed7aa','#5a3a10'), blue: dBg('#c7d2fe','#2a2a60'), green: total > 0 ? dBg('#bbf7d0','#1a4028') : undefined }[getColorTier(ratio)]);
                            }
                            
                            return <div key={i} className="flex-shrink-0 border-r border-b text-center wl-t-tiny text-[8px] flex items-center justify-center relative overflow-hidden" style={{ width: DAY_WIDTH, height: WLR_SUM, backgroundColor: wlBarMode === 'number' ? (numBg || cellBg) : cellBg, borderColor: grpBorder }}>
                              {wlBarMode === 'bar' ? (
                                <React.Fragment>
                                  {capPct > 0 && total > 0 && (
                                    <div className="absolute left-0 right-0 pointer-events-none" style={{ bottom: `${capPct}%`, height: 0, borderTop: darkMode ? '1.5px dashed #606080' : '1.5px dashed #b8b8b8' }} />
                                  )}
                                  {total > 0 && !isWE && !isHol ? (
                                    <div className="absolute bottom-0 left-[2px] right-[2px] flex flex-col justify-end pointer-events-none" style={{ height: `${totalBarPct}%` }}>
                                      {overPct > 0 && (
                                        <div style={{ height: `${(overPct / totalBarPct) * 100}%`, backgroundColor: tierToHex(getColorTier(ratio)), borderRadius: '2px 2px 0 0', minHeight: 2 }} />
                                      )}
                                      <div style={{ flex: overPct > 0 ? undefined : 1, height: overPct > 0 ? `${(normalPct / totalBarPct) * 100}%` : '100%', backgroundColor: '#6366f1', borderRadius: overPct > 0 ? '0' : '2px 2px 0 0', minHeight: 2 }} />
                                    </div>
                                  ) : null}
                                </React.Fragment>
                              ) : wlBarMode === 'indicator' ? (
                                !isWE && !isHol && totalCap > 0 ? (
                                  <div style={{ width: Math.max(4, Math.round(DAY_WIDTH * 0.6)), height: Math.max(4, Math.round(WLR_SUM * 0.6)), borderRadius: 3, backgroundColor: total === 0 ? dBg('#e8e8e8','#3a3a4e') : tierToHex(getColorTier(ratio)) }} />
                                ) : null
                              ) : (
                                total > 0 && <span className={`wl-t-tiny ${numTextColor}`}>{wlFmt(total)}</span>
                              )}
                            </div>;
                          })}
                        </div>
                        );
                      };
                      
                      // WP-Balken-Zeile fÃ¼r einen User
                      const renderWPBarRow = (u, wp) => {
                        const project = projects.find(p => p.id === wp.projectId);
                        const barColor = wp.color || project?.color || '#6366f1';
                        const wpStart = wp.startDate;
                        const wpEnd = wp.endDate;
                        const workDays = getWPWorkDays(wp);
                        const activeDays = getActiveDaysForWP(wp, u.id);
                        const workDaySet = new Set(workDays);
                        const activeDaySet = new Set(activeDays);
                        const totalHours = getUserHours([...(wp.responsibles || []), ...(wp.editors || [])], u.id);
                        const hoursPerActiveDay = activeDays.length > 0 ? totalHours / activeDays.length : 0;
                        const hasOverrides = !!wp.dailyOverrides?.[u.id];
                        
                        return (
                          <div key={u.id + '_wp_' + wp.id} className="flex border-b border-gray-50 relative" style={{ height: WLR_WP, backgroundColor: 'transparent', borderColor: grpBorder }}
                            onContextMenu={(e) => {
                              e.preventDefault();
                              setWorkloadContextMenu({ x: e.clientX, y: e.clientY, wpId: wp.id, userId: u.id, wpName: wp.name, projectName: project?.name, locked: wp.locked });
                            }}
                          >
                            {dayMeta.map((dm, i) => {
                              const { day, ds, isWE, isHol, isToday } = dm;
                              const inRange = ds >= wpStart && ds <= wpEnd;
                              const isWorkDay = workDaySet.has(ds);
                              const isActive = activeDaySet.has(ds);
                              const isFirst = ds === wpStart;
                              const isLast = ds === wpEnd;
                              const isVac = isVacation(u.id, day);
                              const vacConflict = inRange && isWorkDay && isActive && isVac;
                              
                              // Hintergrund
                              let bg = '';
                              let cellStyle = { width: DAY_WIDTH, height: WLR_WP, borderColor: grpBorder };
                              
                              if (vacConflict) {
                                cellStyle.backgroundColor = dBg('#fef2f2', '#5a2020');
                              } else if (inRange && isWorkDay && isActive) {
                                cellStyle.backgroundColor = barColor + '40';
                              } else if (inRange && isWorkDay && !isActive) {
                                cellStyle.backgroundColor = dBg('#ffffff', '#2e2e44');
                              } else if (isToday) {
                                cellStyle.backgroundColor = dBg('#fef2f2', '#3a2028');
                              } else if (isHol) {
                                cellStyle.backgroundColor = dBg('#fee2e2', '#4a2020');
                              } else if (isWE) {
                                cellStyle.backgroundColor = dBg('#e5e7eb', '#1a1a2a');
                              } else if (darkMode) {
                                cellStyle.backgroundColor = '#2e2e44';
                              }
                              
                              // Border
                              let borderStyle = {};
                              if (inRange && isWorkDay) {
                                const bColor = vacConflict ? '#ef4444' : barColor;
                                borderStyle.borderTop = `2px solid ${bColor}`;
                                borderStyle.borderBottom = `2px solid ${bColor}`;
                                if (isFirst || (i > 0 && dayMeta[i-1].ds < wpStart)) { borderStyle.borderLeft = `2px solid ${bColor}`; borderStyle.borderTopLeftRadius = 4; borderStyle.borderBottomLeftRadius = 4; }
                                if (isLast || (i < dayMeta.length - 1 && dayMeta[i+1].ds > wpEnd)) { borderStyle.borderRight = `2px solid ${bColor}`; borderStyle.borderTopRightRadius = 4; borderStyle.borderBottomRightRadius = 4; }
                              } else if (inRange && (isWE || isHol)) {
                                borderStyle.borderTop = `1px dashed ${barColor}50`;
                                borderStyle.borderBottom = `1px dashed ${barColor}50`;
                              }
                              
                              // Label nach dem letzten Tag des Balkens
                              const showLabel = isLast;
                              
                              return (
                                <div 
                                  key={i} 
                                  className={`flex-shrink-0 wl-bar-cell text-center wl-t-tiny text-[8px] flex items-center justify-center ${bg} ${isWorkDay && inRange ? 'cursor-pointer hover:brightness-90' : 'cursor-default'} ${showLabel ? 'relative' : ''}`} 
                                  style={{ ...cellStyle, ...borderStyle }}
                                  onClick={() => { if (isWorkDay && inRange) toggleWPDayForUser(wp.id, u.id, ds); }}
                                  title={vacConflict ? `âš ï¸ ${hoursPerActiveDay.toFixed(1)}h geplant aber abwesend!` : inRange && isWorkDay ? (isActive ? `${hoursPerActiveDay.toFixed(1)}h â€“ Klick: Tag deaktivieren` : 'Klick: Tag aktivieren') : ''}
                                >
                                  {vacConflict ? (
                                    <span className="wl-icon" style={{ fontSize: 9 }}>âš ï¸</span>
                                  ) : isActive && hoursPerActiveDay > 0 ? (
                                    <span className="wl-t-tiny font-medium" style={{ color: barColor, fontSize: 8 }}>
                                      {wlFmt(hoursPerActiveDay)}
                                    </span>
                                  ) : null}
                                  {showLabel && (
                                    <span className="absolute left-full ml-1 whitespace-nowrap wl-t-xxs text-[9px] pointer-events-none flex items-center gap-1 z-10" style={{ top: '50%', transform: 'translateY(-50%)' }}>
                                      <span className="font-medium" style={{ color: barColor }}>{project?.name}</span>
                                      <span className="text-gray-400">â€º</span>
                                      <span className="text-gray-600">{wp.name}</span>
                                      <span className="text-gray-400 ml-0.5">{totalHours}h</span>
                                      {wp.locked && <span className="text-orange-500" title="Termin fixiert">ðŸ”’</span>}
                                    </span>
                                  )}
                                </div>
                              );
                            })}
                          </div>
                        );
                      };
                      
                      // === Resource equivalents of renderUserRow / renderWPBarRow (identical style) ===
                      const rdtColors = { ausfall: 'bg-red-100', wartung: 'bg-amber-100', sonstiges: 'bg-slate-100' };
                      const rdtIcons = { ausfall: 'â›”', wartung: 'ðŸ”§', sonstiges: 'ðŸ“…' };
                      const rdtLabels = { ausfall: 'Ausfall', wartung: 'Wartung', sonstiges: 'Sonstiges' };
                      
                      const renderResourceRow = (r, key) => {
                        const REF_MAX = 12;
                        const resDailyCap = getResourceDailyCapacity(r);
                        return (
                        <div key={key || r.id} className="flex border-b" style={{ height: WLR_SUM, backgroundColor: dBg('#f8f8f8','#2a2a3e'), borderColor: grpBorder }}>
                          {dayMeta.map((dm, i) => {
                            const { day, ds, isWE, isHol, isToday } = dm;
                            const isDown = isResourceDown(r.id, day);
                            const downType = isDown ? getResourceDownType(r.id, day) : null;
                            const data = calculateResourceWorkload[r.id]?.[ds];
                            const hours = data?.total || 0;
                            const dailyCapacity = isDown ? 0 : resDailyCap;
                            
                            const isDragSelected = resDownDrag && resDownDrag.resId === r.id && resDownDrag.endIdx !== undefined &&
                              i >= Math.min(resDownDrag.startIdx, resDownDrag.endIdx) && i <= Math.max(resDownDrag.startIdx, resDownDrag.endIdx) && !isWE;
                            
                            // Bar chart calculations
                            const capLinePct = (!isWE && !isHol && !isDown) ? Math.min(90, (resDailyCap / REF_MAX) * 100) : 0;
                            const normalHours = Math.min(hours, dailyCapacity);
                            const overHours = Math.max(0, hours - dailyCapacity);
                            const normalPct = dailyCapacity > 0 ? (normalHours / REF_MAX) * 100 : (hours > 0 ? Math.min((hours / REF_MAX) * 100, 100) : 0);
                            const overPct = (overHours / REF_MAX) * 100;
                            const totalBarPct = Math.min(normalPct + overPct, 90);
                            
                            // Background
                            let bgStyle = { borderColor: grpBorder };
                            const downConflict = isDown && !isWE && hours > 0;
                            const ratio = dailyCapacity > 0 ? hours / dailyCapacity : (hours > 0 ? 2 : 0);
                            if (isDragSelected) bgStyle.backgroundColor = dBg('#e0e7ff', '#3a3860');
                            else if (downConflict) bgStyle.backgroundColor = dBg('#fecaca', '#5a2020');
                            else if (isDown && !isWE) { const dc = { ausfall: dBg('#fee2e2','#4a2020'), wartung: dBg('#fef3c7','#4a4020'), sonstiges: dBg('#f1f5f9','#30304a') }; bgStyle.backgroundColor = dc[downType] || dBg('#fee2e2','#4a2020'); }
                            else if (isToday) bgStyle.backgroundColor = dBg('#fef2f2', '#3a2028');
                            else if (isHol) bgStyle.backgroundColor = dBg('#fee2e2', '#4a2020');
                            else if (isWE) bgStyle.backgroundColor = dBg('#e5e7eb', '#1a1a2a');
                            else if (wlBarMode === 'number' && hours > 0 && getColorTier(ratio) === 'red') bgStyle.backgroundColor = dBg('#fecaca', '#5a1a1a');
                            else if (wlBarMode === 'number' && hours > 0 && getColorTier(ratio) === 'orange') bgStyle.backgroundColor = dBg('#fed7aa', '#5a3a10');
                            else if (wlBarMode === 'number' && hours > 0 && getColorTier(ratio) === 'blue') bgStyle.backgroundColor = dBg('#c7d2fe', '#2a2a60');
                            else if (wlBarMode === 'number' && hours > 0) bgStyle.backgroundColor = dBg('#bbf7d0', '#1a4028');
                            else if (darkMode) bgStyle.backgroundColor = '#2a2a3e';
                            const numTextColor = (isDown && !isWE) ? 'text-orange-500' : ({ red: 'text-red-700 font-bold', orange: 'text-orange-700 font-bold', blue: 'text-indigo-700 font-bold', green: hours > 0 ? 'text-green-700 font-bold' : 'text-gray-300' }[getColorTier(ratio)]);
                            
                            return (
                              <div 
                                key={i} 
                                data-rdt-idx={i}
                                data-rdt-res-id={r.id}
                                className={`flex-shrink-0 border-r border-b flex ${wlBarMode === 'bar' ? 'items-end' : 'items-center'} justify-center ${!isWE ? 'cursor-cell' : 'cursor-default'} select-none relative overflow-hidden`} 
                                style={{ width: DAY_WIDTH, height: WLR_SUM, ...bgStyle }} 
                                title={isDown ? `${rdtIcons[downType] || 'â›”'} ${rdtLabels[downType] || 'Ausfall'} â€“ ${r.name}` : `${r.name} â€“ ${ds}\nKapazitÃ¤t: ${dailyCapacity}h / Belegt: ${hours}h` + (data?.details?.length ? '\n' + data.details.map(d => `${d.wpName}: ${d.hours.toFixed(1)}h`).join('\n') : '')}
                                onMouseDown={(e) => {
                                  if (e.button !== 0 || isWE) return;
                                  e.preventDefault();
                                  setResDownDrag({ resId: r.id, startIdx: i, endIdx: i });
                                }}
                                onContextMenu={(e) => {
                                  if (isWE) return;
                                  e.preventDefault();
                                  setResDownTypePicker({ x: e.clientX, y: e.clientY, resId: r.id, dates: [ds], hasExisting: isDown });
                                }}
                              >
                                {wlBarMode === 'bar' ? (
                                  <React.Fragment>
                                    {/* Capacity reference line (dashed) */}
                                    {capLinePct > 0 && hours > 0 && (
                                      <div className="absolute left-0 right-0 pointer-events-none" style={{ bottom: `${capLinePct}%`, height: 0, borderTop: darkMode ? '1.5px dashed #606080' : '1.5px dashed #b8b8b8' }} />
                                    )}
                                    {/* Bar chart visualization */}
                                    {hours > 0 && !isWE && !isHol && !isDown ? (
                                      <div className="absolute bottom-0 left-[2px] right-[2px] flex flex-col justify-end pointer-events-none" style={{ height: `${totalBarPct}%` }}>
                                        {overPct > 0 && (
                                          <div style={{ height: `${(overPct / totalBarPct) * 100}%`, backgroundColor: tierToHex(getColorTier(ratio)), borderRadius: '2px 2px 0 0', minHeight: 2 }} />
                                        )}
                                        <div style={{ flex: overPct > 0 ? undefined : 1, height: overPct > 0 ? `${(normalPct / totalBarPct) * 100}%` : '100%', backgroundColor: '#6366f1', borderRadius: overPct > 0 ? '0' : '2px 2px 0 0', minHeight: 2 }} />
                                      </div>
                                    ) : isDown && !isWE ? (
                                      <div className="relative z-10 flex items-center justify-center" style={{ height: '100%', width: '100%' }}>
                                        {hours > 0 ? <span className="wl-icon" style={{ fontSize: 9 }}>âš ï¸</span> : <span className="wl-icon" style={{ fontSize: 9 }}>{rdtIcons[downType] || 'â›”'}</span>}
                                      </div>
                                    ) : null}
                                  </React.Fragment>
                                ) : wlBarMode === 'indicator' ? (
                                  <React.Fragment>
                                    {isDown && !isWE ? (
                                      <span className="wl-icon" style={{ fontSize: 9 }}>{hours > 0 ? 'âš ï¸' : (rdtIcons[downType] || 'â›”')}</span>
                                    ) : !isWE && !isHol && dailyCapacity > 0 ? (
                                      <div style={{ width: Math.max(4, Math.round(DAY_WIDTH * 0.6)), height: Math.max(4, Math.round(WLR_SUM * 0.6)), borderRadius: 3, backgroundColor: hours === 0 ? dBg('#e8e8e8','#3a3a4e') : tierToHex(getColorTier(ratio)) }} />
                                    ) : null}
                                  </React.Fragment>
                                ) : (
                                  <div className="relative z-10 flex items-center justify-center" style={{ height: '100%' }}>
                                    {isDown && !isWE && hours > 0 ? (
                                      <span className="wl-icon" style={{ fontSize: 9 }}>âš ï¸</span>
                                    ) : isDown && !isWE ? (
                                      <span className="wl-icon" style={{ fontSize: 9 }}>{rdtIcons[downType] || 'â›”'}</span>
                                    ) : hours > 0 ? (
                                      <span className={`wl-t-xxs text-[9px] ${numTextColor}`}>{wlFmt(hours)}</span>
                                    ) : null}
                                  </div>
                                )}
                              </div>
                            );
                          })}
                        </div>
                        );
                      };
                      
                      const renderResWPBarRow = (r, wp) => {
                        const project = projects.find(p => p.id === wp.projectId);
                        const barColor = wp.color || project?.color || '#6366f1';
                        const wpStart = wp.startDate;
                        const wpEnd = wp.endDate;
                        const workDays = getWPWorkDays(wp);
                        const activeDays = getActiveDaysForResource(wp, r.id);
                        const workDaySet = new Set(workDays);
                        const activeDaySet = new Set(activeDays);
                        const totalHours = getResourceHours(wp, r.id);
                        const hoursPerActiveDay = activeDays.length > 0 ? totalHours / activeDays.length : 0;
                        
                        return (
                          <div key={r.id + '_wp_' + wp.id} className="flex border-b border-gray-50 relative" style={{ height: WLR_WP, backgroundColor: 'transparent', borderColor: grpBorder }}
                            onContextMenu={(e) => {
                              e.preventDefault();
                              setWorkloadContextMenu({ x: e.clientX, y: e.clientY, wpId: wp.id, resId: r.id, resName: r.name, wpName: wp.name, projectName: project?.name, locked: wp.locked });
                            }}
                          >
                            {dayMeta.map((dm, i) => {
                              const { day, ds, isWE, isHol, isToday } = dm;
                              const inRange = ds >= wpStart && ds <= wpEnd;
                              const isWorkDay = workDaySet.has(ds);
                              const isActive = activeDaySet.has(ds);
                              const isFirst = ds === wpStart;
                              const isLast = ds === wpEnd;
                              const isDown = isResourceDown(r.id, day);
                              const downConflict = inRange && isWorkDay && isActive && isDown;
                              
                              let bg = '';
                              let cellStyle = { width: DAY_WIDTH, height: WLR_WP, borderColor: grpBorder };
                              
                              if (downConflict) {
                                cellStyle.backgroundColor = dBg('#fef2f2', '#5a2020');
                              } else if (inRange && isWorkDay && isActive) {
                                cellStyle.backgroundColor = barColor + '40';
                              } else if (inRange && isWorkDay && !isActive) {
                                cellStyle.backgroundColor = dBg('#ffffff', '#2e2e44');
                              } else if (isToday) {
                                cellStyle.backgroundColor = dBg('#fef2f2', '#3a2028');
                              } else if (isHol) {
                                cellStyle.backgroundColor = dBg('#fee2e2', '#4a2020');
                              } else if (isWE) {
                                cellStyle.backgroundColor = dBg('#e5e7eb', '#1a1a2a');
                              } else if (darkMode) {
                                cellStyle.backgroundColor = '#2e2e44';
                              }
                              
                              let borderStyle = {};
                              if (inRange && isWorkDay) {
                                const bColor = downConflict ? '#ef4444' : barColor;
                                borderStyle.borderTop = `2px solid ${bColor}`;
                                borderStyle.borderBottom = `2px solid ${bColor}`;
                                if (isFirst || (i > 0 && dayMeta[i-1].ds < wpStart)) { borderStyle.borderLeft = `2px solid ${bColor}`; borderStyle.borderTopLeftRadius = 4; borderStyle.borderBottomLeftRadius = 4; }
                                if (isLast || (i < dayMeta.length - 1 && dayMeta[i+1].ds > wpEnd)) { borderStyle.borderRight = `2px solid ${bColor}`; borderStyle.borderTopRightRadius = 4; borderStyle.borderBottomRightRadius = 4; }
                              } else if (inRange && (isWE || isHol)) {
                                borderStyle.borderTop = `1px dashed ${barColor}50`;
                                borderStyle.borderBottom = `1px dashed ${barColor}50`;
                              }
                              
                              const showLabel = isLast;
                              
                              return (
                                <div 
                                  key={i} 
                                  className={`flex-shrink-0 wl-bar-cell text-center wl-t-tiny text-[8px] flex items-center justify-center ${bg} ${isWorkDay && inRange ? 'cursor-pointer hover:brightness-90' : 'cursor-default'} ${showLabel ? 'relative' : ''}`} 
                                  style={{ ...cellStyle, ...borderStyle }}
                                  onClick={() => { if (isWorkDay && inRange) toggleWPDayForResource(wp.id, r.id, ds); }}
                                  title={downConflict ? `âš ï¸ ${hoursPerActiveDay.toFixed(1)}h geplant aber ${rdtLabels[getResourceDownType(r.id, day)] || 'Ausfall'}!` : inRange && isWorkDay ? (isActive ? `${hoursPerActiveDay.toFixed(1)}h â€“ Klick: Tag deaktivieren` : 'Klick: Tag aktivieren') : ''}
                                >
                                  {downConflict ? (
                                    <span className="wl-icon" style={{ fontSize: 9 }}>âš ï¸</span>
                                  ) : isActive && hoursPerActiveDay > 0 ? (
                                    <span className="wl-t-tiny font-medium" style={{ color: barColor, fontSize: 8 }}>
                                      {wlFmt(hoursPerActiveDay)}
                                    </span>
                                  ) : null}
                                  {showLabel && (
                                    <span className="absolute left-full ml-1 whitespace-nowrap wl-t-xxs text-[9px] pointer-events-none flex items-center gap-1 z-10" style={{ top: '50%', transform: 'translateY(-50%)' }}>
                                      <span className="font-medium" style={{ color: barColor }}>{project?.name}</span>
                                      <span className="text-gray-400">â€º</span>
                                      <span className="text-gray-600">{wp.name}</span>
                                      <span className="text-gray-400 ml-0.5">{totalHours}h</span>
                                      {wp.locked && <span className="text-orange-500" title="Termin fixiert">ðŸ”’</span>}
                                    </span>
                                  )}
                                </div>
                              );
                            })}
                          </div>
                        );
                      };
                      const renderResourceWithWPRows = (r) => {
                        gridRows.push(renderResourceRow(r));
                        if (workloadExpandedUsers['res_' + r.id]) {
                          const resWPs = getResourceWorkPackages(r.id);
                          resWPs.forEach(wp => {
                            gridRows.push(renderResWPBarRow(r, wp));
                          });
                        }
                      };
                      
                      // Planning bar row (from Team Dashboard tasks)
                      const renderPlanningBarRow = (u, pp) => {
                        const barColor = pp.color || '#94a3b8';
                        const userTasks = tasks.filter(t => t.userId === u.id && t.projectId === pp.projectId);
                        // Build a map of date â†’ net hours (iterate all days per task)
                        const dateHours = {};
                        userTasks.forEach(t => {
                          const tStart = parseLocalDate(t.startDate);
                          const tEnd = parseLocalDate(t.endDate || t.startDate);
                          const td = new Date(tStart);
                          while (td <= tEnd) {
                            const dow = td.getDay();
                            const tds = formatDate(td);
                            if (dow !== 0 && dow !== 6 && !holidays[tds]) {
                              const netH = calculateDayNetHours(u.id, td, t.startHour || 0, t.endHour || 0);
                              if (netH > 0) dateHours[tds] = (dateHours[tds] || 0) + netH;
                            }
                            td.setDate(td.getDate() + 1);
                          }
                        });
                        const totalHours = Math.round(pp.totalHours);
                        
                        return (
                          <div key={u.id + '_plan_' + pp.projectId} className="flex border-b border-gray-50 relative" style={{ height: WLR_WP, backgroundColor: 'transparent', borderColor: grpBorder }}
                          >
                            {dayMeta.map((dm, i) => {
                              const { day, ds, isWE, isHol, isToday } = dm;
                              const hours = dateHours[ds] || 0;
                              const inRange = ds >= pp.startDate && ds <= pp.endDate;
                              
                              let cellStyle = { width: DAY_WIDTH, height: WLR_WP, borderColor: grpBorder };
                              if (isToday) cellStyle.backgroundColor = dBg('#fef2f2', '#3a2028');
                              else if (isHol) cellStyle.backgroundColor = dBg('#fee2e2', '#4a2020');
                              else if (isWE) cellStyle.backgroundColor = dBg('#e5e7eb', '#1a1a2a');
                              else if (darkMode) cellStyle.backgroundColor = '#2e2e44';
                              
                              // Dashed border for planning range
                              let borderStyle = {};
                              if (inRange && !isWE && !isHol) {
                                const bColor = barColor;
                                borderStyle.borderTop = `2px dashed ${bColor}`;
                                borderStyle.borderBottom = `2px dashed ${bColor}`;
                                if (ds === pp.startDate) { borderStyle.borderLeft = `2px dashed ${bColor}`; borderStyle.borderTopLeftRadius = 4; borderStyle.borderBottomLeftRadius = 4; }
                                if (ds === pp.endDate) { borderStyle.borderRight = `2px dashed ${bColor}`; borderStyle.borderTopRightRadius = 4; borderStyle.borderBottomRightRadius = 4; }
                              }
                              
                              const isLast = ds === pp.endDate || (i === dayMeta.length - 1 && inRange);
                              
                              return (
                                <div 
                                  key={i} 
                                  className={`flex-shrink-0 wl-bar-cell text-center wl-t-tiny text-[8px] flex items-center justify-center ${isLast ? 'relative' : ''}`} 
                                  style={{ ...cellStyle, ...borderStyle }}
                                  title={hours > 0 ? `ðŸ“‹ ${pp.name} â€“ ${ds}\n${hours.toFixed(1)}h (Aus Schnellplanung)` : ''}
                                >
                                  {hours > 0 && (
                                    <span className="wl-t-tiny font-medium" style={{ color: barColor, fontSize: 8, fontStyle: 'italic' }}>
                                      {wlFmt(hours)}
                                    </span>
                                  )}
                                  {isLast && (
                                    <span className="absolute left-full ml-1 whitespace-nowrap wl-t-xxs text-[9px] pointer-events-none flex items-center gap-1 z-10" style={{ top: '50%', transform: 'translateY(-50%)' }}>
                                      <span style={{ fontSize: 8 }}>ðŸ“‹</span>
                                      <span className="font-medium" style={{ color: barColor, fontStyle: 'italic' }}>{pp.name}</span>
                                      <span style={{ color: '#94a3b8' }}>{totalHours}h</span>
                                    </span>
                                  )}
                                </div>
                              );
                            })}
                          </div>
                        );
                      };
                      
                      const renderUserWithWPRows = (u) => {
                        gridRows.push(renderUserRow(u));
                        if (workloadExpandedUsers[u.id]) {
                          let wpList = getUserWorkPackages(u.id);
                          if (wlFocusWP && !wlFocusShowAll) {
                            wpList = wpList.filter(wp => wp.id === wlFocusWP.wpId);
                          }
                          wpList.forEach(wp => {
                            gridRows.push(renderWPBarRow(u, wp));
                          });
                          // Planning projects from Team Dashboard
                          const planProjects = getUserPlanningProjects(u.id);
                          planProjects.forEach(pp => {
                            gridRows.push(renderPlanningBarRow(u, pp));
                          });
                        }
                      };
                      
                      const isGroupExp = (key) => workloadExpandedGroups[key] !== false;
                      
                      if (workloadFilter === 'bereiche') {
                        departments.sort((a,b) => a.name.localeCompare(b.name)).forEach(dept => {
                          const deptDivs = divisions.filter(d => d.departmentId === dept.id);
                          const deptTeams = teams.filter(t => deptDivs.some(d => d.id === t.divisionId));
                          const deptUsers = pUsers.filter(u => u.role !== 'admin' && deptTeams.some(t => t.id === u.teamId));
                          gridRows.push(renderGroupRow(deptUsers, '', dept.id, { backgroundColor: darkMode ? '#2a2a3e' : '#f1f5f9', borderColor: grpBorder }));
                        });
                      } else if (workloadFilter === 'abteilungen') {
                        divisions.sort((a,b) => a.name.localeCompare(b.name)).forEach(div => {
                          const divTeams = teams.filter(t => t.divisionId === div.id);
                          const divUsers = pUsers.filter(u => u.role !== 'admin' && divTeams.some(t => t.id === u.teamId));
                          if (divUsers.length === 0) return;
                          gridRows.push(renderGroupRow(divUsers, '', div.id, { backgroundColor: darkMode ? '#2a2a3e' : '#eff6ff', borderColor: grpBorder }));
                        });
                      } else if (workloadFilter === 'teams') {
                        teams.sort((a,b) => a.name.localeCompare(b.name)).forEach(team => {
                          const teamUsers = pUsers.filter(u => u.role !== 'admin' && u.teamId === team.id);
                          if (teamUsers.length === 0) return;
                          gridRows.push(renderGroupRow(teamUsers, '', team.id, { backgroundColor: darkMode ? '#2a2a3e' : '#eef2ff', borderColor: grpBorder }));
                        });
                      } else if (workloadFilter === 'mitarbeiter' || workloadFilter === 'ma_ressourcen') {
                        
                        // Focus-Mode: Nur beteiligte Mitarbeiter
                        if (wlFocusWP) {
                          const focusUsers = pUsers.filter(u => wlFocusWP.userIds.includes(u.id)).sort((a,b) => a.name.localeCompare(b.name));
                          focusUsers.forEach(u => renderUserWithWPRows(u));
                        } else {
                        // Full hierarchy: Bereich â†’ Abteilung â†’ Team â†’ Mitarbeiter
                        departments.sort((a,b) => a.name.localeCompare(b.name)).forEach(dept => {
                          const deptDivisions = divisions.filter(d => d.departmentId === dept.id);
                          const deptAllUsers = pUsers.filter(u => u.role !== 'admin' && teams.some(t => t.id === u.teamId && deptDivisions.some(d => d.id === t.divisionId)));
                          if (deptAllUsers.length === 0) return;
                          const deptKey = 'wl_dept_' + dept.id;
                          const deptExp = isGroupExp(deptKey);
                          gridRows.push(renderGroupRow(deptAllUsers, '', deptKey, { backgroundColor: dm ? '#2a2a3e' : '#dcdcdc', borderColor: grpBorder, color: dm ? '#c0c0d8' : '#444444' }));
                          if (deptExp) {
                            const activeDivisions = deptDivisions.filter(d => {
                              const divTeams = teams.filter(t => t.divisionId === d.id);
                              return pUsers.some(u => u.role !== 'admin' && divTeams.some(t => t.id === u.teamId));
                            }).sort((a,b) => a.name.localeCompare(b.name));
                            
                            activeDivisions.forEach(div => {
                              const divTeams = teams.filter(t => t.divisionId === div.id);
                              const divAllUsers = pUsers.filter(u => u.role !== 'admin' && divTeams.some(t => t.id === u.teamId));
                              if (divAllUsers.length === 0) return;
                              const divKey = 'wl_' + div.id;
                              const divExp = isGroupExp(divKey);
                              gridRows.push(renderGroupRow(divAllUsers, '', divKey, { backgroundColor: dm ? '#2a2a3e' : '#e2e2e2', borderColor: grpBorder, color: dm ? '#c0c0d8' : '#444444' }));
                              if (divExp) {
                                const activeTeams = divTeams.filter(t => pUsers.some(u => u.role !== 'admin' && u.teamId === t.id)).sort((a,b) => a.name.localeCompare(b.name));
                                activeTeams.forEach(team => {
                                  const teamUsers = pUsers.filter(u => u.role !== 'admin' && u.teamId === team.id);
                                  if (teamUsers.length === 0) return;
                                  const teamKey = 'wl_team_' + team.id;
                                  const teamExp = isGroupExp(teamKey);
                                  gridRows.push(renderGroupRow(teamUsers, '', teamKey, { backgroundColor: dm ? '#2a2a3e' : '#ececec', borderColor: grpBorder, color: dm ? '#b0b0c8' : '#555555' }));
                                  if (teamExp) {
                                    teamUsers.sort((a,b) => a.name.localeCompare(b.name)).forEach(u => renderUserWithWPRows(u));
                                  }
                                });
                              }
                            });
                          }
                        });
                        
                        const assignedUserIds = new Set();
                        departments.forEach(dept => {
                          divisions.filter(d => d.departmentId === dept.id).forEach(div => {
                            teams.filter(t => t.divisionId === div.id).forEach(team => {
                              pUsers.filter(u => u.role !== 'admin' && u.teamId === team.id).forEach(u => assignedUserIds.add(u.id));
                            });
                          });
                        });
                        const orphans = pUsers.filter(u => u.role !== 'admin' && !assignedUserIds.has(u.id));
                        if (orphans.length > 0) {
                          const orphExp = isGroupExp('wl_orphan');
                          gridRows.push(renderGroupRow(orphans, '', '_orph', { backgroundColor: dm ? '#2a2a3e' : '#ececec', borderColor: grpBorder, color: dm ? '#b0b0c8' : '#555555' }));
                          if (orphExp) orphans.sort((a,b) => a.name.localeCompare(b.name)).forEach(u => renderUserWithWPRows(u));
                        }
                        } // end else (non-focus mode)
                        
                        // In combined mode: add Ressourcen grid rows
                        if (workloadFilter === 'ma_ressourcen') {
                          const focusResIds = wlFocusWP?.resourceIds || [];
                          const filteredResources = wlFocusWP ? pResources.filter(r => focusResIds.includes(r.id)) : pResources;
                          
                          if (filteredResources.length > 0) {
                            gridRows.push(<div key="_res_divider_r" style={{ height: 3, background: 'linear-gradient(90deg, #6366f1, #8b5cf6)', flexShrink: 0 }} />);
                            const resHeaderExp = isGroupExp('wl_res_header');
                            gridRows.push(renderGroupRow([], '', '_res_header_r', { backgroundColor: dm ? '#2a2a3e' : '#dcdcdc', borderColor: grpBorder }));
                            if (resHeaderExp) {
                              ['maschine', 'fahrzeug', 'werkzeug'].forEach(type => {
                                const grouped = filteredResources.filter(r => r.type === type);
                                if (grouped.length === 0) return;
                                const isExp = workloadExpandedGroups['wl_res_' + type] !== false;
                                gridRows.push(renderGroupRow([], '', 'cmb_rg_' + type, { backgroundColor: dm ? '#2a2a3e' : '#e2e2e2', borderColor: grpBorder }));
                                if (isExp) {
                                  grouped.sort((a,b) => a.name.localeCompare(b.name)).forEach(r => renderResourceWithWPRows(r));
                                }
                              });
                            }
                          }
                        }
                      } else if (workloadFilter === 'ressourcen') {
                        const focusResIds = wlFocusWP?.resourceIds || [];
                        const allRes = wlFocusWP ? pResources.filter(r => focusResIds.includes(r.id)) : pResources;
                        ['maschine', 'fahrzeug', 'werkzeug'].forEach(type => {
                          const grouped = allRes.filter(r => r.type === type);
                          if (grouped.length === 0) return;
                          const isExp = workloadExpandedGroups['wl_res_' + type] !== false;
                          gridRows.push(renderGroupRow([], '', 'rg_' + type, { backgroundColor: dm ? '#2a2a3e' : '#dcdcdc', borderColor: grpBorder }));
                          if (isExp) {
                            grouped.sort((a,b) => a.name.localeCompare(b.name)).forEach(r => renderResourceWithWPRows(r));
                          }
                        });
                      }
                      
                      // Bottom spacer in cockpit mode
                      if (showResourceCockpit) {
                        gridRows.push(<div key="_grid_bottom_spacer" style={{ height: '60vh', flexShrink: 0 }} />);
                      }
                      
                      return gridRows;
                    })()}
                  </div>
                </div>
              </div>
            </div>
          )}
          
          {/* Global horizontal scrollbar â€” thick, for users without scroll wheel */}
          <div className="flex-shrink-0 border-t" style={{ paddingLeft: showResourceCockpit ? leftPanelWidth : (projectSidebarCollapsed ? 40 : 224) + leftPanelWidth, backgroundColor: darkMode ? '#2a2a3e' : '#f1f5f9', borderColor: darkMode ? '#3a3a4e' : '#e2e8f0' }}>
            <div 
              ref={bottomScrollRef}
              className="overflow-x-auto thick-scrollbar"
              style={{ height: 18 }}
              onScroll={(e) => {
                const sl = e.target.scrollLeft;
                if (ganttHScrollRef.current && ganttHScrollRef.current.scrollLeft !== sl) ganttHScrollRef.current.scrollLeft = sl;
                if (headerScrollRef.current && headerScrollRef.current.scrollLeft !== sl) headerScrollRef.current.scrollLeft = sl;
                if (workloadScrollRef.current && workloadScrollRef.current.scrollLeft !== sl) workloadScrollRef.current.scrollLeft = sl;
                window._ganttScrollLeft.value = sl;
              }}
            >
              <div style={{ width: ganttContentWidth, height: 1 }} />
            </div>
          </div>
          
          <div className="dm-footer bg-white border-t px-4 py-2 flex gap-6 text-xs text-gray-600 flex-shrink-0 items-center">
            {showResourceCockpit ? (
              <React.Fragment>
                <span className="font-semibold text-teal-600">ðŸ‘¥ Ressourcencockpit</span>
                <div className="w-px h-4 bg-gray-200" />
                <span className="text-[9px] text-gray-400">Farbskala:</span>
                <div className="flex items-center gap-1">
                  <span className="w-3 h-3 rounded" style={{ backgroundColor: tierToHex('green') }} /> <span>{colorThresholds.green}â€“{colorThresholds.blue}%</span>
                  <span className="w-3 h-3 rounded ml-1" style={{ backgroundColor: tierToHex('blue') }} /> <span>{colorThresholds.blue}â€“{colorThresholds.orange}%</span>
                  <span className="w-3 h-3 rounded ml-1" style={{ backgroundColor: tierToHex('orange') }} /> <span>{colorThresholds.orange}â€“{colorThresholds.red}%</span>
                  <span className="w-3 h-3 rounded ml-1" style={{ backgroundColor: tierToHex('red') }} /> <span>{'>'}{colorThresholds.red}%</span>
                </div>
                <div className="ml-auto text-gray-400">
                  {users.length} Mitarbeiter | {resources.length} Ressourcen
                </div>
              </React.Fragment>
            ) : (
            <React.Fragment>
            <button 
              onClick={() => setWorkloadPanelHeight(workloadPanelHeight > 0 ? 0 : Math.round(window.innerHeight * 0.5))}
              className={`text-xs px-3 py-1 rounded font-medium flex items-center gap-1.5 ${workloadPanelHeight > 0 ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
              title={workloadPanelHeight > 0 ? 'Workload-Panel schlieÃŸen' : 'Workload-Panel Ã¶ffnen'}
            >
              ðŸ“Š Workload
            </button>
            {workloadPanelHeight > 0 && (
              <React.Fragment>
                <button onClick={() => setWorkloadPanelHeight(Math.min(800, Math.round(workloadPanelHeight * 1.3)))} className="text-xs w-5 h-5 rounded bg-indigo-100 text-indigo-600 hover:bg-indigo-200 font-bold flex items-center justify-center" title="+30% grÃ¶ÃŸer">+</button>
                <button onClick={() => setWorkloadPanelHeight(Math.max(120, Math.round(workloadPanelHeight * 0.7)))} className="text-xs w-5 h-5 rounded bg-indigo-100 text-indigo-600 hover:bg-indigo-200 font-bold flex items-center justify-center" title="âˆ’30% kleiner">âˆ’</button>
                <button onClick={() => setWorkloadPanelHeight(0)} className="text-xs w-5 h-5 rounded bg-gray-100 text-gray-500 hover:bg-red-100 hover:text-red-600 font-bold flex items-center justify-center" title="SchlieÃŸen">âœ•</button>
              </React.Fragment>
            )}
            <div className="w-px h-4 bg-gray-200" />
            <div className="flex items-center gap-2"><div className="w-6 h-2 border-t-2 border-l-2 border-r-2 border-indigo-500 rounded-t" /><span>Klammer = Eltern</span></div>
            <div className="flex items-center gap-2"><div className="w-6 h-3 bg-indigo-500 rounded" /><span>Balken</span></div>
            <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-gray-400 border-2 border-white" /><span>AbhÃ¤ngigkeit</span></div>
            {selectedProjectId && (
              <div className="flex items-center gap-4 ml-4 pl-4 border-l">
                <span className="text-indigo-600 font-medium">{(workPackages || []).filter(wp => wp.projectId === selectedProjectId).length} Arbeitspakete</span>
                <span className="text-gray-500">{currentProjectBaselines.length} Baseline{currentProjectBaselines.length !== 1 ? 's' : ''}</span>
              </div>
            )}
            <div className="ml-auto text-gray-400">Ctrl+Z/Y Undo Â· Ctrl+F Suche Â· F2 Umben. Â· Del LÃ¶schen</div>
            </React.Fragment>
            )}
          </div>
            </div>
          </div>
        </div>
      );
    };
    
    return <ProjectPlanningDashboard />;
  }


  const sortedProjects = [...projects].sort((a, b) => a.name.localeCompare(b.name));
  const filteredProjects = sortedProjects.filter(p => 
    p.name.toLowerCase().includes(projectSearchText.toLowerCase())
  );
  const displayUser = selectedUser || currentUser;

  return (
    <div className={`dm-root min-h-screen bg-gradient-to-br from-indigo-50 to-purple-50 ${darkMode ? 'dark' : ''}`}>
      <div className="dm-header bg-white shadow-lg sticky top-0 z-10">
        <div className="max-w-full mx-auto px-4 py-2 flex justify-between">
          <div className="flex items-center gap-3">
            <Calendar className="w-6 h-6 text-indigo-600" />
            <h1 className="text-lg font-bold">KapazitÃ¤tsplaner V5</h1>
            {lastSync && <span className="text-[9px] text-gray-400 flex items-center gap-1" title={`Letzter Sync: ${lastSync.toLocaleTimeString()}\nSession: ${sessionId.slice(-4)}\nDein Tier: ${myAnimalEmoji}`}><span className="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse" />{myAnimalEmoji}</span>}
            {/* Online presence indicators */}
            {onlineUsers.length > 0 && (
              <div className="flex items-center gap-1 ml-2">
                {onlineUsers.map((p, i) => {
                  const viewLabel = p.view === 'grobplanung' ? 'ðŸ“‹ Schnellplanung' : p.view === 'teamdashboard' ? 'ðŸ“Š Team DB' : p.view === 'projektplanung' ? 'ðŸ“ Projektplanung' : p.view === 'ressourcencockpit' ? 'ðŸ‘¥ Ressourcencockpit' : p.view === 'disposition' ? 'ðŸ“‹ Disposition' : p.view;
                  const viewingUser = p.selectedUserName ? ` â†’ ${p.selectedUserName}` : '';
                  return (
                    <div key={p.sessionId} className="relative group">
                      <div className="w-7 h-7 rounded-full flex items-center justify-center text-white text-[10px] font-bold cursor-default border-2 border-white shadow-sm" style={{ backgroundColor: p.color }} title={`${p.userName} â€” ${viewLabel}${viewingUser}`}>
                        <span style={{ fontSize: 16 }}>{p.animal || 'ðŸ¦«'}</span>
                      </div>
                      <span className="absolute -bottom-0.5 -right-0.5 w-2.5 h-2.5 bg-green-400 rounded-full border border-white" />
                      {/* Hover tooltip */}
                      <div className="absolute top-full left-1/2 -translate-x-1/2 mt-1 bg-gray-900 text-white text-[10px] rounded-lg px-2 py-1 whitespace-nowrap opacity-0 group-hover:opacity-100 pointer-events-none z-50 transition-opacity">
                        <div className="font-bold">{p.animal || 'ðŸ¦«'} {p.userName}</div>
                        <div className="text-gray-300">{viewLabel}{viewingUser}</div>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
            {currentUser.teamRole === 'lead' ? (
              <select value={selectedUser?.id || ''} onChange={(e) => { const user = users.find(u => u.id === e.target.value); if (user) setSelectedUser(user); }}
                className="ml-4 px-4 py-2 border-2 border-indigo-600 rounded-xl font-semibold">
                {users.filter(u => u.role !== 'admin').map(u => {
                  const viewers = onlineUsers.filter(p => p.selectedUserId === u.id);
                  return (<option key={u.id} value={u.id}>{viewers.length > 0 ? 'ðŸŸ¢ ' : ''}{u.name}{viewers.length > 0 ? ` (${viewers.map(v => v.userName.split(' ')[0]).join(', ')})` : ''}</option>);
                })}
              </select>
            ) : (
              <span className="ml-4 px-4 py-2 font-semibold text-gray-600">- {displayUser?.name}</span>
            )}
          </div>
          <div className="nav-bar flex gap-2">
            {/* Undo/Redo Buttons */}
            <button 
              onClick={undo} 
              disabled={undoStack.length === 0}
              className={`p-3 rounded-2xl ${undoStack.length > 0 ? 'hover:bg-gray-100' : 'opacity-30 cursor-not-allowed'}`}
              title={`RÃ¼ckgÃ¤ngig (${undoStack.length} verfÃ¼gbar)`}>
              â†¶
            </button>
            <button 
              onClick={redo} 
              disabled={redoStack.length === 0}
              className={`p-3 rounded-2xl ${redoStack.length > 0 ? 'hover:bg-gray-100' : 'opacity-30 cursor-not-allowed'}`}
              title={`Wiederholen (${redoStack.length} verfÃ¼gbar)`}>
              â†·
            </button>
            
            {/* History Button */}
            <button 
              onClick={() => setShowHistory(!showHistory)} 
              className={`p-3 rounded-2xl ${showHistory ? 'bg-blue-100' : 'hover:bg-gray-100'}`}
              title="Ã„nderungshistorie">
              ðŸ“œ
            </button>
            
            {/* Navigation - IMMER sichtbar, aktiver Button hervorgehoben */}
            <button 
              onClick={() => { setShowDashboard(false); setShowProjectDashboard(false); setShowProjectPlanning(false); setShowResourceCockpit(false); setShowDisposition(false); }} 
              className={`px-3 py-1.5 rounded-2xl text-sm ${!showDashboard && !showProjectDashboard && !showProjectPlanning ? 'bg-indigo-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}
            >
              <Calendar className="w-4 h-4 inline mr-2" />Schnellplanung
            </button>
            <button 
              onClick={() => { setShowDashboard(true); setShowProjectDashboard(false); setShowProjectPlanning(false); setShowResourceCockpit(false); setShowDisposition(false); }} 
              className={`px-3 py-1.5 rounded-2xl text-sm ${showDashboard ? 'bg-green-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}
            >
              <BarChart3 className="w-4 h-4 inline mr-2" />Team Dashboard
            </button>
            <button 
              onClick={() => { setShowDashboard(false); setShowProjectDashboard(true); setShowProjectPlanning(false); setShowResourceCockpit(false); setShowDisposition(false); }} 
              className={`px-3 py-1.5 rounded-2xl text-sm ${showProjectDashboard ? 'bg-blue-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}
            >
              <BarChart3 className="w-4 h-4 inline mr-2" />Projekt Dashboard
            </button>
            <button 
              onClick={() => { setShowDashboard(false); setShowProjectDashboard(false); setShowProjectPlanning(true); setShowResourceCockpit(false); setShowDisposition(false); }} 
              className={`px-4 py-2 rounded-2xl ${showProjectPlanning ? 'bg-orange-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}
            >
              ðŸ—ï¸ Projektplanung
            </button>
            <button 
              onClick={() => { setShowDashboard(false); setShowProjectDashboard(false); setShowProjectPlanning(false); setShowResourceCockpit(true); setShowDisposition(false); }} 
              className={`px-4 py-2 rounded-2xl ${showResourceCockpit ? 'bg-teal-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}
            >
              ðŸ‘¥ Ressourcencockpit
            </button>
            <button 
              onClick={() => { setShowDashboard(false); setShowProjectDashboard(false); setShowProjectPlanning(false); setShowResourceCockpit(false); setShowDisposition(true); }} 
              className={`px-3 py-1.5 rounded-2xl text-sm ${showDisposition ? 'bg-amber-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}
            >
              ðŸ“‹ Disposition
            </button>
            
            {currentUser.role === 'admin' && (<button onClick={() => setShowAdmin(true)} className="px-3 py-1.5 bg-purple-600 text-white rounded-2xl text-sm">Admin</button>)}
            {currentUser.role === 'admin' && (<button onClick={() => setShowDbTool(true)} className="px-4 py-2 bg-amber-600 text-white rounded-2xl">ðŸ”§ DB</button>)}
            <button onClick={() => setDarkMode(d => !d)} className={`p-3 rounded-2xl ${darkMode ? 'bg-indigo-600 text-yellow-200' : 'hover:bg-gray-100'}`} title={darkMode ? 'Light Mode' : 'Dark Mode'}>
              {darkMode ? 'â˜€ï¸' : 'ðŸŒ™'}
            </button>
            <button onClick={() => setShowSettings(true)} className="p-3 hover:bg-gray-100 rounded-2xl"><Settings className="w-5 h-5" /></button>
            <button onClick={() => { setCurrentUser(null); setSelectedUser(null); setShowLogin(true); setShowDashboard(false); }} 
              className="px-3 py-1.5 bg-gray-100 rounded-2xl text-sm"><LogOut className="w-4 h-4 inline mr-2" />Abmelden</button>
          </div>
        </div>
      </div>

      <div className="max-w-full mx-auto px-2 py-2">
        <div className="dm-card bg-white rounded-2xl shadow-lg overflow-hidden">
          {/* Toolbar: Heute + Legend */}
          <div className={`flex items-center justify-between px-4 py-2 border-b ${darkMode ? 'bg-[#1e1e32] border-[#3a3a4e]' : 'bg-gray-50 border-gray-200'}`}>
            <div className="flex items-center gap-2">
              <button onClick={() => {
                const now = new Date();
                const d = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate()));
                const dayNum = d.getUTCDay() || 7;
                d.setUTCDate(d.getUTCDate() + 4 - dayNum);
                const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                const todayKW = Math.ceil(((d - yearStart) / 86400000 + 1) / 7);
                const spStart = Math.max(1, currentWeek - 2);
                const kwOffset = todayKW - spStart;
                const colWidth = 7 * DW + 50 + 16;
                if (ganttScrollRef.current) {
                  ganttScrollRef.current.scrollTo({ left: Math.max(0, kwOffset * colWidth - ganttScrollRef.current.clientWidth / 2 + colWidth / 2), behavior: 'smooth' });
                }
              }} className={`px-3 py-1.5 rounded-lg text-sm font-medium ${darkMode ? 'bg-red-900/40 text-red-300 hover:bg-red-800/50' : 'bg-red-50 text-red-600 hover:bg-red-100'}`}>
                ðŸ“ Heute
              </button>
              <span className={`text-sm font-medium ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>KW {Math.max(1, currentWeek - 2)} â€“ {Math.max(1, currentWeek - 2) + SP_TOTAL_WEEKS - 1}</span>
            </div>
            <div className={`flex items-center gap-4 text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
              <span className="flex items-center gap-1.5"><span className="inline-block w-8 h-4 rounded" style={{ border: '2.5px solid #6366f1', backgroundColor: '#6366f125' }} /> ðŸ“ Projektplanung</span>
              <span className="flex items-center gap-1.5"><span className="inline-block w-8 h-4 rounded" style={{ border: '2.5px dashed #94a3b8', backgroundColor: '#94a3b825' }} /> ðŸ“‹ Schnellplanung</span>
              <span className="flex items-center gap-1.5"><span className="inline-block w-8 h-4 rounded" style={{ border: '2.5px dotted #f97316', backgroundColor: '#f9731610' }} /> âœï¸ Disposition</span>
              <span className="flex items-center gap-1.5"><span className="inline-block w-8 h-4 rounded bg-red-400/30" style={{ border: '2px solid #f87171' }} /> Ãœberlast</span>
              <span className="flex items-center gap-1.5"><span className="inline-block w-8 h-4 rounded" style={{ border: '1px solid #6b728040', backgroundColor: '#6b728020' }}>ðŸ“</span> Notizen</span>
            </div>
          </div>
          <div className="p-2 flex gap-2">
            <div className="w-48 bg-gray-50 rounded-xl p-3 flex-shrink-0 flex flex-col" style={{maxHeight: 'calc(100vh - 180px)'}}>
              <h3 className="font-bold mb-3">Projekte</h3>
              
              {/* Suchfeld */}
              <div className="mb-3">
                <input 
                  type="text" 
                  placeholder="Suchen..." 
                  value={projectSearchText}
                  onChange={(e) => setProjectSearchText(e.target.value)}
                  className="w-full p-2 border rounded-lg text-sm"
                />
              </div>
              
              <div className="space-y-2 overflow-y-auto flex-1">
                {filteredProjects.map(p => {
                  return (
                  <div key={p.id} draggable onDragStart={() => setDraggedProject(p)} 
                    className="flex items-center gap-2 p-3 rounded-xl cursor-move hover:shadow-lg bg-white border-2 transition-shadow" style={{borderColor: p.color}}>
                    <GripVertical className="w-4 h-4" />
                    <div className="w-4 h-4 rounded" style={{backgroundColor: p.color}}></div>
                    <span className="flex-1 text-sm">{p.name}</span>
                  </div>
                  );
                })}
                {filteredProjects.length === 0 && projectSearchText && (
                  <div className="text-center text-gray-500 text-xs py-4">
                    Keine Projekte
                  </div>
                )}
              </div>
            </div>
            <div className="flex-1 overflow-x-auto preserve-scroll" ref={ganttScrollRef}>
              <div className="flex gap-4 pb-4">
                {displayUser && (() => {
                  const spStart = Math.max(1, currentWeek - 2);
                  return Array.from({length: SP_TOTAL_WEEKS}, (_, i) => {
                    const weekNum = spStart + i;
                    return <WeekColumn key={weekNum} weekNum={weekNum} user={displayUser} />;
                  });
                })()}
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* SP Overlay Context Menu */}
      {spOverlayMenu && (
        <div className="fixed inset-0 z-50" onClick={() => setSpOverlayMenu(null)} onContextMenu={(e) => { e.preventDefault(); setSpOverlayMenu(null); }}>
          <div className={`absolute rounded-xl shadow-2xl border py-1 min-w-[220px] ${darkMode ? 'bg-[#2a2a3c] border-[#4a4a5e] text-gray-200' : 'bg-white border-gray-200 text-gray-700'}`}
            style={{ left: Math.min(spOverlayMenu.x, window.innerWidth - 240), top: Math.min(spOverlayMenu.y, window.innerHeight - 200) }}
            onClick={(e) => e.stopPropagation()}>
            <div className={`px-3 py-1.5 text-xs font-bold border-b ${darkMode ? 'border-[#4a4a5e] text-gray-400' : 'border-gray-100 text-gray-400'}`}>
              {spOverlayMenu.type === 'pp' ? 'ðŸ“' : spOverlayMenu.type === 'sp' ? 'ðŸ“‹' : 'âœï¸'} {spOverlayMenu.projectName}
              {spOverlayMenu.wpName && spOverlayMenu.wpName !== spOverlayMenu.projectName && <span className="font-normal ml-1">â†’ {spOverlayMenu.wpName}</span>}
            </div>
            <button className={`w-full text-left px-3 py-2 text-sm ${darkMode ? 'hover:bg-[#353550]' : 'hover:bg-gray-100'} flex items-center gap-2`}
              onClick={() => {
                const m = spOverlayMenu;
                setSpOverlayMenu(null);
                if (m.type === 'pp') {
                  if (m.wpId) setPendingHighlightWP(m.wpId);
                  setShowProjectPlanning(true); setShowDashboard(false); setShowProjectDashboard(false); setShowResourceCockpit(false); setShowDisposition(false);
                } else if (m.type === 'dispo') {
                  setShowDisposition(true); setShowDashboard(false); setShowProjectDashboard(false); setShowProjectPlanning(false); setShowResourceCockpit(false);
                } else {
                  setShowDashboard(false); setShowProjectDashboard(false); setShowProjectPlanning(false); setShowResourceCockpit(false); setShowDisposition(false);
                }
              }}>
              ðŸ” Details Ã¶ffnen
            </button>
            <button className={`w-full text-left px-3 py-2 text-sm ${darkMode ? 'hover:bg-[#353550]' : 'hover:bg-gray-100'} flex items-center gap-2`}
              onClick={() => {
                const m = spOverlayMenu;
                setSpOverlayMenu(null);
                const viewMap = { pp: 'projektplanung', sp: 'grobplanung', dispo: 'disposition' };
                const params = new URLSearchParams({
                  autoView: viewMap[m.type] || 'projektplanung',
                  autoUser: m.userId || '',
                  autoProject: m.projectId || ''
                });
                window.open(window.location.pathname + '?' + params.toString(), '_blank');
              }}>
              ðŸ”— Im neuen Reiter Ã¶ffnen
            </button>
          </div>
        </div>
      )}

      {/* Day Note Editor Modal */}
      {dayNoteEditor && (() => {
        const dn = dayNoteEditor;
        const existing = dn.note;
        const [noteText, setNoteText] = [React.useRef(existing?.text || ''), null];
        // Use a mini inline editor
        return (
          <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-50" onClick={() => setDayNoteEditor(null)}>
            <div className={`rounded-2xl shadow-2xl p-5 w-96 ${darkMode ? 'bg-[#2a2a3c] text-gray-200' : 'bg-white text-gray-800'}`} onClick={(e) => e.stopPropagation()}>
              <div className="flex items-center justify-between mb-3">
                <h3 className="font-bold text-sm">{existing ? 'ðŸ“ Notiz bearbeiten' : 'ðŸ“ Neue Notiz'}</h3>
                <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>{dn.date}</span>
              </div>
              <div className="mb-3">
                <label className={`text-xs font-medium mb-1 block ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Kategorie</label>
                <div className="flex flex-wrap gap-1.5">
                  {NOTE_TYPES.map((nt, i) => {
                    const isActive = (dayNoteEditor._icon || existing?.icon || 'ðŸ“') === nt.icon;
                    return (
                      <button key={i}
                        className={`px-2 py-1 rounded-lg text-xs font-medium transition-all ${isActive ? 'ring-2 ring-offset-1 shadow-md' : 'opacity-60 hover:opacity-100'}`}
                        style={{ backgroundColor: nt.color + '20', color: nt.color, borderColor: nt.color, ...(isActive ? { ringColor: nt.color } : {}) }}
                        onClick={() => setDayNoteEditor(prev => ({ ...prev, _icon: nt.icon, _color: nt.color, _label: nt.label }))}>
                        {nt.icon} {nt.label}
                      </button>
                    );
                  })}
                </div>
              </div>
              <div className="mb-4">
                <label className={`text-xs font-medium mb-1 block ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Text</label>
                <input type="text" autoFocus
                  defaultValue={existing?.text || dayNoteEditor._label || ''}
                  className={`w-full px-3 py-2 rounded-lg border text-sm ${darkMode ? 'bg-[#1e1e30] border-[#4a4a5e] text-gray-200' : 'bg-white border-gray-300'}`}
                  placeholder="z.B. Wechsel zur GU-Abteilung..."
                  id="dayNoteInput"
                  onKeyDown={(e) => {
                    if (e.key === 'Enter') {
                      const text = e.target.value.trim();
                      if (!text) return;
                      const icon = dayNoteEditor._icon || existing?.icon || 'ðŸ“';
                      const color = dayNoteEditor._color || existing?.color || '#6b7280';
                      if (existing) {
                        const updated = dayNotes.map(n => n.id === existing.id ? { ...n, text, icon, color } : n);
                        saveDayNotes(updated);
                      } else {
                        saveDayNotes([...dayNotes, { id: 'dn_' + Date.now(), userId: dn.userId, date: dn.date, text, icon, color }]);
                      }
                      setDayNoteEditor(null);
                    }
                  }} />
              </div>
              <div className="flex justify-between">
                <div>
                  {existing && (
                    <button className="px-3 py-1.5 rounded-lg text-xs font-medium bg-red-50 text-red-600 hover:bg-red-100"
                      onClick={() => { saveDayNotes(dayNotes.filter(n => n.id !== existing.id)); setDayNoteEditor(null); }}>
                      ðŸ—‘ï¸ LÃ¶schen
                    </button>
                  )}
                </div>
                <div className="flex gap-2">
                  <button className={`px-3 py-1.5 rounded-lg text-xs font-medium ${darkMode ? 'bg-[#353550] text-gray-300' : 'bg-gray-100 text-gray-600'}`}
                    onClick={() => setDayNoteEditor(null)}>
                    Abbrechen
                  </button>
                  <button className="px-3 py-1.5 rounded-lg text-xs font-medium bg-indigo-600 text-white hover:bg-indigo-700"
                    onClick={() => {
                      const text = document.getElementById('dayNoteInput')?.value?.trim();
                      if (!text) return;
                      const icon = dayNoteEditor._icon || existing?.icon || 'ðŸ“';
                      const color = dayNoteEditor._color || existing?.color || '#6b7280';
                      if (existing) {
                        saveDayNotes(dayNotes.map(n => n.id === existing.id ? { ...n, text, icon, color } : n));
                      } else {
                        saveDayNotes([...dayNotes, { id: 'dn_' + Date.now(), userId: dn.userId, date: dn.date, text, icon, color }]);
                      }
                      setDayNoteEditor(null);
                    }}>
                    âœ“ Speichern
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      })()}

      {showSettings && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="dm-modal bg-white rounded-3xl p-6 max-w-[1400px] w-full max-h-[80vh] overflow-y-auto">
            <div className="flex justify-between mb-6">
              <h2 className="text-2xl font-bold">Einstellungen</h2>
              <button onClick={() => { setShowSettings(false); setProjectSearchText(''); }} className="text-2xl">âœ•</button>
            </div>
            <div className="mb-6">
              <h3 className="font-semibold mb-3">SchriftgrÃ¶ÃŸe: {fontSize}px</h3>
              <input type="range" min="10" max="16" value={fontSize} onChange={(e) => setFontSize(parseInt(e.target.value))} className="w-full" />
            </div>
            
            {/* Arbeitszeiten & Pausen */}
            <div>
              <div className="flex items-center justify-between mb-3">
                <h3 className="font-semibold">Arbeitszeiten & Pausen</h3>
                <div className="flex items-center gap-2">
                  <span className="text-sm px-3 py-1 rounded-full bg-indigo-100 text-indigo-700 font-medium">
                    ðŸ‘¤ {displayUser?.name || 'Unbekannt'}
                  </span>
                  {currentUser?.role === 'admin' && displayUser?.id !== currentUser?.id && (
                    <span className="text-[10px] text-gray-400">Bearbeitung als Admin</span>
                  )}
                </div>
              </div>
              {/* User selector for leads/admins */}
              {(currentUser?.teamRole === 'lead' || currentUser?.teamRole === 'department_head' || currentUser?.teamRole === 'entrepreneur' || currentUser?.role === 'admin') && (
                <div className="mb-3 flex items-center gap-2">
                  <span className="text-xs text-gray-500">Mitarbeiter:</span>
                  <select 
                    value={displayUser?.id || ''} 
                    onChange={(e) => { const user = users.find(u => u.id === e.target.value); if (user) setSelectedUser(user); }}
                    className="px-2 py-1 border rounded text-sm flex-1 max-w-xs"
                  >
                    {users.filter(u => u.role !== 'admin').map(u => (
                      <option key={u.id} value={u.id}>{u.name}</option>
                    ))}
                  </select>
                  {displayUser?.id !== currentUser?.id && (
                    <button onClick={() => setSelectedUser(currentUser)} className="text-xs px-2 py-1 rounded bg-gray-100 hover:bg-gray-200">ZurÃ¼ck zu mir</button>
                  )}
                </div>
              )}
              <div className="p-3 bg-gray-50 rounded-xl">
                <div className="space-y-2">
                  {[{d:1,l:'Montag'},{d:2,l:'Dienstag'},{d:3,l:'Mittwoch'},{d:4,l:'Donnerstag'},{d:5,l:'Freitag'},{d:6,l:'Samstag'},{d:0,l:'Sonntag'}].map(({d,l}) => {
                    const sched = displayUser?.dailySchedule || DEFAULT_SCHEDULE;
                    const dayS  = sched[d] || {start:0, end:0, break1Start:0, break1Duration:0, break2Start:0, break2Duration:0};
                    const isOff = dayS.start >= dayS.end || (dayS.start === 0 && dayS.end === 0);
                    const toggleOff = () => {
                      const newSched = {...sched, [d]: isOff ? {start:8,end:17,break1Start:9,break1Duration:0.25,break2Start:12.5,break2Duration:0.75} : {start:0,end:0,break1Duration:0,break2Duration:0}};
                      const updatedUsers = users.map(u => u.id === displayUser.id ? {...u, dailySchedule: newSched} : u);
                      saveUsers(updatedUsers);
                      if (selectedUser?.id === displayUser.id) setSelectedUser({...displayUser, dailySchedule: newSched});
                    };
                    const setVal = (field, raw) => {
                      const val = (field === 'break1Duration' || field === 'break2Duration' || field === 'break1Start' || field === 'break2Start') 
                        ? parseFloat(raw) || 0 
                        : t2h(raw);
                      const newSched = {...sched, [d]: {...dayS, [field]: val}};
                      const updatedUsers = users.map(u => u.id === displayUser.id ? {...u, dailySchedule: newSched} : u);
                      saveUsers(updatedUsers);
                      if (selectedUser?.id === displayUser.id) setSelectedUser({...displayUser, dailySchedule: newSched});
                    };
                    const break1 = dayS.break1Duration || 0;
                    const break2 = (dayS.end > 13) ? (dayS.break2Duration || 0) : 0;
                    const netHours = Math.max(0, (dayS.end - dayS.start) - break1 - break2);
                    return (
                      <div key={d} className="space-y-1">
                        {d === 6 && <div className="border-t border-dashed border-gray-300 mt-2 pt-2"><span className="text-[10px] text-gray-400">Wochenende</span></div>}
                        <div className="flex items-center gap-2 text-sm">
                          <span className={`font-medium w-20 ${(d === 6 || d === 0) ? 'text-orange-600' : 'text-gray-700'}`}>{l}</span>
                          {isOff ? (
                            <>
                              <span className="text-red-500 italic flex-1">frei</span>
                              <button onClick={toggleOff} className="text-xs px-2 py-1 rounded font-semibold bg-green-100 text-green-700">An</button>
                            </>
                          ) : (
                            <>
                              <input 
                                type="text" 
                                defaultValue={h2t(dayS.start)}
                                key={`settings-start-${d}-${dayS.start}`}
                                onBlur={(e) => {
                                  const formatted = formatTimeInput(e.target.value);
                                  if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                    setVal('start', formatted);
                                  }
                                }}
                                onKeyDown={(e) => {
                                  if (e.key === 'Enter') {
                                    const formatted = formatTimeInput(e.target.value);
                                    if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                      setVal('start', formatted);
                                      e.target.blur();
                                    }
                                  }
                                }}
                                className="p-1.5 border rounded text-sm w-20"
                                placeholder="HH:MM" 
                              />
                              <span className="text-gray-400 text-sm">â€“</span>
                              <input 
                                type="text" 
                                defaultValue={h2t(dayS.end)}
                                key={`settings-end-${d}-${dayS.end}`}
                                onBlur={(e) => {
                                  const formatted = formatTimeInput(e.target.value);
                                  if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                    setVal('end', formatted);
                                  }
                                }}
                                onKeyDown={(e) => {
                                  if (e.key === 'Enter') {
                                    const formatted = formatTimeInput(e.target.value);
                                    if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                      setVal('end', formatted);
                                      e.target.blur();
                                    }
                                  }
                                }}
                                className="p-1.5 border rounded text-sm w-20"
                                placeholder="HH:MM"
                              />
                              <span className="font-semibold text-indigo-600 w-16 text-right text-sm">{netHours.toFixed(2)}h</span>
                              <button onClick={toggleOff} className="text-xs px-2 py-1 rounded font-semibold bg-red-100 text-red-600">Aus</button>
                            </>
                          )}
                        </div>
                        {!isOff && (
                          <div className="flex items-center gap-2 ml-24 text-sm text-gray-600">
                            <span className="font-medium">P1:</span>
                            <input 
                              type="text" 
                              defaultValue={h2t(dayS.break1Start || 9)}
                              key={`settings-b1s-${d}-${dayS.break1Start}`}
                              onBlur={(e) => {
                                const formatted = formatTimeInput(e.target.value);
                                if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                  setVal('break1Start', formatted);
                                }
                              }}
                              onKeyDown={(e) => {
                                if (e.key === 'Enter') {
                                  const formatted = formatTimeInput(e.target.value);
                                  if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                    setVal('break1Start', formatted);
                                    e.target.blur();
                                  }
                                }
                              }}
                              className="p-2 border rounded text-sm w-32" 
                              placeholder="HH:MM"
                              title="Pause 1 Start" />
                            <span className="text-gray-400">â€“</span>
                            <input 
                              type="text" 
                              defaultValue={h2t((dayS.break1Start || 9) + (dayS.break1Duration || 0.25))}
                              key={`settings-b1e-${d}-${dayS.break1Duration}`}
                              onBlur={(e) => {
                                const formatted = formatTimeInput(e.target.value);
                                if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                  const end = t2h(formatted);
                                  const start = dayS.break1Start || 9;
                                  const duration = Math.max(0, end - start);
                                  const newSched = {...sched, [d]: {...dayS, break1Duration: duration}};
                                  const updatedUsers = users.map(u => u.id === displayUser.id ? {...u, dailySchedule: newSched} : u);
                                  saveUsers(updatedUsers);
                                  if (selectedUser?.id === displayUser.id) setSelectedUser({...displayUser, dailySchedule: newSched});
                                }
                              }}
                              onKeyDown={(e) => {
                                if (e.key === 'Enter') {
                                  const formatted = formatTimeInput(e.target.value);
                                  if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                    const end = t2h(formatted);
                                    const start = dayS.break1Start || 9;
                                    const duration = Math.max(0, end - start);
                                    const newSched = {...sched, [d]: {...dayS, break1Duration: duration}};
                                    const updatedUsers = users.map(u => u.id === displayUser.id ? {...u, dailySchedule: newSched} : u);
                                    saveUsers(updatedUsers);
                                    if (selectedUser?.id === displayUser.id) setSelectedUser({...displayUser, dailySchedule: newSched});
                                    e.target.blur();
                                  }
                                }
                              }}
                              className="p-2 border rounded text-sm w-32" 
                              placeholder="HH:MM"
                              title="Pause 1 Ende" />
                            
                            <span className="text-gray-400 mx-1">|</span>
                            
                            <span className="font-medium">P2:</span>
                            <input 
                              type="text" 
                              defaultValue={h2t(dayS.break2Start || 12.5)}
                              key={`settings-b2s-${d}-${dayS.break2Start}`}
                              onBlur={(e) => {
                                const formatted = formatTimeInput(e.target.value);
                                if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                  setVal('break2Start', formatted);
                                }
                              }}
                              onKeyDown={(e) => {
                                if (e.key === 'Enter') {
                                  const formatted = formatTimeInput(e.target.value);
                                  if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                    setVal('break2Start', formatted);
                                    e.target.blur();
                                  }
                                }
                              }}
                              className="p-2 border rounded text-sm w-32" 
                              placeholder="HH:MM"
                              title="Pause 2 Start" />
                            <span className="text-gray-400">â€“</span>
                            <input 
                              type="text" 
                              defaultValue={h2t((dayS.break2Start || 12.5) + (dayS.break2Duration || 0.75))}
                              key={`settings-b2e-${d}-${dayS.break2Duration}`}
                              onBlur={(e) => {
                                const formatted = formatTimeInput(e.target.value);
                                if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                  const end = t2h(formatted);
                                  const start = dayS.break2Start || 12.5;
                                  const duration = Math.max(0, end - start);
                                  const newSched = {...sched, [d]: {...dayS, break2Duration: duration}};
                                  const updatedUsers = users.map(u => u.id === displayUser.id ? {...u, dailySchedule: newSched} : u);
                                  saveUsers(updatedUsers);
                                  if (selectedUser?.id === displayUser.id) setSelectedUser({...displayUser, dailySchedule: newSched});
                                }
                              }}
                              onKeyDown={(e) => {
                                if (e.key === 'Enter') {
                                  const formatted = formatTimeInput(e.target.value);
                                  if (formatted && formatted.match(/^\d{2}:\d{2}$/)) {
                                    const end = t2h(formatted);
                                    const start = dayS.break2Start || 12.5;
                                    const duration = Math.max(0, end - start);
                                    const newSched = {...sched, [d]: {...dayS, break2Duration: duration}};
                                    const updatedUsers = users.map(u => u.id === displayUser.id ? {...u, dailySchedule: newSched} : u);
                                    saveUsers(updatedUsers);
                                    if (selectedUser?.id === displayUser.id) setSelectedUser({...displayUser, dailySchedule: newSched});
                                    e.target.blur();
                                  }
                                }
                              }}
                              className="p-2 border rounded text-sm w-32" 
                              placeholder="HH:MM"
                              title="Pause 2 Ende" />
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
                <div className="text-sm text-gray-500 text-right pt-3 border-t mt-3">
                  Gesamt: <span className="font-bold text-indigo-600">{[1,2,3,4,5,6,0].reduce((s,d) => { 
                    const ds=(displayUser?.dailySchedule||DEFAULT_SCHEDULE)[d]||{start:0,end:0,break1Duration:0,break2Duration:0}; 
                    const gross=ds.end>ds.start?ds.end-ds.start:0; 
                    const b1=ds.break1Duration||0; 
                    const b2=(ds.end>13)?(ds.break2Duration||0):0; 
                    return s+Math.max(0,gross-b1-b2); 
                  }, 0).toFixed(1)}h / Woche</span>
                  {(() => {
                    const weHours = [6,0].reduce((s,d) => { 
                      const ds=(displayUser?.dailySchedule||DEFAULT_SCHEDULE)[d]||{start:0,end:0,break1Duration:0,break2Duration:0}; 
                      const gross=ds.end>ds.start?ds.end-ds.start:0; 
                      const b1=ds.break1Duration||0; 
                      const b2=(ds.end>13)?(ds.break2Duration||0):0; 
                      return s+Math.max(0,gross-b1-b2); 
                    }, 0);
                    return weHours > 0 ? <span className="ml-2 text-[10px] text-orange-500">(inkl. {weHours.toFixed(1)}h WE)</span> : null;
                  })()}
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {showAdmin && <AdminPanel />}
      
      {showDbTool && <DbTool />}
      
      {/* Global History Panel - fixed overlay fÃ¼r alle Views */}
      {showHistory && (
        <div className="fixed top-20 right-4 w-80 dm-card bg-white rounded-2xl shadow-2xl p-4 flex flex-col z-40 border-2 border-indigo-200" style={{maxHeight: '600px'}}>
          <div className="flex justify-between items-center mb-3">
            <h3 className="font-bold text-indigo-600">ðŸ“œ Ã„nderungshistorie</h3>
            <button onClick={() => setShowHistory(false)} className="text-gray-400 hover:text-gray-600 text-xl">âœ•</button>
          </div>
          
          <div className="space-y-2 overflow-y-auto flex-1">
            {historyLog.length === 0 ? (
              <div className="text-center text-gray-400 text-sm py-8">
                Noch keine Ã„nderungen
              </div>
            ) : (
              historyLog.map(entry => {
                const date = new Date(entry.timestamp);
                const timeStr = date.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
                const dateStr = date.toLocaleDateString('de-DE', {day: '2-digit', month: '2-digit'});
                
                let icon = 'ðŸ“';
                let actionText = entry.action;
                
                if (entry.action === 'task_create') { icon = 'âž•'; actionText = 'Task erstellt'; }
                else if (entry.action === 'task_delete') { icon = 'ðŸ—‘ï¸'; actionText = 'Task gelÃ¶scht'; }
                else if (entry.action === 'task_move') { icon = 'â†”ï¸'; actionText = 'Task verschoben'; }
                else if (entry.action === 'vacation_set') { icon = 'ðŸ–ï¸'; actionText = 'Urlaub gesetzt'; }
                else if (entry.action === 'vacation_remove') { icon = 'âŒ'; actionText = 'Urlaub entfernt'; }
                else if (entry.action === 'project_create') { icon = 'ðŸŽ¨'; actionText = 'Projekt erstellt'; }
                else if (entry.action === 'project_delete') { icon = 'ðŸ—‘ï¸'; actionText = 'Projekt gelÃ¶scht'; }
                else if (entry.action === 'undo') { icon = 'â†¶'; actionText = 'RÃ¼ckgÃ¤ngig'; }
                else if (entry.action === 'redo') { icon = 'â†·'; actionText = 'Wiederherstellt'; }
                
                return (
                  <div key={entry.id} className="bg-gray-50 p-3 rounded-lg shadow-sm border border-gray-200 hover:bg-gray-100 transition-colors">
                    <div className="flex items-start gap-2">
                      <span className="text-lg">{icon}</span>
                      <div className="flex-1 min-w-0">
                        <div className="text-xs text-gray-500">{dateStr} {timeStr}</div>
                        <div className="font-medium text-sm">{entry.userName}</div>
                        <div className="text-sm text-gray-600 mt-1">{actionText}</div>
                        {entry.details && (
                          <div className="text-xs text-gray-500 mt-1 truncate" title={entry.details}>
                            {entry.details}
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                );
              })
            )}
          </div>
        </div>
      )}
      
    </div>
  );
};

    // App rendern
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<CapacityPlanner />);
  </script>
</body>
</html>
